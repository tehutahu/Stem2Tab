/*!
 * alphaTab v1.7.1 (, build 24)
 *
 * Copyright © 2025, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).alphaTab={})}(this,function(t){"use strict";class e{t;i=new Set;constructor(t){this.t=t,window.addEventListener("resize",this.o.bind(this),!1)}observe(t){this.i.add(t)}unobserve(t){this.i.delete(t)}disconnect(){this.i.clear()}o(){const t=[];for(const e of this.i)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this.t(t,this)}}class s{t;l=[];u=null;constructor(t){this.t=t,window.addEventListener("resize",()=>this.p,!0),document.addEventListener("scroll",()=>this.p,!0)}p(){this.u||(this.u=setTimeout(()=>{this.m(),this.u=null},100))}observe(t){this.l.indexOf(t)>=0||(this.l.push(t),this.p())}unobserve(t){this.l=this.l.filter(e=>e!==t)}m(){const t=[];for(const e of this.l){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this.t(t,this)}}var i,n,r,a,h,o,c,l,u,d,f,p,b,m,g,w,y,k,S,B,_,x,T,M,v,N,P,E,C,F,A,D,L,W;void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=e),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=s),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...t){this.innerHTML="",this.append(...t)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(t,e){return this.replace(new RegExp(t,"g"),e)}),t.AlphaTabErrorType=void 0,(i=t.AlphaTabErrorType||(t.AlphaTabErrorType={}))[i.General=0]="General",i[i.Format=1]="Format",i[i.AlphaTex=2]="AlphaTex";class R extends Error{type;constructor(t,e="",s){super(e??"",{cause:s}),this.type=t}}class O{static version="1.7.1";static date="2025-12-02T16:54:46.381Z";static commit="e487b958158892679a115693547661dc49a78e16";static print(t){t(`alphaTab ${O.version}`),t(`commit: ${O.commit}`),t(`build date: ${O.date}`)}}!function(t){t[t.PPP=0]="PPP",t[t.PP=1]="PP",t[t.P=2]="P",t[t.MP=3]="MP",t[t.MF=4]="MF",t[t.F=5]="F",t[t.FF=6]="FF",t[t.FFF=7]="FFF",t[t.PPPP=8]="PPPP",t[t.PPPPP=9]="PPPPP",t[t.PPPPPP=10]="PPPPPP",t[t.FFFF=11]="FFFF",t[t.FFFFF=12]="FFFFF",t[t.FFFFFF=13]="FFFFFF",t[t.SF=14]="SF",t[t.SFP=15]="SFP",t[t.SFPP=16]="SFPP",t[t.FP=17]="FP",t[t.RF=18]="RF",t[t.RFZ=19]="RFZ",t[t.SFZ=20]="SFZ",t[t.SFFZ=21]="SFFZ",t[t.FZ=22]="FZ",t[t.N=23]="N",t[t.PF=24]="PF",t[t.SFZP=25]="SFZP"}(n||(n={}));class I{static QuarterTime=960;static k=15;static VelocityIncrement=16;static ticksToMillis(t,e){return t*(6e4/(e*I.QuarterTime))|0}static millisToTicks(t,e){return t/(6e4/(e*I.QuarterTime))|0}static toTicks(t){return I.valueToTicks(t)}static valueToTicks(t){let e=t;return e<0&&(e=1/-e),I.QuarterTime*(4/e)|0}static applyDot(t,e){return e?t+3*(t/4|0):t+(t/2|0)}static applyTuplet(t,e,s){return t*s/e|0}static removeTuplet(t,e,s){return t*e/s|0}static dynamicToVelocity(t,e=0){let s=1;switch(t){case n.PPP:s=I.k+0*I.VelocityIncrement;break;case n.PP:s=I.k+1*I.VelocityIncrement;break;case n.P:s=I.k+2*I.VelocityIncrement;break;case n.MP:s=I.k+3*I.VelocityIncrement;break;case n.MF:s=I.k+4*I.VelocityIncrement;break;case n.F:s=I.k+5*I.VelocityIncrement;break;case n.FF:s=I.k+6*I.VelocityIncrement;break;case n.FFF:s=I.k+7*I.VelocityIncrement;break;case n.PPPP:s=10;break;case n.PPPPP:s=5;break;case n.PPPPPP:s=3;break;case n.FFFF:s=I.k+8*I.VelocityIncrement;break;case n.FFFFF:s=I.k+9*I.VelocityIncrement;break;case n.FFFFFF:s=I.k+10*I.VelocityIncrement;break;case n.SF:case n.SFP:case n.SFZP:case n.SFPP:case n.SFZ:case n.FZ:s=I.k+6*I.VelocityIncrement;break;case n.FP:case n.RF:case n.RFZ:case n.SFFZ:s=I.k+5*I.VelocityIncrement;break;case n.N:s=1;break;case n.PF:s=I.k+(4.5*I.VelocityIncrement|0)}return s+=e*I.VelocityIncrement,Math.min(Math.max(s,1),127)}}!function(t){t[t.Tempo=0]="Tempo",t[t.Volume=1]="Volume",t[t.Instrument=2]="Instrument",t[t.Balance=3]="Balance",t[t.SyncPoint=4]="SyncPoint",t[t.Bank=4]="Bank"}(r||(r={}));class G{barOccurence=0;millisecondOffset=0}class ${isLinear=!1;type=r.Tempo;value=0;syncPointValue;ratioPosition=0;text="";isVisible=!0;static buildTempoAutomation(t,e,s,i,n=!0){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),h=new $;return h.type=r.Tempo,h.isLinear=t,h.ratioPosition=e,h.value=s*a[i],h.isVisible=n,h}static buildInstrumentAutomation(t,e,s){const i=new $;return i.type=r.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}class V{static MaxPosition=60;static MaxValue=12;offset;value;constructor(t=0,e=0){this.offset=t,this.value=e}}!function(t){t[t.Default=0]="Default",t[t.Gradual=1]="Gradual",t[t.Fast=2]="Fast"}(a||(a={})),function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Bend=2]="Bend",t[t.Release=3]="Release",t[t.BendRelease=4]="BendRelease",t[t.Hold=5]="Hold",t[t.Prebend=6]="Prebend",t[t.PrebendBend=7]="PrebendBend",t[t.PrebendRelease=8]="PrebendRelease"}(h||(h={})),function(t){t[t.None=0]="None",t[t.BrushUp=1]="BrushUp",t[t.BrushDown=2]="BrushDown",t[t.ArpeggioUp=3]="ArpeggioUp",t[t.ArpeggioDown=4]="ArpeggioDown"}(o||(o={})),function(t){t[t.None=0]="None",t[t.Crescendo=1]="Crescendo",t[t.Decrescendo=2]="Decrescendo"}(c||(c={})),function(t){t[t.QuadrupleWhole=-4]="QuadrupleWhole",t[t.DoubleWhole=-2]="DoubleWhole",t[t.Whole=1]="Whole",t[t.Half=2]="Half",t[t.Quarter=4]="Quarter",t[t.Eighth=8]="Eighth",t[t.Sixteenth=16]="Sixteenth",t[t.ThirtySecond=32]="ThirtySecond",t[t.SixtyFourth=64]="SixtyFourth",t[t.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",t[t.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(l||(l={})),function(t){t[t.None=0]="None",t[t.OnBeat=1]="OnBeat",t[t.BeforeBeat=2]="BeforeBeat",t[t.BendGrace=3]="BendGrace"}(u||(u={})),function(t){t[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Heavy=2]="Heavy",t[t.Tenuto=3]="Tenuto"}(d||(d={})),function(t){t[t.Unknown=-2]="Unknown",t[t.NoOrDead=-1]="NoOrDead",t[t.Thumb=0]="Thumb",t[t.IndexFinger=1]="IndexFinger",t[t.MiddleFinger=2]="MiddleFinger",t[t.AnnularFinger=3]="AnnularFinger",t[t.LittleFinger=4]="LittleFinger"}(f||(f={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Artificial=2]="Artificial",t[t.Pinch=3]="Pinch",t[t.Tap=4]="Tap",t[t.Semi=5]="Semi",t[t.Feedback=6]="Feedback"}(p||(p={})),function(t){t[t.Default=0]="Default",t[t.ForceNone=1]="ForceNone",t[t.ForceNatural=2]="ForceNatural",t[t.ForceSharp=3]="ForceSharp",t[t.ForceDoubleSharp=4]="ForceDoubleSharp",t[t.ForceFlat=5]="ForceFlat",t[t.ForceDoubleFlat=6]="ForceDoubleFlat"}(b||(b={})),function(t){t[t.S=0]="_15ma",t[t._=1]="_8va",t[t.Regular=2]="Regular",t[t.T=3]="_8vb",t[t.M=4]="_15mb"}(m||(m={})),function(t){t[t.None=0]="None",t[t.IntoFromBelow=1]="IntoFromBelow",t[t.IntoFromAbove=2]="IntoFromAbove"}(g||(g={})),function(t){t[t.None=0]="None",t[t.Shift=1]="Shift",t[t.Legato=2]="Legato",t[t.OutUp=3]="OutUp",t[t.OutDown=4]="OutDown",t[t.PickSlideDown=5]="PickSlideDown",t[t.PickSlideUp=6]="PickSlideUp"}(w||(w={})),function(t){t[t.None=0]="None",t[t.Slight=1]="Slight",t[t.Wide=2]="Wide"}(y||(y={})),t.TabRhythmMode=void 0,(k=t.TabRhythmMode||(t.TabRhythmMode={}))[k.Hidden=0]="Hidden",k[k.ShowWithBeams=1]="ShowWithBeams",k[k.ShowWithBars=2]="ShowWithBars",k[k.Automatic=3]="Automatic",t.FingeringMode=void 0,(S=t.FingeringMode||(t.FingeringMode={}))[S.ScoreDefault=0]="ScoreDefault",S[S.ScoreForcePiano=1]="ScoreForcePiano",S[S.SingleNoteEffectBand=2]="SingleNoteEffectBand",S[S.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",t.NotationMode=void 0,(B=t.NotationMode||(t.NotationMode={}))[B.GuitarPro=0]="GuitarPro",B[B.SongBook=1]="SongBook",t.NotationElement=void 0,(_=t.NotationElement||(t.NotationElement={}))[_.ScoreTitle=0]="ScoreTitle",_[_.ScoreSubTitle=1]="ScoreSubTitle",_[_.ScoreArtist=2]="ScoreArtist",_[_.ScoreAlbum=3]="ScoreAlbum",_[_.ScoreWords=4]="ScoreWords",_[_.ScoreMusic=5]="ScoreMusic",_[_.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",_[_.ScoreCopyright=7]="ScoreCopyright",_[_.GuitarTuning=8]="GuitarTuning",_[_.TrackNames=9]="TrackNames",_[_.ChordDiagrams=10]="ChordDiagrams",_[_.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",_[_.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",_[_.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",_[_.EffectAlternateEndings=14]="EffectAlternateEndings",_[_.EffectCapo=15]="EffectCapo",_[_.EffectChordNames=16]="EffectChordNames",_[_.EffectCrescendo=17]="EffectCrescendo",_[_.EffectDynamics=18]="EffectDynamics",_[_.EffectFadeIn=19]="EffectFadeIn",_[_.EffectFermata=20]="EffectFermata",_[_.EffectFingering=21]="EffectFingering",_[_.EffectHarmonics=22]="EffectHarmonics",_[_.EffectLetRing=23]="EffectLetRing",_[_.EffectLyrics=24]="EffectLyrics",_[_.EffectMarker=25]="EffectMarker",_[_.EffectOttavia=26]="EffectOttavia",_[_.EffectPalmMute=27]="EffectPalmMute",_[_.EffectPickSlide=28]="EffectPickSlide",_[_.EffectPickStroke=29]="EffectPickStroke",_[_.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",_[_.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",_[_.EffectTap=32]="EffectTap",_[_.EffectTempo=33]="EffectTempo",_[_.EffectText=34]="EffectText",_[_.EffectTrill=35]="EffectTrill",_[_.EffectTripletFeel=36]="EffectTripletFeel",_[_.EffectWhammyBar=37]="EffectWhammyBar",_[_.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",_[_.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",_[_.EffectLeftHandTap=40]="EffectLeftHandTap",_[_.EffectFreeTime=41]="EffectFreeTime",_[_.EffectSustainPedal=42]="EffectSustainPedal",_[_.EffectGolpe=43]="EffectGolpe",_[_.EffectWahPedal=44]="EffectWahPedal",_[_.EffectBeatBarre=45]="EffectBeatBarre",_[_.EffectNoteOrnament=46]="EffectNoteOrnament",_[_.EffectRasgueado=47]="EffectRasgueado",_[_.EffectDirections=48]="EffectDirections",_[_.EffectBeatTimer=49]="EffectBeatTimer";class H{notationMode=t.NotationMode.GuitarPro;fingeringMode=t.FingeringMode.ScoreDefault;elements=new Map;static defaultElements=new Map([[t.NotationElement.ZerosOnDiveWhammys,!1]]);rhythmMode=t.TabRhythmMode.Automatic;rhythmHeight=15;transpositionPitches=[];displayTranspositionPitches=[];smallGraceTabNotes=!0;extendBendArrowsOnTiedNotes=!0;extendLineEffectsToBeatEnd=!1;slurHeight=5;isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!H.defaultElements.has(t)||H.defaultElements.get(t)}}class U{v;L=void 0;get hasValue(){return void 0!==this.L}constructor(t){this.v=t}get value(){return void 0===this.L&&(this.L=this.v()),this.L}reset(){this.L=void 0}}t.LogLevel=void 0,(x=t.LogLevel||(t.LogLevel={}))[x.None=0]="None",x[x.Debug=1]="Debug",x[x.Info=2]="Info",x[x.Warning=3]="Warning",x[x.Error=4]="Error";class z{static logLevel=t.LogLevel.Info;static W(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(z.W(t,e),...s)}warning(t,e,...s){console.warn(z.W(t,e),...s)}info(t,e,...s){console.info(z.W(t,e),...s)}error(t,e,...s){console.error(z.W(t,e),...s)}}class j{static logLevel=t.LogLevel.Info;static log=new z;static R(e){return j.logLevel!==t.LogLevel.None&&e>=j.logLevel}static debug(e,s,...i){j.R(t.LogLevel.Debug)&&j.log.debug(e,s,...i)}static warning(e,s,...i){j.R(t.LogLevel.Warning)&&j.log.warning(e,s,...i)}static info(e,s,...i){j.R(t.LogLevel.Info)&&j.log.info(e,s,...i)}static error(e,s,...i){j.R(t.LogLevel.Error)&&j.log.error(e,s,...i)}}!function(t){t[t.NoBrackets=0]="NoBrackets",t[t.GroupStaves=1]="GroupStaves",t[t.GroupSimilarInstruments=2]="GroupSimilarInstruments"}(T||(T={})),function(t){t[t.Hidden=0]="Hidden",t[t.FirstSystem=1]="FirstSystem",t[t.AllSystems=2]="AllSystems"}(M||(M={})),function(t){t[t.FullName=0]="FullName",t[t.ShortName=1]="ShortName"}(v||(v={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(N||(N={}));class X{hideDynamics=!1;bracketExtendMode=T.GroupStaves;useSystemSignSeparator=!1;globalDisplayTuning=!0;perTrackDisplayTuning=null;globalDisplayChordDiagramsOnTop=!0;perTrackChordDiagramsOnTop=null;singleTrackTrackNamePolicy=M.FirstSystem;multiTrackTrackNamePolicy=M.FirstSystem;firstSystemTrackNameMode=v.ShortName;otherSystemsTrackNameMode=v.ShortName;firstSystemTrackNameOrientation=N.Vertical;otherSystemsTrackNameOrientation=N.Vertical;multiTrackMultiBarRest=!1;perTrackMultiBarRest=null}class J{masterBars=[];opening=null;get openings(){const t=this.opening;return t?[t]:[]}closings=[];get isOpened(){return!0===this.opening?.isRepeatStart}isClosed=!1;addMasterBar(t){null===this.opening&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class q{colors=new Map}!function(t){t[t.Neutral=0]="Neutral",t[t.C3=1]="C3",t[t.C4=2]="C4",t[t.F4=3]="F4",t[t.G2=4]="G2"}(P||(P={})),function(t){t[t.None=0]="None",t[t.Simple=1]="Simple",t[t.FirstOfDouble=2]="FirstOfDouble",t[t.SecondOfDouble=3]="SecondOfDouble"}(E||(E={})),function(t){t[t.Cb=-7]="Cb",t[t.Gb=-6]="Gb",t[t.Db=-5]="Db",t[t.Ab=-4]="Ab",t[t.Eb=-3]="Eb",t[t.Bb=-2]="Bb",t[t.F=-1]="F",t[t.C=0]="C",t[t.G=1]="G",t[t.D=2]="D",t[t.A=3]="A",t[t.E=4]="E",t[t.B=5]="B",t[t.FSharp=6]="FSharp",t[t.CSharp=7]="CSharp"}(C||(C={})),function(t){t[t.Major=0]="Major",t[t.Minor=1]="Minor"}(F||(F={})),function(t){t[t.Down=0]="Down",t[t.Hold=1]="Hold",t[t.Up=2]="Up"}(A||(A={}));class Y{ratioPosition=0;pedalType=A.Down;bar;nextPedalMarker=null;previousPedalMarker=null}!function(t){t[t.StandardNotationRepeats=0]="StandardNotationRepeats",t[t.GuitarTabsRepeats=1]="GuitarTabsRepeats",t[t.SlashRepeats=2]="SlashRepeats",t[t.NumberedRepeats=3]="NumberedRepeats",t[t.StandardNotationBarNumber=4]="StandardNotationBarNumber",t[t.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",t[t.SlashBarNumber=6]="SlashBarNumber",t[t.NumberedBarNumber=7]="NumberedBarNumber",t[t.StandardNotationBarLines=8]="StandardNotationBarLines",t[t.GuitarTabsBarLines=9]="GuitarTabsBarLines",t[t.SlashBarLines=10]="SlashBarLines",t[t.NumberedBarLines=11]="NumberedBarLines",t[t.StandardNotationClef=12]="StandardNotationClef",t[t.GuitarTabsClef=13]="GuitarTabsClef",t[t.StandardNotationKeySignature=14]="StandardNotationKeySignature",t[t.NumberedKeySignature=15]="NumberedKeySignature",t[t.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",t[t.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",t[t.SlashTimeSignature=18]="SlashTimeSignature",t[t.NumberedTimeSignature=19]="NumberedTimeSignature",t[t.StandardNotationStaffLine=20]="StandardNotationStaffLine",t[t.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",t[t.SlashStaffLine=22]="SlashStaffLine",t[t.NumberedStaffLine=23]="NumberedStaffLine"}(D||(D={}));class K extends q{}!function(t){t[t.Automatic=0]="Automatic",t[t.Dashed=1]="Dashed",t[t.Dotted=2]="Dotted",t[t.Heavy=3]="Heavy",t[t.HeavyHeavy=4]="HeavyHeavy",t[t.HeavyLight=5]="HeavyLight",t[t.LightHeavy=6]="LightHeavy",t[t.LightLight=7]="LightLight",t[t.None=8]="None",t[t.Regular=9]="Regular",t[t.Short=10]="Short",t[t.Tick=11]="Tick"}(L||(L={}));class Q{static O=0;static resetIds(){Q.O=0}id=Q.O++;index=0;nextBar=null;previousBar=null;clef=P.G2;clefOttava=m.Regular;staff;voices=[];simileMark=E.None;I=new Set([0]);get isMultiVoice(){return this.I.size>1}get filledVoices(){return this.I}displayScale=1;displayWidth=-1;sustainPedals=[];get masterBar(){return this.staff.track.score.masterBars[this.index]}$=!0;V=!0;get isEmpty(){return this.$}get hasChanges(){if(0===this.index)return!0;return!(this.keySignature===this.previousBar.keySignature&&this.keySignatureType===this.previousBar.keySignatureType&&this.clef===this.previousBar.clef&&this.clefOttava===this.previousBar.clefOttava)||(this.simileMark!==E.None||this.sustainPedals.length>0||this.barLineLeft!==L.Automatic||this.barLineRight!==L.Automatic)}get isRestOnly(){return this.V}barLineLeft=L.Automatic;barLineRight=L.Automatic;keySignature=C.C;keySignatureType=F.Major;getActualBarLineLeft(t){return Q.H(this,!1,t)}getActualBarLineRight(){return Q.H(this,!0,!1)}static U(t,e,s){let i;return i=e?t.isRepeatEnd?L.LightHeavy:t.nextMasterBar?t.isFreeTime?L.Dashed:t.isDoubleBar?L.LightLight:L.Regular:L.LightHeavy:t.isRepeatStart?L.HeavyLight:s?L.Regular:L.None,i}static H(t,e,s){const i=t.masterBar,n=e?t.barLineRight:t.barLineLeft;let r;return r=n===L.Automatic?Q.U(i,e,s):n,r}style;addVoice(t){t.bar=this,t.index=this.voices.length,this.voices.push(t)}finish(t,e=null){this.I.clear(),this.I.add(0),this.$=!0,this.V=!0;for(let s=0,i=this.voices.length;s<i;s++){const i=this.voices[s];i.finish(t,e),i.isEmpty||(this.$=!1,this.I.add(s)),i.isRestOnly||(this.V=!1)}const s=this.sustainPedals;if(s.length>0){let t=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],t.pedalType===A.Up&&(t=null));const e=null!==t&&t.pedalType!==A.Up;for(const i of s){if(t&&t.pedalType!==A.Up){if(t.bar===this&&i.ratioPosition<=t.ratioPosition)continue;t.nextPedalMarker=i,i.previousPedalMarker=t}e&&i.pedalType===A.Down&&(i.pedalType=A.Hold),i.bar=this,this.sustainPedals.push(i),t=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(t.pedalType!==A.Up){const e=new Y;e.ratioPosition=0,e.bar=this,e.pedalType=A.Hold,this.sustainPedals.push(e),t.nextPedalMarker=e,e.previousPedalMarker=t}}}calculateDuration(){let t=0;for(const e of this.voices){const s=e.calculateDuration();s>t&&(t=s)}return t}}class Z{beats=[];id="empty";isComplete=!1;addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}!function(t){t[t.Glyphs=0]="Glyphs"}(W||(W={}));class tt extends q{}let et=class t{j;$=!0;V=!0;static X=0;static resetIds(){t.X=0}id=t.X++;index=0;bar;beats=[];get isEmpty(){return this.$}style;forceNonEmpty(){this.$=!1}get isRestOnly(){return this.V}insertBeat(t,e){e.nextBeat=t.nextBeat,e.nextBeat&&(e.nextBeat.previousBeat=e),e.previousBeat=t,e.voice=this,t.nextBeat=e,this.beats.splice(t.index+1,0,e)}addBeat(t){t.voice=this,t.index=this.beats.length,this.beats.push(t),t.isEmpty||(this.$=!1),t.isRest||(this.V=!1)}J(t,e=null){if(this.bar){if(t.index<this.beats.length-1)t.nextBeat=this.beats[t.index+1],t.nextBeat.previousBeat=t;else if(t.isLastOfVoice&&t.voice.bar.nextBar){const e=this.bar.nextBar.voices[this.index];e.beats.length>0?(t.nextBeat=e.beats[0],t.nextBeat.previousBeat=t):t.nextBeat.previousBeat=t}t.chain(e)}}addGraceBeat(t){if(0===this.beats.length)return void this.addBeat(t);const e=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(t),this.addBeat(e),this.$=!1,this.V=!1}getBeatAtPlaybackStart(t){return this.j.has(t)?this.j.get(t):null}finish(t,e=null){this.$=!0,this.V=!0,this.j=new Map;let s=null;for(let t=0;t<this.beats.length;t++){const i=this.beats[t];i.index=t,this.J(i,e),i.graceType===u.None?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new Z),s.addBeat(i)),i.isEmpty||(this.$=!1),i.isRest||(this.V=!1)}let i=0,n=0;for(let s=0;s<this.beats.length;s++){const r=this.beats[s];if(r.index=s,r.finish(t,e),r.graceType===u.None){if(r.graceGroup){const t=r.graceGroup.beats[0],e=r.graceGroup.beats[r.graceGroup.beats.length-1];if(t.graceType!==u.BendGrace){const s=e.playbackStart+e.playbackDuration-t.playbackStart;switch(t.graceType){case u.BeforeBeat:t.previousBeat?(t.previousBeat.playbackDuration-=s,n=t.previousBeat.voice===this?t.previousBeat.playbackStart+t.previousBeat.playbackDuration:-s):n=-s;for(const t of r.graceGroup.beats)this.j.delete(t.playbackStart),t.playbackStart=n,this.j.set(t.playbackStart,r),n+=t.playbackDuration;break;case u.OnBeat:r.playbackDuration-=s,n=e.voice===this?e.playbackStart+e.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=n,this.j.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=n;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,n+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const t=this.beats[this.beats.length-1],e=this.beats[0];return t.playbackStart+t.playbackDuration-e.playbackStart}};var st,it,nt,rt,at,ht,ot,ct,lt,ut,dt,ft,pt,bt,mt,gt,wt,yt,kt,St,Bt,_t,xt,Tt,Mt,vt,Nt,Pt,Et,Ct,Ft,At;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(st||(st={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom",t[t.Alphabetic=3]="Alphabetic"}(it||(it={}));class Dt{width;height;constructor(t,e){this.width=t,this.height=e}}class Lt{static fillMusicFontSymbolSafe(t,e,s,i,n,r){t.settings.display.resources.engravingSettings.hasSymbol(n)&&t.fillMusicFontSymbol(e,s,i,n,r)}static fillMusicFontSymbolsSafe(t,e,s,i,n,r){const a=n.filter(e=>t.settings.display.resources.engravingSettings.hasSymbol(e));0!==a.length&&t.fillMusicFontSymbols(e,s,i,a,r)}}!function(t){t[t.Title=0]="Title",t[t.SubTitle=1]="SubTitle",t[t.Artist=2]="Artist",t[t.Album=3]="Album",t[t.Words=4]="Words",t[t.Music=5]="Music",t[t.WordsAndMusic=6]="WordsAndMusic",t[t.Transcriber=7]="Transcriber",t[t.Copyright=8]="Copyright",t[t.CopyrightSecondLine=9]="CopyrightSecondLine",t[t.ChordDiagramList=10]="ChordDiagramList"}(nt||(nt={}));class Wt{template;isVisible;textAlign;constructor(t="",e=void 0,s=st.Left){this.template=t,this.isVisible=e,this.textAlign=s}static equals(t,e){return(void 0===t.isVisible||t.isVisible)===(void 0===e.isVisible||e.isVisible)&&(t.template===e.template&&t.textAlign===e.textAlign)}buildText(t){let e=!1,s=!1;const i=this.template.replace(Wt.q,(i,n)=>{s=!0;let r="";switch(n){case"TITLE":r=t.title;break;case"SUBTITLE":r=t.subTitle;break;case"ARTIST":r=t.artist;break;case"ALBUM":r=t.album;break;case"WORDS":case"WORDSMUSIC":r=t.words;break;case"MUSIC":r=t.music;break;case"TABBER":r=t.tab;break;case"COPYRIGHT":r=t.copyright;break;default:r=""}return r&&(e=!0),r});return s&&!e?"":i}static q=/%([^%]+)%/g}class Rt extends q{headerAndFooter=new Map;static defaultHeaderAndFooter=new Map([[nt.Title,new Wt("%TITLE%",void 0,st.Center)],[nt.SubTitle,new Wt("%SUBTITLE%",void 0,st.Center)],[nt.Artist,new Wt("%ARTIST%",void 0,st.Center)],[nt.Album,new Wt("%ALBUM%",void 0,st.Center)],[nt.Words,new Wt("Words by %WORDS%",void 0,st.Left)],[nt.Music,new Wt("Music by %MUSIC%",void 0,st.Right)],[nt.WordsAndMusic,new Wt("Words & Music by %MUSIC%",void 0,st.Right)],[nt.Transcriber,new Wt("Tabbed by %TABBER%",!1,st.Right)],[nt.Copyright,new Wt("%COPYRIGHT%",void 0,st.Center)],[nt.CopyrightSecondLine,new Wt("All Rights Reserved - International Copyright Secured",!0,st.Center)]])}class Ot{Y=null;K=[];Z=0;static resetIds(){Q.resetIds(),Kt.resetIds(),et.resetIds(),Jt.resetIds()}album="";artist="";copyright="";instructions="";music="";notices="";subTitle="";title="";words="";tab="";get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}masterBars=[];tracks=[];defaultSystemsLayout=3;systemsLayout=[];stylesheet=new X;backingTrack;style;rebuildRepeatGroups(){this.Y=null,this.K=[],this.Z=0;for(const t of this.masterBars)this.tt(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,0!==this.masterBars.length&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this.tt(t),this.masterBars.push(t)}tt(t){t.isRepeatStart?(this.Y?.isClosed&&(this.K.pop(),this.Z--),this.Y=new J,this.K.push(this.Y),this.Z++):this.Y||(this.Y=new J,this.K.push(this.Y)),this.Y.addMasterBar(t),t.isRepeatEnd&&this.Z>1&&(this.K.pop(),this.Z--,this.Y=this.K.length>0?this.K[this.K.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e)}applyFlatSyncPoints(t){for(const t of this.masterBars)t.syncPoints=void 0;for(const e of t){const t=new $;t.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),t.type=r.SyncPoint,t.syncPointValue=new G,t.syncPointValue.millisecondOffset=e.millisecondOffset,t.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(t)}for(const t of this.masterBars)t.syncPoints&&t.syncPoints.sort((t,e)=>{const s=t.syncPointValue.barOccurence-e.syncPointValue.barOccurence;return 0!==s?s:t.ratioPosition-e.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}!function(t){t[t.NoTripletFeel=0]="NoTripletFeel",t[t.Triplet16th=1]="Triplet16th",t[t.Triplet8th=2]="Triplet8th",t[t.Dotted16th=3]="Dotted16th",t[t.Dotted8th=4]="Dotted8th",t[t.Scottish16th=5]="Scottish16th",t[t.Scottish8th=6]="Scottish8th"}(rt||(rt={}));class It{static MaxAlternateEndings=8;alternateEndings=0;nextMasterBar=null;previousMasterBar=null;index=0;get hasChanges(){if(0===this.index)return!1;return!(this.timeSignatureCommon===this.previousMasterBar.timeSignatureCommon&&this.timeSignatureNumerator===this.previousMasterBar.timeSignatureNumerator&&this.timeSignatureDenominator===this.previousMasterBar.timeSignatureDenominator&&this.tripletFeel===this.previousMasterBar.tripletFeel)||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(t){this.score.tracks[0].staves[0].bars[this.index].keySignature=t}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(t){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=t}isDoubleBar=!1;isRepeatStart=!1;get isRepeatEnd(){return this.repeatCount>0}repeatCount=0;repeatGroup;timeSignatureNumerator=4;timeSignatureDenominator=4;timeSignatureCommon=!1;isFreeTime=!1;tripletFeel=rt.NoTripletFeel;section=null;get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}tempoAutomations=[];syncPoints;score;fermata=null;start=0;isAnacrusis=!1;displayScale=1;displayWidth=-1;directions=null;calculateDuration(t=!0){if(this.isAnacrusis&&t){let t=0;for(const e of this.score.tracks)for(const s of e.staves){const e=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;e>t&&(t=e)}return t}return this.timeSignatureNumerator*I.valueToTicks(this.timeSignatureDenominator)}addFermata(t,e){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(t,e)}addDirection(t){null==this.directions&&(this.directions=new Set),this.directions.add(t)}getFermata(t){const e=this.fermata;return null===e?null:e.has(t.playbackStart)?e.get(t.playbackStart):0===t.index&&e.has(0)?e.get(0):null}addSyncPoint(t){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(t)}}class Gt{static DefaultChannelCount=17;static MetronomeChannel=Gt.DefaultChannelCount-1;static MetronomeKey=33;static AudioChannels=2;static MinVolume=0;static MinProgram=0;static MaxProgram=127;static MinPlaybackSpeed=.125;static MaxPlaybackSpeed=8;static PercussionChannel=9;static PercussionBank=128;static MaxPitchWheel=16384;static MaxPitchWheel20=4294967296;static DefaultPitchWheel=Gt.MaxPitchWheel/2;static MicroBufferCount=32;static MicroBufferSize=64}!function(t){t[t.None=-1]="None",t[t.Space=32]="Space",t[t.Brace=57344]="Brace",t[t.BracketTop=57347]="BracketTop",t[t.BracketBottom=57348]="BracketBottom",t[t.SystemDivider=57351]="SystemDivider",t[t.GClef=57424]="GClef",t[t.GClef15mb=57425]="GClef15mb",t[t.GClef8vb=57426]="GClef8vb",t[t.GClef8va=57427]="GClef8va",t[t.GClef15ma=57428]="GClef15ma",t[t.CClef=57436]="CClef",t[t.CClef8vb=57437]="CClef8vb",t[t.FClef=57442]="FClef",t[t.FClef15mb=57443]="FClef15mb",t[t.FClef8vb=57444]="FClef8vb",t[t.FClef8va=57445]="FClef8va",t[t.FClef15ma=57446]="FClef15ma",t[t.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",t[t.SixStringTabClef=57453]="SixStringTabClef",t[t.FourStringTabClef=57454]="FourStringTabClef",t[t.Clef8=57469]="Clef8",t[t.Clef15=57470]="Clef15",t[t.TimeSig0=57472]="TimeSig0",t[t.TimeSig1=57473]="TimeSig1",t[t.TimeSig2=57474]="TimeSig2",t[t.TimeSig3=57475]="TimeSig3",t[t.TimeSig4=57476]="TimeSig4",t[t.TimeSig5=57477]="TimeSig5",t[t.TimeSig6=57478]="TimeSig6",t[t.TimeSig7=57479]="TimeSig7",t[t.TimeSig8=57480]="TimeSig8",t[t.TimeSig9=57481]="TimeSig9",t[t.TimeSigCommon=57482]="TimeSigCommon",t[t.TimeSigCutCommon=57483]="TimeSigCutCommon",t[t.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",t[t.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",t[t.NoteheadWhole=57506]="NoteheadWhole",t[t.NoteheadHalf=57507]="NoteheadHalf",t[t.NoteheadBlack=57508]="NoteheadBlack",t[t.NoteheadNull=57509]="NoteheadNull",t[t.NoteheadXOrnate=57514]="NoteheadXOrnate",t[t.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",t[t.NoteheadPlusWhole=57517]="NoteheadPlusWhole",t[t.NoteheadPlusHalf=57518]="NoteheadPlusHalf",t[t.NoteheadPlusBlack=57519]="NoteheadPlusBlack",t[t.NoteheadSquareWhite=57528]="NoteheadSquareWhite",t[t.NoteheadSquareBlack=57529]="NoteheadSquareBlack",t[t.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",t[t.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",t[t.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",t[t.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",t[t.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",t[t.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",t[t.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",t[t.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",t[t.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",t[t.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",t[t.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",t[t.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",t[t.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",t[t.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",t[t.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",t[t.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",t[t.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",t[t.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",t[t.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",t[t.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",t[t.NoteheadCircleX=57523]="NoteheadCircleX",t[t.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",t[t.NoteheadXWhole=57511]="NoteheadXWhole",t[t.NoteheadXHalf=57512]="NoteheadXHalf",t[t.NoteheadXBlack=57513]="NoteheadXBlack",t[t.NoteheadParenthesis=57550]="NoteheadParenthesis",t[t.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",t[t.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",t[t.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",t[t.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",t[t.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",t[t.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",t[t.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",t[t.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",t[t.NoteheadCircledBlack=57572]="NoteheadCircledBlack",t[t.NoteheadCircledHalf=57573]="NoteheadCircledHalf",t[t.NoteheadCircledWhole=57574]="NoteheadCircledWhole",t[t.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",t[t.NoteheadCircleSlash=57591]="NoteheadCircleSlash",t[t.NoteheadHeavyX=57592]="NoteheadHeavyX",t[t.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",t[t.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",t[t.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",t[t.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",t[t.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",t[t.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",t[t.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",t[t.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",t[t.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",t[t.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",t[t.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",t[t.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",t[t.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",t[t.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",t[t.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",t[t.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",t[t.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",t[t.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",t[t.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",t[t.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",t[t.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",t[t.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",t[t.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",t[t.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",t[t.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",t[t.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",t[t.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",t[t.NoteQuarterUp=57813]="NoteQuarterUp",t[t.Note8thUp=57815]="Note8thUp",t[t.MetNoteQuarterUp=60581]="MetNoteQuarterUp",t[t.MetNote8thUp=60583]="MetNote8thUp",t[t.MetAugmentationDot=60599]="MetAugmentationDot",t[t.ArrowheadBlackUp=60280]="ArrowheadBlackUp",t[t.ArrowheadBlackDown=60284]="ArrowheadBlackDown",t[t.AugmentationDot=57831]="AugmentationDot",t[t.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",t[t.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",t[t.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",t[t.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",t[t.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",t[t.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",t[t.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",t[t.TextAugmentationDot=57852]="TextAugmentationDot",t[t.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",t[t.TextTuplet3LongStem=57858]="TextTuplet3LongStem",t[t.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",t[t.Tremolo3=57890]="Tremolo3",t[t.Tremolo2=57889]="Tremolo2",t[t.Tremolo1=57888]="Tremolo1",t[t.Flag8thUp=57920]="Flag8thUp",t[t.Flag8thDown=57921]="Flag8thDown",t[t.Flag16thUp=57922]="Flag16thUp",t[t.Flag16thDown=57923]="Flag16thDown",t[t.Flag32ndUp=57924]="Flag32ndUp",t[t.Flag32ndDown=57925]="Flag32ndDown",t[t.Flag64thUp=57926]="Flag64thUp",t[t.Flag64thDown=57927]="Flag64thDown",t[t.Flag128thUp=57928]="Flag128thUp",t[t.Flag128thDown=57929]="Flag128thDown",t[t.Flag256thUp=57930]="Flag256thUp",t[t.Flag256thDown=57931]="Flag256thDown",t[t.AccidentalFlat=57952]="AccidentalFlat",t[t.AccidentalNatural=57953]="AccidentalNatural",t[t.AccidentalSharp=57954]="AccidentalSharp",t[t.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",t[t.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",t[t.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",t[t.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",t[t.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",t[t.RepeatDot=57412]="RepeatDot",t[t.Segno=57415]="Segno",t[t.Coda=57416]="Coda",t[t.ArticAccentAbove=58528]="ArticAccentAbove",t[t.ArticAccentBelow=58529]="ArticAccentBelow",t[t.ArticStaccatoAbove=58530]="ArticStaccatoAbove",t[t.ArticStaccatoBelow=58531]="ArticStaccatoBelow",t[t.ArticTenutoAbove=58532]="ArticTenutoAbove",t[t.ArticTenutoBelow=58533]="ArticTenutoBelow",t[t.ArticMarcatoAbove=58540]="ArticMarcatoAbove",t[t.ArticMarcatoBelow=58541]="ArticMarcatoBelow",t[t.FermataAbove=58560]="FermataAbove",t[t.FermataShortAbove=58564]="FermataShortAbove",t[t.FermataLongAbove=58566]="FermataLongAbove",t[t.RestLonga=58593]="RestLonga",t[t.RestDoubleWhole=58594]="RestDoubleWhole",t[t.RestWhole=58595]="RestWhole",t[t.RestHalf=58596]="RestHalf",t[t.RestQuarter=58597]="RestQuarter",t[t.Rest8th=58598]="Rest8th",t[t.Rest16th=58599]="Rest16th",t[t.Rest32nd=58600]="Rest32nd",t[t.Rest64th=58601]="Rest64th",t[t.Rest128th=58602]="Rest128th",t[t.Rest256th=58603]="Rest256th",t[t.RestHBarLeft=58607]="RestHBarLeft",t[t.RestHBarMiddle=58608]="RestHBarMiddle",t[t.RestHBarRight=58609]="RestHBarRight",t[t.Repeat1Bar=58624]="Repeat1Bar",t[t.Repeat2Bars=58625]="Repeat2Bars",t[t.Ottava=58640]="Ottava",t[t.OttavaAlta=58641]="OttavaAlta",t[t.OttavaBassaVb=58652]="OttavaBassaVb",t[t.Quindicesima=58644]="Quindicesima",t[t.QuindicesimaAlta=58645]="QuindicesimaAlta",t[t.DynamicPPPPPP=58663]="DynamicPPPPPP",t[t.DynamicPPPPP=58664]="DynamicPPPPP",t[t.DynamicPPPP=58665]="DynamicPPPP",t[t.DynamicPPP=58666]="DynamicPPP",t[t.DynamicPP=58667]="DynamicPP",t[t.DynamicPiano=58656]="DynamicPiano",t[t.DynamicMP=58668]="DynamicMP",t[t.DynamicMF=58669]="DynamicMF",t[t.DynamicPF=58670]="DynamicPF",t[t.DynamicForte=58658]="DynamicForte",t[t.DynamicFF=58671]="DynamicFF",t[t.DynamicFFF=58672]="DynamicFFF",t[t.DynamicFFFF=58673]="DynamicFFFF",t[t.DynamicFFFFF=58674]="DynamicFFFFF",t[t.DynamicFFFFFF=58675]="DynamicFFFFFF",t[t.DynamicFortePiano=58676]="DynamicFortePiano",t[t.DynamicNiente=58662]="DynamicNiente",t[t.DynamicSforzando1=58678]="DynamicSforzando1",t[t.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",t[t.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",t[t.DynamicSforzato=58681]="DynamicSforzato",t[t.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",t[t.DynamicSforzatoFF=58683]="DynamicSforzatoFF",t[t.DynamicRinforzando1=58684]="DynamicRinforzando1",t[t.DynamicRinforzando2=58685]="DynamicRinforzando2",t[t.DynamicForzando=58677]="DynamicForzando",t[t.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",t[t.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",t[t.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",t[t.OrnamentTrill=58726]="OrnamentTrill",t[t.OrnamentTurn=58727]="OrnamentTurn",t[t.OrnamentTurnInverted=58728]="OrnamentTurnInverted",t[t.OrnamentShortTrill=58732]="OrnamentShortTrill",t[t.OrnamentMordent=58733]="OrnamentMordent",t[t.StringsDownBow=58896]="StringsDownBow",t[t.StringsUpBow=58898]="StringsUpBow",t[t.KeyboardPedalPed=58960]="KeyboardPedalPed",t[t.KeyboardPedalUp=58965]="KeyboardPedalUp",t[t.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",t[t.GuitarString0=59443]="GuitarString0",t[t.GuitarString1=59444]="GuitarString1",t[t.GuitarString2=59445]="GuitarString2",t[t.GuitarString3=59446]="GuitarString3",t[t.GuitarString4=59447]="GuitarString4",t[t.GuitarString5=59448]="GuitarString5",t[t.GuitarString6=59449]="GuitarString6",t[t.GuitarString7=59450]="GuitarString7",t[t.GuitarString8=59451]="GuitarString8",t[t.GuitarString9=59452]="GuitarString9",t[t.GuitarOpenPedal=59453]="GuitarOpenPedal",t[t.GuitarClosePedal=59455]="GuitarClosePedal",t[t.GuitarGolpe=59458]="GuitarGolpe",t[t.GuitarFadeIn=59459]="GuitarFadeIn",t[t.GuitarFadeOut=59460]="GuitarFadeOut",t[t.GuitarVolumeSwell=59461]="GuitarVolumeSwell",t[t.FretboardFilledCircle=59480]="FretboardFilledCircle",t[t.FretboardX=59481]="FretboardX",t[t.FretboardO=59482]="FretboardO",t[t.Tuplet0=59520]="Tuplet0",t[t.Tuplet1=59521]="Tuplet1",t[t.Tuplet2=59522]="Tuplet2",t[t.Tuplet3=59523]="Tuplet3",t[t.Tuplet4=59524]="Tuplet4",t[t.Tuplet5=59525]="Tuplet5",t[t.Tuplet6=59526]="Tuplet6",t[t.Tuplet7=59527]="Tuplet7",t[t.Tuplet8=59528]="Tuplet8",t[t.Tuplet9=59529]="Tuplet9",t[t.TupletColon=59530]="TupletColon",t[t.WiggleTrill=60068]="WiggleTrill",t[t.GuitarVibratoStroke=60082]="GuitarVibratoStroke",t[t.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",t[t.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",t[t.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",t[t.WiggleSawtooth=60091]="WiggleSawtooth",t[t.OctaveBaselineM=60565]="OctaveBaselineM",t[t.OctaveBaselineB=60563]="OctaveBaselineB",t[t.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",t[t.Fingering0=60688]="Fingering0",t[t.Fingering1=60689]="Fingering1",t[t.Fingering2=60690]="Fingering2",t[t.Fingering3=60691]="Fingering3",t[t.Fingering4=60692]="Fingering4",t[t.Fingering5=60693]="Fingering5",t[t.FingeringPLower=60695]="FingeringPLower",t[t.FingeringTLower=60696]="FingeringTLower",t[t.FingeringILower=60697]="FingeringILower",t[t.FingeringMLower=60698]="FingeringMLower",t[t.FingeringALower=60699]="FingeringALower",t[t.FingeringCLower=60700]="FingeringCLower"}(at||(at={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Sharp=2]="Sharp",t[t.Flat=3]="Flat",t[t.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",t[t.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",t[t.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",t[t.DoubleSharp=7]="DoubleSharp",t[t.DoubleFlat=8]="DoubleFlat"}(ht||(ht={}));class $t{note=null;tone=new Vt;octave=0;get realValue(){return 12*this.octave+this.tone.noteValue}}class Vt{noteValue;accidentalMode;constructor(t=0,e=b.Default){this.noteValue=t,this.accidentalMode=e}}class Ht{static getIndex(t){return t<0?0:0|Math.log2(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return 0===t}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static isTuning(t){return!!Ht.parseTuning(t)}static tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]);static parseTuning(t){let e="",s="";for(let i=0;i<t.length;i++){const n=t.charCodeAt(i);if(n>=48&&n<=57){if(!e)return null;s+=String.fromCharCode(n)}else if(0===e.length){if(!Ht.tuningLetters.has(n))return null;e+=String.fromCharCode(n)}else e+=String.fromCharCode(n)}if(!s||!e)return null;const i=new $t;i.octave=Number.parseInt(s,10)+1,i.note=e.toLowerCase();const n=Ht.getToneForText(i.note);return null===n?null:(i.tone=n,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(t){const e=Ht.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,n;switch(e.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!Ht.accidentalModeMapping.has(s))return null;switch(n=Ht.parseAccidentalMode(s),n){case b.Default:case b.ForceNone:case b.ForceNatural:break;case b.ForceSharp:i++;break;case b.ForceDoubleSharp:i+=2;break;case b.ForceFlat:i--;break;case b.ForceDoubleFlat:i-=2}return new Vt(i,n)}static reverseAccidentalModeMapping=new Map([[b.Default,"d"],[b.ForceNone,"forcenone"],[b.ForceNatural,"forcenatural"],[b.ForceSharp,"#"],[b.ForceDoubleSharp,"x"],[b.ForceFlat,"b"],[b.ForceDoubleFlat,"bb"]]);static accidentalModeMapping=new Map([["default",b.Default],["d",b.Default],["",b.Default],["forcenone",b.ForceNone],["-",b.ForceNone],["forcenatural",b.ForceNatural],["n",b.ForceNatural],["forcesharp",b.ForceSharp],["#",b.ForceSharp],["forcedoublesharp",b.ForceDoubleSharp],["##",b.ForceDoubleSharp],["x",b.ForceDoubleSharp],["forceflat",b.ForceFlat],["b",b.ForceFlat],["forcedoubleflat",b.ForceDoubleFlat],["bb",b.ForceDoubleFlat]]);static parseAccidentalMode(t){const e=t.toLowerCase();return Ht.accidentalModeMapping.has(e)?Ht.accidentalModeMapping.get(e):b.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&t))+s,t>>=4}while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<It.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(t[0].index)))return null;const n=new Map,r=t[0].score;let a=e,h=r.tempo;for(;a<=s;){const i=a;let o=null;for(;a<=s;){const s=r.masterBars[a];let n=!1;for(const t of s.tempoAutomations)t.value!==h&&(n=!0),h=t.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&n||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0)break;if(i>e&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let c=!0;for(const e of t){for(const t of e.staves){const e=t.bars[s.index];if(!e.isRestOnly){c=!1;break}if(e.index>0&&(e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType)){c=!1;break}}if(!c)break}if(!c)break;if(a++,s.index>i&&(null===o?o=[s.index]:o.push(s.index)),s.isRepeatEnd)break}o?n.set(i,o):a++}return n}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let s,i=t.style;if(t.style||(i=new Rt,t.style=i),i.headerAndFooter.has(e))s=i.headerAndFooter.get(e);else{if(s=new Wt,Rt.defaultHeaderAndFooter.has(e)){const t=Rt.defaultHeaderAndFooter.get(e);s.template=t.template,s.textAlign=t.textAlign}i.headerAndFooter.set(e,s)}return s}static consolidate(t){if(0===t.masterBars.length){const e=new It;t.addMasterBar(e);const s=new $;s.isLinear=!1,s.type=r.Tempo,s.value=t.tempo,e.tempoAutomations.push(s);const i=new Q;t.tracks[0].staves[0].addBar(i);const n=new et;i.addVoice(n);const a=new Kt;return a.isEmpty=!0,void n.addBeat(a)}const e=new Set([Gt.PercussionChannel]);for(const s of t.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=Gt.PercussionChannel,s.playbackInfo.secondaryChannel=Gt.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==Gt.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==Gt.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const e of s.staves){for(const t of e.bars)for(const e of t.voices)if(e.isEmpty&&0===e.beats.length){const t=new Kt;t.isEmpty=!0,e.addBeat(t)}const s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<t.masterBars.length;){const t=new Q;e.addBar(t);const i=t.previousBar;i&&(t.clef=i.clef,t.clefOttava=i.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);for(let e=0;e<s;e++){const e=new et;t.addVoice(e);const s=new Kt;s.isEmpty=!0,e.addBeat(s)}}}}if(t.masterBars.length>0){if(!t.masterBars[0].tempoAutomations.find(t=>t.type===r.Tempo&&0===t.ratioPosition)){const e=new $;e.isLinear=!1,e.type=r.Tempo,e.value=t.tempo,e.text=t.tempoLabel,e.isVisible=!1,t.masterBars[0].tempoAutomations.push(e)}}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];if(!s.isEmpty||s.hasChanges)return}for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];t.bars.pop(),s.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static et=[];static getAllMusicFontSymbols(){return 0===Ht.et.length&&(Ht.et=Object.values(at).filter(t=>"number"==typeof t).map(t=>t)),Ht.et}static displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]);static flooredDivision(t,e){return t-e*Math.floor(t/e)}static st(t){const e=[];for(const s of t){const t=[];e.push(t);for(const e of s){const s=Number.parseInt(e.charAt(0),10)*("b"===e.charAt(1)?-1:1);t.push(s)}}return e}static it=Ht.st([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]);static transposeKey(t,e){if(0===e)return t;if(e<0){const s=Ht.it[-e].indexOf(t);return-1===s?t:s-7}return Ht.it[e][t+7]}static nt=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]];static accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1];static computeAccidental(t,e,s,i,n=null){const r=t+7,a=s%12,h=r<7?ht.Flat:ht.Sharp,o=Ht.nt[r][a],c=Ht.accidentalNotes[a];let l=ht.None;if(i)switch(l=c?h:ht.Natural,l){case ht.Natural:l=ht.NaturalQuarterNoteUp;break;case ht.Sharp:l=ht.SharpQuarterNoteUp;break;case ht.Flat:l=ht.FlatQuarterNoteUp}else{switch(e){case b.ForceSharp:l=ht.Sharp;break;case b.ForceDoubleSharp:l=ht.DoubleSharp;break;case b.ForceFlat:l=ht.Flat;break;case b.ForceDoubleFlat:l=ht.DoubleFlat;break;default:c?l=h:o&&(l=ht.Natural)}l!==ht.None?null!=n?n===l&&(l=ht.None):o&&l===h&&(l=ht.None):null!==n&&(l=n===ht.Natural?ht.None:ht.Natural)}return l}static toArticulationId(t){return t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}}!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down"}(ot||(ot={})),function(t){t[t.Above=0]="Above",t[t.Inside=1]="Inside",t[t.Below=2]="Below",t[t.Outside=3]="Outside"}(ct||(ct={}));class Ut{elementType;staffLine;noteHeadDefault;noteHeadHalf;noteHeadWhole;techniqueSymbol;techniqueSymbolPlacement;outputMidiNumber;constructor(t="",e=0,s=0,i=at.None,n=at.None,r=at.None,a=at.None,h=ct.Inside){this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=n!==at.None?n:i,this.noteHeadWhole=r!==at.None?r:i,this.techniqueSymbol=a,this.techniqueSymbolPlacement=h}getSymbol(t){switch(t){case l.Whole:return this.noteHeadWhole;case l.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class zt{static rt=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]];static articulationFromElementVariation(t,e){return t<zt.rt.length?(e>=zt.rt.length&&(e=0),zt.rt[t][e]):38}static instrumentArticulations=new Map([[38,new Ut("snare",3,38,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[37,new Ut("snare",3,37,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[91,new Ut("snare",3,38,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite)],[42,new Ut("hiHat",-1,42,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[92,new Ut("hiHat",-1,46,at.NoteheadCircleSlash,at.NoteheadCircleSlash,at.NoteheadCircleSlash)],[46,new Ut("hiHat",-1,46,at.NoteheadCircleX,at.NoteheadCircleX,at.NoteheadCircleX)],[44,new Ut("hiHat",9,44,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[35,new Ut("kickDrum",8,35,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[36,new Ut("kickDrum",7,36,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[50,new Ut("tom",1,50,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[48,new Ut("tom",2,48,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[47,new Ut("tom",4,47,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[45,new Ut("tom",5,45,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[43,new Ut("tom",6,43,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[93,new Ut("ride",0,51,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.PictEdgeOfCymbal,ct.Below)],[51,new Ut("ride",0,51,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[53,new Ut("ride",0,53,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite)],[94,new Ut("ride",0,51,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.ArticStaccatoAbove,ct.Above)],[55,new Ut("splash",-2,55,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[95,new Ut("splash",-2,55,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.ArticStaccatoAbove,ct.Below)],[52,new Ut("china",-3,52,at.NoteheadHeavyXHat,at.NoteheadHeavyXHat,at.NoteheadHeavyXHat)],[96,new Ut("china",-3,52,at.NoteheadHeavyXHat,at.NoteheadHeavyXHat,at.NoteheadHeavyXHat)],[49,new Ut("crash",-2,49,at.NoteheadHeavyX,at.NoteheadHeavyX,at.NoteheadHeavyX)],[97,new Ut("crash",-2,49,at.NoteheadHeavyX,at.NoteheadHeavyX,at.NoteheadHeavyX,at.ArticStaccatoAbove,ct.Below)],[57,new Ut("crash",-1,57,at.NoteheadHeavyX,at.NoteheadHeavyX,at.NoteheadHeavyX)],[98,new Ut("crash",-1,57,at.NoteheadHeavyX,at.NoteheadHeavyX,at.NoteheadHeavyX,at.ArticStaccatoAbove,ct.Below)],[99,new Ut("cowbell",1,56,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpHalf,at.NoteheadTriangleUpWhole)],[100,new Ut("cowbell",1,56,at.NoteheadXBlack,at.NoteheadXHalf,at.NoteheadXWhole)],[56,new Ut("cowbell",0,56,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpHalf,at.NoteheadTriangleUpWhole)],[101,new Ut("cowbell",0,56,at.NoteheadXBlack,at.NoteheadXHalf,at.NoteheadXWhole)],[102,new Ut("cowbell",-1,56,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpHalf,at.NoteheadTriangleUpWhole)],[103,new Ut("cowbell",-1,56,at.NoteheadXBlack,at.NoteheadXHalf,at.NoteheadXWhole)],[77,new Ut("woodblock",-9,77,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack)],[76,new Ut("woodblock",-10,76,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack)],[60,new Ut("bongo",-4,60,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[104,new Ut("bongo",-5,60,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.NoteheadParenthesis,ct.Inside)],[105,new Ut("bongo",-6,60,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[61,new Ut("bongo",-7,61,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[106,new Ut("bongo",-8,61,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.NoteheadParenthesis,ct.Inside)],[107,new Ut("bongo",-16,61,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[66,new Ut("timbale",10,66,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[65,new Ut("timbale",9,65,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[68,new Ut("agogo",12,68,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[67,new Ut("agogo",11,67,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[64,new Ut("conga",17,64,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[108,new Ut("conga",16,64,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[109,new Ut("conga",15,64,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.NoteheadParenthesis,ct.Inside)],[63,new Ut("conga",14,63,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[110,new Ut("conga",13,63,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[62,new Ut("conga",19,62,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.NoteheadParenthesis,ct.Inside)],[72,new Ut("whistle",-11,72,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[71,new Ut("whistle",-17,71,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[73,new Ut("guiro",38,73,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[74,new Ut("guiro",37,74,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[86,new Ut("surdo",36,86,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[87,new Ut("surdo",35,87,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadParenthesis,ct.Inside)],[54,new Ut("tambourine",3,54,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack)],[111,new Ut("tambourine",2,54,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.StringsUpBow,ct.Below)],[112,new Ut("tambourine",1,54,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.NoteheadTriangleUpBlack,at.StringsDownBow,ct.Below)],[113,new Ut("tambourine",-7,54,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[79,new Ut("cuica",30,79,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[78,new Ut("cuica",29,78,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[58,new Ut("vibraslap",28,58,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[81,new Ut("triangle",27,81,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[80,new Ut("triangle",26,80,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadParenthesis,ct.Inside)],[114,new Ut("grancassa",25,43,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[115,new Ut("piatti",18,49,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[116,new Ut("piatti",24,49,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[69,new Ut("cabasa",23,69,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[117,new Ut("cabasa",22,69,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.StringsUpBow,ct.Below)],[85,new Ut("castanets",21,85,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[75,new Ut("claves",20,75,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[70,new Ut("maraca",-12,70,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[118,new Ut("maraca",-13,70,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.StringsUpBow,ct.Below)],[119,new Ut("maraca",-14,70,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[120,new Ut("maraca",-15,70,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.StringsUpBow,ct.Below)],[82,new Ut("shaker",-23,54,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[122,new Ut("shaker",-24,54,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.StringsUpBow,ct.Below)],[84,new Ut("bellTree",-18,53,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[123,new Ut("bellTree",-19,53,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole,at.StringsUpBow,ct.Below)],[83,new Ut("jingleBell",-20,53,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[124,new Ut("unpitched",-21,62,at.NoteheadNull,at.NoteheadNull,at.NoteheadNull,at.GuitarGolpe,ct.Above)],[125,new Ut("unpitched",-22,62,at.NoteheadNull,at.NoteheadNull,at.NoteheadNull,at.GuitarGolpe,ct.Below)],[39,new Ut("handClap",3,39,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[40,new Ut("snare",3,40,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[31,new Ut("snare",3,40,at.NoteheadSlashedBlack2,at.NoteheadSlashedBlack2,at.NoteheadSlashedBlack2)],[41,new Ut("tom",5,41,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole)],[59,new Ut("ride",2,59,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.PictEdgeOfCymbal,ct.Below)],[126,new Ut("ride",2,59,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[127,new Ut("ride",2,59,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite,at.NoteheadDiamondWhite)],[29,new Ut("ride",2,59,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack,at.ArticStaccatoAbove,ct.Above)],[30,new Ut("crash",-3,49,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[33,new Ut("snare",3,37,at.NoteheadXBlack,at.NoteheadXBlack,at.NoteheadXBlack)],[34,new Ut("snare",3,38,at.NoteheadBlack,at.NoteheadBlack,at.NoteheadBlack)]]);static instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);static getArticulationName(t){const e=zt.getArticulation(t);let s=t.percussionArticulation;e&&(s=e.outputMidiNumber);for(const[t,e]of zt.instrumentArticulationNames)if(e===s)return t;return"unknown"}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:zt.getArticulationByInputMidiNumber(e)}static getElementAndVariation(t){const e=zt.getArticulation(t);if(!e)return[-1,-1];for(let t=0;t<zt.rt.length;t++){const s=zt.rt[t];for(let i=0;i<s.length;i++){const n=zt.getArticulationByInputMidiNumber(s[i]);if(n?.outputMidiNumber===e.outputMidiNumber)return[t,i]}}return[-1,-1]}static getArticulationByInputMidiNumber(t){return zt.instrumentArticulations.has(t)?zt.instrumentArticulations.get(t):null}}!function(t){t[t.None=0]="None",t[t.InvertedTurn=1]="InvertedTurn",t[t.Turn=2]="Turn",t[t.UpperMordent=3]="UpperMordent",t[t.LowerMordent=4]="LowerMordent"}(lt||(lt={}));class jt{tieDestinationNoteId=-1;tieOriginNoteId=-1;slurDestinationNoteId=-1;slurOriginNoteId=-1;hammerPullDestinationNoteId=-1;hammerPullOriginNoteId=-1;slideTargetNoteId=-1;slideOriginNoteId=-1}!function(t){t[t.Effects=0]="Effects",t[t.StandardNotationNoteHead=1]="StandardNotationNoteHead",t[t.StandardNotationAccidentals=2]="StandardNotationAccidentals",t[t.StandardNotationEffects=3]="StandardNotationEffects",t[t.GuitarTabFretNumber=4]="GuitarTabFretNumber",t[t.GuitarTabEffects=5]="GuitarTabEffects",t[t.SlashNoteHead=6]="SlashNoteHead",t[t.SlashEffects=7]="SlashEffects",t[t.NumberedNumber=8]="NumberedNumber",t[t.NumberedAccidentals=9]="NumberedAccidentals",t[t.NumberedEffects=10]="NumberedEffects"}(ut||(ut={}));class Xt extends q{noteHead;noteHeadCenterOnStem}class Jt{static globalNoteId=0;static resetIds(){Jt.globalNoteId=0}id=Jt.globalNoteId++;index=0;accentuated=d.None;bendType=h.None;bendStyle=a.Default;bendOrigin=null;isContinuedBend=!1;bendPoints=null;maxBendPoint=null;get hasBend(){return null!==this.bendPoints&&this.bendType!==h.None}get isStringed(){return this.string>=0}fret=-1;string=-1;showStringNumber=!1;get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}octave=-1;tone=-1;get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?zt.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?zt.getElementAndVariation(this)[1]:-1}percussionArticulation=-1;isVisible=!0;isLeftHandTapped=!1;isHammerPullOrigin=!1;get isHammerPullDestination(){return!!this.hammerPullOrigin}hammerPullOrigin=null;hammerPullDestination=null;get isSlurOrigin(){return!!this.slurDestination}isSlurDestination=!1;slurOrigin=null;slurDestination=null;get isHarmonic(){return this.harmonicType!==p.None}harmonicType=p.None;harmonicValue=0;isGhost=!1;isLetRing=!1;letRingDestination=null;isPalmMute=!1;palmMuteDestination=null;isDead=!1;isStaccato=!1;slideInType=g.None;slideOutType=w.None;slideTarget=null;slideOrigin=null;vibrato=y.None;tieOrigin=null;tieDestination=null;isTieDestination=!1;get isTieOrigin(){return null!==this.tieDestination}leftHandFinger=f.Unknown;rightHandFinger=f.Unknown;get isFingering(){return this.leftHandFinger!==f.Unknown||this.rightHandFinger!==f.Unknown}trillValue=-1;get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}trillSpeed=l.ThirtySecond;durationPercent=1;accidentalMode=b.Default;beat;dynamics=n.F;isEffectSlurOrigin=!1;hasEffectSlur=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;ornament=lt.None;style;get stringTuning(){return this.beat.voice.bar.staff.capo+Jt.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(t,e){return t.tuning.length>0?t.tuning[t.tuning.length-(e-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){const s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let e=this.calculateRealValue(t,!1);return this.isStringed&&(this.harmonicType===p.Natural?e=this.harmonicPitch+this.stringTuning-s:e+=this.harmonicPitch),e}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===p.None||!this.isStringed)return 0;const t=this.harmonicValue;return Ht.isAlmostEqualTo(t,2.4)?36:Ht.isAlmostEqualTo(t,2.7)?34:t<3?0:t<=3.5?31:t<=4?28:t<=5?24:t<=6?34:t<=7?19:t<=8.5?36:t<=9?28:t<=10?34:t<=11?0:t<=12?12:t<14?0:t<=15?34:t<=16?28:t<=17?36:t<=18?0:t<=19?19:t<=21?0:t<=22?36:t<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let t=this.realValue;switch(this.harmonicType!==p.Natural&&this.harmonicType!==p.None&&(t-=this.harmonicPitch),this.beat.ottava){case m.S:t-=24;break;case m._:t-=12;break;case m.Regular:break;case m.T:t+=12;break;case m.M:t+=24}switch(this.beat.voice.bar.clefOttava){case m.S:t-=24;break;case m._:t-=12;break;case m.Regular:break;case m.T:t+=12;break;case m.M:t+=24}return t-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(t){let e=this.bendPoints;null===e&&(e=[],this.bendPoints=e),e.push(t),(!this.maxBendPoint||t.value>this.maxBendPoint.value)&&(this.maxBendPoint=t),this.bendType===h.None&&(this.bendType=h.Custom)}finish(e,s=null){const i=new U(()=>Jt.nextNoteOnSameLine(this)),n=e&&e.notation.notationMode===t.NotationMode.SongBook;if(this.isTieDestination&&(this.chain(s),n&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,n&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin){const t=Jt.findHammerPullDestination(this);t?(this.hammerPullDestination=t,t.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case w.Shift:case w.Legato:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=w.None}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===w.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===ot.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const a=this.bendPoints,o=null!=a&&a.length>0;if(o){const t=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=t}else this.bendType=h.None;if(o&&this.bendType===h.Custom)if(4===a.length){const t=a[0],e=a[1],s=a[2],i=a[3];e.value===s.value?i.value>t.value?e.value>i.value?this.bendType=h.BendRelease:!this.isContinuedBend&&t.value>0?(this.bendType=h.PrebendBend,a.splice(2,1),a.splice(1,1)):(this.bendType=h.Bend,a.splice(2,1),a.splice(1,1)):i.value<t.value?this.isContinuedBend?(this.bendType=h.Release,a.splice(2,1),a.splice(1,1)):(this.bendType=h.PrebendRelease,a.splice(2,1),a.splice(1,1)):e.value>t.value?this.bendType=h.BendRelease:t.value>0&&!this.isContinuedBend?(this.bendType=h.Prebend,a.splice(2,1),a.splice(1,1)):(this.bendType=h.Hold,a.splice(2,1),a.splice(1,1)):j.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===a.length){const t=a[0],e=a[1];e.value>t.value?!this.isContinuedBend&&t.value>0?this.bendType=h.PrebendBend:this.bendType=h.Bend:e.value<t.value?this.isContinuedBend?this.bendType=h.Release:this.bendType=h.PrebendRelease:t.value>0&&!this.isContinuedBend?this.bendType=h.Prebend:this.bendType=h.Hold}this.initialBendValue>0&&(this.accidentalMode=b.Default)}static ht=3;static nextNoteOnSameLine(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Jt.ht;){const s=e.getNoteOnString(t.string);if(s)return s;e=e.nextBeat}return null}static findHammerPullDestination(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Jt.ht;){let s=e.getNoteOnString(t.string);if(s)return s;for(let i=t.string;i>0;i--)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}e=e.nextBeat}return null}static findTieOrigin(t){let e=t.beat.previousBeat;for(;e&&e.voice.bar.index>=t.beat.voice.bar.index-Jt.ht;){if(t.isStringed){const s=e.getNoteOnString(t.string);if(s)return s}else if(-1===t.octave&&-1===t.tone){if(t.index<e.notes.length)return e.notes[t.index]}else{const s=e.getNoteWithRealValue(t.realValue);if(s)return s}e=e.previousBeat}return null}static ot="NoteIdLookup";ct=null;chain(t=null){if(null!==t)if(null!==this.ct){let e;t.has(Jt.ot)?e=t.get(Jt.ot):(e=new Map,t.set(Jt.ot,e)),-1===this.ct.hammerPullDestinationNoteId&&-1===this.ct.tieDestinationNoteId&&-1===this.ct.slurDestinationNoteId&&-1===this.ct.slideTargetNoteId||e.set(this.id,this),-1!==this.ct.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this.ct.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this.ct.tieOriginNoteId&&(this.tieOrigin=e.get(this.ct.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this.ct.slurOriginNoteId&&(this.slurOrigin=e.get(this.ct.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this.ct.slideOriginNoteId&&(this.slideOrigin=e.get(this.ct.slideOriginNoteId),this.slideOrigin.slideTarget=this),this.ct=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const t=this.tieOrigin??Jt.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(t){null!==this.tieDestination&&t.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&t.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&t.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&t.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&t.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&t.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&t.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&t.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(t,e){switch(t){case"tiedestinationnoteid":return null==this.ct&&(this.ct=new jt),this.ct.tieDestinationNoteId=e,!0;case"tieoriginnoteid":return null==this.ct&&(this.ct=new jt),this.ct.tieOriginNoteId=e,!0;case"slurdestinationnoteid":return null==this.ct&&(this.ct=new jt),this.ct.slurDestinationNoteId=e,!0;case"sluroriginnoteid":return null==this.ct&&(this.ct=new jt),this.ct.slurOriginNoteId=e,!0;case"hammerpulloriginnoteid":return null==this.ct&&(this.ct=new jt),this.ct.hammerPullOriginNoteId=e,!0;case"hammerpulldestinationnoteid":return null==this.ct&&(this.ct=new jt),this.ct.hammerPullDestinationNoteId=e,!0;case"slidetargetnoteid":return null==this.ct&&(this.ct=new jt),this.ct.slideTargetNoteId=e,!0;case"slideoriginnoteid":return null==this.ct&&(this.ct=new jt),this.ct.slideOriginNoteId=e,!0}return!1}}class qt{static lt=1920;static ut=960;static dt=480;static ft=240;static bt=120;static gt=60;static wt=30;static yt=15;static kt=[qt.lt,qt.ut,qt.dt,qt.ft,qt.bt,qt.gt,qt.wt,qt.yt];St=!0;totalDuration=0;beats=[];voice;isFull=!1;constructor(t){this.voice=t}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==u.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.playbackDuration!==this.beats[0].playbackDuration&&(this.St=!1),this.beats.push(t),this.totalDuration+=t.playbackDuration,this.St)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const e of qt.kt)if(this.totalDuration===e*t){this.isFull=!0;break}}return!0}}!function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Dive=2]="Dive",t[t.Dip=3]="Dip",t[t.Hold=4]="Hold",t[t.Predive=5]="Predive",t[t.PrediveDive=6]="PrediveDive"}(dt||(dt={})),function(t){t[t.None=0]="None",t[t.Thumb=1]="Thumb",t[t.Finger=2]="Finger"}(ft||(ft={})),function(t){t[t.None=0]="None",t[t.FadeIn=1]="FadeIn",t[t.FadeOut=2]="FadeOut",t[t.VolumeSwell=3]="VolumeSwell"}(pt||(pt={})),function(t){t[t.None=0]="None",t[t.Open=1]="Open",t[t.Closed=2]="Closed"}(bt||(bt={})),function(t){t[t.None=0]="None",t[t.Full=1]="Full",t[t.Half=2]="Half"}(mt||(mt={})),function(t){t[t.None=0]="None",t[t.Ii=1]="Ii",t[t.Mi=2]="Mi",t[t.MiiTriplet=3]="MiiTriplet",t[t.MiiAnapaest=4]="MiiAnapaest",t[t.PmpTriplet=5]="PmpTriplet",t[t.PmpAnapaest=6]="PmpAnapaest",t[t.PeiTriplet=7]="PeiTriplet",t[t.PeiAnapaest=8]="PeiAnapaest",t[t.PaiTriplet=9]="PaiTriplet",t[t.PaiAnapaest=10]="PaiAnapaest",t[t.AmiTriplet=11]="AmiTriplet",t[t.AmiAnapaest=12]="AmiAnapaest",t[t.Ppp=13]="Ppp",t[t.Amii=14]="Amii",t[t.Amip=15]="Amip",t[t.Eami=16]="Eami",t[t.Eamii=17]="Eamii",t[t.Peami=18]="Peami"}(gt||(gt={})),function(t){t[t.Auto=0]="Auto",t[t.ForceSplitToNext=1]="ForceSplitToNext",t[t.ForceMergeWithNext=2]="ForceMergeWithNext",t[t.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"}(wt||(wt={})),function(t){t[t.Effects=0]="Effects",t[t.StandardNotationStem=1]="StandardNotationStem",t[t.StandardNotationFlags=2]="StandardNotationFlags",t[t.StandardNotationBeams=3]="StandardNotationBeams",t[t.StandardNotationTuplet=4]="StandardNotationTuplet",t[t.StandardNotationEffects=5]="StandardNotationEffects",t[t.StandardNotationRests=6]="StandardNotationRests",t[t.GuitarTabStem=7]="GuitarTabStem",t[t.GuitarTabFlags=8]="GuitarTabFlags",t[t.GuitarTabBeams=9]="GuitarTabBeams",t[t.GuitarTabTuplet=10]="GuitarTabTuplet",t[t.GuitarTabEffects=11]="GuitarTabEffects",t[t.GuitarTabRests=12]="GuitarTabRests",t[t.SlashStem=13]="SlashStem",t[t.SlashFlags=14]="SlashFlags",t[t.SlashBeams=15]="SlashBeams",t[t.SlashTuplet=16]="SlashTuplet",t[t.SlashRests=17]="SlashRests",t[t.SlashEffects=18]="SlashEffects",t[t.NumberedDuration=19]="NumberedDuration",t[t.NumberedEffects=20]="NumberedEffects",t[t.NumberedRests=21]="NumberedRests",t[t.NumberedTuplet=22]="NumberedTuplet"}(yt||(yt={}));class Yt extends q{}class Kt{static Bt=0;static resetIds(){Kt.Bt=0}id=Kt.Bt++;index=0;previousBeat=null;nextBeat=null;get isLastOfVoice(){return this.index===this.voice.beats.length-1}voice;notes=[];noteStringLookup=new Map;noteValueLookup=new Map;isEmpty=!1;whammyStyle=a.Default;ottava=m.Regular;fermata=null;isLegatoOrigin=!1;get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}minNote=null;maxNote=null;maxStringNote=null;minStringNote=null;duration=l.Quarter;get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===l.Whole}isLetRing=!1;isPalmMute=!1;automations=[];dots=0;get fadeIn(){return this.fade===pt.FadeIn}set fadeIn(t){this.fade=t?pt.FadeIn:pt.None}fade=pt.None;lyrics=null;get hasRasgueado(){return this.rasgueado!==gt.None}pop=!1;slap=!1;tap=!1;text=null;slashed=!1;deadSlapped=!1;brushType=o.None;brushDuration=0;tupletDenominator=-1;tupletNumerator=-1;get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}tupletGroup=null;isContinuedWhammy=!1;whammyBarType=dt.None;whammyBarPoints=null;maxWhammyPoint=null;minWhammyPoint=null;get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==dt.None}vibrato=y.None;chordId=null;get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}graceType=u.None;graceGroup=null;graceIndex=-1;pickStroke=ot.None;get isTremolo(){return!!this.tremoloSpeed}tremoloSpeed=null;crescendo=c.None;displayStart=0;get displayEnd(){return this.displayStart+this.displayDuration}playbackStart=0;displayDuration=0;playbackDuration=0;overrideDisplayDuration;golpe=ft.None;get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}dynamics=n.F;invertBeamDirection=!1;preferredBeamDirection=null;isEffectSlurOrigin=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;beamingMode=wt.Auto;wahPedal=bt.None;barreFret=-1;barreShape=mt.None;get isBarre(){return this.barreShape!==mt.None&&this.barreFret>=0}rasgueado=gt.None;showTimer=!1;timer=null;style;addWhammyBarPoint(t){let e=this.whammyBarPoints;null===e&&(e=[],this.whammyBarPoints=e),e.push(t),(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t),(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t),this.whammyBarType===dt.None&&(this.whammyBarType=dt.Custom)}removeWhammyBarPoint(t){const e=this.whammyBarPoints;if(null===e||t<0||t>=e.length)return;e.splice(t,1);const s=e[t];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const t of e)(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const t of e)(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t)}}addNote(t){t.beat=this,t.index=this.notes.length,this.notes.push(t),t.isStringed&&this.noteStringLookup.set(t.string,t)}removeNote(t){const e=this.notes.indexOf(t);e>=0&&(this.notes.splice(e,1),t.isStringed&&this.noteStringLookup.delete(t.string))}getAutomation(t){for(let e=0,s=this.automations.length;e<s;e++){const s=this.automations[e];if(s.type===t)return s}return null}getNoteOnString(t){return this.noteStringLookup.has(t)?this.noteStringLookup.get(t):null}_t(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let t=I.toTicks(this.duration);return 2===this.dots?t=I.applyDot(t,!0):1===this.dots&&(t=I.applyDot(t,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(t=I.applyTuplet(t,this.tupletNumerator,this.tupletDenominator)),t}updateDurations(){const t=this._t();switch(this.playbackDuration=t,this.graceType){case u.BeforeBeat:case u.OnBeat:switch(this.duration){case l.Sixteenth:this.playbackDuration=I.toTicks(l.SixtyFourth);break;case l.ThirtySecond:this.playbackDuration=I.toTicks(l.OneHundredTwentyEighth);break;default:this.playbackDuration=I.toTicks(l.ThirtySecond)}this.displayDuration=0;break;case u.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=t;const e=this.previousBeat;e&&e.graceType===u.BendGrace&&(this.playbackDuration=e.playbackDuration)}}finishTuplet(){const t=this.previousBeat;let e=t?t.tupletGroup:null;(this.hasTuplet||this.graceType!==u.None&&e)&&(t&&e&&e.check(this)||(e=new qt(this.voice),e.check(this)),this.tupletGroup=e);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const t of this.automations)0===t.ratioPosition&&(t.ratioPosition=this.playbackStart/s),t.type!==r.Tempo&&i.push(t);this.automations=i}finish(e,s=null){switch(null===this.getAutomation(r.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push($.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case u.OnBeat:case u.BeforeBeat:const t=this.graceGroup.beats.length;this.duration=1===t?l.Eighth:2===t?l.Sixteenth:l.ThirtySecond}this.brushType===o.None&&(this.brushDuration=0);const i=e?e.notation.notationMode:t.NotationMode.GuitarPro;let n="grad"===this.text||"grad."===this.text;n&&i===t.NotationMode.SongBook&&(this.text="");let c=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let d=0,f=!1;for(let r=0,o=this.notes.length;r<o;r++){const o=this.notes[r];if(o.dynamics=this.dynamics,o.finish(e,s),o.isLetRing&&(this.isLetRing=!0),o.isPalmMute&&(this.isPalmMute=!0),i===t.NotationMode.SongBook&&o.hasBend&&this.graceType!==u.BendGrace){if(!o.isTieOrigin)switch(o.bendType){case h.Bend:case h.PrebendRelease:case h.PrebendBend:c=!0}n||o.bendStyle===a.Gradual?(n=!0,o.bendStyle=a.Gradual,c=!1):o.bendStyle=a.Fast}o.isVisible&&(d++,(!this.minNote||o.realValue<this.minNote.realValue)&&(this.minNote=o),(!this.maxNote||o.realValue>this.maxNote.realValue)&&(this.maxNote=o),(!this.minStringNote||o.string<this.minStringNote.string)&&(this.minStringNote=o),(!this.maxStringNote||o.string>this.maxStringNote.string)&&(this.maxStringNote=o),o.hasEffectSlur&&(f=!0))}if(f&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===d&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&e&&e.notation.notationMode===t.NotationMode.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let t=this.previousBeat;for(;t&&t.isRest;)this.isLetRing||(t.isLetRing=!1),this.isPalmMute||(t.isPalmMute=!1),t=t.previousBeat}const p=this.whammyBarPoints,b=null!==p&&p.length>0;if(b){const t=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=t}else this.whammyBarType=dt.None;if(b&&this.whammyBarType===dt.Custom)if(i===t.NotationMode.SongBook&&(this.whammyStyle=n?a.Gradual:a.Fast),4===p.length){const e=p[0],s=p[1],n=p[2],r=p[3];s.value===n.value&&(e.value<s.value&&s.value<r.value||e.value>s.value&&s.value>r.value?(0===e.value||this.isContinuedWhammy?this.whammyBarType=dt.Dive:this.whammyBarType=dt.PrediveDive,p.splice(2,1),p.splice(1,1)):e.value>s.value&&s.value<r.value||e.value<s.value&&s.value>r.value?(this.whammyBarType=dt.Dip,s.offset!==n.offset&&i!==t.NotationMode.SongBook||p.splice(2,1)):e.value===s.value&&s.value===r.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=dt.Hold:this.whammyBarType=dt.Predive,p.splice(2,1),p.splice(1,1)))}else if(2===p.length){const t=p[0],e=p[1];t.value<e.value||t.value>e.value?0===t.value||this.isContinuedWhammy?this.whammyBarType=dt.Dive:this.whammyBarType=dt.PrediveDive:t.value===e.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=dt.Hold:this.whammyBarType=dt.Predive)}if(this.updateDurations(),c){const t=se.clone(this);t.id=Kt.Bt++,t.pickStroke=ot.None;for(let e=0,s=t.notes.length;e<s;e++){const s=t.notes[e],i=this.notes[e];if(s.bendType=h.None,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=a.Default,s.id=Jt.globalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){const t=Jt.findTieOrigin(i);if(t&&t.hasBend){s.bendType=h.Hold;const t=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new V(0,t.value)),s.addBendPoint(new V(V.MaxPosition,t.value))}}s.isTieDestination=!0}this.graceType=u.BendGrace,this.graceGroup=new Z,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,t),t.graceGroup=new Z,t.graceGroup.addBeat(this),t.graceGroup.isComplete=!0,t.graceGroup.finish()}}isBefore(t){return this.voice.bar.index<t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index<t.index}isAfter(t){return this.voice.bar.index>t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index>t.index}hasNoteOnString(t){return this.noteStringLookup.has(t)}getNoteWithRealValue(t){return this.noteValueLookup.has(t)?this.noteValueLookup.get(t):null}chain(t=null){for(const e of this.notes)this.noteValueLookup.set(e.realValue,e),e.chain(t)}}class Qt{static clone(t){const e=new V;return e.offset=t.offset,e.value=t.value,e}}class Zt{static clone(t){const e=new Jt;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(Qt.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class te{static clone(t){const e=new G;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class ee{static clone(t){const e=new $;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?te.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e.isVisible=t.isVisible,e}}class se{static clone(t){const e=new Kt;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(Zt.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(ee.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(Qt.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloSpeed=t.tremoloSpeed,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}class ie{static xt(t){const e=new Map;for(const[s,i]of t)e.has(i)||e.set(i,s);return e}static whammyType=new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]]);static whammyTypeReversed=ie.xt(ie.whammyType);static bendStyle=new Map([["default",0],["gradual",1],["fast",2]]);static bendStyleReversed=ie.xt(ie.bendStyle);static graceType=new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]]);static graceTypeReversed=ie.xt(ie.graceType);static fermataType=new Map([["short",0],["medium",1],["long",2]]);static fermataTypeReversed=ie.xt(ie.fermataType);static alphaTexAccidentalMode=new Map([["auto",0],["explicit",1]]);static alphaTexAccidentalModeReversed=ie.xt(ie.alphaTexAccidentalMode);static noteAccidentalMode=new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]]);static noteAccidentalModeReversed=ie.xt(ie.noteAccidentalMode);static barreShape=new Map([["full",1],["half",2]]);static barreShapeReversed=ie.xt(ie.barreShape);static ottavia=new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]]);static ottaviaReversed=ie.xt(ie.ottavia);static rasgueado=new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]]);static rasgueadoReversed=ie.xt(ie.rasgueado);static dynamicValue=new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]]);static dynamicValueReversed=ie.xt(ie.dynamicValue);static bracketExtendMode=new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]]);static bracketExtendModeReversed=ie.xt(ie.bracketExtendMode);static trackNamePolicy=new Map([["hidden",0],["firstsystem",1],["allsystems",2]]);static trackNamePolicyReversed=ie.xt(ie.trackNamePolicy);static trackNameOrientation=new Map([["horizontal",0],["vertical",1]]);static trackNameOrientationReversed=ie.xt(ie.trackNameOrientation);static trackNameMode=new Map([["fullname",0],["shortname",1]]);static trackNameModeReversed=ie.xt(ie.trackNameMode);static textAlign=new Map([["left",0],["center",1],["right",2]]);static textAlignReversed=ie.xt(ie.textAlign);static bendType=new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]]);static bendTypeReversed=ie.xt(ie.bendType);static keySignature=new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]]);static keySignatureReversed=ie.xt(ie.keySignature);static keySignatureType=new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]]);static keySignatureTypeReversed=ie.xt(ie.keySignatureType);static clef=new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]]);static clefReversed=ie.xt(ie.clef);static tripletFeel=new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]);static tripletFeelReversed=ie.xt(ie.tripletFeel);static barLineStyle=new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]]);static barLineStyleReversed=ie.xt(ie.barLineStyle);static simileMark=new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]]);static simileMarkReversed=ie.xt(ie.simileMark);static direction=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]);static directionReversed=ie.xt(ie.direction);static keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]);static keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]])}class ne{static Tt(t){return t?{expectedTypes:new Set(t[0]),parseMode:t[1],allowedValues:t.length>2&&t[2]&&t[2].length>0?new Set(t[2]):void 0,reservedIdentifiers:t.length>3&&t[3]&&t[3].length>0?new Set(t[3]):void 0}:null}static Mt(t){return null==t?null:t.map(t=>({isStrict:t.length>0&&null===t[0],parameters:t.map(ne.Tt).filter(t=>null!==t)}))}static vt(t){return new Map(t.map(t=>[t[0],null===t[1]?null:new Map(t[1].map(t=>[t[0],ne.Mt(t[1])]))]))}static Nt(t){return new Map(t.map(t=>[t[0],ne.Mt(t[1])]))}static Pt(t){return new Map(t.map(t=>[t[0],ne.Mt(t[1])]))}static scoreMetaDataSignatures=ne.Pt([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]]]);static staffMetaDataSignatures=ne.Pt([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]]);static structuralMetaDataSignatures=ne.Pt([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]]);static barMetaDataSignatures=ne.Pt([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null]]);static metaDataProperties=ne.vt([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null]]);static metaDataSignatures=[ne.scoreMetaDataSignatures,ne.staffMetaDataSignatures,ne.structuralMetaDataSignatures,ne.barMetaDataSignatures];static durationChangeProperties=ne.Nt([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]]);static beatProperties=ne.Nt([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0,["8","16","32"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]]);static noteProperties=ne.Nt([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]])}!function(t){t[t.Dot=0]="Dot",t[t.Backslash=1]="Backslash",t[t.DoubleBackslash=2]="DoubleBackslash",t[t.Pipe=3]="Pipe",t[t.LBrace=4]="LBrace",t[t.RBrace=5]="RBrace",t[t.LParen=6]="LParen",t[t.RParen=7]="RParen",t[t.Colon=8]="Colon",t[t.Asterisk=9]="Asterisk",t[t.Ident=10]="Ident",t[t.Tag=11]="Tag",t[t.Meta=12]="Meta",t[t.Arguments=13]="Arguments",t[t.Props=14]="Props",t[t.Prop=15]="Prop",t[t.Number=16]="Number",t[t.String=17]="String",t[t.Score=18]="Score",t[t.Bar=19]="Bar",t[t.Beat=20]="Beat",t[t.Duration=21]="Duration",t[t.NoteList=22]="NoteList",t[t.Note=23]="Note"}(kt||(kt={})),function(t){t[t.Hint=0]="Hint",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(St||(St={})),function(t){t[t.AT001=1]="AT001",t[t.AT002=2]="AT002",t[t.AT003=3]="AT003",t[t.AT004=4]="AT004",t[t.AT005=5]="AT005",t[t.AT006=6]="AT006",t[t.AT200=200]="AT200",t[t.AT201=201]="AT201",t[t.AT202=202]="AT202",t[t.AT203=203]="AT203",t[t.AT204=204]="AT204",t[t.AT205=205]="AT205",t[t.AT206=206]="AT206",t[t.AT207=207]="AT207",t[t.AT208=208]="AT208",t[t.AT209=209]="AT209",t[t.AT210=210]="AT210",t[t.AT211=211]="AT211",t[t.AT212=212]="AT212",t[t.AT213=213]="AT213",t[t.AT214=214]="AT214",t[t.AT215=215]="AT215",t[t.AT216=216]="AT216",t[t.AT217=217]="AT217",t[t.AT218=218]="AT218",t[t.AT219=219]="AT219",t[t.AT220=220]="AT220",t[t.AT300=300]="AT300",t[t.AT301=301]="AT301",t[t.AT302=302]="AT302",t[t.AT303=303]="AT303",t[t.AT304=304]="AT304",t[t.AT305=305]="AT305",t[t.AT306=306]="AT306",t[t.AT400=400]="AT400"}(Bt||(Bt={}));class re{Et=!1;items=[];get errors(){return this.items.filter(t=>t.severity===St.Error)}get hasErrors(){return this.Et}push(t){this.items.push(t),t.severity===St.Error&&(this.Et=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}!function(t){t[t.Auto=0]="Auto",t[t.Explicit=1]="Explicit"}(_t||(_t={})),function(t){t[t.Pitched=0]="Pitched",t[t.Fretted=1]="Fretted",t[t.Articulation=2]="Articulation"}(xt||(xt={})),function(t){t[t.Required=0]="Required",t[t.Optional=1]="Optional",t[t.RequiredAsFloat=2]="RequiredAsFloat",t[t.OptionalAsFloat=3]="OptionalAsFloat",t[t.RequiredAsValueList=4]="RequiredAsValueList",t[t.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"}(Tt||(Tt={}));class ae{static Ct=new ArrayBuffer(8);static Ft=new Uint8Array(ae.Ct);static At=new DataView(ae.Ct);static float64ToBytes(t){return ae.At.setFloat64(0,t,!0),ae.Ft}static bytesToInt64LE(t){ae.Ft.set(t,0);const e=ae.At.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return ae.Ft.set(t,0),ae.At.getFloat64(0,!0)}static bytesToFloat32LE(t){return ae.Ft.set(t,0),ae.At.getFloat32(0,!0)}static float32BEToBytes(t){return ae.At.setFloat32(0,t,!1),ae.Ft.slice(0,4)}static uint16ToInt16(t){return ae.At.setUint16(0,t,!0),ae.At.getInt16(0,!0)}static int16ToUint32(t){return ae.At.setInt16(0,t,!0),ae.At.getUint32(0,!0)}static int32ToUint16(t){return ae.At.setInt32(0,t,!0),ae.At.getUint16(0,!0)}static int32ToInt16(t){return ae.At.setInt32(0,t,!0),ae.At.getInt16(0,!0)}static int32ToUint32(t){return ae.At.setInt32(0,t,!0),ae.At.getUint32(0,!0)}static uint8ToInt8(t){return ae.At.setUint8(0,t),ae.At.getInt8(0)}}class he{static readInt32BE(t){return t.readByte()<<24|t.readByte()<<16|t.readByte()<<8|t.readByte()}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),ae.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),ae.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),ae.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){const s=t[e],i=t[e+1],n=t[e+2];return t[e+3]<<24|n<<16|i<<8|s}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return ae.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return ae.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),n=t.readByte();return ae.int32ToUint32(e<<24|s<<16|i<<8|n)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return ae.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return ae.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),he.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;0!==s;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let n=0;n<e;n++){const e=t.readByte();0===e&&-1===i&&(i=n),s+=String.fromCharCode(e)}const n=s;return i>=0?n.substr(0,i):n}static readSInt8(t){const e=t.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return 8388608&~s||(s|=255<<24),s}static readInt16(t,e){return ae.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=he.Dt(t);s&&(e=s),e||(e="utf-8");return new TextDecoder(e).decode(t.buffer)}static Dt(t){return t.length>2&&254===t[0]&&255===t[1]?"utf-16be":t.length>2&&255===t[0]&&254===t[1]?"utf-16le":t.length>4&&0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]?"utf-32be":t.length>4&&255===t[0]&&254===t[1]&&0===t[2]&&0===t[3]?"utf-32le":null}static stringToBytes(t){return(new TextEncoder).encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(255&e)}static writeInt32LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(255&e)}static writeFloat32BE(t,e){const s=ae.float32BEToBytes(e);t.write(s,0,s.length)}static*iterateCodepoints(t){let e=0;for(;e<t.length;){let s=t.charCodeAt(e);he.isLeadingSurrogate(s)&&e+1<t.length&&(e++,s=1024*(s-55296)+(t.charCodeAt(e)-56320)+65536),e++,yield s}}static isLeadingSurrogate(t){return t>=55296&&t<=56319}static isTrailingSurrogate(t){return t>=56320&&t<=57343}}class oe{static Lt=0;Wt;Rt=oe.Lt;Ot=0;It=1;Gt=1;fatalError=!1;$t={line:0,col:0,offset:0};Vt;Ht;Ut;zt;lexerDiagnostics=new re;constructor(t){this.Wt=[...he.iterateCodepoints(t)],this.Ot=0,this.It=1,this.Gt=1,this.Rt=this.Wt.length>0?this.Wt[0]:oe.Lt}peekToken(){if(this.fatalError)return;let t=this.zt;return t||(t=this.jt(),this.zt=t,t)}extendToFloat(t){if(46!==this.Rt||this.Ot+1>=this.Wt.length||!oe.Xt(this.Wt[this.Ot+1]))return t;let e=this.Ot+2;for(;e<this.Wt.length&&oe.Xt(this.Wt[e]);)e++;if(e<this.Wt.length&&oe.Jt(this.Wt[e]))return t;const s=e-this.Ot-1;return this.Ot+=s,this.Gt+=s,this.qt(),t.end=this.Yt(),t.value=Number.parseFloat(String.fromCodePoint(...this.Wt.slice(t.start.offset,t.end.offset))),t}advance(){this.Ut=this.zt,this.zt=void 0}qt(){const t=this.Wt;let e=this.Ot;if(e<t.length-1){10===t[e]?(this.Ht=void 0,++this.It,this.Gt=1):++this.Gt,++e;const s=t[e];return this.Rt=s,this.Ot=e,s}return this.Rt!==oe.Lt&&(this.Rt=oe.Lt,++this.Gt,this.Ot=t.length),oe.Lt}previousTokenEndLocation(){return this.Ut?.end??this.Yt()}currentTokenLocation(){return this.zt?.start??this.Yt()}Yt(){return{line:this.It,col:this.Gt,offset:this.Ot}}jt(){for(this.Vt=void 0;this.Rt!==oe.Lt&&!this.fatalError;)if(this.$t=this.Yt(),oe.Kt.has(this.Rt)){const t=oe.Kt.get(this.Rt)(this);if(t)return this.Ht=t,t}else{if(oe.Jt(this.Rt)){const t=this.Qt();return this.Ht=t,t}this.Rt=this.qt()}}Zt(){this.Rt=this.qt(),47===this.Rt?this.te():42===this.Rt?this.ee():(this.lexerDiagnostics.push({code:Bt.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this.Rt)}'`,severity:St.Error,start:this.$t,end:this.Yt()}),this.fatalError=!0)}static Kt=new Map([[47,t=>t.Zt()],[34,t=>t.se()],[39,t=>t.se()],[45,t=>t.Qt()],[46,t=>t.ie({nodeType:kt.Dot})],[58,t=>t.ie({nodeType:kt.Colon})],[40,t=>t.ie({nodeType:kt.LParen})],[41,t=>t.ie({nodeType:kt.RParen})],[123,t=>t.ie({nodeType:kt.LBrace})],[125,t=>t.ie({nodeType:kt.RBrace})],[124,t=>t.ie({nodeType:kt.Pipe})],[42,t=>t.ie({nodeType:kt.Asterisk})],[92,t=>t.ne()],[9,t=>t.re()],[10,t=>t.re()],[11,t=>t.re()],[13,t=>t.re()],[32,t=>t.re()]]);ne(){const t=this.Yt();let e,s;this.Rt=this.qt(),92===this.Rt?(this.Rt=this.qt(),s=this.Yt(),e={nodeType:kt.DoubleBackslash,start:t,end:s}):(s=this.Yt(),e={nodeType:kt.Backslash,start:t,end:s});let i="";for(;oe.Jt(this.Rt);)i+=String.fromCodePoint(this.Rt),this.Rt=this.qt();if(0===i.length)return void this.lexerDiagnostics.push({code:Bt.AT002,message:"Missing identifier after meta data start",severity:St.Error,start:this.$t,end:this.Yt()});return{nodeType:kt.Tag,leadingComments:this.Vt,start:this.$t,end:this.Yt(),prefix:e,tag:{nodeType:kt.Ident,text:i,start:s,end:this.Yt()}}}ie(t){return t.leadingComments=this.Vt,t.start=this.$t,this.Rt=this.qt(),t.end=this.Yt(),t}se(){const t=this.Rt;this.Rt=this.qt();let e="",s=-1;for(;this.Rt!==t&&this.Rt!==oe.Lt;){let i=-1;if(92===this.Rt)if(this.Rt=this.qt(),92===this.Rt)i=92;else if(this.Rt===t)i=t;else if(82===this.Rt||114===this.Rt)i=13;else if(78===this.Rt||110===this.Rt)i=10;else if(84===this.Rt||116===this.Rt)i=9;else{if(117!==this.Rt)return this.lexerDiagnostics.push({code:Bt.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this.Rt)}'.`,severity:St.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);{let t="";for(let e=0;e<4;e++){if(this.Rt=this.qt(),this.Rt===oe.Lt)return this.lexerDiagnostics.push({code:Bt.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:St.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);t+=String.fromCodePoint(this.Rt)}if(i=Number.parseInt(t,16),Number.isNaN(i))return this.lexerDiagnostics.push({code:Bt.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:St.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0)}}else i=this.Rt;he.isLeadingSurrogate(s)&&he.isTrailingSurrogate(i)?(i=1024*(s-55296)+(i-56320)+65536,e+=String.fromCodePoint(i)):he.isLeadingSurrogate(i)||(he.isLeadingSurrogate(s)&&(e+=String.fromCodePoint(s)),i>0&&(e+=String.fromCodePoint(i))),s=i,this.Rt=this.qt()}if(this.Rt===oe.Lt)return this.lexerDiagnostics.push({code:Bt.AT006,message:"Unexpected end of file. String not closed.",severity:St.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);const i={nodeType:kt.String,text:e,leadingComments:this.Vt,start:this.$t,end:this.Yt()};return this.Rt=this.qt(),i}ee(){const t=this.Ht,e={start:this.$t,end:this.Yt(),text:"",multiLine:!0};for(;this.Rt!==oe.Lt;)if(42===this.Rt){if(this.Rt=this.qt(),47===this.Rt){this.Rt=this.qt();break}e.text+=`*${String.fromCodePoint(this.Rt)}`,e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Ot}else this.Rt=this.qt(),e.text+=String.fromCodePoint(this.Rt),e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Ot;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Vt??=[],this.Vt.push(e))}Qt(){let t="",e=!0,s=this.Rt;45===s&&(t+=String.fromCodePoint(s),s=this.qt(),oe.Xt(s)||(e=!1));let i=!0;do{e?oe.Xt(s)?(t+=String.fromCodePoint(s),s=this.qt(),i=!0):oe.Jt(s)?(e=!1,t+=String.fromCodePoint(s),s=this.qt(),i=!0):i=!1:oe.Jt(s)?(t+=String.fromCodePoint(s),s=this.qt(),i=!0):i=!1}while(i);if(e){return{nodeType:kt.Number,leadingComments:this.Vt,start:this.$t,end:this.Yt(),value:Number.parseInt(t,10)}}return{nodeType:kt.Ident,leadingComments:this.Vt,start:this.$t,end:this.Yt(),text:t}}te(){const t=this.Ht,e={start:this.$t,end:this.Yt(),text:"",multiLine:!1};let s=this.Rt;for(;s!==oe.Lt&&(s=this.qt(),10!==s&&s!==oe.Lt);)e.text+=String.fromCodePoint(s),e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Ot;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Vt??=[],this.Vt.push(e))}re(){let t=this.Rt;for(;oe.ae(t);)10===t&&(this.Ht=void 0),t=this.qt()}static Xt(t){return t>=48&&t<=57}static he(){const t=new Set;for(const e of oe.Kt.keys())t.add(e);return t.delete(45),t.add(oe.Lt),t}static oe=oe.he();static Jt(t){return!oe.oe.has(t)}static ae(t){return 32===t||10===t||13===t||9===t||11===t}}!function(t){t[t.ForModelImport=0]="ForModelImport",t[t.Full=1]="Full"}(Mt||(Mt={}));class ce{lexer;ce;le=ue.instance;mode=Mt.ForModelImport;get lexerDiagnostics(){return this.lexer.lexerDiagnostics}parserDiagnostics=new re;addParserDiagnostic(t){this.parserDiagnostics.push(t)}unexpectedToken(t,e,s){t?this.addParserDiagnostic({code:Bt.AT202,message:`Unexpected '${kt[t.nodeType]}' token. Expected one of following: ${e.map(t=>kt[t]).join(",")}`,severity:St.Error,start:t.start,end:t.end}):this.addParserDiagnostic({code:Bt.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:St.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}constructor(t){this.lexer=new oe(t)}read(){return this.ue(),this.ce}ue(){this.ce={nodeType:kt.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this.de()}finally{this.ce.end=this.lexer.previousTokenEndLocation()}}de(){let t=this.lexer.peekToken();for(;t;)this.fe(),t=this.lexer.peekToken()}fe(){const t={nodeType:kt.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this.ce.bars.push(t);try{this.pe(t),this.be(t);const e=this.lexer.peekToken();e?.nodeType===kt.Pipe&&(t.pipe=e,this.lexer.advance()),(t.metaData.length>0||t.beats.length>0||t.pipe)&&(t.end=this.lexer.previousTokenEndLocation())}finally{t.end=this.lexer.previousTokenEndLocation()}}pe(t){let e=this.lexer.peekToken();for(;e&&(e.nodeType===kt.Tag||e.nodeType===kt.Dot);)e.nodeType===kt.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:Bt.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:St.Hint,start:e.start,end:e.end})):this.me(t.metaData),e=this.lexer.peekToken()}be(t){let e=this.lexer.peekToken();for(;e&&e.nodeType!==kt.Pipe&&e.nodeType!==kt.Dot&&e.nodeType!==kt.Tag;){const s=this.ge();s&&t.beats.push(s),e=this.lexer.peekToken()}}ge(){const t={nodeType:kt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(this.we(t),this.ye(t),!t.notes&&!t.rest)return t;this.ke(t),this.Se(t),t.beatEffects=this.Be(t=>this.le.readBeatPropertyArguments(this,t)),void 0!==t.beatMultiplierValue&&t.beatEffects?.openBrace&&this.addParserDiagnostic({code:Bt.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:St.Warning,start:t.beatMultiplier.start,end:t.beatMultiplierValue.end}),this.Se(t)}finally{t.end=this.lexer.previousTokenEndLocation()}return t}ke(t){const e=this.lexer.peekToken();if(e?.nodeType!==kt.Dot)return;t.durationDot=e,this.lexer.advance();const s=this.lexer.peekToken();if(s?.nodeType===kt.Number)return t.durationValue=s,void this.lexer.advance();s?.nodeType!==kt.Tag?s&&this.unexpectedToken(s,[kt.Number],!0):t.durationDot=void 0}we(t){const e=this.lexer.peekToken();if(e?.nodeType!==kt.Colon)return;this.lexer.advance();const s={nodeType:kt.Duration,colon:e,value:void 0,properties:void 0,start:e.start};t.durationChange=s;try{const t=this.lexer.peekToken();if(!t||t.nodeType!==kt.Number)return void this.addParserDiagnostic({code:Bt.AT201,message:"Missing duration value after ':'.",severity:St.Error,start:e.start,end:e.end});this.lexer.advance(),s.value=t,s.properties=this.Be(t=>this.le.readDurationChangePropertyArguments(this,t))}finally{s.end=this.lexer.previousTokenEndLocation()}}ye(t){const e=this.lexer.peekToken();if(e)if(e.nodeType===kt.Ident&&"r"===e.text)t.rest=e,this.lexer.advance();else if(e.nodeType===kt.LParen)t.notes=this._e(e);else{const s=this.xe(e);s&&(t.notes={nodeType:kt.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}Se(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==kt.Asterisk)return;this.lexer.advance(),t.beatMultiplier=e;const s=this.lexer.peekToken();s&&s.nodeType===kt.Number?(t.beatMultiplierValue=s,this.lexer.advance()):this.addParserDiagnostic({code:Bt.AT200,message:"Missing beat multiplier value after '*'.",severity:St.Error,start:t.beatMultiplier.start,end:t.beatMultiplier.end})}_e(t){const e={nodeType:kt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{e.openParenthesis=t,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==kt.RParen;){const t=this.xe(s);if(!t)break;e.notes.push(t),s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===kt.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:Bt.AT206,message:"Unexpected end of file. Group not closed.",severity:St.Error,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}xe(t){const e={nodeType:kt.Note,noteValue:{nodeType:kt.Ident,text:""},start:t.start};try{let s=!1;switch(t.nodeType){case kt.Number:e.noteValue=t,this.lexer.advance(),s=!0;break;case kt.String:case kt.Ident:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0}break;default:return void this.unexpectedToken(t,[kt.Number,kt.String,kt.Ident],!0)}if(s){const t=this.lexer.peekToken();if(t?.nodeType===kt.Dot){const s=t;this.lexer.advance();const i=this.lexer.peekToken();if(!i)return void this.unexpectedToken(i,[kt.Number],!0);if(i.nodeType===kt.Tag)return e;if(i.nodeType!==kt.Number)return void this.unexpectedToken(i,[kt.Number],!0);e.noteStringDot=s,e.noteString=i,this.lexer.advance()}}e.noteEffects=this.Be(t=>this.le.readNotePropertyArguments(this,t))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}me(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==kt.Tag)return;const s={nodeType:kt.Meta,tag:e,start:e.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),t.push(s);try{const t=this.lexer.peekToken();t?.nodeType===kt.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this.Be(t=>this.le.readMetaDataPropertyArguments(this,s.tag,t)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this.le.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:Bt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:St.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}),this.addParserDiagnostic({code:Bt.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:St.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})))):(s.arguments=this.argumentList(),s.arguments||(s.arguments=this.le.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:Bt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:St.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})),s.properties=this.Be(t=>this.le.readMetaDataPropertyArguments(this,s.tag,t)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Be(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==kt.LBrace)return;const s={nodeType:kt.Props,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e?.nodeType===kt.Ident;)s.properties.push(this.Te(e,t)),e=this.lexer.peekToken();const i=this.lexer.peekToken();i?.nodeType===kt.RBrace?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:Bt.AT206,message:"Unexpected end of file. Group not closed.",severity:St.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Te(t,e){const s={nodeType:kt.Prop,property:t,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=e(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:Bt.AT303,message:"Property args should be wrapped into parenthesis.",severity:St.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const t=this.lexer.peekToken();if(t?.nodeType!==kt.LParen)return;const e={nodeType:kt.Arguments,openParenthesis:t,arguments:[],closeParenthesis:void 0,start:t.start};this.lexer.advance();try{let t=this.lexer.peekToken();for(;t&&t?.nodeType!==kt.RParen;){switch(t.nodeType){case kt.Ident:case kt.String:e.arguments.push(t),this.lexer.advance();break;case kt.Number:e.arguments.push(this.lexer.extendToFloat(t)),this.lexer.advance();break;default:this.unexpectedToken(t,[kt.Ident,kt.String,kt.Number],!1),this.lexer.advance()}t=this.lexer.peekToken()}const s=this.lexer.peekToken();s?.nodeType===kt.RParen?(e.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:Bt.AT206,message:"Unexpected end of file. Group not closed.",severity:St.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}}class le{static ident(t){return{nodeType:kt.Ident,text:t}}static string(t){return{nodeType:kt.String,text:t}}static number(t){return{nodeType:kt.Number,value:t}}static meta(t,e,s){return{nodeType:kt.Meta,tag:{nodeType:kt.Tag,prefix:{nodeType:kt.Backslash},tag:{nodeType:kt.Ident,text:t}},arguments:e,properties:s,propertiesBeforeArguments:!1}}static identMeta(t,e){return le.meta(t,le.identValue(e))}static numberMeta(t,e){return le.meta(t,le.numberValue(e))}static args(t,e=void 0){const s={nodeType:kt.Arguments,arguments:t.filter(t=>void 0!==t)};if((void 0===e?s.arguments.length>1:e)&&(s.openParenthesis={nodeType:kt.LParen},s.closeParenthesis={nodeType:kt.RParen}),0!==s.arguments.length)return s}static stringValue(t){return le.args([le.string(t)])}static identValue(t){return le.args([le.ident(t)])}static numberValue(t){return le.args([le.number(t)])}static props(t){const e={nodeType:kt.Props,properties:[],openBrace:{nodeType:kt.LBrace},closeBrace:{nodeType:kt.RBrace}};for(const s of t)s&&e.properties.push({nodeType:kt.Prop,property:le.ident(s[0]),arguments:s[1]});return e}static prop(t,e,s){t.push({nodeType:kt.Prop,property:le.ident(e),arguments:s})}}class ue{static instance=new ue;static Me=new Set([kt.LParen,kt.String,kt.Ident,kt.Number]);readMetaDataArguments(t,e){const s=e.tag.text.toLowerCase();for(const e of ne.metaDataSignatures)if(e.has(s)){const i=e.get(s);return i?this.ve(t,i):void 0}t.addParserDiagnostic({code:Bt.AT204,message:`Unrecognized metadata '${e.tag.text}'.`,severity:St.Error,start:e.start,end:e.end}),t.lexer.fatalError=!0}readMetaDataPropertyArguments(t,e,s){const i=e.tag.text.toLowerCase();if(!ne.metaDataProperties.has(i))return;const n=ne.metaDataProperties.get(i);return this.Ne(t,[n],s)}readBeatPropertyArguments(t,e){return this.Ne(t,[ne.beatProperties],e)}readDurationChangePropertyArguments(t,e){return this.Ne(t,[ne.durationChangeProperties],e)}readNotePropertyArguments(t,e){return this.Ne(t,[ne.noteProperties,ne.beatProperties],e)}Ne(t,e,s){const i=s.property.text.toLowerCase(),n=new Set([kt.Ident,kt.RBrace]);for(const s of e)if(s.has(i)){const e=s.get(i);return e?this.ve(t,e,n):void this.Pe(t,[],n)}let r=t.lexer.peekToken();for(;r&&r.nodeType!==kt.Ident&&r.nodeType!==kt.RBrace;)t.lexer.advance(),r=t.lexer.peekToken();t.addParserDiagnostic({code:Bt.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:St.Error,start:s.property.start,end:r?.start??t.lexer.currentTokenLocation()})}ve(t,e,s){if(1===e.length&&0===e[0].parameters.length)return;const i=[],n=t.lexer.peekToken()?.start,r=void 0!==s,a=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),h=this.Ee(t,a,i,s),o=this.Ce(t,a,i,s,e,n);return r&&this.Pe(t,e,s),this.Fe(i,n,t.lexer.previousTokenEndLocation(),o,h)}Ce(t,e,s,i,n,r){const a=t.lexer.peekToken();let h=!1;return 1!==e.size&&void 0===a?(t.addParserDiagnostic({code:Bt.AT203,start:t.lexer.currentTokenLocation(),end:t.lexer.currentTokenLocation(),severity:St.Error,message:"Unexpected end of file."}),h=!0):0===e.size&&(void 0!==a&&0===s.length&&i&&!i.has(a.nodeType)&&(s.push(t.lexer.peekToken()),t.lexer.advance()),t.addParserDiagnostic({code:Bt.AT219,message:`Error parsing arguments: no overload matched arguments ${ue.generateSignaturesFromArguments(s)}. Signatures:\n${ue.generateSignatures(n)}`,severity:St.Error,start:r,end:t.lexer.previousTokenEndLocation()}),h=!0),h}Fe(t,e,s,i,n){if(0===t.length)return;const r=le.args(t,!1);return r.start=e,r.end=s,r.validated=!i,n&&(n.length>1&&ue.sortCandidates(n),r.signatureCandidateIndices=n.map(t=>t[0])),r}Ee(t,e,s,i){const n=t.mode===Mt.Full,r=(i,r)=>{const a=e.get(r);if(i.nodeType===kt.LParen){const e=t.argumentList();if(e)for(const t of e.arguments)n&&(t.parameterIndices||(t.parameterIndices=new Map),t.parameterIndices.set(r,a.parameterIndex)),s.push(t)}else{const e=i;n&&(e.parameterIndices||(e.parameterIndices=new Map),e.parameterIndices.set(r,a.parameterIndex)),0!==s.length&&s[s.length-1]===e||(s.push(e),t.lexer.advance())}},a=e=>{t.lexer.extendToFloat(e)},h=ue.Me;for(;e.size>1||e.size>0&&!ue.Ae(e);){const s=t.lexer.peekToken();if(!s||!h.has(s.nodeType))break;if(!ue.filterSignatureCandidates(e,s,void 0!==i&&i.has(s.nodeType),r,a))break}const o=t.mode===Mt.Full?Array.from(e.entries()):void 0;return ue.filterIncompleteCandidates(e),o}static sortCandidates(t){t.length<2||t.sort((t,e)=>{const s=Math.abs(t[1].parameterIndex-t[1].signature.parameters.length),i=Math.abs(e[1].parameterIndex-e[1].signature.parameters.length);if(s===i){const s=t[1].parameterValueMatches;return e[1].parameterValueMatches-s}return s-i})}Pe(t,e,s){const i=t.lexer.currentTokenLocation();let n=t.lexer.peekToken(),r=!1;const a=ue.Me;for(;n&&!s.has(n.nodeType);)a.has(n.nodeType)?(t.lexer.advance(),r=!0,n=t.lexer.peekToken()):n=void 0;r&&t.addParserDiagnostic({code:Bt.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:\n${ue.generateSignatures(e)}`,severity:St.Error,start:i,end:t.lexer.previousTokenEndLocation()})}static Ae(t){for(const e of t.values())if(e.parameterIndex===e.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(t){const e=new Set;for(const[s,i]of t)for(let t=i.parameterIndex;t<i.signature.parameters.length;t++){switch(i.signature.parameters[t].parseMode){case Tt.Required:case Tt.RequiredAsFloat:e.add(s)}}for(const s of e)t.delete(s)}static generateSignaturesFromArguments(t){return t?`(${t.map(t=>kt[t.nodeType]).join(", ")})`:"()"}static generateSignatures(t,e){return 0===t.length?"()":t.map((t,s)=>ue.De(t,void 0!==e&&e.size>1&&e.has(s))).join("\n")}static De(t,e){const s=e?" ~":"";return`(${t.parameters.map(ue.Le).join(", ")})${s}`}static Le(t,e){const s=Array.from(t.expectedTypes);let i=`v${e}`;switch(t.parseMode){case Tt.Optional:case Tt.OptionalAsFloat:i+="?"}if(t.allowedValues&&t.allowedValues.size<5){const e=Array.from(t.allowedValues);if(s[0]===kt.String)i=e.map(t=>`"${t}"`).join("|");else i=e.join("|")}else i=Array.from(t.expectedTypes).map(t=>kt[t]).join("|");switch(t.parseMode){case Tt.RequiredAsValueList:case Tt.ValueListWithoutParenthesis:i+="[]"}return i}static filterSignatureCandidates(t,e,s,i,n){const r=new Set;let a=!1;for(const[h,o]of t){let t=!1;for(;!t;){const c=o.parameterIndex<o.signature.parameters.length?o.signature.parameters[o.parameterIndex]:void 0;if(c)if(o.signature.isStrict&&o.parameterIndex>0)r.add(h),t=!0;else if((c.expectedTypes.has(e.nodeType)||ue.We(e,c))&&ue.Re(e,c,n))switch(t=!0,a=!0,i(e,h),c.allowedValues&&o.parameterValueMatches++,c.parseMode){case Tt.ValueListWithoutParenthesis:o.parameterHasValues=!0;break;case Tt.RequiredAsValueList:default:o.parameterIndex++,o.parameterHasValues=!1}else switch(c.parseMode){case Tt.ValueListWithoutParenthesis:o.parameterIndex++,o.parameterHasValues=!1;break;case Tt.Required:case Tt.RequiredAsFloat:r.add(h),t=!0;break;case Tt.Optional:case Tt.OptionalAsFloat:case Tt.RequiredAsValueList:o.parameterIndex++,o.parameterHasValues=!1}else s||r.add(h),t=!0}}if(a)for(const e of r)t.delete(e);return a}static Re(t,e,s){switch(t.nodeType){case kt.Ident:const i=t;return e?.allowedValues?e.allowedValues.has(i.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(i.text.toLowerCase());case kt.String:const n=t;return!e?.allowedValues||e.allowedValues.has(n.text.toLowerCase());case kt.Number:switch(e?.parseMode??Tt.Optional){case Tt.RequiredAsFloat:case Tt.OptionalAsFloat:return s?.(t),!0;default:return!0}case kt.LParen:return!0}return!1}static We(t,e){return t.nodeType===kt.LParen&&(e.expectedTypes.has(kt.Arguments)||e.parseMode===Tt.ValueListWithoutParenthesis||e.parseMode===Tt.RequiredAsValueList)}}!function(t){t[t.Applied=0]="Applied",t[t.NotAppliedSemanticError=1]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"}(vt||(vt={})),function(t){t[t.AppliedNewTrack=0]="AppliedNewTrack",t[t.AppliedNewStaff=1]="AppliedNewStaff",t[t.AppliedNewVoice=2]="AppliedNewVoice",t[t.NotAppliedSemanticError=3]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"}(Nt||(Nt={}));class de{static Oe=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);static getValue(t){return de.Oe||(de.Oe=new Map),t=t.toLowerCase().replaceAll(" ",""),de.Oe.has(t)?de.Oe.get(t):0}static getName(t){for(const[e,s]of de.Oe)if(s===t)return e;return t.toString()}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||105===t||43===t}static isBass(t){return t>=32&&t<=39}static bankToLsbMsb(t){return[127&t,t>>7&127]}}class fe{name="";firstFret=1;strings=[];barreFrets=[];staff;showName=!0;showDiagram=!0;showFingering=!0;get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class pe extends R{constructor(e){super(t.AlphaTabErrorType.Format,e)}}class be{static BlackRgb="#000000";constructor(t,e,s,i=255){this.raw=(255&i)<<24|(255&t)<<16|(255&e)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${Ht.toHexString(this.r,2)}${Ht.toHexString(this.g,2)}${Ht.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}raw=0;get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}rgba;static random(t=100){return new be(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,t)}static fromJson(t){if(t instanceof be)return t;switch(typeof t){case"number":{const e=new be(0,0,0,0);return e.raw=t,e.updateRgba(),e}case"string":{const e=t;if(e.startsWith("#")){if(4===e.length)return new be(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16));if(5===e.length)return new be(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16),17*Number.parseInt(e[4],16));if(7===e.length)return new be(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(9===e.length)return new be(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s)throw new pe("No values specified for rgb/rgba function");const i=e.substring(t+1,s).split(",");if(3===i.length)return new be(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10));if(4===i.length)return new be(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10),255*Number.parseFloat(i[3]))}return null}}throw new pe("Unsupported format for color")}static toJson(t){return null===t?null:t.raw}}!function(t){t[t.Short=0]="Short",t[t.Medium=1]="Medium",t[t.Long=2]="Long"}(Pt||(Pt={}));class me{type=Pt.Short;length=0}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.Text=2]="Text",t[t.Comment=3]="Comment",t[t.Dash=4]="Dash"}(Et||(Et={}));class ge{static Ie=10;static Ge=9;static $e=13;static Ve=32;static He=93;static Ue=91;static ze=45;startBar=0;text="";chunks;finish(t=!1){this.chunks=[],this.je(this.text,0,this.chunks,t)}je(t,e,s,i){if(!t)return;let n=Et.Begin,r=Et.Begin,a=!1,h=0;for(;e<t.length;){const s=t.charCodeAt(e);switch(n){case Et.IgnoreSpaces:switch(s){case ge.Ie:case ge.$e:case ge.Ge:break;case ge.Ve:if(!a){n=r;continue}break;default:a=!1,n=r;continue}break;case Et.Begin:if(s!==ge.Ue){h=e,n=Et.Text;continue}n=Et.Comment;break;case Et.Comment:if(s===ge.He)n=Et.Begin;break;case Et.Text:switch(s){case ge.ze:n=Et.Dash;break;case ge.$e:case ge.Ie:case ge.Ve:const s=t.substr(h,e-h);this.Xe(s,i),n=Et.IgnoreSpaces,r=Et.Begin}break;case Et.Dash:if(s!==ge.ze){const s=t.substr(h,e-h);this.Xe(s,i),a=!0,n=Et.IgnoreSpaces,r=Et.Begin;continue}}e+=1}n===Et.Text&&e!==h&&this.Xe(t.substr(h,e-h),i)}Xe(t,e){t=this.Je(t),(!e||t.length>0&&"-"!==t)&&this.chunks.push(t)}Je(t){const e=t.split("+").join(" ");let s=e.length;for(;s>0&&"_"===e.charAt(s-1);)s--;return s!==e.length?e.substr(0,s):e}}class we{marker="";text=""}class ye{static qe=[];static Ye=[];static Ke=[];static Qe=[];static Ze=new Map;static noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];static getTextForTuning(t,e){const s=ye.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){const s=t/12|0,i=t%12;return[ye.noteNames[i],(s+e).toString()]}static getDefaultTuningFor(t){if(ye.Ze.has(t)){const e=ye.Ze.get(t);return new ye(e.name,e.tunings,e.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return ye.qe;case 6:return ye.Ye;case 5:return ye.Ke;case 4:return ye.Qe}return[]}static initialize(){ye.Ze.set(7,new ye("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),ye.qe.push(ye.Ze.get(7)),ye.Ze.set(6,new ye("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),ye.Ye.push(ye.Ze.get(6)),ye.Ye.push(new ye("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),ye.Ye.push(new ye("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),ye.Ye.push(new ye("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),ye.Ye.push(new ye("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),ye.Ye.push(new ye("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),ye.Ye.push(new ye("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),ye.Ye.push(new ye("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),ye.Ye.push(new ye("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),ye.Ye.push(new ye("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),ye.Ye.push(new ye("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),ye.Ye.push(new ye("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),ye.Ye.push(new ye("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),ye.Ye.push(new ye("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),ye.Ye.push(new ye("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),ye.Ye.push(new ye("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),ye.Ye.push(new ye("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),ye.Ye.push(new ye("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),ye.Ye.push(new ye("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),ye.Ye.push(new ye("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),ye.Ye.push(new ye("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),ye.Ye.push(new ye("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),ye.Ye.push(new ye("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),ye.Ye.push(new ye("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),ye.Ye.push(new ye("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),ye.Ye.push(new ye("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),ye.Ye.push(new ye("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),ye.Ye.push(new ye("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),ye.Ye.push(new ye("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),ye.Ye.push(new ye("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),ye.Ye.push(new ye("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),ye.Ze.set(5,new ye("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),ye.Ke.push(ye.Ze.get(5)),ye.Ke.push(new ye("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),ye.Ke.push(new ye("Banjo Open D Tuning",[62,57,54,50,69],!1)),ye.Ke.push(new ye("Banjo Open G Tuning",[62,59,55,50,67],!1)),ye.Ke.push(new ye("Banjo G Minor Tuning",[62,58,55,50,67],!1)),ye.Ke.push(new ye("Banjo G Modal Tuning",[62,57,55,50,67],!1)),ye.Ze.set(4,new ye("Bass Standard Tuning",[43,38,33,28],!0)),ye.Qe.push(ye.Ze.get(4)),ye.Qe.push(new ye("Bass Tune down ½ step",[42,37,32,27],!1)),ye.Qe.push(new ye("Bass Tune down 1 step",[41,36,31,26],!1)),ye.Qe.push(new ye("Bass Tune down 2 step",[39,34,29,24],!1)),ye.Qe.push(new ye("Bass Dropped D Tuning",[43,38,33,26],!1)),ye.Qe.push(new ye("Ukulele C Tuning",[45,40,36,43],!1)),ye.Qe.push(new ye("Ukulele G Tuning",[52,47,43,38],!1)),ye.Qe.push(new ye("Mandolin Standard Tuning",[64,57,50,43],!1)),ye.Qe.push(new ye("Mandolin or Violin Tuning",[76,69,62,55],!1)),ye.Qe.push(new ye("Viola Tuning",[69,62,55,48],!1)),ye.Qe.push(new ye("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=ye.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const i=e[s];let n=!0;for(let e=0,s=t.length;e<s;e++)if(t[e]!==i.tunings[e]){n=!1;break}if(n)return new ye(i.name,i.tunings,i.isStandard)}return null}isStandard;name;tunings;constructor(t="",e=null,s=!1){this.isStandard=s,this.name=t,this.tunings=e??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const t=ye.findTuning(this.tunings);t&&(0===this.name.length&&(this.name=t.name),this.isStandard=t.isStandard)}}ye.initialize();class ke{static DefaultStandardNotationLineCount=5;index=0;track;bars=[];chords=null;capo=0;transpositionPitch=0;displayTranspositionPitch=0;stringTuning=new ye("",[],!1);get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}showSlash=!1;showNumbered=!1;showTablature=!0;showStandardNotation=!0;isPercussion=!1;standardNotationLineCount=ke.DefaultStandardNotationLineCount;I=new Set([0]);get filledVoices(){return this.I}finish(t,e=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish();for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(t,e);for(const t of this.bars[s].filledVoices)this.I.add(t)}}addChord(t,e){e.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(t,e)}hasChord(t){return this.chords?.has(t)??!1}getChord(t){return this.chords?.get(t)??null}addBar(t){const e=this.bars;t.staff=this,t.index=e.length,e.length>0&&(t.previousBar=e[e.length-1],t.previousBar.nextBar=t),e.push(t)}}class Se{volume=15;balance=8;port=1;program=0;bank=0;primaryChannel=0;secondaryChannel=0;isMute=!1;isSolo=!1}!function(t){t[t.TrackName=0]="TrackName",t[t.BracesAndBrackets=1]="BracesAndBrackets",t[t.SystemSeparator=2]="SystemSeparator",t[t.StringTuning=3]="StringTuning"}(Ct||(Ct={}));class Be extends q{}class _e{static ts=10;index=0;score;staves=[];playbackInfo=new Se;color=new be(200,0,0,255);name="";isVisibleOnMultiTrack=!0;shortName="";defaultSystemsLayout=3;systemsLayout=[];lineBreaks;get isPercussion(){return this.staves.some(t=>t.isPercussion)}addLineBreaks(t){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(t)}percussionArticulations=[];style;ensureStaveCount(t){for(;this.staves.length<t;)this.addStaff(new ke)}addStaff(t){t.index=this.staves.length,t.track=this,this.staves.push(t)}finish(t,e=null){this.shortName||(this.shortName=this.name,this.shortName.length>_e.ts&&(this.shortName=this.shortName.substr(0,_e.ts)));for(const s of this.staves)s.finish(t,e),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(t){for(const e of t)e.finish();const e=this.staves[0];for(let s=0;s<t.length;s++){const i=t[s];if(i.startBar>=0&&i.startBar<e.bars.length){let n=e.bars[i.startBar].voices[0].beats[0];for(let e=0;e<i.chunks.length&&n;e++){for(;n&&(n.isEmpty||n.isRest);)n=n.nextBeat;n&&(n.lyrics||(n.lyrics=new Array(t.length),n.lyrics.fill("")),n.lyrics[s]=i.chunks[e],n=n.nextBeat)}}}}}class xe{id=Ht.newGuid();x=0;y=0;width=0;height=0;totalWidth=0;totalHeight=0;firstMasterBarIndex=-1;lastMasterBarIndex=-1;renderResult=null}t.LayoutMode=void 0,(Ft=t.LayoutMode||(t.LayoutMode={}))[Ft.Page=0]="Page",Ft[Ft.Horizontal=1]="Horizontal";class Te{es=[];ss;constructor(t=void 0){this.ss=t}on(t){return this.es.push(t),this.ss?.()&&t(),()=>{this.off(t)}}off(t){this.es=this.es.filter(e=>e!==t)}trigger(){for(const t of this.es)t()}}class Me{es=[];ss;constructor(t=void 0){this.ss=t}on(t){if(this.es.push(t),this.ss){const e=this.ss();null!==e&&t(e)}return()=>{this.off(t)}}off(t){this.es=this.es.filter(e=>e!==t)}trigger(t){for(const e of this.es)e(t)}}class ve{masterBarBounds;visualBounds;realBounds;bar;beats=[];addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((t,e)=>t.realBounds.x-e.realBounds.x);for(const e of this.beats)e.finish(t)}}class Ne{barBounds;visualBounds;onNotesX=0;realBounds;beat;notes=null;addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s){const s=i.noteHeadBounds.y+i.noteHeadBounds.h,n=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=n&&e<=s)return i.note}return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class Pe{x=0;y=0;w=0;h=0;scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}}class Ee{index=0;isFirstOfLine=!1;visualBounds;realBounds;lineAlignedBounds;bars=[];staffSystemBounds=null;get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t){let e=null;for(const s of this.bars){const i=s.findBeatAtPos(t);if(i&&(!e||e.realBounds.x<i.realBounds.x)){const s=Math.abs(i.realBounds.x-t);(!e||s<1e7)&&(e=i)}}return e?e.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((t,e)=>t.realBounds.y<e.realBounds.y?-1:t.realBounds.y>e.realBounds.y?1:t.realBounds.x<e.realBounds.x?-1:t.realBounds.x>e.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class Ce{beatBounds;noteHeadBounds;note;finish(t=1){this.noteHeadBounds.scaleWith(t)}}class Fe{index=0;visualBounds;realBounds;bars=[];boundsLookup;finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class Ae{toJson(){const t={},e=[];t.staffSystems=e;for(const t of this.staffSystems){const s={};s.visualBounds=this.ns(t.visualBounds),s.realBounds=this.ns(t.realBounds),s.bars=[];for(const e of t.bars){const t={};t.lineAlignedBounds=this.ns(e.lineAlignedBounds),t.visualBounds=this.ns(e.visualBounds),t.realBounds=this.ns(e.realBounds),t.index=e.index,t.bars=[];for(const s of e.bars){const e={};e.visualBounds=this.ns(s.visualBounds),e.realBounds=this.ns(s.realBounds),e.beats=[];for(const t of s.beats){const s={};s.visualBounds=this.ns(t.visualBounds),s.realBounds=this.ns(t.realBounds),s.onNotesX=t.onNotesX;const i=s;if(i.beatIndex=t.beat.index,i.voiceIndex=t.beat.voice.index,i.barIndex=t.beat.voice.bar.index,i.staffIndex=t.beat.voice.bar.staff.index,i.trackIndex=t.beat.voice.bar.staff.track.index,t.notes){const e=[];s.notes=e;for(const s of t.notes){const t={};t.index=s.note.index,t.noteHeadBounds=this.ns(s.noteHeadBounds),e.push(t)}}e.beats.push(s)}t.bars.push(e)}s.bars.push(t)}e.push(s)}return t}static fromJson(t,e){const s=new Ae,i=t.staffSystems;for(const t of i){const i=new Fe;i.visualBounds=Ae.rs(t.visualBounds),i.realBounds=Ae.rs(t.realBounds),s.addStaffSystem(i);for(const s of t.bars){const t=new Ee;t.index=s.index,t.isFirstOfLine=s.isFirstOfLine,t.lineAlignedBounds=Ae.rs(s.lineAlignedBounds),t.visualBounds=Ae.rs(s.visualBounds),t.realBounds=Ae.rs(s.realBounds),i.addBar(t);for(const i of s.bars){const s=new ve;s.visualBounds=Ae.rs(i.visualBounds),s.realBounds=Ae.rs(i.realBounds),t.addBar(s);for(const t of i.beats){const i=new Ne;i.visualBounds=Ae.rs(t.visualBounds),i.realBounds=Ae.rs(t.realBounds),i.onNotesX=t.onNotesX;const n=t;if(i.beat=e.tracks[n.trackIndex].staves[n.staffIndex].bars[n.barIndex].voices[n.voiceIndex].beats[n.beatIndex],t.notes){i.notes=[];for(const e of t.notes){const t=new Ce,s=e;t.note=i.beat.notes[s.index],t.noteHeadBounds=Ae.rs(e.noteHeadBounds),i.addNote(t)}}s.addBeat(i)}}}}return s}static rs(t){const e=new Pe;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}ns(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}j=new Map;hs=new Map;cs=null;staffSystems=[];isFinished=!1;finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this.cs=t}addMasterBar(t){t.staffSystemBounds?this.hs.set(t.index,t):(t.staffSystemBounds=this.cs,this.hs.set(t.index,t),this.cs.addBar(t))}addBeat(t){this.j.has(t.beat.id)||this.j.set(t.beat.id,[]),this.j.get(t.beat.id)?.push(t)}findMasterBarByIndex(t){return this.hs.has(t)?this.hs.get(t):null}findMasterBar(t){const e=t.index;return this.hs.has(e)?this.hs.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this.j.has(e)?this.j.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,n=-1;for(;s<=i;){const t=(i+s)/2|0,r=this.staffSystems[t];if(e>=r.realBounds.y&&e<=r.realBounds.y+r.realBounds.h){n=t;break}e<r.realBounds.y?i=t-1:s=t+1}if(-1===n)return null;const r=this.staffSystems[n].findBarAtPos(t);return r?r.findBeatAtPos(t):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const t of i){const i=t.findNoteAtPos(e,s);if(i)return i}return null}}class De{ls=t.LayoutMode.Page;us=null;ds=null;canvas=null;score=null;tracks=null;layout=null;settings;boundsLookup=null;width=0;constructor(t){this.settings=t,this.fs(),this.ps()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}fs(){return this.us!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=eu.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this.us=this.settings.core.engine,!0)}ps(){return(!this.layout||this.ls!==this.settings.display.layoutMode)&&(this.layout=eu.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this.ls=this.settings.display.layoutMode,!0)}renderScore(t,e){try{this.score=t;let s=null;if(null!=t&&null!=e){if(e){s=[];for(const i of e)i>=0&&i<t.tracks.length&&s.push(t.tracks[i])}else s=t.tracks.slice(0);0===s.length&&t.tracks.length>0&&s.push(t.tracks[0])}this.tracks=s,this.render()}catch(t){this.error.trigger(t)}}renderTracks(t){0===t.length?this.score=null:this.score=t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(j.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):j.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(t){this.error.trigger(t)}}render(){if(0!==this.width)if(this.boundsLookup=new Ae,this.fs(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){j.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let t=0;t<this.tracks.length;t++){const e=this.tracks[t];j.debug("Rendering",`Track ${t}: ${e.name}`)}this.preRender.trigger(!1),this.ps(),this.bs(),j.debug("Rendering","Rendering finished")}else j.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this.ds=null,this.gs(),this.postRenderFinished.trigger(),j.debug("Rendering","Clearing finished");else j.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.ps()||this.fs()||this.ds!==this.tracks||!this.tracks?(j.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(j.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new Ae,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.gs(),this.postRenderFinished.trigger()):j.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),j.debug("Rendering","Resize finished")}bs(){j.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this.ds=this.tracks,this.gs(),this.postRenderFinished.trigger()}preRender=new Me;renderFinished=new Me;partialRenderFinished=new Me;partialLayoutFinished=new Me;postRenderFinished=new Te;error=new Me;gs(){this.boundsLookup?.finish(this.settings.display.scale);const t=new xe;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down"}(At||(At={}));const Le=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:ve,get BeamDirection(){return At},BeatBounds:Ne,Bounds:Pe,BoundsLookup:Ae,MasterBarBounds:Ee,NoteBounds:Ce,RenderFinishedEventArgs:xe,ScoreRenderer:De,StaffSystemBounds:Fe},Symbol.toStringTag,{value:"Module"}));class We{static instance=new We;applyScoreMetaData(t,e,s){const i=this.ws(t,[ne.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return e.title=s.arguments.arguments[0].text,this.ys(t,e,nt.Title,s),vt.Applied;case"subtitle":return e.subTitle=s.arguments.arguments[0].text,this.ys(t,e,nt.SubTitle,s),vt.Applied;case"artist":return e.artist=s.arguments.arguments[0].text,this.ys(t,e,nt.Artist,s),vt.Applied;case"album":return e.album=s.arguments.arguments[0].text,this.ys(t,e,nt.Album,s),vt.Applied;case"words":return e.words=s.arguments.arguments[0].text,this.ys(t,e,nt.Words,s),vt.Applied;case"music":return e.music=s.arguments.arguments[0].text,this.ys(t,e,nt.Music,s),vt.Applied;case"copyright":return e.copyright=s.arguments.arguments[0].text,this.ys(t,e,nt.Copyright,s),vt.Applied;case"instructions":return e.instructions=s.arguments.arguments[0].text,vt.Applied;case"notices":return e.notices=s.arguments.arguments[0].text,vt.Applied;case"tab":return e.tab=s.arguments.arguments[0].text,this.ys(t,e,nt.Transcriber,s),vt.Applied;case"copyright2":return this.ys(t,e,nt.CopyrightSecondLine,s,0),vt.Applied;case"wordsandmusic":return this.ys(t,e,nt.WordsAndMusic,s,0),vt.Applied;case"defaultsystemslayout":return e.defaultSystemsLayout=s.arguments.arguments[0].value,vt.Applied;case"systemslayout":for(const t of s.arguments.arguments)e.systemsLayout.push(t.value);return vt.Applied;case"hidedynamics":return e.stylesheet.hideDynamics=!0,vt.Applied;case"showdynamics":return e.stylesheet.hideDynamics=!1,vt.Applied;case"bracketextendmode":const i=We.ks(t,s.arguments,"bracket extend mode",ie.bracketExtendMode);return void 0===i?vt.NotAppliedSemanticError:(e.stylesheet.bracketExtendMode=i,vt.Applied);case"usesystemsignseparator":return e.stylesheet.useSystemSignSeparator=!0,vt.Applied;case"multibarrest":return e.stylesheet.multiTrackMultiBarRest=!0,vt.Applied;case"singletracktracknamepolicy":const n=We.ks(t,s.arguments,"track name policy",ie.trackNamePolicy);return void 0===n?vt.NotAppliedSemanticError:(e.stylesheet.singleTrackTrackNamePolicy=n,vt.Applied);case"multitracktracknamepolicy":const r=We.ks(t,s.arguments,"track name policy",ie.trackNamePolicy);return void 0===r?vt.NotAppliedSemanticError:(e.stylesheet.multiTrackTrackNamePolicy=r,vt.Applied);case"firstsystemtracknamemode":const a=We.ks(t,s.arguments,"track name mode",ie.trackNameMode);return void 0===a?vt.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameMode=a,vt.Applied);case"othersystemstracknamemode":const h=We.ks(t,s.arguments,"track name mode",ie.trackNameMode);return void 0===h?vt.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameMode=h,vt.Applied);case"firstsystemtracknameorientation":const o=We.ks(t,s.arguments,"track name orientation",ie.trackNameOrientation);return void 0===o?vt.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameOrientation=o,vt.Applied);case"othersystemstracknameorientation":const c=We.ks(t,s.arguments,"track name orientation",ie.trackNameOrientation);return void 0===c?vt.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameOrientation=c,vt.Applied);default:return vt.NotAppliedUnrecognizedMarker}}ws(t,e,s,i,n){const r=e.find(t=>t.has(i));if(!r)return vt.NotAppliedUnrecognizedMarker;const a=r.get(i);if(a)return this.Ss(t,a,s,n)?void 0:vt.NotAppliedSemanticError;n&&t.addSemanticDiagnostic({code:Bt.AT300,message:"Expected no arguments, but found some.",start:n.start,end:n.end,severity:St.Warning})}applyStaffMetaData(t,e,s){const i=this.ws(t,[ne.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return e.capo=s.arguments.arguments[0].value,vt.Applied;case"tuning":const i=[];let n=!1,r="";for(let a=0;a<s.arguments.arguments.length;a++){const h=s.arguments.arguments[a],o=h.text;switch(o){case"piano":case"none":case"voice":t.applyStaffNoteKind(e,xt.Pitched),a=s.arguments.arguments.length;break;case"hide":n=!0,t.addSemanticDiagnostic({code:Bt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:St.Warning});break;default:const c=Ht.parseTuning(o);if(c)i.push(c.realValue);else if(a===s.arguments.arguments.length-1&&i.length>0)r=o,t.addSemanticDiagnostic({code:Bt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:St.Warning});else{const e=Array.from(Ht.tuningLetters).join(","),s=Array.from(Ht.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected tuning value '${o}', expected: <note><accidental><octave> where <note>=oneOf(${e}) <accidental>=oneOf(${s}), <octave>=number`,start:h.start,end:h.end,severity:St.Error})}}}return t.state.staffHasExplicitTuning.add(e),t.state.staffTuningApplied.delete(e),e.stringTuning=new ye,e.stringTuning.tunings=i,e.stringTuning.name=r,this.Bs(t,e,e.stringTuning,s),n&&(e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1)),vt.Applied;case"instrument":return t.state.staffTuningApplied.delete(e),this._s(t,e.track,s.arguments),vt.Applied;case"bank":return e.track.playbackInfo.bank=s.arguments.arguments[0].value,vt.Applied;case"lyrics":const a=new ge;return a.startBar=0,a.text="",2===s.arguments.arguments.length?(a.startBar=s.arguments.arguments[0].value,a.text=s.arguments.arguments[1].text):a.text=s.arguments.arguments[0].text,t.state.lyrics.get(e.track.index).push(a),vt.Applied;case"chord":const h=new fe;this.xs(t,h,s),h.name=s.arguments.arguments[0].text;for(let e=1;e<s.arguments.arguments.length;e++){const i=s.arguments.arguments[e];if(i.nodeType===kt.Number)h.strings.push(i.value);else if(i.nodeType===kt.Ident){const e=i.text;"x"===e?h.strings.push(-1):t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected chord value '${e}', expected: 'x'`,severity:St.Error,start:i.start,end:i.end})}}return e.addChord(We.Ts(e,h.name),h),vt.Applied;case"articulation":const o=t.state.percussionArticulationNames,c=s.arguments.arguments[0].text;if("defaults"===c){for(const[t,e]of zt.instrumentArticulationNames)o.set(t.toLowerCase(),e),o.set(Ht.toArticulationId(t),e);return vt.Applied}if(2===s.arguments.arguments.length){const e=s.arguments.arguments[1].value;if(zt.instrumentArticulations.has(e))return o.set(c.toLowerCase(),e),vt.Applied;{const i=Array.from(zt.instrumentArticulations.keys()).map(t=>`${t}`).join(",");return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected articulation value '${e}', expected: ${i}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:St.Error}),vt.NotAppliedSemanticError}}return vt.Applied;case"accidentals":return We.Ms(t,s.arguments);case"displaytranspose":return e.displayTranspositionPitch=-1*s.arguments.arguments[0].value,t.state.staffHasExplicitDisplayTransposition.add(e),vt.Applied;case"transpose":return e.transpositionPitch=-1*s.arguments.arguments[0].value,vt.Applied;default:return vt.NotAppliedUnrecognizedMarker}}applyBarMetaData(t,e,s){const i=this.ws(t,[ne.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const i=this.vs(s);return t.state.syncPoints.push(i),vt.Applied;case"tempo":let n=0;const a=s.arguments.arguments[n++].value;let h="",o=!0,c=0;for(;n<s.arguments.arguments.length;){switch(s.arguments.arguments[n].nodeType){case kt.Ident:case kt.String:const t=s.arguments.arguments[n].text;"hide"===t?o=!1:h=t;break;case kt.Number:c=s.arguments.arguments[n].value}n++}let l=e.masterBar.tempoAutomations.find(t=>t.ratioPosition===c);return l||(l=new $,e.masterBar.tempoAutomations.push(l)),l.isLinear=!1,l.type=r.Tempo,l.value=a,l.text=h,l.ratioPosition=c,l.isVisible=o,vt.Applied;case"rc":return e.masterBar.repeatCount=s.arguments.arguments[0].value,vt.Applied;case"ae":for(const i of s.arguments.arguments)if(i.nodeType===kt.Number){const s=i.value;if(s<1||s>31)return t.addSemanticDiagnostic({code:Bt.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:St.Error,start:i.start,end:i.end}),vt.NotAppliedSemanticError;e.masterBar.alternateEndings|=1<<s-1}else t.addSemanticDiagnostic({code:Bt.AT202,message:`Unexpected '${kt[i.nodeType]}' token. Expected one of following: ${kt[kt.Number]}`,severity:St.Error,start:i.start,end:i.end});return vt.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case kt.Number:e.masterBar.timeSignatureNumerator=s.arguments.arguments[0].value,e.masterBar.timeSignatureDenominator=s.arguments.arguments[1].value;break;case kt.Ident:case kt.String:const i=s.arguments.arguments[0].text;if("common"!==i.toLowerCase())return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected time signature value '${i}', expected: common or two numbers`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),vt.NotAppliedSemanticError;e.masterBar.timeSignatureCommon=!0,e.masterBar.timeSignatureNumerator=4,e.masterBar.timeSignatureDenominator=4}return vt.Applied;case"ks":const u=We.ks(t,s.arguments,"key signature",ie.keySignature);if(void 0===u)return vt.NotAppliedSemanticError;const d=We.ks(t,s.arguments,"key signature type",ie.keySignatureType);return void 0===d?vt.NotAppliedSemanticError:(e.keySignature=u,e.keySignatureType=d,vt.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case kt.Ident:case kt.String:const i=We.ks(t,s.arguments,"clef",ie.clef);if(void 0===i)return vt.NotAppliedSemanticError;e.clef=i;break;case kt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.clef=P.Neutral;break;case 43:e.clef=P.G2;break;case 65:e.clef=P.F4;break;case 48:e.clef=P.C3;break;case 60:e.clef=P.C4;break;default:return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected clef value '${n}', expected: ${Array.from(ie.clef.keys()).join(",")}`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),vt.NotAppliedSemanticError}}return vt.Applied;case"section":const f=new we;return 1===s.arguments.arguments.length?f.text=s.arguments.arguments[0].text:(f.marker=s.arguments.arguments[0].text,f.text=s.arguments.arguments[1].text),e.masterBar.section=f,vt.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case kt.Ident:case kt.String:const i=We.ks(t,s.arguments,"triplet feel",ie.tripletFeel);if(void 0===i)return vt.NotAppliedSemanticError;e.masterBar.tripletFeel=i;break;case kt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.masterBar.tripletFeel=rt.NoTripletFeel;break;case 1:e.masterBar.tripletFeel=rt.Triplet16th;break;case 2:e.masterBar.tripletFeel=rt.Triplet8th;break;case 3:e.masterBar.tripletFeel=rt.Dotted16th;break;case 4:e.masterBar.tripletFeel=rt.Dotted8th;break;case 5:e.masterBar.tripletFeel=rt.Scottish16th;break;case 6:e.masterBar.tripletFeel=rt.Scottish8th;break;default:return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected triplet feel value '${n}', expected: ${Array.from(ie.tripletFeel.keys()).join(",")}`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),vt.NotAppliedSemanticError}}return vt.Applied;case"barlineleft":const p=We.ks(t,s.arguments,"bar line",ie.barLineStyle);return void 0===p?vt.NotAppliedSemanticError:(e.barLineLeft=p,vt.Applied);case"barlineright":const b=We.ks(t,s.arguments,"bar line",ie.barLineStyle);return void 0===b?vt.NotAppliedSemanticError:(e.barLineRight=b,vt.Applied);case"accidentals":return We.Ms(t,s.arguments);case"jump":const m=We.ks(t,s.arguments,"direction",ie.direction);return void 0===m?vt.NotAppliedSemanticError:(e.masterBar.addDirection(m),vt.Applied);case"ottava":const g=We.ks(t,s.arguments,"clef ottava",ie.ottavia);return void 0===g?vt.NotAppliedSemanticError:(e.clefOttava=g,vt.Applied);case"simile":const w=We.ks(t,s.arguments,"simile mark",ie.simileMark);return void 0===w?vt.NotAppliedSemanticError:(e.simileMark=w,vt.Applied);case"width":return e.masterBar.displayWidth=s.arguments.arguments[0].value,e.displayWidth=e.masterBar.displayWidth,vt.Applied;case"scale":return e.masterBar.displayScale=s.arguments.arguments[0].value,e.displayScale=e.masterBar.displayScale,vt.Applied;case"spd":const y=new Y;return y.pedalType=A.Down,y.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(y),vt.Applied;case"spu":const k=new Y;return k.pedalType=A.Up,k.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(k),vt.Applied;case"sph":const S=new Y;return S.pedalType=A.Hold,S.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(S),vt.Applied;case"ft":return e.masterBar.isFreeTime=!0,vt.Applied;case"ro":return e.masterBar.isRepeatStart=!0,vt.Applied;case"ac":return e.masterBar.isAnacrusis=!0,vt.Applied;case"db":return e.masterBar.isDoubleBar=!0,e.barLineRight=L.LightLight,vt.Applied;default:return vt.NotAppliedUnrecognizedMarker}}static Ms(t,e){const s=We.ks(t,e,"accidental mode",ie.alphaTexAccidentalMode);return void 0===s?vt.NotAppliedSemanticError:(t.state.accidentalMode=s,vt.Applied)}static Ts(t,e){return e.toLowerCase()+t.index+t.track.index}vs(t){const e=t.arguments.arguments[0].value,s=t.arguments.arguments[1].value,i=t.arguments.arguments[2].value;let n=0;return t.arguments.arguments.length>3&&(n=t.arguments.arguments[3].value),{barIndex:e,barOccurence:s,barPosition:n,millisecondOffset:i}}Ss(t,e,s,i){if(!i){return!!e.some(t=>0===t.parameters.length||!t.parameters.some(t=>t.parseMode===Tt.Required||t.parseMode===Tt.RequiredAsFloat||t.parseMode===Tt.RequiredAsValueList))||(t.addSemanticDiagnostic({code:Bt.AT219,message:`Error parsing arguments: no overload matched arguments ${ue.generateSignaturesFromArguments(void 0)}. Signatures: ${ue.generateSignatures(e)}`,severity:St.Error,start:s.start,end:s.end}),!1)}if(i.validated)return!0;let n=!1;const r=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),a=t.parseMode===Mt.Full,h=a?(t,e)=>{const s=r.get(e),i=t;i.parameterIndices||(i.parameterIndices=new Map),i.parameterIndices.set(e,s.parameterIndex)}:(t,e)=>{};for(const t of i.arguments)if(ue.filterSignatureCandidates(r,t,!1,h),0===r.size)break;const o=a?Array.from(r.entries()):void 0;return ue.filterIncompleteCandidates(r),0===r.size&&(t.addSemanticDiagnostic({code:Bt.AT219,message:`Error parsing arguments: no overload matched arguments ${ue.generateSignaturesFromArguments(i.arguments)}. Signatures:\n${ue.generateSignatures(e)}`,severity:St.Error,start:i.start,end:i.end}),n=!0),o&&(ue.sortCandidates(o),i.signatureCandidateIndices=o.map(t=>t[0])),!n}ys(t,e,s,i,n=1){const r=i.arguments.arguments.length-n;if(r<1)return;const a=Ht.getOrCreateHeaderFooterStyle(e,s);void 0===a.isVisible&&(a.isVisible=!0);const h=i.arguments.arguments[n].text;if(h?a.template=h:a.isVisible=!1,r<2)return;const o=We.ks(t,i.arguments,"textAlign",ie.textAlign,n+1);void 0!==o&&(a.textAlign=o)}_s(t,e,s){switch(s.arguments[0].nodeType){case kt.Number:const i=s.arguments[0].value;i>=0&&i<=127?e.playbackInfo.program=i:t.addSemanticDiagnostic({code:Bt.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:St.Error});break;case kt.Ident:case kt.String:const n=s.arguments[0].text.toLowerCase();if("percussion"===n){for(const s of e.staves)t.applyStaffNoteKind(s,xt.Articulation);e.playbackInfo.primaryChannel=Gt.PercussionChannel,e.playbackInfo.secondaryChannel=Gt.PercussionChannel}else e.playbackInfo.program=de.getValue(n)}}xs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Ns(t,[ne.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":e.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":e.showDiagram=We.Ps(i.arguments.arguments,0);break;case"showfingering":e.showFingering=We.Ps(i.arguments.arguments,0);break;case"showname":e.showName=We.Ps(i.arguments.arguments,0);break;case"barre":e.barreFrets=i.arguments.arguments.map(t=>t.value)}}Bs(t,e,s,i){if(i.properties)for(const n of i.properties.properties)if(this.Ns(t,[ne.metaDataProperties.get("tuning")],n))switch(n.property.text.toLowerCase()){case"hide":e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1);break;case"label":s.name=n.arguments.arguments[0].text}}static Ps(t,e){if(e>=t.length)return!0;const s=t[e];switch(s.nodeType){case kt.String:case kt.Ident:return"false"!==s.text;case kt.Number:return 0!==s.value;default:return!1}}applyStructuralMetaData(t,e){const s=this.ws(t,[ne.structuralMetaDataSignatures],e,e.tag.tag.text.toLowerCase(),e.arguments);if(void 0!==s)switch(s){case vt.NotAppliedSemanticError:return Nt.NotAppliedSemanticError;case vt.NotAppliedUnrecognizedMarker:return Nt.NotAppliedUnrecognizedMarker}switch(e.tag.tag.text.toLowerCase()){case"staff":const s=t.startNewStaff();return this.Es(t,s,e),Nt.AppliedNewStaff;case"track":const i=t.startNewTrack();return e.arguments&&e.arguments.arguments.length>0&&(i.name=e.arguments.arguments[0].text,e.arguments.arguments.length>1&&(i.shortName=e.arguments.arguments[1].text)),this.Cs(t,i,e),Nt.AppliedNewTrack;case"voice":return t.startNewVoice(),Nt.AppliedNewVoice;default:return Nt.NotAppliedUnrecognizedMarker}}Ns(t,e,s){const i=this.ws(t,e,s,s.property.text.toLowerCase(),s.arguments);if(void 0!==i)switch(i){case vt.Applied:case vt.NotAppliedSemanticError:return!1;case vt.NotAppliedUnrecognizedMarker:const i=e.flatMap(t=>Array.from(t.keys()));return t.addSemanticDiagnostic({code:Bt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${i}`,severity:St.Error,start:s.start,end:s.end}),!1}return!0}Es(t,e,s){if(!s.properties)return;let i=!1,n=!1,r=!1,a=!1;for(const h of s.properties.properties)if(this.Ns(t,[ne.metaDataProperties.get("staff")],h))switch(h.property.text.toLowerCase()){case"score":i=!0,h.arguments&&h.arguments.arguments.length>0&&(e.standardNotationLineCount=h.arguments.arguments[0].value);break;case"tabs":n=!0;break;case"slash":r=!0;break;case"numbered":a=!0}(i||n||r||a)&&(e.showStandardNotation=i,e.showTablature=n,e.showSlash=r,e.showNumbered=a)}Cs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Ns(t,[ne.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{e.color=be.fromJson(i.arguments.arguments[0].text)}catch{t.addSemanticDiagnostic({code:Bt.AT213,message:"Invalid format for color",severity:St.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":e.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":e.systemsLayout=i.arguments.arguments.map(t=>t.value);break;case"volume":e.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":e.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":e.playbackInfo.isMute=!0;break;case"solo":e.playbackInfo.isSolo=!0;break;case"multibarrest":e.score.stylesheet.perTrackMultiBarRest||(e.score.stylesheet.perTrackMultiBarRest=new Set),e.score.stylesheet.perTrackMultiBarRest.add(e.index);break;case"instrument":this._s(t,e,i.arguments);break;case"bank":e.playbackInfo.bank=i.arguments.arguments[0].value}}applyBeatDurationProperty(t,e){const s=this.ws(t,[ne.durationChangeProperties],e,e.property.text.toLowerCase(),e.arguments);if(void 0!==s)return s;if("tu"===e.property.text.toLowerCase()){if(2===e.arguments.arguments.length)t.state.currentTupletNumerator=e.arguments.arguments[0].value,t.state.currentTupletDenominator=e.arguments.arguments[1].value;else{const s=e.arguments.arguments[0].value;t.state.currentTupletNumerator=s;const i=We.Fs(s);i<0?(t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected default tuplet value '${s}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:St.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=i}return vt.Applied}return vt.NotAppliedUnrecognizedMarker}static Fs(t){switch(t){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}As=void 0;get allKnownMetaDataTags(){if(!this.As){this.As=new Set;const t=[ne.scoreMetaDataSignatures.keys(),ne.structuralMetaDataSignatures.keys(),ne.staffMetaDataSignatures.keys(),ne.barMetaDataSignatures.keys()];for(const e of t)for(const t of e)this.As.add(t)}return this.As}Ds=void 0;get knownScoreMetaDataTags(){return this.Ds||(this.Ds=new Set(ne.scoreMetaDataSignatures.keys())),this.Ds}Ls=void 0;get knownStructuralMetaDataTags(){return this.Ls||(this.Ls=new Set(ne.structuralMetaDataSignatures.keys())),this.Ls}Ws=void 0;get knownBarMetaDataTags(){return this.Ws||(this.Ws=new Set(ne.barMetaDataSignatures.keys())),this.Ws}Rs=void 0;get knownStaffMetaDataTags(){return this.Rs||(this.Rs=new Set(ne.staffMetaDataSignatures.keys())),this.Rs}Os=void 0;get knownBeatDurationProperties(){return this.Os||(this.Os=new Set(ne.durationChangeProperties.keys())),this.Os}Is=void 0;get knownBeatProperties(){return this.Is||(this.Is=new Set(ne.beatProperties.keys())),this.Is}Gs=void 0;get knownNoteProperties(){return this.Gs||(this.Gs=new Set(ne.noteProperties.keys())),this.Gs}applyBeatProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.ws(t,[ne.beatProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"f":return e.fade=pt.FadeIn,vt.Applied;case"fo":return e.fade=pt.FadeOut,vt.Applied;case"vs":return e.fade=pt.VolumeSwell,vt.Applied;case"v":return e.vibrato=y.Slight,vt.Applied;case"vw":return e.vibrato=y.Wide,vt.Applied;case"s":return e.slap=!0,vt.Applied;case"p":return e.pop=!0,vt.Applied;case"tt":return e.tap=!0,vt.Applied;case"txt":return e.text=s.arguments.arguments[0].text,vt.Applied;case"lyrics":let n=0,a="";for(2===s.arguments.arguments.length?(n=s.arguments.arguments[0].value,a=s.arguments.arguments[1].text):a=s.arguments.arguments[0].text,e.lyrics||(e.lyrics=[]);e.lyrics.length<=n;)e.lyrics.push("");return e.lyrics[n]=a,vt.Applied;case"dd":return e.dots=2,vt.Applied;case"d":return e.dots=1,vt.Applied;case"su":return e.pickStroke=ot.Up,vt.Applied;case"sd":return e.pickStroke=ot.Down,vt.Applied;case"tu":if(2===s.arguments.arguments.length)e.tupletNumerator=s.arguments.arguments[0].value,e.tupletDenominator=s.arguments.arguments[1].value;else{const i=s.arguments.arguments[0].value;e.tupletNumerator=i;const n=We.Fs(i);if(n<0)return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),e.tupletNumerator=-1,e.tupletDenominator=-1,vt.NotAppliedSemanticError;e.tupletDenominator=n}return vt.Applied;case"tb":case"tbe":let h=0,d=!0,f=!1;for(;d;)switch(s.arguments.arguments[h].nodeType){case kt.Ident:case kt.String:const i=s.arguments.arguments[h].text.toLowerCase();if(ie.whammyType.has(i))e.whammyBarType=ie.whammyType.get(i),f=!0,h++;else{if(!ie.bendStyle.has(i))return f?We.ks(t,s.arguments,"whammy style",ie.bendStyle,h):We.ks(t,s.arguments,"whammy type",ie.whammyType,h),vt.NotAppliedSemanticError;e.whammyStyle=ie.bendStyle.get(i),h++}break;default:d=!1}const p=this.$s(t,s,h,"tbe"===i);if(p)for(const t of p)e.addWhammyBarPoint(t);return vt.Applied;case"bu":return We.Vs(e,s,o.BrushUp,.25),vt.Applied;case"bd":return We.Vs(e,s,o.BrushDown,.25),vt.Applied;case"au":return We.Vs(e,s,o.ArpeggioUp,1),vt.Applied;case"ad":return We.Vs(e,s,o.ArpeggioDown,1),vt.Applied;case"ch":const b=s.arguments.arguments[0].text,m=We.Ts(e.voice.bar.staff,b);if(!e.voice.bar.staff.hasChord(m)){const t=new fe;t.showDiagram=!1,t.name=b,e.voice.bar.staff.addChord(m,t)}return e.chordId=m,vt.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const i=We.ks(t,s.arguments,"whammy style",ie.graceType);if(void 0===i)return vt.NotAppliedSemanticError;e.graceType=i}else e.graceType=u.BeforeBeat;return vt.Applied;case"dy":const g=We.ks(t,s.arguments,"dynamic",ie.dynamicValue);return void 0===g?vt.NotAppliedSemanticError:(e.dynamics=g,t.state.currentDynamics=g,vt.Applied);case"cre":return e.crescendo=c.Crescendo,vt.Applied;case"dec":return e.crescendo=c.Decrescendo,vt.Applied;case"tempo":const w=s.arguments.arguments[0].value;let k="",S=!0;if(s.arguments.arguments.length>2){k=s.arguments.arguments[1].text;const e=s.arguments.arguments[2].text;if("hide"!==e)return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected third tempo property value '${e}', expected: 'hide'`,severity:St.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),vt.NotAppliedSemanticError;S=!1}else s.arguments.arguments.length>1&&(k=s.arguments.arguments[1].text,"hide"===k&&(S=!1,k=""));const B=new $;return B.isLinear=!1,B.type=r.Tempo,B.value=w,B.text=k,B.isVisible=S,e.automations.push(B),e.voice.bar.masterBar.tempoAutomations.push(B),vt.Applied;case"volume":const _=new $;return _.isLinear=!0,_.type=r.Volume,_.value=s.arguments.arguments[0].value,e.automations.push(_),vt.Applied;case"balance":const x=new $;return x.isLinear=!0,x.type=r.Balance,x.value=Ht.clamp(s.arguments.arguments[0].value,0,16),e.automations.push(x),vt.Applied;case"tp":if(e.tremoloSpeed=l.Eighth,s.arguments&&s.arguments.arguments.length>0){const i=s.arguments.arguments[0].value;switch(i){case 8:e.tremoloSpeed=l.Eighth;break;case 16:e.tremoloSpeed=l.Sixteenth;break;case 32:e.tremoloSpeed=l.ThirtySecond;break;default:return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected tremolo speed value '${i}, expected: 8, 16 or 32`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),vt.NotAppliedSemanticError}}return vt.Applied;case"spd":return We.Hs(t,e,A.Down),vt.Applied;case"sph":return We.Hs(t,e,A.Hold),vt.Applied;case"spu":return We.Hs(t,e,A.Up),vt.Applied;case"spe":return We.Hs(t,e,A.Up,!0),vt.Applied;case"slashed":return e.slashed=!0,vt.Applied;case"ds":return e.deadSlapped=!0,1===e.notes.length&&e.notes[0].isDead&&e.removeNote(e.notes[0]),vt.Applied;case"glpf":return e.golpe=ft.Finger,vt.Applied;case"glpt":return e.golpe=ft.Thumb,vt.Applied;case"waho":return e.wahPedal=bt.Open,vt.Applied;case"wahc":return e.wahPedal=bt.Closed,vt.Applied;case"barre":if(e.barreFret=s.arguments.arguments[0].value,e.barreShape=mt.Full,s.arguments.arguments.length>1){const i=We.ks(t,s.arguments,"barre shape",ie.barreShape,1);if(void 0===i)return vt.NotAppliedSemanticError;e.barreShape=i}return vt.Applied;case"rasg":const T=We.ks(t,s.arguments,"rasgueado pattern",ie.rasgueado);return void 0===T?vt.NotAppliedSemanticError:(e.rasgueado=T,vt.Applied);case"ot":const M=We.ks(t,s.arguments,"ottava",ie.ottavia);return void 0===M?vt.NotAppliedSemanticError:(e.ottava=M,vt.Applied);case"legatoorigin":return e.isLegatoOrigin=!0,vt.Applied;case"instrument":let v=0;switch(s.arguments.arguments[0].nodeType){case kt.Ident:case kt.String:v=de.getValue(s.arguments.arguments[0].text);break;case kt.Number:v=s.arguments.arguments[0].value}const N=new $;return N.isLinear=!1,N.type=r.Instrument,N.value=v,e.automations.push(N),vt.Applied;case"bank":const P=new $;return P.isLinear=!1,P.type=r.Bank,P.value=s.arguments.arguments[0].value,e.automations.push(P),vt.Applied;case"fermata":const E=We.ks(t,s.arguments,"fermata",ie.fermataType);if(void 0===E)return vt.NotAppliedSemanticError;const C=new me;return C.type=E,s.arguments.arguments.length>1&&(C.length=s.arguments.arguments[1].value),e.fermata=C,vt.Applied;case"beam":const F=s.arguments.arguments[0].text;switch(F.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=At.Up;break;case"down":e.preferredBeamDirection=At.Down;break;case"auto":e.beamingMode=wt.Auto;break;case"split":e.beamingMode=wt.ForceSplitToNext;break;case"merge":e.beamingMode=wt.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=wt.ForceSplitOnSecondaryToNext;break;default:const i=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected beam value '${F}', expected: ${i.join(",")}`,severity:St.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),vt.NotAppliedSemanticError}return vt.Applied;case"timer":return e.showTimer=!0,vt.Applied}return vt.NotAppliedUnrecognizedMarker}static Hs(t,e,s,i=!1){const n=new Y;n.pedalType=s,n.ratioPosition=i?1:.001*e.voice.bar.sustainPedals.length,t.state.sustainPedalToBeat.set(n,e),e.voice.bar.sustainPedals.push(n)}static Vs(t,e,s,i){t.brushType=s,e.arguments&&e.arguments.arguments.length>0?t.brushDuration=e.arguments.arguments[0].value:(t.updateDurations(),t.brushDuration=t.playbackDuration*i/t.notes.length)}applyNoteProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.ws(t,[ne.noteProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"b":case"be":let n=0,r=!0,a=!1;for(;r;)switch(s.arguments.arguments[n].nodeType){case kt.Ident:case kt.String:const i=s.arguments.arguments[n].text.toLowerCase();if(ie.bendType.has(i))e.bendType=ie.bendType.get(i),a=!0,n++;else{if(!ie.bendStyle.has(i))return a?We.ks(t,s.arguments,"bend style",ie.bendStyle,n):We.ks(t,s.arguments,"bend type",ie.bendType,n),vt.NotAppliedSemanticError;e.bendStyle=ie.bendStyle.get(i),n++}break;default:r=!1}const h=this.$s(t,s,n,"be"===i);if(h)for(const t of h)e.addBendPoint(t);return vt.Applied;case"nh":return e.harmonicType=p.Natural,e.harmonicValue=Ht.deltaFretToHarmonicValue(e.fret),vt.Applied;case"ah":return e.harmonicType=p.Artificial,e.harmonicValue=We.Us(s.arguments,e.harmonicValue),vt.Applied;case"th":return e.harmonicType=p.Tap,e.harmonicValue=We.Us(s.arguments,e.harmonicValue),vt.Applied;case"ph":return e.harmonicType=p.Pinch,e.harmonicValue=We.Us(s.arguments,e.harmonicValue),vt.Applied;case"sh":return e.harmonicType=p.Semi,e.harmonicValue=We.Us(s.arguments,e.harmonicValue),vt.Applied;case"fh":return e.harmonicType=p.Feedback,e.harmonicValue=We.Us(s.arguments,e.harmonicValue),vt.Applied;case"tr":const o=s.arguments.arguments[0].value;let c=l.Sixteenth;if(s.arguments.arguments.length>1){const e=s.arguments.arguments[1].value;switch(e){case 16:c=l.Sixteenth;break;case 32:c=l.ThirtySecond;break;case 64:c=l.SixtyFourth;break;default:return t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected trill duration value '${e}', expected: 16, 32 or 64`,severity:St.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),vt.NotAppliedSemanticError}}return e.trillValue=o+e.stringTuning,e.trillSpeed=c,vt.Applied;case"v":return e.vibrato=y.Slight,vt.Applied;case"vw":return e.vibrato=y.Wide,vt.Applied;case"sl":return e.slideOutType=w.Legato,vt.Applied;case"ss":return e.slideOutType=w.Shift,vt.Applied;case"sib":return e.slideInType=g.IntoFromBelow,vt.Applied;case"sia":return e.slideInType=g.IntoFromAbove,vt.Applied;case"sou":return e.slideOutType=w.OutUp,vt.Applied;case"sod":return e.slideOutType=w.OutDown,vt.Applied;case"psd":return e.slideOutType=w.PickSlideDown,vt.Applied;case"psu":return e.slideOutType=w.PickSlideUp,vt.Applied;case"h":return e.isHammerPullOrigin=!0,vt.Applied;case"lht":return e.isLeftHandTapped=!0,vt.Applied;case"g":return e.isGhost=!0,vt.Applied;case"ac":return e.accentuated=d.Normal,vt.Applied;case"hac":return e.accentuated=d.Heavy,vt.Applied;case"ten":return e.accentuated=d.Tenuto,vt.Applied;case"pm":return e.isPalmMute=!0,vt.Applied;case"st":return e.isStaccato=!0,vt.Applied;case"lr":return e.isLetRing=!0,vt.Applied;case"x":return e.isDead=!0,vt.Applied;case"-":case"t":return e.isTieDestination=!0,vt.Applied;case"lf":let u=f.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=We.zs(t,s.arguments);if(void 0===e)return vt.NotAppliedSemanticError;u=e}return e.leftHandFinger=u,vt.Applied;case"rf":let b=f.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=We.zs(t,s.arguments);if(void 0===e)return vt.NotAppliedSemanticError;b=e}return e.rightHandFinger=b,vt.Applied;case"acc":return e.accidentalMode=Ht.parseAccidentalMode(s.arguments.arguments[0].text),vt.Applied;case"turn":return e.ornament=lt.Turn,vt.Applied;case"iturn":return e.ornament=lt.InvertedTurn,vt.Applied;case"umordent":return e.ornament=lt.UpperMordent,vt.Applied;case"lmordent":return e.ornament=lt.LowerMordent,vt.Applied;case"string":return e.showStringNumber=!0,vt.Applied;case"hide":return e.isVisible=!1,vt.Applied;case"slur":const m=s.arguments.arguments[0].text;if(t.state.slurs.has(m)){const s=t.state.slurs.get(m);s.slurDestination=e,e.slurOrigin=s,e.isSlurDestination=!0}else t.state.slurs.set(m,e);return vt.Applied;default:return this.applyBeatProperty(t,e.beat,s)}return vt.NotAppliedUnrecognizedMarker}static zs(t,e){const s=e.arguments[0].value;switch(s){case 1:return f.Thumb;case 2:return f.IndexFinger;case 3:return f.MiddleFinger;case 4:return f.AnnularFinger;case 5:return f.LittleFinger;default:return void t.addSemanticDiagnostic({code:Bt.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:e.arguments[0].start,end:e.arguments[0].end,severity:St.Error})}}static Us(t,e){return t&&(e=t.arguments[0].value),e}$s(t,e,s,i){let n=e.arguments.arguments,r=n.length-s,a=e.arguments;r>0&&n[s].nodeType===kt.Arguments&&(n=n[s].arguments,s=0,r=n.length,a=n[s]);const h=i?2:1;if(r%h!==0){const s=Math.ceil(r/h),i=s*h;return void t.addSemanticDiagnostic({code:Bt.AT214,message:`The '${e.property.text}' effect needs ${h} arguments per item. With ${s} points, ${i} arguments are needed, only ${r} arguments found.`,severity:St.Error,start:a.end,end:a.end})}const o=[];let c=s;for(;c<n.length;){let t=0,e=0;i?(t=n[c++].value,e=n[c++].value):(t=0,e=n[c++].value),o.push(new V(t,e))}if(o.length>0){if(o.length>60&&o.splice(60,o.length-60),i)o.sort((t,e)=>t.offset-e.offset);else{const t=o.length,e=V.MaxPosition/(t-1)|0;let s=0;for(;s<t;)o[s].offset=Math.min(V.MaxPosition,s*e),s++}return o}}static ks(t,e,s,i,n=0){if(n>=e.arguments.length)return;const r=e.arguments[n].text;return i.has(r.toLowerCase())?i.get(r.toLowerCase()):void t.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected ${s} value '${r}', expected: ${Array.from(i.keys()).join(",")}`,severity:St.Error,start:e.arguments[n].start,end:e.arguments[n].end})}static js=new Ot;static Xs=new _e;buildScoreMetaDataNodes(t){const e=[];return We.Js(e,"album",t,t.album,nt.Album),We.Js(e,"artist",t,t.artist,nt.Artist),We.Js(e,"copyright",t,t.copyright,nt.Copyright),We.Js(e,"copyright2",t,void 0,nt.CopyrightSecondLine),We.Js(e,"wordsandmusic",t,void 0,nt.WordsAndMusic,!0),We.Js(e,"instructions",t,t.instructions,void 0),We.Js(e,"music",t,t.music,nt.Music),We.Js(e,"notices",t,t.notices,void 0),We.Js(e,"subtitle",t,t.subTitle,nt.SubTitle),We.Js(e,"title",t,t.title,nt.Title),We.Js(e,"words",t,t.words,nt.Words),We.Js(e,"tab",t,t.tab,nt.Transcriber),t.defaultSystemsLayout!==We.js.defaultSystemsLayout&&e.push(le.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&e.push(le.meta("systemsLayout",le.args(t.systemsLayout.map(t=>le.number(t))))),We.qs(e,t.stylesheet),e.length>0&&(e[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),e}static qs(t,e){const s=t.length;e.hideDynamics&&t.push(le.meta("hideDynamics")),e.bracketExtendMode!==We.js.stylesheet.bracketExtendMode&&t.push(le.identMeta("bracketExtendMode",ie.bracketExtendModeReversed.get(e.bracketExtendMode))),e.useSystemSignSeparator&&t.push(le.meta("useSystemSignSeparator")),e.multiTrackMultiBarRest&&t.push(le.meta("multiBarRest")),e.singleTrackTrackNamePolicy!==We.js.stylesheet.singleTrackTrackNamePolicy&&t.push(le.identMeta("singleTrackTrackNamePolicy",ie.trackNamePolicyReversed.get(e.singleTrackTrackNamePolicy))),e.multiTrackTrackNamePolicy!==We.js.stylesheet.multiTrackTrackNamePolicy&&t.push(le.identMeta("multiTrackTrackNamePolicy",ie.trackNamePolicyReversed.get(e.multiTrackTrackNamePolicy))),e.firstSystemTrackNameMode!==We.js.stylesheet.firstSystemTrackNameMode&&t.push(le.identMeta("firstSystemTrackNameMode",ie.trackNameModeReversed.get(e.firstSystemTrackNameMode))),e.otherSystemsTrackNameMode!==We.js.stylesheet.otherSystemsTrackNameMode&&t.push(le.identMeta("otherSystemsTrackNameMode",ie.trackNameModeReversed.get(e.otherSystemsTrackNameMode))),e.firstSystemTrackNameOrientation!==We.js.stylesheet.firstSystemTrackNameOrientation&&t.push(le.identMeta("firstSystemTrackNameOrientation",ie.trackNameOrientationReversed.get(e.firstSystemTrackNameOrientation))),e.otherSystemsTrackNameOrientation!==We.js.stylesheet.otherSystemsTrackNameOrientation&&t.push(le.identMeta("otherSystemsTrackNameOrientation",ie.trackNameOrientationReversed.get(e.otherSystemsTrackNameOrientation))),s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static Js(t,e,s,i,n,r=!1){if(void 0!==i&&0===i.length&&!r)return;const a=[];if(void 0!==i&&a.push(le.string(i)),void 0!==n){const t=s.style&&s.style.headerAndFooter.has(n)?s.style.headerAndFooter.get(n):void 0,e=Rt.defaultHeaderAndFooter.has(n)?Rt.defaultHeaderAndFooter.get(n):void 0;!t||e&&Wt.equals(e,t)||(a.push(le.string(!1===t.isVisible?"":t.template)),a.push(le.ident(ie.textAlignReversed.get(t.textAlign))))}void 0===i&&0===a.length||void 0!==i&&0===i.length&&1===a.length||t.push(le.meta(e,le.args(a)))}buildSyncPointNodes(t){const e=[],s=t.exportFlatSyncPoints();for(const t of s)e.push(le.meta("sync",le.args([le.number(t.barIndex),le.number(t.barOccurence),le.number(t.millisecondOffset),t.barPosition>0?le.number(t.barPosition):void 0])));return e}buildBarMetaDataNodes(t,e,s,i){const n=[];if(We.Ys(e,t,n,i,s),!e)return n;0===s&&0===t.index&&0===t.track.index&&We.Ks(n,e.masterBar);const r=n.length;0===s&&0===e.index&&0===t.index&&0===t.track.index&&n.push(le.identMeta("accidentals","auto")),0!==e.index&&e.clef===e.previousBar?.clef||n.push(le.identMeta("clef",ie.clefReversed.get(e.clef))),(0===e.index&&e.clefOttava!==m.Regular||e.clefOttava!==e.previousBar?.clefOttava)&&n.push(le.identMeta("ottava",ie.ottaviaReversed.get(e.clefOttava))),(0===e.index&&e.simileMark!==E.None||e.simileMark!==e.previousBar?.simileMark)&&n.push(le.identMeta("simile",ie.simileMarkReversed.get(e.simileMark))),1!==e.displayScale&&n.push(le.numberMeta("scale",e.displayScale)),e.displayWidth>0&&n.push(le.numberMeta("width",e.displayWidth));for(const t of e.sustainPedals){let e="";switch(t.pedalType){case A.Down:e="spd";break;case A.Hold:e="sph";break;case A.Up:e="spu"}e&&n.push(le.numberMeta(e,t.ratioPosition))}if(e.barLineLeft!==L.Automatic&&n.push(le.identMeta("barLineLeft",ie.barLineStyleReversed.get(e.barLineLeft))),e.barLineRight!==L.Automatic&&n.push(le.identMeta("barLineRight",ie.barLineStyleReversed.get(e.barLineRight))),0===e.index||e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType){let t="";t=e.keySignatureType===F.Minor?ie.keySignaturesMinorReversed.get(e.keySignature):ie.keySignaturesMajorReversed.get(e.keySignature),n.push(le.identMeta("ks",t))}return r<n.length&&(n[r].leadingComments=[{multiLine:!1,text:`Bar ${e.index+1} Metadata`}]),n}static Qs(t,e){const s=t.length;if(0!==e.capo&&t.push(le.numberMeta("capo",e.capo)),e.isPercussion)t.push(le.identMeta("articulation","defaults"));else if(e.isStringed){const s=le.meta("tuning",le.args(e.stringTuning.tunings.map(t=>le.ident(ye.getTextForTuning(t,!0)))));t.push(s),e.track.score.stylesheet.perTrackDisplayTuning&&e.track.score.stylesheet.perTrackDisplayTuning.has(e.track.index)&&(s.properties=le.props([["hide",void 0]])),e.stringTuning.name.length>0&&(s.properties??=le.props([]),le.prop(s.properties.properties,"label",le.stringValue(e.stringTuning.name)))}0!==e.transpositionPitch&&t.push(le.numberMeta("transpose",-e.transpositionPitch));const i=Ht.displayTranspositionPitches.has(e.track.playbackInfo.program)?Ht.displayTranspositionPitches.get(e.track.playbackInfo.program):0;if(e.displayTranspositionPitch!==i&&t.push(le.numberMeta("displaytranspose",-e.displayTranspositionPitch)),null!=e.chords)for(const[s,i]of e.chords)t.push(We.Zs(i));s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Staff ${e.index+1} Metadata`}])}static Zs(t){const e=le.meta("chord",le.args([le.string(t.name)],!0),le.props([t.firstFret>=0?["firstfret",le.numberValue(t.firstFret)]:void 0,["showdiagram",le.identValue(t.showDiagram?"true":"false")],["showfingering",le.identValue(t.showFingering?"true":"false")],["showname",le.identValue(t.showName?"true":"false")],t.barreFrets.length>0?["barre",le.args(t.barreFrets.map(t=>le.number(t)))]:void 0]));for(let s=0;s<t.staff.tuning.length;s++)s<t.strings.length&&t.strings[s]>=0?e.arguments.arguments.push(le.number(t.strings[s])):e.arguments.arguments.push(le.ident("x"));return e}static Ks(t,e){const s=t.length;if(0!==e.alternateEndings&&t.push(le.meta("ae",le.args(Ht.getAlternateEndingsList(e.alternateEndings).map(t=>le.number(t+1))))),e.isRepeatStart&&t.push(le.meta("ro")),e.isRepeatEnd&&t.push(le.numberMeta("rc",e.repeatCount)),0!==e.index&&e.timeSignatureCommon===e.previousMasterBar?.timeSignatureCommon&&e.timeSignatureNumerator===e.previousMasterBar.timeSignatureNumerator&&e.timeSignatureDenominator===e.previousMasterBar.timeSignatureDenominator||(e.timeSignatureCommon?t.push(le.identMeta("ts","common")):t.push(le.meta("ts",le.args([le.number(e.timeSignatureNumerator),le.number(e.timeSignatureDenominator)])))),(e.index>0&&e.tripletFeel!==e.previousMasterBar?.tripletFeel||0===e.index&&e.tripletFeel!==rt.NoTripletFeel)&&t.push(le.identMeta("tf",ie.tripletFeelReversed.get(e.tripletFeel))),e.isFreeTime&&t.push(le.meta("ft")),null!=e.section&&t.push(le.meta("section",le.args([le.string(e.section.marker),le.string(e.section.text)]))),e.isAnacrusis&&t.push(le.meta("ac")),1!==e.displayScale&&t.push(le.numberMeta("scale",e.displayScale)),e.displayWidth>0&&t.push(le.numberMeta("width",e.displayWidth)),e.directions)for(const s of e.directions)t.push(le.identMeta("jump",ie.directionReversed.get(s)));for(const s of e.tempoAutomations){const e=le.meta("tempo",le.args([le.number(s.value),s.text?le.string(s.text):void 0,s.ratioPosition>0?le.number(s.ratioPosition):void 0,s.isVisible?void 0:le.ident("hide")]));1===e.arguments.arguments.length&&(e.arguments.openParenthesis=void 0,e.arguments.closeParenthesis=void 0),t.push(e)}s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Masterbar ${e.index+1} Metadata`}])}static Ys(t,e,s,i,n){if((void 0===t||0===t.index)&&(0===n&&(0===e.index&&s.push(We.ti(e.track)),s.push(We.ei(e)),We.Qs(s,e)),i)){const t=le.meta("voice");t.trailingComments=[{multiLine:!0,text:`Voice ${n+1}`}],s.push(t)}}static ei(t){const e=le.meta("staff",void 0,le.props([t.showStandardNotation?["score",le.args([t.standardNotationLineCount!==ke.DefaultStandardNotationLineCount?le.number(t.standardNotationLineCount):void 0])]:void 0,t.showTablature?["tabs",void 0]:void 0,t.showSlash?["slash",void 0]:void 0,t.showNumbered?["numbered",void 0]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static ti(t){const e=le.meta("track",le.args([le.string(t.name),t.shortName.length>0?le.string(t.shortName):void 0]),le.props([t.color.rgba!==We.Xs.color.rgba?["color",le.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==We.Xs.defaultSystemsLayout?["defaultSystemsLayout",le.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",le.args(t.systemsLayout.map(t=>le.number(t)))]:void 0,["volume",le.numberValue(t.playbackInfo.volume)],["balance",le.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",le.identValue(t.isPercussion?"percussion":de.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",le.numberValue(t.playbackInfo.bank)]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(t){const e=[];if(t.hasBend){const s=le.args([le.ident(ie.bendTypeReversed.get(t.bendType)),t.bendStyle!==a.Default?le.ident(ie.bendStyleReversed.get(t.bendStyle)):void 0],!0);for(const e of t.bendPoints)s.arguments.push(le.number(e.offset)),s.arguments.push(le.number(e.value));le.prop(e,"be",s)}let s="";switch(t.harmonicType){case p.Natural:le.prop(e,"nh");break;case p.Artificial:s="ah";break;case p.Pinch:s="ph";break;case p.Tap:s="th";break;case p.Semi:s="sh";break;case p.Feedback:s="fh"}switch(s&&le.prop(e,s,le.numberValue(t.harmonicValue)),t.showStringNumber&&le.prop(e,"string"),t.isTrill&&le.prop(e,"tr",le.args([le.number(t.trillFret),le.number(t.trillSpeed)])),t.vibrato){case y.Slight:le.prop(e,"v");break;case y.Wide:le.prop(e,"vw")}switch(t.slideInType){case g.IntoFromBelow:le.prop(e,"sib");break;case g.IntoFromAbove:le.prop(e,"sia")}switch(t.slideOutType){case w.Shift:le.prop(e,"ss");break;case w.Legato:le.prop(e,"sl");break;case w.OutUp:le.prop(e,"sou");break;case w.OutDown:le.prop(e,"sod");break;case w.PickSlideDown:le.prop(e,"psd");break;case w.PickSlideUp:le.prop(e,"psu")}switch(t.isHammerPullOrigin&&le.prop(e,"h"),t.isLeftHandTapped&&le.prop(e,"lht"),t.isGhost&&le.prop(e,"g"),t.accentuated){case d.Normal:le.prop(e,"ac");break;case d.Heavy:le.prop(e,"hac");break;case d.Tenuto:le.prop(e,"ten")}if(t.isPalmMute&&le.prop(e,"pm"),t.isStaccato&&le.prop(e,"st"),t.isLetRing&&le.prop(e,"lr"),t.isDead&&le.prop(e,"x"),t.isTieDestination&&le.prop(e,"t"),t.leftHandFinger>=f.Thumb&&le.prop(e,"lf",le.numberValue(t.leftHandFinger+1)),t.rightHandFinger>=f.Thumb&&le.prop(e,"rf",le.numberValue(t.rightHandFinger+1)),t.isVisible||le.prop(e,"hide"),t.isSlurOrigin){const s=`s${t.id}`;le.prop(e,"slur",le.identValue(s))}if(t.isSlurDestination){const s=`s${t.slurOrigin.id}`;le.prop(e,"slur",le.identValue(s))}switch(t.accidentalMode!==b.Default&&le.prop(e,"acc",le.identValue(Ht.reverseAccidentalModeMapping.get(t.accidentalMode))),t.ornament){case lt.InvertedTurn:le.prop(e,"iturn");break;case lt.Turn:le.prop(e,"turn");break;case lt.UpperMordent:le.prop(e,"umordent");break;case lt.LowerMordent:le.prop(e,"lmordent")}return e}buildBeatEffects(t){const e=[];switch(t.fade){case pt.FadeIn:le.prop(e,"f");break;case pt.FadeOut:le.prop(e,"fo");break;case pt.VolumeSwell:le.prop(e,"vs")}if(t.vibrato===y.Slight?le.prop(e,"v"):t.vibrato===y.Wide&&le.prop(e,"vw"),t.slap&&le.prop(e,"s"),t.pop&&le.prop(e,"p"),t.tap&&le.prop(e,"tt"),t.dots>=2?le.prop(e,"dd"):t.dots>0&&le.prop(e,"d"),t.pickStroke===ot.Up?le.prop(e,"su"):t.pickStroke===ot.Down&&le.prop(e,"sd"),t.hasTuplet&&le.prop(e,"tu",le.args([le.number(t.tupletNumerator),le.number(t.tupletDenominator)])),t.hasWhammyBar){const s=le.args([le.ident(ie.whammyTypeReversed.get(t.whammyBarType)),le.ident(ie.bendStyleReversed.get(t.whammyStyle))],!0);for(const e of t.whammyBarPoints)s.arguments.push(le.number(e.offset)),s.arguments.push(le.number(e.value));le.prop(e,"tbe",s)}let s="";switch(t.brushType){case o.BrushUp:s="bu";break;case o.BrushDown:s="bd";break;case o.ArpeggioUp:s="au";break;case o.ArpeggioDown:s="ad"}if(s&&le.prop(e,s,le.numberValue(t.brushDuration)),null!=t.chord&&le.prop(e,"ch",le.stringValue(t.chord.name)),t.ottava!==m.Regular&&le.prop(e,"ot",le.identValue(ie.ottaviaReversed.get(t.ottava))),t.hasRasgueado&&le.prop(e,"rasg",le.identValue(ie.rasgueadoReversed.get(t.rasgueado))),null!=t.text&&le.prop(e,"txt",le.stringValue(t.text)),null!=t.lyrics&&t.lyrics.length>0)if(t.lyrics.length>1)for(let s=0;s<t.lyrics.length;s++)le.prop(e,"lyrics",le.args([le.number(s),le.string(t.lyrics[s])]));else le.prop(e,"lyrics",le.stringValue(t.lyrics[0]));switch(t.graceType!==u.None&&le.prop(e,"gr",t.graceType===u.BeforeBeat?void 0:le.identValue(ie.graceTypeReversed.get(t.graceType))),t.isTremolo&&le.prop(e,"tp",le.numberValue(t.tremoloSpeed)),t.crescendo){case c.Crescendo:le.prop(e,"cre");break;case c.Decrescendo:le.prop(e,"dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&le.prop(e,"dy",le.identValue(ie.dynamicValueReversed.get(t.dynamics)));null!=t.fermata&&le.prop(e,"fermata",le.args([le.ident(ie.fermataTypeReversed.get(t.fermata.type)),le.number(t.fermata.length)])),t.isLegatoOrigin&&le.prop(e,"legatoorigin");for(const s of t.automations)switch(s.type){case r.Tempo:le.prop(e,"tempo",le.args([le.number(s.value),0===s.text.length?void 0:le.string(s.text)]));break;case r.Volume:le.prop(e,"volume",le.numberValue(s.value));break;case r.Instrument:t.voice.bar.staff.isPercussion||le.prop(e,"instrument",le.identValue(de.getName(s.value)));break;case r.Balance:le.prop(e,"balance",le.numberValue(s.value))}switch(t.wahPedal){case bt.Open:le.prop(e,"waho");break;case bt.Closed:le.prop(e,"wahc")}switch(t.isBarre&&le.prop(e,"barre",le.args([le.number(t.barreFret),le.ident(ie.barreShapeReversed.get(t.barreShape))])),t.slashed&&le.prop(e,"slashed"),t.deadSlapped&&le.prop(e,"ds"),t.golpe){case ft.Thumb:le.prop(e,"glpt");break;case ft.Finger:le.prop(e,"glpf")}t.invertBeamDirection?le.prop(e,"beam",le.identValue("invert")):null!==t.preferredBeamDirection&&le.prop(e,"beam",le.identValue(At[t.preferredBeamDirection]));let i="";switch(t.beamingMode){case wt.ForceSplitToNext:i="split";break;case wt.ForceMergeWithNext:i="merge";break;case wt.ForceSplitOnSecondaryToNext:i="splitsecondary"}return i&&le.prop(e,"beam",le.identValue(i)),t.showTimer&&le.prop(e,"timer"),e}}class Re{data;settings;init(t,e){this.data=t,this.settings=e,Ot.resetIds()}}class Oe extends R{constructor(e=null,s){super(t.AlphaTabErrorType.Format,e??"Unsupported format",s)}}class Ie{si;length=0;position=0;get bytesWritten(){return this.position}getBuffer(){return this.si}static empty(){return Ie.withCapacity(0)}static withCapacity(t){const e=new Ie;return e.si=new Uint8Array(t),e}static fromBuffer(t){const e=new Ie;return e.si=t,e.length=t.length,e}static fromString(t){const e=he.stringToBytes(t);return Ie.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this.si[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this.si.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this.ii(e),this.si[this.position]=255&t,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this.ii(i);const n=Math.min(s,t.length-e);this.si.set(t.subarray(e,e+n),this.position),i>this.length&&(this.length=i),this.position=i}ii(t){if(t>this.si.length){let e=t;e<256&&(e=256),e<2*this.si.length&&(e=2*this.si.length);const s=new Uint8Array(e);this.length>0&&s.set(this.si.subarray(0,0+this.length),0),this.si=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this.si.subarray(0,0+this.length),0),t}copyTo(t){t.write(this.si,0,this.length)}}class Ge extends R{lexerDiagnostics;parserDiagnostics;semanticDiagnostics;*iterateDiagnostics(){if(this.lexerDiagnostics)for(const t of this.lexerDiagnostics.items)yield t;if(this.parserDiagnostics)for(const t of this.parserDiagnostics.items)yield t;if(this.semanticDiagnostics)for(const t of this.semanticDiagnostics.items)yield t}constructor(e,s,i,n){super(t.AlphaTabErrorType.AlphaTex,e),this.lexerDiagnostics=s,this.parserDiagnostics=i,this.semanticDiagnostics=n}toString(){return[this.message,"lexer diagnostics:",Ge.ni(this.lexerDiagnostics,"  "),"parser diagnostics:",Ge.ni(this.parserDiagnostics,"  "),"semantic diagnostics:",Ge.ni(this.semanticDiagnostics,"  ")].join("\n")}static ni(t,e){return t?t.items.map(t=>`${e}${St[t.severity]} AT${t.code.toString().padStart(3,"0")}${Ge.ri(t)}: ${t.message}`).join("\n"):`${e}none`}static ri(t){let e="";return t.start&&(e+=`(${t.start.line},${t.start.col})`),t.end&&(e.length>0&&(e+="->"),e+=`(${t.end.line},${t.end.col})`),e}}class $e{trackChannel=0;score;currentTrack;currentStaff;barIndex=0;voiceIndex=0;ignoredInitialVoice=!1;ignoredInitialStaff=!1;ignoredInitialTrack=!1;currentDuration=l.Quarter;articulationValueToIndex=new Map;hasAnyProperData=!1;percussionArticulationNames=new Map;slurs=new Map;lyrics=new Map;sustainPedalToBeat=new Map;staffTuningApplied=new Set;staffNoteKind=new Map;staffHasExplicitTuning=new Set;staffHasExplicitDisplayTransposition=new Set;staffDisplayTranspositionApplied=new Set;staffInitialClef=new Map;syncPoints=[];currentDynamics=n.F;accidentalMode=_t.Explicit;currentTupletNumerator=-1;currentTupletDenominator=-1;scoreNode}class Ve extends Re{ai;hi=We.instance;oi=new $e;get state(){return this.oi}get scoreNode(){return this.oi.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this.ai.lexerDiagnostics}get parserDiagnostics(){return this.ai.parserDiagnostics}get parser(){return this.ai}get parseMode(){return this.ai.mode}logErrors=!1;semanticDiagnostics=new re;addSemanticDiagnostic(t){this.semanticDiagnostics.push(t)}initFromString(t,e){this.data=Ie.empty(),this.ai=new ce(t),this.settings=e,Ot.resetIds()}readScore(){let t;this.oi=new $e,this.ci(),this.data.length>0&&(this.ai=new ce(he.toString(this.data.readAll(),this.settings.importer.encoding)));try{t=this.ai.read(),this.oi.scoreNode=t}catch(t){throw this.logErrors&&j.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Oe("Error parsing alphaTex, check inner error for details",t)}if(this.ai.parserDiagnostics.hasErrors||this.ai.lexer.lexerDiagnostics.hasErrors){const t=new Ge("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&j.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Oe("Error parsing alphaTex, check diagnostics on inner error for details",t)}if(0===t.bars.length)throw new Oe("No alphaTex data found");if(this.de(t),this.semanticDiagnostics.hasErrors){if(this.oi.hasAnyProperData){const t=new Ge("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&j.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),t}throw new Oe("No alphaTex data found")}Ht.consolidate(this.oi.score),this.oi.score.finish(this.settings),Ht.trimEmptyBarsAtEnd(this.oi.score),this.oi.score.rebuildRepeatGroups(),this.oi.score.applyFlatSyncPoints(this.oi.syncPoints);for(const[t,e]of this.oi.lyrics)this.oi.score.tracks[t].applyLyrics(e);for(const[t,e]of this.oi.sustainPedalToBeat)if(t.ratioPosition<1){const s=e.voice.bar.masterBar.calculateDuration();t.ratioPosition=e.playbackStart/s}return this.oi.score}ci(){this.oi.score=new Ot,this.li()}li(){this.oi.currentTrack=new _e,this.oi.currentTrack.ensureStaveCount(1),this.oi.currentTrack.playbackInfo.program=25,this.oi.currentTrack.playbackInfo.primaryChannel=this.oi.trackChannel++,this.oi.currentTrack.playbackInfo.secondaryChannel=this.oi.trackChannel++;const t=this.oi.currentTrack.staves[0];t.displayTranspositionPitch=0,t.stringTuning=ye.getDefaultTuningFor(6),this.oi.articulationValueToIndex.clear(),this.ui(t),this.oi.score.addTrack(this.oi.currentTrack),this.oi.lyrics.set(this.oi.currentTrack.index,[]),this.oi.currentDynamics=n.F,this.oi.currentTupletDenominator=-1,this.oi.currentTupletNumerator=-1}ui(t){this.oi.currentStaff&&(this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff)),this.oi.currentStaff=t,this.oi.slurs.clear(),this.oi.barIndex=0,this.oi.voiceIndex=0}de(t){if(t.bars.length>0)for(const e of t.bars)this.fe(e);else this.pi(this.oi.currentStaff),this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff)}fe(t){const e=this.bi(t);this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff),0===e.index&&this.oi.staffInitialClef.has(this.oi.currentStaff)&&(e.clef=this.oi.staffInitialClef.get(this.oi.currentStaff));const s=e.voices[this.oi.voiceIndex];for(const e of t.beats)this.ge(s,e);if(0===s.beats.length){const t=new Kt;t.isEmpty=!0,s.addBeat(t)}}ge(t,e){if(e.durationChange&&this.ke(e.durationChange),!e.notes&&!e.rest)return;const s=new Kt;if(t.addBeat(s),e.notes)for(const t of e.notes.notes)this.xe(s,t);else e.rest;e.durationValue&&(this.oi.currentDuration=this.mi(e.durationValue)),s.duration=this.oi.currentDuration,s.dynamics=this.oi.currentDynamics,-1===this.oi.currentTupletNumerator||s.hasTuplet||(s.tupletNumerator=this.oi.currentTupletNumerator,s.tupletDenominator=this.oi.currentTupletDenominator);let i=1;void 0!==e.beatMultiplierValue&&(i=e.beatMultiplierValue.value),e.beatEffects&&this.gi(s,e.beatEffects);for(let e=0;e<i-1;e++)t.addBeat(se.clone(s))}gi(t,e){for(const s of e.properties){switch(this.hi.applyBeatProperty(this,t,s)){case vt.Applied:case vt.NotAppliedSemanticError:this.oi.hasAnyProperData=!0;break;case vt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:Bt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:St.Error,start:s.start,end:s.end})}}}ke(t){if(t.value&&(this.oi.currentDuration=this.mi(t.value)),this.oi.currentTupletNumerator=-1,this.oi.currentTupletDenominator=-1,t.properties)for(const e of t.properties.properties){switch(this.hi.applyBeatDurationProperty(this,e)){case vt.Applied:case vt.NotAppliedSemanticError:this.oi.hasAnyProperData=!0;break;case vt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:Bt.AT212,message:`Unrecogized property '${e.property.text}', expected one of ${t}`,severity:St.Error,start:e.start,end:e.end})}}}mi(t){switch(t.value){case-4:return l.QuadrupleWhole;case-2:return l.DoubleWhole;case 1:return l.Whole;case 2:return l.Half;case 4:return l.Quarter;case 8:return l.Eighth;case 16:return l.Sixteenth;case 32:return l.ThirtySecond;case 64:return l.SixtyFourth;case 128:return l.OneHundredTwentyEighth;case 256:return l.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected duration value '${t.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:St.Error,start:t.start,end:t.end}),this.oi.currentDuration}}xe(t,e){let s=!1,i=!1,n=-1,r=-1,a=-1,h=b.Default;const o=e.noteValue;let c,l=this.oi.staffNoteKind.has(this.oi.currentStaff)?this.oi.staffNoteKind.get(this.oi.currentStaff):void 0;switch(o.nodeType){case kt.Number:n=o.value,c=void 0!==e.noteString?xt.Fretted:xt.Articulation;break;case kt.String:case kt.Ident:const t=o.text;if(s="x"===t,i="-"===t,i||s)n=0,c=e.noteStringDot&&e.noteString?xt.Fretted:void 0;else{const e=Ht.parseTuning(t);if(e)c=xt.Pitched,r=e.octave,a=e.tone.noteValue,this.oi.accidentalMode===_t.Explicit&&(h=e.tone.accidentalMode);else{c=xt.Articulation;const e=t.toLowerCase(),s=this.oi.percussionArticulationNames;if(void 0===l&&0===s.size)for(const[t,e]of zt.instrumentArticulationNames)s.set(t.toLowerCase(),e),s.set(Ht.toArticulationId(t),e);if(!s.has(e))return this.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected percussion articulation value '${e}', expected: oneOf(${Array.from(this.oi.percussionArticulationNames.keys()).join(",")}).`,severity:St.Error,start:o.start,end:o.end}),void(n=Array.from(zt.instrumentArticulationNames.values())[0]);n=s.get(e)}}}void 0!==c?void 0===l?(l=c,this.applyStaffNoteKind(this.oi.currentStaff,l)):l!==c&&this.addSemanticDiagnostic({code:Bt.AT218,message:`Wrong note kind '${xt[c]}' for staff with note kind ''${xt[l]}'. Do not mix incompatible staves and notes.`,severity:St.Error,start:o.start,end:o.end}):void 0!==l&&(c=l);const u=new Jt;if(u.isDead=s,(s||i)&&(u.fret=n),u.isTieDestination=i,void 0!==c&&c===l)switch(c){case xt.Pitched:u.octave=r,u.tone=a,u.accidentalMode=h;break;case xt.Fretted:if(!e.noteString)return void this.addSemanticDiagnostic({code:Bt.AT207,message:"Missing string for fretted note.",severity:St.Error,start:o.end,end:o.end});const t=e.noteString.value;if(t<1||t>this.oi.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:Bt.AT208,message:`Note string is out of range. Available range: 1-${this.oi.currentStaff.tuning.length}`,severity:St.Error,start:o.end,end:o.end});u.string=this.oi.currentStaff.tuning.length-(t-1),i||(u.fret=n);break;case xt.Articulation:let s=0;if(this.oi.articulationValueToIndex.has(n))s=this.oi.articulationValueToIndex.get(n);else{s=this.oi.currentTrack.percussionArticulations.length;const t=zt.getArticulationByInputMidiNumber(n);if(null===t)return void this.addSemanticDiagnostic({code:Bt.AT209,message:`Unexpected articulation value '${n}', expected: oneOf(${Array.from(zt.instrumentArticulations.keys()).join(",")}).`,severity:St.Error,start:o.end,end:o.end});this.oi.currentTrack.percussionArticulations.push(t),this.oi.articulationValueToIndex.set(n,s)}u.percussionArticulation=s}t.addNote(u),this.oi.hasAnyProperData=!0,e.noteEffects&&this.wi(u,e.noteEffects)}getStaffNoteKind(t){return this.oi.staffNoteKind.has(t)?this.oi.staffNoteKind.get(t):void 0}applyStaffNoteKind(t,e){switch(this.oi.staffNoteKind.set(t,e),e){case xt.Pitched:t.isPercussion=!1,t.stringTuning.reset(),this.oi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0);break;case xt.Fretted:t.isPercussion=!1,this.di(t),this.fi(t);break;case xt.Articulation:t.isPercussion=!0,t.stringTuning.reset(),this.oi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0)}}wi(t,e){for(const s of e.properties){let e=this.hi.applyNoteProperty(this,t,s);switch(e===vt.NotAppliedUnrecognizedMarker&&(e=this.hi.applyBeatProperty(this,t.beat,s)),e){case vt.Applied:case vt.NotAppliedSemanticError:break;case vt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownNoteProperties).concat(Array.from(this.hi.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:Bt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:St.Error,start:s.start,end:s.end})}}}fi(t){if(!this.oi.staffDisplayTranspositionApplied.has(t)&&!this.oi.staffHasExplicitDisplayTransposition.has(t)){const e=t.track.playbackInfo.program;Ht.displayTranspositionPitches.has(e)?t.displayTranspositionPitch=Ht.displayTranspositionPitches.get(e):this.oi.currentStaff.displayTranspositionPitch=0,this.oi.staffDisplayTranspositionApplied.add(t)}}di(t){const e=t.track.playbackInfo.program;this.oi.staffTuningApplied.has(t)||this.oi.staffHasExplicitTuning.has(t)||(t.stringTuning.reset(),15===e||e>=24&&e<=31?t.stringTuning.tunings=ye.getDefaultTuningFor(6).tunings:e>=32&&e<=39?(t.stringTuning.tunings=[43,38,33,28],this.oi.staffInitialClef.set(t,P.F4)):40===e||44===e||45===e||48===e||49===e||50===e||51===e?t.stringTuning.tunings=[52,57,50,43]:41===e?t.stringTuning.tunings=[57,50,43,36]:42===e?t.stringTuning.tunings=[45,38,31,24]:43===e?t.stringTuning.tunings=[43,38,33,28]:105===e?t.stringTuning.tunings=[50,47,43,38,55]:106===e?t.stringTuning.tunings=[57,52,45]:107===e?t.stringTuning.tunings=[52,45,38,31]:110===e?t.stringTuning.tunings=[64,57,50,43]:this.oi.staffNoteKind.has(t)&&this.oi.staffNoteKind.get(t)===xt.Fretted&&(t.stringTuning=ye.getDefaultTuningFor(6)),this.oi.staffTuningApplied.add(t))}bi(e){let s=this.oi.score.masterBars.length>0?void 0:[],i=this.oi.currentStaff,n=!1,r=!1,a=!1;const h=()=>{s&&(s=void 0,i=this.oi.currentStaff,n=!1,r=!1,a=!1)},o=new U(()=>{const t=this.pi(this.oi.currentStaff);if(s){for(const e of s)this.hi.applyBarMetaData(this,t,e);h()}return t});for(const c of e.metaData){const e=c.tag.tag.text.toLowerCase();if(this.hi.knownStructuralMetaDataTags.has(e)){this.oi.hasAnyProperData=!0;switch(this.hi.applyStructuralMetaData(this,c)){case Nt.AppliedNewTrack:r||n?a=!0:(n=!0,i=this.oi.currentStaff),o.reset();break;case Nt.AppliedNewStaff:r?a=!0:(r=!0,i=this.oi.currentStaff),o.reset()}if(s&&a){if(0!==i.bars.length)throw new R(t.AlphaTabErrorType.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");{const t=new Q;i.addBar(t);const e=new et;if(t.addVoice(e),i.bars.length>this.oi.score.masterBars.length){const t=new It;this.oi.score.addMasterBar(t)}for(const e of s)this.hi.applyBarMetaData(this,t,e);h()}}}else if(this.hi.knownScoreMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,this.hi.applyScoreMetaData(this,this.oi.score,c);else if(this.hi.knownStaffMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,this.hi.applyStaffMetaData(this,this.oi.currentStaff,c);else if(this.hi.knownBarMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,s?s.push(c):this.hi.applyBarMetaData(this,o.value,c);else{const t=Array.from(this.hi.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:Bt.AT204,message:`Unrecognized metadata '${c.tag.tag.text}', expected one of: ${t}`,severity:St.Error,start:c.tag.start,end:c.tag.end})}}return o.value}pi(t){if(this.oi.barIndex<t.bars.length){const e=t.bars[this.oi.barIndex];return this.oi.barIndex++,e}const e=0===t.bars.length?1:t.bars[0].voices.length,s=new Q;t.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this.oi.barIndex++,s.index>0&&(s.clef=s.previousBar.clef);for(let t=0;t<e;t++){const t=new et;s.addVoice(t)}if(this.oi.currentStaff.bars.length>this.oi.score.masterBars.length){const t=new It;this.oi.score.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this.oi.ignoredInitialVoice=!1,this.oi.ignoredInitialStaff||this.oi.currentTrack.staves[0].bars.length>0){const t=this.oi.currentStaff.isPercussion;this.oi.currentTrack.ensureStaveCount(this.oi.currentTrack.staves.length+1);const e=this.oi.currentTrack.staves[this.oi.currentTrack.staves.length-1];this.ui(e),t&&this.applyPercussionStaff(this.oi.currentStaff),this.oi.currentDynamics=n.F}else this.oi.ignoredInitialStaff=!0;return this.oi.currentStaff}applyPercussionStaff(t){t.isPercussion=!0,t.showTablature=!1,t.track.playbackInfo.program=0}startNewTrack(){return this.oi.ignoredInitialVoice=!1,this.oi.ignoredInitialStaff=!1,this.oi.ignoredInitialTrack||this.oi.score.masterBars.length>0?this.li():this.oi.ignoredInitialTrack=!0,this.oi.currentTrack}startNewVoice(){if(0!==this.oi.voiceIndex||0!==this.oi.currentStaff.bars.length&&(1!==this.oi.currentStaff.bars.length||!this.oi.currentStaff.bars[0].isEmpty||this.oi.ignoredInitialVoice)){for(const t of this.oi.currentStaff.bars){const e=new et;t.addVoice(e)}this.oi.voiceIndex++,this.oi.barIndex=0,this.oi.currentTupletDenominator=-1,this.oi.currentTupletNumerator=-1}else this.oi.ignoredInitialVoice=!0}}let He=class{};class Ue extends He{n;constructor(t){super(),this.n=t}}class ze extends He{left;right;constructor(t,e){super(),this.left=t,this.right=e}}class je extends He{n;table;constructor(t,e){super(),this.n=t,this.table=e}}class Xe{static make(t,e,s,i){const n=[],r=[];if(i>32)throw new pe("Invalid huffman");for(let t=0;t<i;t++)n.push(0),r.push(0);for(let r=0;r<s;r++){const s=t[r+e];if(s>=i)throw new pe("Invalid huffman");n[s]++}let a=0;for(let t=1;t<i-1;t++)a=a+n[t]<<1,r[t]=a;const h=new Map;for(let i=0;i<s;i++){const s=t[i+e];if(0!==s){const t=r[s-1];r[s-1]=t+1,h.set(t<<5|s,i)}}return Xe.yi(new ze(Xe.ki(h,i,0,1),Xe.ki(h,i,1,1)))}static ki(t,e,s,i){if(i>e)throw new pe("Invalid huffman");const n=s<<5|i;return t.has(n)?new Ue(t.get(n)):(s<<=1,i+=1,new ze(Xe.ki(t,e,s,i),Xe.ki(t,e,1|s,i)))}static yi(t){const e=Xe.Si(t);if(0===e)return t;if(1===e){if(t instanceof ze)return new ze(Xe.yi(t.left),Xe.yi(t.right));throw new pe("assert")}const s=1<<e,i=[];for(let t=0;t<s;t++)i.push(new Ue(-1));return Xe.Bi(i,0,0,e,t),new je(e,i)}static Bi(t,e,s,i,n){n instanceof ze&&i>0?(Xe.Bi(t,e,s+1,i-1,n.left),Xe.Bi(t,e|1<<s,s+1,i-1,n.right)):t[e]=Xe.yi(n)}static Si(t){if(t instanceof Ue)return 0;if(t instanceof je)throw new pe("assert");if(t instanceof ze){const e=Xe.Si(t.left),s=Xe.Si(t.right);return 1+(e<s?e:s)}return 0}}var Je,qe,Ye,Ke,Qe,Ze,ts,es,ss,is,ns,rs,as,hs,os,cs,ls,us,ds,fs,ps,bs,ms,gs,ws,ys,ks,Ss;!function(t){t[t.Head=0]="Head",t[t.Block=1]="Block",t[t.CData=2]="CData",t[t.Flat=3]="Flat",t[t.Crc=4]="Crc",t[t.Dist=5]="Dist",t[t.DistOne=6]="DistOne",t[t.Done=7]="Done"}(Je||(Je={}));class Bs{static _i=32768;static xi=65536;buffer=new Uint8Array(Bs.xi);pos=0;slide(){const t=new Uint8Array(Bs.xi);this.pos-=Bs._i,t.set(this.buffer.subarray(Bs._i,Bs._i+this.pos),0),this.buffer=t}addBytes(t,e,s){this.pos+s>Bs.xi&&this.slide(),this.buffer.set(t.subarray(e,e+s),this.pos),this.pos+=s}addByte(t){this.pos===Bs.xi&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}class _s{static Ti=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1];static Ni=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];static Pi=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1];static Ei=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];static Ci=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static Fi=_s.Ai();static Ai(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return Xe.make(t,0,288,10)}Di=0;Li=0;oi=Je.Block;Wi=!1;Ri=_s.Fi;Oi=null;Gi=0;$i=0;Vi=0;Hi=null;Ui=0;zi;ji=[];Xi=new Bs;constructor(t){this.zi=t;for(let t=0;t<19;t++)this.ji.push(-1)}readBytes(t,e,s){if(this.Vi=s,this.Ui=e,this.Hi=t,s>0)for(;this.Ji(););return s-this.Vi}Ji(){switch(this.oi){case Je.Head:const t=this.zi.readByte();if(8!==(15&t))throw new pe("Invalid data");const e=this.zi.readByte(),s=!!(32&e);if(((t<<8)+e)%31!=0)throw new pe("Invalid data");if(s)throw new pe("Unsupported dictionary");return this.oi=Je.Block,!0;case Je.Crc:return this.oi=Je.Done,!0;case Je.Done:return!1;case Je.Block:switch(this.Wi=this.qi(),this.Yi(2)){case 0:this.Gi=he.readUInt16LE(this.zi);if(he.readUInt16LE(this.zi)!==65535-this.Gi)throw new pe("Invalid data");this.oi=Je.Flat;const t=this.Ji();return this.Ki(),t;case 1:return this.Ri=_s.Fi,this.Oi=null,this.oi=Je.CData,!0;case 2:const e=this.Yi(5)+257,s=this.Yi(5)+1,i=this.Yi(4)+4;for(let t=0;t<i;t++)this.ji[_s.Ci[t]]=this.Yi(3);for(let t=i;t<19;t++)this.ji[_s.Ci[t]]=0;this.Ri=Xe.make(this.ji,0,19,8);const n=[];for(let t=0;t<e+s;t++)n.push(0);return this.Qi(n,e+s),this.Oi=Xe.make(n,e,s,16),this.Ri=Xe.make(n,0,e,16),this.oi=Je.CData,!0;default:throw new pe("Invalid data")}case Je.Flat:{const t=this.Gi<this.Vi?this.Gi:this.Vi,e=he.readByteArray(this.zi,t);return this.Gi-=t,this.Zi(e,0,t),0===this.Gi&&(this.oi=this.Wi?Je.Crc:Je.Block),this.Vi>0}case Je.DistOne:{const t=this.Gi<this.Vi?this.Gi:this.Vi;return this.tn(t),this.Gi-=t,0===this.Gi&&(this.oi=Je.CData),this.Vi>0}case Je.Dist:for(;this.Gi>0&&this.Vi>0;){const t=this.Gi<this.$i?this.Gi:this.$i,e=this.Vi<t?this.Vi:t;this.en(this.$i,e),this.Gi-=e}return 0===this.Gi&&(this.oi=Je.CData),this.Vi>0;case Je.CData:let i=this.sn(this.Ri);if(i<256)return this.nn(i),this.Vi>0;if(256===i)return this.oi=this.Wi?Je.Crc:Je.Block,!0;i=i-257&255;let n=_s.Ti[i];if(-1===n)throw new pe("Invalid data");this.Gi=_s.Ni[i]+this.Yi(n);const r=this.Oi,a=r?this.sn(r):this.rn(5);if(n=_s.Pi[a],-1===n)throw new pe("Invalid data");if(this.$i=_s.Ei[a]+this.Yi(n),this.$i>this.Xi.available())throw new pe("Invalid data");return this.oi=1===this.$i?Je.DistOne:Je.Dist,!0}return!1}tn(t){const e=this.Xi.getLastChar();for(let s=0;s<t;s++)this.nn(e)}nn(t){this.Xi.addByte(t),this.Hi[this.Ui]=t,this.Vi--,this.Ui++}en(t,e){this.Zi(this.Xi.buffer,this.Xi.pos-t,e)}qi(){0===this.Di&&(this.Di=8,this.Li=this.zi.readByte());const t=!(1&~this.Li);return this.Di--,this.Li=this.Li>>1,t}Yi(t){for(;this.Di<t;)this.Li=this.Li|this.zi.readByte()<<this.Di,this.Di+=8;const e=this.Li&(1<<t)-1;return this.Di-=t,this.Li=this.Li>>t,e}rn(t){return 0===t?0:this.qi()?1<<t-1|this.rn(t-1):this.rn(t-1)}Ki(){this.Li=0,this.Di=0}Zi(t,e,s){this.Xi.addBytes(t,e,s),this.Hi.set(t.subarray(e,e+s),this.Ui),this.Vi-=s,this.Ui+=s}Qi(t,e){let s=0,i=0;for(;s<e;){const n=this.sn(this.Ri);switch(n){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=n,t[s]=n,s++;break;case 16:const r=s+3+this.Yi(2);if(r>e)throw new pe("Invalid data");for(;s<r;)t[s]=i,s++;break;case 17:if(s+=3+this.Yi(3),s>e)throw new pe("Invalid data");break;case 18:if(s+=11+this.Yi(7),s>e)throw new pe("Invalid data");break;default:throw new pe("Invalid data")}}}sn(t){if(t instanceof Ue)return t.n;if(t instanceof ze)return this.sn(this.qi()?t.right:t.left);if(t instanceof je)return this.sn(t.table[this.Yi(t.n)]);throw new pe("Invalid data")}}class xs{static OptionalDataDescriptorSignature=134695760;static CompressionMethodDeflate=8;static LocalFileHeaderSignature=67324752;static CentralFileHeaderSignature=33639248;static EndOfCentralDirSignature=101010256;fullName;fileName;data;constructor(t,e){this.fullName=t;const s=t.lastIndexOf("/");this.fileName=-1===s||s===t.length-1?this.fullName:t.substr(s+1),this.data=e}}class Ts{an;constructor(t){this.an=t}read(){const t=[];for(;;){const e=this.hn();if(!e)break;t.push(e)}return t}hn(){const t=this.an;if(he.readInt32LE(t)!==xs.LocalFileHeaderSignature)return null;he.readUInt16LE(t);const e=he.readUInt16LE(t),s=he.readUInt16LE(t),i=0!==s;if(i&&s!==xs.CompressionMethodDeflate)return null;he.readInt16LE(this.an),he.readInt16LE(this.an),he.readInt32LE(t),he.readInt32LE(t);const n=he.readInt32LE(t),r=he.readInt16LE(t),a=he.readInt16LE(t),h=he.toString(he.readByteArray(t,r),"utf-8");let o;if(t.skip(a),i){const t=Ie.empty(),e=new _s(this.an),s=new Uint8Array(65536);for(;;){const i=e.readBytes(s,0,s.length);if(t.write(s,0,i),i<s.length)break}o=t.toArray()}else o=he.readByteArray(this.an,n);if(8&e){he.readInt32LE(this.an)===xs.OptionalDataDescriptorSignature&&he.readInt32LE(this.an),he.readInt32LE(this.an),he.readInt32LE(this.an)}return new xs(h,o)}}!function(t){t[t.None=0]="None",t[t.Element=1]="Element",t[t.Text=2]="Text",t[t.CDATA=3]="CDATA",t[t.Document=4]="Document",t[t.DocumentType=5]="DocumentType",t[t.Comment=6]="Comment"}(qe||(qe={}));class Ms{nodeType=qe.None;localName=null;value=null;childNodes=[];attributes=new Map;firstChild=null;firstElement=null;*childElements(){for(const t of this.childNodes)t.nodeType===qe.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,t.nodeType!==qe.Element&&t.nodeType!==qe.CDATA||(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this.cn(this.childNodes,s,t,e),s}cn(t,e,s,i=!1){for(const n of t)n&&n.nodeType===qe.Element&&n.localName===s&&e.push(n),i&&this.cn(n.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===qe.Element&&e.localName===t)return e;return null}addElement(t){const e=new Ms;return e.nodeType=qe.Element,e.localName=t,this.addChild(e),e}get innerText(){if(this.nodeType===qe.Element||this.nodeType===qe.Document){if(this.firstElement&&this.firstElement.nodeType===qe.CDATA)return this.firstElement.innerText;let t="";for(const e of this.childNodes)t+=e.innerText?.toString();return t.trim()}return this.value??""}set innerText(t){const e=new Ms;e.nodeType=qe.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new Ms;e.nodeType=qe.CDATA,e.value=t,this.childNodes=[e]}}class vs extends R{xml;pos=0;constructor(e,s,i){super(t.AlphaTabErrorType.Format,e),this.xml=s,this.pos=i}}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.BeginNode=2]="BeginNode",t[t.TagName=3]="TagName",t[t.Body=4]="Body",t[t.AttribName=5]="AttribName",t[t.Equals=6]="Equals",t[t.AttvalBegin=7]="AttvalBegin",t[t.AttribVal=8]="AttribVal",t[t.Childs=9]="Childs",t[t.Close=10]="Close",t[t.WaitEnd=11]="WaitEnd",t[t.WaitEndRet=12]="WaitEndRet",t[t.Pcdata=13]="Pcdata",t[t.Header=14]="Header",t[t.Comment=15]="Comment",t[t.Doctype=16]="Doctype",t[t.Cdata=17]="Cdata",t[t.Escape=18]="Escape"}(Ye||(Ye={}));class Ns{static CharCodeLF=10;static CharCodeTab=9;static CharCodeCR=13;static CharCodeSpace=32;static CharCodeLowerThan=60;static CharCodeAmp=38;static CharCodeBrackedClose=93;static CharCodeBrackedOpen=91;static CharCodeGreaterThan=62;static CharCodeExclamation=33;static CharCodeUpperD=68;static CharCodeLowerD=100;static CharCodeMinus=45;static CharCodeQuestion=63;static CharCodeSlash=47;static CharCodeEquals=61;static CharCodeDoubleQuote=34;static CharCodeSingleQuote=39;static CharCodeSharp=35;static CharCodeLowerX=120;static CharCodeLowerA=97;static CharCodeLowerZ=122;static CharCodeUpperA=65;static CharCodeUpperZ=90;static CharCode0=48;static CharCode9=57;static CharCodeColon=58;static CharCodeDot=46;static CharCodeUnderscore=95;static CharCodeSemi=59;static ln=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);static parse(t,e,s){let i=t.charCodeAt(e),n=Ye.Begin,r=Ye.Begin,a=0,h="",o=Ye.Begin,c=null,l=null,u=0,d=0;for(;e<t.length;){switch(i=t.charCodeAt(e),n){case Ye.IgnoreSpaces:switch(i){case Ns.CharCodeLF:case Ns.CharCodeCR:case Ns.CharCodeTab:case Ns.CharCodeSpace:break;default:n=r;continue}break;case Ye.Begin:if(i!==Ns.CharCodeLowerThan){a=e,n=Ye.Pcdata;continue}n=Ye.IgnoreSpaces,r=Ye.BeginNode;break;case Ye.Pcdata:if(i===Ns.CharCodeLowerThan){h+=t.substr(a,e-a);const i=new Ms;i.nodeType=qe.Text,i.value=h,h="",s.addChild(i),n=Ye.IgnoreSpaces,r=Ye.BeginNode}else i===Ns.CharCodeAmp&&(h+=t.substr(a,e-a),n=Ye.Escape,o=Ye.Pcdata,a=e+1);break;case Ye.Cdata:if(i===Ns.CharCodeBrackedClose&&t.charCodeAt(e+1)===Ns.CharCodeBrackedClose&&t.charCodeAt(e+2)===Ns.CharCodeGreaterThan){const i=new Ms;i.nodeType=qe.CDATA,i.value=t.substr(a,e-a),s.addChild(i),e+=2,n=Ye.Begin}break;case Ye.BeginNode:switch(i){case Ns.CharCodeExclamation:if(t.charCodeAt(e+1)===Ns.CharCodeBrackedOpen){if(e+=2,"CDATA["!==t.substr(e,6).toUpperCase())throw new vs("Expected <![CDATA[",t,e);e+=5,n=Ye.Cdata,a=e+1}else if(t.charCodeAt(e+1)===Ns.CharCodeUpperD||t.charCodeAt(e+1)===Ns.CharCodeLowerD){if("OCTYPE"!==t.substr(e+2,6).toUpperCase())throw new vs("Expected <!DOCTYPE",t,e);e+=8,n=Ye.Doctype,a=e+1}else{if(t.charCodeAt(e+1)!==Ns.CharCodeMinus||t.charCodeAt(e+2)!==Ns.CharCodeMinus)throw new vs("Expected \x3c!--",t,e);e+=2,n=Ye.Comment,a=e+1}break;case Ns.CharCodeQuestion:n=Ye.Header,a=e;break;case Ns.CharCodeSlash:if(!s)throw new vs("Expected node name",t,e);a=e+1,n=Ye.IgnoreSpaces,r=Ye.Close;break;default:n=Ye.TagName,a=e;continue}break;case Ye.TagName:if(!Ns.un(i)){if(e===a)throw new vs("Expected node name",t,e);c=new Ms,c.nodeType=qe.Element,c.localName=t.substr(a,e-a),s.addChild(c),n=Ye.IgnoreSpaces,r=Ye.Body;continue}break;case Ye.Body:switch(i){case Ns.CharCodeSlash:n=Ye.WaitEnd;break;case Ns.CharCodeGreaterThan:n=Ye.Childs;break;default:n=Ye.AttribName,a=e;continue}break;case Ye.AttribName:if(!Ns.un(i)){if(a===e)throw new vs("Expected attribute name",t,e);if(l=t.substr(a,e-a),c.attributes.has(l))throw new vs(`Duplicate attribute [${l}]`,t,e);n=Ye.IgnoreSpaces,r=Ye.Equals;continue}break;case Ye.Equals:if(i!==Ns.CharCodeEquals)throw new vs("Expected =",t,e);n=Ye.IgnoreSpaces,r=Ye.AttvalBegin;break;case Ye.AttvalBegin:switch(i){case Ns.CharCodeDoubleQuote:case Ns.CharCodeSingleQuote:h="",n=Ye.AttribVal,a=e+1,d=i}break;case Ye.AttribVal:if(i===Ns.CharCodeAmp)h+=t.substr(a,e-a),n=Ye.Escape,o=Ye.AttribVal,a=e+1;else if(i===d){h+=t.substr(a,e-a);const s=h;h="",c.attributes.set(l,s),n=Ye.IgnoreSpaces,r=Ye.Body}break;case Ye.Childs:a=e=Ns.parse(t,e,c),n=Ye.Begin;break;case Ye.WaitEnd:if(i!==Ns.CharCodeGreaterThan)throw new vs("Expected >",t,e);n=Ye.Begin;break;case Ye.WaitEndRet:if(i===Ns.CharCodeGreaterThan)return e;throw new vs("Expected >",t,e);case Ye.Close:if(!Ns.un(i)){if(a===e)throw new vs("Expected node name",t,e);if(t.substr(a,e-a)!==s.localName)throw new vs(`Expected </${s.localName}>`,t,e);n=Ye.IgnoreSpaces,r=Ye.WaitEndRet;continue}break;case Ye.Comment:i===Ns.CharCodeMinus&&t.charCodeAt(e+1)===Ns.CharCodeMinus&&t.charCodeAt(e+2)===Ns.CharCodeGreaterThan&&(e+=2,n=Ye.Begin);break;case Ye.Doctype:if(i===Ns.CharCodeBrackedOpen)u++;else if(i===Ns.CharCodeBrackedClose)u--;else if(i===Ns.CharCodeGreaterThan&&0===u){const i=new Ms;i.nodeType=qe.DocumentType,i.value=t.substr(a,e-a),s.addChild(i),n=Ye.Begin}break;case Ye.Header:i===Ns.CharCodeQuestion&&t.charCodeAt(e+1)===Ns.CharCodeGreaterThan&&(e++,n=Ye.Begin);break;case Ye.Escape:if(i===Ns.CharCodeSemi){const s=t.substr(a,e-a);if(s.charCodeAt(0)===Ns.CharCodeSharp){const t=s.charCodeAt(1)===Ns.CharCodeLowerX?Number.parseInt(`0${s.substr(1,s.length-1)}`,10):Number.parseInt(s.substr(1,s.length-1),10);h+=String.fromCharCode(t)}else Ns.ln.has(s)?h+=Ns.ln.get(s):h+=`&${s};`?.toString();a=e+1,n=o}else Ns.un(i)||i===Ns.CharCodeSharp||(h+="&",h+=t.substr(a,e-a),a=--e+1,n=o)}e++}if(n===Ye.Begin&&(a=e,n=Ye.Pcdata),n===Ye.Pcdata){if(e!==a){h+=t.substr(a,e-a);const i=new Ms;i.nodeType=qe.Text,i.value=h,s.addChild(i)}return e}if(n===Ye.Escape&&o===Ye.Pcdata){h+="&",h+=t.substr(a,e-a);const i=new Ms;return i.nodeType=qe.Text,i.value=h,s.addChild(i),e}throw new vs("Unexpected end",t,e)}static un(t){return t>=Ns.CharCodeLowerA&&t<=Ns.CharCodeLowerZ||t>=Ns.CharCodeUpperA&&t<=Ns.CharCodeUpperZ||t>=Ns.CharCode0&&t<=Ns.CharCode9||t===Ns.CharCodeColon||t===Ns.CharCodeDot||t===Ns.CharCodeUnderscore||t===Ns.CharCodeMinus}}class Ps{dn=[];pn;bn;mn;gn;constructor(t,e){this.pn=t,this.bn=e,this.gn="",this.mn=!0}writeNode(t){switch(t.nodeType){case qe.None:break;case qe.Element:this.dn.length>0&&this.wn(),this.yn(`<${t.localName}`);for(const[e,s]of t.attributes)this.yn(` ${e}="`),this.kn(s),this.yn('"');if(0===t.childNodes.length)this.yn("/>");else{if(this.yn(">"),1!==t.childNodes.length||t.firstElement){this.Sn();for(const e of t.childNodes)e.nodeType!==qe.Element&&e.nodeType!==qe.Comment||this.writeNode(e);this.Bn(),this.wn()}else this.writeNode(t.childNodes[0]);this.yn(`</${t.localName}>`)}break;case qe.Text:t.value&&this.yn(t.value);break;case qe.CDATA:null!==t.value&&this.yn(`<![CDATA[${t.value}]]>`);break;case qe.Document:this.bn&&this.yn('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case qe.DocumentType:this.yn(`<!DOCTYPE ${t.value}>`);break;case qe.Comment:this.yn(`\x3c!-- ${t.value} --\x3e`)}}Bn(){this.gn=this.gn.substr(0,this.gn.length-this.pn.length)}Sn(){this.gn+=this.pn}kn(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this.dn.push("&lt;");break;case">":this.dn.push("&gt;");break;case"&":this.dn.push("&amp;");break;case"'":this.dn.push("&apos;");break;case'"':this.dn.push("&quot;");break;default:this.dn.push(s)}}}static write(t,e,s){const i=new Ps(e,s);return i.writeNode(t),i.toString()}yn(t){this.mn&&this.dn.push(this.gn),this.dn.push(t),this.mn=!1}wn(t=null){t&&this.yn(t),this.pn.length>0&&!this.mn&&(this.dn.push("\n"),this.mn=!0)}toString(){return this.dn.join("").trimRight()}}class Es extends Ms{constructor(){super(),this.nodeType=qe.Document}parse(t){Ns.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return Ps.write(this,t,e)}}class Cs{noteRange=1;x=0;y=0}!function(t){t[t.None=0]="None",t[t.Rectangle=1]="Rectangle",t[t.Ellipse=2]="Ellipse",t[t.Circle=3]="Circle"}(Ke||(Ke={}));class Fs extends Cs{align=st.Left;frame=Ke.None;text="";fontFace="";weight=0;height=0}class As extends Cs{chord=new fe}class Ds extends Cs{}class Ls extends Cs{}class Ws extends Cs{number=0}class Rs extends Cs{decrescendo=!1}class Os extends Cs{allNumbers=!1;firstNumber=0;lastNumber=0}class Is extends Cs{octave=1}class Gs extends Cs{}class $s{defaultClef=P.G2;description="";percussion=!1;instrument=0;volume=0;transpose=0;index=0}class Vs{from=0;to=0;curly=!1}class Hs{currentBarIndex=-1;currentBarComplete=!0;currentBarDuration=0;currentPosition=0;voiceStemDir=null;repeatCount=0;repeatEnd=null}class Us{score;_n=0;xn=wt.Auto;Tn;Mn;vn=!0;Nn=-1;parseXml(t,e){this.Tn=new Map,this.Pn=[],this.En=new Map,this.Mn=new Map,this.Cn=new Map,this.Fn=new Map,this.vn=!0;const s=new Es;try{s.parse(t)}catch(t){throw new Oe("Could not parse XML",t)}this.An(s),this.Dn(),this.score.finish(e)}Dn(){Ht.consolidate(this.score),Us.Ln(this.Cn,(t,e)=>{e.isLegatoOrigin=!0}),Us.Ln(this.Fn,(t,e)=>{e.crescendo=t.decrescendo?c.Decrescendo:c.Crescendo})}static Ln(t,e){for(const[s,i]of t){const t=i.noteRange;let n=s;for(let s=0;s<t;s++)if(e(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else{if(!(n.voice.bar.index+1<n.voice.bar.staff.bars.length))break;n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0]}}}An(t){const e=t.firstElement;if(!e)throw new Oe("No valid XML");if("score"!==e.localName)throw new Oe('Root node of XML was not "score"');this.score=new Ot;for(const t of e.childElements())switch(t.localName){case"info":this.Wn(t);break;case"layout":this.Rn(t);break;case"gallery":this.On(t);break;case"pageObjects":this.In(t);break;case"systems":this.Gn(t)}}$n=new Map;Rn(t){for(const e of t.childElements())switch(e.localName){case"staves":this.Vn(e);break;case"brackets":this.Hn(e)}const e=this.Un.filter(t=>!!t.curly);e.sort((t,e)=>t.from-e.from);let s=0,i=null;for(let t=0;t<this.zn.length;t++){const n=this.zn[t];for(;s<e.length&&t>e[s].to;)s++;i&&s<e.length&&t>e[s].from&&t<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new _e,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._n++,i.playbackInfo.secondaryChannel=this._n++),this.score.addTrack(i));const r=i.staves[i.staves.length-1];r.isPercussion=n.percussion,r.transpositionPitch=n.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this.$n.set(n.index,r)}}Un=[];Hn(t){for(const e of t.childElements())if("bracket"===e.localName)this.jn(e)}jn(t){const e=new Vs;e.from=Number.parseInt(t.getAttribute("from"),10),e.to=Number.parseInt(t.getAttribute("to"),10),t.attributes.has("curly")&&(e.curly="true"===t.attributes.get("curly")),this.Un.push(e)}Vn(t){for(const e of t.childElements())if("staffLayout"===e.localName)this.Xn(e)}Jn=new Map;zn=[];Xn(t){const e=new $s;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this.qn(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this.Jn.set(e.description,e),e.index=this.zn.length,this.zn.push(e)}qn(t){switch(t){case"treble":return P.G2;case"bass":return P.F4;case"alto":case"tenor":return P.C4}return P.G2}Yn(t){return t.endsWith("-")?m.T:t.endsWith("+")?m._:m.Regular}Gn(t){for(const e of t.childElements())if("system"===e.localName)this.Kn(e)}Kn(t){t.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.Nn=Number.parseInt(t.attributes.get("tempo"),10)),"0"===t.getAttribute("beamGrouping")&&(this.xn=wt.ForceSplitToNext);for(const e of t.childElements())if("staves"===e.localName)this.Qn(t,e);this.vn=!1}Qn(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())if("staff"===i.localName)this.Zn(t,s,i)}tr=new It;er;Zn(t,e,s){const i=s.getAttribute("layout");this.er=this.Jn.get(i),this.tr.timeSignatureNumerator=4,this.tr.timeSignatureDenominator=4,this.tr.timeSignatureCommon=!1,this.sr(s.getAttribute("defaultTime"));const n=this.$n.get(this.er.index);for(;n.bars.length<e;)this.ir(n);for(const r of s.childElements())if("voices"===r.localName)this.nr(i,n,t,e,r)}sr(t){switch(t){case"allaBreve":case"C":this.tr.timeSignatureNumerator=2,this.tr.timeSignatureDenominator=2,this.tr.timeSignatureCommon=!0;break;case"longAllaBreve":this.tr.timeSignatureNumerator=4,this.tr.timeSignatureDenominator=4,this.tr.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this.tr.timeSignatureNumerator=Number.parseInt(e[0],10),this.tr.timeSignatureDenominator=Number.parseInt(e[1],10),this.tr.timeSignatureCommon=!1}}}nr(t,e,s,i,n){let r=0;for(const a of n.childElements())if("voice"===a.localName)this.rr(t,e,s,r,i,a),r++}ar(t,e){return e<t.bars.length?t.bars[e]:this.ir(t)}ir(t){const e=new Q;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this.er.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const t=new It;this.score.addMasterBar(t),t.index>0?t.tripletFeel=t.previousMasterBar.tripletFeel:this.Nn>0&&t.tempoAutomations.push($.buildTempoAutomation(!1,0,this.Nn,0)),t.timeSignatureDenominator=this.tr.timeSignatureDenominator,t.timeSignatureNumerator=this.tr.timeSignatureNumerator,t.timeSignatureCommon=this.tr.timeSignatureCommon}return e}hr=new Map;cr;lr;ur;pi(t,e){this.cr.currentBarIndex++,this.lr=this.ar(t,this.cr.currentBarIndex),this.cr.currentBarDuration=this.lr.masterBar.calculateDuration(!1),this.cr.currentBarComplete=!1,this.cr.currentPosition=0,this.dr(t,e)}rr(t,e,s,i,n,a){const h=`${t}_${i}`;if(this.cr&&!this.cr.currentBarComplete&&(this.lr.masterBar.isAnacrusis=!0),this.hr.has(h)?(this.cr=this.hr.get(h),this.lr=this.ar(e,this.cr.currentBarIndex),this.dr(e,i)):(this.cr=new Hs,this.cr.currentBarIndex=n-1,this.hr.set(h,this.cr),this.pi(e,i)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this.cr.voiceStemDir=At.Up;break;case"down":this.cr.voiceStemDir=At.Down;break;default:this.cr.voiceStemDir=null}else this.cr.voiceStemDir=null;const o=a.findChildElement("noteObjects");if(s.attributes.has("tempo")){const t=new $;t.isLinear=!0,t.type=r.Tempo,t.value=Number.parseInt(s.attributes.get("tempo"),10),t.ratioPosition=this.cr.currentPosition/this.cr.currentBarDuration,this.lr.masterBar.tempoAutomations.push(t)}if(o)for(const t of o.childElements())switch(this.cr.currentBarComplete&&"barline"!==t.localName&&this.pi(e,i),t.localName){case"clefSign":this.lr.clef=this.qn(t.getAttribute("clef")),this.lr.clefOttava=this.Yn(t.getAttribute("clef"));break;case"keySign":this.lr.keySignature=Number.parseInt(t.getAttribute("fifths"),10);break;case"timeSign":this.sr(t.getAttribute("time")),this.lr.masterBar.timeSignatureDenominator=this.tr.timeSignatureDenominator,this.lr.masterBar.timeSignatureNumerator=this.tr.timeSignatureNumerator,this.lr.masterBar.timeSignatureCommon=this.tr.timeSignatureCommon,this.cr.currentPosition=0,this.cr.currentBarDuration=this.lr.masterBar.calculateDuration(!1);break;case"barline":switch(t.getAttribute("type")){case"double":this.lr.barLineRight=L.LightLight,this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0;break;case"end":this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0);break;case"repEnd":this.cr.repeatEnd=this.lr.masterBar,this.lr.masterBar.repeatCount<this.cr.repeatCount&&(this.lr.masterBar.repeatCount=this.cr.repeatCount),this.pr(t),this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0;break;case"repBegin":this.pi(e,i),this.lr.masterBar.isRepeatStart=!0,this.cr.repeatEnd=null,this.cr.repeatCount=0;break;case"repEndBegin":this.cr.repeatEnd=this.lr.masterBar,this.lr.masterBar.repeatCount<this.cr.repeatCount&&(this.lr.masterBar.repeatCount=this.cr.repeatCount),this.pr(t),this.pi(e,i),this.lr.masterBar.isRepeatStart=!0;break;default:this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0}break;case"chord":const s=new Kt;this.br(s,this.ur),s.beamingMode=this.xn,this.cr.voiceStemDir&&(s.preferredBeamDirection=this.cr.voiceStemDir),this.mi(s,t.findChildElement("duration")),s.updateDurations(),this.cr.currentPosition+=s.playbackDuration,this.ur.addBeat(s),this.mr(s,t),this.cr.currentPosition>=this.cr.currentBarDuration&&(this.cr.currentBarComplete=!0);break;case"rest":const n=this.gr(t.findChildElement("duration"));n&&(this.br(n,this.ur),n.updateDurations(),this.cr.currentPosition+=n.playbackDuration,this.ur.addBeat(n),this.cr.currentPosition>=this.cr.currentBarDuration&&(this.cr.currentBarComplete=!0))}}br(t,e){const s=this.wr(e);s&&(t.dynamics=s.dynamics)}wr(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length){const s=e.voices[t.index];return this.wr(s)}}return null}dr(t,e){for(;this.lr.voices.length<e+1;)this.lr.addVoice(new et);(!this.Mn.has(t.track.index)||this.Mn.get(t.track.index)<this.lr.voices.length)&&this.Mn.set(t.track.index,this.lr.voices.length),this.ur=this.lr.voices[e]}mr(t,e){const s=new Jt;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=At.Up;break;case"down":t.preferredBeamDirection=At.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=d.Normal;break;case"strongAccent":s.accentuated=d.Heavy}break;case"lyric":this.yr(t,i);break;case"drawObjects":this.kr(t,i);break;case"heads":this.Sr(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=wt.ForceMergeWithNext;break;case"divide":t.beamingMode=wt.ForceSplitToNext}}}Sr(t,e,s){for(const i of s.childElements())if("head"===i.localName)this.Br(t,e,i)}Pn;En;Cn;Fn;Br(t,e,s){const i=new Jt,n=Ht.parseTuning(s.getAttribute("pitch"));i.octave=n.octave-1,i.tone=n.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const t of s.childElements())switch(t.localName){case"alter":t.attributes.has("step")&&(i.tone+=Number.parseInt(t.attributes.get("step"),10));break;case"tie":t.attributes.has("begin")?this.En.has(i.id)||(this.En.set(i.id,!0),this.Pn.push(i)):t.attributes.has("end")&&this.Pn.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this.Pn[0],this.Pn.splice(0,1),this.En.delete(i.id))}}kr(t,e){for(const s of e.childElements())if("drawObj"===s.localName){const e=this._r(s);if(e)if(e instanceof Fs)e.fontFace.startsWith("capella")?"u"===e.text?(t.fermata=new me,t.fermata.type=Pt.Medium):"f"===e.text?t.dynamics=n.F:"j"===e.text&&(t.dynamics=n.MF):this.vn&&""===this.score.title&&e.align===st.Center&&e.height>16&&e.weight>400?this.score.title=e.text:this.vn&&""===this.score.artist&&e.align===st.Center&&e.y<0?this.score.artist=e.text:this.vn&&""===this.score.music&&e.align===st.Right&&e.y<0?this.score.music=e.text:e.text.startsWith("by capella")||(t.text=e.text);else if(e instanceof As);else if(e instanceof Ls)t.vibrato=y.Slight;else if(e instanceof Rs)t.crescendo=e.decrescendo?c.Decrescendo:c.Crescendo,e.noteRange++,this.Fn.set(t,e);else if(e instanceof Ds){const s=e;this.Cn.set(t,s)}else e instanceof Os&&this.Tr(e)}}pr(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);t&&t instanceof Os&&this.Tr(t)}}Tr(t){if(t.lastNumber>0?(this.cr.repeatCount=t.lastNumber,this.cr.repeatEnd&&this.cr.repeatEnd.repeatCount<this.cr.repeatCount&&(this.cr.repeatEnd.repeatCount=this.cr.repeatCount)):t.firstNumber>0&&(this.cr.repeatCount=t.firstNumber,this.cr.repeatEnd&&this.cr.repeatEnd.repeatCount<this.cr.repeatCount&&(this.cr.repeatEnd.repeatCount=this.cr.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e|=1<<s-1;this.lr.masterBar.alternateEndings=e}else t.lastNumber>0?this.lr.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this.lr.masterBar.alternateEndings=1<<t.firstNumber-1)}yr(t,e){for(const s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let e=s.innerText;"true"===s.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}gr(t){const e=t.getAttribute("base");if(-1!==e.indexOf("/")){const e=new Kt;return e.beamingMode=this.xn,this.mi(e,t),e}if(1===Number.parseInt(e,10)){const t=new Kt;return t.beamingMode=this.xn,t.duration=l.Whole,t}return j.warning("Importer","Multi-Bar rests are not supported"),null}Mr(t){switch(t){case"2/1":return l.DoubleWhole;case"1/1":return l.Whole;case"1/2":return l.Half;case"1/4":return l.Quarter;case"1/8":return l.Eighth;case"1/16":return l.Sixteenth;case"1/32":return l.ThirtySecond;case"1/64":return l.SixtyFourth;case"1/128":return l.OneHundredTwentyEighth;default:return j.warning("Importer","Unsupported duration"),l.Quarter}}mi(t,e){const s=e.getAttribute("base");t.duration=this.Mr(s),e.attributes.has("dots")&&(t.dots=Number.parseInt(e.attributes.get("dots"),10));const i=e.findChildElement("tuplet");if(i){t.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const e="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1;let n=0;for(;e*Math.pow(2,n+s)<t.tupletNumerator;)n++;t.tupletDenominator=e*Math.pow(2,n)}}In(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);if(t&&t instanceof Fs)switch(t.align){case st.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case st.Right:this.score.artist||(this.score.artist=e.innerText)}}}On(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);t&&this.Tn.set(e.getAttribute("name"),t)}}_r(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this.vr(i);break;case"guitar":e=this.Nr(i);break;case"slur":e=this.Pr(i);break;case"wavyLine":e=this.Er(i);break;case"bracket":e=this.Cr(i);break;case"wedge":e=this.Fr(i);break;case"volta":e=this.Ar(i);break;case"octaveClef":e=this.Dr(i);break;case"trill":e=this.Lr(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return e&&(e.noteRange=s),e}Lr(t){return new Gs}Dr(t){const e=new Is;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"),10)),e}Ar(t){const e=new Os;return e.allNumbers="true"===t.attributes.get("allNumbers"),t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"),10)),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"),10)),e}Fr(t){const e=new Rs;return e.decrescendo="true"===t.attributes.get("decrescendo"),e}Cr(t){const e=new Ws;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"),10)),e}Er(t){return new Ls}Pr(t){return new Ds}Nr(t){const e=new As,s=t.innerText.trim();for(let t=0;t<s.length;t++)"/"===s.charAt(t)?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(t),10));return e}vr(t){const e=new Fs;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=st.Left;break;case"center":e.align=st.Center;break;case"right":e.align=st.Right}switch(t.getAttribute("frame")){case"rectangle":e.frame=Ke.Rectangle;break;case"ellipse":e.frame=Ke.Ellipse;break;case"circle":e.frame=Ke.Circle;break;case"none":e.frame=Ke.None}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":e.text=s.innerText}else e.text=t.innerText;return e}Wn(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText}}}class zs extends Re{get name(){return"Capella"}readScore(){j.debug(this.name,"Loading ZIP entries");let t,e=null;if(t=new Ts(this.data).read(),j.debug(this.name,"Zip entries loaded"),t.length>0){for(const s of t)if("score.xml"===s.fileName)e=he.toString(s.data,this.settings.importer.encoding)}else this.data.reset(),e=he.toString(this.data.readAll(),this.settings.importer.encoding);if(!e)throw new Oe("No valid capella file");j.debug(this.name,"Start Parsing score.xml");try{const t=new Us;t.parseXml(e,this.settings),j.debug(this.name,"score.xml parsed");return t.score}catch(t){throw new Oe("Failed to parse CapXML",t)}}}!function(t){t[t.TargetFine=0]="TargetFine",t[t.TargetSegno=1]="TargetSegno",t[t.TargetSegnoSegno=2]="TargetSegnoSegno",t[t.TargetCoda=3]="TargetCoda",t[t.TargetDoubleCoda=4]="TargetDoubleCoda",t[t.JumpDaCapo=5]="JumpDaCapo",t[t.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",t[t.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",t[t.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",t[t.JumpDalSegno=9]="JumpDalSegno",t[t.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",t[t.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",t[t.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",t[t.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",t[t.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",t[t.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",t[t.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",t[t.JumpDaCoda=17]="JumpDaCoda",t[t.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"}(Qe||(Qe={}));class js extends Re{static Wr="FICHIER GUITAR PRO ";Rr=0;ue;Or=rt.NoTripletFeel;Ir=0;Gr=[];$r=0;Vr=0;Hr=[];Ur=new Set;zr=new Map;jr=new Map;Xr=new Map;Jr=new Map;Nn;get name(){return"Guitar Pro 3-5"}readScore(){if(this.Jr.clear(),this.readVersion(),this.ue=new Ot,this.readScoreInformation(),this.Rr<500&&(this.Or=Xs.gpReadBool(this.data)?rt.Triplet8th:rt.NoTripletFeel),this.Rr>=400&&this.readLyrics(),this.Rr>=510&&this.data.skip(19),this.Nn=$.buildTempoAutomation(!1,0,0,0),this.Rr>=500&&(this.readPageSetup(),this.Nn.text=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this.Nn.value=he.readInt32LE(this.data),this.Rr>=510&&Xs.gpReadBool(this.data),he.readInt32LE(this.data),this.Rr>=400&&this.data.readByte(),this.readPlaybackInfos(),this.Rr>=500&&(this.qr(Qe.TargetCoda),this.qr(Qe.TargetDoubleCoda),this.qr(Qe.TargetSegno),this.qr(Qe.TargetSegnoSegno),this.qr(Qe.TargetFine),this.qr(Qe.JumpDaCapo),this.qr(Qe.JumpDaCapoAlCoda),this.qr(Qe.JumpDaCapoAlDoubleCoda),this.qr(Qe.JumpDaCapoAlFine),this.qr(Qe.JumpDalSegno),this.qr(Qe.JumpDalSegnoAlCoda),this.qr(Qe.JumpDalSegnoAlDoubleCoda),this.qr(Qe.JumpDalSegnoAlFine),this.qr(Qe.JumpDalSegnoSegno),this.qr(Qe.JumpDalSegnoSegnoAlCoda),this.qr(Qe.JumpDalSegnoSegnoAlDoubleCoda),this.qr(Qe.JumpDalSegnoSegnoAlFine),this.qr(Qe.JumpDaCoda),this.qr(Qe.JumpDaDoubleCoda),this.data.skip(4)),this.$r=he.readInt32LE(this.data),this.Vr=he.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this.ue.masterBars.length>0){const t=$.buildTempoAutomation(!1,0,this.ue.tempo,2);t.text=this.ue.tempoLabel,this.ue.masterBars[0].tempoAutomations.push(t)}return Ht.consolidate(this.ue),this.ue.finish(this.settings),this.Gr&&this.Ir>=0&&this.ue.tracks[this.Ir].applyLyrics(this.Gr),this.ue}qr(t){let e,s=he.readInt16LE(this.data);-1!==s&&(s--,this.Jr.has(s)?e=this.Jr.get(s):(e=[],this.Jr.set(s,e)),e.push(t))}readVersion(){let t=Xs.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!t.startsWith(js.Wr))throw new Oe("Unsupported format");t=t.substr(js.Wr.length+1);const e=t.indexOf(String.fromCharCode(46));this.Rr=100*Number.parseInt(t.substr(0,e),10)+Number.parseInt(t.substr(e+1),10),j.debug(this.name,`Guitar Pro version ${t} detected`)}readScoreInformation(){this.ue.title=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.subTitle=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.artist=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.album=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.words=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.music=this.Rr>=500?Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this.ue.words,this.ue.copyright=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.tab=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.instructions=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const t=he.readInt32LE(this.data);let e="";for(let s=0;s<t;s++)s>0&&(e+="\r\n"),e+=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this.ue.notices=e}readLyrics(){this.Gr=[],this.Ir=he.readInt32LE(this.data)-1;for(let t=0;t<5;t++){const t=new ge;t.startBar=he.readInt32LE(this.data)-1,t.text=Xs.gpReadStringInt(this.data,this.settings.importer.encoding),this.Gr.push(t)}}readPageSetup(){this.data.skip(28);const t=he.readInt16LE(this.data);Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Title).isVisible=!!(1&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Title).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.SubTitle).isVisible=!!(2&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.SubTitle).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Artist).isVisible=!!(4&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Artist).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Album).isVisible=!!(8&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Album).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Words).isVisible=!!(16&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Words).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Music).isVisible=!!(32&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Music).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.WordsAndMusic).isVisible=!!(64&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.WordsAndMusic).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Copyright).isVisible=!!(128&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.Copyright).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.CopyrightSecondLine).isVisible=!!(128&t),Ht.getOrCreateHeaderFooterStyle(this.ue,nt.CopyrightSecondLine).template=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this.Hr=[];let t=0;for(let e=0;e<64;e++){const e=new Se;e.primaryChannel=t++,e.secondaryChannel=t++,e.program=he.readInt32LE(this.data),e.volume=this.data.readByte(),e.balance=this.data.readByte(),this.data.skip(6),this.Hr.push(e)}}readMasterBars(){for(let t=0;t<this.$r;t++)this.readMasterBar()}readMasterBar(){let t=null;this.ue.masterBars.length>0&&(t=this.ue.masterBars[this.ue.masterBars.length-1]);const e=new It;!t&&this.Nn.value>0&&e.tempoAutomations.push(this.Nn);const s=this.data.readByte();if(1&s?e.timeSignatureNumerator=this.data.readByte():t&&(e.timeSignatureNumerator=t.timeSignatureNumerator),2&s?e.timeSignatureDenominator=this.data.readByte():t&&(e.timeSignatureDenominator=t.timeSignatureDenominator),e.isRepeatStart=!!(4&s),8&s&&(e.repeatCount=this.data.readByte()+(this.Rr>=500?0:1)),16&s&&this.Rr<500){let s=t,i=0;for(;s&&(!s.isRepeatEnd||s===t)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let n=0;const r=this.data.readByte();for(let t=0;t<8;t++){const e=1<<t;r>t&&0===(i&e)&&(n|=e)}e.alternateEndings=n}if(32&s){const t=new we;t.text=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.marker="",Xs.gpReadColor(this.data,!1),e.section=t}if(64&s&&this.jr.set(this.ue.masterBars.length,[he.readSInt8(this.data),this.data.readByte()]),this.Rr>=500&&3&s&&this.data.skip(4),this.Rr>=500&&(e.alternateEndings=this.data.readByte()),this.Rr>=500){switch(this.data.readByte()){case 1:e.tripletFeel=rt.Triplet8th;break;case 2:e.tripletFeel=rt.Triplet16th}this.data.readByte()}else e.tripletFeel=this.Or;const i=!!(128&s);e.isDoubleBar=i;const n=this.ue.masterBars.length;if(this.Jr.has(n))for(const t of this.Jr.get(n))e.addDirection(t);this.ue.addMasterBar(e),i&&this.Ur.add(e.index)}readTracks(){for(let t=0;t<this.Vr;t++)this.readTrack()}readTrack(){const t=new _e;t.ensureStaveCount(1),this.ue.addTrack(t);const e=t.staves[0],s=this.data.readByte();t.name=Xs.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),1&s&&(e.isPercussion=!0),this.Rr>=500&&(t.isVisibleOnMultiTrack=!!(8&s)),null===this.ue.stylesheet.perTrackDisplayTuning&&(this.ue.stylesheet.perTrackDisplayTuning=new Map),this.ue.stylesheet.perTrackDisplayTuning.set(t.index,!!(128&s));const i=he.readInt32LE(this.data),n=[];for(let t=0;t<7;t++){const e=he.readInt32LE(this.data);i>t&&n.push(e)}e.stringTuning.tunings=n;const r=he.readInt32LE(this.data),a=he.readInt32LE(this.data)-1,h=he.readInt32LE(this.data)-1;if(this.data.skip(4),a>=0&&a<this.Hr.length){const i=this.Hr[a];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=h,de.isGuitar(i.program)&&(e.displayTranspositionPitch=-12),t.playbackInfo=i}if(e.capo=he.readInt32LE(this.data),t.color=Xs.gpReadColor(this.data,!1),this.Rr>=500){const s=this.data.readByte();e.showTablature=!!(1&s),e.showStandardNotation=!!(2&s);const i=!!(100&s);null===this.ue.stylesheet.perTrackChordDiagramsOnTop&&(this.ue.stylesheet.perTrackChordDiagramsOnTop=new Map),this.ue.stylesheet.perTrackChordDiagramsOnTop.set(t.index,i),this.data.readByte(),this.data.readByte(),t.playbackInfo.bank=this.data.readByte(),this.data.readByte();12===he.readInt32LE(this.data)?this.zr.set(a,P.F4):this.zr.set(a,P.G2),he.readInt32LE(this.data),he.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this.Yr(),this.Rr>=510&&(this.data.skip(4),Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else de.isBass(t.playbackInfo.program)?this.zr.set(a,P.F4):this.zr.set(a,P.G2)}readBars(){for(let t=0;t<this.$r;t++)for(let t=0;t<this.Vr;t++)this.readBar(this.ue.tracks[t])}readBar(t){const e=new Q,s=t.staves[0];if(s.isPercussion?e.clef=P.Neutral:this.zr.has(t.index)&&(e.clef=this.zr.get(t.index)),s.addBar(e),this.jr.has(e.index)){const t=this.jr.get(e.index);e.keySignature=t[0],e.keySignatureType=t[1]}else e.index>0&&(e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);this.Ur.has(e.index)&&(e.barLineRight=L.LightLight);let i=1;this.Rr>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(t,e)}readVoice(t,e){const s=he.readInt32LE(this.data);if(0===s)return;const i=new et;e.addVoice(i);for(let n=0;n<s;n++)this.readBeat(t,e,i)}readBeat(t,e,s){const i=new Kt,n=this.data.readByte();if(1&n&&(i.dots=1),64&n){const t=this.data.readByte();i.isEmpty=!(2&t)}s.addBeat(i);switch(he.readSInt8(this.data)){case-2:i.duration=l.Whole;break;case-1:i.duration=l.Half;break;case 0:i.duration=l.Quarter;break;case 1:i.duration=l.Eighth;break;case 2:i.duration=l.Sixteenth;break;case 3:i.duration=l.ThirtySecond;break;case 4:i.duration=l.SixtyFourth;break;default:i.duration=l.Quarter}if(32&n)switch(i.tupletNumerator=he.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&n&&this.readChord(i);const r=this.settings.importer.beatTextAsLyrics&&t.index!==this.Ir;if(4&n){const e=Xs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){const s=new ge;s.text=e.trim(),s.finish(!0);const i=[];for(let t=s.chunks.length-1;t>=0;t--)i.push(s.chunks[t]);this.Xr.set(t.index,i)}else i.text=e}let a=p.None;8&n&&(a=this.readBeatEffects(i)),16&n&&this.readMixTableChange(i);const h=this.data.readByte();for(let n=6;n>=0;n--)if(h&1<<n&&6-n<e.staff.tuning.length){const r=this.readNote(t,e,s,i,6-n);a!==p.None&&(r.harmonicType=a,r.harmonicType===p.Natural&&(r.harmonicValue=Ht.deltaFretToHarmonicValue(r.fret)))}if(this.Rr>=500){const t=he.readInt16LE(this.data);if(1&t&&i.index>0&&(s.beats[i.index-1].beamingMode=wt.ForceSplitToNext),2&t&&(i.preferredBeamDirection=At.Down),4&t&&i.index>0&&(s.beats[i.index-1].beamingMode=wt.ForceMergeWithNext),8&t&&(i.preferredBeamDirection=At.Up),16&t&&(i.ottava=m._),32&t&&(i.ottava=m.T),64&t&&(i.ottava=m.S),256&t&&(i.ottava=m.M),2048&t){const t=0!==this.data.readByte();i.index>0&&t&&(s.beats[i.index-1].beamingMode=wt.ForceSplitOnSecondaryToNext)}}r&&!i.isRest&&this.Xr.has(t.index)&&this.Xr.get(t.index).length>0&&(i.lyrics=[this.Xr.get(t.index).pop()])}readChord(t){const e=new fe,s=Ht.newGuid();if(this.Rr>=500){this.data.skip(17),e.name=Xs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=he.readInt32LE(this.data);for(let s=0;s<7;s++){const i=he.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else if(0!==this.data.readByte())if(this.Rr>=400){this.data.skip(16),e.name=Xs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=he.readInt32LE(this.data);for(let s=0;s<7;s++){const i=he.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else{this.data.skip(25),e.name=Xs.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),e.firstFret=he.readInt32LE(this.data);for(let s=0;s<6;s++){const i=he.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}this.data.skip(36)}else{const s=this.Rr>=406?7:6;if(e.name=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.firstFret=he.readInt32LE(this.data),e.firstFret>0)for(let i=0;i<s;i++){const s=he.readInt32LE(this.data);i<t.voice.bar.staff.tuning.length&&e.strings.push(s)}}e.name&&(t.chordId=s,t.voice.bar.staff.addChord(t.chordId,e))}readBeatEffects(t){const e=this.data.readByte();let s=0;if(this.Rr>=400&&(s=this.data.readByte()),16&e&&(t.fade=pt.FadeIn),(this.Rr<400&&1&e||2&e)&&(t.vibrato=y.Slight),1&s&&(t.rasgueado=gt.Ii),32&e&&this.Rr>=400){switch(he.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}}else if(32&e){switch(he.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}this.data.skip(4)}if(4&s&&this.readTremoloBarEffect(t),64&e){let e=0,s=0;this.Rr<500?(s=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),s=this.data.readByte()),e>0?(t.brushType=o.BrushUp,t.brushDuration=js.Kr(e)):s>0&&(t.brushType=o.BrushDown,t.brushDuration=js.Kr(s))}if(2&s)switch(he.readSInt8(this.data)){case 0:t.pickStroke=ot.None;break;case 1:t.pickStroke=ot.Up;break;case 2:t.pickStroke=ot.Down}if(this.Rr<400){if(4&e)return p.Natural;if(8&e)return p.Artificial}return p.None}readTremoloBarEffect(t){this.data.readByte(),he.readInt32LE(this.data);const e=he.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new V(0,0);e.offset=he.readInt32LE(this.data),e.value=he.readInt32LE(this.data)/js.Qr|0,Xs.gpReadBool(this.data),t.addWhammyBarPoint(e)}}static Kr(t){switch(t){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}Yr(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(t){const e=new Js;e.instrument=he.readSInt8(this.data),this.Rr>=500&&this.Yr(),e.volume=he.readSInt8(this.data),e.balance=he.readSInt8(this.data);const s=he.readSInt8(this.data),i=he.readSInt8(this.data),n=he.readSInt8(this.data),a=he.readSInt8(this.data);if(this.Rr>=500&&(e.tempoName=Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.tempo=he.readInt32LE(this.data),e.volume>=0&&this.data.readByte(),e.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),n>=0&&this.data.readByte(),a>=0&&this.data.readByte(),e.tempo>=0&&(e.duration=he.readSInt8(this.data),this.Rr>=510&&this.data.readByte()),this.Rr>=400&&this.data.readByte(),this.Rr>=500){const e=he.readSInt8(this.data);e>=100?t.wahPedal=bt.Closed:e>=0&&(t.wahPedal=bt.Open)}if(this.Rr>=510&&(Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.volume>=0){const s=new $;s.isLinear=!0,s.type=r.Volume,s.value=e.volume,t.automations.push(s)}if(e.balance>=0){const s=new $;s.isLinear=!0,s.type=r.Balance,s.value=e.balance,t.automations.push(s)}if(e.instrument>=0){const s=new $;s.isLinear=!0,s.type=r.Instrument,s.value=e.instrument,t.automations.push(s)}if(e.tempo>=0){const s=new $;s.isLinear=!0,s.type=r.Tempo,s.value=e.tempo,t.automations.push(s),t.voice.bar.masterBar.tempoAutomations.some(t=>t.ratioPosition===s.ratioPosition&&t.value===s.value)||t.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(t,e,s,i,n){const r=new Jt;r.string=e.staff.tuning.length-n;const a=this.data.readByte();if(2&a?r.accentuated=d.Heavy:64&a&&(r.accentuated=d.Normal),r.isGhost=!!(4&a),32&a){const t=this.data.readByte();3===t?r.isDead=!0:2===t&&(r.isTieDestination=!0)}if(1&a&&this.Rr<500&&(this.data.readByte(),this.data.readByte()),16&a){const t=he.readSInt8(this.data);r.dynamics=this.toDynamicValue(t),i.dynamics=r.dynamics}32&a&&(r.fret=he.readSInt8(this.data)),128&a&&(r.leftHandFinger=he.readSInt8(this.data),r.rightHandFinger=he.readSInt8(this.data));let h=!1;if(this.Rr>=500){1&a&&(r.durationPercent=he.readFloat64BE(this.data));h=!!(2&this.data.readByte())}if(i.addNote(r),8&a&&this.readNoteEffects(t,s,i,r),e.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),h){const t=Ht.computeAccidental(e.keySignature,b.Default,r.realValueWithoutHarmonic,!1);t===ht.Sharp?r.accidentalMode=b.ForceFlat:t===ht.Flat&&(r.accidentalMode=b.ForceSharp)}return r}toDynamicValue(t){switch(t){case 1:return n.PPP;case 2:return n.PP;case 3:return n.P;case 4:return n.MP;case 5:return n.MF;case 6:default:return n.F;case 7:return n.FF;case 8:return n.FFF}}readNoteEffects(t,e,s,i){const n=this.data.readByte();let r=0;this.Rr>=400&&(r=this.data.readByte()),1&n&&this.readBend(i),16&n&&this.readGrace(e,i),4&r&&this.readTremoloPicking(s),8&r?this.readSlide(i):this.Rr<400&&4&n&&(i.slideOutType=w.Shift),16&r&&this.readArtificialHarmonic(i),32&r&&this.readTrill(i),i.isLetRing=!!(8&n),i.isHammerPullOrigin=!!(2&n),64&r&&(i.vibrato=y.Slight),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}static Qr=25;readBend(t){this.data.readByte(),he.readInt32LE(this.data);const e=he.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new V(0,0);e.offset=he.readInt32LE(this.data),e.value=he.readInt32LE(this.data)/js.Qr|0,Xs.gpReadBool(this.data),t.addBendPoint(e)}}readGrace(t,e){const s=new Kt,i=new Jt;i.string=e.string,i.fret=he.readSInt8(this.data),s.duration=l.ThirtySecond,s.dynamics=this.toDynamicValue(he.readSInt8(this.data));switch(he.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=w.Legato,i.slideTarget=e;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this.Rr<500)s.graceType=u.BeforeBeat;else{const t=this.data.readByte();i.isDead=!!(1&t),s.graceType=2&t?u.OnBeat:u.BeforeBeat}t.addGraceBeat(s),s.addNote(i)}readTremoloPicking(t){switch(this.data.readByte()){case 1:t.tremoloSpeed=l.Eighth;break;case 2:t.tremoloSpeed=l.Sixteenth;break;case 3:t.tremoloSpeed=l.ThirtySecond}}readSlide(t){if(this.Rr>=500){const e=he.readSInt8(this.data);1&e?t.slideOutType=w.Shift:2&e?t.slideOutType=w.Legato:4&e?t.slideOutType=w.OutDown:8&e&&(t.slideOutType=w.OutUp),16&e?t.slideInType=g.IntoFromBelow:32&e&&(t.slideInType=g.IntoFromAbove)}else{switch(he.readSInt8(this.data)){case 1:t.slideOutType=w.Shift;break;case 2:t.slideOutType=w.Legato;break;case 3:t.slideOutType=w.OutDown;break;case 4:t.slideOutType=w.OutUp;break;case-1:t.slideInType=g.IntoFromBelow;break;case-2:t.slideInType=g.IntoFromAbove}}}readArtificialHarmonic(t){const e=this.data.readByte();if(this.Rr>=500)switch(e){case 1:t.harmonicType=p.Natural,t.harmonicValue=Ht.deltaFretToHarmonicValue(t.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),t.harmonicType=p.Artificial;break;case 3:t.harmonicType=p.Tap,t.harmonicValue=Ht.deltaFretToHarmonicValue(this.data.readByte());break;case 4:t.harmonicType=p.Pinch,t.harmonicValue=12;break;case 5:t.harmonicType=p.Semi,t.harmonicValue=12}else if(this.Rr>=400)switch(e){case 1:t.harmonicType=p.Natural;break;case 3:t.harmonicType=p.Tap;break;case 4:t.harmonicType=p.Pinch;break;case 5:t.harmonicType=p.Semi;break;case 15:case 17:case 22:t.harmonicType=p.Artificial}}readTrill(t){switch(t.trillValue=this.data.readByte()+t.stringTuning,this.data.readByte()){case 1:t.trillSpeed=l.Sixteenth;break;case 2:t.trillSpeed=l.ThirtySecond;break;case 3:t.trillSpeed=l.SixtyFourth}}}class Xs{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),n=t.readByte();let r=255;return e?r=t.readByte():t.skip(1),new be(s,i,n,r)}static gpReadBool(t){return 0!==t.readByte()}static gpReadStringIntUnused(t,e){return t.skip(4),Xs.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return Xs.gpReadString(t,he.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=he.readInt32LE(t)-1;return t.readByte(),Xs.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),he.toString(i,s)}static gpWriteString(t,e){const s=he.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),n=Xs.gpReadString(t,i,s);return i<e&&t.skip(e-i),n}}class Js{volume=-1;balance=-1;instrument=-1;tempoName="";tempo=-1;duration=-1}!function(t){t[t.Boolean=0]="Boolean",t[t.Integer=1]="Integer",t[t.Float=2]="Float",t[t.String=3]="String",t[t.Point=4]="Point",t[t.Size=5]="Size",t[t.Rectangle=6]="Rectangle",t[t.Color=7]="Color"}(Ze||(Ze={}));class qs{Zr=new Map;raw=new Map;constructor(t){t&&this.ta(t)}ta(t){const e=Ie.fromBuffer(t),s=he.readInt32BE(e);for(let t=0;t<s;t++){const t=Xs.gpReadString(e,e.readByte(),"utf-8"),s=e.readByte();switch(this.Zr.set(t,s),s){case Ze.Boolean:const s=1===e.readByte();this.addValue(t,s);break;case Ze.Integer:const i=he.readInt32BE(e);this.addValue(t,i);break;case Ze.Float:const n=he.readFloat32BE(e);this.addValue(t,n);break;case Ze.String:const r=Xs.gpReadString(e,he.readInt16BE(e),"utf-8");this.addValue(t,r);break;case Ze.Point:const a=he.readInt32BE(e),h=he.readInt32BE(e);this.addValue(t,new V(a,h));break;case Ze.Size:const o=he.readInt32BE(e),c=he.readInt32BE(e);this.addValue(t,new V(o,c));break;case Ze.Rectangle:const l=new Pe;l.x=he.readInt32BE(e),l.y=he.readInt32BE(e),l.w=he.readInt32BE(e),l.h=he.readInt32BE(e),this.addValue(t,l);break;case Ze.Color:const u=Xs.gpReadColor(e,!0);this.addValue(t,u)}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=M.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=M.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==M.Hidden)switch(s){case 0:case 1:t.stylesheet.singleTrackTrackNamePolicy=M.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=M.AllSystems}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==M.Hidden)switch(s){case 0:case 1:t.stylesheet.multiTrackTrackNamePolicy=M.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=M.AllSystems}break;case"System/shortTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameMode=s?v.ShortName:v.FullName;break;case"System/shortTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameMode=s?v.ShortName:v.FullName;break;case"System/horizontalTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameOrientation=s?N.Horizontal:N.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameOrientation=s?N.Horizontal:N.Vertical;break;case"Header/Title":Ht.getOrCreateHeaderFooterStyle(t,nt.Title).template=s;break;case"Header/TitleAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Title).textAlign=this.ea(s);break;case"Header/drawTitle":Ht.getOrCreateHeaderFooterStyle(t,nt.Title).isVisible=s;break;case"Header/Subtitle":Ht.getOrCreateHeaderFooterStyle(t,nt.SubTitle).template=s;break;case"Header/SubtitleAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.SubTitle).textAlign=this.ea(s);break;case"Header/drawSubtitle":Ht.getOrCreateHeaderFooterStyle(t,nt.SubTitle).isVisible=s;break;case"Header/Artist":Ht.getOrCreateHeaderFooterStyle(t,nt.Artist).template=s;break;case"Header/ArtistAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Artist).textAlign=this.ea(s);break;case"Header/drawArtist":Ht.getOrCreateHeaderFooterStyle(t,nt.Artist).isVisible=s;break;case"Header/Album":Ht.getOrCreateHeaderFooterStyle(t,nt.Album).template=s;break;case"Header/AlbumAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Album).textAlign=this.ea(s);break;case"Header/drawAlbum":Ht.getOrCreateHeaderFooterStyle(t,nt.Album).isVisible=s;break;case"Header/Words":Ht.getOrCreateHeaderFooterStyle(t,nt.Words).template=s;break;case"Header/WordsAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Words).textAlign=this.ea(s);break;case"Header/drawWords":Ht.getOrCreateHeaderFooterStyle(t,nt.Words).isVisible=s;break;case"Header/Music":Ht.getOrCreateHeaderFooterStyle(t,nt.Music).template=s;break;case"Header/MusicAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Music).textAlign=this.ea(s);break;case"Header/drawMusic":Ht.getOrCreateHeaderFooterStyle(t,nt.Music).isVisible=s;break;case"Header/WordsAndMusic":Ht.getOrCreateHeaderFooterStyle(t,nt.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.WordsAndMusic).textAlign=this.ea(s);break;case"Header/drawWordsAndMusic":Ht.getOrCreateHeaderFooterStyle(t,nt.WordsAndMusic).isVisible=s;break;case"Header/Tabber":Ht.getOrCreateHeaderFooterStyle(t,nt.Transcriber).template=s;break;case"Header/TabberAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Transcriber).textAlign=this.ea(s);break;case"Header/drawTabber":Ht.getOrCreateHeaderFooterStyle(t,nt.Transcriber).isVisible=s;break;case"Footer/Copyright":Ht.getOrCreateHeaderFooterStyle(t,nt.Copyright).template=s;break;case"Footer/CopyrightAlignment":Ht.getOrCreateHeaderFooterStyle(t,nt.Copyright).textAlign=this.ea(s);break;case"Footer/drawCopyright":Ht.getOrCreateHeaderFooterStyle(t,nt.Copyright).isVisible=s;break;case"Footer/Copyright2":Ht.getOrCreateHeaderFooterStyle(t,nt.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":Ht.getOrCreateHeaderFooterStyle(t,nt.CopyrightSecondLine).textAlign=this.ea(s);break;case"Footer/drawCopyright2":Ht.getOrCreateHeaderFooterStyle(t,nt.CopyrightSecondLine).isVisible=s}}ea(t){switch(t){case 0:return st.Left;case 1:return st.Center;case 2:return st.Right}return st.Left}addValue(t,e,s){this.raw.set(t,e),void 0!==s&&this.Zr.set(t,s)}writeTo(t){he.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this.sa(e,s);switch(Xs.gpWriteString(t,e),t.writeByte(i),i){case Ze.Boolean:t.writeByte(s?1:0);break;case Ze.Integer:he.writeInt32BE(t,s);break;case Ze.Float:he.writeFloat32BE(t,s);break;case Ze.String:const e=he.stringToBytes(s);he.writeInt16BE(t,e.length),t.write(e,0,e.length);break;case Ze.Point:case Ze.Size:he.writeInt32BE(t,s.offset),he.writeInt32BE(t,s.value);break;case Ze.Rectangle:he.writeInt32BE(t,s.x),he.writeInt32BE(t,s.y),he.writeInt32BE(t,s.w),he.writeInt32BE(t,s.h);break;case Ze.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a)}}}sa(e,s){if(this.Zr.has(e))return this.Zr.get(e);const i=typeof s;switch(typeof s){case"string":return Ze.String;case"number":return s===(0|s)?Ze.Integer:Ze.Float;case"object":if(s instanceof V)return Ze.Point;if(s instanceof Pe)return Ze.Rectangle;if(s instanceof be)return Ze.Color}throw new R(t.AlphaTabErrorType.General,`Unknown value type in BinaryStylesheet: ${i}`)}static writeForScore(t){const e=new qs;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,Ze.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,Ze.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,Ze.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,Ze.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,Ze.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case M.Hidden:e.addValue("System/showTrackNameSingle",!1,Ze.Boolean);break;case M.FirstSystem:e.addValue("System/trackNameModeSingle",0,Ze.Integer);break;case M.AllSystems:e.addValue("System/trackNameModeSingle",2,Ze.Integer)}switch(t.stylesheet.multiTrackTrackNamePolicy){case M.Hidden:e.addValue("System/showTrackNameMulti",!1,Ze.Boolean);break;case M.FirstSystem:e.addValue("System/trackNameModeMulti",0,Ze.Integer);break;case M.AllSystems:e.addValue("System/trackNameModeMulti",2,Ze.Integer)}switch(t.stylesheet.firstSystemTrackNameMode){case v.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,Ze.Boolean);break;case v.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,Ze.Boolean)}switch(t.stylesheet.otherSystemsTrackNameMode){case v.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,Ze.Boolean);break;case v.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,Ze.Boolean)}switch(t.stylesheet.firstSystemTrackNameOrientation){case N.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,Ze.Boolean);break;case N.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,Ze.Boolean)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case N.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,Ze.Boolean);break;case N.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,Ze.Boolean)}const s=t.style;if(s)for(const[t,i]of s.headerAndFooter)switch(t){case nt.Title:qs.ia(e,i,"Header/","Title");break;case nt.SubTitle:qs.ia(e,i,"Header/","Subtitle");break;case nt.Artist:qs.ia(e,i,"Header/","Artist");break;case nt.Album:qs.ia(e,i,"Header/","Album");break;case nt.Words:qs.ia(e,i,"Header/","Words");break;case nt.Music:qs.ia(e,i,"Header/","Music");break;case nt.WordsAndMusic:qs.ia(e,i,"Header/","WordsAndMusic");break;case nt.Transcriber:qs.ia(e,i,"Header/","Tabber");break;case nt.Copyright:qs.ia(e,i,"Footer/","Copyright");break;case nt.CopyrightSecondLine:qs.ia(e,i,"Footer/","Copyright2")}const i=Ie.withCapacity(128);return e.writeTo(i),i.toArray()}static ia(t,e,s,i){t.addValue(`${s}${i}`,e.template,Ze.String),t.addValue(`${s}${i}Alignment`,e.textAlign,Ze.Integer),void 0!==e.isVisible&&t.addValue(`${s}draw${i}`,e.isVisible,Ze.Boolean)}}class Ys{rawAudioFile}class Ks{id="";dots=0;tupletDenominator=-1;tupletNumerator=-1;value=l.Quarter}class Qs{name="";path="";role="";get uniqueId(){return`${this.path};${this.name};${this.role}`}program=0;bank=0}class Zs{static na="-1";static ra=V.MaxPosition/100;static aa=.04;static ha=44100;score;oa;ca;la;ua;da;fa;pa;ba;ma;ga;wa;ya;ka;Sa;Ba;_a;xa;Ta;Ma;va;Na=!1;Pa;Ea=!1;Ca=0;Ur=new Set;jr=new Map;loadAsset;parseXml(t,e){this.ca=new Map,this.la=new Map,this.ua=new Map,this.da=[],this.fa=new Map,this.pa=[],this.ba=[],this.ga=new Map,this.ma=new Map,this.wa=new Map,this.ya=new Map,this.Sa=new Map,this.ka=new Map,this.Ba=new Map,this.xa=new Map,this._a=new Map,this.Ta=new Map,this.Ma=new Map,this.va=new Map,this.Ea=!1;const s=new Es;try{s.parse(t)}catch(t){throw new Oe("Could not parse XML",t)}if(this.An(s),this.Fa(),Ht.consolidate(this.score),this.score.finish(e),!this.Ea&&this.Ma.size>0)for(const[t,e]of this.Ma){this.fa.get(t).applyLyrics(e)}}An(t){const e=t.firstElement;if(e){if("GPIF"!==e.localName)throw new Oe("Root node of XML was not GPIF");this.score=new Ot;for(const t of e.childElements())switch(t.localName){case"Score":this.Aa(t);break;case"MasterTrack":this.Da(t);break;case"BackingTrack":this.La(t);break;case"Tracks":this.Wa(t);break;case"MasterBars":this.Ra(t);break;case"Bars":this.Oa(t);break;case"Voices":this.nr(t);break;case"Beats":this.Ia(t);break;case"Notes":this.Ga(t);break;case"Rhythms":this.$a(t);break;case"Assets":this.Va(t)}}}Va(t){for(const e of t.childElements())if("Asset"===e.localName)e.getAttribute("id")===this.oa&&this.Ha(e)}Ha(t){let e="";for(const s of t.childElements())if("EmbeddedFilePath"===s.localName)e=s.innerText;const s=this.loadAsset;if(s){const t=s(e);t?this.score.backingTrack.rawAudioFile=t:this.score.backingTrack=void 0}}Aa(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const t=e.innerText;""!==t&&(t&&!this.score.words&&(this.score.words=t),t&&!this.score.music&&(this.score.music=t));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=Zs.Ua(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=Zs.za(e.innerText).map(t=>Zs.Ua(t,4))}}static Ua(t,e){if(!t)return e;const s=Number.parseInt(t,10);return Number.isNaN(s)?e:s}static ja(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static za(t,e=" "){return t?t.split(e).map(t=>t.trim()).filter(t=>t.length>0):[]}La(t){const e=new Ys;let s=!1,i="",n="";for(const e of t.childElements())switch(e.localName){case"Enabled":s="true"===e.innerText;break;case"Source":i=e.innerText;break;case"AssetId":n=e.innerText;break;case"FramePadding":this.Ca=Zs.Ua(e.innerText,0)/Zs.ha*1e3}s&&"Local"===i&&(this.score.backingTrack=e,this.oa=n)}Da(t){for(const e of t.childElements())switch(e.localName){case"Automations":this.Xa(e,this.ca,null,null);break;case"Tracks":this.da=Zs.za(e.innerText);break;case"Anacrusis":this.Na=!0}}Xa(t,e,s,i){for(const n of t.childElements())if("Automation"===n.localName)this.Ja(n,e,s,i)}Ja(t,e,s,i){let n,a=null,h=!1,o=-1,c=0,l=0,u=null,d=0,f=null,p=!0;for(const e of t.childElements())switch(e.localName){case"Type":a=e.innerText;break;case"Linear":h="true"===e.innerText.toLowerCase();break;case"Bar":o=Zs.Ua(e.innerText,0);break;case"Position":c=Zs.ja(e.innerText,0);break;case"Value":if(e.firstElement&&e.firstElement.nodeType===qe.CDATA)u=e.innerText;else if(e.firstElement&&e.firstElement.nodeType===qe.Element&&"SyncPoint"===a){n=new G;for(const t of e.childElements())switch(t.localName){case"BarIndex":o=Zs.Ua(t.innerText,0);break;case"BarOccurrence":n.barOccurence=Zs.Ua(t.innerText,0);break;case"FrameOffset":const e=Zs.ja(t.innerText,0);n.millisecondOffset=e/Zs.ha*1e3}}else{const t=Zs.za(e.innerText);1===t.length?(l=Zs.ja(t[0],0),d=1):(l=Zs.ja(t[0],0),d=Zs.Ua(t[1],0))}break;case"Text":f=e.innerText;break;case"Visible":p="true"===e.innerText.toLowerCase()}if(!a)return;const b=[];switch(a){case"Tempo":b.push($.buildTempoAutomation(h,c,l,d,p));break;case"SyncPoint":const t=new $;t.type=r.SyncPoint,t.isLinear=h,t.ratioPosition=c,t.syncPointValue=n,t.isVisible=p,b.push(t);break;case"Sound":if(u&&s&&s.has(u)){const t=new $;t.type=r.Bank,t.ratioPosition=c,t.value=s.get(u).bank,t.isVisible=p,b.push(t);const e=$.buildInstrumentAutomation(h,c,s.get(u).program);b.push(e)}break;case"SustainPedal":if(i){let t;i.has(o)?t=i.get(o):(t=[],i.set(o,t));const e=new Y;switch(e.ratioPosition=c,d){case 1:e.pedalType=A.Down;break;case 3:e.pedalType=A.Up}t.push(e)}}if(b.length){if(f)for(const t of b)t.text=f;if(o>=0){e.has(o)||e.set(o,[]);for(const t of b)e.get(o).push(t)}}}Wa(t){for(const e of t.childElements())if("Track"===e.localName)this.qa(e)}qa(t){this.Pa=new Map;const e=new _e;e.ensureStaveCount(1);e.staves[0].showStandardNotation=!0;const s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Name":e.name=i.innerText;break;case"Color":const t=Zs.za(i.innerText);if(t.length>=3){const s=Zs.Ua(t[0],0),i=Zs.Ua(t[1],0),n=Zs.Ua(t[2],0);e.color=new be(s,i,n,255)}break;case"Instrument":const n=i.getAttribute("ref");(n.endsWith("-gs")||n.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.Ya(e,i);break;case"NotationPatch":this.Ka(e,i);break;case"ShortName":e.shortName=i.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=Zs.Ua(i.innerText,4);break;case"SystemsLayout":e.systemsLayout=Zs.za(i.innerText).map(t=>Zs.Ua(t,4));break;case"Lyrics":this.Qa(s,i);break;case"Properties":this.Za(e,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.th(e,i);break;case"Sounds":this.eh(s,e,i);break;case"PlaybackState":const r=i.innerText;e.playbackInfo.isSolo="Solo"===r,e.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.sh(s,e,i);break;case"Staves":this.Qn(e,i);break;case"Transpose":this.ih(s,e,i);break;case"RSE":this.nh(e,i);break;case"Automations":this.rh(s,i)}this.fa.set(s,e)}rh(t,e){const s=new Map;this.la.set(t,s);const i=new Map;this.ua.set(t,i),this.Xa(e,s,this.va.get(t),i)}Ka(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const e=Zs.Ua(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e;break;case"Elements":this.ah(t,s)}}Ya(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const e of t.staves)e.isPercussion=!0;break;case"Elements":this.ah(t,s);break;case"LineCount":const e=Zs.Ua(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e}}ah(t,e){for(const s of e.childElements())if("Element"===s.localName)this.hh(t,s)}hh(t,e){const s=e.findChildElement("Type")?.innerText??"";for(const i of e.childElements())switch(i.localName){case"Name":case"Articulations":this.oh(t,i,s)}}oh(t,e,s){for(const i of e.childElements())if("Articulation"===i.localName)this.uh(t,i,s)}uh(t,e,s){const i=new Ut;i.outputMidiNumber=-1,i.elementType=s;let n="";for(const t of e.childElements()){const e=t.innerText;switch(t.localName){case"Name":n=t.innerText;break;case"OutputMidiNumber":i.outputMidiNumber=Zs.Ua(e,0);break;case"TechniqueSymbol":i.techniqueSymbol=this.dh(e);break;case"TechniquePlacement":switch(e){case"outside":i.techniqueSymbolPlacement=ct.Outside;break;case"inside":i.techniqueSymbolPlacement=ct.Inside;break;case"above":i.techniqueSymbolPlacement=ct.Above;break;case"below":i.techniqueSymbolPlacement=ct.Below}break;case"Noteheads":const s=Zs.za(e);s.length>=1&&(i.noteHeadDefault=this.fh(s[0])),s.length>=2&&(i.noteHeadHalf=this.fh(s[1])),s.length>=3&&(i.noteHeadWhole=this.fh(s[2])),i.noteHeadHalf===at.None&&(i.noteHeadHalf=i.noteHeadDefault),i.noteHeadWhole===at.None&&(i.noteHeadWhole=i.noteHeadDefault);break;case"StaffLine":i.staffLine=Zs.Ua(e,0)}}-1!==i.outputMidiNumber?(t.percussionArticulations.push(i),n.length>0&&this.Pa.set(n,i)):n.length>0&&this.Pa.has(n)&&(this.Pa.get(n).staffLine=i.staffLine)}dh(t){switch(t){case"pictEdgeOfCymbal":return at.PictEdgeOfCymbal;case"articStaccatoAbove":return at.ArticStaccatoAbove;case"noteheadParenthesis":return at.NoteheadParenthesis;case"stringsUpBow":return at.StringsUpBow;case"stringsDownBow":return at.StringsDownBow;case"guitarGolpe":return at.GuitarGolpe;default:return at.None}}fh(t){switch(t){case"noteheadDoubleWholeSquare":return at.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return at.NoteheadDoubleWhole;case"noteheadWhole":return at.NoteheadWhole;case"noteheadHalf":return at.NoteheadHalf;case"noteheadBlack":return at.NoteheadBlack;case"noteheadNull":return at.NoteheadNull;case"noteheadXOrnate":return at.NoteheadXOrnate;case"noteheadTriangleUpWhole":return at.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return at.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return at.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return at.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return at.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return at.NoteheadDiamondWhiteWide;case"noteheadCircleX":return at.NoteheadCircleX;case"noteheadXWhole":return at.NoteheadXWhole;case"noteheadXHalf":return at.NoteheadXHalf;case"noteheadXBlack":return at.NoteheadXBlack;case"noteheadParenthesis":return at.NoteheadParenthesis;case"noteheadSlashedBlack2":return at.NoteheadSlashedBlack2;case"noteheadCircleSlash":return at.NoteheadCircleSlash;case"noteheadHeavyX":return at.NoteheadHeavyX;case"noteheadHeavyXHat":return at.NoteheadHeavyXHat;default:return j.warning("GPIF","Unknown notehead symbol",t),at.None}}Qn(t,e){let s=0;for(const i of e.childElements())if("Staff"===i.localName){t.ensureStaveCount(s+1);const e=t.staves[s];this.Zn(e,i),s++}}Zn(t,e){for(const s of e.childElements())if("Properties"===s.localName)this.ph(t,s)}ph(t,e){for(const s of e.childElements())if("Property"===s.localName)this.bh(t,s)}bh(t,e){switch(e.getAttribute("name")){case"Tuning":for(const s of e.childElements())switch(s.localName){case"Pitches":const i=Zs.za(e.findChildElement("Pitches")?.innerText),n=new Array(i.length);for(let t=0;t<n.length;t++)n[n.length-1-t]=Zs.Ua(i[t],0);t.stringTuning.tunings=n;break;case"Label":t.stringTuning.name=s.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.mh(t,e);break;case"CapoFret":const s=Zs.Ua(e.findChildElement("Fret")?.innerText,0);t.capo=s}}Qa(t,e){const s=[];for(const t of e.childElements())if("Line"===t.localName)s.push(this.gh(t));this.Ma.set(t,s)}gh(t){const e=new ge;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=Zs.Ua(s.innerText,0);break;case"Text":e.text=s.innerText}return e}wh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.yh(t,e)}mh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.kh(t,e)}yh(t,e){const s=new fe,i=e.getAttribute("id");for(const e of t.staves)e.addChord(i,s);this.Sh(s,e)}kh(t,e){const s=new fe,i=e.getAttribute("id");t.addChord(i,s),this.Sh(s,e)}Sh(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s)return t.showDiagram=!1,void(t.showFingering=!1);const i=Zs.Ua(s.getAttribute("stringCount"),6),n=Zs.Ua(s.getAttribute("baseFret"),0);t.firstFret=n+1;for(let e=0;e<i;e++)t.strings.push(-1);for(const e of s.childElements())switch(e.localName){case"Fret":const s=Zs.Ua(e.getAttribute("string"),0);t.strings[i-s-1]=n+Zs.Ua(e.getAttribute("fret"),0);break;case"Fingering":const r=new Map;for(const s of e.childElements())if("Position"===s.localName){let e=f.Unknown;const i=n+Zs.Ua(s.getAttribute("fret"),0);switch(s.getAttribute("finger")){case"Index":e=f.IndexFinger;break;case"Middle":e=f.MiddleFinger;break;case"Rank":e=f.AnnularFinger;break;case"Pinky":e=f.LittleFinger;break;case"Thumb":e=f.Thumb}e!==f.Unknown&&(r.has(e)?t.barreFrets.push(i):r.set(e,!0))}break;case"Property":switch(e.getAttribute("name")){case"ShowName":t.showName="true"===e.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===e.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===e.getAttribute("value")}}}Za(t,e){for(const s of e.childElements())if("Property"===s.localName)this.Bh(t,s)}Bh(t,e){switch(e.getAttribute("name")){case"Tuning":const s=Zs.za(e.findChildElement("Pitches")?.innerText),i=new Array(s.length);for(let t=0;t<i.length;t++)i[i.length-1-t]=Zs.Ua(s[t],0);for(const e of t.staves)e.stringTuning.tunings=i,e.showStandardNotation=!0,e.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.wh(t,e);break;case"CapoFret":const n=Zs.Ua(e.findChildElement("Fret")?.innerText,0);for(const e of t.staves)e.capo=n}}th(t,e){for(const s of e.childElements())switch(s.localName){case"Program":t.playbackInfo.program=Zs.Ua(s.innerText,0);break;case"Port":t.playbackInfo.port=Zs.Ua(s.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=Zs.Ua(s.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=Zs.Ua(s.innerText,0)}if("Percussion"===e.getAttribute("table"))for(const e of t.staves)e.isPercussion=!0}eh(t,e,s){for(const i of s.childElements())if("Sound"===i.localName)this._h(t,e,i)}_h(t,e,s){const i=new Qs;for(const t of s.childElements())switch(t.localName){case"Name":i.name=t.innerText;break;case"Path":i.path=t.innerText;break;case"Role":i.role=t.innerText;break;case"MIDI":this.xh(i,t)}this.va.has(t)||(this.va.set(t,new Map),e.playbackInfo.program=i.program,e.playbackInfo.bank=i.bank),this.va.get(t).set(i.uniqueId,i)}xh(t,e){let s=0,i=0;for(const n of e.childElements())switch(n.localName){case"Program":t.program=Zs.Ua(n.innerText,0);break;case"MSB":s=Zs.Ua(n.innerText,0);break;case"LSB":i=Zs.Ua(n.innerText,0)}t.bank=(127&s)<<7|i}sh(t,e,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const t of e.staves)t.displayTranspositionPitch=Zs.Ua(i.innerText,0);break;case"NominalKey":const s=Math.max(0,ye.noteNames.indexOf(i.innerText));this.Th.set(t,s)}}Th=new Map;ih(t,e,s){let i=0,n=0;for(const t of s.childElements())switch(t.localName){case"Chromatic":n=Zs.Ua(t.innerText,0);break;case"Octave":i=Zs.Ua(t.innerText,0)}const r=12*i+n;for(const t of e.staves)t.displayTranspositionPitch=r;const a=Ht.flooredDivision(r,12);this.Th.set(t,a)}nh(t,e){for(const s of e.childElements())if("ChannelStrip"===s.localName)this.Mh(t,s)}Mh(t,e){for(const s of e.childElements())if("Parameters"===s.localName)this.Nh(t,s)}Nh(t,e){if(e.firstChild&&e.firstChild.value){const s=Zs.za(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(16*Zs.ja(s[11],.5)),t.playbackInfo.volume=Math.floor(16*Zs.ja(s[12],.9)))}}Ra(t){for(const e of t.childElements())if("MasterBar"===e.localName)this.Ph(e)}Ph(t){const e=new It;0===this.pa.length&&this.Na&&(e.isAnacrusis=!0);for(const s of t.childElements())switch(s.localName){case"Time":const t=s.innerText.split("/");e.timeSignatureNumerator=Zs.Ua(t[0],4),e.timeSignatureDenominator=Zs.Ua(t[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this.Ur.add(e);break;case"Section":e.section=new we,e.section.marker=s.findChildElement("Letter")?.innerText??"",e.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(e.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(e.repeatCount=Zs.Ua(s.getAttribute("count"),1));break;case"AlternateEndings":const i=Zs.za(s.innerText);let n=0;for(let t=0;t<i.length;t++)n|=1<<-1+Zs.Ua(i[t],0);e.alternateEndings=n;break;case"Bars":this.ba.push(Zs.za(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":e.tripletFeel=rt.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=rt.Triplet8th;break;case"Triplet16th":e.tripletFeel=rt.Triplet16th;break;case"Dotted8th":e.tripletFeel=rt.Dotted8th;break;case"Dotted16th":e.tripletFeel=rt.Dotted16th;break;case"Scottish8th":e.tripletFeel=rt.Scottish8th;break;case"Scottish16th":e.tripletFeel=rt.Scottish16th}break;case"Key":const r=Zs.Ua(s.findChildElement("AccidentalCount")?.innerText,0),a=s.findChildElement("Mode");let h=F.Major;if(a)switch(a.innerText.toLowerCase()){case"major":h=F.Major;break;case"minor":h=F.Minor}this.jr.set(this.pa.length,[r,h]);break;case"Fermatas":this.Eh(e,s);break;case"XProperties":this.Ch(e,s);break;case"Directions":this.Fh(e,s)}this.pa.push(e)}Fh(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(Qe.TargetCoda);break;case"DoubleCoda":t.addDirection(Qe.TargetDoubleCoda);break;case"Segno":t.addDirection(Qe.TargetSegno);break;case"SegnoSegno":t.addDirection(Qe.TargetSegnoSegno);break;case"Fine":t.addDirection(Qe.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(Qe.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(Qe.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(Qe.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(Qe.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(Qe.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(Qe.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(Qe.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(Qe.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(Qe.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(Qe.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(Qe.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(Qe.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(Qe.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(Qe.JumpDaDoubleCoda)}}}Eh(t,e){for(const s of e.childElements())if("Fermata"===s.localName)this.Ah(t,s)}Ah(t,e){let s=0;const i=new me;for(const t of e.childElements())switch(t.localName){case"Type":switch(t.innerText){case"Short":i.type=Pt.Short;break;case"Medium":i.type=Pt.Medium;break;case"Long":i.type=Pt.Long}break;case"Length":i.length=Zs.ja(t.innerText,0);break;case"Offset":const e=t.innerText.split("/");if(2===e.length){s=Zs.Ua(e[0],4)/Zs.Ua(e[1],4)*I.QuarterTime|0}}t.addFermata(s,i)}Oa(t){for(const e of t.childElements())if("Bar"===e.localName)this.Dh(e)}Dh(t){const e=new Q,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this.ga.set(s,Zs.za(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=P.Neutral;break;case"G2":e.clef=P.G2;break;case"F4":e.clef=P.F4;break;case"C4":e.clef=P.C4;break;case"C3":e.clef=P.C3}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=m._;break;case"15ma":e.clefOttava=m.S;break;case"8vb":e.clefOttava=m.T;break;case"15mb":e.clefOttava=m.M}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=E.Simple;break;case"FirstOfDouble":e.simileMark=E.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=E.SecondOfDouble}break;case"XProperties":this.Lh(i,e)}this.ma.set(s,e)}nr(t){for(const e of t.childElements())if("Voice"===e.localName)this.rr(e)}rr(t){const e=new et,s=t.getAttribute("id");for(const e of t.childElements())if("Beats"===e.localName)this.ya.set(s,Zs.za(e.innerText));this.wa.set(s,e)}Ia(t){for(const e of t.childElements())if("Beat"===e.localName)this.Wh(e)}Wh(t){const e=new Kt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Notes":this.xa.set(s,Zs.za(i.innerText));break;case"Rhythm":this.ka.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":e.fade=pt.FadeIn;break;case"FadeOut":e.fade=pt.FadeOut;break;case"VolumeSwell":e.fade=pt.VolumeSwell}break;case"Tremolo":switch(i.innerText){case"1/2":e.tremoloSpeed=l.Eighth;break;case"1/4":e.tremoloSpeed=l.Sixteenth;break;case"1/8":e.tremoloSpeed=l.ThirtySecond}break;case"Chord":e.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":e.crescendo=c.Crescendo;break;case"Decrescendo":e.crescendo=c.Decrescendo}break;case"Arpeggio":"Up"===i.innerText?e.brushType=o.ArpeggioUp:e.brushType=o.ArpeggioDown;break;case"Properties":this.Rh(i,e);break;case"XProperties":this.Oh(i,e);break;case"FreeText":e.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":e.preferredBeamDirection=At.Up;break;case"Downward":e.preferredBeamDirection=At.Down}break;case"Dynamic":switch(i.innerText){case"PPP":e.dynamics=n.PPP;break;case"PP":e.dynamics=n.PP;break;case"P":e.dynamics=n.P;break;case"MP":e.dynamics=n.MP;break;case"MF":e.dynamics=n.MF;break;case"F":e.dynamics=n.F;break;case"FF":e.dynamics=n.FF;break;case"FFF":e.dynamics=n.FFF}break;case"GraceNotes":switch(i.innerText){case"OnBeat":e.graceType=u.OnBeat;break;case"BeforeBeat":e.graceType=u.BeforeBeat}break;case"Legato":"true"===i.getAttribute("origin")&&(e.isLegatoOrigin=!0);break;case"Whammy":const t=new V(0,0);t.value=this.Ih(Zs.ja(i.getAttribute("originValue"),0)),t.offset=this.Gh(Zs.ja(i.getAttribute("originOffset"),0)),e.addWhammyBarPoint(t);const r=new V(0,0);r.value=this.Ih(Zs.ja(i.getAttribute("middleValue"),0)),r.offset=this.Gh(Zs.ja(i.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(r);const a=new V(0,0);a.value=this.Ih(Zs.ja(i.getAttribute("middleValue"),0)),a.offset=this.Gh(Zs.ja(i.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(a);const h=new V(0,0);h.value=this.Ih(Zs.ja(i.getAttribute("destinationValue"),0)),h.offset=this.Gh(Zs.ja(i.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(h);break;case"Ottavia":switch(i.innerText){case"8va":e.ottava=m._;break;case"8vb":e.ottava=m.T;break;case"15ma":e.ottava=m.S;break;case"15mb":e.ottava=m.M}break;case"Lyrics":e.lyrics=this.$h(i),this.Ea=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":e.golpe=ft.Finger;break;case"Thumb":e.golpe=ft.Thumb}break;case"Wah":switch(i.innerText){case"Open":e.wahPedal=bt.Open;break;case"Closed":e.wahPedal=bt.Closed}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":e.preferredBeamDirection=At.Down;break;case"Upward":e.preferredBeamDirection=At.Up}break;case"Timer":e.showTimer=!0,e.timer=Zs.Ua(i.innerText,-1),e.timer<0&&(e.timer=null)}this.Sa.set(s,e)}$h(t){const e=[];for(const s of t.childElements())if("Line"===s.localName)e.push(s.innerText);return e}Oh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){let t=0;switch(s.getAttribute("id")){case"1124204546":switch(t=Zs.Ua(s.findChildElement("Int")?.innerText,0),t){case 1:e.beamingMode=wt.ForceMergeWithNext;break;case 2:e.beamingMode=wt.ForceSplitToNext}break;case"1124204552":if(t=Zs.Ua(s.findChildElement("Int")?.innerText,0),1===t)e.beamingMode!==wt.ForceSplitToNext&&(e.beamingMode=wt.ForceSplitOnSecondaryToNext);break;case"1124204545":t=Zs.Ua(s.findChildElement("Int")?.innerText,0),e.invertBeamDirection=1===t;break;case"687935489":t=Zs.Ua(s.findChildElement("Int")?.innerText,0),e.brushDuration=t}}}Lh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){if("1124139520"===s.getAttribute("id")){const t=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=Zs.ja(t?.innerText,1)}}}Ch(t,e){for(const s of e.childElements())if("XProperty"===s.localName){if("1124073984"===s.getAttribute("id"))t.displayScale=Zs.ja(s.findChildElement("Double")?.innerText,1)}}Rh(t,e){let s=!1,i=null,n=null,r=null,a=null,h=null;for(const c of t.childElements())if("Property"===c.localName){switch(c.getAttribute("name")){case"Brush":"Up"===c.findChildElement("Direction")?.innerText?e.brushType=o.BrushUp:e.brushType=o.BrushDown;break;case"PickStroke":"Up"===c.findChildElement("Direction")?.innerText?e.pickStroke=ot.Up:e.pickStroke=ot.Down;break;case"Slapped":c.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":c.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch(c.findChildElement("Strength")?.innerText){case"Wide":e.vibrato=y.Wide;break;case"Slight":e.vibrato=y.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new V(0,0)),i.value=this.Ih(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new V(0,0)),i.offset=this.Gh(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":n=this.Ih(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.Gh(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":a=this.Gh(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":h||(h=new V(V.MaxPosition,0)),h.value=this.Ih(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":h||(h=new V(0,0)),h.offset=this.Gh(Zs.ja(c.findChildElement("Float")?.innerText,0));break;case"BarreFret":e.barreFret=Zs.Ua(c.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(c.findChildElement("String")?.innerText){case"0":e.barreShape=mt.Full;break;case"1":e.barreShape=mt.Half}break;case"Rasgueado":switch(c.findChildElement("Rasgueado")?.innerText){case"ii_1":e.rasgueado=gt.Ii;break;case"mi_1":e.rasgueado=gt.Mi;break;case"mii_1":e.rasgueado=gt.MiiTriplet;break;case"mii_2":e.rasgueado=gt.MiiAnapaest;break;case"pmp_1":e.rasgueado=gt.PmpTriplet;break;case"pmp_2":e.rasgueado=gt.PmpAnapaest;break;case"pei_1":e.rasgueado=gt.PeiTriplet;break;case"pei_2":e.rasgueado=gt.PeiAnapaest;break;case"pai_1":e.rasgueado=gt.PaiTriplet;break;case"pai_2":e.rasgueado=gt.PaiAnapaest;break;case"ami_1":e.rasgueado=gt.AmiTriplet;break;case"ami_2":e.rasgueado=gt.AmiAnapaest;break;case"ppp_1":e.rasgueado=gt.Ppp;break;case"amii_1":e.rasgueado=gt.Amii;break;case"amip_1":e.rasgueado=gt.Amip;break;case"eami_1":e.rasgueado=gt.Eami;break;case"eamii_1":e.rasgueado=gt.Eamii;break;case"peami_1":e.rasgueado=gt.Peami}}}s&&(i||(i=new V(0,0)),h||(h=new V(V.MaxPosition,0)),e.addWhammyBarPoint(i),r&&n&&e.addWhammyBarPoint(new V(r,n)),a&&n&&e.addWhammyBarPoint(new V(a,n)),r||a||!n||e.addWhammyBarPoint(new V(V.MaxPosition/2|0,n)),e.addWhammyBarPoint(h))}Ga(t){for(const e of t.childElements())if("Note"===e.localName)this.Vh(e)}Vh(t){const e=new Jt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this.Hh(i,e,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=Zs.Ua(i.innerText,-1),e.trillSpeed=l.Sixteenth;break;case"Accent":const t=Zs.Ua(i.innerText,0);1&t&&(e.isStaccato=!0),4&t&&(e.accentuated=d.Heavy),8&t&&(e.accentuated=d.Normal),16&t&&(e.accentuated=d.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=y.Slight;break;case"Wide":e.vibrato=y.Wide}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=f.Thumb;break;case"I":e.leftHandFinger=f.IndexFinger;break;case"M":e.leftHandFinger=f.MiddleFinger;break;case"A":e.leftHandFinger=f.AnnularFinger;break;case"C":e.leftHandFinger=f.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=f.Thumb;break;case"I":e.rightHandFinger=f.IndexFinger;break;case"M":e.rightHandFinger=f.MiddleFinger;break;case"A":e.rightHandFinger=f.AnnularFinger;break;case"C":e.rightHandFinger=f.LittleFinger}break;case"InstrumentArticulation":e.percussionArticulation=Zs.Ua(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=lt.Turn;break;case"InvertedTurn":e.ornament=lt.InvertedTurn;break;case"UpperMordent":e.ornament=lt.UpperMordent;break;case"LowerMordent":e.ornament=lt.LowerMordent}}this._a.set(s,e)}Hh(t,e,s){let i=!1,n=null,r=null,a=null,h=null,o=null,c=-1,l=-1,u=!1;for(const d of t.childElements())if("Property"===d.localName){switch(d.getAttribute("name")){case"ShowStringNumber":d.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=Zs.Ua(d.findChildElement("String")?.innerText,0)+1;break;case"Fret":e.fret=Zs.Ua(d.findChildElement("Fret")?.innerText,0);break;case"Element":c=Zs.Ua(d.findChildElement("Element")?.innerText,0);break;case"Variation":l=Zs.Ua(d.findChildElement("Variation")?.innerText,0);break;case"Tapped":this.Ta.set(s,!0);break;case"HarmonicType":const t=d.findChildElement("HType");if(t)switch(t.innerText){case"NoHarmonic":e.harmonicType=p.None;break;case"Natural":e.harmonicType=p.Natural;break;case"Artificial":e.harmonicType=p.Artificial;break;case"Pinch":e.harmonicType=p.Pinch;break;case"Tap":e.harmonicType=p.Tap;break;case"Semi":e.harmonicType=p.Semi;break;case"Feedback":e.harmonicType=p.Feedback}break;case"HarmonicFret":const f=d.findChildElement("HFret");f&&(e.harmonicValue=Zs.ja(f.innerText,0));break;case"Muted":d.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":d.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=Zs.Ua(d.findChildElement("Number")?.innerText,0),-1===e.tone&&(e.tone=0);break;case"Tone":e.tone=Zs.Ua(d.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":u||this.Uh(d,e);break;case"TransposedPitch":e.accidentalMode=b.Default,this.Uh(d,e),u=!0;break;case"Bended":i=!0;break;case"BendOriginValue":n||(n=new V(0,0)),n.value=this.Ih(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":n||(n=new V(0,0)),n.offset=this.Gh(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.Ih(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":a=this.Gh(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":h=this.Gh(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":o||(o=new V(V.MaxPosition,0)),o.value=this.Ih(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":o||(o=new V(0,0)),o.offset=this.Gh(Zs.ja(d.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":d.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const m=Zs.Ua(d.findChildElement("Flags")?.innerText,0);1&m?e.slideOutType=w.Shift:2&m?e.slideOutType=w.Legato:4&m?e.slideOutType=w.OutDown:8&m&&(e.slideOutType=w.OutUp),16&m?e.slideInType=g.IntoFromBelow:32&m&&(e.slideInType=g.IntoFromAbove),64&m?e.slideOutType=w.PickSlideDown:128&m&&(e.slideOutType=w.PickSlideUp)}}i&&(n||(n=new V(0,0)),o||(o=new V(V.MaxPosition,0)),e.addBendPoint(n),a&&r&&e.addBendPoint(new V(a,r)),h&&r&&e.addBendPoint(new V(h,r)),a||h||!r||e.addBendPoint(new V(V.MaxPosition/2|0,r)),e.addBendPoint(o)),-1!==c&&-1!==l&&(e.percussionArticulation=zt.articulationFromElementVariation(c,l))}Uh(t,e){const s=t.findChildElement("Pitch");if(s)for(const t of s.childElements())if("Accidental"===t.localName)switch(t.innerText){case"x":e.accidentalMode=b.ForceDoubleSharp;break;case"#":e.accidentalMode=b.ForceSharp;break;case"b":e.accidentalMode=b.ForceFlat;break;case"bb":e.accidentalMode=b.ForceDoubleFlat}}Ih(t){return t*Zs.aa|0}Gh(t){return t*Zs.ra}$a(t){for(const e of t.childElements())if("Rhythm"===e.localName)this.zh(e)}zh(t){const e=new Ks,s=t.getAttribute("id");e.id=s;for(const s of t.childElements())switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":e.value=l.QuadrupleWhole;break;case"DoubleWhole":e.value=l.DoubleWhole;break;case"Whole":e.value=l.Whole;break;case"Half":e.value=l.Half;break;case"Quarter":e.value=l.Quarter;break;case"Eighth":e.value=l.Eighth;break;case"16th":e.value=l.Sixteenth;break;case"32nd":e.value=l.ThirtySecond;break;case"64th":e.value=l.SixtyFourth;break;case"128th":e.value=l.OneHundredTwentyEighth;break;case"256th":e.value=l.TwoHundredFiftySixth}break;case"PrimaryTuplet":e.tupletNumerator=Zs.Ua(s.getAttribute("num"),-1),e.tupletDenominator=Zs.Ua(s.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=Zs.Ua(s.getAttribute("count"),0)}this.Ba.set(s,e)}Fa(){for(let t=0,e=this.pa.length;t<e;t++){const e=this.pa[t];this.score.addMasterBar(e)}const t=this.pa[this.pa.length-1];this.Ur.has(t)&&(this.Ur.delete(t),t.isDoubleBar=!1);const e=[];for(const t of this.da){if(!t)continue;const s=this.fa.get(t);this.score.addTrack(s),e.push(t)}let s;for(const t of this.ba){let i=0,n=0;s=[C.C,F.Major],this.Th.has(e[0])&&(s=[Ht.transposeKey(s[0],this.Th.get(e[0])),s[1]]);for(let r=0;r<t.length&&n<this.score.tracks.length;r++){const a=t[r];if(a!==Zs.na){const t=this.ma.get(a),r=this.score.tracks[n],h=r.staves[i];h.addBar(t);const o=h.bars.length-1;if(this.jr.has(o)&&(s=this.jr.get(o),this.Th.has(e[n])&&(s=[Ht.transposeKey(s[0],this.Th.get(e[n])),s[1]])),t.keySignature=s[0],t.keySignatureType=s[1],this.Ur.has(t.masterBar)&&(t.barLineRight=L.LightLight),this.ga.has(a))for(const e of this.ga.get(a))if(e!==Zs.na){const s=this.wa.get(e);if(t.addVoice(s),this.ya.has(e))for(const t of this.ya.get(e))if(t!==Zs.na){const e=se.clone(this.Sa.get(t));s.addBeat(e);const i=this.ka.get(t),n=this.Ba.get(i);if(e.duration=n.value,e.dots=n.dots,e.tupletNumerator=n.tupletNumerator,e.tupletDenominator=n.tupletDenominator,this.xa.has(t))for(const s of this.xa.get(t))if(s!==Zs.na){const t=Zt.clone(this._a.get(s));h.isPercussion?(t.fret=-1,t.string=-1):t.percussionArticulation=-1,e.addNote(t),this.Ta.has(s)&&(e.tap=!0)}}}else{const e=new et;t.addVoice(e);const s=new Kt;s.isEmpty=!0,s.duration=l.Quarter,e.addBeat(s)}i===r.staves.length-1?(n++,i=0):i++,s=[C.C,F.Major],n<e.length&&this.Th.has(e[n])&&(s=[Ht.transposeKey(s[0],this.Th.get(e[n])),s[1]])}else n++}}for(const t of this.da){if(!t)continue;const e=this.fa.get(t);let s=!1;for(const t of e.staves)if(t.isPercussion){s=!0;break}if(s||(e.percussionArticulations=[]),this.la.has(t)){const s=this.la.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){const s=e.staves[0].bars[t];if(s.voices.length>0&&s.voices[0].beats.length>0){const t=s.voices[0].beats[0];for(const e of i){e.type===r.Bank&&0===e.value&&0===s.index||t.automations.push(e)}}}}if(this.ua.has(t)){const s=this.ua.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){e.staves[0].bars[t].sustainPedals=i}}}for(const[t,e]of this.ca){const s=this.score.masterBars[t];for(let t=0,i=e.length;t<i;t++){const i=e[t];switch(i.type){case r.Tempo:s.tempoAutomations.push(i);break;case r.SyncPoint:i.syncPointValue.millisecondOffset-=this.Ca,s.addSyncPoint(i)}}}}}class ti{isMultiRest=!1;trackViewGroups=[]}class ei{showNumbered=!1;showSlash=!1;showStandardNotation=!1;showTablature=!1}class si{scoreViews=[];apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const t of i.staves)t.isPercussion||(t.showTablature=s.showTablature),t.showStandardNotation=s.showStandardNotation,t.showSlash=s.showSlash,t.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}constructor(t){const e=Ie.fromBuffer(t),s=he.readInt32BE(e);for(let t=0;t<s;t++){const t=new ti;this.scoreViews.push(t),t.isMultiRest=Xs.gpReadBool(e);const s=he.readInt32BE(e);for(let i=0;i<s;i++){let s=e.readByte();0===s&&(s=1);const i=new ei;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),t.trackViewGroups.push(i)}}}static writeForScore(t){const e=Ie.withCapacity(128),s=[new ti];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const e of t.tracks){const i=new ei;i.showStandardNotation=e.staves[0].showStandardNotation,i.showTablature=e.staves[0].showTablature,i.showSlash=e.staves[0].showSlash,i.showNumbered=e.staves[0].showNumbered,s[0].trackViewGroups.push(i);const n=new ti;n.isMultiRest=!0===t.stylesheet.perTrackMultiBarRest?.has(e.index),n.trackViewGroups.push(i),s.push(n)}he.writeInt32BE(e,s.length);for(const t of s){e.writeByte(t.isMultiRest?1:0),he.writeInt32BE(e,t.trackViewGroups.length);for(const s of t.trackViewGroups){let t=0;s.showStandardNotation&&(t|=1),s.showTablature&&(t|=2),s.showSlash&&(t|=4),s.showNumbered&&(t|=8),e.writeByte(t)}}return he.writeInt32BE(e,1),e.toArray()}}class ii{trackViewGroups=[]}class ni{isVisible=!1}!function(t){t[t.PageVertical=0]="PageVertical",t[t.PageGrid=1]="PageGrid",t[t.PageParchment=2]="PageParchment",t[t.ScreenVertical=3]="ScreenVertical",t[t.ScreenHorizontal=4]="ScreenHorizontal",t[t.PageHorizontal=5]="PageHorizontal"}(ts||(ts={}));class ri{zoomLevel=4;view=ts.PageVertical;muiltiVoiceCursor=!1;scoreViews=[];constructor(t,e){const s=Ie.fromBuffer(e);this.zoomLevel=he.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=t.scoreViews.length;for(let e=0;e<i;e++){const i=new ii;this.scoreViews.push(i);const n=t.scoreViews[e];for(let t=0;t<n.trackViewGroups.length;t++){const t=new ni;t.isVisible=0!==s.readByte(),i.trackViewGroups.push(t)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){t.tracks[e].isVisibleOnMultiTrack=s.isVisible}e++}}}static writeForScore(t){const e=Ie.withCapacity(128);he.writeInt32BE(e,4),e.writeByte(0);const s=t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice;e.writeByte(s?255:0);for(const s of t.tracks)e.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of t.tracks)e.writeByte(255);return e.toArray()}}class ai extends Re{get name(){return"Guitar Pro 7-8"}readScore(){j.debug(this.name,"Loading ZIP entries");const t=new Ts(this.data);let e;try{e=t.read()}catch(t){throw new Oe("No Zip archive",t)}j.debug(this.name,"Zip entries loaded");let s=null,i=null,n=null,r=null;const a=new Map;for(const t of e)switch(a.set(t.fullName,t),t.fileName){case"score.gpif":s=he.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=t.data;break;case"PartConfiguration":n=t.data;break;case"LayoutConfiguration":r=t.data}if(!s)throw new Oe("No score.gpif found in zip archive");j.debug(this.name,"Start Parsing score.gpif");const h=new Zs;h.loadAsset=t=>{if(a.has(t))return a.get(t).data},h.parseXml(s,this.settings),j.debug(this.name,"score.gpif parsed");const o=h.score;if(i){j.debug(this.name,"Start Parsing BinaryStylesheet");new qs(i).apply(o),j.debug(this.name,"BinaryStylesheet parsed")}let c=null;if(n&&(j.debug(this.name,"Start Parsing Part Configuration"),c=new si(n),c.apply(o),j.debug(this.name,"Part Configuration parsed")),r&&null!=c){j.debug(this.name,"Start Parsing Layout Configuration");new ri(c,r).apply(o),j.debug(this.name,"Layout Configuration parsed")}return o}}class hi extends R{constructor(){super(t.AlphaTabErrorType.Format,"Unexpected end of data within reader")}}class oi{static jh=8;Xh=0;Jh=oi.jh;qh;constructor(t){this.qh=t}readByte(){return this.readBits(8)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){let e=0,s=t-1;for(;s>=0;)e|=this.readBit()<<s,s--;return e}readBitsReversed(t){let e=0;for(let s=0;s<t;s++)e|=this.readBit()<<s;return e}readBit(){if(this.Jh>=8){if(this.Xh=this.qh.readByte(),-1===this.Xh)throw new hi;this.Jh=0}const t=this.Xh>>oi.jh-this.Jh-1&1;return this.Jh++,t}readAll(){const t=Ie.empty();try{for(;;)t.writeByte(255&this.readByte())}catch(t){if(!(t instanceof hi))throw t}return t.toArray()}}class ci{fileName="";fileSize=0;data=null}class li{static HeaderBcFs="BCFS";static HeaderBcFz="BCFZ";fileFilter;files=[];constructor(){this.files=[],this.fileFilter=t=>!0}load(t){const e=new oi(t);this.Yh(e)}readHeader(t){return this.Kh(t.readBytes(4),0,4)}decompress(t,e=!1){const s=Ie.empty();let i;const n=this.Qh(t.readBytes(4),0);try{for(;s.length<n;){if(1===t.readBits(1)){const e=t.readBits(4),n=t.readBitsReversed(e),r=t.readBitsReversed(e),a=s.length-n,h=Math.min(n,r);i=s.getBuffer(),s.write(i,a,h)}else{const e=t.readBitsReversed(2);for(let i=0;i<e;i++)s.writeByte(t.readByte())}}}catch(t){if(!(t instanceof hi))throw t}i=s.getBuffer();const r=e?4:0,a=s.length-r,h=new Uint8Array(a),o=a;return h.set(i.subarray(r,r+o),0),h}Yh(t){const e=this.readHeader(t);if("BCFZ"===e)this.Zh(this.decompress(t,!0));else{if("BCFS"!==e)throw new Oe("Unsupported format");this.Zh(t.readAll())}}Zh(t){const e=4096;let s=e;for(;s+3<t.length;){if(2===this.Qh(t,s)){const i=new ci;i.fileName=this.Kh(t,s+4,127),i.fileSize=this.Qh(t,s+140);const n=!this.fileFilter||this.fileFilter(i.fileName);n&&this.files.push(i);const r=s+148;let a=0,h=0;const o=n?Ie.withCapacity(i.fileSize):null;for(;a=this.Qh(t,r+4*h++),0!==a;)s=a*e,n&&o.write(t,s,e);if(n){i.data=new Uint8Array(Math.min(i.fileSize,o.length));const t=o.toArray();i.data.set(t.subarray(0,0+i.data.length),0)}}s+=e}}Kh(t,e,s){let i="";for(let n=0;n<s;n++){const s=255&t[e+n];if(0===s)break;i+=String.fromCharCode(s)}return i}Qh(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}}class ui extends Re{get name(){return"Guitar Pro 6"}readScore(){j.debug(this.name,"Loading GPX filesystem");const t=new li;t.fileFilter=t=>t.endsWith("score.gpif")||t.endsWith("BinaryStylesheet")||t.endsWith("PartConfiguration")||t.endsWith("LayoutConfiguration"),t.load(this.data),j.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,n=null;for(const r of t.files)switch(r.fileName){case"score.gpif":e=he.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":n=r.data}if(!e)throw new Oe("No score.gpif found in GPX");j.debug(this.name,"Start Parsing score.gpif");const r=new Zs;r.parseXml(e,this.settings),j.debug(this.name,"score.gpif parsed");const a=r.score;if(s){j.debug(this.name,"Start Parsing BinaryStylesheet");new qs(s).apply(a),j.debug(this.name,"BinaryStylesheet parsed")}let h=null;if(i&&(j.debug(this.name,"Start Parsing Part Configuration"),h=new si(i),h.apply(a),j.debug(this.name,"Part Configuration parsed")),n&&null!=h){j.debug(this.name,"Start Parsing Layout Configuration");new ri(h,n).apply(a),j.debug(this.name,"Layout Configuration parsed")}return a}}class di{maxLine=-1e3;maxLineNote=null;minLine=-1e3;minLineNote=null}class fi{fe;eo;static so=7;static no=[38,32,30,26,38];static sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6];static flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];ro=new Map;ao=new Map;ho=new Map;oo=new Map;co=new Map;maxLineBeat=null;minLineBeat=null;maxLine=-1e3;minLine=-1e3;constructor(t){this.eo=t,this.fe=t.bar}static getPercussionLine(t,e){return e<t.staff.track.percussionArticulations.length?t.staff.track.percussionArticulations[e].staffLine:zt.getArticulationByInputMidiNumber(e)?.staffLine??0}static getNoteValue(t){if(t.isPercussion)return t.percussionArticulation;let e=t.displayValue;switch(t.accidentalMode){case b.ForceDoubleFlat:e+=2;break;case b.ForceDoubleSharp:e-=2;break;case b.ForceFlat:e+=1;break;case b.ForceSharp:e-=1}return e}applyAccidental(t){const e=fi.getNoteValue(t),s=t.hasQuarterToneOffset;return this.lo(e,s,t.beat,!1,t)}applyAccidentalForValue(t,e,s,i){return this.lo(e,s,t,i,null)}static computeLineWithoutAccidentals(t,e){let s=0;const i=fi.getNoteValue(e);return s=e.isPercussion?fi.getPercussionLine(t,i):fi.calculateNoteSteps(t.keySignature,t.clef,i),s}lo(t,e,s,i,n=null){let r=0,a=ht.None;if(null!=n?n.isPercussion:this.fe.staff.isPercussion)r=fi.getPercussionLine(this.fe,t);else{const s=n?n.accidentalMode:b.Default;r=fi.calculateNoteSteps(this.fe.keySignature,this.fe.clef,t);const i=this.ro.has(r)?this.ro.get(r):null;a=Ht.computeAccidental(this.fe.keySignature,s,t,e,i);let h=!1;switch(a){case ht.NaturalQuarterNoteUp:case ht.SharpQuarterNoteUp:case ht.FlatQuarterNoteUp:break;default:if(n&&n.isTieDestination&&0===n.beat.index){const t=this.eo.scoreRenderer.layout?.getRendererForBar(this.eo.staff.staffId,n.tieOrigin.beat.voice.bar);if(t&&t.staff===this.eo.staff){t.accidentalHelper.getNoteLine(n.tieOrigin)===r&&(h=!0)}}h?a=ht.None:a!==ht.None&&this.ro.set(r,a)}}return n?(this.ao.set(n.id,r),this.oo.set(t,n)):this.ho.set(t,r),(-1e3===this.minLine||this.minLine<r)&&(this.minLine=r,this.minLineBeat=s),(-1e3===this.maxLine||this.maxLine>r)&&(this.maxLine=r,this.maxLineBeat=s),i||this.uo(s,r,n),a}uo(t,e,s){let i;this.co.has(t.id)?i=this.co.get(t.id):(i=new di,this.co.set(t.id,i)),(-1e3===i.minLine||e<i.minLine)&&(i.minLine=e,i.minLineNote=s),(-1e3===i.minLine||e>i.maxLine)&&(i.maxLine=e,i.maxLineNote=s)}getMaxLine(t){return this.co.has(t.id)?this.co.get(t.id).maxLine:0}getMaxLineNote(t){return this.co.has(t.id)?this.co.get(t.id).maxLineNote:null}getMinLine(t){return this.co.has(t.id)?this.co.get(t.id).minLine:0}getMinLineNote(t){return this.co.has(t.id)?this.co.get(t.id).minLineNote:null}static calculateNoteSteps(t,e,s){const i=t,n=e,r=s%12,a=(s/12|0)-1;let h=fi.no[n];h-=a*fi.so;return h-=(Ht.keySignatureIsSharp(i)||Ht.keySignatureIsNatural(i)?fi.sharpNoteSteps:fi.flatNoteSteps)[r],h}getNoteLine(t){return this.ao.get(t.id)}getNoteLineForValue(t,e=!1){return this.ho.has(t)?this.ho.get(t):e&&this.oo.has(t)?this.getNoteLine(this.oo.get(t)):0}}class pi{slurStarts;currentDynamics=n.F;tieStarts;tieStartIds;slideOrigins=new Map;transpose=0;isExplicitlyBeamed=!1;constructor(){this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class bi extends Ut{outputMidiChannel=-1;outputMidiProgram=-1;outputMidiBank=-1;outputVolume=-1;outputBalance=-1}class mi{track;firstArticulation;instruments=new Map;do=new Map;fo=0;po=new Map;constructor(t){this.track=t}getLyricLine(t){if(this.po.has(t))return this.po.get(t);const e=this.fo;return this.po.set(t,e),this.fo++,e}static bo=new Ut("Default",0,0,at.NoteheadBlack,at.NoteheadHalf,at.NoteheadWhole);getOrCreateArticulation(t,e){const s=12*e.octave+e.tone,i=`${t}_${s}`;if(this.do.has(i))return this.do.get(i);let n;n=this.instruments.has(t)?this.instruments.get(t):mi.bo;const r=this.track.percussionArticulations.length,a=e.beat.voice.bar;let h;h=0===s?4:fi.calculateNoteSteps(a.keySignature,a.clef,s);const o=h-(9-(2*e.beat.voice.bar.staff.standardNotationLineCount-1)),c=new Ut(n.elementType,o,n.outputMidiNumber,n.noteHeadDefault,n.noteHeadHalf,n.noteHeadWhole,n.techniqueSymbol,n.techniqueSymbolPlacement);return this.do.set(i,r),this.track.percussionArticulations.push(c),r}}class gi extends Re{ue;mo=new Map;wo=new Map;yo=new Map;ko=1;So=n.F;get name(){return"MusicXML"}readScore(){const t=this.Bo(),e=new Es;try{e.parse(t)}catch(t){throw new Oe("Unsupported format",t)}return this.ue=new Ot,this.ue.stylesheet.hideDynamics=!0,this.An(e),Ht.consolidate(this.ue),this.ue.finish(this.settings),this.ue.rebuildRepeatGroups(),this.ue}Bo(){const t=new Ts(this.data);let e;try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),he.toString(this.data.readAll(),this.settings.importer.encoding);const s=e.find(t=>"META-INF/container.xml"===t.fullName);if(!s)throw new Oe("No compressed MusicXML");const i=new Es;try{i.parse(he.toString(s.data,this.settings.importer.encoding))}catch(t){throw new Oe("Malformed container.xml, could not parse as XML",t)}const n=i.firstElement;if(!n||"container"!==n.localName)throw new Oe("Malformed container.xml, root element not 'container'");const r=n.findChildElement("rootfiles");if(!r)throw new Oe("Malformed container.xml, 'container/rootfiles' not found");let a="";for(const t of r.childElements())if("rootfile"===t.localName){a=t.getAttribute("full-path");break}if(!a)throw new Oe("Unsupported compressed MusicXML, missing rootfile");const h=e.find(t=>t.fullName===a);if(!h)throw new Oe(`Malformed container.xml, '${a}' not contained in zip`);return he.toString(h.data,this.settings.importer.encoding)}An(t){const e=t.firstElement;if(!e)throw new Oe("Unsupported format");switch(e.localName){case"score-partwise":this._o(e);break;case"score-timewise":this.xo(e);break;default:throw new Oe("Unsupported format")}}_o(t){for(const e of t.childElements())switch(e.localName){case"credit":this.To(e);break;case"identification":this.Mo(e);break;case"movement-title":this.vo(e);break;case"part":this.No(e);break;case"part-list":this.Po(e);break;case"work":this.Eo(e)}}xo(t){let e=0;for(const s of t.childElements())switch(s.localName){case"credit":this.To(s);break;case"identification":this.Mo(s);break;case"movement-title":this.vo(s);break;case"part-list":this.Po(s);break;case"work":this.Eo(s);break;case"measure":this.Co(s,e),e++}}To(t){if("1"!==t.getAttribute("page","1"))return;const e=[];let s=null,i="";for(const n of t.childElements())switch(n.localName){case"credit-type":e.push(n.innerText);break;case"credit-words":null===s&&(s=n),i+=n.innerText}if(e.length>0)for(const t of e)switch(t){case"title":this.ue.title=gi.Fo(i);break;case"subtitle":this.ue.subTitle=gi.Fo(i);break;case"composer":case"arranger":this.ue.artist=gi.Fo(i);break;case"lyricist":this.ue.words=gi.Fo(i);break;case"rights":this.ue.copyright=gi.Fo(i)}else if(s){const t=s.getAttribute("font-size","0"),e=s.getAttribute("font-size","top"),n=s.getAttribute("halign","left");if("top"===e){if(i.includes("copyright")||i.includes("Copyright")||i.includes("©")||i.includes("(c)")||i.includes("(C)"))return void(this.ue.copyright=gi.Fo(i));if("center"===n||"center"===t){if(0===this.ue.title.length)return void(this.ue.title=gi.Fo(i));if(0===this.ue.subTitle.length)return void(this.ue.subTitle=gi.Fo(i));if(0===this.ue.album.length)return void(this.ue.album=gi.Fo(i))}else if(("right"===n||"right"===t)&&0===this.ue.music.length)return void(this.ue.music=gi.Fo(i));if(0===this.ue.artist.length)return void(this.ue.artist=gi.Fo(i));if(0===this.ue.words.length)return void(this.ue.words=gi.Fo(i))}}}static Fo(t){return t.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","  ").replaceAll(" "," ")}Mo(t){for(const e of t.childElements())switch(e.localName){case"creator":if(e.attributes.has("type"))switch(e.attributes.get("type")){case"composer":this.ue.artist=gi.Fo(e.innerText);break;case"lyricist":this.ue.words=gi.Fo(e.innerText);break;case"arranger":this.ue.music=gi.Fo(e.innerText)}else this.ue.artist=gi.Fo(e.innerText);break;case"rights":this.ue.copyright.length>0&&(this.ue.copyright+=", "),this.ue.copyright+=e.innerText,e.attributes.has("type")&&(this.ue.copyright+=` (${e.attributes.get("type")})`);break;case"encoding":this.Ao(e)}}Ao(t){for(const e of t.childElements())switch(e.localName){case"encoder":this.ue.tab.length>0&&(this.ue.tab+=", "),this.ue.tab+=e.innerText,e.attributes.has("type")&&(this.ue.tab+=` (${e.attributes.get("type")})`);break;case"encoding-description":this.ue.notices+=gi.Fo(e.innerText)}}vo(t){0===this.ue.title.length?this.ue.title=gi.Fo(t.innerText):this.ue.subTitle=gi.Fo(t.innerText)}Po(t){for(const e of t.childElements())if("score-part"===e.localName)this.Do(e)}Do(t){const e=new _e;e.ensureStaveCount(1),this.ue.addTrack(e);const s=t.attributes.get("id"),i=new mi(e);this.mo.set(s,i),this.wo.set(e.index,i);for(const s of t.childElements())switch(s.localName){case"part-name":e.name=gi.Fo(s.innerText);break;case"part-name-display":e.name=this.Lo(s);break;case"part-abbreviation":e.shortName=gi.Fo(s.innerText);break;case"part-abbreviation-display":e.shortName=this.Lo(s);break;case"score-instrument":this.Wo(s,i);break;case"midi-device":s.attributes.has("port")&&(e.playbackInfo.port=Number.parseInt(s.attributes.get("port"),10));break;case"midi-instrument":this.Ro(s,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(e.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(e.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(e.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(e.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(e.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,e.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}Wo(t,e){const s=new bi;e.firstArticulation||(e.firstArticulation=s),e.instruments.set(t.getAttribute("id",""),s)}Ro(t,e){const s=t.getAttribute("id","");if(!e.instruments.has(s))return;const i=e.instruments.get(s);for(const e of t.childElements())switch(e.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(e.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(e.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(e.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(e.innerText,10)-1;break;case"volume":i.outputVolume=gi.Oo(Number.parseFloat(e.innerText));break;case"pan":i.outputBalance=gi.Io(Number.parseFloat(e.innerText))}}static Oo(t){return 0|gi.Go(0,100,0,16,t)}static Io(t){return 0|gi.Go(-90,90,0,16,t)}static Go(t,e,s,i,n){return s+(i-s)*((n-t)/(e-t))}Lo(t){let e="";for(const s of t.childElements())switch(s.localName){case"display-text":e+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":e+="♯";break;case"natural":e+="♮";break;case"flat":e+="♭";break;case"double-sharp":e+="𝄪";break;case"sharp-sharp":e+="♯♯";break;case"flat-flat":e+="𝄫";break;case"natural-sharp":e+="♮♯";break;case"natural-flat":e+="♮♭";break;case"sharp-down":e+="𝄱";break;case"sharp-up":e+="𝄰";break;case"natural-down":e+="𝄯";break;case"natural-up":e+="𝄮";break;case"flat-down":e+="𝄭";break;case"flat-up":e+="𝄬";break;case"arrow-down":e+="↓";break;case"arrow-up":e+="↑";break;case"triple-sharp":e+="♯𝄪";break;case"triple-flat":e+="𝄬𝄬𝄬";break;case"sharp-1":e+="♯¹";break;case"sharp-2":e+="♯²";break;case"sharp-3":e+="♯³";break;case"sharp-4":e+="♯⁴";break;case"sharp-5":e+="♯⁵";break;case"flat-1":e+="♭¹";break;case"flat-2":e+="♭²";break;case"flat-3":e+="♭³";break;case"flat-4":e+="♭⁴";break;case"flat-5":e+="♭⁵"}}return gi.Fo(e)}Eo(t){for(const e of t.childElements())if("work-title"===e.localName)this.ue.title=gi.Fo(e.innerText)}No(t){const e=t.attributes.get("id");if(!e||!this.mo.has(e))return;const s=this.mo.get(e).track;let i=0;for(const e of t.childElements())if("measure"===e.localName)this.$o(e,s,i),i++}$o(t,e,s){const i=this.Vo(t,s);this.Ho(t,i,e)}Co(t,e){const s=this.Vo(t,e);for(const e of t.childElements())if("part"===e.localName)this.Uo(e,s)}Vo(t,e){const s="yes"===t.attributes.get("implicit");for(;this.ue.masterBars.length<=e;){const t=new It;s&&(t.isAnacrusis=!0),this.ue.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return this.ue.masterBars[e]}Uo(t,e){const s=t.attributes.get("id");if(!s||!this.mo.has(s))return;const i=this.mo.get(s).track;this.Ho(t,e,i)}zo=0;jo=null;Ho(t,e,s){this.zo=0,this.jo=null,e.alternateEndings=this.Xo;const i=[];for(const n of t.childElements())switch(n.localName){case"note":this.Vh(n,e,s);break;case"backup":this.Jo(n);break;case"forward":this.qo(n);break;case"direction":this.Yo(n,e,s);break;case"attributes":this.Ko(n,e,s);break;case"harmony":this.Qo(n,s);break;case"print":this.Zo(n,e,s);break;case"sound":this._h(n,e,s);break;case"barline":i.push(n)}for(const t of i)this.tc(t,e,s);this.ec(e,s);const n=this.sc(s,0);this.ar(n,e),this.nc=null}Zo(t,e,s){("yes"===t.getAttribute("new-system","no")||"yes"===t.getAttribute("new-page","no"))&&s.addLineBreaks(e.index)}ec(t,e){if(null!==this.rc){for(const s of e.staves){const e=this.ar(s,t);e.simileMark=this.rc,e.simileMark!==E.None&&this.ac(e)}this.rc===E.FirstOfDouble?this.rc=E.SecondOfDouble:this.rc=null}if(null!==this.hc){const s=Array.from(this.hc.keys());for(const i of s){const s=this.sc(e,i),n=this.ar(s,t);n.simileMark=this.hc.get(i),n.simileMark!==E.None&&this.ac(n),n.simileMark===E.FirstOfDouble?this.hc.set(i,E.SecondOfDouble):this.hc.delete(i)}0===this.hc.size&&(this.hc=null)}}ac(t){for(const e of t.voices){const t=new Kt;t.isEmpty=!0,e.addBeat(t)}}tc(t,e,s){for(const i of t.childElements())switch(i.localName){case"bar-style":this.oc(i,e,s,t.getAttribute("location","right"));break;case"ending":this.cc(i,e);break;case"repeat":this.lc(i,e)}}lc(t,e){const s=t.getAttribute("direction");let i=Number.parseInt(t.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?e.repeatCount=i:"forward"===s&&(e.isRepeatStart=!0)}Xo=0;cc(t,e){const s=t.getAttribute("number").split(",").map(t=>Number.parseInt(t,10));let i=0;for(const t of s)i|=1<<t-1&255;switch(e.alternateEndings=i,t.getAttribute("type","")){case"start":this.Xo=this.Xo|i;break;case"stop":case"discontinue":this.Xo=this.Xo&~i}}oc(t,e,s,i){let n=L.Automatic;switch(t.innerText){case"dashed":n=L.Dashed;break;case"dotted":n=L.Dotted;break;case"heavy":n=L.Heavy;break;case"heavy-heavy":n=L.HeavyHeavy;break;case"heavy-light":n=L.HeavyLight;break;case"light-heavy":n=L.LightHeavy;break;case"light-light":n=L.LightLight;break;case"none":n=L.None;break;case"regular":n=L.Regular;break;case"short":n=L.Short;break;case"tick":n=L.Tick}for(const t of s.staves){const s=this.ar(t,e);switch(i){case"left":s.barLineLeft=n;break;case"right":s.barLineRight=n}}}_h(t,e,s){for(const s of t.childElements())switch(s.localName){case"midi-instrument":this.uc(s,e);break;case"swing":this.dc(s,e)}if(t.attributes.has("coda")&&e.addDirection(Qe.TargetCoda),t.attributes.has("tocoda")&&e.addDirection(Qe.JumpDaCoda),t.attributes.has("dacapo")&&e.addDirection(Qe.JumpDaCapo),t.attributes.has("dalsegno")&&e.addDirection(Qe.JumpDalSegno),t.attributes.has("fine")&&e.addDirection(Qe.TargetFine),t.attributes.has("segno")&&e.addDirection(Qe.TargetSegno),t.attributes.has("pan")){this.fc||(this.fc=[]);const e=new $;e.type=r.Balance,e.value=gi.Io(Number.parseFloat(t.attributes.get("pan"))),this.fc.push(e)}if(t.attributes.has("tempo")){this.fc||(this.fc=[]);const e=new $;e.type=r.Tempo,e.value=gi.Oo(Number.parseFloat(t.attributes.get("tempo"))),this.fc.push(e)}}dc(t,e){let s=0,i=0,n=null;for(const r of t.childElements())switch(r.localName){case"straight":return void(e.tripletFeel=rt.NoTripletFeel);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":n=this.bc(r)}n||(n=l.Eighth),n===l.Eighth?2===s&&1===i?e.tripletFeel=rt.Triplet8th:3===s&&1===i?e.tripletFeel=rt.Dotted8th:1===s&&3===i&&(e.tripletFeel=rt.Scottish8th):n===l.Sixteenth&&(2===s&&1===i?e.tripletFeel=rt.Triplet16th:3===s&&1===i?e.tripletFeel=rt.Dotted16th:1===s&&3===i&&(e.tripletFeel=rt.Scottish16th))}fc=null;mc=null;gc=null;wc=!1;yc=!1;kc=null;Sc=null;uc(t,e){let s;for(const e of t.childElements())switch(e.localName){case"midi-bank":this.fc||(this.fc=[]),s=new $,s.type=r.Bank,s.value=Number.parseInt(e.innerText,10)-1,this.fc.push(s);break;case"midi-program":this.fc||(this.fc=[]),s=new $,s.type=r.Instrument,s.value=Number.parseInt(e.innerText,10)-1,this.fc.push(s);break;case"volume":this.fc||(this.fc=[]),s=new $,s.type=r.Volume,s.value=gi.Oo(Number.parseFloat(e.innerText)),this.fc.push(s);break;case"pan":this.fc||(this.fc=[]),s=new $,s.type=r.Balance,s.value=gi.Io(Number.parseFloat(e.innerText)),this.fc.push(s)}}Qo(t,e){const s=new fe;let i=!1,n="";for(const e of t.childElements())switch(e.localName){case"root":s.name=this.Bc(e);break;case"kind":s.name=s.name+this._c(e),"yes"===e.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this.xc(e,s);break;case"degree":n+=this.Tc(e)}n&&(s.name+=i?`(${n})`:n),null===this.mc&&(this.mc=s)}Tc(t){let e="",s="",i="";for(const n of t.childElements())switch(n.localName){case"degree-value":e=n.innerText;break;case"degree-alter":switch(n.innerText){case"-1":s="♭";break;case"1":s="♯"}break;case"degree-type":i+=n.getAttribute("text","")}return`${i}${s}${e}`}Bc(t){let e="",s="";for(const i of t.childElements())switch(i.localName){case"root-step":e=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return e+s}_c(t){const e=t.getAttribute("text");let s="";if(e)s=e;else{const e=t.innerText;switch(e){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="○";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="○7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="⍉";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="♭II";break;case"Italian":s="It⁺⁶";break;case"French":case"German":s="Fr⁺⁶";break;default:s=e}}return s}xc(t,e){for(const s of t.childElements())switch(s.localName){case"frame-strings":const t=Number.parseInt(s.innerText,10);e.strings=new Array(t);for(let s=0;s<t;s++)e.strings[s]=-1;break;case"first-fret":e.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,n=null;for(const t of s.childElements())switch(t.localName){case"string":i=Number.parseInt(t.innerText,10);break;case"fret":n=Number.parseInt(t.innerText,10),i&&n>=0&&(e.strings[i-1]=n);break;case"barre":i&&n&&"start"===t.getAttribute("type")&&e.barreFrets.push(n)}}}Ko(t,e,s){let i,n,r;if(null==this.jo)for(const a of t.childElements())switch(a.localName){case"divisions":this.ko=Number.parseFloat(a.innerText);break;case"key":this.Mc(a,e,s);break;case"time":this.sr(a,e);break;case"staves":s.ensureStaveCount(Number.parseInt(a.innerText,10));break;case"clef":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.sc(s,i),r=this.ar(n,e),this.qn(a,r);break;case"staff-details":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.sc(s,i),this.vc(a,n);break;case"transpose":this.ih(a,s);break;case"measure-style":this.Nc(a,s,!1)}else for(const e of t.childElements())switch(e.localName){case"divisions":this.ko=Number.parseFloat(e.innerText);break;case"measure-style":this.Nc(e,s,!0)}}rc=null;hc=null;Pc=!1;Nc(t,e,s){for(const e of t.childElements())switch(e.localName){case"measure-repeat":if(!s){let s=null;switch(e.getAttribute("type")){case"start":switch(Number.parseInt(e.getAttribute("slashes","1"),10)){case 1:s=E.Simple;break;case 2:s=E.FirstOfDouble}break;case"stop":s=null}if(t.attributes.has("number")){this.hc=this.hc??new Map;const e=Number.parseInt(t.attributes.get("number"),10)-1;null==s?this.hc.delete(e):this.hc.set(e,s)}else this.rc=s}break;case"slash":switch(e.getAttribute("type")){case"start":this.Pc=!0;break;case"stop":this.Pc=!1}}}ih(t,e){let s=0;for(const e of t.childElements())switch(e.localName){case"chromatic":s+=Number.parseFloat(e.innerText);break;case"octave-change":s+=12*Number.parseFloat(e.innerText)}if(t.attributes.has("number")){const i=this.sc(e,Number.parseInt(t.attributes.get("number"),10)-1);this.Ec(i).transpose=s,i.displayTranspositionPitch=s}else for(const t of e.staves)this.Ec(t).transpose=s,t.displayTranspositionPitch=s}vc(t,e){for(const s of t.childElements())switch(s.localName){case"staff-lines":e.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this.Cc(s,e);break;case"capo":e.capo=Number.parseInt(s.innerText,10)}}Cc(t,e){0===e.stringTuning.tunings.length&&(e.showTablature=!0,e.showStandardNotation=!1,e.stringTuning.tunings=new Array(e.standardNotationLineCount).fill(0));const s=Number.parseInt(t.getAttribute("line"),10);let i="C",n="",r=0;for(const e of t.childElements())switch(e.localName){case"tuning-step":i=e.innerText;break;case"tuning-alter":r=Number.parseFloat(e.innerText);break;case"tuning-octave":n=e.innerText}const a=Ht.getTuningForText(i+n)+r;e.tuning[e.tuning.length-s]=a}qn(t,e){let s="s",i=0;for(const n of t.childElements())switch(n.localName){case"sign":s=n.innerText.toLowerCase();break;case"line":i=Number.parseInt(n.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(n.innerText,10)){case-2:e.clefOttava=m.M;break;case-1:e.clefOttava=m.T;break;case 1:e.clefOttava=m._;break;case 2:e.clefOttava=m.M}}switch(s){case"g":default:e.clef=P.G2;break;case"f":e.clef=P.F4;break;case"c":e.clef=3===i?P.C3:P.C4;break;case"percussion":e.clef=P.Neutral,e.staff.isPercussion=!0;break;case"tab":e.clef=P.G2,e.staff.showTablature=!0}}sr(t,e){let s=!1,i=!1;for(const n of t.childElements()){const t=n.innerText;switch(n.localName){case"beats":s||(-1===t.indexOf("+")?e.timeSignatureNumerator=Number.parseInt(t,10):e.timeSignatureNumerator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),s=!0);break;case"beat-type":i||(-1===t.indexOf("+")?e.timeSignatureDenominator=Number.parseInt(t,10):e.timeSignatureDenominator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),i=!0)}}switch(t.getAttribute("symbol","")){case"common":case"cut":e.timeSignatureCommon=!0}}nc=null;Mc(t,e,s){let i,n,r=-C.C,a="";for(const e of t.childElements())switch(e.localName){case"fifths":r=Number.parseInt(e.innerText,10);break;case"mode":a=e.innerText}if(i=-7<=r&&r<=7?r:C.C,n="minor"===a?F.Minor:F.Major,t.attributes.has("number")){const r=this.sc(s,Number.parseInt(t.attributes.get("number"),10)-1),a=this.ar(r,e);a.keySignature=i,a.keySignatureType=n}else{this.nc=[i,n];for(const t of s.staves)t.bars.length>e.index&&(t.bars[e.index].keySignature=i,t.bars[e.index].keySignatureType=n)}}Yo(t,e,s){const i=[];let n=null,a=-1,h=-1;for(const e of t.childElements())switch(e.localName){case"direction-type":const t=e.firstElement;t&&i.push(t);break;case"offset":n=Number.parseFloat(e.innerText);break;case"voice":break;case"staff":a=Number.parseInt(e.innerText,10)-1;break;case"sound":e.attributes.has("tempo")&&(h=Number.parseFloat(e.attributes.get("tempo")))}let o=null;o=a>=0?this.sc(s,a):null!==this.jo?this.jo.voice.bar.staff:this.sc(s,0);const l=o?this.ar(o,e):null,u=()=>{let t=this.zo;null!==n&&(t+=n);return t/e.calculateDuration(!1)};if(h>0){const t=new $;t.type=r.Tempo,t.value=h,t.ratioPosition=u(),this.Fc(e,t)||e.tempoAutomations.push(t)}let d="";for(const t of i)switch(t.localName){case"rehearsal":e.section=new we,e.section.marker=t.innerText;break;case"segno":e.addDirection(Qe.TargetSegno);break;case"coda":e.addDirection(Qe.TargetCoda);break;case"words":d=t.innerText;break;case"wedge":switch(t.getAttribute("type")){case"crescendo":this.gc=c.Crescendo;break;case"diminuendo":this.gc=c.Decrescendo;break;case"stop":this.gc=null}break;case"dynamics":const s=this.Ac(t);null!==s&&(this.So=s,this.ue.stylesheet.hideDynamics=!1);break;case"dashes":const i=t.getAttribute("type","start");switch(d){case"LetRing":this.wc="start"===i||"continue"===i;break;case"P.M.":this.yc="start"===i||"continue"===i}d="";break;case"pedal":const n=this.Dc(t);if(n&&l){n.ratioPosition=u();const t=l.sustainPedals.length>0&&l.sustainPedals[l.sustainPedals.length-1].pedalType!==A.Up;(n.pedalType!==A.Up||t)&&l.sustainPedals.push(n)}break;case"metronome":this.Lc(t,e,u());break;case"octave-shift":this.kc=this.Wc(t)}d&&(this.Sc=d)}Wc(t){const e=t.getAttribute("type");switch(Number.parseInt(t.getAttribute("size","8"),10)){case 15:switch(e){case"up":return m.M;case"down":return m.S;case"stop":return m.Regular;case"continue":return this.kc}break;case 8:switch(e){case"up":return m.T;case"down":return m._;case"stop":return m.Regular;case"continue":return this.kc}}return null}Lc(t,e,s){let i=null,n=-1;for(const e of t.childElements())switch(e.localName){case"beat-unit":i=this.bc(e);break;case"per-minute":n=Number.parseFloat(e.innerText)}if(null!==i&&n>0){const t=new $;t.type=r.Tempo,t.value=n*(i/4)|0,t.ratioPosition=s,this.Fc(e,t)||e.tempoAutomations.push(t)}}Fc(t,e){for(const s of t.tempoAutomations)if(e.ratioPosition===s.ratioPosition&&e.value===s.value)return!0;return!1}Dc(t){const e=new Y;switch(t.getAttribute("type")){case"start":e.pedalType=A.Down;break;case"stop":e.pedalType=A.Up;break;case"continue":e.pedalType=A.Hold;break;default:return null}return e}Ac(t){for(const e of t.childElements()){const t=e.localName.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return n[t]}}return null}qo(t){for(const e of t.childElements())if("duration"===e.localName)this.zo+=this.Rc(Number.parseFloat(e.innerText))}Jo(t){for(const e of t.childElements())if("duration"===e.localName){if(this.jo){let t=this.zo;t-=this.Rc(Number.parseFloat(e.innerText)),t<0&&(t=0),this.zo=t}}}sc(t,e){for(;t.staves.length<=e;){const e=new ke;t.addStaff(e),this.ue.masterBars.length>0&&this.ar(e,this.ue.masterBars[this.ue.masterBars.length-1])}return t.staves[e]}ar(t,e){const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<=e.index;){const e=new Q;t.addBar(e),e.previousBar&&(e.clef=e.previousBar.clef,e.clefOttava=e.previousBar.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType),null!=this.nc&&(e.keySignature=this.nc[0],e.keySignatureType=this.nc[1]);for(let t=0;t<s;t++){const t=new et;e.addVoice(t)}}return t.bars[e.index]}Oc(t,e){let s=!1;for(;t.voices.length<=e;)t.addVoice(new et),s=!0;if(s)for(const s of t.staff.bars)for(;s.voices.length<=e;)s.addVoice(new et);return t.voices[e]}Vh(t,e,s){let i=null,n=u.None,r=0,a=null,h=!1,o=0,c=0,d=-1,f=null,p=0,b=-1,m=-1,g=null,w=null,y=!1,k=null;const S="no"!==t.getAttribute("print-object","yes"),B=()=>{if(null!==i)return;h&&!this.jo&&(j.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),h=!1),h&&!w&&(j.warning("MusicXML","Cannot mix <chord /> and <rest />"),h=!1);const t=this.sc(s,o);if(h)return i=this.jo,void i.addNote(w);const B=this.ar(t,e),_=this.Oc(B,c),x=0===_.beats.length?0:_.beats[_.beats.length-1].displayEnd;let T=this.zo-x;if(T>0){if(this.jo&&this.jo.beamingMode===wt.ForceMergeWithNext&&this.jo.voice.bar.staff.index!==o&&_.beats.length>0&&_.beats[_.beats.length-1].beamingMode===wt.ForceMergeWithNext){const t=_.beats[_.beats.length-1].duration;for(;T>0;){const e=this.Ic(T,t);if(null===e)break;this.Gc(e,_),T-=e.playbackDuration}}if(T>0){const t=new Kt;t.dynamics=this.So,t.isEmpty=!0,t.duration=l.TwoHundredFiftySixth,t.overrideDisplayDuration=T,t.updateDurations(),this.Gc(t,_)}}else T<0&&j.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==f&&(d=I.toTicks(f),p>0&&(d=I.applyDot(d,2===p)));const M=new Kt;i=M,null===a?M.beamingMode=this.Ec(t).isExplicitlyBeamed?wt.ForceSplitToNext:wt.Auto:(M.beamingMode=a,this.Ec(t).isExplicitlyBeamed=!0),M.isEmpty=!1,M.dynamics=this.So,this.Pc&&(M.slashed=!0);const v=this.fc;if(this.fc=null,null!==v)for(const t of v)M.automations.push(t);const N=this.mc;this.mc=null,null!==N&&(M.chordId=N.uniqueId,_.bar.staff.hasChord(N.uniqueId)||_.bar.staff.addChord(M.chordId,N));const P=this.gc;null!==P&&(M.crescendo=P);const E=this.kc;if(null!==E&&(M.ottava=E),M.isLetRing=this.wc,M.isPalmMute=this.yc,this.Sc&&(M.text=this.Sc,this.Sc=null),null!==w&&M.addNote(w),this.Gc(M,_),null!==w){w.isVisible=S;const t=this.wo.get(s.index);null!==k?w.percussionArticulation=t.getOrCreateArticulation(k,w):y||(w.percussionArticulation=t.getOrCreateArticulation("",w))}n!==u.None?(M.graceType=n,this.$c(M,r,null,!1)):(M.tupletNumerator=b,M.tupletDenominator=m,M.dots=p,M.preferredBeamDirection=g,this.$c(M,d,f,!0)),this.zo=M.displayEnd,this.jo=M};for(const e of t.childElements())switch(e.localName){case"grace":const t=Number.parseFloat(e.getAttribute("make-time","-1"));t>=0?(r=this.Rc(t),n=u.BeforeBeat):n=u.OnBeat,"yes"===e.getAttribute("slash")&&(n=u.BeforeBeat);break;case"chord":h=!0;break;case"cue":return;case"pitch":w=this.Vc(e),y=!0;break;case"unpitched":w=this.Hc(e,s);break;case"rest":w=null,null===f&&(f=l.Whole);break;case"duration":d=this.mi(e);break;case"instrument":k=e.getAttribute("id","");break;case"voice":c=Number.parseInt(e.innerText,10),Number.isNaN(c)?(j.warning("MusicXML","Voices need to be specified as numbers"),c=0):c-=1;break;case"type":f=this.bc(e);break;case"dot":p++;break;case"accidental":null===w?j.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.Uc(e,w);break;case"time-modification":for(const t of e.childElements())switch(t.localName){case"actual-notes":b=Number.parseInt(t.innerText,10);break;case"normal-notes":m=Number.parseInt(t.innerText,10)}break;case"stem":g=this.zc(e);break;case"notehead":null===w?j.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.fh(e,w,f??l.Quarter,g??this.jc(w));break;case"staff":o=Number.parseInt(e.innerText,10)-1;break;case"beam":if("1"===e.getAttribute("number","1"))switch(e.innerText){case"begin":case"continue":a=wt.ForceMergeWithNext;break;case"end":a=wt.ForceSplitToNext}break;case"notations":B(),this.Xc(e,w,i);break;case"lyric":B(),this.yr(e,i,s);break;case"play":this.Jc(e,w)}if(y){const t=this.sc(s,o),e=this.Ec(t).transpose;if(0!==e){const t=12*w.octave+w.tone+e;w.octave=t/12|0,w.tone=t-12*w.octave}}B()}Jc(t,e){for(const s of t.childElements())if("mute"===s.localName)e&&"palm"===s.innerText&&(e.isPalmMute=!0)}static qc=71;jc(t){return t.calculateRealValue(!1,!1)<gi.qc?At.Down:At.Up}fh(t,e,s,i){"yes"===t.getAttribute("parentheses","no")&&(e.isGhost=!0);const n=t.getAttribute("filled","");let r;switch("yes"===n?r=!0:"no"===n&&(r=!1),e.style=new Xt,t.innerText){case"arrow down":e.style.noteHeadCenterOnStem=!0,this.Yc(e,s,r,at.NoteheadTriangleDownDoubleWhole,at.NoteheadTriangleDownWhole,at.NoteheadTriangleDownHalf,at.NoteheadTriangleDownBlack);break;case"arrow up":e.style.noteHeadCenterOnStem=!0,this.Yc(e,s,r,at.NoteheadTriangleUpDoubleWhole,at.NoteheadTriangleUpWhole,at.NoteheadTriangleUpHalf,at.NoteheadTriangleUpBlack);break;case"back slashed":this.Yc(e,s,r,at.NoteheadSlashedDoubleWhole2,at.NoteheadSlashedWhole2,at.NoteheadSlashedHalf2,at.NoteheadSlashedBlack2);break;case"circle dot":e.style.noteHead=at.NoteheadRoundWhiteWithDot;break;case"circle-x":this.Yc(e,s,r,at.NoteheadCircleXDoubleWhole,at.NoteheadCircleXWhole,at.NoteheadCircleXHalf,at.NoteheadCircleX);break;case"circled":this.Yc(e,s,r,at.NoteheadCircledDoubleWhole,at.NoteheadCircledWhole,at.NoteheadCircledHalf,at.NoteheadCircledBlack);break;case"cluster":this.Yc(e,s,r,at.NoteheadClusterDoubleWhole3rd,at.NoteheadClusterWhole3rd,at.NoteheadClusterHalf3rd,at.NoteheadClusterQuarter3rd);break;case"cross":this.Yc(e,s,r,at.NoteheadPlusDoubleWhole,at.NoteheadPlusWhole,at.NoteheadPlusHalf,at.NoteheadPlusBlack);break;case"diamond":this.Yc(e,s,r,at.NoteheadDiamondDoubleWhole,at.NoteheadDiamondWhole,at.NoteheadDiamondHalf,at.NoteheadDiamondBlack);break;case"do":this.Yc(e,s,r,at.NoteShapeTriangleUpWhite,at.NoteShapeTriangleUpWhite,at.NoteShapeTriangleUpWhite,at.NoteShapeTriangleUpBlack);break;case"fa":i===At.Up?this.Yc(e,s,r,at.NoteShapeTriangleRightWhite,at.NoteShapeTriangleRightWhite,at.NoteShapeTriangleRightWhite,at.NoteShapeTriangleRightBlack):this.Yc(e,s,r,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftBlack);break;case"fa up":this.Yc(e,s,r,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftWhite,at.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.Yc(e,s,r,at.NoteheadTriangleDownDoubleWhole,at.NoteheadTriangleDownWhole,at.NoteheadTriangleDownHalf,at.NoteheadTriangleDownBlack);break;case"la":case"square":this.Yc(e,s,r,at.NoteShapeSquareWhite,at.NoteShapeSquareWhite,at.NoteShapeSquareWhite,at.NoteShapeSquareBlack);break;case"left triangle":this.Yc(e,s,r,at.NoteheadTriangleRightWhite,at.NoteheadTriangleRightWhite,at.NoteheadTriangleRightWhite,at.NoteheadTriangleRightBlack);break;case"mi":this.Yc(e,s,r,at.NoteShapeDiamondWhite,at.NoteShapeDiamondWhite,at.NoteShapeDiamondWhite,at.NoteShapeDiamondBlack);break;case"none":e.style.noteHead=at.NoteheadNull;break;case"normal":this.Yc(e,s,r,at.NoteheadDoubleWhole,at.NoteheadWhole,at.NoteheadHalf,at.NoteheadBlack);break;case"re":this.Yc(e,s,r,at.NoteShapeMoonWhite,at.NoteShapeMoonWhite,at.NoteShapeMoonWhite,at.NoteShapeMoonBlack);break;case"rectangle":this.Yc(e,s,r,at.NoteheadSquareWhite,at.NoteheadSquareWhite,at.NoteheadSquareWhite,at.NoteheadSquareBlack);break;case"slash":this.Yc(e,s,r,at.NoteheadSlashWhiteWhole,at.NoteheadSlashWhiteWhole,at.NoteheadSlashWhiteHalf,at.NoteheadSlashHorizontalEnds);break;case"slashed":this.Yc(e,s,r,at.NoteheadSlashedDoubleWhole1,at.NoteheadSlashedWhole1,at.NoteheadSlashedHalf1,at.NoteheadSlashedBlack1);break;case"so":this.Yc(e,s,r,at.NoteShapeRoundWhite,at.NoteShapeRoundWhite,at.NoteShapeRoundWhite,at.NoteShapeRoundBlack);break;case"ti":this.Yc(e,s,r,at.NoteShapeTriangleRoundWhite,at.NoteShapeTriangleRoundWhite,at.NoteShapeTriangleRoundWhite,at.NoteShapeTriangleRoundBlack);break;case"triangle":this.Yc(e,s,r,at.NoteheadTriangleUpDoubleWhole,at.NoteheadTriangleUpWhole,at.NoteheadTriangleUpHalf,at.NoteheadTriangleUpBlack);break;case"x":this.Yc(e,s,r,at.NoteheadXDoubleWhole,at.NoteheadXWhole,at.NoteheadXHalf,at.NoteheadXBlack)}}Ic(t,e){let s=I.toTicks(e);for(;s>t;){if(e===l.TwoHundredFiftySixth)return null;e*=2,s=I.toTicks(e)}const i=new Kt;return i.dynamics=this.So,i.isEmpty=!1,i.duration=e,i.overrideDisplayDuration=s,i.updateDurations(),i}Gc(t,e){if(e.beats.length>0){const s=e.beats[e.beats.length-1];s.nextBeat=t,t.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==u.None;)i=i.index>0?i.previousBeat:null;null!==i&&(t.displayStart=i.displayEnd)}e.addBeat(t)}Rc(t){return t*I.QuarterTime/this.ko}bc(t){switch(t.innerText){case"1024th":case"512th":case"256th":return l.TwoHundredFiftySixth;case"128th":return l.OneHundredTwentyEighth;case"64th":return l.SixtyFourth;case"32nd":return l.ThirtySecond;case"16th":return l.Sixteenth;case"eighth":return l.Eighth;case"quarter":return l.Quarter;case"half":return l.Half;case"whole":return l.Whole;case"breve":return l.DoubleWhole;case"long":return l.QuadrupleWhole}return null}static Kc=[l.TwoHundredFiftySixth,l.OneHundredTwentyEighth,l.SixtyFourth,l.ThirtySecond,l.Sixteenth,l.Eighth,l.Quarter,l.Half,l.Whole,l.DoubleWhole,l.QuadrupleWhole];static Qc=gi.Kc.map(t=>I.toTicks(t));$c(t,e,s,i){if(!s)for(let t=0;t<gi.Kc.length;t++){if(!(e>=gi.Qc[t]))break;s=gi.Kc[t]}t.duration=s??l.Sixteenth,i&&(t.overrideDisplayDuration=e),t.updateDurations()}yr(t,e,s){const i=this.wo.get(s.index).getLyricLine(t.getAttribute("number",""));for(null===e.lyrics&&(e.lyrics=[]);e.lyrics.length<=i;)e.lyrics.push("");for(const s of t.childElements())switch(s.localName){case"text":e.lyrics[i]?e.lyrics[i]+=` ${s.innerText}`:e.lyrics[i]=s.innerText;break;case"elision":e.lyrics[i]+=s.innerText}}Xc(t,e,s){for(const i of t.childElements())switch(i.localName){case"tied":e&&this.Zc(i,e,s.voice.bar.staff);break;case"slur":e&&this.Pr(i,e);break;case"glissando":e&&this.tl(i,e);break;case"slide":e&&this.el(i,e);break;case"ornaments":e&&this.sl(i,e);break;case"technical":this.il(i,e,s);break;case"articulations":e&&this.oh(i,e);break;case"dynamics":const t=this.Ac(i);null!==t&&(s.dynamics=t,this.So=t);break;case"fermata":this.Ah(i,s);break;case"arpeggiate":this.nl(i,s)}}Ec(t){if(!this.yo.has(t)){const e=new pi;return this.yo.set(t,e),e}return this.yo.get(t)}tl(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Ec(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=w.Shift}}}Pr(t,e){const s=t.getAttribute("number","1"),i=this.Ec(e.beat.voice.bar.staff);switch(t.getAttribute("type")){case"start":i.slurStarts.set(s,e);break;case"stop":if(i.slurStarts.has(s)){e.isSlurDestination=!0;const t=i.slurStarts.get(s);t.slurDestination=e,e.slurOrigin=t,i.slurStarts.delete(s)}}}nl(t,e){switch(t.getAttribute("direction","down")){case"down":e.brushType=o.ArpeggioDown;break;case"up":e.brushType=o.ArpeggioUp}}Ah(t,e){let s;switch(t.innerText){case"normal":default:s=Pt.Medium;break;case"angled":s=Pt.Short;break;case"square":s=Pt.Long}e.fermata=new me,e.fermata.type=s}oh(t,e){for(const s of t.childElements())switch(s.localName){case"accent":e.accentuated=d.Normal;break;case"strong-accent":e.accentuated=d.Heavy;break;case"staccato":e.isStaccato=!0;break;case"tenuto":e.accentuated=d.Tenuto}}il(t,e,s){const i=[];for(const n of t.childElements())switch(n.localName){case"up-bow":s.pickStroke=ot.Up;break;case"down-bow":s.pickStroke=ot.Down;break;case"harmonic":break;case"fingering":e&&(e.leftHandFinger=this.rl(n));break;case"pluck":e&&(e.rightHandFinger=this.rl(n));break;case"fret":e&&(e.fret=Number.parseInt(n.innerText,10));break;case"string":e&&(e.string=s.voice.bar.staff.tuning.length-Number.parseInt(n.innerText,10)+1);break;case"hammer-on":case"pull-off":e&&(e.isHammerPullOrigin=!0);break;case"bend":i.push(n);break;case"tap":s.tap=!0;break;case"smear":e&&(e.vibrato=y.Slight);break;case"golpe":switch(n.getAttribute("placement","above")){case"above":s.golpe=ft.Finger;break;case"below":s.golpe=ft.Thumb}}e&&i.length>0&&this.al(i,e)}al(t,e){const s=V.MaxPosition/t.length;let i=0,n=0,r=!0;for(const a of t){const t=a.findChildElement("bend-alter");if(t){const h=Math.round(2*Math.abs(Number.parseFloat(t.innerText)));a.findChildElement("pre-bend")?r?(i+=h,e.addBendPoint(new V(n,i)),n+=s,e.addBendPoint(new V(n,i)),r=!1):n+=s:a.findChildElement("release")?(r&&(i+=h),e.addBendPoint(new V(n,i)),n+=s,i-=h,e.addBendPoint(new V(n,i)),r=!1):(e.addBendPoint(new V(n,i)),i+=h,n+=s,e.addBendPoint(new V(n,i)),r=!1)}}}rl(t){switch(t.innerText){case"0":return f.NoOrDead;case"1":case"p":case"t":return f.Thumb;case"2":case"i":return f.IndexFinger;case"3":case"m":return f.MiddleFinger;case"4":case"a":return f.AnnularFinger;case"5":case"c":return f.LittleFinger}return f.Unknown}hl=-1;sl(t,e){let s=-1;for(const i of t.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),e.isStringed?e.trillValue=e.stringTuning+s:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+s);break;case"turn":e.ornament=lt.Turn;break;case"inverted-turn":e.ornament=lt.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this.hl=s):this.hl>0?"stop"===i.getAttribute("type")?this.hl=-1:e.isStringed?e.trillValue=e.stringTuning+this.hl:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+this.hl):e.vibrato=y.Slight;break;case"mordent":e.ornament=lt.LowerMordent;break;case"inverted-mordent":e.ornament=lt.UpperMordent;break;case"tremolo":switch(i.innerText){case"1":e.beat.tremoloSpeed=l.Eighth;break;case"2":e.beat.tremoloSpeed=l.Sixteenth;break;case"3":e.beat.tremoloSpeed=l.ThirtySecond}}}el(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Ec(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=w.Shift}}}Zc(t,e,s){const i=t.getAttribute("type"),n=t.getAttribute("number",""),r=this.Ec(s);if("start"===i){if(n){if(r.tieStartIds.has(n)){const t=r.tieStartIds.get(n);r.tieStarts.delete(t)}r.tieStartIds.set(n,e)}r.tieStarts.add(e)}else if("stop"===i&&!e.isTieDestination){let t=null;if(n){if(!r.tieStartIds.has(n))return;t=r.tieStartIds.get(n),r.tieStartIds.delete(n),r.tieStarts.delete(e)}else{const s=this.ol(e);for(const e of r.tieStarts)if(this.ol(e)===s){t=e,r.tieStarts.delete(t);break}}if(!t)return;e.isTieDestination=!0,e.tieOrigin=t}}zc(t){switch(t.innerText){case"down":return At.Down;case"up":return At.Up;default:return null}}Uc(t,e){switch(t.innerText){case"sharp":e.accidentalMode=b.ForceSharp;break;case"natural":e.accidentalMode=b.ForceNatural;break;case"flat":e.accidentalMode=b.ForceFlat;break;case"double-sharp":e.accidentalMode=b.ForceDoubleSharp;break;case"flat-flat":e.accidentalMode=b.ForceDoubleFlat}}ol(t){return 12*t.octave+t.tone}mi(t){return this.Rc(Number.parseFloat(t.innerText))}Hc(t,e){let s="",i=0;for(const e of t.childElements())switch(e.localName){case"display-step":s=e.innerText;break;case"display-octave":i=Number.parseInt(e.innerText,10)+1}const n=new Jt;if(""===s)n.octave=0,n.tone=0;else{const t=12*i+(Ht.getToneForText(s)?.noteValue??0);n.octave=t/12|0,n.tone=t-12*n.octave}return n}Vc(t){let e="",s=0,i=0;for(const n of t.childElements())switch(n.localName){case"step":e=n.innerText;break;case"alter":s=Number.parseFloat(n.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(n.innerText,10)+1}s|=0;const n=12*i+(Ht.getToneForText(e)?.noteValue??0)+s,r=new Jt;return r.octave=n/12|0,r.tone=n-12*r.octave,r}Yc(t,e,s,i,n,r,a){if(void 0===s)switch(e){case l.QuadrupleWhole:case l.DoubleWhole:t.style.noteHead=i;break;case l.Whole:t.style.noteHead=n;break;case l.Half:t.style.noteHead=r;break;default:t.style.noteHead=a}else if(!0===s)t.style.noteHead=a;else switch(e){case l.QuadrupleWhole:case l.DoubleWhole:t.style.noteHead=i;break;case l.Whole:t.style.noteHead=n;break;case l.Half:default:t.style.noteHead=r}}}class wi{si;cl=0;ll=0;count=0;constructor(t){this.si=new Float32Array(t)}clear(){this.ll=0,this.cl=0,this.count=0,this.si=new Float32Array(this.si.length)}write(t,e,s){let i=0;s>this.si.length-this.count&&(s=this.si.length-this.count);const n=Math.min(this.si.length-this.cl,s);return this.si.set(t.subarray(e,e+n),this.cl),this.cl+=n,this.cl%=this.si.length,i+=n,i<s&&(this.si.set(t.subarray(e+i,e+i+s-i),this.cl),this.cl+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const n=Math.min(this.si.length-this.ll,s);return t.set(this.si.subarray(this.ll,this.ll+n),e),i+=n,this.ll+=n,this.ll%=this.si.length,i<s&&(t.set(this.si.subarray(this.ll,this.ll+s-i),e+i),this.ll+=s-i,i=s),this.count-=i,i}}class yi{static CmdOutputPrefix="alphaSynth.output.";static CmdOutputAddSamples=`${yi.CmdOutputPrefix}addSamples`;static CmdOutputPlay=`${yi.CmdOutputPrefix}play`;static CmdOutputPause=`${yi.CmdOutputPrefix}pause`;static CmdOutputResetSamples=`${yi.CmdOutputPrefix}resetSamples`;static CmdOutputStop=`${yi.CmdOutputPrefix}stop`;static CmdOutputSampleRequest=`${yi.CmdOutputPrefix}sampleRequest`;static CmdOutputSamplesPlayed=`${yi.CmdOutputPrefix}samplesPlayed`;static preferredSampleRate=0;ul;get sampleRate(){return yi.preferredSampleRate}open(){j.debug("AlphaSynth","Initializing synth worker"),this.ul=eu.globalThis,this.ul.addEventListener("message",this.dl.bind(this)),this.ready.trigger()}destroy(){this.ul.postMessage({cmd:"alphaSynth.output.destroy"})}dl(t){const e=t.data;switch(e.cmd){case yi.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case yi.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples)}}ready=new Te;samplesPlayed=new Me;sampleRequest=new Te;addSamples(t){this.ul.postMessage({cmd:"alphaSynth.output.addSamples",samples:eu.prepareForPostMessage(t)})}play(){this.ul.postMessage({cmd:"alphaSynth.output.play"})}pause(){this.ul.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this.ul.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class ki{device;constructor(t){this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}isDefault=!1}class Si{static fl=[];static findKnownDevice(t){return Si.fl.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in eu.globalThis)return new AudioContext;if("webkitAudioContext"in eu.globalThis)return new webkitAudioContext;throw new R(t.AlphaTabErrorType.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in Si.createAudioContext()||(j.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await Si.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(t){j.warning("WebAudio","Output device permission rejected",t)}const t=await navigator.mediaDevices.enumerateDevices();let e="",s="";const i=new Map;for(const n of t)"audiooutput"===n.kind&&(i.set(n.groupId,new ki(n)),"default"!==n.deviceId&&""!==n.deviceId||(e=n.groupId,s=n.deviceId));const n=Array.from(i.values());let r=n.find(t=>t.deviceId===s);return r||(r=n.find(t=>t.device.groupId===e)),!r&&n.length>0&&(r=n[0]),r&&(r.isDefault=!0),Si.fl=n,n}catch(t){return j.error("WebAudio","Failed to enumerate output devices",t),[]}}}class Bi{static BufferSize=4096;static PreferredSampleRate=44100;context=null;buffer=null;source=null;pl;get sampleRate(){return this.context?this.context.sampleRate:Bi.PreferredSampleRate}activate(t){this.context||(this.context=Si.createAudioContext()),"suspended"!==this.context.state&&"interrupted"!==this.context.state||(j.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{j.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),t&&t()},t=>{j.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${t}`)}))}bl(){const t=navigator.userAgent;if(-1!==t.indexOf("iPhone")||-1!==t.indexOf("iPad")){const t=Si.createAudioContext(),e=t.createBuffer(1,1,Bi.PreferredSampleRate),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect(0),t.close()}}open(t){this.bl(),this.context=Si.createAudioContext();"suspended"===this.context.state&&this.ml()}ml(){this.pl=(()=>{this.activate(()=>{this.gl()})}).bind(this),document.body.addEventListener("touchend",this.pl,!1),document.body.addEventListener("click",this.pl,!1)}gl(){const t=this.pl;t&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))}play(){const t=this.context;this.activate(),this.buffer=t.createBuffer(2,Bi.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this.gl()}ready=new Te;samplesPlayed=new Me;sampleRequest=new Te;onSamplesPlayed(t){this.samplesPlayed.trigger(t)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return Si.enumerateOutputDevices()}async setOutputDevice(t){await Si.checkSinkIdSupport()&&(t?await this.context.setSinkId(t.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await Si.checkSinkIdSupport())return null;const t=this.context.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=Si.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(j.warning("WebAudio","Could not find output device in device list",t,s),null)}}class _i{static wl=!1;static init(){_i.wl||(_i.wl=!0,registerProcessor("alphatab",class t extends AudioWorkletProcessor{static BufferSize=4096;yl=new Float32Array(0);kl;Sl=0;Bl=0;_l=!1;constructor(e){super(e),j.debug("WebAudio","creating processor"),this.Sl=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this.kl=new wi(t.BufferSize*this.Sl),this.port.onmessage=this.dl.bind(this)}dl(t){const e=t.data;switch(e.cmd){case yi.CmdOutputAddSamples:const t=e.samples;this.kl.write(t,0,t.length),this.Bl--;break;case yi.CmdOutputResetSamples:this.kl.clear();break;case yi.CmdOutputStop:this._l=!0}}process(t,e,s){if(1!==e.length&&2!==e[0].length)return!1;const i=e[0][0],n=e[0][1];if(!i||!n)return!0;const r=i.length+n.length;let a=this.yl;a.length!==r&&(a=new Float32Array(r),this.yl=a);const h=this.kl.read(a,0,Math.min(a.length,this.kl.count));let o=0;const c=Math.min(i.length,h);for(let t=0;t<c;t++)i[t]=a[o++],n[t]=a[o++];if(h<i.length)for(let t=h;t<i.length;t++)i[t]=0,n[t]=0;return this.port.postMessage({cmd:yi.CmdOutputSamplesPlayed,samples:h/Gt.AudioChannels}),this.xl(),this.kl.count>0||!this._l}xl(){const e=this.Sl/2|0,s=e*t.BufferSize;if(this.kl.count+this.Bl*t.BufferSize<s){for(let t=0;t<e;t++)this.port.postMessage({cmd:yi.CmdOutputSampleRequest});this.Bl+=e}}}))}}class xi extends Bi{Tl=null;Ml=0;vl;constructor(t){super(),this.vl=t}open(t){super.open(t),this.Ml=t,this.onReady()}play(){super.play();const t=this.context;eu.createAudioWorklet(t,this.vl).then(()=>{this.Tl=new AudioWorkletNode(t,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this.Ml}}),this.Tl.port.onmessage=this.dl.bind(this),this.source.connect(this.Tl),this.source.start(0),this.Tl.connect(t.destination)},t=>{j.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}dl(t){const e=t.data;switch(e.cmd){case yi.CmdOutputSamplesPlayed:this.onSamplesPlayed(e.samples);break;case yi.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this.Tl&&(this.Tl.port.postMessage({cmd:yi.CmdOutputStop}),this.Tl.port.onmessage=null,this.Tl.disconnect()),this.Tl=null}addSamples(t){this.Tl?.port.postMessage({cmd:yi.CmdOutputAddSamples,samples:eu.prepareForPostMessage(t)})}resetSamples(){this.Tl?.port.postMessage({cmd:yi.CmdOutputResetSamples})}}!function(t){t[t.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",t[t.MultiTrack=1]="MultiTrack"}(es||(es={}));class Ti{events=[];addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0;){if(!(this.events[e-1].tick>t.tick))break;e--}this.events.splice(e,0,t)}}writeTo(t){const e=Ie.empty();let s=0;for(const t of this.events){const i=t.tick-s;Mi.writeVariableInt(e,i),t.writeTo(e),s=t.tick}const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const n=e.toArray();he.writeInt32BE(t,n.length),t.write(n,0,n.length)}}class Mi{format=es.SingleTrackMultiChannel;division=I.QuarterTime;get events(){if(1===this.tracks.length)return this.tracks[0].events;const t=[];for(const t of this.tracks)this.events.push(...t.events);return t.sort((t,e)=>t.tick-e.tick),t}tracks=[];Nl(t){for(;this.tracks.length<t;)this.tracks.push(new Ti)}addEvent(t){this.format===es.SingleTrackMultiChannel?(this.Nl(1),this.tracks[0].addEvent(t)):(this.Nl(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=Ie.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),he.writeInt32BE(t,6),he.writeInt16BE(t,this.format),he.writeInt16BE(t,this.tracks.length),he.writeInt16BE(t,this.division);for(const e of this.tracks)e.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do{s[i++]=127&e,e>>=7}while(e>0);for(;i>0;)i--,i>0?t.writeByte(128|s[i]):t.writeByte(s[i])}}!function(t){t[t.TimeSignature=88]="TimeSignature",t[t.NoteOn=128]="NoteOn",t[t.NoteOff=144]="NoteOff",t[t.ControlChange=176]="ControlChange",t[t.ProgramChange=192]="ProgramChange",t[t.TempoChange=81]="TempoChange",t[t.PitchBend=224]="PitchBend",t[t.PerNotePitchBend=96]="PerNotePitchBend",t[t.EndOfTrack=47]="EndOfTrack",t[t.AlphaTabRest=241]="AlphaTabRest",t[t.AlphaTabMetronome=242]="AlphaTabMetronome",t[t.SystemExclusive=240]="SystemExclusive",t[t.SystemExclusive2=247]="SystemExclusive2",t[t.Meta=255]="Meta"}(ss||(ss={}));class vi{track;tick;type;constructor(t,e,s){this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class Ni extends vi{numerator;denominatorIndex;midiClocksPerMetronomeClick;thirtySecondNodesInQuarter;constructor(t,e,s,i,n,r){super(t,e,ss.TimeSignature),this.track=t,this.tick=e,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=n,this.thirtySecondNodesInQuarter=r}writeTo(t){t.writeByte(255),t.writeByte(88),Mi.writeVariableInt(t,4),t.writeByte(255&this.numerator),t.writeByte(255&this.denominatorIndex),t.writeByte(255&this.midiClocksPerMetronomeClick),t.writeByte(255&this.thirtySecondNodesInQuarter)}}class Pi extends vi{static AlphaTabManufacturerId=125;static MetronomeEventId=0;static RestEventId=1;writeTo(t){t.writeByte(240);const e=Ie.withCapacity(16);e.writeByte(Pi.AlphaTabManufacturerId),this.writeEventData(e),e.writeByte(247),Mi.writeVariableInt(t,e.length),e.copyTo(t)}}class Ei extends Pi{metronomeNumerator;metronomeDurationInTicks;metronomeDurationInMilliseconds;isMetronome=!0;constructor(t,e,s,i,n){super(t,e,ss.AlphaTabMetronome),this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=n,this.metronomeDurationInTicks=i}writeEventData(t){t.writeByte(Pi.MetronomeEventId),t.writeByte(this.metronomeNumerator),he.writeInt32LE(t,this.metronomeDurationInTicks),he.writeInt32LE(t,this.metronomeDurationInMilliseconds)}}class Ci extends Pi{channel;constructor(t,e,s){super(t,e,ss.AlphaTabRest),this.channel=s}writeEventData(t){t.writeByte(Pi.RestEventId),t.writeByte(this.channel)}}class Fi extends vi{channel;noteKey;noteVelocity;constructor(t,e,s,i,n,r){super(t,e,s),this.channel=i,this.noteKey=n,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Ai extends Fi{constructor(t,e,s,i,n){super(t,e,ss.NoteOn,s,i,n)}writeTo(t){t.writeByte(15&this.channel|144),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Di extends Fi{constructor(t,e,s,i,n){super(t,e,ss.NoteOff,s,i,n)}writeTo(t){t.writeByte(15&this.channel|128),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Li extends vi{channel;controller;value;constructor(t,e,s,i,n){super(t,e,ss.ControlChange),this.channel=s,this.controller=i,this.value=n}writeTo(t){t.writeByte(15&this.channel|176),t.writeByte(255&this.controller),t.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class Wi extends vi{channel;program;constructor(t,e,s,i){super(t,e,ss.ProgramChange),this.channel=s,this.program=i}writeTo(t){t.writeByte(15&this.channel|192),t.writeByte(255&this.program)}get data1(){return this.program}}class Ri extends vi{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(t){this.beatsPerMinute=6e7/t}beatsPerMinute=0;constructor(t,e){super(0,t,ss.TempoChange),this.microSecondsPerQuarterNote=e}writeTo(t){t.writeByte(255),t.writeByte(81),t.writeByte(3),t.writeByte(this.microSecondsPerQuarterNote>>16&255),t.writeByte(this.microSecondsPerQuarterNote>>8&255),t.writeByte(255&this.microSecondsPerQuarterNote)}}class Oi extends vi{channel;value;constructor(t,e,s,i){super(t,e,ss.PitchBend),this.channel=s,this.value=i}writeTo(t){t.writeByte(15&this.channel|224),t.writeByte(127&this.value),t.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class Ii extends vi{channel;noteKey;value;constructor(t,e,s,i,n){super(t,e,ss.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=n}writeTo(e){throw new R(t.AlphaTabErrorType.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Gi extends vi{constructor(t,e){super(t,e,ss.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class $i{eventIndex;event;isMetronome;time=0;constructor(t,e){this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===ss.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,n){const r=new Ei(0,e,s,i,n);return new $i(t,r)}}class Vi{masterBarIndex=0;masterBarOccurence=0;synthBpm=0;synthTime=0;synthTick=0;syncTime=0;syncBpm=0;updateSyncBpm(t,e){const s=(t-this.synthTime)/(e-this.syncTime)*this.synthBpm;this.syncBpm=s}}class Hi{bpm;ticks;time;constructor(t,e,s){this.bpm=t,this.ticks=e,this.time=s}}class Ui{tempoChanges=[];tempoChangeIndex=0;syncPoints=[];firstProgramEventPerChannel=new Map;firstTimeSignatureNumerator=0;firstTimeSignatureDenominator=0;synthData=[];division=I.QuarterTime;eventIndex=0;currentTime=0;syncPointIndex=0;playbackRange=null;playbackRangeStartTime=0;playbackRangeEndTime=0;endTick=0;endTime=0;currentTempo=0;syncPointTempo=0}class zi{Pl;El;Cl;Fl=null;Al=null;get isPlayingMain(){return this.El===this.Cl}get isPlayingOneTimeMidi(){return this.El===this.Fl}get isPlayingCountIn(){return this.El===this.Al}constructor(t){this.Pl=t,this.Cl=new Ui,this.El=this.Cl}get mainPlaybackRange(){return this.Cl.playbackRange}set mainPlaybackRange(t){this.Cl.playbackRange=t,t&&(this.Cl.playbackRangeStartTime=this.Dl(this.Cl,t.startTick,1),this.Cl.playbackRangeEndTime=this.Dl(this.Cl,t.endTick,1))}isLooping=!1;get currentTime(){return this.El.currentTime/this.playbackSpeed}get currentEndTick(){return this.El.endTick}get currentEndTime(){return this.El.endTime/this.playbackSpeed}get currentTempo(){return this.El.currentTempo}get modifiedTempo(){return this.El.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this.El.syncPointTempo}get currentSyncPoints(){return this.El.syncPoints}playbackSpeed=1;mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this.Cl.playbackRangeStartTime?t=this.Cl.playbackRangeStartTime:t>this.Cl.playbackRangeEndTime&&(t=this.Cl.playbackRangeEndTime)),t>this.Cl.currentTime)this.Ll(t-this.Cl.currentTime);else if(t<this.Cl.currentTime){if(this.Cl.currentTime=0,this.Cl.eventIndex=0,this.Cl.syncPointIndex=0,this.Cl.tempoChangeIndex=0,this.Cl.currentTempo=this.Cl.tempoChanges[0].bpm,this.Cl.syncPointTempo=this.Cl.syncPoints.length>0?this.Cl.syncPoints[0].syncBpm:this.Cl.currentTempo,this.isPlayingMain){const t=this.Pl.metronomeVolume;this.Pl.noteOffAll(!0),this.Pl.resetSoft(),this.Pl.setupMetronomeChannel(t)}this.Ll(t)}}Ll(t){if(t<=0)return;const e=Date.now(),s=this.Cl.currentTime+t;if(this.isPlayingMain)for(;this.Cl.currentTime<s;)this.Wl(s-this.Cl.currentTime)&&this.Pl.synthesizeSilent(Gt.MicroBufferSize);this.Cl.currentTime=s;const i=Date.now()-e;j.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this.Fl=this.createStateFromFile(t),this.El=this.Fl}instrumentPrograms=new Set;percussionKeys=new Set;loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this.Cl=this.createStateFromFile(t),this.El=this.Cl}createStateFromFile(t){const e=new Ui;this.percussionKeys.add(Gt.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,n=0,r=0,a=0,h=0,o=0,c=0,l=0;for(const u of t.events){const d=new $i(e.synthData.length,u);e.synthData.push(d);const f=u.tick-l;if(i+=f,n+=f*(6e4/(s*t.division)),d.time=n,l=u.tick,a>0)for(;o<i;){const t=$i.newMetronomeEvent(e.synthData.length,o,Math.floor(o/a)%r,a,h);e.synthData.push(t),t.time=c,o+=a,c+=h}if(u.type===ss.TempoChange){s=u.beatsPerMinute,e.tempoChanges.push(new Hi(s,i,n)),h=a*(6e4/(s*t.division))}else if(u.type===ss.TimeSignature){const i=u,n=Math.pow(2,i.denominatorIndex);r=i.numerator,a=e.division*(4/n)|0,h=a*(6e4/(s*t.division)),0===e.firstTimeSignatureDenominator&&(e.firstTimeSignatureNumerator=i.numerator,e.firstTimeSignatureDenominator=n)}else if(u.type===ss.ProgramChange){const t=u,s=t.channel;e.firstProgramEventPerChannel.has(s)||e.firstProgramEventPerChannel.set(s,d);s===Gt.PercussionChannel||this.instrumentPrograms.add(t.program)}else if(u.type===ss.NoteOn){const t=u;t.channel===Gt.PercussionChannel&&this.percussionKeys.add(t.noteKey)}}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),e.endTime=n,e.endTick=i,e}fillMidiEventQueue(){return this.Wl(-1)}fillMidiEventQueueToEndTime(t){for(;this.Cl.currentTime<t;)this.Wl(t-this.Cl.currentTime)&&this.Pl.synthesizeSilent(Gt.MicroBufferSize);let e=!1;for(this.El.currentTime=t;this.El.eventIndex<this.El.synthData.length&&this.El.synthData[this.El.eventIndex].time<this.El.currentTime;){const t=this.El.synthData[this.El.eventIndex];this.Pl.dispatchEvent(t),this.El.eventIndex++,e=!0}return e}Wl(t){let e=Gt.MicroBufferSize/this.Pl.outSampleRate*1e3*this.playbackSpeed,s=this.Rl;t>0&&(t<e&&(e=t),s=Math.min(this.Rl,this.El.currentTime+t));let i=!1;for(this.El.currentTime+=e;this.El.eventIndex<this.El.synthData.length&&this.El.synthData[this.El.eventIndex].time<this.El.currentTime&&this.El.currentTime<s;)this.Pl.dispatchEvent(this.El.synthData[this.El.eventIndex]),this.El.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this.Dl(this.Cl,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this.Cl;if(t.sort((t,e)=>t.synthTick-e.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,n=0,r=0;for(let a=0;a<t.length;a++){const h=t[a];let o,c,l,u=0;if(0===a)o=s,c=0,l=0;else{const e=t[a-1];o=e.syncBpm,c=e.syncTime,l=e.synthTick}for(;r<e.tempoChanges.length&&e.tempoChanges[r].ticks<=h.synthTick;){if(u=e.tempoChanges[r].ticks-i,u>0){i+=u,n+=u*(6e4/(s*e.division));const t=(i-l)*((h.syncTime-c)/(h.synthTick-l))+c,r=new Vi;r.synthTick=i,r.synthBpm=s,r.synthTime=n,r.syncTime=t,r.syncBpm=o}s=e.tempoChanges[r].bpm,r++}u=h.synthTick-i,i+=u,n+=u*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this.El;if(0===e.tempoChanges.length)return 0;t*=this.playbackSpeed,this.Ol(e,t);const s=e.tempoChanges[e.tempoChangeIndex],i=(t-s.time)/(6e4/(s.bpm*e.division))|0;return s.ticks+i+1}currentUpdateCurrentTempo(t){this.Ol(this.Cl,t*this.playbackSpeed)}Ol(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,0===t.syncPoints.length&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this.Il(this.Cl,t)}Il(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this.Cl,i=s.syncPoints;if(t<0||0===i.length)return t;this.Il(this.Cl,t);const n=Math.min(s.syncPointIndex,i.length-1),r=i[n],a=t-r.syncTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.syncTime-r.syncTime);h=(t.synthTime-r.synthTime)*e}else{const t=a/(e-r.syncTime);h=(s.endTime-r.synthTime)*t}return(r.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this.Cl,i=s.syncPoints;if(t<0||0===i.length)return t;t*=this.playbackSpeed;let n=Math.min(s.syncPointIndex,i.length-1);for(t<i[n].synthTime&&(n=0);n+1<i.length&&i[n+1].synthTime<=t;)n++;const r=i[n],a=t-r.synthTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.synthTime-r.synthTime),s=t.syncTime-r.syncTime;h=r.syncTime+s*e}else{const t=a/(s.endTime-r.synthTime),i=e-r.syncTime;h=r.syncTime+i*t}return h}Dl(t,e,s){let i=0,n=120,r=0;for(const s of t.tempoChanges){if(e<s.ticks)break;i=s.time,n=s.bpm,r=s.ticks}return i+=(e-=r)*(6e4/(n*t.division)),i/s}get Rl(){return this.isPlayingMain&&this.mainPlaybackRange?this.El.playbackRangeEndTime:this.El.endTime}get isFinished(){return this.El.currentTime>=this.Rl}stop(){this.isPlayingMain&&this.mainPlaybackRange?this.El.currentTime=this.mainPlaybackRange.startTick:this.El.currentTime=0,this.El.eventIndex=0}resetOneTimeMidi(){this.Fl=null,this.El=this.Cl}resetCountIn(){this.Al=null,this.El=this.Cl}startCountIn(){this.generateCountInMidi(),this.El=this.Al,this.stop(),this.Pl.noteOffAll(!0)}generateCountInMidi(){const t=new Ui;t.division=this.Cl.division;let e=120,s=4,i=4;0===this.Cl.eventIndex?(e=this.Cl.tempoChanges[0].bpm,s=this.Cl.firstTimeSignatureNumerator,i=this.Cl.firstTimeSignatureDenominator):(e=this.Pl.currentTempo,s=this.Pl.timeSignatureNumerator,i=this.Pl.timeSignatureDenominator),t.tempoChanges.push(new Hi(e,0,0));const n=t.division*(4/i)|0,r=n*(6e4/(e*this.Cl.division));let a=0,h=0;for(let e=0;e<s;e++){const s=$i.newMetronomeEvent(t.synthData.length,a,e,n,r);t.synthData.push(s),s.time=h,a+=n,h+=r}t.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),t.endTime=h,t.endTick=a,t.currentTempo=e,t.syncPointTempo=e,this.Al=t}}!function(t){t[t.Paused=0]="Paused",t[t.Playing=1]="Playing"}(is||(is={}));class ji{state;stopped;constructor(t,e){this.state=t,this.stopped=e}}class Xi{currentTime;endTime;currentTick;endTick;isSeek;originalTempo=0;modifiedTempo=0;constructor(t,e,s,i,n,r,a){this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=n,this.originalTempo=r,this.modifiedTempo=a}}class Ji{static HeaderSize=8;id="";size=0;static load(t,e,s){if(t&&Ji.HeaderSize>t.size)return!1;if(s.position+Ji.HeaderSize>=s.length)return!1;if(e.id=he.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)return!1;if(e.size=he.readUInt32LE(s),t&&Ji.HeaderSize+e.size>t.size)return!1;t&&(t.size-=Ji.HeaderSize+e.size);const i="RIFF"===e.id,n="LIST"===e.id;return(!i||!t)&&(!i&&!n||(e.id=he.read8BitStringLength(s,4),!(e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)&&(e.size-=4,!0)))}}class qi{packetData;isBeginningOfStream;isEndOfStream;granulePosition;constructor(t,e,s,i){this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}!function(t){t[t.ContinuesPacket=1]="ContinuesPacket",t[t.BeginningOfStream=2]="BeginningOfStream",t[t.EndOfStream=4]="EndOfStream"}(ns||(ns={}));class Yi{an;constructor(t){this.an=t}read(){const t=[];for(;this.Gl(t););return t}Gl(t){return!!this.$l()&&this.Vl(t)}$l(){for(let t=0;t<65536;t++){if(1399285583===he.readInt32LE(this.an))return!0;this.an.position-=3}return!1}Vl(e){const s=this.an.readByte();if(-1===s||0!==s)return!1;const i=this.an.readByte(),n=he.readInt64LE(this.an);this.an.skip(4),this.an.skip(4),this.an.skip(4);const r=this.an.readByte();if(-1===r)return!1;const a=[];let h=0;for(let t=0;t<r;t++){const t=this.an.readByte();h===a.length&&a.push(0),a[h]+=t,t<255&&h++}for(let s=0;s<a.length;s++){const r=new Uint8Array(a[s]);if(this.an.read(r,0,r.length)!==r.length)return!1;if(0!==(i&ns.ContinuesPacket)){if(0===e.length)throw new R(t.AlphaTabErrorType.Format,"OGG: Continuation page without any previous packets");e[e.length-1].addData(r)}else{const t=new qi(r,0!==(i&ns.BeginningOfStream)&&0===s,0!==(i&ns.EndOfStream)&&s===a.length-1,n);e.push(t)}}return!0}}class Ki{audioChannels=0;audioSampleRate=0;samples=new Float32Array(0);bitrateMaximum=0;bitrateNominal=0;bitrateMinimum=0;blocksize0=0;blocksize1=0}class Qi{value=0;bitsRead=0}class Zi{static jh=8;qh;Hl=0n;Ul=0n;zl=0n;constructor(t){this.qh=t}readByte(){return this.readBits(Zi.jh)}readBit(){return 1===this.readBits(1)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){if(0===t)return 0;const e=this.tryPeekBits(t);return this.skipBits(t),e.value}tryPeekBits(e){if(e<0||e>32)throw new R(t.AlphaTabErrorType.General,"IO: Cannot read more than 32 bits in one go");if(0===e)return new Qi;const s=new Qi;for(;this.Ul<e;){const t=BigInt(this.qh.readByte());if(-1n===t)return s.bitsRead=Number(this.Ul),s.value=Number(this.Hl),this.Hl=0n,this.Ul=0n,s;this.Hl=(0xffn&t)<<this.Ul|this.Hl,this.Ul+=8n,this.Ul>32&&(this.zl=t>>40n-this.Ul&0xffn)}let i=this.Hl;return e<64&&(i&=(1n<<BigInt(e))-1n),s.value=Number(i),s.bitsRead=e,s}skipBits(t){let e=BigInt(t);if(0===t);else if(this.Ul>e){if(this.Hl=t>31?0n:this.Hl>>e,this.Ul>32){const s=this.Ul-32n;this.Hl=this.Hl|this.zl<<this.Ul-e-s,s>t&&(this.zl=this.zl>>e&0xffn)}this.Ul-=e}else if(this.Ul===e)this.Hl=0n,this.Ul=0n;else{for(e-=this.Ul,this.Ul=0n,this.Hl=0n;e>8;){if(-1===this.qh.readByte()){e=0n;break}e-=8n}if(e>0){const t=BigInt(this.qh.readByte());-1n===t||(this.Hl=t>>e,this.Ul=8n-e)}}}}class tn{codebooks=[];timeDomainTransforms=[];floors=[];residues=[];mappings=[];modes=[]}class en{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e);return Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),n=(e&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(n)-788)}}class sn{jl;constructor(t){this.jl=t}get(t){return this.jl[t]}}class nn{static instance=new nn;get(t){return t}}class rn{ji;Xl=0;Jl=null;ql=null;Yl=0;Kl;dimensions=0;entries=0;mapType=0;constructor(e,s){if(5653314!==e.readBits(24))throw new R(t.AlphaTabErrorType.Format,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this.ji=new Int32Array(this.entries),this.Ql(e,s),this.Zl(e)}get(t,e){return this.Kl[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this.Yl);if(0===e.bitsRead)return-1;let s=this.ql[e.value];if(null!=s)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this.Xl),null!==this.Jl)for(let i=0;i<this.Jl.length;i++){s=this.Jl[i];const n=e.value&s.mask;if(s.bits===n)return t.skipBits(s.length),s.value}return-1}Ql(e,s){let i,n,r=0;if(e.readBit()){let t=e.readBits(5)+1;for(let s=0;s<this.entries;){let i=e.readBits(en.ilog(this.entries-s));for(;--i>=0;)this.ji[s++]=t;++t}r=0,i=!1,n=t}else{n=-1,i=e.readBit();for(let t=0;t<this.entries;t++)!i||e.readBit()?(this.ji[t]=e.readBits(5)+1,++r):this.ji[t]=-1,this.ji[t]>n&&(n=this.ji[t])}if(this.Xl=n,n>-1){let e,n=null;i&&r>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this.ji.subarray(0,this.entries),0),i=!1),e=i?r:0;let a=null,h=null;if(i?0!==e&&(n=new Int32Array(e),h=new Int32Array(e),a=new Int32Array(e)):h=new Int32Array(this.entries),!this.tu(i,h,n,this.ji,this.entries,a))throw new R(t.AlphaTabErrorType.Format,"Vorbis: Failed to compute codewords");const o=null==a?nn.instance:new sn(a);s.generateTable(o,n??this.ji,h),this.ql=s.prefixTree,this.Yl=s.tableBits,this.Jl=s.overflowList}}tu(t,e,s,i,n,r){const a=new Uint32Array(32);let h=0,o=0;for(h=0;h<n&&!(i[h]>0);++h);if(h===n)return!0;this.eu(t,e,s,0,h,o++,i[h],r);for(let t=1;t<=i[h];++t)a[t]=1<<32-t;for(let c=h+1;c<n;++c){let n=i[c];if(n<=0)continue;for(;n>0&&0===a[n];)--n;if(0===n)return!1;const h=a[n];if(a[n]=0,this.eu(t,e,s,en.bitReverse(h),c,o++,i[c],r),n!==i[c])for(let t=i[c];t>n;--t)a[t]=h+(1<<32-t)}return!0}eu(t,e,s,i,n,r,a,h){t?(e[r]=i,s[r]=a,h[r]=n):e[n]=i}Zl(t){if(this.mapType=t.readBits(4),0===this.mapType)return;const e=en.convertFromVorbisFloat32(t.readBits(32)),s=en.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,n=t.readBit();let r=this.entries*this.dimensions;const a=new Float32Array(r);1===this.mapType&&(r=this.su());const h=new Uint32Array(r);for(let e=0;e<r;e++)h[e]=t.readBits(i);if(1===this.mapType)for(let t=0;t<this.entries;t++){let i=0,o=1;for(let c=0;c<this.dimensions;c++){const l=h[t/o%r|0]*s+e+i;a[t*this.dimensions+c]=l,n&&(i=l),o*=r}}else for(let t=0;t<this.entries;t++){let i=0,r=t*this.dimensions;for(let o=0;o<this.dimensions;o++){const c=h[r]*s+e+i;a[t*this.dimensions+o]=c,n&&(i=c),++r}}this.Kl=a}su(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class an{value=0;length=0;bits=0;mask=0}class hn{static maxTableBits=10;tableBits=0;prefixTree=[];overflowList=null;generateTable(t,e,s){const i=new Array(e.length);let n=0;for(let r=0;r<i.length;r++){const a=new an;a.value=t.get(r),a.length=e[r]<=0?99999:e[r],a.bits=s[r],a.mask=(1<<e[r])-1,i[r]=a,e[r]>0&&n<e[r]&&(n=e[r])}i.sort((t,e)=>{const s=t.length-e.length;return 0===s?t.bits-e.bits:s});const r=n>hn.maxTableBits?hn.maxTableBits:n,a=[];let h=null;for(let t=0;t<i.length&&i[t].length<99999;t++){const e=i[t].length;if(e>r)for(h=[];t<i.length&&i[t].length<99999;t++)h.push(i[t]);else{const s=1<<r-e,n=i[t];for(let t=0;t<s;t++){const s=t<<e|n.bits;for(;a.length<=s;)a.push(null);a[s]=n}}}for(;a.length<1<<r;)a.push(null);this.tableBits=r,this.prefixTree=a,this.overflowList=h}}class on{constructor(t){t.readBits(16)}}class cn{coeff;amp=0;get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1;constructor(t){this.coeff=t}}class ln{iu;nu;ru;au;hu;ou;cu;lu;uu;du;constructor(e,s,i,n){if(this.iu=e.readBits(8),this.nu=e.readBits(16),this.ru=e.readBits(16),this.au=e.readBits(6),this.hu=e.readBits(8),this.cu=new Array(e.readBits(4)+1),this.iu<1||this.nu<1||this.ru<1||0===this.cu.length)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this.ou=(1<<this.au)-1;for(let s=0;s<this.cu.length;s++){const i=e.readBits(8);if(i<0||i>=n.length)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");const r=n[i];if(0===r.mapType||r.dimensions<1)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this.cu[s]=r}this.lu=en.ilog(this.cu.length),this.du=new Map([[s,this.fu(s/2)],[i,this.fu(i/2)]]),this.uu=new Map([[s,this.pu(s/2)],[i,this.pu(i/2)]])}fu(t){const e=this.ru/ln.bu(this.nu/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this.ru-1,Math.floor(ln.bu(this.nu/2/t*i)*e));return s[t]=-1,s}static bu(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(1.85e-8*t*t)+1e-4*t}pu(t){const e=Math.PI/this.ru,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new cn(new Float32Array(this.iu+1));if(i.amp=t.readBits(this.au),i.amp>0){i.amp=i.amp/this.ou*this.hu;const e=t.readBits(this.lu);if(e>=this.cu.length)return i.amp=0,i;const s=this.cu[e];for(let e=0;e<this.iu;){const n=s.decodeScalar(t);if(-1===n)return i.amp=0,i;for(let t=0;e<this.iu&&t<s.dimensions;t++,e++)i.coeff[e]=s.get(n,t)}let n=0;for(let t=0;t<this.iu;){for(let e=0;t<this.iu&&e<s.dimensions;t++,e++)i.coeff[t]+=n;n=i.coeff[t-1]}}return i}apply(t,e,s){const i=t,n=e/2;if(i.amp>0){const t=this.du.get(e),r=this.uu.get(e);let a=0;for(a=0;a<this.iu;a++)i.coeff[a]=2*Math.cos(i.coeff[a]);for(a=0;a<n;){let e=0;const n=t[a];let h=.5,o=.5;const c=r[n];for(e=1;e<this.iu;e+=2)o*=c-i.coeff[e-1],h*=c-i.coeff[e];for(e===this.iu?(o*=c-i.coeff[e-1],h*=h*(4-c*c),o*=o):(h*=h*(2-c),o*=o*(2+c)),o=i.amp/Math.sqrt(h+o)-this.hu,o=Math.exp(.11512925*o),s[a]*=o;t[++a]===n;)s[a]*=o}}else s.fill(0,0,n)}}class un{posts=new Int32Array(64);postCount=0;get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1}class dn{static mu=[256,128,86,64];static gu=[8,7,7,6];wu;yu;ku;Su;Bu;_u;xu;Tu;Mu;vu;Nu;Pu;Eu;Cu;constructor(e,s){let i=-1;this.wu=new Int32Array(e.readBits(5));for(let t=0;t<this.wu.length;t++)this.wu[t]=e.readBits(4),this.wu[t]>i&&(i=this.wu[t]);++i,this.yu=new Int32Array(i),this.ku=new Int32Array(i),this.Pu=new Array(i),this.Bu=new Int32Array(i),this.Eu=new Array(i),this.Cu=new Array(i);for(let t=0;t<i;t++){this.yu[t]=e.readBits(3)+1,this.ku[t]=e.readBits(2),this.ku[t]>0&&(this.Bu[t]=e.readBits(8),this.Pu[t]=s[this.Bu[t]]),this.Eu[t]=new Array(1<<this.ku[t]),this.Cu[t]=new Int32Array(this.Eu[t].length);for(let i=0;i<this.Eu[t].length;i++){const n=e.readBits(8)-1;n>=0&&(this.Eu[t][i]=s[n]),this.Cu[t][i]=n}}this.Mu=e.readBits(2),this.vu=dn.mu[this.Mu],this.Nu=dn.gu[this.Mu],++this.Mu;const n=e.readBits(4),r=[];r.push(0),r.push(1<<n);for(let t=0;t<this.wu.length;t++){const s=this.wu[t];for(let t=0;t<this.yu[s];t++)r.push(e.readBits(n))}this.Su=new Int32Array(r),this.xu=new Int32Array(r.length),this._u=new Int32Array(r.length),this.Tu=new Int32Array(r.length),this.Tu[0]=0,this.Tu[1]=1;for(let t=2;t<this.xu.length;t++){this.xu[t]=0,this._u[t]=1,this.Tu[t]=t;for(let e=2;e<t;e++){const s=this.Su[e];s<this.Su[t]?s>this.Su[this.xu[t]]&&(this.xu[t]=e):s<this.Su[this._u[t]]&&(this._u[t]=e)}}for(let e=0;e<this.Tu.length-1;e++)for(let s=e+1;s<this.Tu.length;s++){if(this.Su[e]===this.Su[s])throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor1 Data");if(this.Su[this.Tu[e]]>this.Su[this.Tu[s]]){const t=this.Tu[e];this.Tu[e]=this.Tu[s],this.Tu[s]=t}}}unpack(t,e,s){const i=new un;if(t.readBit()){let e=2;i.posts[0]=t.readBits(this.Nu),i.posts[1]=t.readBits(this.Nu);for(let s=0;s<this.wu.length;s++){const n=this.wu[s],r=this.yu[n],a=this.ku[n],h=(1<<a)-1;let o=0;if(a>0&&(o=this.Pu[n].decodeScalar(t),-1===o)){e=0;break}for(let c=0;c<r;c++){const r=this.Eu[n][o&h];if(o>>=a,null!=r&&(i.posts[e]=r.decodeScalar(t),-1===i.posts[e])){e=0,s=this.wu.length;break}++e}}i.postCount=e}return i}apply(t,e,s){const i=t,n=e/2;if(i.postCount>0){const t=this.Fu(i);let e=0,r=i.posts[0]*this.Mu;for(let a=1;a<i.postCount;a++){const h=this.Tu[a];if(t[h]){const t=this.Su[h],a=i.posts[h]*this.Mu;e<n&&this.Au(e,r,Math.min(t,n),a,s),e=t,r=a}if(e>=n)break}e<n&&this.Au(e,r,n,r,s)}else s.fill(0,0,n)}Fu(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const n=this.xu[i],r=this._u[i],a=this.Du(this.Su[n],s[n],this.Su[r],s[r],this.Su[i]),h=t.posts[i],o=this.vu-a,c=a;let l;l=o<c?2*o:2*c,0!==h?(e[n]=!0,e[r]=!0,e[i]=!0,s[i]=h>=l?o>c?h-c+a:a-h+o-1:h%2==1?a-(h+1)/2:a+h/2):(e[i]=!1,s[i]=a)}for(let e=0;e<t.postCount;e++)t.posts[e]=s[e];return e}Du(t,e,s,i,n){const r=i-e,a=s-t,h=Math.abs(r)*(n-t)/a|0;return r<0?e-h:e+h}Au(t,e,s,i,n){const r=i-e,a=s-t;let h=Math.abs(r);const o=1-2*(r>>31&1),c=r/a|0;let l=t,u=e,d=-a;for(n[t]*=dn.Lu[e],h-=Math.abs(c)*a;++l<s;)u+=c,d+=h,d>=0&&(d-=a,u+=o),n[l]*=dn.Lu[u]}static Lu=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1])}class fn{floor;constructor(e,s,i,n){const r=e.readBits(16);switch(r){case 0:this.floor=new ln(e,s,i,n);break;case 1:this.floor=new dn(e,n);break;default:throw new R(t.AlphaTabErrorType.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class pn{Wu;Ru;Ou;Iu;Gu;$u;cu;Vu;Hu;Uu;constructor(e,s,i){this.Ru=e.readBits(24),this.Ou=e.readBits(24),this.Iu=e.readBits(24)+1,this.Gu=e.readBits(6)+1,this.Vu=i[e.readBits(8)],this.Hu=new Int32Array(this.Gu);let n=0;for(let t=0;t<this.Gu;t++){const s=e.readBits(3);e.readBit()?this.Hu[t]=e.readBits(5)<<3|s:this.Hu[t]=s,n+=pn.zu(this.Hu[t])}const r=new Int32Array(n);for(let s=0;s<n;s++)if(r[s]=e.readBits(8),0===i[r[s]].mapType)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");const a=this.Vu.entries;let h=this.Vu.dimensions,o=1;for(;h>0;){if(o*=this.Gu,o>a)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");--h}this.cu=new Array(this.Gu),n=0;let c,l=0;for(let t=0;t<this.Gu;t++)if(c=en.ilog(this.Hu[t]),this.cu[t]=new Array(c),c>0){l=Math.max(l,c);for(let e=0;e<c;e++)(this.Hu[t]&1<<e)>0&&(this.cu[t][e]=i[r[n++]])}this.$u=l,this.Uu=new Array(o);for(let t=0;t<o;t++){let e=t,s=o/this.Gu|0;this.Uu[t]=new Int32Array(this.Vu.dimensions);for(let i=0;i<this.Vu.dimensions;i++){const n=e/s|0;e-=n*s,s=s/this.Gu|0,this.Uu[t][i]=n}}this.Wu=s}static zu(t){let e=0;for(;0!==t;)e+=1&t,t>>=1;return e}decode(t,e,s,i){const n=(this.Ou<s/2?this.Ou:s/2)-this.Ru;if(n>0&&-1!==e.indexOf(!1)){const e=n/this.Iu,s=(e+this.Vu.dimensions-1)/this.Vu.dimensions|0,r=[];for(let t=0;t<this.Wu;t++)r.push(new Array(s));for(let s=0;s<this.$u;s++)for(let n=0,a=0;n<e;a++){if(0===s)for(let i=0;i<this.Wu;i++){const h=this.Vu.decodeScalar(t);if(!(h>=0&&h<this.Uu.length)){n=e,s=this.$u;break}r[i][a]=this.Uu[h]}for(let h=0;n<e&&h<this.Vu.dimensions;h++,n++){const o=this.Ru+n*this.Iu;for(let c=0;c<this.Wu;c++){const l=r[c][a][h];if(this.Hu[l]&1<<s){const r=this.cu[l][s];if(r&&this.writeVectors(r,t,i,c,o,this.Iu)){n=e,s=this.$u;break}}}}}}}writeVectors(t,e,s,i,n,r){const a=s[i],h=r/t.dimensions,o=new Int32Array(h);for(let s=0;s<h;s++)if(o[s]=t.decodeScalar(e),-1===o[s])return!0;for(let e=0;e<t.dimensions;e++)for(let s=0;s<h;s++,n++)a[n]+=t.get(o[s],e);return!1}}class bn extends pn{writeVectors(t,e,s,i,n,r){const a=s[i];for(let s=0;s<r;){const i=t.decodeScalar(e);if(-1===i)return!0;for(let e=0;e<t.dimensions;s++,e++)a[n+s]+=t.get(i,e)}return!1}}class mn extends pn{ju;constructor(t,e,s){super(t,1,s),this.ju=e}decode(t,e,s,i){super.decode(t,e,s*this.ju,i)}writeVectors(t,e,s,i,n,r){let a=0;n/=this.ju;for(let i=0;i<r;){const r=t.decodeScalar(e);if(-1===r)return!0;for(let e=0;e<t.dimensions;e++,i++)s[a][n]+=t.get(r,e),++a===this.ju&&(a=0,n++)}return!1}}class gn{residue;constructor(e,s,i){const n=e.readBits(16);switch(n){case 0:this.residue=new pn(e,s,i);break;case 1:this.residue=new bn(e,s,i);break;case 2:this.residue=new mn(e,s,i);break;default:throw new R(t.AlphaTabErrorType.Format,`Vorbis: Invalid Residue type: ${n}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class wn{Xu;Ju;qu;Yu;Ku;Qu;Zu;constructor(e,s,i,n,r){if(0!==e.readBits(16))throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid mapping type!");let a=1;e.readBit()&&(a+=e.readBits(4));let h=0;e.readBit()&&(h=e.readBits(8)+1);const o=en.ilog(s-1);this.Ju=new Int32Array(h),this.qu=new Int32Array(h);for(let i=0;i<h;i++){const n=e.readBits(o),r=e.readBits(o);if(n===r||n>s-1||r>s-1)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this.Ju[i]=r,this.qu[i]=n}if(0!==e.readBits(2))throw new R(t.AlphaTabErrorType.Format,"Vorbis: Reserved bits not 0 in mapping header.");const c=new Int32Array(s);if(a>1)for(let i=0;i<s;i++)if(c[i]=e.readBits(4),c[i]>a)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this.Yu=new Array(a),this.Ku=new Array(a);for(let s=0;s<a;s++){e.skipBits(8);const r=e.readBits(8);if(r>=i.length)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid floor number in mapping header!");const a=e.readBits(8);if(a>=n.length)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Invalid residue number in mapping header!");this.Yu[s]=i[r],this.Ku[s]=n[a]}this.Qu=new Array(s),this.Zu=new Array(s);for(let t=0;t<s;t++)this.Qu[t]=this.Yu[c[t]],this.Zu[t]=this.Ku[c[t]];this.Xu=r}decodePacket(t,e,s){const i=e>>1,n=new Array(this.Qu.length),r=new Array(this.Qu.length);r.fill(!1);for(let a=0;a<this.Qu.length;a++)n[a]=this.Qu[a].unpack(t,e,a),r[a]=!n[a].executeChannel,s[a].fill(0,0,i);for(let t=0;t<this.Ju.length;t++)(n[this.Ju[t]].executeChannel||n[this.qu[t]].executeChannel)&&(n[this.Ju[t]].forceEnergy=!0,n[this.qu[t]].forceEnergy=!0);for(let i=0;i<this.Yu.length;i++){for(let t=0;t<this.Qu.length;t++)this.Yu[i]===this.Qu[t]&&this.Ku[i]===this.Zu[t]||(n[t].forceNoEnergy=!0);this.Ku[i].decode(t,r,e,s)}for(let t=this.Ju.length-1;t>=0;t--)if(n[this.Ju[t]].executeChannel||n[this.qu[t]].executeChannel){const e=s[this.qu[t]],n=s[this.Ju[t]];for(let t=0;t<i;t++){let s,i;const r=e[t],a=n[t];r>0?a>0?(s=r,i=r-a):(i=r,s=r+a):a>0?(s=r,i=r+a):(i=r,s=r-a),e[t]=s,n[t]=i}}for(let t=0;t<this.Qu.length;t++)n[t].executeChannel?(this.Qu[t].apply(n[t],e,s[t]),this.Xu.reverse(s[t],e)):s[t].fill(0,i,2*i)}}class yn{packetStartIndex=0;packetTotalLength=0;packetValidLength=0}class kn{overlapInfo=new yn;windowIndex=0}class Sn{samplePosition=null;constructor(t=null){this.samplePosition=t}}class Bn{static td=1.57079632695;Wu;ed;sd;nd;rd;ad=null;constructor(e,s,i,n,r){if(this.Wu=s,this.ed=e.readBit(),0!==e.readBits(32))throw new R(t.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid window or transform type!");const a=e.readBits(8);if(a>=r.length)throw new R(t.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid mapping index!");this.nd=r[a],this.ed?(this.sd=n,this.rd=[Bn.hd(i,n,i),Bn.hd(n,n,i),Bn.hd(i,n,n),Bn.hd(n,n,n)],this.ad=[Bn.od(i,n,i),Bn.od(n,n,i),Bn.od(i,n,n),Bn.od(n,n,n)]):(this.sd=i,this.rd=[Bn.hd(i,i,i)])}decode(t,e){const s=this.ld(t);this.nd.decodePacket(t,this.sd,e);const i=this.rd[s.windowIndex];for(let t=0;t<this.sd;t++)for(let s=0;s<this.Wu;s++)e[s][t]*=i[t];return s.overlapInfo}ld(t){const e=new kn;if(this.ed){const s=t.readBit(),i=t.readBit();e.windowIndex=(s?1:0)+(i?2:0);const n=this.ad[e.windowIndex];e.overlapInfo.packetStartIndex=n.packetStartIndex,e.overlapInfo.packetValidLength=n.packetValidLength,e.overlapInfo.packetTotalLength=n.packetTotalLength}else e.windowIndex=0,e.overlapInfo.packetStartIndex=0,e.overlapInfo.packetValidLength=this.sd/2,e.overlapInfo.packetTotalLength=this.sd;return e}static hd(t,e,s){const i=new Float32Array(e),n=t/2,r=s/2,a=e/4-n/2,h=e-e/4-r/2;for(let t=0;t<n;t++){let e=Math.sin((t+.5)/n*Bn.td);e*=e,i[a+t]=Math.sin(e*Bn.td)}for(let t=a+n;t<h;t++)i[t]=1;for(let t=0;t<r;t++){let e=Math.sin((r-t-.5)/r*Bn.td);e*=e,i[h+t]=Math.sin(e*Bn.td)}return i}static od(t,e,s){const i=s/4,n=e/4-t/4,r=e/4*3+i,a=r-2*i,h=new yn;return h.packetStartIndex=n,h.packetValidLength=a,h.packetTotalLength=r,h}}class _n{static ud=3.141592653589793;dd;fd;pd;bd;md;gd;wd;yd;kd;constructor(t){this.dd=t,this.fd=t>>1,this.pd=this.fd>>1,this.bd=this.pd>>1,this.md=en.ilog(t)-1,this.gd=new Float32Array(this.fd),this.wd=new Float32Array(this.fd),this.yd=new Float32Array(this.pd);let e=0,s=0;for(;e<this.pd;++e,s+=2)this.gd[s]=Math.cos(4*e*_n.ud/t),this.gd[s+1]=-Math.sin(4*e*_n.ud/t),this.wd[s]=.5*Math.cos((s+1)*_n.ud/t/2),this.wd[s+1]=.5*Math.sin((s+1)*_n.ud/t/2);for(e=0,s=0;e<this.bd;++e,s+=2)this.yd[s]=Math.cos(2*(s+1)*_n.ud/t),this.yd[s+1]=-Math.sin(2*(s+1)*_n.ud/t);this.kd=new Uint16Array(this.bd);for(let t=0;t<this.bd;++t)this.kd[t]=ae.int32ToUint16(en.bitReverse(t,this.md-3)<<2)}calcReverse(t){let e,s;const i=new Float32Array(this.fd);{let e=this.fd-2,s=0,n=0;const r=this.fd;for(;n!==r;)i[e+1]=t[n]*this.gd[s]-t[n+2]*this.gd[s+1],i[e]=t[n]*this.gd[s+1]+t[n+2]*this.gd[s],e-=2,s+=2,n+=4;for(n=this.fd-3;e>=0;)i[e+1]=-t[n+2]*this.gd[s]- -t[n]*this.gd[s+1],i[e]=-t[n+2]*this.gd[s+1]+-t[n]*this.gd[s],e-=2,s+=2,n-=4}e=t,s=i;{let t=this.fd-8,i=this.pd,n=0,r=this.pd,a=0;for(;t>=0;){let h,o;o=s[i+1]-s[n+1],h=s[i]-s[n],e[r+1]=s[i+1]+s[n+1],e[r]=s[i]+s[n],e[a+1]=o*this.gd[t+4]-h*this.gd[t+5],e[a]=h*this.gd[t+4]+o*this.gd[t+5],o=s[i+3]-s[n+3],h=s[i+2]-s[n+2],e[r+3]=s[i+3]+s[n+3],e[r+2]=s[i+2]+s[n+2],e[a+3]=o*this.gd[t]-h*this.gd[t+1],e[a+2]=h*this.gd[t]+o*this.gd[t+1],t-=8,r+=4,a+=4,i+=4,n+=4}}this.Sd(this.dd>>4,e,this.fd-1-0*this.pd,-this.bd),this.Sd(this.dd>>4,e,this.fd-1-1*this.pd,-this.bd),this.Bd(this.dd>>5,e,this.fd-1-0*this.bd,-(this.dd>>4),16),this.Bd(this.dd>>5,e,this.fd-1-1*this.bd,-(this.dd>>4),16),this.Bd(this.dd>>5,e,this.fd-1-2*this.bd,-(this.dd>>4),16),this.Bd(this.dd>>5,e,this.fd-1-3*this.bd,-(this.dd>>4),16);let n=2;for(;n<this.md-3>>1;++n){const t=this.dd>>n+2,s=t>>1,i=1<<n+1;for(let r=0;r<i;++r)this.Bd(this.dd>>n+4,e,this.fd-1-t*r,-s,1<<n+3)}for(;n<this.md-6;++n){const t=this.dd>>n+2,s=1<<n+3,i=t>>1,r=this.dd>>n+6,a=1<<n+1;let h=this.fd-1,o=0;for(let n=r;n>0;--n)this._d(a,e,h,-i,o,s,t),o+=4*s,h-=8}this.xd(this.dd>>5,e,this.fd-1,this.dd);{let t=0,i=this.pd-4,n=this.fd-4;for(;i>=0;){let r;r=this.kd[t],s[n+3]=e[r],s[n+2]=e[r+1],s[i+3]=e[r+2],s[i+2]=e[r+3],r=this.kd[t+1],s[n+1]=e[r],s[n]=e[r+1],s[i+1]=e[r+2],s[i]=e[r+3],i-=4,n-=4,t+=2}}{let t=0,e=0,i=this.fd-4;for(;e<i;){let n,r,a,h,o,c;n=s[e]-s[i+2],r=s[e+1]+s[i+3],a=this.yd[t+1]*n+this.yd[t]*r,h=this.yd[t+1]*r-this.yd[t]*n,o=s[e]+s[i+2],c=s[e+1]-s[i+3],s[e]=o+a,s[e+1]=c+h,s[i+2]=o-a,s[i+3]=h-c,n=s[e+2]-s[i],r=s[e+3]+s[i+1],a=this.yd[t+3]*n+this.yd[t+2]*r,h=this.yd[t+3]*r-this.yd[t+2]*n,o=s[e+2]+s[i],c=s[e+3]-s[i+1],s[e+2]=o+a,s[e+3]=c+h,s[i]=o-a,s[i+1]=h-c,t+=4,e+=4,i-=4}}{let e=this.fd-8,s=this.fd-8,n=0,r=this.fd-4,a=this.fd,h=this.dd-4;for(;s>=0;){let o,c,l,u;u=i[s+6]*this.wd[e+7]-i[s+7]*this.wd[e+6],l=-i[s+6]*this.wd[e+6]-i[s+7]*this.wd[e+7],t[n]=u,t[r+3]=-u,t[a]=l,t[h+3]=l,c=i[s+4]*this.wd[e+5]-i[s+5]*this.wd[e+4],o=-i[s+4]*this.wd[e+4]-i[s+5]*this.wd[e+5],t[n+1]=c,t[r+2]=-c,t[a+1]=o,t[h+2]=o,u=i[s+2]*this.wd[e+3]-i[s+3]*this.wd[e+2],l=-i[s+2]*this.wd[e+2]-i[s+3]*this.wd[e+3],t[n+2]=u,t[r+1]=-u,t[a+2]=l,t[h+1]=l,c=i[s]*this.wd[e+1]-i[s+1]*this.wd[e],o=-i[s]*this.wd[e]-i[s+1]*this.wd[e+1],t[n+3]=c,t[r]=-c,t[a+3]=o,t[h]=o,e-=8,s-=8,n+=4,a+=4,r-=4,h-=4}}}Bd(t,e,s,i,n){let r,a,h=s,o=h+i,c=0;for(let s=t>>2;s>0;--s)r=e[h]-e[o],a=e[h-1]-e[o-1],e[h]+=e[o],e[h-1]+=e[o-1],e[o]=r*this.gd[c]-a*this.gd[c+1],e[o-1]=a*this.gd[c]+r*this.gd[c+1],c+=n,r=e[h-2]-e[o-2],a=e[h-3]-e[o-3],e[h-2]+=e[o-2],e[h-3]+=e[o-3],e[o-2]=r*this.gd[c]-a*this.gd[c+1],e[o-3]=a*this.gd[c]+r*this.gd[c+1],c+=n,r=e[h-4]-e[o-4],a=e[h-5]-e[o-5],e[h-4]+=e[o-4],e[h-5]+=e[o-5],e[o-4]=r*this.gd[c]-a*this.gd[c+1],e[o-5]=a*this.gd[c]+r*this.gd[c+1],c+=n,r=e[h-6]-e[o-6],a=e[h-7]-e[o-7],e[h-6]+=e[o-6],e[h-7]+=e[o-7],e[o-6]=r*this.gd[c]-a*this.gd[c+1],e[o-7]=a*this.gd[c]+r*this.gd[c+1],c+=n,h-=8,o-=8}Sd(t,e,s,i){let n=s,r=n+i,a=0;for(let s=t>>2;s>0;--s){let t,s;t=e[n]-e[r],s=e[n-1]-e[r-1],e[n]+=e[r],e[n-1]+=e[r-1],e[r]=t*this.gd[a]-s*this.gd[a+1],e[r-1]=s*this.gd[a]+t*this.gd[a+1],a+=8,t=e[n-2]-e[r-2],s=e[n-3]-e[r-3],e[n-2]+=e[r-2],e[n-3]+=e[r-3],e[r-2]=t*this.gd[a]-s*this.gd[a+1],e[r-3]=s*this.gd[a]+t*this.gd[a+1],a+=8,t=e[n-4]-e[r-4],s=e[n-5]-e[r-5],e[n-4]+=e[r-4],e[n-5]+=e[r-5],e[r-4]=t*this.gd[a]-s*this.gd[a+1],e[r-5]=s*this.gd[a]+t*this.gd[a+1],a+=8,t=e[n-6]-e[r-6],s=e[n-7]-e[r-7],e[n-6]+=e[r-6],e[n-7]+=e[r-7],e[r-6]=t*this.gd[a]-s*this.gd[a+1],e[r-7]=s*this.gd[a]+t*this.gd[a+1],a+=8,n-=8,r-=8}}_d(t,e,s,i,n,r,a){const h=this.gd[n],o=this.gd[n+1],c=this.gd[n+r],l=this.gd[n+r+1],u=this.gd[n+2*r],d=this.gd[n+2*r+1],f=this.gd[n+3*r],p=this.gd[n+3*r+1];let b,m,g=s,w=g+i;for(let s=t;s>0;--s)b=e[g]-e[w],m=e[g-1]-e[w-1],e[g]+=e[w],e[g-1]+=e[w-1],e[w]=b*h-m*o,e[w-1]=m*h+b*o,b=e[g-2]-e[w-2],m=e[g-3]-e[w-3],e[g-2]+=e[w-2],e[g-3]+=e[w-3],e[w-2]=b*c-m*l,e[w-3]=m*c+b*l,b=e[g-4]-e[w-4],m=e[g-5]-e[w-5],e[g-4]+=e[w-4],e[g-5]+=e[w-5],e[w-4]=b*u-m*d,e[w-5]=m*u+b*d,b=e[g-6]-e[w-6],m=e[g-7]-e[w-7],e[g-6]+=e[w-6],e[g-7]+=e[w-7],e[w-6]=b*f-m*p,e[w-7]=m*f+b*p,g-=a,w-=a}xd(t,e,s,i){const n=i>>3,r=this.gd[n];let a=s;const h=a-16*t;for(;a>h;){let t,s;t=e[a]-e[a-8],s=e[a-1]-e[a-9],e[a]+=e[a-8],e[a-1]+=e[a-9],e[a-8]=t,e[a-9]=s,t=e[a-2]-e[a-10],s=e[a-3]-e[a-11],e[a-2]+=e[a-10],e[a-3]+=e[a-11],e[a-10]=(t+s)*r,e[a-11]=(s-t)*r,t=e[a-12]-e[a-4],s=e[a-5]-e[a-13],e[a-4]+=e[a-12],e[a-5]+=e[a-13],e[a-12]=s,e[a-13]=t,t=e[a-14]-e[a-6],s=e[a-7]-e[a-15],e[a-6]+=e[a-14],e[a-7]+=e[a-15],e[a-14]=(t+s)*r,e[a-15]=(t-s)*r,this.Td(e,a),this.Td(e,a-8),a-=16}}Td(t,e){const s=t[e]-t[e-4],i=t[e]+t[e-4],n=t[e-2]+t[e-6],r=t[e-2]-t[e-6];t[e]=i+n,t[e-2]=i-n;const a=t[e-3]-t[e-7];t[e-4]=s+a,t[e-6]=s-a;const h=t[e-1]-t[e-5],o=t[e-1]+t[e-5],c=t[e-3]+t[e-7];t[e-1]=o+c,t[e-3]=o-c,t[e-5]=h-r,t[e-7]=h+r}}class xn{Md=new Map;reverse(t,e){let s;this.Md.has(e)?s=this.Md.get(e):(s=new _n(e),this.Md.set(e,s)),s.calcReverse(t)}}class Tn{vd;Nd;Pd;Ed=0;Cd;Fd;Ad;Dd;Ld;Wd;Rd;Od;Id;constructor(t,e,s){this.vd=t,this.Nd=e,this.Pd=s,this.Wd=0,this.Fd=null,this.Ad=0,this.Dd=0,this.Ld=0,this.Cd=null,this.Od=!1,this.Rd=!1,this.Id=en.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this.Pd[this.Pd.length-1].granulePosition*this.vd.audioChannels);const e=new Float32Array(.2*this.vd.audioSampleRate*this.vd.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),0!==s;){if(i+s>=t.length){const s=new Float32Array(t.length+e.length);s.set(t,0),t=s}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(0===s)return 0;let i=e;const n=e+s;for(;i<n;){if(this.Ad===this.Dd){if(this.Od){this.Cd=null,this.Fd=null;break}const t=this.Gd((i-e)/this.vd.audioChannels);null===t&&(this.Dd=this.Ld),null===t||null===t.samplePosition||this.Rd||(this.Rd=!0,this.Wd=t.samplePosition-(this.Dd-this.Ad)-(i-e)/this.vd.audioChannels)}const s=Math.min((n-i)/this.vd.audioChannels,this.Dd-this.Ad);s>0&&(i+=this.$d(t,i,s))}return s=i-e,this.Wd+=s/this.vd.audioChannels,s}$d(t,e,s){let i=e;for(;s>0;this.Ad++,s--)for(let e=0;e<this.vd.audioChannels;e++)t[i++]=this.Fd[e][this.Ad];return i-e}Gd(t){const e=this.Vd();if(this.Od=this.Od||e.isEndOfStream,null==e.curPacket)return null;if(null!==e.samplePosition&&e.isEndOfStream){const s=this.Wd+t+e.validLen-e.startIndex,i=e.samplePosition-s;i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this.Dd>0?(Tn.Hd(this.Fd,e.curPacket,this.Ad,this.Ld,e.startIndex,this.vd.audioChannels),this.Ad=e.startIndex):null==this.Fd&&(this.Ad=e.validLen),this.Cd=this.Fd,this.Dd=e.validLen,this.Ld=e.totalLen,this.Fd=e.curPacket,new Sn(e.samplePosition)}static Hd(t,e,s,i,n,r){for(;s<i;s++,n++)for(let i=0;i<r;i++)e[i][n]+=t[i][s]}Vd(){const t=new Mn;let e=null;if(this.Ed>=this.Pd.length)t.isEndOfStream=!0;else{e=this.Pd[this.Ed++];const s=new Zi(Ie.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this.Nd.modes[s.readBits(this.Id)];if(null==this.Cd){this.Cd=new Array(this.vd.audioChannels);for(let t=0;t<this.vd.audioChannels;t++)this.Cd[t]=new Float32Array(this.vd.blocksize1)}const n=i.decode(s,this.Cd);return t.startIndex=n.packetStartIndex,t.validLen=n.packetValidLength,t.totalLen=n.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this.Cd,t}}return t}}class Mn{curPacket=null;startIndex=0;validLen=0;totalLen=0;isEndOfStream=!1;samplePosition=null}!function(t){t[t.IdentificationHeader=1]="IdentificationHeader",t[t.Comment=3]="Comment",t[t.SetupHeader=5]="SetupHeader"}(rs||(rs={}));class vn{static vorbisHeaderMarker=new Uint8Array(["v".charCodeAt(0),"o".charCodeAt(0),"r".charCodeAt(0),"b".charCodeAt(0),"i".charCodeAt(0),"s".charCodeAt(0)]);Pd;Ed;constructor(t){this.Ed=-1,this.Pd=t}read(){let t;for(;;){if(t=this.Ud(),null==t)return null;if(t.isBeginningOfStream){const e=this.zd(t);if(null!=e)return e}}}Ud(){return this.Ed++,this.Ed<this.Pd.length?this.Pd[this.Ed]:null}zd(t){const e=new Ki;if(!this.jd(e,t))return null;if(!this.Xd(this.Ud()))return null;const s=new tn;if(!this.Jd(e,s,this.Ud()))return null;const i=[];let n;for(;n=this.Ud(),null!=n&&(i.push(n),!n.isEndOfStream););const r=new Tn(e,s,i);return e.samples=r.decode(),e}qd(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let t=0;t<vn.vorbisHeaderMarker.length;t++)if(s[1+t]!==vn.vorbisHeaderMarker[t])return!1;return!0}Yd(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let t=0;t<vn.vorbisHeaderMarker.length;t++)if(s[1+t]!==vn.vorbisHeaderMarker[t])return!1;return!0}jd(t,e){const s=Ie.fromBuffer(e.packetData);if(!this.qd(rs.IdentificationHeader,s))return!1;if(0!==he.readUInt32LE(s))return!1;if(t.audioChannels=s.readByte(),t.audioSampleRate=he.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0)return!1;t.bitrateMaximum=he.readInt32LE(s),t.bitrateNominal=he.readInt32LE(s),t.bitrateMinimum=he.readInt32LE(s);const i=s.readByte();if(t.blocksize0=1<<(15&i),t.blocksize1=1<<(i>>4),t.blocksize0>t.blocksize1||!vn.Kd(t.blocksize0)||!vn.Kd(t.blocksize0))return!1;return 0!==s.readByte()}static Kd(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}Xd(t){if(null==t)return!1;const e=Ie.fromBuffer(t.packetData);if(!this.qd(rs.Comment,e))return!1;const s=he.readUInt32LE(e);e.skip(s);const i=he.readUInt32LE(e);for(let t=0;t<i;t++){const t=he.readUInt32LE(e);e.skip(t)}return 0!==e.readByte()}Jd(t,e,s){if(null==s)return!1;const i=new Zi(Ie.fromBuffer(s.packetData)),n=new xn,r=new hn;if(!this.Yd(rs.SetupHeader,i))return!1;let a=i.readByte()+1;for(let t=0;t<a;t++)e.codebooks.push(new rn(i,r));a=i.readBits(6)+1;for(let t=0;t<a;t++)e.timeDomainTransforms.push(new on(i));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.floors.push(new fn(i,t.blocksize0,t.blocksize1,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.residues.push(new gn(i,t.audioChannels,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.mappings.push(new wn(i,t.audioChannels,e.floors,e.residues,n));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.modes.push(new Bn(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}}class Nn{streams=[];constructor(t){const e=new Yi(t).read(),s=new vn(e);for(;;){const t=s.read();if(null==t)break;this.streams.push(t)}}}class Pn{phdrs=[];pbags=[];pmods=[];pgens=[];insts=[];ibags=[];imods=[];igens=[];sHdrs=[];sampleData=new Uint8Array(0);Qd=new Map;decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this.Qd.has(i)){let n;const r=this.sampleData.slice(t,e);if(s){n=new Nn(Ie.fromBuffer(r)).streams[0].samples}else{const t=new DataView(r.buffer,r.byteOffset,r.length);n=new Float32Array(r.length/2);for(let e=0;e<n.length;e++)n[e]=t.getInt16(2*e,!0)/32767}return this.Qd.set(i,n),n}return this.Qd.get(i)}load(t){const e=new Ji,s=new Ji;if(!Ji.load(null,e,t)||"sfbk"!==e.id)throw new pe("Soundfont is not a valid Soundfont2 file");for(;Ji.load(e,s,t);){const e=new Ji;if("pdta"===s.id)for(;Ji.load(s,e,t);)switch(e.id){case"phdr":for(let s=0,i=e.size/Wn.SizeInFile|0;s<i;s++)this.phdrs.push(new Wn(t));break;case"pbag":for(let s=0,i=e.size/Dn.SizeInFile|0;s<i;s++)this.pbags.push(new Dn(t));break;case"pmod":for(let s=0,i=e.size/Rn.SizeInFile|0;s<i;s++)this.pmods.push(new Rn(t));break;case"pgen":for(let s=0,i=e.size/Ln.SizeInFile|0;s<i;s++)this.pgens.push(new Ln(t));break;case"inst":for(let s=0,i=e.size/An.SizeInFile|0;s<i;s++)this.insts.push(new An(t));break;case"ibag":for(let s=0,i=e.size/En.SizeInFile|0;s<i;s++)this.ibags.push(new En(t));break;case"imod":for(let s=0,i=e.size/Cn.SizeInFile|0;s<i;s++)this.imods.push(new Cn(t));break;case"igen":for(let s=0,i=e.size/Fn.SizeInFile|0;s<i;s++)this.igens.push(new Fn(t));break;case"shdr":for(let s=0,i=e.size/On.SizeInFile|0;s<i;s++)this.sHdrs.push(new On(t));break;default:t.position+=e.size}else if("sdta"===s.id)for(;Ji.load(s,e,t);)if("smpl"===e.id)this.sampleData=new Uint8Array(e.size),t.read(this.sampleData,0,e.size);else t.position+=e.size;else t.position+=s.size}}}class En{static SizeInFile=4;instGenNdx;instModNdx;constructor(t){this.instGenNdx=he.readUInt16LE(t),this.instModNdx=he.readUInt16LE(t)}}class Cn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=he.readUInt16LE(t),this.modDestOper=he.readUInt16LE(t),this.modAmount=he.readInt16LE(t),this.modAmtSrcOper=he.readUInt16LE(t),this.modTransOper=he.readUInt16LE(t)}}class Fn{static SizeInFile=4;genOper;genAmount;constructor(t){this.genOper=he.readUInt16LE(t),this.genAmount=new In(t)}}class An{static SizeInFile=22;instName;instBagNdx;constructor(t){this.instName=he.read8BitStringLength(t,20),this.instBagNdx=he.readUInt16LE(t)}}class Dn{static SizeInFile=4;genNdx;modNdx;constructor(t){this.genNdx=he.readUInt16LE(t),this.modNdx=he.readUInt16LE(t)}}class Ln{static SizeInFile=4;static GenInstrument=41;static GenKeyRange=43;static GenVelRange=44;static GenSampleId=53;genOper;genAmount;constructor(t){this.genOper=he.readUInt16LE(t),this.genAmount=new In(t)}}class Wn{static SizeInFile=38;presetName;preset;bank;presetBagNdx;library;genre;morphology;constructor(t){this.presetName=he.read8BitStringLength(t,20),this.preset=he.readUInt16LE(t),this.bank=he.readUInt16LE(t),this.presetBagNdx=he.readUInt16LE(t),this.library=he.readUInt32LE(t),this.genre=he.readUInt32LE(t),this.morphology=he.readUInt32LE(t)}}class Rn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=he.readUInt16LE(t),this.modDestOper=he.readUInt16LE(t),this.modAmount=he.readUInt16LE(t),this.modAmtSrcOper=he.readUInt16LE(t),this.modTransOper=he.readUInt16LE(t)}}class On{static SizeInFile=46;sampleName;start;end;startLoop;endLoop;sampleRate;originalPitch;pitchCorrection;sampleLink;sampleType;constructor(t){this.sampleName=he.read8BitStringLength(t,20),this.start=he.readUInt32LE(t),this.end=he.readUInt32LE(t),this.startLoop=he.readUInt32LE(t),this.endLoop=he.readUInt32LE(t),this.sampleRate=he.readUInt32LE(t),this.originalPitch=t.readByte(),this.pitchCorrection=he.readSInt8(t),this.sampleLink=he.readUInt16LE(t),this.sampleType=he.readUInt16LE(t)}}class In{wordAmount;get shortAmount(){return ae.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(t){this.wordAmount=he.readUInt16LE(t)}}class Gn{presetIndex=0;bank=0;pitchWheel=0;perNotePitchWheel=new Map;midiPan=0;midiVolume=0;midiExpression=0;midiRpn=0;midiData=0;panOffset=0;gainDb=0;pitchRange=0;tuning=0;mixVolume=0;mute=!1;solo=!1}class $n{activeChannel=0;channelList=[];setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}!function(t){t[t.None=0]="None",t[t.Continuous=1]="Continuous",t[t.Sustain=2]="Sustain"}(as||(as={})),function(t){t[t.StereoInterleaved=0]="StereoInterleaved",t[t.StereoUnweaved=1]="StereoUnweaved",t[t.Mono=2]="Mono"}(hs||(hs={}));class Vn{name="";presetNumber=0;bank=0;regions=null}class Hn{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,.05*t):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class Un{delay=0;attack=0;hold=0;decay=0;sustain=0;release=0;keynumToHold=0;keynumToDecay=0;constructor(t){t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:Hn.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Hn.timecents2Secs(this.attack),this.release=this.release<-11950?0:Hn.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Hn.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Hn.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=t?Hn.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(t){t[t.StartAddrsOffset=0]="StartAddrsOffset",t[t.EndAddrsOffset=1]="EndAddrsOffset",t[t.StartloopAddrsOffset=2]="StartloopAddrsOffset",t[t.EndloopAddrsOffset=3]="EndloopAddrsOffset",t[t.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",t[t.ModLfoToPitch=5]="ModLfoToPitch",t[t.VibLfoToPitch=6]="VibLfoToPitch",t[t.ModEnvToPitch=7]="ModEnvToPitch",t[t.InitialFilterFc=8]="InitialFilterFc",t[t.InitialFilterQ=9]="InitialFilterQ",t[t.ModLfoToFilterFc=10]="ModLfoToFilterFc",t[t.ModEnvToFilterFc=11]="ModEnvToFilterFc",t[t.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",t[t.ModLfoToVolume=13]="ModLfoToVolume",t[t.Unused1=14]="Unused1",t[t.ChorusEffectsSend=15]="ChorusEffectsSend",t[t.ReverbEffectsSend=16]="ReverbEffectsSend",t[t.Pan=17]="Pan",t[t.Unused2=18]="Unused2",t[t.Unused3=19]="Unused3",t[t.Unused4=20]="Unused4",t[t.DelayModLFO=21]="DelayModLFO",t[t.FreqModLFO=22]="FreqModLFO",t[t.DelayVibLFO=23]="DelayVibLFO",t[t.FreqVibLFO=24]="FreqVibLFO",t[t.DelayModEnv=25]="DelayModEnv",t[t.AttackModEnv=26]="AttackModEnv",t[t.HoldModEnv=27]="HoldModEnv",t[t.DecayModEnv=28]="DecayModEnv",t[t.SustainModEnv=29]="SustainModEnv",t[t.ReleaseModEnv=30]="ReleaseModEnv",t[t.KeynumToModEnvHold=31]="KeynumToModEnvHold",t[t.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",t[t.DelayVolEnv=33]="DelayVolEnv",t[t.AttackVolEnv=34]="AttackVolEnv",t[t.HoldVolEnv=35]="HoldVolEnv",t[t.DecayVolEnv=36]="DecayVolEnv",t[t.SustainVolEnv=37]="SustainVolEnv",t[t.ReleaseVolEnv=38]="ReleaseVolEnv",t[t.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",t[t.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",t[t.Instrument=41]="Instrument",t[t.Reserved1=42]="Reserved1",t[t.KeyRange=43]="KeyRange",t[t.VelRange=44]="VelRange",t[t.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",t[t.Keynum=46]="Keynum",t[t.Velocity=47]="Velocity",t[t.InitialAttenuation=48]="InitialAttenuation",t[t.Reserved2=49]="Reserved2",t[t.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",t[t.CoarseTune=51]="CoarseTune",t[t.FineTune=52]="FineTune",t[t.SampleID=53]="SampleID",t[t.SampleModes=54]="SampleModes",t[t.Reserved3=55]="Reserved3",t[t.ScaleTuning=56]="ScaleTuning",t[t.ExclusiveClass=57]="ExclusiveClass",t[t.OverridingRootKey=58]="OverridingRootKey",t[t.Unused5=59]="Unused5",t[t.EndOper=60]="EndOper"}(os||(os={}));class zn{static Zd=new Float32Array(0);loopMode=as.None;samples=zn.Zd;sampleRate=0;loKey=0;hiKey=0;loVel=0;hiVel=0;group=0;offset=0;end=0;loopStart=0;loopEnd=0;transpose=0;tune=0;pitchKeyCenter=0;pitchKeyTrack=0;attenuation=0;pan=0;ampEnv=new Un;modEnv=new Un;initialFilterQ=0;initialFilterFc=0;modEnvToPitch=0;modEnvToFilterFc=0;modLfoToFilterFc=0;modLfoToVolume=0;delayModLFO=0;freqModLFO=0;modLfoToPitch=0;delayVibLFO=0;freqVibLFO=0;vibLfoToPitch=0;constructor(t){t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new Un(t.ampEnv),this.modEnv=new Un(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=as.None,this.samples=zn.Zd,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,t||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case os.StartAddrsOffset:this.offset+=ae.int16ToUint32(e.shortAmount);break;case os.EndAddrsOffset:this.end+=ae.int16ToUint32(e.shortAmount);break;case os.StartloopAddrsOffset:this.loopStart+=ae.int16ToUint32(e.shortAmount);break;case os.EndloopAddrsOffset:this.loopEnd+=ae.int16ToUint32(e.shortAmount);break;case os.StartAddrsCoarseOffset:this.offset+=32768*ae.int16ToUint32(e.shortAmount);break;case os.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case os.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case os.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case os.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case os.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case os.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case os.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case os.EndAddrsCoarseOffset:this.end+=32768*ae.int16ToUint32(e.shortAmount);break;case os.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case os.Pan:this.pan=e.shortAmount/1e3;break;case os.DelayModLFO:this.delayModLFO=e.shortAmount;break;case os.FreqModLFO:this.freqModLFO=e.shortAmount;break;case os.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case os.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case os.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case os.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case os.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case os.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case os.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case os.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case os.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case os.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case os.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case os.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case os.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case os.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case os.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case os.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case os.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case os.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case os.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case os.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case os.StartloopAddrsCoarseOffset:this.loopStart+=32768*ae.int16ToUint32(e.shortAmount);break;case os.InitialAttenuation:this.attenuation+=.1*e.shortAmount;break;case os.EndloopAddrsCoarseOffset:this.loopEnd+=32768*ae.int16ToUint32(e.shortAmount);break;case os.CoarseTune:this.transpose+=e.shortAmount;break;case os.FineTune:this.tune+=e.shortAmount;break;case os.SampleModes:this.loopMode=3&~e.wordAmount?1==(3&e.wordAmount)?as.Continuous:as.None:as.Sustain;break;case os.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case os.ExclusiveClass:this.group=e.wordAmount;break;case os.OverridingRootKey:this.pitchKeyCenter=e.shortAmount}}}!function(t){t[t.None=0]="None",t[t.Delay=1]="Delay",t[t.Attack=2]="Attack",t[t.Hold=3]="Hold",t[t.Decay=4]="Decay",t[t.Sustain=5]="Sustain",t[t.Release=6]="Release",t[t.Done=7]="Done"}(cs||(cs={}));class jn{static tf=.01;level=0;slope=0;samplesUntilNextSegment=0;segment=cs.None;midiVelocity=0;parameters=null;segmentIsExponential=!1;isAmpEnv=!1;nextSegment(t,e){if(this.parameters)for(;;)switch(t){case cs.None:if(this.samplesUntilNextSegment=this.parameters.delay*e|0,this.samplesUntilNextSegment>0)return this.segment=cs.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);t=cs.Delay;break;case cs.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*e|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*e|0),this.segment=cs.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);t=cs.Attack;break;case cs.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*e|0,this.samplesUntilNextSegment>0)return this.segment=cs.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);t=cs.Hold;break;case cs.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*e|0,this.samplesUntilNextSegment>0){if(this.segment=cs.Decay,this.level=1,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/t|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*e|0,this.segmentIsExponential=!1;return}t=cs.Decay;break;case cs.Decay:return this.segment=cs.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case cs.Sustain:if(this.segment=cs.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?jn.tf:this.parameters.release)*e|0,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=cs.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(t,e,s,i,n){this.parameters=new Un(t),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-e),this.parameters.hold=this.parameters.hold<-1e4?0:Hn.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-e),this.parameters.decay=this.parameters.decay<-1e4?0:Hn.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(cs.None,n)}process(t,e){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,t):this.level+=this.slope*t),this.samplesUntilNextSegment-=t,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,e)}}class Xn{samplesUntil=0;level=0;delta=0;setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*Hn.cents2Hertz(e)/s,this.level=0}process(t){this.samplesUntil>t?this.samplesUntil-=t:(this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class Jn{qInv=0;a0=0;a1=0;b1=0;b2=0;z1=0;z2=0;active=!1;constructor(t){t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}class qn{static renderEffectSampleBlock=Gt.MicroBufferSize;playingPreset=0;playingKey=0;playingChannel=0;region=null;pitchInputTimecents=0;pitchOutputFactor=0;sourceSamplePosition=0;noteGainDb=0;panFactorLeft=0;panFactorRight=0;playIndex=0;loopStart=0;loopEnd=0;ampEnv=new jn;modEnv=new jn;lowPass=new Jn;modLfo=new Xn;vibLfo=new Xn;mixVolume=0;mute=!1;updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192);const i=8192===s?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning;this.calcPitchRatio(i,e)}calcPitchRatio(t,e){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==t&&(i+=t),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Hn.timecents2Secs(100*this.region.pitchKeyCenter)*e)}end(t){this.region&&(this.ampEnv.nextSegment(cs.Sustain,t),this.modEnv.nextSegment(cs.Sustain,t),this.region.loopMode===as.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(cs.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(cs.Sustain,t)}render(t,e,s,i,n){if(!this.region)return;const r=this.region,a=r.samples;let h=0,o=t.outputMode===hs.StereoUnweaved?i:-1;const c=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,l=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),u=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,d=this.loopStart<this.loopEnd,f=this.loopStart,p=this.loopEnd,b=r.end,m=p+1;let g=this.sourceSamplePosition;const w=new Jn(this.lowPass),y=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc;let k=0,S=0,B=0,_=0;const x=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch;let T=0,M=0,v=0,N=0;const P=0!==r.modLfoToVolume;let E=0,C=0;for(y?(k=t.outSampleRate,S=r.initialFilterFc,B=r.modLfoToFilterFc,_=r.modEnvToFilterFc):(k=0,S=0,B=0,_=0),x?(T=0,M=r.modLfoToPitch,v=r.vibLfoToPitch,N=r.modEnvToPitch):(T=Hn.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,M=0,v=0,N=0),P?C=.1*r.modLfoToVolume:(E=Hn.decibelsToGain(this.noteGainDb),C=0);i>0;){let r,F,A=0,D=i>qn.renderEffectSampleBlock?qn.renderEffectSampleBlock:i;if(i-=D,y){const t=S+this.modLfo.level*B+this.modEnv.level*_;w.active=t<=13500,w.active&&w.setup(Hn.cents2Hertz(t)/k)}switch(x&&(T=Hn.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*M+this.vibLfo.level*v+this.modEnv.level*N))*this.pitchOutputFactor),P&&(E=Hn.decibelsToGain(this.noteGainDb+this.modLfo.level*C)),r=E*this.ampEnv.level,n?r=0:r*=this.mixVolume,this.ampEnv.process(D,t.outSampleRate),c&&this.modEnv.process(D,t.outSampleRate),l&&this.modLfo.process(D),u&&this.vibLfo.process(D),t.outputMode){case hs.StereoInterleaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+h]+=r*A,h++,g+=T,g>=m&&d&&(g-=p-f+1)}break;case hs.StereoUnweaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+o]+=r*A,o++,g+=T,g>=m&&d&&(g-=p-f+1)}break;case hs.Mono:for(;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let o=a[t]*(1-n)+a[i]*n;w.active&&(o=w.process(o)),e[s+h]=o*r,h++,g+=T,g>=m&&d&&(g-=p-f+1)}}if(g>=b||this.ampEnv.segment===cs.Done)return void this.kill()}this.sourceSamplePosition=g,(w.active||y)&&(this.lowPass=w)}kill(){this.playingPreset=-1}}class Yn{value;next;constructor(t){this.value=t}}class Kn{ef;sf;get isEmpty(){return void 0===this.ef}clear(){this.ef=void 0,this.sf=void 0}enqueue(t){const e=new Yn(t);this.sf?(this.sf.next=e,this.sf=e):(this.ef=e,this.sf=e)}enqueueFront(t){const e=new Yn(t);e.next=this.ef,this.ef?this.ef=e:(this.ef=e,this.sf=e)}peek(){const t=this.ef;if(t)return t.value}dequeue(){const t=this.ef;if(!t)return;const e=t.next;return this.ef=e,e||(this.sf=void 0),t.value}}!function(t){t[t.BankSelectCoarse=0]="BankSelectCoarse",t[t.ModulationCoarse=1]="ModulationCoarse",t[t.DataEntryCoarse=6]="DataEntryCoarse",t[t.VolumeCoarse=7]="VolumeCoarse",t[t.PanCoarse=10]="PanCoarse",t[t.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",t[t.BankSelectFine=32]="BankSelectFine",t[t.ModulationFine=33]="ModulationFine",t[t.DataEntryFine=38]="DataEntryFine",t[t.VolumeFine=39]="VolumeFine",t[t.PanFine=42]="PanFine",t[t.ExpressionControllerFine=43]="ExpressionControllerFine",t[t.HoldPedal=64]="HoldPedal",t[t.LegatoPedal=68]="LegatoPedal",t[t.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",t[t.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",t[t.RegisteredParameterFine=100]="RegisteredParameterFine",t[t.RegisteredParameterCourse=101]="RegisteredParameterCourse",t[t.AllSoundOff=120]="AllSoundOff",t[t.ResetControllers=121]="ResetControllers",t[t.AllNotesOff=123]="AllNotesOff"}(ls||(ls={}));class Qn{if=new Kn;nf=new Map;rf=new Map;af=!1;hf=new Map;cf=new Map;currentTempo=0;timeSignatureNumerator=0;timeSignatureDenominator=0;constructor(t){this.outSampleRate=t}synthesize(t,e,s){return this.lf(t,e,s)}synthesizeSilent(t){this.lf(null,0,t)}channelGetMixVolume(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this.uf(t);for(const s of this.df)s.playingChannel===t&&-1!==s.playingPreset&&(s.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this.nf.set(t,!0):this.nf.delete(t)}channelSetSolo(t,e){e?this.rf.set(t,!0):this.rf.delete(t),this.af=this.rf.size>0}resetChannelStates(){this.nf=new Map,this.rf=new Map,this.cf=new Map,this.applyTranspositionPitches(new Map),this.af=!1}setChannelTranspositionPitch(t,e){let s=0;this.cf.has(t)&&(s=this.cf.get(t)),0===e?this.cf.delete(t):this.cf.set(t,e);for(const i of this.df)if(i.playingChannel===t&&9!==i.playingChannel){let t=0;t-=s,t+=e,i.playingKey+=t,this.Wu&&i.updatePitchRatio(this.Wu.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this.hf;for(const s of this.df)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this.Wu&&s.updatePitchRatio(this.Wu.channelList[s.playingChannel],this.outSampleRate)}this.hf=t}dispatchEvent(t){this.if.enqueue(t)}lf(t,e,s){const i=this.af,n=[];for(;!this.if.isEmpty;){const t=this.if.dequeue();t.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(Gt.MetronomeChannel,Gt.MetronomeKey),this.channelNoteOn(Gt.MetronomeChannel,Gt.MetronomeKey,95/127)):t.event&&this.processMidiMessage(t.event),n.push(t)}for(const n of this.df)if(-1!==n.playingPreset){const r=n.playingChannel,a=this.nf.has(r)||i&&r!==Gt.MetronomeChannel&&!this.rf.has(r);t?n.render(this,t,e,s,a):n.kill()}return n}processMidiMessage(t){switch(t.type){case ss.TimeSignature:const e=t;this.timeSignatureNumerator=e.numerator,this.timeSignatureDenominator=Math.pow(2,e.denominatorIndex);break;case ss.NoteOn:const s=t;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case ss.NoteOff:const i=t;this.channelNoteOff(i.channel,i.noteKey);break;case ss.ControlChange:const n=t;this.channelMidiControl(n.channel,n.controller,n.value);break;case ss.ProgramChange:const r=t;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case ss.TempoChange:const a=t;this.currentTempo=a.beatsPerMinute;break;case ss.PitchBend:const h=t;this.channelSetPitchWheel(h.channel,h.value);break;case ss.PerNotePitchBend:const o=t;let c=o.value;c=c*Gt.MaxPitchWheel/Gt.MaxPitchWheel20,this.channelSetPerNotePitchWheel(o.channel,o.noteKey,c)}}get metronomeVolume(){return this.channelGetMixVolume(Gt.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(Gt.MetronomeChannel,t),t>0&&(this.channelSetVolume(Gt.MetronomeChannel,1),this.channelSetPresetNumber(Gt.MetronomeChannel,0,!0))}get masterVolume(){return Hn.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=Hn.gainToDecibels(t),s=e-this.globalGainDb;if(0!==s){for(const t of this.df)-1!==t.playingPreset&&(t.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this.df)-1!==t.playingPreset&&(t.ampEnv.segment<cs.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);if(this.Wu)for(const t of this.Wu.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}presets=null;df=[];Wu=null;ff=0;get presetCount(){return this.presets?.length??0}outputMode=hs.StereoInterleaved;outSampleRate=0;globalGainDb=0;reset(){for(const t of this.df)-1!==t.playingPreset&&(t.ampEnv.segment<cs.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);this.Wu=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=127*s|0;if(t<0||t>=this.presets.length)return;if(s<=0)return void this.noteOff(t,e);const n=this.ff++;for(const r of this.presets[t].regions){if(e<r.loKey||e>r.hiKey||i<r.loVel||i>r.hiVel)continue;let a=null;if(0!==r.group)for(const e of this.df)e.playingPreset===t&&e.region.group===r.group?e.endQuick(this.outSampleRate):-1!==e.playingPreset||a||(a=e);else for(const t of this.df)-1===t.playingPreset&&(a=t);if(!a){for(let t=0;t<4;t++){const t=new qn;t.playingPreset=-1,this.df.push(t)}a=this.df[this.df.length-4]}a.region=r,a.playingPreset=t,a.playingKey=e,a.playIndex=n,a.noteGainDb=this.globalGainDb-r.attenuation-Hn.gainToDecibels(1/s),this.Wu?this.Wu.setupVoice(this,a):(a.calcPitchRatio(0,this.outSampleRate),a.panFactorLeft=Math.sqrt(.5-r.pan),a.panFactorRight=Math.sqrt(.5+r.pan)),a.sourceSamplePosition=r.offset;const h=r.loopMode!==as.None&&r.loopStart<r.loopEnd;a.loopStart=h?r.loopStart:0,a.loopEnd=h?r.loopEnd:0,a.ampEnv.setup(r.ampEnv,e,i,!0,this.outSampleRate),a.modEnv.setup(r.modEnv,e,i,!1,this.outSampleRate);const o=r.initialFilterQ/10;a.lowPass.qInv=1/Math.pow(10,o/20),a.lowPass.z1=0,a.lowPass.z2=0,a.lowPass.active=r.initialFilterFc<=13500,a.lowPass.active&&a.lowPass.setup(Hn.cents2Hertz(r.initialFilterFc)/this.outSampleRate),a.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),a.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const n=this.pf(t,e);return-1!==n&&(this.noteOn(n,s,i),!0)}noteOff(t,e){let s=null,i=null;const n=[];for(const r of this.df)r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=cs.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,n.push(r)):r.playIndex===s.playIndex&&(i=r,n.push(r)));if(s)for(const r of n)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=cs.Release)||r.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this.pf(t,e);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this.df)-1!==e.playingPreset&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<cs.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this.df)-1!==e.playingPreset&&t++;return t}uf(t){if(this.Wu&&t<this.Wu.channelList.length)return this.Wu.channelList[t];this.Wu||(this.Wu=new $n);for(let e=this.Wu.channelList.length;e<=t;e++){const t=new Gn;t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0,t.mixVolume=1,this.Wu.channelList.push(t)}return this.Wu.channelList[t]}pf(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this.pf(t,e))}channelNoteOn(t,e,s){!this.Wu||t>this.Wu.channelList.length||(this.hf.has(t)&&(e+=this.hf.get(t)),this.cf.has(t)&&(e+=this.cf.get(t)),this.Wu.activeChannel=t,this.noteOn(this.Wu.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this.hf.has(t)&&(e+=this.hf.get(t)),this.cf.has(t)&&(e+=this.cf.get(t));const s=[];let i=null,n=null;for(const r of this.df)-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=cs.Release||(!i||r.playIndex<i.playIndex?(i=r,n=r,s.push(r)):r.playIndex===i.playIndex&&(n=r,s.push(r)));if(this.uf(t).perNotePitchWheel.delete(e),i)for(const r of s)r!==i&&r!==n&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=cs.Release)||r.end(this.outSampleRate)}channelNoteOffAll(t){this.uf(t).perNotePitchWheel.clear();for(const e of this.df)-1!==e.playingPreset&&e.playingChannel===t&&e.ampEnv.segment<cs.Release&&e.end(this.outSampleRate)}channelSoundsOffAll(t){this.uf(t).perNotePitchWheel.clear();for(const e of this.df)-1!==e.playingPreset&&e.playingChannel===t&&(e.ampEnv.segment<cs.Release||0===e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this.uf(t).presetIndex=ae.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this.uf(t);let n=0;return s?(n=this.pf(128|32767&i.bank,e),-1===n&&(n=this.pf(128,e)),-1===n&&(n=this.pf(128,0)),-1===n&&(n=this.pf(2047&i.bank,e))):n=this.pf(2047&i.bank,e),i.presetIndex=n,-1!==n}channelSetBank(t,e){this.uf(t).bank=ae.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this.uf(t),n=this.pf(e,s);return-1!==n&&(i.presetIndex=ae.int32ToUint16(n),i.bank=ae.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this.df)if(s.playingChannel===t&&-1!==s.playingPreset){const t=s.region.pan+e-.5;t<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):t>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-t),s.panFactorRight=Math.sqrt(.5+t))}this.uf(t).panOffset=e-.5}channelSetVolume(t,e){const s=this.uf(t),i=Hn.gainToDecibels(e),n=i-s.gainDb;if(0!==n){for(const e of this.df)e.playingChannel===t&&-1!==e.playingPreset&&(e.noteGainDb+=n);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this.uf(t);s.pitchWheel!==e&&(s.pitchWheel=ae.int32ToUint16(e),this.bf(t,s))}channelSetPerNotePitchWheel(t,e,s){this.hf.has(t)&&(e+=this.hf.get(t)),this.cf.has(t)&&(e+=this.cf.get(t));const i=this.uf(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this.bf(t,i,e))}bf(t,e,s=-1){for(const i of this.df)i.playingChannel!==t||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this.uf(t);s.pitchRange!==e&&(s.pitchRange=e,8192!==s.pitchWheel&&this.bf(t,s))}channelSetTuning(t,e){const s=this.uf(t);s.tuning!==e&&(s.tuning=e,this.bf(t,s))}channelMidiControl(t,e,s){const i=this.uf(t);switch(e){case ls.DataEntryFine:return i.midiData=ae.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case ls.VolumeCoarse:return i.midiVolume=ae.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ls.VolumeFine:return i.midiVolume=ae.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ls.ExpressionControllerCoarse:return i.midiExpression=ae.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ls.ExpressionControllerFine:return i.midiExpression=ae.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case ls.PanCoarse:return i.midiPan=ae.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(t,i.midiPan/16383);case ls.PanFine:return i.midiPan=ae.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(t,i.midiPan/16383);case ls.DataEntryCoarse:return i.midiData=ae.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&e===ls.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case ls.BankSelectCoarse:return void(i.bank=ae.int32ToUint16(32768|s));case ls.BankSelectFine:return void(i.bank=ae.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case ls.RegisteredParameterCourse:return void(i.midiRpn=ae.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case ls.RegisteredParameterFine:return void(i.midiRpn=ae.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case ls.NonRegisteredParameterFine:case ls.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case ls.AllSoundOff:return void this.channelSoundsOffAll(t);case ls.AllNotesOff:return void this.channelNoteOffAll(t);case ls.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),void this.channelSetPitchRange(t,2)}}channelGetPresetIndex(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].presetIndex:0}channelGetPresetBank(t){return this.Wu&&t<this.Wu.channelList.length?32767&this.Wu.channelList[t].bank:0}channelGetPan(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this.Wu&&t<this.Wu.channelList.length?Hn.decibelsToGain(this.Wu.channelList[t].gainDb):1}channelGetPitchWheel(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].pitchRange:2}channelGetTuning(t){return this.Wu&&t<this.Wu.channelList.length?this.Wu.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const n=[];for(let i=0;i<t.phdrs.length-1;i++){const r=t.phdrs[i];let a=0;const h=new Vn;n.push(h),h.name=r.presetName,h.bank=r.bank,h.presetNumber=r.preset;let o=0;for(let e=r.presetBagNdx;e<t.phdrs[i+1].presetBagNdx;e++){let s=0,i=127,n=0,r=127;for(let a=t.pbags[e].genNdx;a<t.pbags[e+1].genNdx;a++){const e=t.pgens[a];if(e.genOper===Ln.GenKeyRange){s=e.genAmount.lowByteAmount,i=e.genAmount.highByteAmount;continue}if(e.genOper===Ln.GenVelRange){n=e.genAmount.lowByteAmount,r=e.genAmount.highByteAmount;continue}if(e.genOper!==Ln.GenInstrument)continue;if(e.genAmount.wordAmount>=t.insts.length)continue;for(let a=t.insts[e.genAmount.wordAmount].instBagNdx;a<t.insts[e.genAmount.wordAmount+1].instBagNdx;a++){let e=0,h=127,c=0,l=127;for(let u=t.ibags[a].instGenNdx;u<t.ibags[a+1].instGenNdx;u++){const a=t.igens[u];a.genOper!==Ln.GenKeyRange?a.genOper!==Ln.GenVelRange?53===a.genOper&&h>=s&&e<=i&&l>=n&&c<=r&&o++:(c=a.genAmount.lowByteAmount,l=a.genAmount.highByteAmount):(e=a.genAmount.lowByteAmount,h=a.genAmount.highByteAmount)}}}}h.regions=new Array(o);let c=new zn;c.clear(!0);for(let n=r.presetBagNdx;n<t.phdrs[i+1].presetBagNdx;n++){const i=t.pbags[n],o=new zn(c);let l=!1;for(let c=i.genNdx;c<t.pbags[n+1].genNdx;c++){const i=t.pgens[c];if(i.genOper===Ln.GenInstrument){const n=i.genAmount.wordAmount;if(n>=t.insts.length)continue;let c=new zn;c.clear(!1);const u=t.insts[n];for(let i=u.instBagNdx;i<t.insts[n+1].instBagNdx;i++){const n=t.ibags[i],l=new zn(c);let d=!1;for(let c=n.instGenNdx;c<t.ibags[i+1].instGenNdx;c++){const i=t.igens[c];if(i.genOper===Ln.GenSampleId){if(l.hiKey<o.loKey||l.loKey>o.hiKey)continue;if(l.hiVel<o.loVel||l.loVel>o.hiVel)continue;o.loKey>l.loKey&&(l.loKey=o.loKey),o.hiKey<l.hiKey&&(l.hiKey=o.hiKey),o.loVel>l.loVel&&(l.loVel=o.loVel),o.hiVel<l.hiVel&&(l.hiVel=o.hiVel),l.offset+=o.offset,l.end+=o.end,l.loopStart+=o.loopStart,l.loopEnd+=o.loopEnd,l.transpose+=o.transpose,l.tune+=o.tune,l.pitchKeyTrack+=o.pitchKeyTrack,l.attenuation+=o.attenuation,l.pan+=o.pan,l.ampEnv.delay+=o.ampEnv.delay,l.ampEnv.attack+=o.ampEnv.attack,l.ampEnv.hold+=o.ampEnv.hold,l.ampEnv.decay+=o.ampEnv.decay,l.ampEnv.sustain+=o.ampEnv.sustain,l.ampEnv.release+=o.ampEnv.release,l.modEnv.delay+=o.modEnv.delay,l.modEnv.attack+=o.modEnv.attack,l.modEnv.hold+=o.modEnv.hold,l.modEnv.decay+=o.modEnv.decay,l.modEnv.sustain+=o.modEnv.sustain,l.modEnv.release+=o.modEnv.release,l.initialFilterQ+=o.initialFilterQ,l.initialFilterFc+=o.initialFilterFc,l.modEnvToPitch+=o.modEnvToPitch,l.modEnvToFilterFc+=o.modEnvToFilterFc,l.delayModLFO+=o.delayModLFO,l.freqModLFO+=o.freqModLFO,l.modLfoToPitch+=o.modLfoToPitch,l.modLfoToFilterFc+=o.modLfoToFilterFc,l.modLfoToVolume+=o.modLfoToVolume,l.delayVibLFO+=o.delayVibLFO,l.freqVibLFO+=o.freqVibLFO,l.vibLfoToPitch+=o.vibLfoToPitch,l.ampEnv.envToSecs(!0),l.modEnv.envToSecs(!1),l.delayModLFO=l.delayModLFO<-11950?0:Hn.timecents2Secs(l.delayModLFO),l.delayVibLFO=l.delayVibLFO<-11950?0:Hn.timecents2Secs(l.delayVibLFO),l.pan<-.5?l.pan=-.5:l.pan>.5&&(l.pan=.5),(l.initialFilterQ<1500||l.initialFilterQ>13500)&&(l.initialFilterQ=0);const n=t.sHdrs[i.genAmount.wordAmount];l.offset+=n.start,l.end+=n.end,l.loopStart+=n.startLoop,l.loopEnd+=n.endLoop,n.endLoop>0&&(l.loopEnd-=1),-1===l.pitchKeyCenter&&(l.pitchKeyCenter=n.originalPitch),l.tune+=n.pitchCorrection,l.sampleRate=n.sampleRate;const c=r.bank===Gt.PercussionBank;if(c&&Qn.mf(s,l.loKey,l.hiKey)||!c&&e.has(r.preset))if(1&n.sampleType){j.debug("AlphaSynth",`Loading of used sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`);!!(16&n.sampleType)?l.samples=t.decodeSamples(n.start,n.end,!0):(l.samples=t.decodeSamples(2*l.offset,2*l.end,!1),l.loopStart>0&&(l.loopStart-=l.offset),l.loopEnd>0&&(l.loopEnd-=l.offset)),l.offset=0,l.end=l.samples.length-1}else j.warning("AlphaSynth",`Skipping load of unsupported sample ${n.sampleName} for preset ${r.presetName}, sample type ${n.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);else j.debug("AlphaSynth",`Skipping load of unused sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);h.regions[a]=new zn(l),a++,d=!0}else l.operator(i.genOper,i.genAmount)}n!==t.ibags[u.instBagNdx]||d||(c=new zn(l))}l=!0}else o.operator(i.genOper,i.genAmount)}i!==t.pbags[r.presetBagNdx]||l||(c=o)}}if(i&&this.presets)for(const t of n)this.presets.push(t);else this.presets=n}static mf(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t)for(const t of s.regions)if(t.samples.length>0)return!0;return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===Gt.PercussionBank)for(const e of s.regions)if(e.loKey>=t&&e.hiKey<=t&&e.samples.length>0)return!0;return!1}}class Zn{events;constructor(t){this.events=t}}class tr{playbackRange;constructor(t){this.playbackRange=t}}class er{soundFonts;sampleRate=44100;useSyncPoints=!1;masterVolume=1;metronomeVolume=0;playbackRange;trackVolume=new Map;trackTranspositionPitches=new Map}class sr{samples;currentTime=0;endTime=0;currentTick=0;endTick=0}class ir{sequencer;synthesizer;isSoundFontLoaded=!1;gf=!1;wf=0;yf=0;kf=0;Sf=0;playedEventsQueue=new Kn;midiEventsPlayedFilterSet=new Set;Bf=0;_f=!1;Hi;xf;Wd=new Xi(0,0,0,0,!1,120,120);get output(){return this.Hi}isReady=!1;get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this.gf}state=is.Paused;get logLevel(){return j.logLevel}set logLevel(t){j.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,Gt.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this.kf}set metronomeVolume(t){t=Math.max(t,Gt.MinVolume),this.kf=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this.Sf}set countInVolume(t){t=Math.max(t,Gt.MinVolume),this.Sf=t}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(t){this.midiEventsPlayedFilterSet=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=Ht.clamp(t,Gt.MinPlaybackSpeed,Gt.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this.xf}get currentPosition(){return this.Wd}get tickPosition(){return this.wf}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this.yf}set timePosition(t){j.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this.Bf=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new tr(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){j.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(t,e,s){j.debug("AlphaSynth","Initializing player"),this.state=is.Paused,this.ready=new Te(()=>this.isReady),this.readyForPlayback=new Te(()=>this.isReadyForPlayback),this.midiLoaded=new Me(()=>this.xf?this.xf:null),this.stateChanged=new Me(()=>new ji(this.state,!1)),this.positionChanged=new Me(()=>this.Wd),this.playbackRangeChanged=new Me(()=>this.playbackRange?new tr(this.playbackRange):null),j.debug("AlphaSynth","Creating output"),this.Hi=t,j.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new zi(this.synthesizer),j.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.Tf()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.Mf.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===is.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(Gt.MicroBufferSize*Gt.MicroBufferCount*Gt.AudioChannels),e=0;for(let s=0;s<Gt.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const s=this.synthesizer.synthesize(t,e,Gt.MicroBufferSize);e+=Gt.MicroBufferSize*Gt.AudioChannels;for(const t of s)this.midiEventsPlayedFilterSet.has(t.event.type)&&this.playedEventsQueue.enqueue(t);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this.Bf+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return!(this.state!==is.Paused||!this.gf)&&(this.output.activate(),this.vf(),this.Sf>0&&(j.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this.Sf),this.updateTimePosition(0,!0)),this.output.play(),!0)}vf(){this.sequencer.isPlayingOneTimeMidi&&(j.debug("AlphaSynth","Cancelling one time midi"),this.Nf()),j.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._f=!1,this.state=is.Playing,this.stateChanged.trigger(new ji(this.state,!1))}pause(){this.state!==is.Paused&&this.gf&&(j.debug("AlphaSynth","Pausing playback"),this.state=is.Paused,this.stateChanged.trigger(new ji(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===is.Paused&&this.gf?this.play():this.pause()}stop(){this.gf&&(j.debug("AlphaSynth","Stopping playback"),this.state=is.Paused,this.output.pause(),this.Bf=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new ji(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this.Nf():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this.Bf=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this.Pf=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}Pf=[];loadSoundFont(t,e){this.pause();const s=Ie.fromBuffer(t);try{j.debug("AlphaSynth","Loading soundfont from bytes");const t=new Pn;t.load(s),e||(this.Pf=[]),this.Pf.push(t),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),j.debug("AlphaSynth","soundFont successfully loaded"),this.Tf()}catch(t){j.error("AlphaSynth",`Could not load soundfont from bytes ${t}`),this.soundFontLoadFailed.trigger(t)}}Tf(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this.Pf)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{j.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this.gf=!0,this.xf=new Xi(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this.xf),j.debug("AlphaSynth","Midi successfully loaded"),this.Tf(),this.tickPosition=0}catch(t){j.error("AlphaSynth",`Could not load midi from model ${t}`),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,Gt.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}Mf(t){if(0===t)return;const e=t/this.synthesizer.outSampleRate*1e3;this.Bf-=t*Gt.AudioChannels,this.updateTimePosition(this.yf+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this.wf>=e&&(this.Bf<=0?(this.Bf=0,this.sequencer.isPlayingCountIn?(j.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.vf(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(j.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=is.Paused,this.Nf()):this.isLooping?(j.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this._f=!1):this.synthesizer.activeVoiceCount>0?this._f||(j.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._f=!0):(this._f=!1,j.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._f||(j.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._f=!0))}Nf(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}Ef(t){let e=this.yf,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,n=this.sequencer.currentEndTick;return e>i&&(e=i,s=n),new Xi(e,i,s,n,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this.yf=t;const s=this.Ef(e);this.wf=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(j.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this.Wd=s,this.positionChanged.trigger(s)),e)this.playedEventsQueue.clear();else{const t=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const e=this.playedEventsQueue.dequeue();t.push(e.event)}t.length>0&&(t.reverse(),this.midiEventsPlayed.trigger(new Zn(t)))}}ready;readyForPlayback=new Te;finished=new Te;soundFontLoaded=new Te;soundFontLoadFailed=new Me;midiLoaded;midiLoadFailed=new Me;stateChanged;positionChanged;midiEventsPlayed=new Me;playbackRangeChanged;hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class nr extends ir{constructor(t,e){super(t,new Qn(t.sampleRate),e)}exportAudio(t,e,s,i){const n=new rr(t);n.loadMidiFile(e),t.useSyncPoints&&n.updateSyncPoints(s),n.applyTranspositionPitches(i);for(const[e,s]of t.trackTranspositionPitches)n.setChannelTranspositionPitch(e,s);for(const[e,s]of t.trackVolume)n.channelSetMixVolume(e,s);if(t.soundFonts)for(const e of t.soundFonts)n.loadSoundFont(e);else n.loadPresets(this.synthesizer.presets);return t.playbackRange&&n.limitExport(t.playbackRange),n.setup(),n}}class rr{Cf;Ff;constructor(t){this.Cf=new Qn(t.sampleRate),this.Ff=new zi(this.Cf),this.Cf.masterVolume=Math.max(t.masterVolume,Gt.MinVolume),this.Cf.metronomeVolume=Math.max(t.metronomeVolume,Gt.MinVolume)}loadSoundFont(t){const e=Ie.fromBuffer(t),s=new Pn;s.load(e);const i=this.Ff.instrumentPrograms,n=this.Ff.percussionKeys;this.Cf.loadPresets(s,i,n,!0)}loadPresets(t){this.Cf.presets=t}limitExport(t){this.Ff.mainPlaybackRange=t,this.Ff.mainSeek(this.Ff.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this.Cf.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this.Cf.applyTranspositionPitches(t)}loadMidiFile(t){this.Ff.loadMidi(t)}updateSyncPoints(t){this.Ff.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,Gt.MinVolume),this.Cf.channelSetMixVolume(t,e)}Af=0;Df=0;setup(){this.Cf.setupMetronomeChannel(this.Cf.metronomeVolume);const t=this.Ff.currentSyncPoints,e=this.Ff.currentEndTime;if(0===t.length)this.Df=e;else{const e=t[t.length-1];let s=e.syncTime;const i=this.Ff.currentEndTick-e.synthTick;i>0&&(s+=I.ticksToMillis(i,e.syncBpm)),this.Df=s}}render(t){if(this.Ff.isFinished)return;const e=1e3*Gt.MicroBufferSize/this.Cf.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(Gt.MicroBufferSize*s*Gt.AudioChannels);const n=this.Ff.currentSyncPoints;let r=0,a=this.Af;for(let t=0;t<s;t++){if(n.length>0){this.Ff.currentUpdateSyncPoints(a),this.Ff.currentUpdateCurrentTempo(this.Ff.currentTime);const t=this.Ff.syncPointTempo/this.Ff.currentTempo;this.Ff.playbackSpeed!==t&&(this.Ff.playbackSpeed=t)}if(this.Ff.fillMidiEventQueue(),this.Cf.synthesize(i,r,Gt.MicroBufferSize),r+=Gt.MicroBufferSize*Gt.AudioChannels,a+=e,this.Ff.isFinished)break}r<i.length&&(i=i.subarray(0,r));const h=new sr;return h.currentTime=this.Af,h.endTime=this.Df,h.currentTick=this.Ff.currentTimePositionToTickPosition(this.Ff.currentTime),h.endTick=this.Ff.currentEndTick,this.Af+=t,h.samples=i,this.Ff.isFinished&&this.Cf.noteOffAll(!0),h}}class ar{static parseEnum(e,s){switch(typeof e){case"string":const t=Number.parseInt(e,10);return Number.isNaN(t)?s[Object.keys(s).find(t=>t.toLowerCase()===e.toLowerCase())]:t;case"number":return e;case"undefined":case"object":return}throw new R(t.AlphaTabErrorType.Format,`Could not parse enum value '${e}'`)}static parseEnumExact(t,e){if(t in e)return e[t]}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if("object"==typeof t)for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):"object"==typeof t?t[e]:null}}class hr{startPos;endPos;text;constructor(t,e,s){this.text=t,this.startPos=e,this.endPos=s}}class or{style="normal";variant="normal";weight="normal";stretch="normal";lineHeight="normal";size="1rem";families=[];parseOnlyFamilies=!1;Lf;Wf=-1;zi="";Rf=null;constructor(t){this.zi=t,this.Lf=this.Of(t)}Of(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&" "!==t.charAt(i);)i++;i>s&&e.push(new hr(t.substring(s,i),s,i)),s=i+1}return e}parse(){if(this.If(),1===this.Lf.length)switch(this.Rf?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.Gf(),this.$f()),this.Vf()}static parseFamilies(t){const e=new or(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}Vf(){if(!this.Rf){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this.zi.substr(this.Rf.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(" "===s||","===s)e++;else if('"'===s||"'"===s){const i=this.Hf(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const s=this.Hf(t,e+1,",");this.families.push(t.substring(e,s).trim()),e=s+1}}}Hf(t,e,s){let i=!1;for(;e<t.length;){const n=t.charAt(e);if(!i&&n===s)return e;i=!i&&"\\"===n,e+=1}return t.length}$f(){if(!this.Rf)throw new Error("Missing font size");const t=this.Rf.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this.Rf}' specified`);if(this.Uf(),t.length>=2)if("/"===t[1]){if(!this.Rf)throw new Error("Missing line-height after font size");this.lineHeight=this.Rf.text,this.Uf()}else this.size=t[0],this.lineHeight=t[1];else{if(!(t.length>=1))throw new Error("Missing font size");if(this.size=t[0],this.Rf&&0===this.Rf.text.indexOf("/"))if("/"===this.Rf.text){if(this.Uf(),!this.Rf)throw new Error("Missing line-height after font size");this.lineHeight=this.Rf.text,this.Uf()}else this.lineHeight=this.Rf.text.substr(1),this.Uf()}}Uf(){this.Wf++,this.Wf<this.Lf.length?this.Rf=this.Lf[this.Wf]:this.Rf=null}Gf(){let t=!1,e=!1,s=!1,i=3;const n=[];for(;;){if(!this.Rf)return;const r=this.Rf.text;switch(r){case"normal":case"inherit":n.push(r),i--,this.Uf();break;case"italic":case"oblique":this.style=r,t=!0,i--,this.Uf();break;case"small-caps":this.variant=r,e=!0,i--,this.Uf();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this.Uf();break;default:return}if(0===i)break}for(;n.length>0;){const i=n.pop();s?e?t||(this.style=i):this.variant=i:this.weight=i}}If(){this.Wf=-1,this.Uf()}static quoteFont(t){if(-1===t.indexOf(" "))return t;return`"${t.replaceAll('"','\\"')}"`}}!function(t){t[t.Plain=0]="Plain",t[t.Italic=1]="Italic"}(us||(us={})),function(t){t[t.Regular=0]="Regular",t[t.Bold=1]="Bold"}(ds||(ds={}));class cr{zf;jf=0;Xf;Jf;qf;_i;If(){this.jf=0,this.zf=this.toCssString()}get family(){return this.Xf[0]}set family(t){this.families=or.parseFamilies(t)}get families(){return this.Xf}set families(t){this.Xf=t,this.If()}get size(){return this._i}set size(t){this._i=t,this.If()}get style(){return this.Jf}set style(t){this.Jf=t,this.If()}get weight(){return this.qf}set weight(t){this.qf=t,this.If()}get isBold(){return this.weight===ds.Bold}get isItalic(){return this.style===us.Italic}constructor(t,e,s=us.Plain,i=ds.Regular){this.Xf=or.parseFamilies(t),this._i=e,this.Jf=s,this.qf=i,this.zf=this.toCssString()}withSize(t){return cr.withFamilyList(this.Xf,t,this.Jf,this.qf)}static withFamilyList(t,e,s=us.Plain,i=ds.Regular){const n=new cr("",e,s,i);return n.families=t,n}toCssString(t=1){if(!(this.zf&&Math.abs(t-this.jf)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(t=>or.quoteFont(t)).join(", "),this.zf=e,this.jf=t}return this.zf}static fromJson(t){if(t instanceof cr)return t;switch(typeof t){case"undefined":default:return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),n=ar.parseEnum(e.get("style"),us),r=ar.parseEnum(e.get("weight"),ds);return cr.withFamilyList(s,i,n,r)}case"string":{const e=new or(t);e.parse();const s=e.families,i=e.size.toLowerCase();let n=0;switch(i){case"xx-small":n=7;break;case"x-small":n=10;break;case"small":case"smaller":n=13;break;case"medium":n=16;break;case"large":case"larger":n=18;break;case"x-large":n=24;break;case"xx-large":n=32;break;default:try{n=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{n=12}}let r=us.Plain;"italic"===e.style&&(r=us.Italic);let a=ds.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:a=ds.Bold}return cr.withFamilyList(s,n,r,a)}}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}class lr{static clone(t){const e=new dr;return e.musicFontSize=t.musicFontSize,e.oneStaffSpace=t.oneStaffSpace,e.tabLineSpacing=t.tabLineSpacing,e.arrowShaftThickness=t.arrowShaftThickness,e.barlineSeparation=t.barlineSeparation,e.beamSpacing=t.beamSpacing,e.beamThickness=t.beamThickness,e.bracketThickness=t.bracketThickness,e.dashedBarlineDashLength=t.dashedBarlineDashLength,e.dashedBarlineGapLength=t.dashedBarlineGapLength,e.dashedBarlineThickness=t.dashedBarlineThickness,e.hairpinThickness=t.hairpinThickness,e.legerLineThickness=t.legerLineThickness,e.legerLineExtension=t.legerLineExtension,e.octaveLineThickness=t.octaveLineThickness,e.pedalLineThickness=t.pedalLineThickness,e.repeatBarlineDotSeparation=t.repeatBarlineDotSeparation,e.repeatEndingLineThickness=t.repeatEndingLineThickness,e.slurMidpointThickness=t.slurMidpointThickness,e.staffLineThickness=t.staffLineThickness,e.stemThickness=t.stemThickness,e.thickBarlineThickness=t.thickBarlineThickness,e.thinBarlineThickness=t.thinBarlineThickness,e.thinThickBarlineSeparation=t.thinThickBarlineSeparation,e.tieMidpointThickness=t.tieMidpointThickness,e.tupletBracketThickness=t.tupletBracketThickness,e.stemUp=new Map(t.stemUp),e.stemDown=new Map(t.stemDown),e.repeatOffsetX=new Map(t.repeatOffsetX),e.standardStemLength=t.standardStemLength,e.stemFlagOffsets=new Map(t.stemFlagOffsets),e.glyphTop=new Map(t.glyphTop),e.glyphBottom=new Map(t.glyphBottom),e.glyphWidths=new Map(t.glyphWidths),e.glyphHeights=new Map(t.glyphHeights),e.numberedBarRendererBarSize=t.numberedBarRendererBarSize,e.numberedBarRendererBarSpacing=t.numberedBarRendererBarSpacing,e.numberedDashGlyphPadding=t.numberedDashGlyphPadding,e.numberedDashGlyphWidth=t.numberedDashGlyphWidth,e.lineRangedGlyphDashGap=t.lineRangedGlyphDashGap,e.lineRangedGlyphDashSize=t.lineRangedGlyphDashSize,e.preNoteEffectPadding=t.preNoteEffectPadding,e.postNoteEffectPadding=t.postNoteEffectPadding,e.onNoteEffectPadding=t.onNoteEffectPadding,e.stringNumberCirclePadding=t.stringNumberCirclePadding,e.rowContainerPadding=t.rowContainerPadding,e.rowContainerGap=t.rowContainerGap,e.alternateEndingsPadding=t.alternateEndingsPadding,e.sustainPedalLinePadding=t.sustainPedalLinePadding,e.tieHeight=t.tieHeight,e.beatTimerPadding=t.beatTimerPadding,e.bendNoteHeadElementPadding=t.bendNoteHeadElementPadding,e.ghostParenthesisWidth=t.ghostParenthesisWidth,e.ghostParenthesisPadding=t.ghostParenthesisPadding,e.brokenBeamWidth=t.brokenBeamWidth,e.tabWhammyTextPadding=t.tabWhammyTextPadding,e.tabWhammyPerHalfHeight=t.tabWhammyPerHalfHeight,e.tabWhammyDashSize=t.tabWhammyDashSize,e.songBookWhammyDipHeight=t.songBookWhammyDipHeight,e.deadSlappedLineWidth=t.deadSlappedLineWidth,e.leftHandTabTieWidth=t.leftHandTabTieWidth,e.tabBendDashSize=t.tabBendDashSize,e.tabBendPerValueHeight=t.tabBendPerValueHeight,e.tabBendLabelPadding=t.tabBendLabelPadding,e.simpleSlideWidth=t.simpleSlideWidth,e.simpleSlideHeight=t.simpleSlideHeight,e.chordDiagramPaddingX=t.chordDiagramPaddingX,e.chordDiagramPaddingY=t.chordDiagramPaddingY,e.chordDiagramStringSpacing=t.chordDiagramStringSpacing,e.chordDiagramFretSpacing=t.chordDiagramFretSpacing,e.chordDiagramNutHeight=t.chordDiagramNutHeight,e.chordDiagramFretHeight=t.chordDiagramFretHeight,e.chordDiagramLineWidth=t.chordDiagramLineWidth,e.tripletFeelBracketPadding=t.tripletFeelBracketPadding,e.accidentalPadding=t.accidentalPadding,e.preBeatGlyphSpacing=t.preBeatGlyphSpacing,e.tempoNoteScale=t.tempoNoteScale,e.tuningGlyphCircleNumberScale=t.tuningGlyphCircleNumberScale,e.tuningGlyphStringColumnScale=t.tuningGlyphStringColumnScale,e.tuningGlyphStringRowPadding=t.tuningGlyphStringRowPadding,e.directionsScale=t.directionsScale,e}}class ur{topY=0;bottomY=0;x=0}class dr{static Yf;static get bravuraDefaults(){let t=dr.Yf;return t||(t=new dr,t.fillFromSmufl(dr.bravuraMetadata),dr.Yf=t),lr.clone(t)}musicFontSize=0;oneStaffSpace=0;tabLineSpacing=0;arrowShaftThickness=0;barlineSeparation=0;beamSpacing=0;beamThickness=0;bracketThickness=0;dashedBarlineDashLength=0;dashedBarlineGapLength=0;dashedBarlineThickness=0;hairpinThickness=0;legerLineThickness=0;legerLineExtension=0;octaveLineThickness=0;pedalLineThickness=0;repeatBarlineDotSeparation=0;repeatEndingLineThickness=0;slurMidpointThickness=0;staffLineThickness=0;stemThickness=0;thickBarlineThickness=0;thinBarlineThickness=0;thinThickBarlineSeparation=0;tieMidpointThickness=0;tupletBracketThickness=0;stemUp=new Map;stemDown=new Map;repeatOffsetX=new Map;standardStemLength=0;stemFlagOffsets=new Map;glyphTop=new Map;glyphBottom=new Map;glyphWidths=new Map;glyphHeights=new Map;hasSymbol(t){return this.glyphWidths.get(t)>0&&this.glyphHeights.get(t)>0}fillFromSmufl(t,e=36){this.musicFontSize=e,this.oneStaffSpace=e/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof t.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(l.QuadrupleWhole,0),this.stemFlagOffsets.set(l.DoubleWhole,0),this.stemFlagOffsets.set(l.Whole,0),this.stemFlagOffsets.set(l.Half,0),this.stemFlagOffsets.set(l.Quarter,0),this.stemFlagOffsets.set(l.Eighth,0),this.stemFlagOffsets.set(l.Sixteenth,0),this.stemFlagOffsets.set(l.ThirtySecond,0),this.stemFlagOffsets.set(l.SixtyFourth,0),this.stemFlagOffsets.set(l.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(l.TwoHundredFiftySixth,0);for(const[e,s]of Object.entries(t.glyphsWithAnchors)){const t=dr.Kf(e);if(t){if(s.stemDownNW){const e=new ur;e.x=s.stemDownNW[0]*this.oneStaffSpace,e.topY=s.stemDownNW[1]*this.oneStaffSpace,s.stemDownSW?e.bottomY=s.stemDownSW[1]*this.oneStaffSpace:e.bottomY=0,this.stemDown.set(t,e)}if(s.stemUpSE){const e=new ur,i=s.stemUpSE[0]*this.oneStaffSpace;e.bottomY=s.stemUpSE[1]*this.oneStaffSpace,s.stemUpNW?(e.x=s.stemUpNW[0]*this.oneStaffSpace,e.topY=s.stemUpNW[1]*this.oneStaffSpace):(e.x=i-this.stemThickness,e.topY=0),this.stemUp.set(t,e)}if(s.repeatOffset&&this.repeatOffsetX.set(t,s.repeatOffset[0]*this.oneStaffSpace),s.stemUpNW){const e=s.stemUpNW[1]*this.oneStaffSpace;switch(t){case at.Flag8thUp:this.stemFlagOffsets.set(l.Eighth,e);break;case at.Flag16thUp:this.stemFlagOffsets.set(l.Sixteenth,e);break;case at.Flag32ndUp:this.stemFlagOffsets.set(l.ThirtySecond,e);break;case at.Flag64thUp:this.stemFlagOffsets.set(l.SixtyFourth,e);break;case at.Flag128thUp:this.stemFlagOffsets.set(l.OneHundredTwentyEighth,e);break;case at.Flag256thUp:this.stemFlagOffsets.set(l.TwoHundredFiftySixth,e)}}}}const i=new Set,n=t.glyphBBoxes;if(n)for(const[t,e]of Object.entries(n)){const s=dr.Kf(t);s&&(i.add(s),this.glyphTop.set(s,e.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(s,e.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(s,(e.bBoxNE[0]-e.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(s,(e.bBoxNE[1]-e.bBoxSW[1])*this.oneStaffSpace))}const r=new Set([at.None,at.Space,at.NoteheadNull]);for(const t of Ht.getAllMusicFontSymbols())i.has(t)||(r.has(t)||j.warning("SmuFL",`The provided SmuFL font is missing the glyph ${at[t]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(t,0),this.glyphBottom.set(t,0),this.glyphWidths.set(t,0),this.glyphHeights.set(t,0));this.numberedBarRendererBarSize=2*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]);static Kf(t){const e=dr.smuflNameToGlyphNameMapping.has(t)?dr.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return ar.parseEnumExact(e,at)}numberedBarRendererBarSize=0;numberedBarRendererBarSpacing=0;numberedDashGlyphPadding=0;numberedDashGlyphWidth=0;lineRangedGlyphDashGap=0;lineRangedGlyphDashSize=0;preNoteEffectPadding=0;postNoteEffectPadding=0;onNoteEffectPadding=0;stringNumberCirclePadding=0;rowContainerPadding=0;rowContainerGap=0;alternateEndingsPadding=0;sustainPedalLinePadding=0;tieHeight=0;beatTimerPadding=0;bendNoteHeadElementPadding=0;ghostParenthesisWidth=0;ghostParenthesisPadding=0;brokenBeamWidth=0;tabWhammyTextPadding=0;tabWhammyPerHalfHeight=0;tabWhammyDashSize=0;songBookWhammyDipHeight=0;deadSlappedLineWidth=0;leftHandTabTieWidth=0;tabBendDashSize=0;tabBendPerValueHeight=0;tabBendLabelPadding=0;simpleSlideWidth=0;simpleSlideHeight=0;chordDiagramPaddingX=0;chordDiagramPaddingY=0;chordDiagramStringSpacing=0;chordDiagramFretSpacing=0;chordDiagramNutHeight=0;chordDiagramFretHeight=0;chordDiagramLineWidth=0;tripletFeelBracketPadding=0;accidentalPadding=0;preBeatGlyphSpacing=0;tempoNoteScale=.7;tuningGlyphCircleNumberScale=.7;tuningGlyphStringColumnScale=1.5;tuningGlyphStringRowPadding=0;directionsScale=.6;static bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}}}class fr{static Qf="Arial, sans-serif";static Zf="Georgia, serif";smuflFontFamilyName;engravingSettings=dr.bravuraDefaults;copyrightFont=new cr(fr.Qf,12,us.Plain,ds.Bold);titleFont=new cr(fr.Zf,32,us.Plain);subTitleFont=new cr(fr.Zf,20,us.Plain);wordsFont=new cr(fr.Zf,15,us.Plain);effectFont=new cr(fr.Zf,12,us.Italic);timerFont=new cr(fr.Zf,12,us.Plain);directionsFont=new cr(fr.Zf,14,us.Plain);fretboardNumberFont=new cr(fr.Qf,11,us.Plain);numberedNotationFont=new cr(fr.Qf,16,us.Plain);numberedNotationGraceFont=new cr(fr.Qf,14,us.Plain);tablatureFont=new cr(fr.Qf,14,us.Plain);graceFont=new cr(fr.Qf,12,us.Plain);staffLineColor=new be(165,165,165,255);barSeparatorColor=new be(34,34,17,255);barNumberFont=new cr(fr.Qf,11,us.Plain);barNumberColor=new be(200,0,0,255);fingeringFont=new cr(fr.Zf,14,us.Plain);inlineFingeringFont=new cr(fr.Zf,12,us.Plain);markerFont=new cr(fr.Zf,14,us.Plain,ds.Bold);mainGlyphColor=new be(0,0,0,255);secondaryGlyphColor=new be(0,0,0,100);scoreInfoColor=new be(0,0,0,255);getFontForElement(t){switch(t){case nt.Title:return this.titleFont;case nt.SubTitle:case nt.Artist:case nt.Album:return this.subTitleFont;case nt.Words:case nt.Music:case nt.WordsAndMusic:case nt.Transcriber:return this.wordsFont;case nt.Copyright:case nt.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}t.StaveProfile=void 0,(fs=t.StaveProfile||(t.StaveProfile={}))[fs.Default=0]="Default",fs[fs.ScoreTab=1]="ScoreTab",fs[fs.Score=2]="Score",fs[fs.Tab=3]="Tab",fs[fs.TabMixed=4]="TabMixed",t.SystemsLayoutMode=void 0,(ps=t.SystemsLayoutMode||(t.SystemsLayoutMode={}))[ps.Automatic=0]="Automatic",ps[ps.UseModelLayout=1]="UseModelLayout";class pr{scale=1;stretchForce=1;layoutMode=t.LayoutMode.Page;staveProfile=t.StaveProfile.Default;barsPerRow=-1;startBar=1;barCount=-1;barCountPerPartial=10;justifyLastSystem=!1;resources=new fr;padding=[35,35];firstSystemPaddingTop=5;systemPaddingTop=10;systemPaddingBottom=10;lastSystemPaddingBottom=0;systemLabelPaddingLeft=0;systemLabelPaddingRight=3;accoladeBarPaddingRight=3;notationStaffPaddingTop=5;notationStaffPaddingBottom=5;effectStaffPaddingTop=0;effectStaffPaddingBottom=0;firstStaffPaddingLeft=6;staffPaddingLeft=2;effectBandPaddingBottom=2;systemsLayoutMode=t.SystemsLayoutMode.Automatic}class br{encoding="utf-8";mergePartGroupsInMusicXml=!1;beatTextAsLyrics=!1}t.ScrollMode=void 0,(bs=t.ScrollMode||(t.ScrollMode={}))[bs.Off=0]="Off",bs[bs.Continuous=1]="Continuous",bs[bs.OffScreen=2]="OffScreen";class mr{noteWideLength=240;noteWideAmplitude=1;noteSlightLength=360;noteSlightAmplitude=.5;beatWideLength=480;beatWideAmplitude=2;beatSlightLength=480;beatSlightAmplitude=2}class gr{simpleSlidePitchOffset=6;simpleSlideDurationRatio=.25;shiftSlideDurationRatio=.5}t.PlayerOutputMode=void 0,(ms=t.PlayerOutputMode||(t.PlayerOutputMode={}))[ms.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",ms[ms.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",t.PlayerMode=void 0,(gs=t.PlayerMode||(t.PlayerMode={}))[gs.Disabled=0]="Disabled",gs[gs.EnabledAutomatic=1]="EnabledAutomatic",gs[gs.EnabledSynthesizer=2]="EnabledSynthesizer",gs[gs.EnabledBackingTrack=3]="EnabledBackingTrack",gs[gs.EnabledExternalMedia=4]="EnabledExternalMedia";class wr{soundFont=null;scrollElement="html,body";outputMode=t.PlayerOutputMode.WebAudioAudioWorklets;enablePlayer=!1;playerMode=t.PlayerMode.Disabled;enableCursor=!0;enableAnimatedBeatCursor=!0;enableElementHighlighting=!0;enableUserInteraction=!0;scrollOffsetX=0;scrollOffsetY=0;scrollMode=t.ScrollMode.Continuous;scrollSpeed=300;nativeBrowserSmoothScroll=!0;songBookBendDuration=75;songBookDipDuration=150;vibrato=new mr;slide=new gr;playTripletFeel=!0;bufferTimeInMilliseconds=500}class yr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>yr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),null!==t.smuflFontSources){const s=new Map;e.set("smuflfontsources",s);for(const[e,i]of t.smuflFontSources)s.set(e.toString(),i)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(e,s,i){switch(s){case"scriptfile":return e.scriptFile=i,!0;case"fontdirectory":return e.fontDirectory=i,!0;case"smuflfontsources":return e.smuflFontSources=new Map,ar.forEach(i,(s,i)=>{e.smuflFontSources.set(ar.parseEnum(i,t.FontFileFormat),s)}),!0;case"file":return e.file=i,!0;case"tex":return e.tex=i,!0;case"tracks":return e.tracks=i,!0;case"enablelazyloading":return e.enableLazyLoading=i,!0;case"engine":return e.engine=i,!0;case"loglevel":return e.logLevel=ar.parseEnum(i,t.LogLevel),!0;case"useworkers":return e.useWorkers=i,!0;case"includenotebounds":return e.includeNoteBounds=i,!0}return!1}}class kr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>kr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("topy",t.topY),e.set("bottomy",t.bottomY),e.set("x",t.x),e}static setProperty(t,e,s){switch(e){case"topy":return t.topY=s,!0;case"bottomy":return t.bottomY=s,!0;case"x":return t.x=s,!0}return!1}}class Sr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Sr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("musicfontsize",t.musicFontSize),e.set("onestaffspace",t.oneStaffSpace),e.set("tablinespacing",t.tabLineSpacing),e.set("arrowshaftthickness",t.arrowShaftThickness),e.set("barlineseparation",t.barlineSeparation),e.set("beamspacing",t.beamSpacing),e.set("beamthickness",t.beamThickness),e.set("bracketthickness",t.bracketThickness),e.set("dashedbarlinedashlength",t.dashedBarlineDashLength),e.set("dashedbarlinegaplength",t.dashedBarlineGapLength),e.set("dashedbarlinethickness",t.dashedBarlineThickness),e.set("hairpinthickness",t.hairpinThickness),e.set("legerlinethickness",t.legerLineThickness),e.set("legerlineextension",t.legerLineExtension),e.set("octavelinethickness",t.octaveLineThickness),e.set("pedallinethickness",t.pedalLineThickness),e.set("repeatbarlinedotseparation",t.repeatBarlineDotSeparation),e.set("repeatendinglinethickness",t.repeatEndingLineThickness),e.set("slurmidpointthickness",t.slurMidpointThickness),e.set("stafflinethickness",t.staffLineThickness),e.set("stemthickness",t.stemThickness),e.set("thickbarlinethickness",t.thickBarlineThickness),e.set("thinbarlinethickness",t.thinBarlineThickness),e.set("thinthickbarlineseparation",t.thinThickBarlineSeparation),e.set("tiemidpointthickness",t.tieMidpointThickness),e.set("tupletbracketthickness",t.tupletBracketThickness);{const s=new Map;e.set("stemup",s);for(const[e,i]of t.stemUp)s.set(e.toString(),kr.toJson(i))}{const s=new Map;e.set("stemdown",s);for(const[e,i]of t.stemDown)s.set(e.toString(),kr.toJson(i))}{const s=new Map;e.set("repeatoffsetx",s);for(const[e,i]of t.repeatOffsetX)s.set(e.toString(),i)}e.set("standardstemlength",t.standardStemLength);{const s=new Map;e.set("stemflagoffsets",s);for(const[e,i]of t.stemFlagOffsets)s.set(e.toString(),i)}{const s=new Map;e.set("glyphtop",s);for(const[e,i]of t.glyphTop)s.set(e.toString(),i)}{const s=new Map;e.set("glyphbottom",s);for(const[e,i]of t.glyphBottom)s.set(e.toString(),i)}{const s=new Map;e.set("glyphwidths",s);for(const[e,i]of t.glyphWidths)s.set(e.toString(),i)}{const s=new Map;e.set("glyphheights",s);for(const[e,i]of t.glyphHeights)s.set(e.toString(),i)}return e.set("numberedbarrendererbarsize",t.numberedBarRendererBarSize),e.set("numberedbarrendererbarspacing",t.numberedBarRendererBarSpacing),e.set("numbereddashglyphpadding",t.numberedDashGlyphPadding),e.set("numbereddashglyphwidth",t.numberedDashGlyphWidth),e.set("linerangedglyphdashgap",t.lineRangedGlyphDashGap),e.set("linerangedglyphdashsize",t.lineRangedGlyphDashSize),e.set("prenoteeffectpadding",t.preNoteEffectPadding),e.set("postnoteeffectpadding",t.postNoteEffectPadding),e.set("onnoteeffectpadding",t.onNoteEffectPadding),e.set("stringnumbercirclepadding",t.stringNumberCirclePadding),e.set("rowcontainerpadding",t.rowContainerPadding),e.set("rowcontainergap",t.rowContainerGap),e.set("alternateendingspadding",t.alternateEndingsPadding),e.set("sustainpedallinepadding",t.sustainPedalLinePadding),e.set("tieheight",t.tieHeight),e.set("beattimerpadding",t.beatTimerPadding),e.set("bendnoteheadelementpadding",t.bendNoteHeadElementPadding),e.set("ghostparenthesiswidth",t.ghostParenthesisWidth),e.set("ghostparenthesispadding",t.ghostParenthesisPadding),e.set("brokenbeamwidth",t.brokenBeamWidth),e.set("tabwhammytextpadding",t.tabWhammyTextPadding),e.set("tabwhammyperhalfheight",t.tabWhammyPerHalfHeight),e.set("tabwhammydashsize",t.tabWhammyDashSize),e.set("songbookwhammydipheight",t.songBookWhammyDipHeight),e.set("deadslappedlinewidth",t.deadSlappedLineWidth),e.set("lefthandtabtiewidth",t.leftHandTabTieWidth),e.set("tabbenddashsize",t.tabBendDashSize),e.set("tabbendpervalueheight",t.tabBendPerValueHeight),e.set("tabbendlabelpadding",t.tabBendLabelPadding),e.set("simpleslidewidth",t.simpleSlideWidth),e.set("simpleslideheight",t.simpleSlideHeight),e.set("chorddiagrampaddingx",t.chordDiagramPaddingX),e.set("chorddiagrampaddingy",t.chordDiagramPaddingY),e.set("chorddiagramstringspacing",t.chordDiagramStringSpacing),e.set("chorddiagramfretspacing",t.chordDiagramFretSpacing),e.set("chorddiagramnutheight",t.chordDiagramNutHeight),e.set("chorddiagramfretheight",t.chordDiagramFretHeight),e.set("chorddiagramlinewidth",t.chordDiagramLineWidth),e.set("tripletfeelbracketpadding",t.tripletFeelBracketPadding),e.set("accidentalpadding",t.accidentalPadding),e.set("prebeatglyphspacing",t.preBeatGlyphSpacing),e.set("temponotescale",t.tempoNoteScale),e.set("tuningglyphcirclenumberscale",t.tuningGlyphCircleNumberScale),e.set("tuningglyphstringcolumnscale",t.tuningGlyphStringColumnScale),e.set("tuningglyphstringrowpadding",t.tuningGlyphStringRowPadding),e.set("directionsscale",t.directionsScale),e}static setProperty(t,e,s){switch(e){case"musicfontsize":return t.musicFontSize=s,!0;case"onestaffspace":return t.oneStaffSpace=s,!0;case"tablinespacing":return t.tabLineSpacing=s,!0;case"arrowshaftthickness":return t.arrowShaftThickness=s,!0;case"barlineseparation":return t.barlineSeparation=s,!0;case"beamspacing":return t.beamSpacing=s,!0;case"beamthickness":return t.beamThickness=s,!0;case"bracketthickness":return t.bracketThickness=s,!0;case"dashedbarlinedashlength":return t.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return t.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return t.dashedBarlineThickness=s,!0;case"hairpinthickness":return t.hairpinThickness=s,!0;case"legerlinethickness":return t.legerLineThickness=s,!0;case"legerlineextension":return t.legerLineExtension=s,!0;case"octavelinethickness":return t.octaveLineThickness=s,!0;case"pedallinethickness":return t.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return t.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return t.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return t.slurMidpointThickness=s,!0;case"stafflinethickness":return t.staffLineThickness=s,!0;case"stemthickness":return t.stemThickness=s,!0;case"thickbarlinethickness":return t.thickBarlineThickness=s,!0;case"thinbarlinethickness":return t.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return t.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return t.tieMidpointThickness=s,!0;case"tupletbracketthickness":return t.tupletBracketThickness=s,!0;case"stemup":return t.stemUp=new Map,ar.forEach(s,(e,s)=>{const i=new ur;kr.fromJson(i,e),t.stemUp.set(ar.parseEnum(s,at),i)}),!0;case"stemdown":return t.stemDown=new Map,ar.forEach(s,(e,s)=>{const i=new ur;kr.fromJson(i,e),t.stemDown.set(ar.parseEnum(s,at),i)}),!0;case"repeatoffsetx":return t.repeatOffsetX=new Map,ar.forEach(s,(e,s)=>{t.repeatOffsetX.set(ar.parseEnum(s,at),e)}),!0;case"standardstemlength":return t.standardStemLength=s,!0;case"stemflagoffsets":return t.stemFlagOffsets=new Map,ar.forEach(s,(e,s)=>{t.stemFlagOffsets.set(ar.parseEnum(s,l),e)}),!0;case"glyphtop":return t.glyphTop=new Map,ar.forEach(s,(e,s)=>{t.glyphTop.set(ar.parseEnum(s,at),e)}),!0;case"glyphbottom":return t.glyphBottom=new Map,ar.forEach(s,(e,s)=>{t.glyphBottom.set(ar.parseEnum(s,at),e)}),!0;case"glyphwidths":return t.glyphWidths=new Map,ar.forEach(s,(e,s)=>{t.glyphWidths.set(ar.parseEnum(s,at),e)}),!0;case"glyphheights":return t.glyphHeights=new Map,ar.forEach(s,(e,s)=>{t.glyphHeights.set(ar.parseEnum(s,at),e)}),!0;case"numberedbarrendererbarsize":return t.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return t.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return t.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return t.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return t.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return t.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return t.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return t.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return t.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return t.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return t.rowContainerPadding=s,!0;case"rowcontainergap":return t.rowContainerGap=s,!0;case"alternateendingspadding":return t.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return t.sustainPedalLinePadding=s,!0;case"tieheight":return t.tieHeight=s,!0;case"beattimerpadding":return t.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return t.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return t.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return t.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return t.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return t.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return t.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return t.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return t.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return t.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return t.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return t.tabBendDashSize=s,!0;case"tabbendpervalueheight":return t.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return t.tabBendLabelPadding=s,!0;case"simpleslidewidth":return t.simpleSlideWidth=s,!0;case"simpleslideheight":return t.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return t.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return t.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return t.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return t.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return t.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return t.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return t.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return t.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return t.accidentalPadding=s,!0;case"prebeatglyphspacing":return t.preBeatGlyphSpacing=s,!0;case"temponotescale":return t.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return t.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return t.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return t.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return t.directionsScale=s,!0}return!1}}class Br{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Br.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("smuflfontfamilyname",t.smuflFontFamilyName),e.set("engravingsettings",Sr.toJson(t.engravingSettings)),e.set("copyrightfont",cr.toJson(t.copyrightFont)),e.set("titlefont",cr.toJson(t.titleFont)),e.set("subtitlefont",cr.toJson(t.subTitleFont)),e.set("wordsfont",cr.toJson(t.wordsFont)),e.set("effectfont",cr.toJson(t.effectFont)),e.set("timerfont",cr.toJson(t.timerFont)),e.set("directionsfont",cr.toJson(t.directionsFont)),e.set("fretboardnumberfont",cr.toJson(t.fretboardNumberFont)),e.set("numberednotationfont",cr.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",cr.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",cr.toJson(t.tablatureFont)),e.set("gracefont",cr.toJson(t.graceFont)),e.set("stafflinecolor",be.toJson(t.staffLineColor)),e.set("barseparatorcolor",be.toJson(t.barSeparatorColor)),e.set("barnumberfont",cr.toJson(t.barNumberFont)),e.set("barnumbercolor",be.toJson(t.barNumberColor)),e.set("fingeringfont",cr.toJson(t.fingeringFont)),e.set("inlinefingeringfont",cr.toJson(t.inlineFingeringFont)),e.set("markerfont",cr.toJson(t.markerFont)),e.set("mainglyphcolor",be.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",be.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",be.toJson(t.scoreInfoColor)),e}static setProperty(t,e,s){switch(e){case"smuflfontfamilyname":return t.smuflFontFamilyName=s,!0;case"copyrightfont":return t.copyrightFont=cr.fromJson(s),!0;case"titlefont":return t.titleFont=cr.fromJson(s),!0;case"subtitlefont":return t.subTitleFont=cr.fromJson(s),!0;case"wordsfont":return t.wordsFont=cr.fromJson(s),!0;case"effectfont":return t.effectFont=cr.fromJson(s),!0;case"timerfont":return t.timerFont=cr.fromJson(s),!0;case"directionsfont":return t.directionsFont=cr.fromJson(s),!0;case"fretboardnumberfont":return t.fretboardNumberFont=cr.fromJson(s),!0;case"numberednotationfont":return t.numberedNotationFont=cr.fromJson(s),!0;case"numberednotationgracefont":return t.numberedNotationGraceFont=cr.fromJson(s),!0;case"tablaturefont":return t.tablatureFont=cr.fromJson(s),!0;case"gracefont":return t.graceFont=cr.fromJson(s),!0;case"stafflinecolor":return t.staffLineColor=be.fromJson(s),!0;case"barseparatorcolor":return t.barSeparatorColor=be.fromJson(s),!0;case"barnumberfont":return t.barNumberFont=cr.fromJson(s),!0;case"barnumbercolor":return t.barNumberColor=be.fromJson(s),!0;case"fingeringfont":return t.fingeringFont=cr.fromJson(s),!0;case"inlinefingeringfont":return t.inlineFingeringFont=cr.fromJson(s),!0;case"markerfont":return t.markerFont=cr.fromJson(s),!0;case"mainglyphcolor":return t.mainGlyphColor=be.fromJson(s),!0;case"secondaryglyphcolor":return t.secondaryGlyphColor=be.fromJson(s),!0;case"scoreinfocolor":return t.scoreInfoColor=be.fromJson(s),!0}return["engravingsettings"].indexOf(e)>=0&&(Sr.fromJson(t.engravingSettings,s),!0)}}class _r{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>_r.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",Br.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("effectbandpaddingbottom",t.effectBandPaddingBottom),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(e,s,i){switch(s){case"scale":return e.scale=i,!0;case"stretchforce":return e.stretchForce=i,!0;case"layoutmode":return e.layoutMode=ar.parseEnum(i,t.LayoutMode),!0;case"staveprofile":return e.staveProfile=ar.parseEnum(i,t.StaveProfile),!0;case"barsperrow":return e.barsPerRow=i,!0;case"startbar":return e.startBar=i,!0;case"barcount":return e.barCount=i,!0;case"barcountperpartial":return e.barCountPerPartial=i,!0;case"justifylastsystem":return e.justifyLastSystem=i,!0;case"padding":return e.padding=i,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=i,!0;case"systempaddingtop":return e.systemPaddingTop=i,!0;case"systempaddingbottom":return e.systemPaddingBottom=i,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=i,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=i,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=i,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=i,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=i,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=i,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=i,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=i,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=i,!0;case"staffpaddingleft":return e.staffPaddingLeft=i,!0;case"effectbandpaddingbottom":return e.effectBandPaddingBottom=i,!0;case"systemslayoutmode":return e.systemsLayoutMode=ar.parseEnum(i,t.SystemsLayoutMode),!0}if(["resources"].indexOf(s)>=0)return Br.fromJson(e.resources,i),!0;for(const t of["resources"])if(0===s.indexOf(t)&&Br.setProperty(e.resources,s.substring(t.length),i))return!0;return!1}}class xr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>xr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[e,i]of t.elements)s.set(e.toString(),i)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(e,s,i){switch(s){case"notationmode":return e.notationMode=ar.parseEnum(i,t.NotationMode),!0;case"fingeringmode":return e.fingeringMode=ar.parseEnum(i,t.FingeringMode),!0;case"elements":return e.elements=new Map,ar.forEach(i,(s,i)=>{e.elements.set(ar.parseEnum(i,t.NotationElement),s)}),!0;case"rhythmmode":return e.rhythmMode=ar.parseEnum(i,t.TabRhythmMode),!0;case"rhythmheight":return e.rhythmHeight=i,!0;case"transpositionpitches":return e.transpositionPitches=i,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=i,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=i,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=i,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=i,!0;case"slurheight":return e.slurHeight=i,!0}return!1}}class Tr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Tr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class Mr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Mr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class vr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>vr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}class Nr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Nr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",Mr.toJson(t.vibrato)),e.set("slide",vr.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(e,s,i){switch(s){case"soundfont":return e.soundFont=i,!0;case"scrollelement":return e.scrollElement=i,!0;case"outputmode":return e.outputMode=ar.parseEnum(i,t.PlayerOutputMode),!0;case"enableplayer":return e.enablePlayer=i,!0;case"playermode":return e.playerMode=ar.parseEnum(i,t.PlayerMode),!0;case"enablecursor":return e.enableCursor=i,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return e.enableElementHighlighting=i,!0;case"enableuserinteraction":return e.enableUserInteraction=i,!0;case"scrolloffsetx":return e.scrollOffsetX=i,!0;case"scrolloffsety":return e.scrollOffsetY=i,!0;case"scrollmode":return e.scrollMode=ar.parseEnum(i,t.ScrollMode),!0;case"scrollspeed":return e.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return e.songBookBendDuration=i,!0;case"songbookdipduration":return e.songBookDipDuration=i,!0;case"playtripletfeel":return e.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=i,!0}if(["vibrato"].indexOf(s)>=0)return Mr.fromJson(e.vibrato,i),!0;for(const t of["vibrato"])if(0===s.indexOf(t)&&Mr.setProperty(e.vibrato,s.substring(t.length),i))return!0;if(["slide"].indexOf(s)>=0)return vr.fromJson(e.slide,i),!0;for(const t of["slide"])if(0===s.indexOf(t)&&vr.setProperty(e.slide,s.substring(t.length),i))return!0;return!1}}class Pr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Pr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("indent",t.indent),e.set("comments",t.comments),e}static setProperty(t,e,s){switch(e){case"indent":return t.indent=s,!0;case"comments":return t.comments=s,!0}return!1}}class Er{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Er.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",yr.toJson(t.core)),e.set("display",_r.toJson(t.display)),e.set("notation",xr.toJson(t.notation)),e.set("importer",Tr.toJson(t.importer)),e.set("player",Nr.toJson(t.player)),e.set("exporter",Pr.toJson(t.exporter)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return yr.fromJson(t.core,s),!0;for(const i of["core",""])if(0===e.indexOf(i)&&yr.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return _r.fromJson(t.display,s),!0;for(const i of["display",""])if(0===e.indexOf(i)&&_r.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return xr.fromJson(t.notation,s),!0;for(const i of["notation"])if(0===e.indexOf(i)&&xr.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return Tr.fromJson(t.importer,s),!0;for(const i of["importer"])if(0===e.indexOf(i)&&Tr.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return Nr.fromJson(t.player,s),!0;for(const i of["player"])if(0===e.indexOf(i)&&Nr.setProperty(t.player,e.substring(i.length),s))return!0;if(["exporter"].indexOf(e)>=0)return Pr.fromJson(t.exporter,s),!0;for(const i of["exporter"])if(0===e.indexOf(i)&&Pr.setProperty(t.exporter,e.substring(i.length),s))return!0;return!1}}class Cr{indent=2;comments=!1}class Fr{core=new su;display=new pr;notation=new H;importer=new br;player=new wr;exporter=new Cr;setSongBookModeSettings(){this.notation.notationMode=t.NotationMode.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=t.FingeringMode.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(t.NotationElement.ParenthesisOnTiedBends,!1),this.notation.elements.set(t.NotationElement.TabNotesOnTiedBends,!1),this.notation.elements.set(t.NotationElement.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new Fr;return t.setSongBookModeSettings(),t}fillFromJson(t){Er.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===t.PlayerMode.Disabled&&this.player.enablePlayer&&(this.player.playerMode=t.PlayerMode.EnabledAutomatic)}}class Ar{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class Dr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Dr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class Lr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Lr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",Dr.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e.set("isvisible",t.isVisible),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=ar.parseEnum(s,r),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new G,Dr.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0;case"isvisible":return t.isVisible=s,!0}return!1}}class Wr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Wr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=ar.parseEnum(s,Pt),!0;case"length":return t.length=s,!0}return!1}}class Rr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Rr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",Ar.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(t=>Lr.toJson(t))),void 0!==t.syncPoints&&e.set("syncpoints",t.syncPoints?.map(t=>Lr.toJson(t))),null!==t.fermata){const s=new Map;e.set("fermata",s);for(const[e,i]of t.fermata)s.set(e.toString(),Wr.toJson(i))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),null!==t.directions){const s=[];e.set("directions",s);for(const e of t.directions)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=ar.parseEnum(s,rt),!0;case"section":return s?(t.section=new we,Ar.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const e of s){const s=new $;Lr.fromJson(s,e),t.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const e of s){const s=new $;Lr.fromJson(s,e),t.addSyncPoint(s)}}return!0;case"fermata":return t.fermata=new Map,ar.forEach(s,(e,s)=>{const i=new me;Wr.fromJson(i,e),t.addFermata(Number.parseInt(s),i)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const e of s)t.addDirection(ar.parseEnum(e,Qe));return!0}return!1}}class Or{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Or.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class Ir{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Ir.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=ar.parseEnum(s,at),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,ut),be.fromJson(e))}),!0}return!1}}class Gr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Gr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),null!==t.bendPoints&&e.set("bendpoints",t.bendPoints?.map(t=>Or.toJson(t))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",Ir.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=ar.parseEnum(s,d),!0;case"bendtype":return t.bendType=ar.parseEnum(s,h),!0;case"bendstyle":return t.bendStyle=ar.parseEnum(s,a),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const e of s){const s=new V;Or.fromJson(s,e),t.addBendPoint(s)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=ar.parseEnum(s,p),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=ar.parseEnum(s,g),!0;case"slideouttype":return t.slideOutType=ar.parseEnum(s,w),!0;case"vibrato":return t.vibrato=ar.parseEnum(s,y),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=ar.parseEnum(s,f),!0;case"righthandfinger":return t.rightHandFinger=ar.parseEnum(s,f),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=ar.parseEnum(s,l),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=ar.parseEnum(s,b),!0;case"dynamics":return t.dynamics=ar.parseEnum(s,n),!0;case"ornament":return t.ornament=ar.parseEnum(s,lt),!0;case"style":return s?(t.style=new Xt,Ir.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class $r{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>$r.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,yt),be.fromJson(e))}),!0)}}class Vr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Vr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(t=>Gr.toJson(t))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(t=>Lr.toJson(t))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),null!==t.whammyBarPoints&&e.set("whammybarpoints",t.whammyBarPoints?.map(t=>Or.toJson(t))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),e.set("tremolospeed",t.tremoloSpeed),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",$r.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const e of s){const s=new Jt;Gr.fromJson(s,e),t.addNote(s)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=ar.parseEnum(s,a),!0;case"ottava":return t.ottava=ar.parseEnum(s,m),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=ar.parseEnum(s,l),!0;case"automations":t.automations=[];for(const e of s){const s=new $;Lr.fromJson(s,e),t.automations.push(s)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=ar.parseEnum(s,pt),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=ar.parseEnum(s,o),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=ar.parseEnum(s,dt),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const e of s){const s=new V;Or.fromJson(s,e),t.addWhammyBarPoint(s)}}return!0;case"vibrato":return t.vibrato=ar.parseEnum(s,y),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=ar.parseEnum(s,u),!0;case"pickstroke":return t.pickStroke=ar.parseEnum(s,ot),!0;case"tremolospeed":return t.tremoloSpeed=ar.parseEnum(s,l)??null,!0;case"crescendo":return t.crescendo=ar.parseEnum(s,c),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=ar.parseEnum(s,ft),!0;case"dynamics":return t.dynamics=ar.parseEnum(s,n),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=ar.parseEnum(s,At)??null,!0;case"beamingmode":return t.beamingMode=ar.parseEnum(s,wt),!0;case"wahpedal":return t.wahPedal=ar.parseEnum(s,bt),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=ar.parseEnum(s,mt),!0;case"rasgueado":return t.rasgueado=ar.parseEnum(s,gt),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new Yt,$r.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Hr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Hr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,W),be.fromJson(e))}),!0)}}class Ur{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Ur.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(t=>Vr.toJson(t))),t.style&&e.set("style",Hr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const e of s){const s=new Kt;Vr.fromJson(s,e),t.addBeat(s)}return!0;case"style":return s?(t.style=new tt,Hr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class zr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>zr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=ar.parseEnum(s,A),!0}return!1}}class jr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>jr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,D),be.fromJson(e))}),!0)}}class Xr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Xr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(t=>Ur.toJson(t))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(t=>zr.toJson(t))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),t.style&&e.set("style",jr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=ar.parseEnum(s,P),!0;case"clefottava":return t.clefOttava=ar.parseEnum(s,m),!0;case"voices":t.voices=[];for(const e of s){const s=new et;Ur.fromJson(s,e),t.addVoice(s)}return!0;case"similemark":return t.simileMark=ar.parseEnum(s,E),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const e of s){const s=new Y;zr.fromJson(s,e),t.sustainPedals.push(s)}return!0;case"barlineleft":return t.barLineLeft=ar.parseEnum(s,L),!0;case"barlineright":return t.barLineRight=ar.parseEnum(s,L),!0;case"keysignature":return t.keySignature=ar.parseEnum(s,C),!0;case"keysignaturetype":return t.keySignatureType=ar.parseEnum(s,F),!0;case"style":return s?(t.style=new K,jr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Jr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Jr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class qr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>qr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class Yr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Yr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(t=>Xr.toJson(t))),null!==t.chords){const s=new Map;e.set("chords",s);for(const[e,i]of t.chords)s.set(e.toString(),Jr.toJson(i))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",qr.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const e of s){const s=new Q;Xr.fromJson(s,e),t.addBar(s)}return!0;case"chords":return t.chords=new Map,ar.forEach(s,(e,s)=>{const i=new fe;Jr.fromJson(i,e),t.addChord(s,i)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return qr.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class Kr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Kr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("bank",t.bank),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"bank":return t.bank=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class Qr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Qr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=ar.parseEnum(s,at),!0;case"noteheadhalf":return t.noteHeadHalf=ar.parseEnum(s,at),!0;case"noteheadwhole":return t.noteHeadWhole=ar.parseEnum(s,at),!0;case"techniquesymbol":return t.techniqueSymbol=ar.parseEnum(s,at),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=ar.parseEnum(s,ct),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class Zr{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>Zr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,Ct),be.fromJson(e))}),!0)}}class ta{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>ta.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(t=>Yr.toJson(t))),e.set("playbackinfo",Kr.toJson(t.playbackInfo)),e.set("color",be.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),void 0!==t.lineBreaks){const s=[];e.set("linebreaks",s);for(const e of t.lineBreaks)s.push(e)}return e.set("percussionarticulations",t.percussionArticulations.map(t=>Qr.toJson(t))),t.style&&e.set("style",Zr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const e of s){const s=new ke;Yr.fromJson(s,e),t.addStaff(s)}return!0;case"playbackinfo":return Kr.fromJson(t.playbackInfo,s),!0;case"color":return t.color=be.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const e of s)t.addLineBreaks(e);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const e of s){const s=new Ut;Qr.fromJson(s,e),t.percussionArticulations.push(s)}return!0;case"style":return s?(t.style=new Be,Zr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class ea{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>ea.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),null!==t.perTrackDisplayTuning){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[e,i]of t.perTrackDisplayTuning)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),null!==t.perTrackChordDiagramsOnTop){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[e,i]of t.perTrackChordDiagramsOnTop)s.set(e.toString(),i)}if(e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),null!==t.perTrackMultiBarRest){const s=[];e.set("pertrackmultibarrest",s);for(const e of t.perTrackMultiBarRest)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=ar.parseEnum(s,T),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,ar.forEach(s,(e,s)=>{t.perTrackDisplayTuning.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,ar.forEach(s,(e,s)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(s),e)}),!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=ar.parseEnum(s,M),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=ar.parseEnum(s,M),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=ar.parseEnum(s,v),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=ar.parseEnum(s,v),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=ar.parseEnum(s,N),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=ar.parseEnum(s,N),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0}return!1}}class sa{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>sa.setProperty(t,s,e))}static toJson(t){if(!t)return null;return new Map}static setProperty(t,e,s){return!1}}class ia{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>ia.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=ar.parseEnum(s,st),!0}return!1}}class na{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>na.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[e,i]of t.headerAndFooter)s.set(e.toString(),ia.toJson(i))}{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),be.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,ar.forEach(s,(e,s)=>{const i=new Wt;ia.fromJson(i,e),t.headerAndFooter.set(ar.parseEnum(s,nt),i)}),!0;case"colors":return t.colors=new Map,ar.forEach(s,(e,s)=>{t.colors.set(ar.parseEnum(s,nt),be.fromJson(e))}),!0}return!1}}class ra{static fromJson(t,e){e&&ar.forEach(e,(e,s)=>ra.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("masterbars",t.masterBars.map(t=>Rr.toJson(t))),e.set("tracks",t.tracks.map(t=>ta.toJson(t))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",ea.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",sa.toJson(t.backingTrack)),t.style&&e.set("style",na.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"masterbars":t.masterBars=[];for(const e of s){const s=new It;Rr.fromJson(s,e),t.addMasterBar(s)}return!0;case"tracks":t.tracks=[];for(const e of s){const s=new _e;ta.fromJson(s,e),t.addTrack(s)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return ea.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new Ys,sa.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new Rt,na.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class aa{static tp(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const t={};for(const[s,i]of e)t[s]=i;return t}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=aa.scoreToJsObject(t);return JSON.stringify(e,aa.tp)}static jsonToScore(t,e){return aa.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return ra.toJson(t)}static jsObjectToScore(t,e){const s=new Ot;return ra.fromJson(s,t),s.finish(e??new Fr),s}static settingsToJson(t){const e=aa.settingsToJsObject(t);return JSON.stringify(e,aa.tp)}static jsonToSettings(t){return aa.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return Er.toJson(t)}static jsObjectToSettings(t){const e=new Fr;return Er.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new Mi;return ar.forEach(t,(t,s)=>{switch(s){case"division":e.division=t;break;case"tracks":for(const s of t){const t=aa.ep(s);e.tracks.push(t)}}}),e}static ep(t){const e=new Ti;return ar.forEach(t,(t,s)=>{if("events"===s)for(const s of t){const t=aa.jsObjectToMidiEvent(s);e.events.push(t)}}),e}static jsObjectToMidiEvent(e){const s=ar.getValue(e,"track"),i=ar.getValue(e,"tick"),n=ar.getValue(e,"type");switch(n){case ss.TimeSignature:return new Ni(s,i,ar.getValue(e,"numerator"),ar.getValue(e,"denominatorIndex"),ar.getValue(e,"midiClocksPerMetronomeClick"),ar.getValue(e,"thirdySecondNodesInQuarter"));case ss.AlphaTabRest:return new Ci(s,i,ar.getValue(e,"channel"));case ss.AlphaTabMetronome:return new Ei(s,i,ar.getValue(e,"metronomeNumerator"),ar.getValue(e,"metronomeDurationInTicks"),ar.getValue(e,"metronomeDurationInMilliseconds"));case ss.NoteOn:return new Ai(s,i,ar.getValue(e,"channel"),ar.getValue(e,"noteKey"),ar.getValue(e,"noteVelocity"));case ss.NoteOff:return new Di(s,i,ar.getValue(e,"channel"),ar.getValue(e,"noteKey"),ar.getValue(e,"noteVelocity"));case ss.ControlChange:return new Li(s,i,ar.getValue(e,"channel"),ar.getValue(e,"controller"),ar.getValue(e,"value"));case ss.ProgramChange:return new Wi(s,i,ar.getValue(e,"channel"),ar.getValue(e,"program"));case ss.TempoChange:const t=new Ri(i,0);return t.beatsPerMinute=ar.getValue(e,"beatsPerMinute"),t;case ss.PitchBend:return new Oi(s,i,ar.getValue(e,"channel"),ar.getValue(e,"value"));case ss.PerNotePitchBend:return new Ii(s,i,ar.getValue(e,"channel"),ar.getValue(e,"noteKey"),ar.getValue(e,"value"));case ss.EndOfTrack:return new Gi(s,i)}throw new R(t.AlphaTabErrorType.Format,`Unknown Midi Event type: ${n}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division);const s=[];for(const e of t.tracks)s.push(aa.sp(e));return e.set("tracks",s),e}static sp(t){const e=new Map,s=[];for(const e of t.events)s.push(aa.midiEventToJsObject(e));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case ss.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case ss.AlphaTabRest:e.set("channel",t.channel);break;case ss.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case ss.NoteOn:case ss.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case ss.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case ss.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case ss.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case ss.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case ss.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value);case ss.EndOfTrack:}return e}}class ha{ip;np;rp=new Map;constructor(t,e){this.np=t,this.np.addEventListener("message",this.handleMessage.bind(this)),this.ip=new nr(new yi,e),this.ip.positionChanged.on(this.onPositionChanged.bind(this)),this.ip.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.ip.finished.on(this.onFinished.bind(this)),this.ip.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.ip.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.ip.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.ip.midiLoaded.on(this.onMidiLoaded.bind(this)),this.ip.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this.ip.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this.ip.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.ip.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.np.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=eu.globalThis;t.addEventListener("message",e=>{const s=e.data;if("alphaSynth.initialize"===s.cmd)yi.preferredSampleRate=s.sampleRate,j.logLevel=s.logLevel,eu.globalThis.alphaSynthWebWorker=new ha(t,s.bufferTimeInMilliseconds)})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":j.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this.ip.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this.ip.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this.ip.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this.ip.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this.ip.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this.ip.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this.ip.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this.ip.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this.ip.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this.ip.play();break;case"alphaSynth.pause":this.ip.pause();break;case"alphaSynth.playPause":this.ip.playPause();break;case"alphaSynth.stop":this.ip.stop();break;case"alphaSynth.playOneTimeMidiFile":this.ip.playOneTimeMidiFile(aa.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this.ip.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this.ip.resetSoundFonts();break;case"alphaSynth.loadMidi":this.ip.loadMidiFile(aa.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this.ip.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this.ip.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this.ip.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this.ip.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this.ip.resetChannelStates();break;case"alphaSynth.destroy":this.ip.destroy(),this.np.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this.ip.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.ap(t)}ap(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const t=this.ip.exportAudio(e.options,aa.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this.rp.set(e.exporterId,t),this.np.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this.rp.has(e.exporterId)){const t=this.rp.get(e.exporterId).render(e.milliseconds);this.np.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:t})}else this.np.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this.rp.delete(e.exporterId)}}catch(t){this.np.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:t})}}onPositionChanged(t){this.np.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this.np.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this.np.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this.np.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this.np.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.hp(eu.prepareForPostMessage(t))})}hp(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this.np.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this.np.postMessage({cmd:"alphaSynth.midiLoaded",error:this.hp(eu.prepareForPostMessage(t))})}onReadyForPlayback(){this.np.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this.np.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(aa.midiEventToJsObject)})}onPlaybackRangeChanged(t){this.np.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}t.WebPlatform=void 0,(ws=t.WebPlatform||(t.WebPlatform={}))[ws.Browser=0]="Browser",ws[ws.NodeJs=1]="NodeJs",ws[ws.BrowserModule=2]="BrowserModule";class oa{characterWidths;characterHeights;constructor(t,e){this.characterWidths=t,this.characterHeights=e}}class ca{static fontSizeLookupTables=new Map;static ControlChars=32;static generateFontLookup(e){if(!ca.fontSizeLookupTables.has(e))if(eu.isRunningInWorker||eu.webPlatform===t.WebPlatform.NodeJs){const t=new oa(new Uint8Array([8]),new Uint8Array([10]));ca.fontSizeLookupTables.set(e,t)}else{const t=document.createElement("canvas").getContext("2d"),s=11;t.font=`${s}px ${e}`;const i=[],n=[];for(let e=ca.ControlChars;e<255;e++){const s=String.fromCharCode(e),r=t.measureText(s);i.push(r.width);const a=r.actualBoundingBoxDescent+r.actualBoundingBoxAscent;n.push(a)}const r=new oa(new Uint8Array(i),new Uint8Array(n));ca.fontSizeLookupTables.set(e,r)}}static measureString(t,e,s,i,n){let r;let a=e[0];for(let t=0;t<e.length;t++)if(ca.fontSizeLookupTables.has(e[t])){a=e[t];break}ca.fontSizeLookupTables.has(a)||ca.generateFontLookup(a),r=ca.fontSizeLookupTables.get(a);let h=1;i===us.Italic&&(h*=1.1),n===ds.Bold&&(h*=1.1);let o=0,c=0;for(let e=0;e<t.length;e++){const i=Math.min(r.characterWidths.length-1,t.charCodeAt(e)-ca.ControlChars);i>=0&&(o+=r.characterWidths[i]*s/11,c=Math.max(c,r.characterHeights[i]*s/11))}return h*=1.07,new Dt(o*h,c)}}class la{op;np;constructor(t){this.np=t,this.np.addEventListener("message",this.dl.bind(this),!1)}static init(){eu.globalThis.alphaTabWebWorker=new la(eu.globalThis)}dl(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const t=aa.jsObjectToSettings(e.settings);j.logLevel=t.core.logLevel,this.op=new De(t),this.op.partialRenderFinished.on(t=>{this.np.postMessage({cmd:"alphaTab.partialRenderFinished",result:t})}),this.op.partialLayoutFinished.on(t=>{this.np.postMessage({cmd:"alphaTab.partialLayoutFinished",result:t})}),this.op.renderFinished.on(t=>{this.np.postMessage({cmd:"alphaTab.renderFinished",result:t})}),this.op.postRenderFinished.on(()=>{this.np.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this.op.boundsLookup?.toJson()??null})}),this.op.preRender.on(t=>{this.np.postMessage({cmd:"alphaTab.preRender",resize:t})}),this.op.error.on(this.cp.bind(this));break;case"alphaTab.invalidate":this.op.render();break;case"alphaTab.resizeRender":this.op.resizeRender();break;case"alphaTab.renderResult":this.op.renderResult(e.resultId);break;case"alphaTab.setWidth":this.op.width=e.width;break;case"alphaTab.renderScore":this.lp(e.fontSizes);const s=null==e.score?null:aa.jsObjectToScore(e.score,this.op.settings);this.dp(s,e.trackIndexes);break;case"alphaTab.updateSettings":this.fp(e.settings)}}lp(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t)for(const[e,s]of t)ca.fontSizeLookupTables.set(e,s)}fp(t){Er.fromJson(this.op.settings,t)}dp(t,e){try{this.op.renderScore(t,e)}catch(t){this.cp(t)}}cp(t){j.error("Worker","An unexpected error occurred in worker",t),this.np.postMessage({cmd:"alphaTab.error",error:t})}}class ua{pp;bp;mp=null;gp;wp=new be(0,0,0,255);yp=new cr("Arial",10,us.Plain);kp;Sp=0;settings;constructor(){this.pp=document.createElement("canvas"),this.pp.width=10,this.pp.height=10,this.pp.style.width="10px",this.pp.style.height="10px",this.bp=this.pp.getContext("2d"),this.bp.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this.kp=new cr(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,us.Plain,ds.Regular);const s=this.settings.display.scale;this.mp=document.createElement("canvas"),this.mp.width=t*eu.highDpiFactor|0,this.mp.height=e*eu.highDpiFactor|0,this.mp.style.width=`${t}px`,this.mp.style.height=`${e}px`,this.gp=this.mp.getContext("2d"),this.gp.textBaseline="hanging",this.gp.scale(eu.highDpiFactor*s,eu.highDpiFactor*s),this.gp.lineWidth=this.Sp}endRender(){const t=this.mp;return this.mp=null,t}get color(){return this.wp}set color(t){this.wp.rgba!==t.rgba&&(this.wp=t,this.gp.strokeStyle=t.rgba,this.gp.fillStyle=t.rgba)}get lineWidth(){return this.Sp}set lineWidth(t){this.Sp=t,this.gp&&(this.gp.lineWidth=t)}fillRect(t,e,s,i){s>0&&this.gp.fillRect(t,e,s,i)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.gp.strokeRect(t+n,e+n,s,i)}beginPath(){this.gp.beginPath()}closePath(){this.gp.closePath()}moveTo(t,e){this.gp.moveTo(t,e)}lineTo(t,e){this.gp.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this.gp.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,n,r){this.gp.bezierCurveTo(t,e,s,i,n,r)}fillCircle(t,e,s){this.gp.beginPath(),this.gp.arc(t,e,s,0,2*Math.PI,!0),this.fill()}strokeCircle(t,e,s){this.gp.beginPath(),this.gp.arc(t,e,s,0,2*Math.PI,!0),this.stroke()}fill(){this.gp.fill(),this.gp.beginPath()}stroke(){this.gp.stroke(),this.gp.beginPath()}get font(){return this.yp}set font(t){this.yp=t,this.gp&&(this.gp.font=t.toCssString(1)),this.bp.font=t.toCssString(1)}get textAlign(){switch(this.gp.textAlign){case"left":default:return st.Left;case"center":return st.Center;case"right":return st.Right}}set textAlign(t){switch(t){case st.Left:this.gp.textAlign="left";break;case st.Center:this.gp.textAlign="center";break;case st.Right:this.gp.textAlign="right"}}get textBaseline(){switch(this.gp.textBaseline){case"hanging":default:return it.Top;case"middle":return it.Middle;case"bottom":return it.Bottom;case"alphabetic":return it.Alphabetic}}set textBaseline(t){switch(t){case it.Top:this.gp.textBaseline="hanging";break;case it.Middle:this.gp.textBaseline="middle";break;case it.Bottom:this.gp.textBaseline="bottom";break;case it.Alphabetic:this.gp.textBaseline="alphabetic"}}beginGroup(t){}endGroup(){}fillText(t,e,s){this.gp.fillText(t,e,s)}measureText(t){const e=this.bp.measureText(t);return new Dt(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,n=!1){i!==at.None&&this.Bp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n=!1){let r="";for(const t of i)t!==at.None&&(r+=String.fromCharCode(t));this.Bp(t,e,s,r,n)}Bp(t,e,s,i,n){const r=this.gp.textAlign,a=this.gp.textBaseline,h=this.gp.font;this.gp.font=this.kp.toCssString(s),this.gp.textBaseline="alphabetic",this.gp.textAlign=n?"center":"left",this.gp.fillText(i,t,e),this.gp.textBaseline=a,this.gp.font=h,this.gp.textAlign=r}beginRotate(t,e,s){this.gp.save(),this.gp.translate(t,e),this.gp.rotate(s*Math.PI/180)}endRotate(){this.gp.restore()}}class da{_p;xp;constructor(t,e=!1){this._p=t,this.xp=e}addTimeSignature(t,e,s){let i=0,n=s;for(;n>>=1,n>0;)i++;this._p.addEvent(new Ni(0,t,e,i,48,8))}addRest(t,e,s){this.xp||this._p.addEvent(new Ci(t,e,s))}addNote(t,e,s,i,n,r){this._p.addEvent(new Ai(t,e,r,da.Tp(i),da.Tp(n))),this._p.addEvent(new Di(t,e+s,r,da.Tp(i),da.Tp(n)))}static Tp(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,n){this._p.addEvent(new Li(t,e,s,i,da.Tp(n)))}addProgramChange(t,e,s,i){this._p.addEvent(new Wi(t,e,s,i))}addTempo(t,e){const s=new Ri(t,0);s.beatsPerMinute=e,this._p.addEvent(s)}addBend(t,e,s,i){i=i>=Gt.MaxPitchWheel?Gt.MaxPitchWheel:Math.floor(i),this._p.addEvent(new Oi(t,e,s,i))}addNoteBend(t,e,s,i,n){this.xp?this.addBend(t,e,s,n):(n=n*Gt.MaxPitchWheel20/Gt.MaxPitchWheel,this._p.addEvent(new Ii(t,e,s,i,n)))}finishTrack(t,e){this._p.format!==es.MultiTrack&&0!==t||this._p.addEvent(new Gi(t,e))}}class fa{group;opening;iterations;closingIndex=0;constructor(t,e){this.group=t,this.opening=e,t.closings=t.closings.sort((t,e)=>t.index-e.index),this.iterations=t.closings.map(t=>0)}}!function(t){t[t.PlayingNormally=0]="PlayingNormally",t[t.DirectionJumped=1]="DirectionJumped",t[t.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",t[t.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",t[t.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"}(ys||(ys={}));class pa{ue;Mp=[];vp=new Set;Np=0;oi=ys.PlayingNormally;shouldPlay=!0;index=0;currentTick=0;get finished(){return this.index>=this.ue.masterBars.length}constructor(t){this.ue=t}processCurrent(){const t=this.ue.masterBars[this.index];if(this.oi===ys.PlayingNormally){let e=t.alternateEndings;if(0===e&&(e=this.Np),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this.vp.has(t.repeatGroup)){const s=new fa(t.repeatGroup,t);this.Mp.push(s),this.vp.add(t.repeatGroup),this.Np=0,e=t.alternateEndings}if(0===this.Mp.length||0===e)this.shouldPlay=!0;else{const t=this.Mp[this.Mp.length-1],s=t.iterations[t.closingIndex];this.Np=e,this.shouldPlay=!!(e&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this.Pp()||this.Ep()}Cp(){this.vp.clear(),this.Np=0,this.Mp=[]}Fp(t,e,s){return!!t.has(e)&&(this.index=0,this.oi=s,this.Cp(),!0)}Ap(t,e,s,i){if(t.has(e)){const t=this.Dp(i,this.index,!0);return-1!==t&&(this.index=t,this.oi=s,this.Cp(),!0)}return!1}Lp(t,e,s){if(t.has(e)){const t=this.Dp(s,this.index,!1);return-1===t?(this.index++,!0):(this.index=t,this.oi=ys.PlayingNormally,!0)}return!1}Pp(){const t=this.ue.masterBars[this.index],e=null!==t.directions&&t.directions.size>0;if(this.oi===ys.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this.oi){case ys.PlayingNormally:return!!(this.Fp(t.directions,Qe.JumpDaCapo,ys.DirectionJumped)||this.Fp(t.directions,Qe.JumpDaCapoAlCoda,ys.DirectionJumpedAlCoda)||this.Fp(t.directions,Qe.JumpDaCapoAlDoubleCoda,ys.DirectionJumpedAlDoubleCoda)||this.Fp(t.directions,Qe.JumpDaCapoAlFine,ys.DirectionJumpedAlFine))||(!!(this.Ap(t.directions,Qe.JumpDalSegno,ys.DirectionJumped,Qe.TargetSegno)||this.Ap(t.directions,Qe.JumpDalSegnoAlCoda,ys.DirectionJumpedAlCoda,Qe.TargetSegno)||this.Ap(t.directions,Qe.JumpDalSegnoAlDoubleCoda,ys.DirectionJumpedAlDoubleCoda,Qe.TargetSegno)||this.Ap(t.directions,Qe.JumpDalSegnoAlFine,ys.DirectionJumpedAlFine,Qe.TargetSegno))||!!(this.Ap(t.directions,Qe.JumpDalSegnoSegno,ys.DirectionJumped,Qe.TargetSegnoSegno)||this.Ap(t.directions,Qe.JumpDalSegnoSegnoAlCoda,ys.DirectionJumpedAlCoda,Qe.TargetSegnoSegno)||this.Ap(t.directions,Qe.JumpDalSegnoSegnoAlDoubleCoda,ys.DirectionJumpedAlDoubleCoda,Qe.TargetSegnoSegno)||this.Ap(t.directions,Qe.JumpDalSegnoSegnoAlFine,ys.DirectionJumpedAlFine,Qe.TargetSegnoSegno)));case ys.DirectionJumped:return this.index++,!0;case ys.DirectionJumpedAlCoda:return this.Lp(t.directions,Qe.JumpDaCoda,Qe.TargetCoda)||this.index++,!0;case ys.DirectionJumpedAlDoubleCoda:return this.Lp(t.directions,Qe.JumpDaDoubleCoda,Qe.TargetDoubleCoda)||this.index++,!0;case ys.DirectionJumpedAlFine:return t.directions.has(Qe.TargetFine)?(this.index=this.ue.masterBars.length,!0):(this.index++,!0)}return!0}Dp(t,e,s){let i;return s?(i=this.Wp(t,e),-1===i&&(i=this.Rp(t,e)),i):(i=this.Rp(t,e),-1===i&&(i=this.Wp(t,e)),i)}Rp(t,e){let s=e;for(;s<this.ue.masterBars.length;){const e=this.ue.masterBars[s].directions;if(e&&e.has(t))return s;s++}return-1}Wp(t,e){let s=e;for(;s>=0;){const e=this.ue.masterBars[s].directions;if(e&&e.has(t))return s;s--}return-1}Ep(){const t=this.ue.masterBars[this.index].repeatCount-1;if(this.Mp.length>0&&t>0){const e=this.Mp[this.Mp.length-1];if(e.iterations[e.closingIndex]<t){this.index=e.opening.index,e.iterations[e.closingIndex]++;for(let t=0;t<e.closingIndex;t++)e.iterations[t]=0;e.closingIndex=0,this.Np=0}else e.closingIndex<e.group.closings.length-1?(e.closingIndex++,this.index++):(this.Mp.pop(),this.vp.delete(e.group),this.index++)}else this.index++}}class ba{beat;playbackStart;constructor(t,e){this.beat=t,this.playbackStart=e}}class ma{Op=new Map;start;end;highlightedBeats=[];nextBeat=null;previousBeat=null;get duration(){return this.end-this.start}constructor(t,e){this.start=t,this.end=e}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this.Op.has(t.id)||(this.Op.set(t.id,!0),this.highlightedBeats.push(new ba(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}}class ga{tick;tempo;constructor(t,e){this.tick=t,this.tempo=e}}class wa{start=0;end=0;get tempo(){return this.tempoChanges[0].tempo}tempoChanges=[];masterBar;firstBeat=null;lastBeat=null;Ip(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}Gp(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}nextMasterBar=null;previousMasterBar=null;addBeat(e,s,i,n){const r=i+n;if(null==this.firstBeat){const t=new ma(i,r);t.highlightBeat(e,s),this.Ip(this.firstBeat,t)}else if(i>=this.lastBeat.end){const t=new ma(this.lastBeat.end,r);t.highlightBeat(e,s),this.Ip(this.lastBeat,t)}else{let n=null;if(i<this.firstBeat.start)n=this.firstBeat;else{let e=this.firstBeat;for(;null!=e;){if(i>=e.start&&i<e.end){n=e;break}e=e.nextBeat}if(null===n)throw new R(t.AlphaTabErrorType.General,"Error on building lookup, unknown variant")}if(i<n.start)if(r===n.start){const t=new ma(i,n.start);t.highlightBeat(e,s),this.Gp(this.firstBeat,t)}else if(r<n.end){const t=new ma(i,n.start);t.highlightBeat(e,s),this.Gp(n,t);const a=new ma(n.start,r);for(const t of n.highlightedBeats)a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(e,s),this.Gp(n,a),n.start=r}else if(r===n.end){const t=new ma(i,n.start);t.highlightBeat(e,s),n.highlightBeat(e,s),this.Gp(n,t)}else{const t=new ma(i,n.start);t.highlightBeat(e,s),n.highlightBeat(e,s),this.Gp(n,t),this.addBeat(e,s,n.end,r-n.end)}else if(i>n.start)if(r===n.end){const t=new ma(n.start,i);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);n.start=i,n.highlightBeat(e,s),this.Gp(n,t)}else if(r<n.end){const t=new ma(n.start,i);this.Gp(n,t);const a=new ma(i,r);this.Gp(n,a);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart),a.highlightBeat(e.beat,e.playbackStart);a.highlightBeat(e,s),n.start=r}else{const t=new ma(n.start,i);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);n.start=i,n.highlightBeat(e,s),this.Gp(n,t),this.addBeat(e,s,n.end,r-n.end)}else if(r===n.end)n.highlightBeat(e,s);else if(r<n.end){const t=new ma(n.start,r);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);t.highlightBeat(e,s),n.start=r,this.Gp(n,t)}else n.highlightBeat(e,s),this.addBeat(e,s,n.end,r-n.end)}}}!function(t){t[t.Unknown=0]="Unknown",t[t.ToNextBext=1]="ToNextBext",t[t.ToEndOfBar=2]="ToEndOfBar"}(ks||(ks={}));class ya{beat;masterBar;beatLookup;nextBeat=null;tickDuration=0;duration=0;cursorMode=ks.Unknown;get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(t){this.masterBar=t}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=I.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const n of this.masterBar.tempoChanges)if(n.tick<e)s=n.tempo;else{if(n.tick>i)break;t+=I.ticksToMillis(n.tick-e,s),s=n.tempo,e=n.tick}i>e&&(t+=I.ticksToMillis(i-e,s)),this.duration=t}}}class ka{$p=null;masterBarLookup=new Map;masterBars=[];multiBarRestInfo=null;findBeat(t,e,s=null){let i=null;return s&&(i=this.Vp(t,s,e)),i||(i=this.Hp(t,s,e,!1)),i}Vp(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end){const s=e.nextBeat;return this.zp(s,t),s}return null}jp(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this.Xp(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ks.ToNextBext,t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ks.ToEndOfBar)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=ks.ToEndOfBar)):(t.tickDuration=i.end-t.start,t.cursorMode=ks.ToEndOfBar):(j.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=ks.ToEndOfBar),t.calculateDuration()}zp(t,e){this.Jp(t)?this.jp(t,e):this.qp(t,e)}qp(t,e){t.nextBeat=this.Yp(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),null==t.nextBeat&&(t.nextBeat=this.Hp(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ks.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=ks.ToEndOfBar,t.calculateDuration()),t.nextBeat&&t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ks.ToEndOfBar)}Jp(t){return this.Kp(t.masterBar.masterBar.index,t.beat)}Kp(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}Hp(t,e,s,i){let n=null;return null!=e&&(e.masterBar.start<=s&&e.masterBar.end>s?n=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(n=e.masterBar.nextMasterBar)),n||(n=this.Qp(s)),n?this.Xp(t,n,s,i):null}Xp(t,e,s,i){let n=e;for(;n;){if(n.firstBeat){const e=this.Yp(n,n.firstBeat,s,t,i);if(e)return e}n=n.nextMasterBar}return null}Yp(t,e,s,i,n){if(!e)return null;let r=null,a=null;const h=s-t.start;for(;null!=e&&null==a;){if((e.start<=h||n&&h<0)&&h<e.end){if(r=e,a=e.getVisibleBeatAtStart(i),!a)if(n){let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStart(i),a){r=e,t=s;break}e=e.nextBeat}a&&r||(s=s.nextMasterBar,e=s?.firstBeat??null)}}else{let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStart(i),a){r=e,t=s;break}e=e.previousBeat}a&&r||(s=s.previousMasterBar,e=s?.firstBeat??null)}}}else if(e.end>h)break;e=e?.nextBeat??null}if(null==a)return null;return this.Zp(t,r,a,n,i)}Zp(t,e,s,i,n){const r=new ya(t);if(r.beat=s,r.beatLookup=e,r.tickDuration=e.end-e.start,i){if(this.Jp(r)){const s=this.multiBarRestInfo.get(t.masterBar.index);let i=t;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-e.start:r.tickDuration=i.end-e.start:j.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.zp(r,n);return r.calculateDuration(),r}Qp(t){const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const n=(i+s)/2|0,r=e[n];if(t>=r.start&&t<r.end)return r;t<r.start?i=n-1:s=n+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new wa;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this.$p&&(t.previousMasterBar=this.$p,this.$p.nextMasterBar=t),this.$p=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this.$p;if(i)if(e<0&&i.previousMasterBar){const n=i.previousMasterBar.end-i.previousMasterBar.start,r=n+e,a=r+s;if(i.previousMasterBar.addBeat(t,r,r,s),a>n){const n=s+e;i.addBeat(t,e,0,n)}}else i.addBeat(t,e,e,s)}}class Sa{noteOnly=0;untilTieOrSlideEnd=0;letRingEnd=0}class Ba{firstBeatDuration=0;secondBeatStartOffset=0;secondBeatDuration=0}class _a{durations=[];brushInfos=[]}class xa{synthTick=0;synthTime=0;currentTempo=0;automationToSyncPoint=new Map;syncPoints;createNewSyncPoints=!1}class Ta{static tb=30;static eb=80;ue;vl;hi;sb=new Map;ib=0;nb=new Set;tickLookup=new ka;applyTranspositionPitches=!0;syncPoints=[];transpositionPitches=new Map;constructor(t,e,s){this.ue=t,this.vl=e||new Fr,this.hi=s}generate(){this.transpositionPitches.clear(),this.nb.clear(),this.ib=0;for(const t of this.ue.tracks)this.rb(t);j.debug("Midi","Begin midi generation"),this.syncPoints=[],Ta.ab(this.ue,this.syncPoints,!1,(t,e,s,i,n)=>{this.hb(t,e,s,i,n)},(t,e,s)=>{for(const i of this.ue.tracks)for(const n of i.staves)t<n.bars.length&&this.ob(n.bars[t],e,s)},t=>{for(const e of this.ue.tracks)this.hi.finishTrack(e.index,t)}),j.debug("Midi","Midi generation done")}rb(t){this.cb(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this.cb(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}lb(t,e,s,i){this.sb.has(s)&&this.sb.get(s)===i||(this.hi.addProgramChange(t.index,e,s,i),this.sb.set(s,i))}ub(t,e,s,i){const n=de.bankToLsbMsb(i);this.hi.addControlChange(t.index,e,s,ls.BankSelectCoarse,n[1]),this.hi.addControlChange(t.index,e,s,ls.BankSelectFine,n[0])}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const t=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,t),s.set(i.playbackInfo.secondaryChannel,t)}return s}cb(t,e,s){const i=t.index<this.vl.notation.transpositionPitches.length?this.vl.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(e,i);const n=Ta.fb(s.volume),r=Ta.fb(s.balance);this.hi.addControlChange(t.index,0,e,ls.VolumeCoarse,n),this.hi.addControlChange(t.index,0,e,ls.PanCoarse,r),this.hi.addControlChange(t.index,0,e,ls.ExpressionControllerCoarse,127),this.hi.addControlChange(t.index,0,e,ls.RegisteredParameterFine,0),this.hi.addControlChange(t.index,0,e,ls.RegisteredParameterCourse,0),this.hi.addControlChange(t.index,0,e,ls.DataEntryFine,0),this.hi.addControlChange(t.index,0,e,ls.DataEntryCoarse,Ta.pb),this.ub(t,0,e,s.bank),this.lb(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return Ta.ab(t,s,e,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}),s}static buildModifiedTempoLookup(t){return Ta.ab(t,[],!1,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}).automationToSyncPoint}static ab(t,e,s,i,n,r){const a=new pa(t),h=new xa;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let o=null;const c=new Map;for(;!a.finished;){const e=a.index,s=t.masterBars[e],r=a.currentTick;if(a.processCurrent(),a.shouldPlay){let t=c.has(e)?c.get(e):-1;t++,c.set(e,t),i(s,o,r,h.currentTempo,t);n(e,r,s.tempoAutomations.length>0?s.tempoAutomations[0].value:h.currentTempo),h.synthTick=r,Ta.bb(s,t,h)}a.moveNext(),o=s}if(e.length>0){const t=e[e.length-1],s=a.currentTick-t.synthTick;if(s>0){const i=new Vi;i.masterBarIndex=o.index,i.masterBarOccurence=c.get(o.index)-1,i.synthTick=a.currentTick,i.synthBpm=h.currentTempo,h.createNewSyncPoints?(i.syncBpm=t.synthBpm,i.synthBpm=t.synthBpm):1===e.length?i.syncBpm=t.synthBpm:i.syncBpm=e[e.length-2].syncBpm,i.synthTime=t.synthTime+I.ticksToMillis(s,t.synthBpm),i.syncTime=t.syncTime+I.ticksToMillis(s,i.syncBpm),h.createNewSyncPoints||t.updateSyncBpm(i.synthTime,i.syncTime),e.push(i)}}return r(a.currentTick),h}static bb(t,e,s){const i=t.calculateDuration(),n=t.syncPoints,r=s.synthTick;s.createNewSyncPoints?Ta.mb(t,e,s):n?Ta.gb(t,e,s):Ta.wb(t,s);const a=r+i,h=a-s.synthTick;h>0&&(s.synthTime+=I.ticksToMillis(h,s.currentTempo),s.synthTick=a)}static mb(t,e,s){const i=s.synthTick;if(0===t.index&&0===e){s.currentTempo=t.score.tempo;const n=new Vi;n.masterBarIndex=t.index,n.masterBarOccurence=e,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const n=t.calculateDuration();for(const r of t.tempoAutomations){const a=i+r.ratioPosition*n,h=a-s.synthTick;if(h>0&&(s.synthTick=a,s.synthTime+=I.ticksToMillis(h,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;const i=new Vi;i.masterBarIndex=t.index,i.masterBarOccurence=e,i.synthTick=a,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static gb(t,e,s){const i=s.synthTick,n=t.calculateDuration();let r,a=0;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const o=i+h.ratioPosition*n;for(;a<t.tempoAutomations.length&&t.tempoAutomations[a].ratioPosition<=h.ratioPosition;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=I.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=I.ticksToMillis(r,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const c=new Vi;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=o,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=h.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(h,c)}for(;a<t.tempoAutomations.length;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=I.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}}static wb(t,e){const s=e.synthTick,i=t.calculateDuration();for(const n of t.tempoAutomations){const t=s+n.ratioPosition*i,r=t-e.synthTick;r>0&&(e.synthTick=t,e.synthTime+=I.ticksToMillis(r,e.currentTempo)),e.currentTempo=n.value}}static fb(t){const e=Math.max(-32768,Math.min(32767,8*t-1));return Math.max(e,-1)+1}hb(t,e,s,i,n){e&&e.timeSignatureDenominator===t.timeSignatureDenominator&&e.timeSignatureNumerator===t.timeSignatureNumerator||this.hi.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const r=t.calculateDuration(),a=new wa;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&a.tempoChanges.push(new ga(s,i));for(const e of t.tempoAutomations){const t=s+r*e.ratioPosition;this.hi.addTempo(t,e.value),a.tempoChanges.push(new ga(t,e.value))}}else e?a.tempoChanges.push(new ga(s,i)):(this.hi.addTempo(s,t.score.tempo),a.tempoChanges.push(new ga(s,t.score.tempo)));a.masterBar=t,a.start=s,a.end=a.start+r,this.tickLookup.addMasterBar(a)}ob(t,e,s){const i=this.yb(t),n=this.ib;for(const r of i.voices)this.ib=n,this.kb(r,e,t,s);const r=i.masterBar,a=r.calculateDuration(),h=r.tempoAutomations.slice();if(0===h.length)this.ib=n+I.ticksToMillis(a,s);else{this.ib=n;let t=e,i=s;const r=e+a;for(const e of h){const s=a*e.ratioPosition-t;s>0&&(this.ib+=I.ticksToMillis(s,i)),i=e.value,t+=s}const o=r-t;o>0&&(this.ib+=I.ticksToMillis(o,i))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,a)}yb(t){switch(t.simileMark){case E.Simple:t.previousBar&&(t=this.yb(t.previousBar));break;case E.FirstOfDouble:case E.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this.yb(t.previousBar.previousBar))}return t}kb(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||0!==t.index))return;const n=s.masterBar.tempoAutomations.slice();let r=i;const a=s.masterBar.calculateDuration();for(const i of t.beats){const t=i.playbackStart/a;for(;n.length>0&&n[0].ratioPosition<=t;)r=n.shift().value;this.Sb(i,e,s,r)}}_b=null;Sb(t,e,s,i){let n=t.playbackStart,r=t.playbackDuration;const a=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?r=a:t.voice.bar.masterBar.tripletFeel!==rt.NoTripletFeel&&this.vl.player.playTripletFeel&&(this._b?(n-=this._b.secondBeatStartOffset,r=this._b.secondBeatDuration,this._b=null):(this._b=Ta.xb(n,r,t),this._b&&(r=this._b.firstBeatDuration))),t.showTimer&&!this.nb.has(t.id)&&(t.timer=this.ib,this.nb.add(t.id)),this.ib+=I.ticksToMillis(r,i),s===t.voice.bar&&this.tickLookup.addBeat(t,n,r);const h=t.voice.bar.staff.track;for(const s of t.automations)this.Tb(t,s,e);if(t.isRest)this.hi.addRest(h.index,e+n,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this.Mb(t,e+n);else{const s=this.Nb(t),a=this.Pb(t,r);for(const h of t.notes)this.Fb(h,e+n,r,i,s,a)}if(t.fade!==pt.None&&this.Lb(t,e+n,r),t.vibrato!==y.None){let s=240,i=3;switch(t.vibrato){case y.Slight:s=this.vl.player.vibrato.beatSlightLength,i=this.vl.player.vibrato.beatSlightAmplitude;break;case y.Wide:s=this.vl.player.vibrato.beatWideLength,i=this.vl.player.vibrato.beatWideAmplitude}this.Wb(e+n,t.playbackDuration,s,0,i,(e,s)=>{this.hi.addBend(t.voice.bar.staff.track.index,e,h.playbackInfo.secondaryChannel,s)})}}static xb(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case rt.Triplet8th:case rt.Dotted8th:case rt.Scottish8th:i=l.Eighth;break;case rt.Triplet16th:case rt.Dotted16th:case rt.Scottish16th:i=l.Sixteenth;break;default:return null}const n=I.toTicks(i);if(e!==n)return null;if(t%n!==0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==n)return null;const r=new Ba;switch(s.voice.bar.masterBar.tripletFeel){case rt.Triplet8th:r.firstBeatDuration=I.applyTuplet(I.toTicks(l.Quarter),3,2),r.secondBeatDuration=I.applyTuplet(I.toTicks(l.Eighth),3,2);break;case rt.Dotted8th:r.firstBeatDuration=I.applyDot(I.toTicks(l.Eighth),!1),r.secondBeatDuration=I.toTicks(l.Sixteenth);break;case rt.Scottish8th:r.firstBeatDuration=I.toTicks(l.Sixteenth),r.secondBeatDuration=I.applyDot(I.toTicks(l.Eighth),!1);break;case rt.Triplet16th:r.firstBeatDuration=I.applyTuplet(I.toTicks(l.Eighth),3,2),r.secondBeatDuration=I.applyTuplet(I.toTicks(l.Sixteenth),3,2);break;case rt.Dotted16th:r.firstBeatDuration=I.applyDot(I.toTicks(l.Sixteenth),!1),r.secondBeatDuration=I.toTicks(l.ThirtySecond);break;case rt.Scottish16th:r.firstBeatDuration=I.toTicks(l.ThirtySecond),r.secondBeatDuration=I.applyDot(I.toTicks(l.Sixteenth),!1)}return r.secondBeatStartOffset=e-r.firstBeatDuration,r}Mb(t,e){const s=I.toTicks(l.SixtyFourth),i=t.voice.bar.staff;if(i.tuning.length>0)for(const t of i.tuning)this.hi.addNote(i.track.index,e,s,t,I.dynamicToVelocity(n.F),i.track.playbackInfo.primaryChannel)}Rb(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==y.None}Ob(t,e){if(this.Rb(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this.Rb(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this.Rb(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}Fb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let o=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const e=zt.getArticulation(t);e&&(o=e.outputMidiNumber)}const c=null==r&&t.isStringed&&t.string<=n.length?n[t.string-1]:0,l=e+c,u=this.Ib(t,s,i);u.untilTieOrSlideEnd-=c,u.noteOnly-=c,u.letRingEnd-=c;const d=Ta.$b(t),f=this.Ob(a,t);let p=0;const b=Math.max(u.untilTieOrSlideEnd,u.letRingEnd);p=t.hasBend?Ta.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?Ta.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===w.Legato?-1:Ta.getPitchWheel(0),p>=0&&this.hi.addNoteBend(a.index,l,f,o,p),t.beat.hasRasgueado?this.Vb(a,t,l,o,d,f,r):t.ornament===lt.None?!t.isTrill||h.isPercussion?t.beat.isTremolo?this.Hb(t,l,u,o,d,f):(t.hasBend?this.Ub(t,l,u,o,f,i):t.beat.hasWhammyBar&&0===t.index?this.zb(t.beat,l,u,f,i):t.slideInType!==g.None||t.slideOutType!==w.None?this.jb(t,l,u,o,f,i):(t.vibrato!==y.None||t.isTieDestination&&t.tieOrigin.vibrato!==y.None)&&this.Xb(t,l,u,o,f),t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===w.Legato||this.hi.addNote(a.index,l,b,o,d,f)):this.Jb(t,l,u,o,d,f):this.qb(a,t,l,b,o,d,f)}static Yb=[2,2,2,1,1,2,2,2,2,2,1,1];static ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];qb(t,e,s,i,n,r,a){let h,o;const c=n%12,u=1/3;switch(e.ornament){case lt.Turn:h=[n+Ta.Yb[c],n,n+Ta.ornamentKeysDown[c]],o=[I.toTicks(l.Sixteenth)*u,I.toTicks(l.Sixteenth)*u,I.toTicks(l.Sixteenth)*u];break;case lt.InvertedTurn:h=[n+Ta.ornamentKeysDown[c],n,n+Ta.Yb[c]],o=[I.toTicks(l.Sixteenth)*u,I.toTicks(l.Sixteenth)*u,I.toTicks(l.Sixteenth)*u];break;case lt.UpperMordent:h=[n,n+Ta.Yb[c]],o=[I.toTicks(l.ThirtySecond),I.toTicks(l.ThirtySecond)];break;case lt.LowerMordent:h=[n,n+Ta.ornamentKeysDown[c]],o=[I.toTicks(l.ThirtySecond),I.toTicks(l.ThirtySecond)];break;default:return}let d=1;i<I.QuarterTime&&(d=i/I.QuarterTime),r-=I.VelocityIncrement;let f=0;for(let e=0;e<h.length;e++){const i=o[e]*d;this.hi.addNote(t.index,s,i,h[e],r,a),s+=i,f+=i}const p=i-f;this.hi.addNote(t.index,s,p,n,r,a)}Ib(e,s,i){const n=new Sa;if(n.noteOnly=s,n.untilTieOrSlideEnd=s,n.letRingEnd=s,e.isDead)return n.noteOnly=this.Kb(Ta.tb,s,i),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isPalmMute)return n.noteOnly=this.Kb(Ta.eb,s,i),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isStaccato)return n.noteOnly=s/2|0,n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isTieOrigin){const t=e.tieDestination;if(t)if(e.isTieDestination){const e=this.Ib(t,t.beat.playbackDuration,i);n.untilTieOrSlideEnd=s+e.untilTieOrSlideEnd}else{const s=e.beat.absolutePlaybackStart,r=this.Ib(t,t.beat.playbackDuration,i),a=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;n.untilTieOrSlideEnd=a-s}}else if(e.slideOutType===w.Legato){const t=e.slideTarget;if(t){const s=e.beat.absolutePlaybackStart,r=this.Ib(t,t.beat.playbackDuration,i),a=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;n.untilTieOrSlideEnd=a-s}}if(e.isLetRing&&this.vl.notation.notationMode===t.NotationMode.GuitarPro){let t=e.beat,i=0;const r=e.beat.voice.bar.masterBar.calculateDuration();for(;t.nextBeat;){const s=t.nextBeat;if(s.isRest)break;if(e.isStringed&&s.hasNoteOnString(e.string))break;if(t=t.nextBeat,i=t.absolutePlaybackStart-e.beat.absolutePlaybackStart+t.playbackDuration,i>r){i=r;break}}t===e.beat?n.letRingEnd=s:n.letRingEnd=i}else n.letRingEnd=n.untilTieOrSlideEnd;return n}Kb(t,e,s){const i=s*t/V.MaxPosition|0;return Math.min(i,e)}static $b(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case d.Normal:e++;break;case d.Heavy:e+=2}return I.dynamicToVelocity(t.dynamics,e)}Lb(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case pt.FadeIn:this.Qb(i,e,s,0,Ta.fb(i.playbackInfo.volume));break;case pt.FadeOut:this.Qb(i,e,s,Ta.fb(i.playbackInfo.volume),0);break;case pt.VolumeSwell:const t=s/2|0;this.Qb(i,e,t,0,Ta.fb(i.playbackInfo.volume)),this.Qb(i,e+t,t,Ta.fb(i.playbackInfo.volume),0)}}Qb(t,e,s,i,n){const r=(n-i)/(s=.8*s|0),a=s/120+1|0,h=e+s;for(let s=0;s<a;s++){const o=s===a-1,c=o?h:e+120*s,l=o?n:Math.round(i+(c-e)*r);this.hi.addControlChange(t.index,c,t.playbackInfo.primaryChannel,ls.VolumeCoarse,l),this.hi.addControlChange(t.index,c,t.playbackInfo.secondaryChannel,ls.VolumeCoarse,l)}}Xb(t,e,s,i,n){let r=0,a=0;switch(t.vibrato!==y.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:y.Slight){case y.Slight:r=this.vl.player.vibrato.noteSlightLength,a=this.vl.player.vibrato.noteSlightAmplitude;break;case y.Wide:r=this.vl.player.vibrato.noteWideLength,a=this.vl.player.vibrato.noteWideAmplitude;break;default:return}const h=t.beat.voice.bar.staff.track;let o=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const e=t.tieOrigin.bendPoints;o=e[e.length-1].value}this.Wb(e,s.noteOnly,r,o,a,(t,e)=>{this.hi.addNoteBend(h.index,t,n,i,e)})}vibratoResolution=16;Wb(t,e,s,i,n,r){const a=this.vibratoResolution,h=s/2|0,o=t+e;for(;t<o;){let e=0;const c=t+s<o?s:o-t;for(;e<c;){const s=i+n*Math.sin(e*Math.PI/h);r(t+e|0,Ta.getPitchWheel(s)),e+=a}t+=s}r(0|o,Ta.getPitchWheel(i))}static pb=16;static Zb=Gt.DefaultPitchWheel/Ta.pb;static tm=6;static sm=150;static getPitchWheel(t){return Gt.DefaultPitchWheel+t/2*Ta.Zb}jb(t,e,s,i,n,r){const a=t.slideOutType===w.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],o=t.beat.voice.bar.staff.track,c=this.vl.player.slide.simpleSlidePitchOffset,l=Math.floor(V.MaxPosition*this.vl.player.slide.simpleSlideDurationRatio),u=Math.floor(V.MaxPosition*this.vl.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case g.IntoFromAbove:h.push(new V(0,c)),h.push(new V(l,0));break;case g.IntoFromBelow:h.push(new V(0,-c)),h.push(new V(l,0))}switch(t.slideOutType){case w.Legato:case w.Shift:h.push(new V(u,0));const e=2*(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0));h.push(new V(V.MaxPosition,e));break;case w.OutDown:h.push(new V(V.MaxPosition-l,0)),h.push(new V(V.MaxPosition,-c));break;case w.OutUp:h.push(new V(V.MaxPosition-l,0)),h.push(new V(V.MaxPosition,c))}this.im(e,a,h,r,(t,e)=>{this.hi.addNoteBend(o.index,t,n,i,e)})}Ub(t,e,s,i,n,r){const o=t.bendPoints,c=t.beat.voice.bar.staff.track,l=(t,e)=>{this.hi.addNoteBend(c.index,t,n,i,e)};let d,f=null;if(t.isTieOrigin&&this.vl.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&e.tieDestination.vibrato===y.None;)e=e.tieDestination;d=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this.Ib(e,e.beat.playbackDuration,r).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==u.None){switch(t.tieDestination.bendType){case h.Bend:case h.BendRelease:case h.PrebendBend:f=t.tieDestination.bendPoints[1].value;break;case h.Prebend:case h.PrebendRelease:f=t.tieDestination.bendPoints[0].value}d=Math.max(s.noteOnly,I.millisToTicks(this.vl.player.songBookBendDuration,r))}else d=s.noteOnly;o[0].value>0&&!t.isContinuedBend&&e>0&&e--;const p=Math.min(d,I.millisToTicks(this.vl.player.songBookBendDuration,r));let b=[];switch(t.bendType){case h.Custom:b=o;break;case h.Bend:case h.Release:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new V(0,t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),b.push(new V(V.MaxPosition,f));break;case a.Fast:return(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void(t.beat.graceType===u.BendGrace?this.nm(e,d,!0,[t.bendPoints[0].value,f],p,r,l):this.nm(e,d,!1,[t.bendPoints[0].value,f],p,r,l))}break;case h.BendRelease:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new V(0,t.bendPoints[0].value)),b.push(new V(V.MaxPosition/2|0,t.bendPoints[1].value)),b.push(new V(V.MaxPosition,t.bendPoints[2].value));break;case a.Fast:return void this.nm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],p,r,l)}break;case h.Hold:case h.Prebend:b=o;break;case h.PrebendBend:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new V(0,t.bendPoints[0].value)),b.push(new V(V.MaxPosition,t.bendPoints[1].value));break;case a.Fast:return l(e,0|Ta.getPitchWheel(t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void this.nm(e,d,!1,[t.bendPoints[0].value,f],p,r,l)}break;case h.PrebendRelease:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new V(0,t.bendPoints[0].value)),b.push(new V(V.MaxPosition,t.bendPoints[1].value));break;case a.Fast:return l(e,0|Ta.getPitchWheel(t.bendPoints[0].value)),void this.nm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value],p,r,l)}}this.im(e,d,b,r,l)}nm(t,e,s,i,n,r,a){const h=s?t:t+e-n,o=n/(i.length-1);for(let t=0;t<i.length-1;t++){const e=Ta.getPitchWheel(i[t]),s=Ta.getPitchWheel(i[t+1]),n=h+o*t;this.rm(n,o,e,s,r,a)}}zb(t,e,s,i,n){const r=t.whammyBarPoints,h=t.voice.bar.staff.track,o=s.noteOnly;r[0].value>0&&!t.isContinuedWhammy&&e--;const c=(t,e)=>{this.hi.addBend(h.index,t,i,e)};let l=[];switch(t.whammyBarType){case dt.Custom:l=r;break;case dt.Dive:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new V(0,r[0].value)),l.push(new V(V.MaxPosition,r[1].value));break;case a.Fast:const t=Math.min(o,I.millisToTicks(this.vl.player.songBookBendDuration,n));return void this.nm(e,o,!1,[r[0].value,r[1].value],t,n,c)}break;case dt.Dip:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new V(0,r[0].value)),l.push(new V(V.MaxPosition/2|0,r[1].value)),l.push(new V(V.MaxPosition,r[2].value));break;case a.Fast:const t=Math.min(o,I.millisToTicks(this.vl.player.songBookDipDuration,n));return void this.nm(e,o,!0,[r[0].value,r[1].value,r[2].value],t,n,c)}break;case dt.Hold:case dt.Predive:l=r;break;case dt.PrediveDive:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new V(0,r[0].value)),l.push(new V(V.MaxPosition/2|0,r[0].value)),l.push(new V(V.MaxPosition,r[1].value));break;case a.Fast:const t=Ta.getPitchWheel(r[0].value);this.hi.addBend(h.index,e,i,0|t);const s=Math.min(o,I.millisToTicks(this.vl.player.songBookBendDuration,n));return void this.nm(e,o,!1,[r[0].value,r[1].value],s,n,c)}}this.im(e,o,l,n,c)}im(t,e,s,i,n){const r=e/V.MaxPosition;for(let e=0;e<s.length-1;e++){const a=s[e],h=s[e+1],o=Ta.getPitchWheel(a.value),c=Ta.getPitchWheel(h.value),l=r*(h.offset-a.offset),u=t+r*a.offset;this.rm(u,l,o,c,i,n)}}rm(t,e,s,i,n,r){const a=I.ticksToMillis(e,n),h=Math.abs(i-s)/Ta.Zb,o=Math.max(Ta.tm*h,a/Ta.sm),c=e/o,l=(i-s)/o,u=t+e;for(let e=0;e<o;e++)r(0|t,Math.round(s)),s+=l,t+=c;r(0|u,i)}Vb(t,e,s,i,n,r,a){let h=s;for(let s=0;s<a.durations.length;s++){const o=a.brushInfos[s],c=e.isStringed&&e.string<=o.length?o[e.string-1]:0,l=a.durations[s];this.hi.addNote(t.index,h+c,l-c,i,n,r),h+=l}}Jb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let o=I.toTicks(t.trillSpeed),c=!0,l=e;const u=e+s.untilTieOrSlideEnd;for(;l+10<u;)l+o>=u&&(o=u-l),this.hi.addNote(a.index,l,o,c?h:i,n,r),c=!c,l+=o}Hb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track;let h=I.toTicks(t.beat.tremoloSpeed),o=e;const c=e+s.untilTieOrSlideEnd;for(;o+10<c;)o+h>=c&&(h=c-o),this.hi.addNote(a.index,o,h,i,n,r),o+=h}static am=new Map([[gt.Ii,[o.BrushDown,o.BrushUp]],[gt.Mi,[o.BrushDown,o.BrushDown]],[gt.MiiTriplet,[o.BrushDown,o.BrushDown,o.BrushUp]],[gt.MiiAnapaest,[o.BrushDown,o.BrushDown,o.BrushUp]],[gt.PmpTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.PmpAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.PeiTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.PeiAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.PaiTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.PaiAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[gt.AmiTriplet,[o.BrushDown,o.BrushDown,o.BrushDown]],[gt.AmiAnapaest,[o.BrushDown,o.BrushDown,o.BrushDown]],[gt.Ppp,[o.None,o.BrushDown,o.BrushUp]],[gt.Amii,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[gt.Amip,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[gt.Eami,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown]],[gt.Eamii,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[gt.Peami,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]]]);static hm=new Map([[gt.Ii,[I.toTicks(l.Eighth),I.toTicks(l.Eighth)]],[gt.Mi,[I.toTicks(l.Eighth),I.toTicks(l.Eighth)]],[gt.MiiTriplet,[I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3]],[gt.MiiAnapaest,[I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth),I.toTicks(l.Eighth)]],[gt.PmpTriplet,[I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3]],[gt.PmpAnapaest,[I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Eighth)/3]],[gt.PeiTriplet,[I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3]],[gt.PeiAnapaest,[I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth),I.toTicks(l.Eighth)]],[gt.PaiTriplet,[I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3]],[gt.PaiAnapaest,[I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth),I.toTicks(l.Eighth)]],[gt.AmiTriplet,[I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3,I.toTicks(l.Eighth)/3]],[gt.AmiAnapaest,[I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Eighth)/3]],[gt.Ppp,[I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Eighth)/3]],[gt.Amii,[I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Eighth)]],[gt.Amip,[I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Sixteenth)/3,I.toTicks(l.Eighth)]],[gt.Eami,[I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth),I.toTicks(l.Sixteenth)]],[gt.Eamii,[I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5]],[gt.Peami,[I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5,I.toTicks(l.Sixteenth)/5]]]);Pb(t,e){if(!t.hasRasgueado)return null;const s=new _a,i=Ta.hm.get(t.rasgueado).reduce((t,e)=>t+e,0);s.durations=Ta.hm.get(t.rasgueado).map(t=>e*t/i),s.brushInfos=new Array(s.durations.length);const n=I.toTicks(l.Sixteenth);let r=0,a=0;for(const e of t.notes)e.isTieDestination||(r|=1<<e.string-1,a++);const h=Ta.am.get(t.rasgueado);for(let e=0;e<s.durations.length;e++){const i=s.durations[e]*n/I.QuarterTime,c=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[e]=c;const l=h[e];l!==o.None&&this.om(t,c,l===o.ArpeggioDown||l===o.BrushDown,r,a,i)}return s}Nb(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const e of t.notes)e.isTieDestination||(s|=1<<e.string-1,i++);this.om(t,e,t.brushType===o.ArpeggioDown||t.brushType===o.BrushDown,s,i,t.brushDuration)}return e}om(t,e,s,i,n,r){if(t.notes.length>0){let a=0;const h=r/(n-1)|0;for(let n=0;n<t.voice.bar.staff.tuning.length;n++){const t=s?n:e.length-1-n;i&1<<t&&(e[t]=a,a+=h)}}return e}Tb(t,e,s){switch(e.type){case r.Instrument:this.lb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&e.value),this.lb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&e.value);break;case r.Bank:this.ub(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,e.value),this.ub(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,e.value);break;case r.Balance:const i=Ta.fb(e.value);this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,ls.PanCoarse,i),this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,ls.PanCoarse,i);break;case r.Volume:const n=Ta.fb(e.value);this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,ls.VolumeCoarse,n),this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,ls.VolumeCoarse,n)}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(-1===e||-1===s);){for(const i of t.automations)switch(i.type){case r.Instrument:s=i.value;break;case r.Tempo:e=i.value}i=i.previousBeat}const n=t.voice.bar.staff.track,a=t.voice.bar.masterBar;-1===e&&(e=a.score.tempo);const h=t.playbackStart/a.calculateDuration();for(const t of a.tempoAutomations){if(!(t.ratioPosition<=h))break;e=t.value}-1===s&&(s=n.playbackInfo.program);const o=n.playbackInfo.volume;this.rb(n),this.hi.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this.hi.addTempo(0,e);const c=Ta.fb(o);return this.hi.addControlChange(0,0,n.playbackInfo.primaryChannel,ls.VolumeCoarse,c),this.hi.addControlChange(0,0,n.playbackInfo.secondaryChannel,ls.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this.Sb(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this.Fb(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}}class Ma{oldWidth=0;newWidth=0;settings=null}class va{x;y;width=0;height=0;renderer;constructor(t,e){this.x=t,this.y=e}getBoundingBoxTop(){return this.y}doLayout(){}paint(t,e,s){}}class Na extends va{beat=null;nextGlyph=null;previousGlyph=null;constructor(t=0,e=0){super(t,e)}}class Pa extends Na{glyphScale=0;symbol;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const t=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-t}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class Ea extends Na{glyphScale=0;symbols;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let t=0;for(let e=0;e<this.symbols.length;e++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[e]);(0===e||s<t)&&(t=s)}return this.y-this.offsetY-t}doLayout(){this.width=0,this.height=0;for(let t=0;t<this.symbols.length;t++){const e=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[t])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[t])*this.glyphScale;(0===t||e>this.width)&&(this.width=e),(0===t||s>this.height)&&(this.height=s)}}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class Ca extends Pa{static GraceScale=.75;centerOnStem=!1;constructor(t,e,s,i){super(t,e,i?Ca.GraceScale:1,Ca.getSymbol(s))}paint(t,e,s){this.centerOnStem&&(this.center=!0),super.paint(t,e,s)}static getSymbol(t){switch(t){case l.QuadrupleWhole:return at.NoteheadDoubleWholeSquare;case l.DoubleWhole:return at.NoteheadDoubleWhole;case l.Whole:return at.NoteheadWhole;case l.Half:return at.NoteheadHalf;default:return at.NoteheadBlack}}}class Fa extends Pa{constructor(t,e,s,i,n){super(t,e,n?Ca.GraceScale:1,Fa.getSymbol(s,i,n))}static getSymbol(t,e,s){if(s&&(t=l.Eighth),e===At.Up)switch(t){case l.Eighth:return at.Flag8thUp;case l.Sixteenth:return at.Flag16thUp;case l.ThirtySecond:return at.Flag32ndUp;case l.SixtyFourth:return at.Flag64thUp;case l.OneHundredTwentyEighth:return at.Flag128thUp;case l.TwoHundredFiftySixth:return at.Flag256thUp;default:return at.Flag8thUp}switch(t){case l.Eighth:return at.Flag8thDown;case l.Sixteenth:return at.Flag16thDown;case l.ThirtySecond:return at.Flag32ndDown;case l.SixtyFourth:return at.Flag64thDown;case l.OneHundredTwentyEighth:case l.TwoHundredFiftySixth:return at.Flag128thDown;default:return at.Flag8thDown}}}class Aa extends va{voiceContainer;beat;preNotes;onNotes;ties=[];minWidth=0;get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(t,e){super(0,0),this.beat=t,this.ties=[],this.voiceContainer=e}addTie(t){t.renderer=this.renderer,this.ties.push(t)}drawBeamHelperAsFlags(t){return t.hasFlag(!1,void 0)}registerLayoutingInfo(t){const e=this.preNotes.computedWidth+this.onNotes.centerX;let s=this.onNotes.computedWidth-this.onNotes.centerX;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(this.beat.graceType!==u.None||i&&this.drawBeamHelperAsFlags(i))&&(s+=this.renderer.smuflMetrics.glyphWidths.get(at.Flag8thUp)*Ca.GraceScale);for(const t of this.ties)s+=t.width;t.addBeatSpring(this.beat,e,s)}applyLayoutingInfo(t){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.onNotes.updateBeamingHelper();let t=this.beat.notes.length-1;for(;t>=0;)this.createTies(this.beat.notes[t--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&1===this.onNotes.beamingHelper.beats.length&&this.beat.duration>=l.Eighth){const t=Fa.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,this.beat.graceType!==u.None);this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(t)}let t=0;for(const e of this.ties)e.width>t&&(t=e.width);this.minWidth+=t,this.width=this.minWidth}scaleToWidth(t){this.onNotes.updateBeamingHelper(),this.width=t}createTies(t){}static getGroupId(t){return`b${t.id}`}paint(t,e,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;s.beginGroup(Aa.getGroupId(this.beat)),this.preNotes.paint(t+this.x,e+this.y,s),this.onNotes.paint(t+this.x,e+this.y,s);const i=t-this.voiceContainer.x-this.renderer.x,n=e-this.voiceContainer.y-this.renderer.y;for(let t=0,e=this.ties.length;t<e;t++){const e=this.ties[t];e.renderer=this.renderer,e.paint(i,n,s)}s.endGroup()}buildBoundingsLookup(t,e,s,i){const n=new Ne;if(n.beat=this.beat,this.beat.isEmpty)n.visualBounds=new Pe,n.visualBounds.x=e+this.x,n.visualBounds.y=t.visualBounds.y,n.visualBounds.w=this.width,n.visualBounds.h=t.visualBounds.h,n.realBounds=new Pe,n.realBounds.x=e+this.x,n.realBounds.y=t.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=t.realBounds.h,n.onNotesX=e+this.x+this.onNotes.centerX;else{n.visualBounds=new Pe,n.visualBounds.x=e+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?n.visualBounds.x=e+this.x:n.visualBounds.x=e+this.x+this.onNotes.x:n.visualBounds.x=e+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?e+this.x+this.width:e+this.x+this.preNotes.x+this.preNotes.width:e+this.x+this.onNotes.x+this.onNotes.width,n.visualBounds.w=s-n.visualBounds.x;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(i&&this.drawBeamHelperAsFlags(i)||this.beat.graceType!==u.None)&&(n.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(at.Flag8thUp)*(this.beat.graceType!==u.None?Ca.GraceScale:1)),n.visualBounds.y=t.visualBounds.y,n.visualBounds.h=t.visualBounds.h,n.realBounds=new Pe,n.realBounds.x=e+this.x,n.realBounds.y=t.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=t.realBounds.h,n.onNotesX=e+this.x+this.onNotes.x+this.onNotes.centerX}t.addBeat(n),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(n,e+this.x,s+this.y)}}class Da{lm;um;vl;dm=0;ue=null;fm=null;get instance(){return this.lm}set instance(t){this.lm=t;const e=this.um;if(e)for(const t of e)t();if(t){const e=[];e.push(t.preRender.on(t=>this.preRender.trigger(t))),e.push(t.renderFinished.on(t=>this.renderFinished.trigger(t))),e.push(t.partialRenderFinished.on(t=>this.partialRenderFinished.trigger(t))),e.push(t.partialLayoutFinished.on(t=>this.partialLayoutFinished.trigger(t))),e.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),e.push(t.error.on(t=>this.error.trigger(t))),this.um=e,this.vl&&t.updateSettings(this.vl),t.width=this.dm,null!==this.ue&&t.renderScore(this.ue,this.fm)}else this.um=void 0}get boundsLookup(){return this.lm?this.lm.boundsLookup:null}get width(){return this.lm?this.lm.width:0}set width(t){this.dm=t,this.lm&&(this.lm.width=t)}render(){this.lm?.render()}resizeRender(){this.lm?.resizeRender()}renderScore(t,e){this.ue=t,this.fm=e,this.lm?.renderScore(t,e)}renderResult(t){this.lm?.renderResult(t)}updateSettings(t){this.vl=t,this.lm?.updateSettings(t)}destroy(){this.lm?.destroy(),this.lm=void 0}preRender=new Me;renderFinished=new Me;partialRenderFinished=new Me;partialLayoutFinished=new Me;postRenderFinished=new Te;error=new Me}class La{activeBeats;constructor(t){this.activeBeats=t}}class Wa{pm=1;kf=0;Sf=0;bm=1;gm=!1;wm=[];lm;um;constructor(){this.ready=new Te(()=>this.isReady),this.readyForPlayback=new Te(()=>this.isReadyForPlayback),this.midiLoaded=new Me(()=>this.lm?.loadedMidiInfo??null),this.stateChanged=new Me(()=>new ji(this.state,!1)),this.positionChanged=new Me(()=>this.currentPosition),this.playbackRangeChanged=new Me(()=>{const t=this.playbackRange;return t?new tr(t):null})}get instance(){return this.lm}set instance(t){this.lm=t;const e=this.um;if(e)for(const t of e)t();if(t){const e=[];e.push(t.ready.on(()=>this.ready.trigger())),e.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),e.push(t.finished.on(()=>this.finished.trigger())),e.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),e.push(t.soundFontLoadFailed.on(t=>this.soundFontLoadFailed.trigger(t))),e.push(t.midiLoaded.on(t=>{this.midiLoaded.trigger(t)})),e.push(t.midiLoadFailed.on(t=>this.midiLoadFailed.trigger(t))),e.push(t.stateChanged.on(t=>this.stateChanged.trigger(t))),e.push(t.positionChanged.on(t=>{this.positionChanged.trigger(t)})),e.push(t.midiEventsPlayed.on(t=>this.midiEventsPlayed.trigger(t))),e.push(t.playbackRangeChanged.on(t=>this.playbackRangeChanged.trigger(t))),this.um=e,this.isReady?(t.masterVolume=this.pm,t.metronomeVolume=this.kf,t.countInVolume=this.Sf,t.playbackSpeed=this.bm,t.isLooping=this.gm,t.midiEventsPlayedFilter=this.wm,this.ready.trigger()):e.push(t.ready.on(()=>{t.masterVolume=this.pm,t.metronomeVolume=this.kf,t.countInVolume=this.Sf,t.playbackSpeed=this.bm,t.isLooping=this.gm,t.midiEventsPlayedFilter=this.wm}))}else this.um=void 0}get output(){return this.lm.output}get isReady(){return!!this.lm&&this.lm.isReady}get isReadyForPlayback(){return!!this.lm&&this.lm.isReadyForPlayback}get state(){return this.lm?this.lm.state:is.Paused}get logLevel(){return j.logLevel}set logLevel(t){j.logLevel=t,this.lm&&(this.lm.logLevel=t)}get masterVolume(){return this.pm}set masterVolume(t){t=Math.max(t,Gt.MinVolume),this.pm=t,this.lm&&(this.lm.masterVolume=t)}get metronomeVolume(){return this.kf}set metronomeVolume(t){t=Math.max(t,Gt.MinVolume),this.kf=t,this.lm&&(this.lm.metronomeVolume=t)}get playbackSpeed(){return this.bm}set playbackSpeed(t){this.bm=t,this.lm&&(this.lm.playbackSpeed=t)}get loadedMidiInfo(){return this.lm?this.lm.loadedMidiInfo:void 0}get currentPosition(){return this.lm?this.lm.currentPosition:new Xi(0,0,0,0,!1,120,120)}get tickPosition(){return this.lm?this.lm.tickPosition:0}set tickPosition(t){this.lm&&(this.lm.tickPosition=t)}get timePosition(){return this.lm?this.lm.timePosition:0}set timePosition(t){this.lm&&(this.lm.timePosition=t)}get playbackRange(){return this.lm?this.lm.playbackRange:null}set playbackRange(t){this.lm&&(this.lm.playbackRange=t)}get isLooping(){return this.gm}set isLooping(t){this.gm=t,this.lm&&(this.lm.isLooping=t)}get countInVolume(){return this.Sf}set countInVolume(t){this.Sf=t,this.lm&&(this.lm.countInVolume=t)}get midiEventsPlayedFilter(){return this.wm}set midiEventsPlayedFilter(t){this.wm=t,this.lm&&(this.lm.midiEventsPlayedFilter=t)}destroy(){this.lm&&(this.lm.destroy(),this.lm=void 0)}play(){return!!this.lm&&this.lm.play()}pause(){this.lm&&this.lm.pause()}playPause(){this.lm&&this.lm.playPause()}stop(){this.lm&&this.lm.stop()}playOneTimeMidiFile(t){this.lm&&this.lm.playOneTimeMidiFile(t)}loadSoundFont(t,e){this.lm&&this.lm.loadSoundFont(t,e)}resetSoundFonts(){this.lm&&this.lm.resetSoundFonts()}loadMidiFile(t){this.lm&&this.lm.loadMidiFile(t)}loadBackingTrack(t){this.lm&&this.lm.loadBackingTrack(t)}updateSyncPoints(t){this.lm&&this.lm.updateSyncPoints(t)}applyTranspositionPitches(t){this.lm&&this.lm.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.lm&&this.lm.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.lm&&this.lm.setChannelMute(t,e)}resetChannelStates(){this.lm&&this.lm.resetChannelStates()}setChannelSolo(t,e){this.lm&&this.lm.setChannelSolo(t,e)}setChannelVolume(t,e){this.lm&&this.lm.setChannelVolume(t,e)}ready;readyForPlayback;finished=new Te;soundFontLoaded=new Te;soundFontLoadFailed=new Me;midiLoaded;midiLoadFailed=new Me;stateChanged;positionChanged;midiEventsPlayed=new Me;playbackRangeChanged}class Ra{if=new Kn;masterVolume=1;metronomeVolume=0;outSampleRate=44100;currentTempo=120;timeSignatureNumerator=4;timeSignatureDenominator=4;activeVoiceCount=0;output;noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}ym(t){}dispatchEvent(t){this.if.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this.if.isEmpty;){const e=this.if.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this.ym(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class Oa extends ir{km;constructor(t,e){super(t,new Ra,e),this.synthesizer.output=t,this.km=t,t.timeUpdate.on(e=>{const s=this.sequencer.mainTimePositionFromBackingTrack(e,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(t){super.updateMasterVolume(t),this.km.masterVolume=t}updatePlaybackSpeed(t){super.updatePlaybackSpeed(t),this.km.playbackRate=t}onSampleRequest(){}loadMidiFile(t){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(t)}updateTimePosition(t,e){super.updateTimePosition(t,e),e&&this.km.seekTo(this.sequencer.mainTimePositionToBackingTrack(t,this.km.backingTrackDuration))}loadBackingTrack(t){const e=t.backingTrack;e&&(this.km.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(t){this.sequencer.mainUpdateSyncPoints(t),this.tickPosition=this.tickPosition}}class Ia{sampleRate=44100;Sm=0;hi;get handler(){return this.hi}set handler(t){t&&0!==this.Sm&&(t.seekTo(this.Sm),this.Sm=0),this.hi=t}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this.Sm=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(t){}resetSamples(){}activate(){}ready=new Te;samplesPlayed=new Me;timeUpdate=new Me;sampleRequest=new Te;async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class Ga extends Oa{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new Ia,t)}}class $a{startTick=0;endTick=0}class Va{beat;bounds=null;constructor(t){this.beat=t}}class Ha{Bm=0;fm=null;_m=null;xm=!1;ue=null;Tm=[];Mm=t.PlayerMode.Disabled;ip;op;get actualPlayerMode(){return this.Mm}uiFacade;container;get renderer(){return this.op}get score(){return this.ue}settings;get tracks(){return this.Tm}canvasElement;constructor(e,s){this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new Me(()=>this.ip.state===is.Playing&&this.vm?new La(this.vm.beatLookup.highlightedBeats.map(t=>t.beat)):null),this.playedBeatChanged=new Me(()=>this.ip.state===is.Playing&&this.vm?this.vm.beat:null),this.scoreLoaded=new Me(()=>this.ue?this.ue:null),this.midiLoaded=new Me(()=>this.ip.loadedMidiInfo??null),e.initialize(this,s),j.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),eu.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this.op=new Da,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&eu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.op.instance=this.uiFacade.createWorkerRenderer():this.op.instance=new De(this.settings),this.container.resize.on(eu.throttle(()=>{this.xm||this.container.width!==this.op.width&&this.triggerResize()},e.resizeThrottle));const i=new Ma;i.oldWidth=this.op.width,i.newWidth=0|this.container.width,i.settings=this.settings,this.Nm(i),this.op.preRender.on(this.Pm.bind(this)),this.op.renderFinished.on(t=>{this.gs(t)}),this.op.postRenderFinished.on(()=>{const t=Date.now()-this.Bm;j.debug("rendering",`Rendering completed in ${t}ms`),this.Em()}),this.op.preRender.on(t=>{this.Bm=Date.now()}),this.op.partialLayoutFinished.on(t=>this.Cm(t,!1)),this.op.partialRenderFinished.on(this.Fm.bind(this)),this.op.renderFinished.on(t=>{this.Cm(t,!0)}),this.op.error.on(this.onError.bind(this)),this.Am(),this.settings.player.playerMode!==t.PlayerMode.Disabled&&this.Dm(),this.Lm(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}Am(){const t=new Wa;this.ip=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this.Wm(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this.Rm.bind(this)),t.soundFontLoadFailed.on(t=>{this.onError(t)}),t.midiLoaded.on(this.Om.bind(this)),t.midiLoadFailed.on(t=>{this.onError(t)}),t.stateChanged.on(this.Im.bind(this)),t.positionChanged.on(this.Gm.bind(this)),t.midiEventsPlayed.on(this.$m.bind(this)),t.playbackRangeChanged.on(this.Vm.bind(this)),t.finished.on(this.Hm.bind(this))}destroy(){this.xm=!0,this.ip.destroy(),this.uiFacade.destroy(),this.op.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&Ht.applyPitchOffsets(this.settings,t),this.Um(),this.op.updateSettings(this.settings),this.Dm(),this.zm()}Um(){const t=this.op;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&eu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof De&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof De||(t.destroy(),t.instance=new De(this.settings))}load(t,e){try{return this.uiFacade.load(t,t=>{this.renderScore(t,e)},t=>{this.onError(t)})}catch(t){return this.onError(t),!1}}renderScore(t,e){const s=[];if(e)if(0===e.length)t.tracks.length>0&&s.push(t.tracks[0]);else if(1===e.length&&-1===e[0])for(const e of t.tracks)s.push(e);else for(const i of e)i>=0&&i<=t.tracks.length&&s.push(t.tracks[i]);else t.tracks.length>0&&s.push(t.tracks[0]);this.jm(t,s)}renderTracks(e){if(e.length>0){const s=e[0].score;for(const i of e)if(i.score!==s)return void this.onError(new R(t.AlphaTabErrorType.General,"All rendered tracks must belong to the same score."));this.jm(s,e)}}jm(t,e){if(Ht.applyPitchOffsets(this.settings,t),t!==this.score){this.ue=t,this.Tm=e,this.Xm=null,this.fm=[];for(const t of e)this.fm.push(t.index);this._m=new Set(this.fm),this.Jm(t),this.loadMidiForScore(),this.render()}else{this.Tm=e;const s=Ht.computeFirstDisplayedBarIndex(t,this.settings),i=Ht.computeLastDisplayedBarIndex(t,this.settings,s);this.Xm&&(this.Xm.multiBarRestInfo=Ht.buildMultiBarRestInfo(this.tracks,s,i)),this.fm=[];for(const t of e)this.fm.push(t.index);this._m=new Set(this.fm),this.render()}}triggerResize(){if(this.container.isVisible){const t=new Ma;t.oldWidth=this.op.width,t.newWidth=this.container.width,t.settings=this.settings,this.Nm(t),this.op.updateSettings(this.settings),this.op.width=this.container.width,this.op.resizeRender()}else j.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{j.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}Cm(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this.qm&&(this.qm.width=t.totalWidth,this.qm.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}Fm(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new Ve;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(t){this.onError(t)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this.ip.resetSoundFonts()}render(){this.uiFacade.canRender?(this.op.width=this.container.width,this.op.renderScore(this.score,this.fm)):this.uiFacade.canRenderChanged.on(()=>this.render())}Xm=null;get tickCache(){return this.Xm}get boundsLookup(){return this.op.boundsLookup}get player(){return this.ip.instance?this.ip:null}get isReadyForPlayback(){return this.ip.isReadyForPlayback}get playerState(){return this.ip.state}get masterVolume(){return this.ip.masterVolume}set masterVolume(t){this.ip.masterVolume=t}get metronomeVolume(){return this.ip.metronomeVolume}set metronomeVolume(t){this.ip.metronomeVolume=t}get countInVolume(){return this.ip.countInVolume}set countInVolume(t){this.ip.countInVolume=t}get midiEventsPlayedFilter(){return this.ip.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this.ip.midiEventsPlayedFilter=t}get tickPosition(){return this.ip.tickPosition}set tickPosition(t){this.ip.tickPosition=t}get timePosition(){return this.ip.timePosition}set timePosition(t){this.ip.timePosition=t}get endTick(){return this.ip.currentPosition.endTick}get endTime(){return this.ip.currentPosition.endTime}get playbackRange(){return this.ip.playbackRange}set playbackRange(t){this.ip.playbackRange=t,this.Ym(t)}get playbackSpeed(){return this.ip.playbackSpeed}set playbackSpeed(t){this.ip.playbackSpeed=t}get isLooping(){return this.ip.isLooping}set isLooping(t){this.ip.isLooping=t}Km(){this.ip.destroy(),this.Qm=0,this.Zm()}Dm(){let e=this.settings.player.playerMode;if(e===t.PlayerMode.EnabledAutomatic){const s=this.score;if(!s)return!1;e=s?.backingTrack?.rawAudioFile?t.PlayerMode.EnabledBackingTrack:t.PlayerMode.EnabledSynthesizer}let s=null;if(e===this.Mm)return this.tg(),!1;switch(this.Km(),this.tg(),e){case t.PlayerMode.Disabled:s=null;break;case t.PlayerMode.EnabledSynthesizer:s=this.uiFacade.createWorkerPlayer();break;case t.PlayerMode.EnabledBackingTrack:s=this.uiFacade.createBackingTrackPlayer();break;case t.PlayerMode.EnabledExternalMedia:s=new Ga(this.settings.player.bufferTimeInMilliseconds)}return this.Mm=e,!!s&&(this.ip.instance=s,!1)}loadMidiForScore(){if(!this.score)return;const t=this.score;j.debug("AlphaTab","Generating Midi");const e=new Mi,s=new da(e),i=new Ta(t,this.settings,s),n=Ht.computeFirstDisplayedBarIndex(t,this.settings),r=Ht.computeLastDisplayedBarIndex(t,this.settings,n);i.tickLookup.multiBarRestInfo=Ht.buildMultiBarRestInfo(this.tracks,n,r),i.applyTranspositionPitches=!1,i.generate(),this.Xm=i.tickLookup,this.eg(e);const a=this.ip;a.loadMidiFile(e),a.loadBackingTrack(t),a.updateSyncPoints(i.syncPoints),a.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const t=this.score;this.ip.updateSyncPoints(Ta.generateSyncPoints(t))}changeTrackVolume(t,e){for(const s of t)this.ip.setChannelVolume(s.playbackInfo.primaryChannel,e),this.ip.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this.ip.setChannelSolo(s.playbackInfo.primaryChannel,e),this.ip.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this.ip.setChannelMute(s.playbackInfo.primaryChannel,e),this.ip.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this.ip.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this.ip.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this.ip.play()}pause(){this.ip.pause()}playPause(){this.ip.playPause()}stop(){this.ip.stop()}playBeat(t){const e=new Mi,s=new da(e);new Ta(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this.ip.playOneTimeMidiFile(e)}playNote(t){const e=new Mi,s=new da(e);new Ta(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this.ip.playOneTimeMidiFile(e)}qm=null;sg=null;ig=null;ng=null;Qm=0;vm=null;rg=null;ag=!0;hg=is.Paused;og=null;cg=0;Zm(){this.qm&&(this.uiFacade.destroyCursors(),this.qm=null,this.sg=null,this.ig=null,this.ng=null)}tg(){const t=this.lg;if(t&&!this.qm){const t=this.uiFacade.createCursors();t&&(this.qm=t.cursorWrapper,this.sg=t.barCursor,this.ig=t.beatCursor,this.ng=t.selectionWrapper,this.ag=!0),null!==this.vm&&this.ug(this.vm,!1,this.Qm>10,1,!0)}else!t&&this.qm&&this.Zm()}dg(t,e,s,i=!1,n=!1){this.Qm=t;const r=this.Xm;if(r){const a=this._m;if(null!=a&&a.size>0){const h=r.findBeat(a,t,this.vm);h&&this.ug(h,e,i,s,n||this.playerState===is.Paused)}}}ug(t,e,s,i,n=!1){const r=t.beat,a=t.nextBeat?.beat??null,h=t.duration,o=t.beatLookup.highlightedBeats;if(!r)return;const c=this.op.boundsLookup;if(!c)return;const l=this.vm,u=this.og,d=this.hg;if(!n&&r===l?.beat&&c===u&&d===this.ip.state&&l?.start===t.start)return;const f=c.findBeat(r);f&&(this.vm=t,this.og=c,this.hg=this.ip.state,this.uiFacade.beginInvoke(()=>{this.fg(r,a,h,e,o,c,f,s,t.cursorMode,i)}))}scrollToCursor(){const t=this.rg;t&&this.pg(t.barBounds.masterBarBounds)}pg(e){const s=this.uiFacade.getScrollContainer(),i=eu.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,n=this.settings.player.scrollMode;if(i){const i=e.realBounds.y+this.settings.player.scrollOffsetY;if(i!==this.cg)switch(this.cg=i,n){case t.ScrollMode.Continuous:const n=this.uiFacade.getOffset(s,this.container);this.uiFacade.scrollToY(s,n.y+i,this.settings.player.scrollSpeed);break;case t.ScrollMode.OffScreen:const r=s.scrollTop+this.uiFacade.getOffset(null,s).h;if(e.visualBounds.y+e.visualBounds.h>=r||e.visualBounds.y<s.scrollTop){const t=e.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(s,t,this.settings.player.scrollSpeed)}}}else{const i=e.visualBounds.x;if(i!==this.cg)switch(this.cg=i,n){case t.ScrollMode.Continuous:const i=e.realBounds.x+this.settings.player.scrollOffsetX;this.cg=e.visualBounds.x,this.uiFacade.scrollToX(s,i,this.settings.player.scrollSpeed);break;case t.ScrollMode.OffScreen:const n=s.scrollLeft+this.uiFacade.getOffset(null,s).w;if(e.visualBounds.x+e.visualBounds.w>=n||e.visualBounds.x<s.scrollLeft){const t=e.realBounds.x+this.settings.player.scrollOffsetX;this.cg=e.visualBounds.x,this.uiFacade.scrollToX(s,t,this.settings.player.scrollSpeed)}}}}fg(e,s,i,n,r,a,h,o,c,l){const u=this.sg,d=this.ig,f=h.barBounds.masterBarBounds,p=f.visualBounds,b=this.rg;this.rg=h,u&&u.setBounds(p.x,p.y,p.w,p.h);const m=this.ip.state===is.Playing&&!n;let g=f.visualBounds.x+f.visualBounds.w;if(s&&c===ks.ToNextBext){const t=a.findBeat(s);t&&t.barBounds.masterBarBounds.staffSystemBounds===f.staffSystemBounds&&(g=t.onNotesX)}let w=h.onNotesX;if(d){if(this.settings.player.enableAnimatedBeatCursor){const t=g-h.onNotesX,e=this.Qm-this.vm.start,s=this.vm.tickDuration>0?e/this.vm.tickDuration:0;if(w=h.onNotesX+t*s,i-=i*s,m){(!b||this.ag||p.y!==b.barBounds.masterBarBounds.visualBounds.y||w<b.onNotesX||f.index>b.barBounds.masterBarBounds.index+1)&&(d.transitionToX(0,w),d.setBounds(w,p.y,1,p.h)),this.uiFacade.beginInvoke(()=>{const t=c===ks.ToNextBext?2:1,e=w+(g-w)*t;d.transitionToX(i/l*t,e)})}else d.transitionToX(0,w),d.setBounds(w,p.y,1,p.h)}else d.transitionToX(0,w),d.setBounds(w,p.y,1,p.h);this.ag=!1}else this.ag=!0;this.uiFacade.removeHighlights();let y=!1;if(m){if(this.settings.player.enableElementHighlighting)for(const t of r){const s=Aa.getGroupId(t.beat);this.uiFacade.highlightElements(s,e.voice.bar.index)}o=!n,y=!0}o&&!this.bg&&this.settings.player.scrollMode!==t.ScrollMode.Off&&this.pg(f),y&&(this.mg(e),this.gg(new La(r.map(t=>t.beat))))}playedBeatChanged;mg(t){this.xm||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}activeBeatsChanged;gg(t){this.xm||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}bg=!1;wg=!1;yg=null;kg=null;beatMouseDown=new Me;beatMouseMove=new Me;beatMouseUp=new Me;noteMouseDown=new Me;noteMouseMove=new Me;noteMouseUp=new Me;get lg(){return this.settings.player.playerMode!==t.PlayerMode.Disabled&&this.settings.player.enableCursor}Sg(t,e){this.xm||(this.lg&&this.settings.player.enableUserInteraction&&(this.yg=new Va(e),this.kg=null),this.bg=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}Bg(t,e){this.xm||(this.wg=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}_g(t,e){this.xm||(this.settings.player.enableUserInteraction&&(this.kg&&this.kg.beat===e||(this.kg=new Va(e),this.xg(this.yg,this.kg))),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}Tg(t,e){this.xm||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}Mg(t,e){if(!this.xm){if(this.lg&&this.settings.player.enableUserInteraction){if(this.kg){const t=this.Xm?.getBeatStart(this.yg.beat)??this.yg.beat.absolutePlaybackStart;if((this.Xm?.getBeatStart(this.kg.beat)??this.kg.beat.absolutePlaybackStart)<t){const t=this.yg;this.yg=this.kg,this.kg=t}}if(this.yg&&this.Xm){const t=this.Xm,e=t.getMasterBarStart(this.yg.beat.voice.bar.masterBar);if(this.vm=null,this.ip.state===is.Paused&&this.dg(this.Xm.getBeatStart(this.yg.beat),!1,1),this.tickPosition=e+this.yg.beat.playbackStart,this.kg&&this.yg.beat!==this.kg.beat){const s=t.getMasterBarStart(this.kg.beat.voice.bar.masterBar),i=new $a;i.startTick=e+this.yg.beat.playbackStart,i.endTick=s+this.kg.beat.playbackStart+this.kg.beat.playbackDuration-50,this.playbackRange=i}else this.yg=null,this.playbackRange=null,this.xg(this.yg,this.kg)}}this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this.bg=!1}}vg(t,e){this.xm||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this.wg=!1)}Ym(t){if(this.Xm)if(t){const e=this.Xm.findBeat(this._m,t.startTick),s=this.Xm.findBeat(this._m,t.endTick);if(e&&s){const t=new Va(e.beat),i=new Va(s.beat);this.xg(t,i)}}else this.xg(null,null)}Lm(){this.canvasElement.mouseDown.on(t=>{if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.op.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.Sg(t,i),this.settings.core.includeNoteBounds)){const n=this.op.boundsLookup?.getNoteAtPos(i,e,s);n&&this.Bg(t,n)}}),this.canvasElement.mouseMove.on(t=>{if(!this.bg)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.op.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this._g(t,i),this.wg)){const n=this.op.boundsLookup?.getNoteAtPos(i,e,s);n&&this.Tg(t,n)}}),this.canvasElement.mouseUp.on(t=>{if(!this.bg)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.op.boundsLookup?.getBeatAtPos(e,s)??null;if(this.Mg(t,i),this.wg)if(i){const n=this.op.boundsLookup?.getNoteAtPos(i,e,s)??null;this.vg(t,n)}else this.vg(t,null)}),this.op.postRenderFinished.on(()=>{this.yg&&this.lg&&this.settings.player.enableUserInteraction&&this.xg(this.yg,this.kg)})}xg(t,e){const s=this.op.boundsLookup;if(!s)return;const i=this.ng;if(!i)return;if(i.clear(),!t||!e||t.beat===e.beat)return;t.bounds||(t.bounds=s.findBeat(t.beat)),e.bounds||(e.bounds=s.findBeat(e.beat));const n=this.Xm?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart;if((this.Xm?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart)<n){const s=t;t=e,e=s}const r=t.bounds.realBounds.x;let a=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(a=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const n=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,h=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,o=this.uiFacade.createSelectionElement();o.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(o);const c=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,l=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let t=c;t<l;t++){const e=s.staffSystems[t],r=this.uiFacade.createSelectionElement();r.setBounds(n,e.visualBounds.y,h-n,e.visualBounds.h),i.appendChild(r)}const u=this.uiFacade.createSelectionElement();u.setBounds(n,e.bounds.barBounds.masterBarBounds.visualBounds.y,a-n,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(u)}else{const e=this.uiFacade.createSelectionElement();e.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,a-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(e)}}scoreLoaded;Jm(t){this.xm||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this.Dm()||this.loadMidiForScore())}resize=new Me;Nm(t){this.xm||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}renderStarted=new Me;Pm(t){this.xm||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}renderFinished=new Me;gs(t){this.xm||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}postRenderFinished=new Te;Em(){this.xm||(this.vm=null,this.dg(this.Qm,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}error=new Me;onError(t){this.xm||(j.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this.ip.readyForPlayback}Wm(){this.xm||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this.ip.finished}Hm(){this.xm||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this.ip.soundFontLoaded}Rm(){this.xm||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}midiLoad=new Me;eg(t){this.xm||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}midiLoaded;Om(t){this.xm||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this.ip.stateChanged}Im(t){if(!this.xm){if(!t.stopped&&t.state===is.Paused){const t=this.vm,e=this.Xm;t&&e&&(this.ip.tickPosition=e.getBeatStart(t.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this.ip.positionChanged}Gm(t){this.xm||(this.Qm=t.currentTick,this.uiFacade.beginInvoke(()=>{const e=t.modifiedTempo/t.originalTempo;this.dg(t.currentTick,!1,e,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t))}get midiEventsPlayed(){return this.ip.midiEventsPlayed}$m(t){this.xm||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this.ip.playbackRangeChanged}Vm(t){this.xm||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}settingsUpdated=new Te;zm(){this.xm||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this.ip.output.enumerateOutputDevices()}async setOutputDevice(t){await this.ip.output.setOutputDevice(t)}async getOutputDevice(){return await this.ip.output.getOutputDevice()}async exportAudio(e){if(!this.score)throw new R(t.AlphaTabErrorType.General,"No song loaded");let s;if(this.Mm===t.PlayerMode.EnabledSynthesizer)s=this.uiFacade.createWorkerAudioExporter(this.ip.instance);else s=this.uiFacade.createWorkerAudioExporter(null);const i=this.score,n=new Mi,r=new da(n),a=new Ta(i,this.settings,r);a.applyTranspositionPitches=!1,a.generate();const h=new er;h.soundFonts=e.soundFonts,h.sampleRate=e.sampleRate,h.useSyncPoints=e.useSyncPoints,h.masterVolume=e.masterVolume,h.metronomeVolume=e.metronomeVolume,h.playbackRange=e.playbackRange;for(const[t,s]of e.trackVolume)if(t<this.score.tracks.length){const e=this.score.tracks[t];h.trackVolume.set(e.playbackInfo.primaryChannel,s),h.trackVolume.set(e.playbackInfo.secondaryChannel,s)}for(const[t,s]of e.trackTranspositionPitches)if(t<this.score.tracks.length){const e=this.score.tracks[t];h.trackTranspositionPitches.set(e.playbackInfo.primaryChannel,s),h.trackTranspositionPitches.set(e.playbackInfo.secondaryChannel,s)}return await s.initialize(h,n,a.syncPoints,a.transpositionPitches),s}}class Ua extends R{xhr;constructor(e,s){super(t.AlphaTabErrorType.General,e),this.xhr=s}}class za{static loadAlphaTex(t,e){const s=new Ve;return s.logErrors=!0,s.initFromString(t,e??new Fr),s.readScore()}static loadScoreAsync(t,e,s,i){const n=new XMLHttpRequest;n.open("GET",t,!0,null,null),n.responseType="arraybuffer",n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){const t=n.response;if(200===n.status||0===n.status&&t)try{const t=n.response,s=new Uint8Array(t),r=za.loadScoreFromBytes(s,i);e(r)}catch(t){s(t)}else 0===n.status?s(new Ua("You are offline!!\n Please Check Your Network.",n)):404===n.status?s(new Ua("Requested URL not found.",n)):500===n.status?s(new Ua("Internel Server Error.",n)):"parsererror"===n.statusText?s(new Ua("Error.\nParsing JSON Request failed.",n)):"timeout"===n.statusText?s(new Ua("Request Time out.",n)):s(new Ua(`Unknow Error: ${n.responseText}`,n))}},n.send()}static loadScoreFromBytes(t,e){e||(e=new Fr);const s=eu.buildImporters();j.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const n=Ie.fromBuffer(t);for(const t of s){n.reset();try{j.debug("ScoreLoader",`Importing using importer ${t.name}`),t.init(n,e),i=t.readScore(),j.debug("ScoreLoader",`Score imported using ${t.name}`);break}catch(e){if(!(e instanceof Oe))throw j.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;j.debug("ScoreLoader",`${t.name} does not support the file`)}}if(i)return i;throw new Oe("No compatible importer found for file")}}class ja{mouseEvent;get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(t){const e=t.element,s=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(t){const e=t.element,s=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(t){this.mouseEvent=t}}class Xa{static Ng=new U(()=>new ResizeObserver(t=>{for(const e of t){const t=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(t)}}));Pg=0;get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){this.element.style.height=t>=0?`${t}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}element;constructor(t){this.element=t,this.mouseDown={on:t=>{const e=e=>{t(new ja(e))};return this.element.addEventListener("mousedown",e,!0),()=>{this.element.removeEventListener("mousedown",e,!0)}},off:t=>{}},this.mouseUp={on:t=>{const e=e=>{t(new ja(e))};return this.element.addEventListener("mouseup",e,!0),()=>{this.element.removeEventListener("mouseup",e,!0)}},off:t=>{}},this.mouseMove={on:t=>{const e=e=>{t(new ja(e))};return this.element.addEventListener("mousemove",e,!0),()=>{this.element.removeEventListener("mousemove",e,!0)}},off:t=>{}};const e=this;this.resize={on:function(t){return 0===e.Pg&&Xa.Ng.value.observe(e.element),e.element.addEventListener("resize",t,!0),e.Pg++,()=>this.off(t)},off:t=>{this.element.removeEventListener("resize",t,!0),this.Pg--,this.Pg<=0&&(this.Pg=0,Xa.Ng.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}lastBounds=new Pe;setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}resize;mouseDown;mouseMove;mouseUp;appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerHTML=""}}class Ja{Eg;Xf;Cg=!1;isFontLoaded=!1;fontLoaded=new Me;constructor(t){this.Eg=t,this.Xf=t}checkForFontAvailability(){if(eu.isRunningInWorker)return void(this.isFontLoaded=!1);if(this.Cg)return;this.Cg=!0;let t=0;const e=window.setInterval(()=>{j.warning("Rendering",`Could not load font '${this.Xf[0]}' within ${5*(t+1)} seconds`,null),this.Xf.length>1?(this.Xf.shift(),t=0):t++},5e3);j.debug("Font",`Start checking for font availablility: ${this.Xf.join(", ")}`);const s=t=>{this.Xf.length>1?(j.debug("Font",`[${this.Xf[0]}] Loading Failed, switching to ${this.Xf[1]}`,t),this.Xf.shift(),window.setTimeout(()=>{n()},0)):(j.error("Font",`[${this.Eg.join(",")}] Loading Failed, rendering cannot start`,t),window.clearInterval(e))},i=t=>{j.debug("Font",`[${t}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(e),this.fontLoaded.trigger(this.Xf[0])},n=async()=>{for(const t of this.Xf)if(await this.Fg(t,!1))return void i(t);try{await document.fonts.load(`1em ${this.Xf[0]}`)}catch(t){s(t)}return j.debug("Font",`[${this.Xf[0]}] Font API signaled loaded`),await this.Fg(this.Xf[0],!0)?i(this.Xf[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{n()})}Fg(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){j.debug("Font",`Font ${t} not available, creating test element to trigger load`);const e=document.createElement("div");e.style.font=i,e.style.opacity="0",e.style.position="absolute",e.style.top="0",e.style.left="0",e.innerText=`Trigger ${t} load`,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class qa extends Bi{Ag=null;kl;Sl=0;Bl=0;open(t){super.open(t),this.Sl=Math.floor(t*this.sampleRate/1e3/Bi.BufferSize),this.kl=new wi(Bi.BufferSize*this.Sl),this.onReady()}play(){super.play();const t=this.context;this.Ag=t.createScriptProcessor(4096,0,2),this.Ag.onaudioprocess=this.Dg.bind(this),this.kl.clear(),this.xl(),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.Ag,0,0),this.source.start(0),this.Ag.connect(t.destination,0,0)}pause(){super.pause(),this.Ag&&this.Ag.disconnect(0),this.Ag=null}addSamples(t){this.kl.write(t,0,t.length),this.Bl--}resetSamples(){this.kl.clear()}xl(){const t=this.Sl/2|0,e=t*Bi.BufferSize;if(this.kl.count+this.Bl*Bi.BufferSize<e){for(let e=0;e<t;e++)this.onSampleRequest();this.Bl+=t}}yl=new Float32Array(0);Dg(t){const e=t.outputBuffer.getChannelData(0),s=t.outputBuffer.getChannelData(1),i=e.length+s.length;let n=this.yl;n.length!==i&&(n=new Float32Array(i),this.yl=n);const r=this.kl.read(n,0,Math.min(n.length,this.kl.count));let a=0;const h=Math.min(e.length,r);for(let t=0;t<h;t++)e[t]=n[a++],s[t]=n[a++];if(r<e.length)for(let t=r;t<e.length;t++)e[t]=0,s[t]=0;this.onSamplesPlayed(r/Gt.AudioChannels),this.xl()}}class Ya{Cf;Hi;Lg=!1;Wg=!1;Rg=!1;oi=is.Paused;pm=0;kf=0;Sf=0;bm=0;gm=!1;Og=null;wm=[];xf;Wd=new Xi(0,0,0,0,!1,120,120);get output(){return this.Hi}get isReady(){return this.Wg&&this.Rg}get isReadyForPlayback(){return this.Lg}get state(){return this.oi}get logLevel(){return j.logLevel}get worker(){return this.Cf}set logLevel(t){j.logLevel=t,this.Cf.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this.pm}set masterVolume(t){t=Math.max(t,Gt.MinVolume),this.pm=t,this.Cf.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this.kf}set metronomeVolume(t){t=Math.max(t,Gt.MinVolume),this.kf=t,this.Cf.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this.Sf}set countInVolume(t){t=Math.max(t,Gt.MinVolume),this.Sf=t,this.Cf.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this.wm}set midiEventsPlayedFilter(t){this.wm=t,this.Cf.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:eu.prepareForPostMessage(t)})}get playbackSpeed(){return this.bm}set playbackSpeed(t){t=Ht.clamp(t,Gt.MinPlaybackSpeed,Gt.MaxPlaybackSpeed),this.bm=t,this.Cf.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this.Wd}get tickPosition(){return this.Wd.currentTick}set tickPosition(t){t<0&&(t=0),this.Wd=new Xi(this.Wd.currentTime,this.Wd.endTime,t,this.Wd.endTick,!0,this.Wd.originalTempo,this.Wd.modifiedTempo),this.Cf.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this.Wd.currentTime}set timePosition(t){t<0&&(t=0),this.Wd=new Xi(t,this.Wd.endTime,this.Wd.currentTick,this.Wd.endTick,!0,this.Wd.originalTempo,this.Wd.modifiedTempo),this.Cf.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this.gm}set isLooping(t){this.gm=t,this.Cf.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this.Og}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this.Og=t,this.Cf.postMessage({cmd:"alphaSynth.setPlaybackRange",value:eu.prepareForPostMessage(t)})}constructor(t,e){this.Lg=!1,this.Wg=!1,this.Rg=!1,this.oi=is.Paused,this.pm=0,this.kf=0,this.bm=0,this.gm=!1,this.Og=null,this.Hi=t,this.Hi.ready.on(this.Ig.bind(this)),this.Hi.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this.Hi.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this.Hi.open(e.player.bufferTimeInMilliseconds);try{this.Cf=eu.createWebWorker(e)}catch(t){j.error("AlphaSynth",`Failed to create WebWorker: ${t}`)}this.Cf.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this.Cf.postMessage({cmd:"alphaSynth.initialize",sampleRate:this.Hi.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this.Cf.postMessage({cmd:"alphaSynth.destroy"})}play(){return this.Hi.activate(),this.Cf.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this.Cf.postMessage({cmd:"alphaSynth.pause"})}playPause(){this.Hi.activate(),this.Cf.postMessage({cmd:"alphaSynth.playPause"})}stop(){this.Cf.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this.Cf.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:aa.midiFileToJsObject(eu.prepareForPostMessage(t))})}loadSoundFont(t,e){this.Cf.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:eu.prepareForPostMessage(t),append:e})}resetSoundFonts(){this.Cf.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this.Cf.postMessage({cmd:"alphaSynth.loadMidi",midi:aa.midiFileToJsObject(eu.prepareForPostMessage(t))})}applyTranspositionPitches(t){this.Cf.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(eu.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this.Cf.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this.Cf.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this.Cf.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this.Cf.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,Gt.MinVolume),this.Cf.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this.Wg=!0,this.Gg();break;case"alphaSynth.destroyed":this.Cf.terminate();break;case"alphaSynth.readyForPlayback":this.Lg=!0,this.Tf();break;case"alphaSynth.positionChanged":this.Wd=new Xi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this.Wd);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Zn(e.events.map(aa.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this.oi=e.state,this.stateChanged.trigger(new ji(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this.Og=e.playbackRange,this.playbackRangeChanged.trigger(new tr(this.Og));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this.Tf(),this.xf=new Xi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this.xf);break;case"alphaSynth.midiLoadFailed":this.Tf(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this.Hi.addSamples(e.samples);break;case"alphaSynth.output.play":this.Hi.play();break;case"alphaSynth.output.pause":this.Hi.pause();break;case"alphaSynth.output.destroy":this.Hi.destroy();break;case"alphaSynth.output.resetSamples":this.Hi.resetSamples()}}Gg(){this.isReady&&this.ready.trigger()}Tf(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}ready=new Te;readyForPlayback=new Te;finished=new Te;soundFontLoaded=new Te;soundFontLoadFailed=new Me;midiLoaded=new Me;midiLoadFailed=new Me;stateChanged=new Me;positionChanged=new Me;midiEventsPlayed=new Me;playbackRangeChanged=new Me;onOutputSampleRequest(){this.Cf.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this.Cf.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}Ig(){this.Rg=!0,this.Gg()}loadBackingTrack(t){}updateSyncPoints(t){}}class Ka{$g;ul;dm=0;boundsLookup=null;constructor(t,e){this.$g=t;try{this.ul=eu.createWebWorker(e)}catch(t){return void j.error("Rendering",`Failed to create WebWorker: ${t}`)}this.ul.postMessage({cmd:"alphaTab.initialize",settings:this.Vg(e)}),this.ul.addEventListener("message",this.Hg.bind(this))}destroy(){this.ul.terminate()}updateSettings(t){this.ul.postMessage({cmd:"alphaTab.updateSettings",settings:this.Vg(t)})}Vg(t){const e=aa.settingsToJsObject(eu.prepareForPostMessage(t));return e.delete("player"),e}render(){this.ul.postMessage({cmd:"alphaTab.render"})}resizeRender(){this.ul.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this.ul.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this.dm}set width(t){this.dm=t,this.ul.postMessage({cmd:"alphaTab.setWidth",width:t})}Hg(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=Ae.fromJson(e.boundsLookup,this.$g.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error)}}renderScore(t,e){const s=null==t?null:aa.scoreToJsObject(eu.prepareForPostMessage(t));this.ul.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:eu.prepareForPostMessage(e),fontSizes:ca.fontSizeLookupTables})}preRender=new Me;partialRenderFinished=new Me;partialLayoutFinished=new Me;renderFinished=new Me;postRenderFinished=new Te;error=new Me}class Qa{cursorWrapper;barCursor;beatCursor;selectionWrapper;constructor(t,e,s,i){this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}class Za extends Xa{Ug;zg;constructor(t,e,s){super(t),this.Ug=e,this.zg=s}get width(){return this.element.offsetWidth/this.Ug}set width(t){this.element.style.width=t*this.Ug+"px"}get height(){return this.element.offsetHeight/this.zg}set height(t){this.element.style.height=t>=0?t*this.zg+"px":"100%"}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this.Ug,Number.isNaN(i)?i=this.lastBounds.h:i/=this.zg,this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}}class th{sampleRate=44100;audioElement;jg=0;get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?1e3*t:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this.Xg()}),e.addEventListener("timeupdate",()=>{this.Xg()}),this.audioElement=e,this.ready.trigger()}Xg(){const t=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(t)}play(){this.audioElement.play(),this.jg=window.setInterval(()=>{this.Xg()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this.jg)}addSamples(t){}resetSamples(){}activate(){}ready=new Te;samplesPlayed=new Me;timeUpdate=new Me;sampleRequest=new Te;async enumerateOutputDevices(){return Si.enumerateOutputDevices()}async setOutputDevice(t){await Si.checkSinkIdSupport()&&(t?await this.audioElement.setSinkId(t.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await Si.checkSinkIdSupport())return null;const t=this.audioElement.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=Si.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(j.warning("WebAudio","Could not find output device in device list",t,s),null)}}class eh{static Jg=1;ul;qg;Yg;Kg;Qg=null;constructor(t,e){this.Yg=eh.Jg++,this.ul=t,this.Kg=e}async initialize(t,e,s,i){const n=this.handleWorkerMessage.bind(this);this.ul.worker.addEventListener("message",n,!1),this.qg=()=>{this.ul.worker.removeEventListener("message",n,!1)},this.Qg=Promise.withResolvers(),this.ul.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this.Yg,options:eu.prepareForPostMessage(t),midi:aa.midiFileToJsObject(eu.prepareForPostMessage(e)),syncPoints:eu.prepareForPostMessage(s),transpositionPitches:eu.prepareForPostMessage(i)}),await this.Qg.promise}handleWorkerMessage(e){const s=e.data;if(s.exporterId!==this.Yg)return;switch(s.cmd){case"alphaSynth.exporter.initialized":this.Qg?.resolve(null),this.Qg=null;break;case"alphaSynth.exporter.error":this.Qg?.reject(s.error),this.Qg=null;break;case"alphaSynth.exporter.rendered":this.Qg?.resolve(s.chunk),this.Qg=null;break;case"alphaSynth.destroyed":this.Qg?.reject(new R(t.AlphaTabErrorType.General,"Worker was destroyed")),this.Qg=null}}async render(e){if(this.Qg)throw new R(t.AlphaTabErrorType.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this.Qg=Promise.withResolvers(),this.ul.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this.Yg,milliseconds:e}),await this.Qg.promise}destroy(){this.ul.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this.Yg}),this.qg(),this.Kg&&this.ul.destroy()}[Symbol.dispose](){this.destroy()}}!function(t){t[t.LayoutDone=0]="LayoutDone",t[t.RenderRequested=1]="RenderRequested",t[t.RenderDone=2]="RenderDone",t[t.Detached=3]="Detached"}(Ss||(Ss={}));class sh{Zg=new Map;$g;tw=null;ew=null;sw=0;iw=null;nw;rw=new Map;aw=new Map;hw;rootContainerBecameVisible=new Te;canRenderChanged=new Te;get resizeThrottle(){return 10}rootContainer;areWorkersSupported;get canRender(){return this.ow()}ow(){let t=!1;for(const e of this.Zg.values())e.isFontLoaded||(t=!0);return!t&&(j.debug("Font",`All fonts loaded: ${this.Zg.size}`),!0)}cw(t){ca.generateFontLookup(t),this.ow()&&this.canRenderChanged.trigger()}constructor(e){if(eu.webPlatform!==t.WebPlatform.Browser&&eu.webPlatform!==t.WebPlatform.BrowserModule)throw new R(t.AlphaTabErrorType.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new Xa(e),this.areWorkersSupported="Worker"in window,this.nw=new IntersectionObserver(this.lw.bind(this),{threshold:[0,.01,1]}),this.nw.observe(e)}lw(t){for(const e of t){const t=e.target;if(t===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this.nw.unobserve(this.rootContainer.element));else if("layoutResultId"in t&&this.$g.settings.core.enableLazyLoading){const s=t;e.isIntersecting?s.renderedResultId!==s.layoutResultId?this.aw.has(s.layoutResultId)?s.resultState!==Ss.RenderRequested&&(s.resultState=Ss.RenderRequested,this.$g.renderer.renderResult(s.layoutResultId)):t.replaceChildren():s.resultState===Ss.Detached&&(t.replaceChildren(...s.renderedResult),s.resultState=Ss.RenderDone):s.resultState===Ss.RenderDone&&(s.resultState=Ss.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new Ka(this.$g,this.$g.settings)}initialize(e,s){let i;this.$g=e,i=s instanceof Fr?s:aa.jsObjectToSettings(s);const n=this.uw();Er.fromJson(i,n),i.notation.notationMode===t.NotationMode.SongBook&&i.setSongBookModeSettings(),e.settings=i,this.dw(i),this.iw=this.parseTracks(i.core.tracks),this.tw="";const r=e.container;i.core.tex&&(this.tw=r.element.innerHTML,r.element.innerHTML=""),this.fw(i),this.ew=i.core.file}dw(t){this.pw(t.display.resources.copyrightFont),this.pw(t.display.resources.effectFont),this.pw(t.display.resources.graceFont),this.pw(t.display.resources.markerFont),this.pw(t.display.resources.tablatureFont),this.pw(t.display.resources.titleFont),this.pw(t.display.resources.wordsFont),this.pw(t.display.resources.barNumberFont),this.pw(t.display.resources.fretboardNumberFont),this.pw(t.display.resources.subTitleFont)}pw(t){if(!this.Zg.has(t.families.join(", "))){const e=new Ja(t.families);this.Zg.set(t.families.join(", "),e),e.fontLoaded.on(this.cw.bind(this)),e.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";const t=this.hw;t.usages--,t.usages<=0&&(t.element.remove(),sh.bw.delete(t.hash))}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this.hw.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new Xa(t)}triggerEvent(t,e,s=null,i){const n=t.element;e=`alphaTab.${e}`;const r=document.createEvent("CustomEvent"),a=i?i.mouseEvent:null;if(r.initCustomEvent(e,!1,!1,s),a&&(r.originalEvent=a),n.dispatchEvent(r),window&&"jQuery"in window){const t=window.jQuery,i=[];i.push(s),a&&i.push(a),t(n).trigger(e,i)}}load(t,e,s){if(t instanceof Ot)return e(t),!0;if(t instanceof ArrayBuffer){const s=new Uint8Array(t);return e(za.loadScoreFromBytes(s,this.$g.settings)),!0}return t instanceof Uint8Array?(e(za.loadScoreFromBytes(t,this.$g.settings)),!0):"string"==typeof t&&(za.loadScoreAsync(t,e,s,this.$g.settings),!0)}loadSoundFont(t,e){return!!this.$g.player&&(t instanceof ArrayBuffer?(this.$g.player.loadSoundFont(new Uint8Array(t),e),!0):t instanceof Uint8Array?(this.$g.player.loadSoundFont(t,e),!0):"string"==typeof t&&(this.$g.loadSoundFontFromUrl(t,e),!0))}initialRender(){this.$g.renderer.preRender.on(t=>{this.sw=0,this.aw.clear(),this.rw.clear()});const t=()=>{this.$g.renderer.width=0|this.rootContainer.width,this.$g.renderer.updateSettings(this.$g.settings),this.tw?(this.$g.tex(this.tw,this.iw??void 0),this.iw=null):this.ew&&za.loadScoreAsync(this.ew,t=>{this.$g.renderScore(t,this.iw??void 0),this.iw=null},t=>{this.$g.onError(t)},this.$g.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}fw(t){const e=this.$g.container.element.ownerDocument;sh.createSharedStyleElement(e);const s=t.core.smuflFontSources??su.buildDefaultSmuflFontSources(t.core.fontDirectory),i=sh.mw(s.values()),n=sh.bw;if(n.has(i)){const t=n.get(i);return t.usages++,t.checker.fontLoaded.on(this.cw.bind(this)),void(this.hw=t)}const r=0===n.size?"":String(n.size),a=`alphaTab${r}`,h=`\n            @font-face {\n                font-display: block;\n                font-family: '${a}';\n                src: ${Array.from(s.entries()).map(t=>`url(${JSON.stringify(t[1])}) format('${sh.gw(t[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${r} .at {\n                font-family: '${a}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,o=e.createElement("style");o.id=`alphaTabStyle${r}`,o.innerHTML=h,e.getElementsByTagName("head").item(0).appendChild(o);const c=new Ja([a]);c.fontLoaded.on(this.cw.bind(this)),this.Zg.set(a,c),c.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=a;const l={hash:i,element:o,fontSuffix:r,usages:1,checker:c};n.set(i,l),this.hw=l}static gw(e){switch(e){case t.FontFileFormat.EmbeddedOpenType:return"embedded-opentype";case t.FontFileFormat.Woff:return"woff";case t.FontFileFormat.Woff2:return"woff2";case t.FontFileFormat.OpenType:return"opentype";case t.FontFileFormat.TrueType:return"truetype";case t.FontFileFormat.Svg:return"svg"}}static bw=new Map;static mw(t,e=0){let s=3735928559^e,i=1103547991^e;for(const e of t)for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);s=Math.imul(s^n,2654435761),i=Math.imul(i^n,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");if(!e){e=document.createElement("style"),e.id="alphaTabStyleShared";const t="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";e.innerHTML=t,document.getElementsByTagName("head").item(0).appendChild(e)}}parseTracks(t){if(!t)return[];const e=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch{t=[0]}if("number"==typeof t)e.push(t);else if("length"in t){const s=t.length,i=t;for(let t=0;t<s;t++){const s=i[t];let n=0;n="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(n>=0||-1===n)&&e.push(n)}}else"index"in t&&e.push(t.index);return e}uw(){const t=new Map,e=this.$g.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{const t=i;i=JSON.parse(t)}catch{""===i&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),n=i.nodeName;if(n.startsWith("data-")){const e=n.substr(5).split("-");let s=e[0];for(let t=1;t<e.length;t++)s+=e[t].substr(0,1).toUpperCase()+e[t].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}t.set(s,r)}}return t}beginUpdateRenderResults(t){if(!this.aw.has(t.id))return;const e=this.aw.get(t.id),s=t.renderResult;"string"==typeof s?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=Ss.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this.$g.canvasElement.element;if(t){let s;this.sw<e.childElementCount?s=e.childNodes.item(this.sw):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=Ss.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,this.aw.set(t.id,s);for(let e=t.firstMasterBarIndex;e<=t.lastMasterBarIndex;e++)e>=0&&this.rw.set(e,s);this.$g.settings.core.enableLazyLoading&&(this.nw.unobserve(s),this.nw.observe(s)),this.sw++}else for(;e.childElementCount>this.sw;)this.$g.settings.core.enableLazyLoading&&this.nw.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let e=null;const s="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this.$g.settings.player.outputMode===t.PlayerOutputMode.WebAudioAudioWorklets?(j.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new Ya(new xi(this.$g.settings),this.$g.settings)):s&&(j.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new Ya(new qa,this.$g.settings)),e?e.ready.on(()=>{this.$g.settings.player.soundFont&&this.$g.loadSoundFontFromUrl(this.$g.settings.player.soundFont,!1)}):j.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(t){const e=null===t||!(t instanceof Ya);return e&&(t=this.createWorkerPlayer()),new eh(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}ww=[];highlightElements(t,e){const s=this.rw.get(e);if(s){const e=s.getElementsByClassName(t);for(let t=0;t<e.length;t++)e.item(t).classList.add("at-highlight"),this.ww.push(e.item(t))}}removeHighlights(){const t=this.ww;if(t){for(const e of t)e.classList.remove("at-highlight");this.ww=[]}}destroyCursors(){const t=this.$g.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this.$g.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),n=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");const a=n.element;return a.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),a.style.position="absolute",a.style.transition="all 0s linear",a.style.left="0",a.style.top="0",a.style.willChange="transform",n.width=3,n.height=1,n.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(r),e.appendChild(a),new Qa(new Xa(e),i,n,new Xa(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let n=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const e=t.element,s=e.nodeName.toLowerCase();if("html"!==s&&"body"!==s){const s=this.getOffset(null,t);n=n+e.scrollTop-s.y,r=r+e.scrollLeft-s.x}}const a=new Pe;return a.x=r,a.y=n,a.w=i.width,a.h=i.height,a}yw=null;getScrollContainer(){if(this.yw)return this.yw;let t="string"==typeof this.$g.settings.player.scrollElement?document.querySelector(this.$g.settings.player.scrollElement):this.$g.settings.player.scrollElement;const e=t.nodeName.toLowerCase();if("html"===e||"body"===e)if("scrollingElement"in document)t=document.scrollingElement;else{t=-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement}return this.yw=new Xa(t),this.yw}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new Za(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this.kw(t.element,e,s)}scrollToX(t,e,s){this.Sw(t.element,e,s)}kw(t,e,s){if(this.$g.settings.player.nativeBrowserSmoothScroll)t.scrollTo({top:e,behavior:"smooth"});else{const i=t.scrollTop,n=e-i;let r=0;const a=e=>{0===r&&(r=e);const h=e-r,o=Math.min(h/s,1);t.scrollTop=i+n*o|0,h<s&&window.requestAnimationFrame(a)};window.requestAnimationFrame(a)}}Sw(t,e,s){if(this.$g.settings.player.nativeBrowserSmoothScroll)t.scrollTo({left:e,behavior:"smooth"});else{const i=t.scrollLeft,n=e-i;let r=0;const a=e=>{0===r&&(r=e);const h=e-r,o=Math.min(h/s,1);t.scrollLeft=i+n*o|0,h<s&&window.requestAnimationFrame(a)};window.requestAnimationFrame(a)}}createBackingTrackPlayer(){return new Oa(new th,this.$g.settings.player.bufferTimeInMilliseconds)}}class ih{loaded;total;constructor(t,e){this.loaded=t,this.total=e}}class nh extends Ha{constructor(t,e){super(new sh(t),e)}tex(t,e){const s=this.uiFacade;super.tex(t,s.parseTracks(e))}print(e,s=null){const i=window.open("","","width=0,height=0"),n=i.document.createElement("div");e?n.style.width=e:this.settings.display.layoutMode===t.LayoutMode.Horizontal?n.style.width="297mm":n.style.width="210mm",i.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const r=this.score;r&&(r.artist&&r.title?i.document.title=`${r.title} - ${r.artist}`:r.title&&(i.document.title=`${r.title}`)),i.document.body.appendChild(n);const a=void 0!==window.screenLeft?window.screenLeft:window.left,h=void 0!==window.screenTop?window.screenTop:window.top,o="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,c="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,l=n.offsetWidth+50,u=window.innerHeight,d=(o/2|0)-(l/2|0)+a,f=(c/2|0)-(u/2|0)+h;i.resizeTo(l,u),i.moveTo(d,f),i.focus();const p=aa.jsObjectToSettings(aa.settingsToJsObject(this.settings));p.core.enableLazyLoading=!1,p.core.useWorkers=!0,p.core.file=null,p.core.tracks=null,p.player.enableCursor=!1,p.player.playerMode=t.PlayerMode.Disabled,p.player.enableElementHighlighting=!1,p.player.enableUserInteraction=!1,p.player.soundFont=null,p.display.scale=.8,p.display.stretchForce=.8,Er.fromJson(p,s);const b=new nh(n,p);i.onunload=()=>{b.destroy()},b.renderer.postRenderFinished.on(()=>{i.print()}),b.renderTracks(this.tracks)}downloadMidi(t=es.SingleTrackMultiChannel){if(!this.score)return;const e=new Mi;e.format=t;const s=new da(e,!0);new Ta(this.score,this.settings,s).generate();const i=e.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=n;const a=new Blob([i],{type:"audio/midi"}),h=URL.createObjectURL(a);r.href=h,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(t,e){const s=this.Bw(this.uiFacade.parseTracks(t));super.changeTrackMute(s,e)}changeTrackSolo(t,e){const s=this.Bw(this.uiFacade.parseTracks(t));super.changeTrackSolo(s,e)}changeTrackVolume(t,e){const s=this.Bw(this.uiFacade.parseTracks(t));super.changeTrackVolume(s,e)}Bw(t){if(!this.score)return[];const e=[];if(1===t.length&&-1===t[0])for(const t of this.score.tracks)e.push(t);else for(const s of t)s>=0&&s<this.score.tracks.length&&e.push(this.score.tracks[s]);return e}soundFontLoad=new Me;loadSoundFontFromUrl(t,e){const s=this.player;if(!s)return;j.debug("AlphaSynth",`Start loading Soundfont from url ${t}`);const i=new XMLHttpRequest;i.open("GET",t,!0,null,null),i.responseType="arraybuffer",i.onload=t=>{const s=new Uint8Array(i.response);this.loadSoundFont(s,e)},i.onerror=t=>{j.error("AlphaSynth",`Loading failed: ${t.message}`),s.soundFontLoadFailed.trigger(new Ua(t.message,i))},i.onprogress=t=>{j.debug("AlphaSynth",`Soundfont downloading: ${t.loaded}/${t.total} bytes`);const e=new ih(t.loaded,t.total);this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)},i.send()}}class rh{exec(t,e,s){if("string"!=typeof e&&(s=[e],e="init"),95===e.charCodeAt(0)||"exec"===e)return null;const i=new jQuery(t),n=i.data("alphaTab");if("destroy"===e&&!n)return null;if("init"!==e&&!n)throw new Error("alphaTab not initialized");const r=this[e];if(r){const t=[i,n].concat(s);return r.apply(this,t)}return j.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new nh(t[0],s),t.data("alphaTab",e);for(const i of this._w)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return"number"==typeof s&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return"number"==typeof s&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return"number"==typeof s&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return"number"==typeof s&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return"number"==typeof s&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return"number"==typeof s&&(e.timePosition=s),e.timePosition}loop(t,e,s){return"boolean"==typeof s&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}_w=[];xw(t){this._w.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}var ah,hh,oh,ch,lh,uh,dh,fh="function"==typeof SuppressedError?SuppressedError:function(t,e,s){var i=new Error(s);return i.name="SuppressedError",i.error=t,i.suppressed=e,i};class ph{static Tw;static Mw=null;static enable(t,e){ph.Tw=e,ph.initializeMusicFont(ph.Tw.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){ph.Mw=new ph.Tw.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,e){const s=ph.Tw.AlphaSkiaTypeface.register(t.buffer);return e||(e=cr.withFamilyList([s.familyName],12,s.isItalic?us.Italic:us.Plain,s.weight>400?ds.Bold:ds.Regular)),e}mp;wp=new be(0,0,0,0);Sp=0;Nw=null;Pw=1;Ew=new Map;yp=new cr("Arial",10,us.Plain);Cw=null;settings;get font(){return this.yp}set font(t){if(this.yp===t)return;this.yp=t;const e=this.Fw(t);if(this.Ew.has(e))this.Nw=this.Ew.get(e);else{const s=new ph.Tw.AlphaSkiaTextStyle(t.families,t.weight===ds.Bold?700:400,t.isItalic);this.Ew.set(e,s),this.Nw=s}}Fw(t){return[...t.families,t.weight.toString(),t.isItalic?"italic":"upright"].join("_")}constructor(){this.mp=new ph.Tw.AlphaSkiaCanvas,this.color=new be(0,0,0,255)}destroy(){this.mp[Symbol.dispose]();for(const t of this.Ew.values())t[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,e){this.Pw=this.settings.display.scale,this.mp.beginRender(t,e,eu.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==ph.Mw.familyNames[0]?this.Ew.has(s)?this.Cw=this.Ew.get(s):(this.Cw=new ph.Tw.AlphaSkiaTextStyle([s],ph.Mw.weight,ph.Mw.isItalic),this.Ew.set(s,this.Cw)):this.Cw=ph.Mw}endRender(){return this.mp.endRender()}get color(){return this.wp}set color(t){this.wp.rgba!==t.rgba&&(this.wp=t,this.mp.color=ph.Tw.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this.Sp}set lineWidth(t){this.Sp=t,this.mp.lineWidth=t}fillRect(t,e,s,i){s>0&&this.mp.fillRect(t*this.Pw,e*this.Pw,s*this.Pw,i*this.Pw)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.mp.strokeRect(t*this.Pw+n,e*this.Pw+n,s*this.Pw,i*this.Pw)}beginPath(){this.mp.beginPath()}closePath(){this.mp.closePath()}moveTo(t,e){this.mp.moveTo(t*this.Pw,e*this.Pw)}lineTo(t,e){this.mp.lineTo(t*this.Pw,e*this.Pw)}quadraticCurveTo(t,e,s,i){this.mp.quadraticCurveTo(t*this.Pw,e*this.Pw,s*this.Pw,i*this.Pw)}bezierCurveTo(t,e,s,i,n,r){this.mp.bezierCurveTo(t*this.Pw,e*this.Pw,s*this.Pw,i*this.Pw,n*this.Pw,r*this.Pw)}fillCircle(t,e,s){this.mp.fillCircle(t*this.Pw,e*this.Pw,s*this.Pw)}strokeCircle(t,e,s){this.mp.strokeCircle(t*this.Pw,e*this.Pw,s*this.Pw)}fill(){this.mp.fill()}stroke(){this.mp.stroke()}textAlign=st.Left;textBaseline=it.Top;beginGroup(t){}endGroup(){}fillText(t,e,s){if(0===t.length)return;let i=ph.Tw.AlphaSkiaTextAlign.Left;switch(this.textAlign){case st.Left:i=ph.Tw.AlphaSkiaTextAlign.Left;break;case st.Center:i=ph.Tw.AlphaSkiaTextAlign.Center;break;case st.Right:i=ph.Tw.AlphaSkiaTextAlign.Right}let n=ph.Tw.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case it.Top:n=ph.Tw.AlphaSkiaTextBaseline.Top;break;case it.Middle:n=ph.Tw.AlphaSkiaTextBaseline.Middle;break;case it.Bottom:n=ph.Tw.AlphaSkiaTextBaseline.Bottom;break;case it.Alphabetic:n=ph.Tw.AlphaSkiaTextBaseline.Alphabetic}this.mp.fillText(t,this.Nw,this.yp.size*this.Pw,e*this.Pw,s*this.Pw,i,n)}measureText(t){const e={stack:[],error:void 0,hasError:!1};try{const s=function(t,e,s){if(null!=e){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object expected.");var i,n;if(s){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=e[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose],s&&(n=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");n&&(i=function(){try{n.call(this)}catch(t){return Promise.reject(t)}}),t.stack.push({value:e,dispose:i,async:s})}else s&&t.stack.push({async:!0});return e}(e,this.mp.measureText(t,this.Nw,this.yp.size,ph.Tw.AlphaSkiaTextAlign.Left,ph.Tw.AlphaSkiaTextBaseline.Alphabetic),!1),[i,n]=this.Aw(s,t);return new Dt(i,n)}catch(t){e.error=t,e.hasError=!0}finally{!function(t){function e(e){t.error=t.hasError?new fh(e,t.error,"An error was suppressed during disposal."):e,t.hasError=!0}var s,i=0;(function n(){for(;s=t.stack.pop();)try{if(!s.async&&1===i)return i=0,t.stack.push(s),Promise.resolve().then(n);if(s.dispose){var r=s.dispose.call(s.value);if(s.async)return i|=2,Promise.resolve(r).then(n,function(t){return e(t),n()})}else i|=1}catch(t){e(t)}if(1===i)return t.hasError?Promise.reject(t.error):Promise.resolve();if(t.hasError)throw t.error})()}(e)}}Aw(t,e){let s=t.width;if(e.length>0&&s<1)for(let e=0;e<5&&(s=t.width,!(s>1));e++);return[s,t.actualBoundingBoxAscent+t.actualBoundingBoxDescent]}fillMusicFontSymbol(t,e,s,i,n){i!==at.None&&this.Bp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==at.None&&(r+=String.fromCharCode(t));this.Bp(t,e,s,r,n)}Bp(t,e,s,i,n){this.mp.fillText(i,this.Cw,this.settings.display.resources.engravingSettings.musicFontSize*this.Pw*s,t*this.Pw,e*this.Pw,n?ph.Tw.AlphaSkiaTextAlign.Center:ph.Tw.AlphaSkiaTextAlign.Left,ph.Tw.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(t,e,s){this.mp.beginRotate(t*this.Pw,e*this.Pw,s)}endRotate(){this.mp.endRotate()}}class bh{buffer="";Dw="";Lw=!0;scale=1;color=new be(255,255,255,255);lineWidth=1;font=new cr("Arial",10,us.Plain);textAlign=st.Left;textBaseline=it.Top;settings;destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|t}px" height="${0|e}px" class="at-surface-svg">\n`,this.Dw="",this.Lw=!0,this.textBaseline=it.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale}" y="${e*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(t,e,s,i){const n=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${t*this.scale+n}" y="${e*this.scale+n}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this.Dw+=" z"}moveTo(t,e){this.Dw+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this.Lw=!1,this.Dw+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this.Lw=!1,this.Dw+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,n,r){this.Lw=!1,this.Dw+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${n*this.scale},${r*this.scale}`}fillCircle(t,e,s){this.Lw=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Dw+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this.Lw=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Dw+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this.Lw||(this.buffer+=`<path d="${this.Dw}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this.Dw="",this.Lw=!0}stroke(){if(!this.Lw){let t=`<path d="${this.Dw}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this.Dw="",this.Lw=!0}fillText(t,e,s){if(""===t)return;let i=`<text x="${e*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==st.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${bh.Ww(t)}</text>`,this.buffer+=i}static Ww(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case st.Left:return"start";case st.Center:return"middle";case st.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case it.Top:return"dominant-baseline: hanging";case it.Bottom:return"dominant-baseline: ideographic";case it.Alphabetic:return"";case it.Middle:return"dominant-baseline: middle";default:return""}}measureText(t){return t?ca.measureString(t,this.font.families,this.font.size,this.font.style,this.font.weight):new Dt(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class mh extends bh{fillMusicFontSymbol(t,e,s,i,n){i!==at.None&&this.Bp(t,e,s,`&#${i};`,n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==at.None&&(r+=`&#${t};`);this.Bp(t,e,s,r,n)}Bp(t,e,s,i,n){t*=this.scale,e*=this.scale,this.buffer+=`<g transform="translate(${t} ${e})" class="at" ><text`;const r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),n&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(st.Center)}"`),this.buffer+=`>${i}</text></g>`}}class gh{isInsideBracket=!0;isRelevantForBoundsLookup=!0;hideOnMultiTrack=!1;hideOnPercussionTrack=!1;canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}!function(t){t[t.PreNotes=0]="PreNotes",t[t.OnNotes=1]="OnNotes",t[t.MiddleNotes=2]="MiddleNotes",t[t.Stem=3]="Stem",t[t.PostNotes=4]="PostNotes",t[t.EndBeat=5]="EndBeat"}(ah||(ah={}));class wh extends va{glyphs=null;get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let t=0;const e=this.glyphs;if(e)for(const s of e){const e=s.getBoundingBoxTop();e<t&&(t=e)}return t}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let t=0,e=0;for(let s=0,i=this.glyphs.length;s<i;s++){const i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),t=Math.max(t,i.width),e=Math.max(e,i.y+i.height)}this.width=t,this.height=e}addGlyph(t){this.glyphs||(this.glyphs=[]),this.renderer&&(t.renderer=this.renderer),this.glyphs.push(t)}paint(t,e,s){const i=this.glyphs;if(i&&0!==i.length)for(const n of i)n.paint(t+this.x,e+this.y,s)}}class yh extends wh{gap=0;constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(t){t.x=this.width,t.renderer=this.renderer,t.doLayout(),this.width=t.x+t.width+this.gap,super.addGlyph(t)}}class kh{static score(t,e,s,i=!1){if(!s.style&&!i)return;const n=kh.Rw(t.settings.display.resources,e);return new Sh(t,e,s.style,n)}static scoreColor(t,e,s){const i=kh.Rw(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Rw(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let n=t.settings.display.resources.mainGlyphColor;switch(e){case D.StandardNotationRepeats:case D.GuitarTabsRepeats:case D.SlashRepeats:case D.NumberedRepeats:case D.StandardNotationClef:case D.GuitarTabsClef:case D.StandardNotationKeySignature:case D.NumberedKeySignature:case D.StandardNotationTimeSignature:case D.GuitarTabsTimeSignature:case D.SlashTimeSignature:case D.NumberedTimeSignature:break;case D.StandardNotationBarLines:case D.GuitarTabsBarLines:case D.SlashBarLines:case D.NumberedBarLines:n=t.settings.display.resources.barSeparatorColor;break;case D.StandardNotationBarNumber:case D.SlashBarNumber:case D.NumberedBarNumber:case D.GuitarTabsBarNumber:n=t.settings.display.resources.barNumberColor;break;case D.StandardNotationStaffLine:case D.GuitarTabsStaffLine:case D.SlashStaffLine:case D.NumberedStaffLine:n=t.settings.display.resources.staffLineColor}return new Sh(t,e,s.style,n)}static voice(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new Sh(t,e,s.style,n)}static trackColor(t,e,s){const i=kh.Ow(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Ow(t,e){let s=t.mainGlyphColor;switch(e){case Ct.TrackName:case Ct.SystemSeparator:case Ct.StringTuning:break;case Ct.BracesAndBrackets:s=t.barSeparatorColor}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const n=kh.Ow(t.settings.display.resources,e);return new Sh(t,e,s.style,n)}static beatColor(t,e,s){const i=kh.Iw(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Iw(t,e,s){return 0===s.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const n=kh.Iw(t.settings.display.resources,e,s);return new Sh(t,e,s.style,n)}static noteColor(t,e,s){const i=kh.Gw(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Gw(t,e,s){return 0===s.beat.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.beat.voice.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new Sh(t,e,s.style,n)}}class Sh{mp;$w;constructor(t,e,s,i){this.mp=t,s&&s.colors.has(e)?(this.$w=t.color,t.color=s.colors.get(e)??i):s||(this.$w=t.color,t.color=i)}[Symbol.dispose](){this.$w&&(this.mp.color=this.$w)}}class Bh extends wh{static KeySizeBeat="Beat";beatGlyphs;voice;tupletGroups;constructor(t,e,s){super(t,e),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(t){const e=this.renderer.layoutingInfo.spaceToForce(t);this.Vw(e)}Vw(t){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(t);const e=this.renderer.layoutingInfo.buildOnTimePositions(t),s=this.beatGlyphs;for(let t=0,i=s.length;t<i;t++){const n=s[t];if(n.beat.graceType===u.None)n.x=e.get(n.beat.absoluteDisplayStart)-n.onTimeX;else{const i=n.beat.graceGroup.beats[0].absoluteDisplayStart,r=n.beat.graceGroup.id;if(n.beat.graceGroup.isComplete&&e.has(i)){n.x=e.get(i)-n.onTimeX;const t=this.renderer.layoutingInfo.allGraceRods.get(r),s=n.beat.graceGroup.beats[n.beat.graceGroup.beats.length-1].nextBeat,a=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;n.x-=a,n.x-=t[n.beat.graceIndex].postSpringWidth,n.x+=t[n.beat.graceIndex].graceBeatWidth;const h=t[n.beat.graceGroup.beats.length-1];n.x-=h.graceBeatWidth}else{const e=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=e[n.beat.graceIndex].postSpringWidth-e[n.beat.graceIndex].preSpringWidth;t>0?0===n.beat.graceIndex?n.x=s[t-1].x+s[t-1].width:n.x=s[t-1].x+e[n.beat.graceIndex-1].postSpringWidth-e[n.beat.graceIndex-1].preSpringWidth-i:n.x=-i}}if(t>0){const e=n.x-s[t-1].x;s[t-1].scaleToWidth(e)}if(t===i-1){const t=this.width-s[s.length-1].x;n.scaleToWidth(t)}}}registerLayoutingInfo(t){const e=this.beatGlyphs;for(const s of e)s.registerLayoutingInfo(t)}applyLayoutingInfo(t){const e=this.beatGlyphs;for(const s of e)s.applyLayoutingInfo(t);this.Vw(Math.max(this.renderer.settings.display.stretchForce,t.minStretchForce))}addGlyph(t){const e=t;t.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,t.renderer=this.renderer,t.doLayout(),this.beatGlyphs.push(e),this.width=t.x+t.width,e.beat.hasTuplet&&e.beat.tupletGroup.beats[0].id===e.beat.id&&this.tupletGroups.push(e.beat.tupletGroup)}doLayout(){}paint(t,e,s){const i=kh.voice(s,W.Glyphs,this.voice,!0);try{for(let i=0,n=this.beatGlyphs.length;i<n;i++)this.beatGlyphs[i].paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class _h{staffId="";up=0;down=0}class xh{startBeat=null;startX=0;startY=0;endBeat=null;endX=0;endY=0;calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class Th{Hw;Uw=new Map;op;zw=null;jw=null;voice=null;beats=[];shortestDuration=l.QuadrupleWhole;tremoloDuration;hasTuplet=!1;slashBeats=[];lowestNoteInHelper=null;Xw=-1;highestNoteInHelper=null;Jw=-1;invertBeamDirection=!1;preferredBeamDirection=null;graceType=u.None;minRestLine=null;beatOfMinRestLine=null;maxRestLine=null;beatOfMaxRestLine=null;get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(t,e){return t&&this.qw(e)||!t&&1===this.beats.length&&this.qw(e)}qw(t){return t.duration>l.Whole}hasFlag(t,e){return t&&this.Yw(e)||!t&&1===this.beats.length&&this.Yw(this.beats[0])}Yw(t){return!t.deadSlapped&&!t.isRest&&(t.duration>l.Quarter||t.graceType!==u.None)}constructor(t,e){this.Hw=t,this.op=e,this.beats=[]}getBeatLineX(t,e){return e=e??this.direction,this.hasBeatLineX(t)?e===At.Up?this.Uw.get(t.index).up:this.Uw.get(t.index).down:0}hasBeatLineX(t){return this.Uw.has(t.index)}registerBeatLineX(t,e,s,i){const n=this.Kw(e);n.staffId=t,n.up=s,n.down=i;for(const t of this.drawingInfos.values())t.startBeat===e?t.startX=this.getBeatLineX(e):t.endBeat===e&&(t.endX=this.getBeatLineX(e))}Kw(t){return this.Uw.has(t.index)||this.Uw.set(t.index,new _h),this.Uw.get(t.index)}direction=At.Up;finish(){this.direction=this.Qw(),this.op.completeBeamingHelper(this)}Qw(){if(!this.voice)return At.Up;if(null!==this.preferredBeamDirection)return this.preferredBeamDirection;if(this.voice.index>0)return this.Zw(At.Down);if(this.voice.bar.isMultiVoice)return this.Zw(At.Up);if(this.beats[0].graceType!==u.None)return this.Zw(At.Up);if(this.highestNoteInHelper&&this.lowestNoteInHelper){const t=(this.op.getNoteY(this.highestNoteInHelper,oh.Center)+this.op.getNoteY(this.lowestNoteInHelper,oh.Center))/2;return this.Zw(this.op.middleYPosition<t?At.Up:At.Down)}return this.Zw(At.Up)}static computeLineHeightsForRest(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:return[2,2];case l.Whole:return[0,1];case l.Half:return[1,0];case l.Quarter:return[3,3];case l.Eighth:return[2,2];case l.Sixteenth:return[2,4];case l.ThirtySecond:return[4,4];case l.SixtyFourth:return[4,6];case l.OneHundredTwentyEighth:return[6,6];case l.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(t,e){if(this.jw&&t.index>=this.jw.index||this.zw&&t.index<=this.zw.index)return;let s=e,i=e;const n=Th.computeLineHeightsForRest(t.duration);s-=n[0],i+=n[1];const r=this.minRestLine,a=this.maxRestLine;(null===r||r>s)&&(this.minRestLine=s,this.beatOfMinRestLine=t),(null===a||a<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=t)}Zw(t){return this.invertBeamDirection?t===At.Down?At.Up:At.Down:t}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case wt.Auto:case wt.ForceSplitOnSecondaryToNext:e=Th.ty(this.beats[this.beats.length-1],t);break;case wt.ForceSplitToNext:e=!1;break;case wt.ForceMergeWithNext:e=!0}return e&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<t.tremoloSpeed)&&(this.tremoloDuration=t.tremoloSpeed),t.graceType!==u.None&&(this.graceType=t.graceType),t.isRest?0===this.beats.length&&this.beats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this.ey(t.minNote),this.ey(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration),this.zw||(this.zw=t),this.jw=t),t.slashed&&this.slashBeats.push(t)),e}ey(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-fi.getPercussionLine(this.voice.bar,fi.getNoteValue(t)),s=e):(e=fi.getNoteValue(t),s=e,t.harmonicType!==p.None&&t.harmonicType!==p.Natural&&(s=t.realValue-this.Hw.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this.Xw)&&(this.lowestNoteInHelper=t,this.Xw=e),(!this.highestNoteInHelper||s>this.Jw)&&(this.highestNoteInHelper=t,this.Jw=s)}static ty(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===u.BendGrace||e.graceType===u.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==u.None&&e.graceType!==u.None)return!0;const s=t.voice.bar;if(s!==e.voice.bar)return!1;const i=t.playbackStart,n=e.playbackStart;if(!Th.sy(t.duration)||!Th.sy(e.duration))return i===n;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;let r=I.QuarterTime;if(8===s.masterBar.timeSignatureDenominator)s.masterBar.timeSignatureNumerator%3==0&&(r+=I.QuarterTime/2|0);return((r+i)/r|0)===((r+n)/r|0)}static sy(t){switch(t){case l.Whole:case l.Half:case l.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return Ht.getIndex(t.duration)-2-s>0&&Ht.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(t,e){return!this.Uw.has(e.index)||(this.Uw.get(e.index).staffId===t||!this.Uw.get(e.index).staffId)}drawingInfos=new Map}class Mh{topY=0;bottomY=0;constructor(t,e){this.topY=t,this.bottomY=e}}class vh{beat;topY=-1e3;bottomY=-1e3;slots=[];constructor(t){this.beat=t}addSlot(t,e){if(this.slots.push(new Mh(t,e)),-1e3===this.topY)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class Nh{reservedLayoutAreasByDisplayTime=new Map;restDurationsByDisplayTime=new Map;getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===t?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return-1e3===t?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new vh(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=Th.computeLineHeightsForRest(t.duration).map(t=>t*s),n=e-i[0],r=e+i[1];let a=n;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let o=!1;for(const t of h.slots)if(n>=t.topY&&n<=t.bottomY||r>=t.topY&&r<=t.bottomY){o=!0;break}if(o){a=1===t.voice.index?h.topY-i[1]-i[0]:h.bottomY;const e=a+i[0]+i[1],r=2*s,o=Math.ceil(Math.abs(a-n)/r);return h.addSlot(a,e),a<n?o*-r:o*r}}return 0}}class Ph{op;beamHelpers=[];beamHelperLookup=[];collisionHelper;preferredBeamDirection=null;constructor(t){this.op=t,this.collisionHelper=new Nh}initialize(){const t=this.op,e=this.op.bar;let s=null,i=null;for(let n=0,r=e.voices.length;n<r;n++){const r=e.voices[n];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let n=0,a=r.beats.length;n<a;n++){const a=r.beats[n];let h;a.graceType!==u.None?h=i:(h=s,i=null),h&&h.checkBeat(a)||(h&&h.finish(),h=new Th(e.staff,t),h.preferredBeamDirection=this.preferredBeamDirection,h.checkBeat(a),a.graceType!==u.None?i=h:s=h,this.beamHelpers[r.index].push(h)),this.beamHelperLookup[r.index].set(a.index,h)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(t){return this.beamHelperLookup[t.voice.index].get(t.index)}}class Eh extends Na{static iy=5;ny;hy=0;oy=0;ly=0;constructor(t,e,s){super(t,e),this.ny=s}doLayout(){super.doLayout();const t=this.renderer.resources;this.hy=1.5*t.effectFont.size,this.oy=1.5*t.effectFont.size,this.ny.firstFret>1?this.ly=this.renderer.smuflMetrics.chordDiagramFretSpacing:this.ly=0,this.height=this.hy+this.oy+Eh.iy*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width=this.ly+(this.ny.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingX}paint(t,e,s){t+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this.ly,e+=this.y;const i=this.renderer.smuflMetrics.chordDiagramStringSpacing,n=this.renderer.smuflMetrics.chordDiagramFretSpacing,r=this.renderer.resources,a=r.engravingSettings.chordDiagramLineWidth,h=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this.ly+a,o=r.engravingSettings.glyphHeights.get(at.FretboardFilledCircle),c=r.engravingSettings.glyphTop.get(at.FretboardFilledCircle),l=r.engravingSettings.glyphHeights.get(at.FretboardX)/2,u=r.engravingSettings.glyphHeights.get(at.FretboardO)/2,d=s.textAlign,f=s.textBaseline;s.font=r.effectFont,s.textAlign=st.Center,s.textBaseline=it.Top,this.ny.showName&&s.fillText(this.ny.name,t+h/2,e+r.effectFont.size/2),e+=this.hy,s.font=r.fretboardNumberFont,s.textBaseline=it.Middle;for(let n=0;n<this.ny.strings.length;n++){const r=t+n*i,a=e+this.oy/2;let h=this.ny.strings[this.ny.strings.length-n-1];h<0?Lt.fillMusicFontSymbolSafe(s,r,a+l,1,at.FretboardX,!0):0===h?Lt.fillMusicFontSymbolSafe(s,r,a+u,1,at.FretboardO,!0):(h-=this.ny.firstFret-1,s.fillText(h.toString(),r,a))}e+=this.oy;for(let r=0;r<this.ny.strings.length;r++){const h=t+r*i;s.fillRect(h,e,a,n*Eh.iy+1)}this.ny.firstFret>1?(s.textAlign=st.Left,s.fillText(this.ny.firstFret.toString(),t-this.ly,e+n/2),s.fillRect(t,e,h,a)):s.fillRect(t,e-this.renderer.smuflMetrics.chordDiagramNutHeight/2,h,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let i=0;i<=Eh.iy;i++){const r=e+i*n;s.fillRect(t,r,h,this.renderer.smuflMetrics.chordDiagramFretHeight)}const p=new Map;for(const t of this.ny.barreFrets){const e=[-1,-1];p.set(t-this.ny.firstFret,e)}for(let r=0;r<this.ny.strings.length;r++){let h=this.ny.strings[r];if(h>0){if(h-=this.ny.firstFret,p.has(h)){const t=p.get(h);(-1===t[0]||r<t[0])&&(t[0]=r),(-1===t[1]||r>t[1])&&(t[1]=r)}const l=e+h*n+n/2+.5,u=t+(this.ny.strings.length-r-1)*i+a/2;Lt.fillMusicFontSymbolSafe(s,u,l+c-o/2,1,at.FretboardFilledCircle,!0)}}for(const[r,a]of p){const h=e+r*n+n/2+.5,c=t+(this.ny.strings.length-a[1]-1)*i,l=t+(this.ny.strings.length-a[0]-1)*i;s.fillRect(c,h-o/2,l-c,o)}s.textAlign=d,s.textBaseline=f}}class Ch extends wh{uy=0;py;constructor(t,e,s=st.Center){super(t,e),this.glyphs=[],this.py=s}doLayout(){const t=this.renderer.smuflMetrics.rowContainerGap,e=this.uy-t;let s=0;switch(this.py){case st.Left:s=0;break;case st.Center:s=(this.width-e)/2;break;case st.Right:s=this.width-e}for(const e of this.glyphs)e.x=s,s+=e.width+t}addGlyphToRow(t){this.glyphs.push(t),this.uy+=t.width+this.renderer.smuflMetrics.rowContainerGap,t.height>this.height&&(this.height=t.height)}}class Fh extends wh{by=[];py;constructor(t,e,s=st.Center){super(t,e),this.height=0,this.glyphs=[],this.py=s}doLayout(){let t=0,e=0;const s=this.renderer.smuflMetrics.rowContainerGap;this.by=[];let i=new Ch(t,e,this.py);i.renderer=this.renderer,i.width=this.width;for(const n of this.glyphs){const r=t+n.width+s;r<this.width?(i.addGlyphToRow(n),t=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this.by.push(i),e+=i.height+s),t=0,i=new Ch(t,e,this.py),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(n),t+=Math.ceil(n.width+s))}i.isEmpty||(i.doLayout(),this.by.push(i),e+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=e}paint(t,e,s){for(const i of this.by)i.paint(t+this.x,e+this.y,s)}}class Ah extends Fh{addChord(t){if(t.strings.length>0){const e=new Eh(0,0,t);e.renderer=this.renderer,e.doLayout(),this.glyphs.push(e)}}paint(t,e,s){if(this.glyphs.length>0){const i=kh.score(s,nt.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Dh extends Na{my;gy=null;font;textAlign;textBaseline;colorOverride;constructor(t,e,s,i,n=st.Left,r=null,a){super(t,e),this.my=s.split("\n"),this.font=i,this.textAlign=n,this.textBaseline=r,this.colorOverride=a}doLayout(){super.doLayout(),this.gy=[];const t=this.renderer.scoreRenderer.canvas;for(const e of this.my){t.font=this.font;const s=t.measureText(e),i=s.height;this.gy.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const n=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let a=e+this.y;for(let e=0;e<this.my.length;e++)s.fillText(this.my[e],t+this.x,a),a+=this.gy[e];s.textAlign=n,s.textBaseline=r,s.color=i}}class Lh{v;wy=new Map;staffTrackGroup;system;barRenderers=[];x=0;y=0;height=0;index=0;staffIndex=0;isFirstInSystem=!1;trackIndex=0;modelStaff;get staffId(){return this.v.staffId}staveTop=0;topSpacing=0;bottomSpacing=0;staveBottom=0;get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(t,e,s){this.v=s,this.trackIndex=t,this.modelStaff=e}getSharedLayoutData(t,e){return this.wy.has(t)?this.wy.get(t):e}setSharedLayoutData(t,e){this.wy.set(t,e)}get isInsideBracket(){return this.v.isInsideBracket}get isRelevantForBoundsLookup(){return this.v.isRelevantForBoundsLookup}registerStaffTop(t){this.staveTop=t}registerStaffBottom(t){this.staveBottom=t}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t)}addBar(t,e,s){const i=this.v.create(this.system.layout.renderer,t);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),i.registerLayoutingInfo();const n=i.barDisplayWidth;n>0&&this.system.layout.systemsLayoutMode===hh.FromModelWithWidths&&(i.width=n),this.barRenderers.push(i),t&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,t);for(const t of this.barRenderers)t.applyLayoutingInfo();return t}scaleToWidth(t){this.wy=new Map;const e=this.topOverflow;let s=0;switch(this.system.layout.systemsLayoutMode){case hh.Automatic:const i=(t-this.system.computedWidth)/this.barRenderers.length;for(const t of this.barRenderers){t.x=s,t.y=this.topSpacing+e;const n=t.computedWidth+i;t.scaleToWidth(n),s+=t.width}break;case hh.FromModelWithScale:t-=this.system.accoladeWidth;const n=this.system.totalBarDisplayScale;for(const i of this.barRenderers){i.x=s,i.y=this.topSpacing+e;const r=i.barDisplayScale*t/n;i.scaleToWidth(r),s+=i.width}break;case hh.FromModelWithWidths:for(const t of this.barRenderers){t.x=s,t.y=this.topSpacing+e;const i=t.barDisplayWidth;i>0?t.scaleToWidth(i):t.scaleToWidth(t.computedWidth),s+=t.width}}}get topOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const s=this.barRenderers[e];s.topOverflow>t&&(t=s.topOverflow)}return t}get bottomOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const s=this.barRenderers[e];s.bottomOverflow>t&&(t=s.bottomOverflow)}return t}calculateHeightForAccolade(){this.topSpacing=this.v.getStaffPaddingTop(this),this.bottomSpacing=this.v.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this.v.getStaffPaddingTop(this),this.bottomSpacing=this.v.getStaffPaddingBottom(this),this.height=0;let t=!1,e=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+e,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(t=!0);if(t){e=this.topOverflow;for(let t=0;t<this.barRenderers.length;t++)this.barRenderers[t].y=this.topSpacing+e;for(let t=0;t<this.barRenderers.length;t++)this.barRenderers[t].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+e+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(t,e,s,i,n){if(0!==this.height&&0!==n)for(let r=i,a=Math.min(i+n,this.barRenderers.length);r<a;r++)this.barRenderers[r].paint(t+this.x,e+this.y,s)}}class Wh{timePosition=0;longestDuration=0;smallestDuration=0;force=0;springConstant=0;get springWidth(){return this.preSpringWidth+this.postSpringWidth}preBeatWidth=0;graceBeatWidth=0;postSpringWidth=0;get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}allDurations=new Set}class Rh{static yy=30;static ky=7;Sy=[];By=-1;_y=0;xy=new Map;Ty=0;My=Rh.yy;version=0;preBeatSize=0;postBeatSize=0;minStretchForce=0;totalSpringConstant=0;vy(t){this.minStretchForce<t&&(this.minStretchForce=t)}getPreBeatSize(t){if(t.graceType!==u.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].preBeatWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).preBeatWidth:0}getPostBeatSize(t){if(t.graceType!==u.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].postSpringWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).postSpringWidth:0}incompleteGraceRods=new Map;allGraceRods=new Map;springs=new Map;addSpring(t,e,s,i,n){let r;if(this.version++,this.springs.has(t))r=this.springs.get(t),r.postSpringWidth<n&&(r.postSpringWidth=n),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),e<r.smallestDuration&&(r.smallestDuration=e),e>r.longestDuration&&(r.longestDuration=e),r.allDurations.add(e);else{if(r=new Wh,r.timePosition=t,r.allDurations.add(e),this.Sy.length>0){const t=this.Sy[this.Sy.length-1];for(const e of t.allDurations)t.timePosition;e<this.My&&(this.My=e)}r.longestDuration=e,r.postSpringWidth=n,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(t,r);const a=this.Sy;let h=a.length-1;for(;h>0&&a[h].timePosition>t;)h--;this.Sy.splice(h+1,0,r)}return(-1===this.By||this.By>t)&&(this.By=t),r}addBeatSpring(t,e,s){const i=t.absoluteDisplayStart;if(t.graceType!==u.None){const n=t.graceGroup.id;this.allGraceRods.has(n)||this.allGraceRods.set(n,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(n)||this.incompleteGraceRods.set(n,new Array(t.graceGroup.beats.length));const r=this.allGraceRods.get(n)[t.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<e&&(r.preBeatWidth=e);else{const r=new Wh;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=e,t.graceGroup.isComplete||(this.incompleteGraceRods.get(n)[t.graceIndex]=r),this.allGraceRods.get(n)[t.graceIndex]=r}}else{let n=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const e of this.allGraceRods.get(t.graceGroup.id))n+=e.springWidth;this.addSpring(i,t.displayDuration,n,e,s)}}finish(){for(const[t,e]of this.allGraceRods){let t=0;for(const s of e)t+=s.preBeatWidth,s.graceBeatWidth=t,t+=s.postSpringWidth}this.Ty=0;for(const t of this.incompleteGraceRods.values())for(const e of t)this.Ty+=e.preBeatWidth+e.postSpringWidth;this.Ny(),this.version++}Ny(){let t=0;const e=this.Sy;if(0===e.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<e.length;s++){const i=e[s];let n=0;if(s===e.length-1)n=i.longestDuration;else{const t=e[s+1];n=Math.abs(t.timePosition-i.timePosition)}i.springConstant=this.Py(i,n),t+=1/i.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let t=0;t<e.length;t++){const s=e[t];let i=0;if(t===e.length-1)i=s.postSpringWidth;else{const n=e[t+1];i=s.postSpringWidth+n.preSpringWidth}0===t&&(i+=s.preSpringWidth);const n=i*s.springConstant;this.vy(n)}}height=0;paint(t,e,s){}Py(t,e){e<=0&&(e=I.toTicks(l.TwoHundredFiftySixth)),0===t.smallestDuration&&(t.smallestDuration=e);const s=t.smallestDuration,i=this.My,n=Rh.ky;return s/e*(1/((1+.85*Math.log2(e/i))*n))}spaceToForce(t){return-1!==this.totalSpringConstant?(this.Sy.length>0&&(t-=this.Sy[0].preSpringWidth),t-=this.Ty,Math.max(t,0)*this.totalSpringConstant):-1}calculateVoiceWidth(t){let e=0;return-1!==this.totalSpringConstant&&(e=this.Ey(t,this.totalSpringConstant)),this.Sy.length>0&&(e+=this.Sy[0].preSpringWidth),e+=this.Ty,e}Ey(t,e){return t/e}buildOnTimePositions(t){if(-1===this.totalSpringConstant)return new Map;if(Ht.isAlmostEqualTo(this._y,t)&&this.xy)return this.xy;this._y=t;const e=new Map;this.xy=e;const s=this.Sy;if(0===s.length)return e;let i=s[0].preSpringWidth;for(let n=0;n<s.length;n++)e.set(s[n].timePosition,i),i+=this.Ey(t,s[n].springConstant);return e}}class Oh{width=0;isLinkedToPrevious=!1;canWrap=!0;masterBar;additionalMultiBarRestIndexes=null;get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}renderers=[];layoutingInfo}class Ih{track;staffSystem;staves=[];stavesRelevantForBoundsLookup=[];firstStaffInBracket=null;lastStaffInBracket=null;bracket=null;constructor(t,e){this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t),t.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(t)}}class Gh{firstStaffInBracket=null;lastStaffInBracket=null;drawAsBrace=!1;braceScale=1;width=0;index=0;finalizeBracket(t){if(this.firstStaffInBracket===this.lastStaffInBracket)return void(this.width=0);const e=t.glyphHeights.get(at.Brace),s=t.glyphWidths.get(at.Brace);if(this.drawAsBrace?this.width=s:this.width=t.bracketThickness,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;const i=this.firstStaffInBracket.contentTop,n=(this.lastStaffInBracket.contentBottom-i)/e;this.braceScale=n,this.width=s*this.braceScale}}class $h extends Gh{track;constructor(t){super(),this.track=t,this.drawAsBrace=$h.isTrackDrawAsBrace(t)}includesStaff(t){return t.modelStaff.track===this.track}static isTrackDrawAsBrace(t){return t.staves.filter(t=>t.showStandardNotation).length>1}}class Vh extends $h{includesStaff(t){return t.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}class Hh{Cy=[];Fy=null;Ay=null;Dy=!1;Un=[];Ly=!1;x=0;y=0;index=0;accoladeWidth=0;isFull=!1;width=0;computedWidth=0;totalBarDisplayScale=0;isLast=!1;masterBarsRenderers=[];staves=[];layout;topPadding;bottomPadding;constructor(t){this.layout=t,this.topPadding=t.renderer.settings.display.systemPaddingTop,this.bottomPadding=t.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(t,e){if(0===t.length)return null;this.masterBarsRenderers.push(e),e.layoutingInfo.preBeatSize=0;let s=0;for(let t=0,i=this.staves.length;t<i;t++){const i=this.staves[t];for(let t=0,n=i.staves.length;t<n;t++){const n=i.staves[t],r=e.renderers[s++];n.addBarRenderer(r)}}return this.Wy(t),this.Ry(),e}addBars(t,e,s){const i=new Oh;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Rh,i.masterBar=t[0].score.masterBars[e],this.masterBarsRenderers.push(i);const n=i.layoutingInfo;for(const t of this.staves)for(const r of t.staves){const a=t.track.staves[r.modelStaff.index].bars[e],h=null==s?null:s.map(e=>t.track.staves[r.modelStaff.index].bars[e]);r.addBar(a,n,h);const o=r.barRenderers[r.barRenderers.length-1];i.renderers.push(o),o.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),o.canWrap||(i.canWrap=!1)}return this.Wy(t),n.finish(),i.width=this.Ry(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){const t=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let e=0,s=0;for(let t=0,i=this.Cy.length;t<i;t++){const i=this.Cy[t].revertLastBar(),n=i.computedWidth;n>e&&(e=n);const r=i.barDisplayScale;r>s&&(s=r)}return this.width-=e,this.computedWidth-=e,this.totalBarDisplayScale-=s,t}return null}Ry(){let t=0,e=0;for(let s=0,i=this.Cy.length;s<i;s++){const i=this.Cy[s],n=i.barRenderers[i.barRenderers.length-1];n.applyLayoutingInfo(),n.computedWidth>t&&(t=n.computedWidth);const r=n.barDisplayScale;r>e&&(e=r)}return this.width+=t,this.computedWidth+=t,this.totalBarDisplayScale+=e,t}Wy(e){const s=this.layout.renderer.settings;if(!this.Dy){this.Dy=!0,this.accoladeWidth=0;const i=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TrackNames)){const t=1===this.layout.renderer.tracks.length?i.singleTrackTrackNamePolicy:i.multiTrackTrackNamePolicy,n=0===this.index?i.firstSystemTrackNameMode:i.otherSystemsTrackNameMode,r=0===this.index?i.firstSystemTrackNameOrientation:i.otherSystemsTrackNameOrientation;let a=!1;switch(t){case M.Hidden:break;case M.FirstSystem:a=0===this.index;break;case M.AllSystems:a=!0}let h=!1;if(a){const t=this.layout.renderer.canvas,i=s.display.resources.effectFont;t.font=i;for(const s of e){let e="";switch(n){case v.FullName:e=s.name;break;case v.ShortName:e=s.shortName}if(e.length>0){h=!0;const s=t.measureText(e);switch(r){case N.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,s.width));break;case N.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,s.height))}}}h&&(this.accoladeWidth+=s.display.systemLabelPaddingLeft,this.accoladeWidth+=s.display.systemLabelPaddingRight)}}let n=0;for(const t of this.Cy)t.y=n,t.calculateHeightForAccolade(),n+=t.height;let r=0;for(const t of this.Un)t.finalizeBracket(s.display.resources.engravingSettings),r=Math.max(r,t.width);this.accoladeWidth+=r,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}Oy(t){for(let e=0,s=this.staves.length;e<s;e++){const s=this.staves[e];if(s.track===t)return s}return null}addStaff(t,e){let s=this.Oy(t);if(s||(s=new Ih(this,t),this.staves.push(s)),e.staffTrackGroup=s,e.system=this,e.index=this.Cy.length,this.Cy.push(e),s.addStaff(e),e.isInsideBracket){this.Fy||(this.Fy=e,e.isFirstInSystem=!0),s.firstStaffInBracket||(s.firstStaffInBracket=e),this.Ay=e,s.lastStaffInBracket=e;let i=this.Un.find(t=>t.includesStaff(e));if(!i)switch(t.score.stylesheet.bracketExtendMode){case T.NoBrackets:break;case T.GroupStaves:i=new $h(t),i.index=this.Un.length,this.Un.push(i);break;case T.GroupSimilarInstruments:i=new Vh(t),i.index=this.Un.length,this.Un.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=e),i.lastStaffInBracket=e,s.bracket=i)}}get height(){return 0===this.Cy.length?0:Math.ceil(this.Cy[this.Cy.length-1].y+this.Cy[this.Cy.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(t){for(let e=0,s=this.Cy.length;e<s;e++)this.Cy[e].scaleToWidth(t);this.width=t}paint(t,e,s){if(this.paintPartial(t+this.x,e+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this.Ly){const i=kh.track(s,Ct.SystemSeparator,this.Cy[0].modelStaff.track);try{const i=this.layout.renderer.settings.display.resources.engravingSettings,n=Math.min(0,i.glyphBottom.get(at.SystemDivider)??0);Lt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height+n,1,at.SystemDivider,!1),Lt.fillMusicFontSymbolSafe(s,t+this.x+this.width-i.glyphWidths.get(at.SystemDivider),e+this.y+this.height+n,1,at.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(e,s,i,n,r){for(let t=0,a=this.Cy.length;t<a;t++)this.Cy[t].paint(e,s,i,n,r);const a=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===n){i.color=a.barSeparatorColor;const n=this.layout.renderer.settings,r=this.layout.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TrackNames);if(i.font=a.effectFont,r){const t=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?t.singleTrackTrackNamePolicy:t.multiTrackTrackNamePolicy,a=0===this.index?t.firstSystemTrackNameMode:t.otherSystemsTrackNameMode,h=0===this.index?t.firstSystemTrackNameOrientation:t.otherSystemsTrackNameOrientation;let o=!1;switch(r){case M.Hidden:break;case M.FirstSystem:o=0===this.index;break;case M.AllSystems:o=!0}if(o){const t=i.textBaseline,r=i.textAlign;for(const t of this.staves)if(t.firstStaffInBracket&&t.lastStaffInBracket){const r=s+t.firstStaffInBracket.contentTop,o=s+t.lastStaffInBracket.contentBottom;let c="";switch(a){case v.FullName:c=t.track.name;break;case v.ShortName:c=t.track.shortName}const l=kh.track(i,Ct.TrackName,t.track);try{if(c.length>0){const s=e+t.firstStaffInBracket.x-n.display.accoladeBarPaddingRight-(t.bracket?.width??0)-n.display.systemLabelPaddingRight;switch(h){case N.Horizontal:i.textBaseline=it.Middle,i.textAlign=st.Right,i.fillText(c,s,(r+o)/2);break;case N.Vertical:i.textBaseline=it.Bottom,i.textAlign=st.Center;const t=.1;i.beginRotate(s,(r+o)/2,-90-t),i.fillText(c,0,0),i.endRotate()}}}finally{l?.[Symbol.dispose]?.()}}i.textBaseline=t,i.textAlign=r}}if(this.Cy.length>0){let t=null;for(const n of this.Cy)if(n.isInsideBracket){if(null!==t){const r=t.contentBottom,h=n.contentTop,o=e+t.x,c=t.barRenderers[0],l=kh.bar(i,c.staffLineBarSubElement,c.bar);try{const t=Math.ceil(h-r);i.fillRect(o,s+r,a.engravingSettings.thinBarlineThickness,t)}finally{l?.[Symbol.dispose]?.()}}t=n}}for(const t of this.Un)if(t.firstStaffInBracket&&t.lastStaffInBracket){const r=e+t.firstStaffInBracket.x,a=t.width,h=n.display.accoladeBarPaddingRight;let o=s+t.firstStaffInBracket.contentTop,c=s+t.lastStaffInBracket.contentBottom;if(t.drawAsBrace)Lt.fillMusicFontSymbolSafe(i,r-h-a,c,t.braceScale,at.Brace);else if(t.firstStaffInBracket!==t.lastStaffInBracket){const t=a/2;o-=t,c+=2*t,i.fillRect(r-h-a,o,a,Math.ceil(c-o));const e=r-h-a;Lt.fillMusicFontSymbolSafe(i,e,o,1,at.BracketTop),Lt.fillMusicFontSymbolSafe(i,e,Math.floor(c),1,at.BracketBottom)}}}}finalizeSystem(){const t=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=t.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=t.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const e=t.display.resources.engravingSettings.glyphHeights.get(at.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,e),this.Ly=!0}let e=0;for(const t of this.Cy)t.x=this.accoladeWidth,t.y=e,t.finalizeStaff(),e+=t.height;for(const e of this.Un)e.finalizeBracket(t.display.resources.engravingSettings)}buildBoundingsLookup(t,e){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this.Fy,i=this.Ay;if(!s||!i)return;e+=this.topPadding;const n=this.Cy[this.Cy.length-1],r=e+this.y+s.y,a=e+this.y+i.y+i.height,h=e+this.y+this.Cy[0].y,o=e+this.y+n.y+n.height,c=e+this.y+s.y+s.topSpacing+s.topOverflow+(s.barRenderers.length>0?s.barRenderers[0].topPadding:0),l=a-r,u=e+this.y+n.y+n.height-n.bottomSpacing-n.bottomOverflow-(n.barRenderers.length>0?n.barRenderers[0].bottomPadding:0)-c,d=o-h,f=this.x+s.x,p=new Fe;p.visualBounds=new Pe,p.visualBounds.x=t+this.x,p.visualBounds.y=e+this.y,p.visualBounds.w=this.width,p.visualBounds.h=this.height-this.topPadding-this.bottomPadding,p.realBounds=new Pe,p.realBounds.x=t+this.x,p.realBounds.y=e+this.y,p.realBounds.w=this.width,p.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(p);const b=new Map;for(let t=0;t<this.staves.length;t++)for(const s of this.staves[t].stavesRelevantForBoundsLookup)for(const t of s.barRenderers){let i;b.has(t.bar.masterBar.index)?i=b.get(t.bar.masterBar.index):(i=new Ee,i.index=t.bar.masterBar.index,i.isFirstOfLine=t.isFirstOfLine,i.realBounds=new Pe,i.realBounds.x=f+t.x,i.realBounds.y=h,i.realBounds.w=t.width,i.realBounds.h=d,i.visualBounds=new Pe,i.visualBounds.x=f+t.x,i.visualBounds.y=r,i.visualBounds.w=t.width,i.visualBounds.h=l,i.lineAlignedBounds=new Pe,i.lineAlignedBounds.x=f+t.x,i.lineAlignedBounds.y=c,i.lineAlignedBounds.w=t.width,i.lineAlignedBounds.h=u,this.layout.renderer.boundsLookup.addMasterBar(i),b.set(i.index,i)),t.buildBoundingsLookup(i,f,e+this.y+s.y)}}getBarX(t){if(!this.Fy||0===this.layout.renderer.tracks.length)return 0;const e=this.layout.renderer.tracks[0].staves[0].bars[t];return this.layout.getRendererForBar(this.Fy.staffId,e).x}}class Uh extends Fh{constructor(t,e){super(t,e,st.Left)}}class zh extends wh{Iy;Gy;colorOverride;constructor(t,e,s,i){super(t,e),this.Iy=s,this.Gy=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.$y(this.Iy);for(const t of this.glyphs)t.renderer=this.renderer,t.doLayout()}}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(t,e,s),s.color=i}$y(t){const e=this.renderer.resources;if(this.height=0,this.Gy.length>0){const t=new Dh(0,this.height,this.Gy,e.effectFont,st.Left);t.renderer=this.renderer,t.doLayout(),this.height+=t.height,this.addGlyph(t)}if(t.name.length>0){const s=new Dh(0,this.height,t.name,e.effectFont,st.Left);s.renderer=this.renderer,s.doLayout(),this.height+=s.height,this.addGlyph(s)}const s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(at.GuitarString0)*s;this.renderer.scoreRenderer.canvas.font=e.effectFont;const n=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*e.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this.Gy).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(t.name).width,2*n)),!t.isStandard){const r=0|Math.ceil(t.tunings.length/2);let a=0;const h=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let o=h;for(let c=0,l=t.tunings.length;c<l;c++){const l=at.GuitarString0+(c+1);this.addGlyph(new Pa(a,o+i,s,l));const u=` = ${ye.getTextForTuning(t.tunings[c],!1)}`;this.addGlyph(new Dh(a+i,o+i/2,u,e.effectFont,st.Left,it.Middle)),o+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const d=o;this.height<d&&(this.height=d),c===r-1&&(o=h,a+=n)}}}}class jh{args;renderCallback;constructor(t,e){this.args=t,this.renderCallback=e}}!function(t){t[t.Automatic=0]="Automatic",t[t.FromModelWithScale=1]="FromModelWithScale",t[t.FromModelWithWidths=2]="FromModelWithWidths"}(hh||(hh={}));class Xh{Vy=new Map;pagePadding=null;renderer;width=0;height=0;multiBarRestInfo=null;get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}headerGlyphs=new Map;footerGlyphs=new Map;chordDiagrams=null;tuningGlyph=null;systemsLayoutMode=hh.Automatic;constructor(t){this.renderer=t}resize(){this.Hy.clear(),this.doResize()}layoutAndRender(){this.Hy.clear();const t=this.renderer.score;this.firstBarIndex=Ht.computeFirstDisplayedBarIndex(t,this.renderer.settings),this.lastBarIndex=Ht.computeLastDisplayedBarIndex(t,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=Ht.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(t=>t/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.Uy(),this.doLayoutAndRender()}Hy=new Map;registerPartial(t,e){if(0===t.height)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this.Hy.set(t.id,new jh(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this.zy(t,e))}zy(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this.Hy.has(t)){const e=this.Hy.get(t);this.zy(e.args,e.renderCallback)}}static headerElements=new U(()=>new Map([[nt.Title,t.NotationElement.ScoreTitle],[nt.SubTitle,t.NotationElement.ScoreSubTitle],[nt.Artist,t.NotationElement.ScoreArtist],[nt.Album,t.NotationElement.ScoreAlbum],[nt.Words,t.NotationElement.ScoreWords],[nt.Music,t.NotationElement.ScoreMusic],[nt.WordsAndMusic,t.NotationElement.ScoreWordsAndMusic],[nt.Transcriber,void 0]]));static footerElements=new U(()=>new Map([[nt.Copyright,t.NotationElement.ScoreCopyright],[nt.CopyrightSecondLine,void 0]]));jy(t,e,s,i){switch(s){case nt.WordsAndMusic:if(e.words!==e.music)return;break;case nt.Words:case nt.Music:if(e.words===e.music)return;break;case nt.CopyrightSecondLine:if(!this.footerGlyphs.has(nt.Copyright))return}const n=t.display.resources,r=t.notation,a=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):Rt.defaultHeaderAndFooter.get(s);let h=void 0===a.isVisible||a.isVisible;if(void 0!==i&&(h=r.isNotationElementVisible(i)),!h)return;const o=a.buildText(e);return o?new Dh(0,0,o,n.getFontForElement(s),a.textAlign,void 0,kh.scoreColor(n,s,e)):void 0}Uy(){j.debug("ScoreLayout","Creating score info glyphs");const e=this.renderer.settings,s=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const i=new Zh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[t,n]of Xh.headerElements.value){const r=this.jy(e,s,t,n);r&&(r.renderer=i,r.doLayout(),this.headerGlyphs.set(t,r))}for(const[t,n]of Xh.footerElements.value){const r=this.jy(e,s,t,n);r&&(r.renderer=i,r.doLayout(),this.footerGlyphs.set(t,r))}const n=e.notation,r=e.display.resources;if(n.isNotationElementVisible(t.NotationElement.GuitarTuning)){const t=[];for(const e of this.renderer.tracks)for(const i of e.staves){let n=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(s.stylesheet.perTrackDisplayTuning&&s.stylesheet.perTrackDisplayTuning.has(e.index)&&!1===s.stylesheet.perTrackDisplayTuning.get(e.index)&&(n=!1),n){t.push(i);break}}if(t.length>0&&s.stylesheet.globalDisplayTuning){this.tuningGlyph=new Uh(0,0),this.tuningGlyph.renderer=i;for(const e of t)if(e.stringTuning.tunings.length>0){const s=t.length>1?e.track.name:"",n=new zh(0,0,e.stringTuning,s);n.colorOverride=kh.trackColor(r,Ct.StringTuning,e.track),n.renderer=i,n.doLayout(),this.tuningGlyph.addGlyph(n)}}else this.tuningGlyph=null}if(n.isNotationElementVisible(t.NotationElement.ChordDiagrams)){this.chordDiagrams=new Ah(0,0),this.chordDiagrams.renderer=i;const t=new Set;for(const e of this.renderer.tracks){if(s.stylesheet.globalDisplayChordDiagramsOnTop&&(null==s.stylesheet.perTrackChordDiagramsOnTop||!s.stylesheet.perTrackChordDiagramsOnTop.has(e.index)||s.stylesheet.perTrackChordDiagramsOnTop.get(e.index)))for(const s of e.staves){const e=s.chords;if(e)for(const[,s]of e)t.has(s.uniqueId)||s.showDiagram&&(t.add(s.uniqueId),this.chordDiagrams.addChord(s))}}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}firstBarIndex=0;lastBarIndex=0;createEmptyStaffSystem(){const t=new Hh(this);for(let e=0;e<this.renderer.tracks.length;e++){const s=this.renderer.tracks[e];for(let i=0;i<s.staves.length;i++){const n=s.staves[i],r=eu.staveProfiles.get(this.renderer.settings.display.staveProfile);for(const i of r)i.canCreate(s,n)&&t.addStaff(s,new Lh(e,n,i))}}return t}registerBarRenderer(t,e){if(this.Vy.has(t)||this.Vy.set(t,new Map),this.Vy.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this.Vy.get(t).set(s.id,e)}unregisterBarRenderer(t,e){if(this.Vy.has(t)){const s=this.Vy.get(t);if(s.delete(e.bar.id),e.additionalMultiRestBars)for(const t of e.additionalMultiRestBars)s.delete(t.id)}}getRendererForBar(t,e){const s=e.id;return this.Vy.has(t)&&this.Vy.get(t).has(s)?this.Vy.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new xe;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,n=[];let r=0;for(const[t,e]of Xh.footerElements.value)if(this.footerGlyphs.has(t)){const e=this.footerGlyphs.get(t);e.y=s,this.alignScoreInfoGlyph(e),s+=e.height,n.push(e),r=Math.max(r,Math.round(e.x+e.width))}return s=Math.round(s),n.length>0&&(e.width=r,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,t=>{t.color=i.scoreInfoColor,t.textAlign=st.Left,t.textBaseline=it.Top;for(const e of n)e.paint(0,0,t)})),t+s}alignScoreInfoGlyph(t){if(eu.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case st.Left:t.x=this.pagePadding[0];break;case st.Center:t.x=this.scaledWidth/2;break;case st.Right:t.x=this.scaledWidth-this.pagePadding[2]}else t.x=this.firstBarX,t.textAlign=st.Left}layoutAndRenderAnnotation(t){const e=this.renderer.settings.display.resources,s=cr.withFamilyList(e.copyrightFont.families,12,us.Plain,ds.Bold),i=new Zh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),n=new Dh(0,0,"rendered by alphaTab",s,st.Center,void 0,e.mainGlyphColor);n.renderer=i,n.doLayout(),this.alignScoreInfoGlyph(n);const r=new xe;return r.width=n.x+n.width,r.x=0,r.height=12,r.y=t,r.totalWidth=this.scaledWidth,r.totalHeight=t+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,t=>{t.color=e.mainGlyphColor,t.font=s,t.textAlign=st.Left,t.textBaseline=it.Top,n.paint(0,0,t)}),t+12}}class Jh extends wh{Xy=[];Jy=[];container;computedWidth=0;constructor(){super(0,0)}doLayout(){let t=0;if(this.glyphs)for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.x=t,s.renderer=this.renderer,s.doLayout(),t+=s.width}this.width=t,this.computedWidth=t}noteLoop(t){for(let e=this.container.beat.notes.length-1;e>=0;e--)t(this.container.beat.notes[e])}addEffect(t){super.addGlyph(t),this.Xy.push(t)}addNormal(t){super.addGlyph(t),this.Jy.push(t)}get effectElement(){}paint(t,e,s){this.qy(t,e,s),this.Yy(t,e,s)}Yy(t,e,s){for(const i of this.Jy)i.paint(t+this.x,e+this.y,s)}qy(t,e,s){const i=this.effectElement?kh.beat(s,this.effectElement,this.container.beat):void 0;try{for(const i of this.Xy)i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class qh extends Jh{beamingHelper;centerX=0;updateBeamingHelper(){}buildBoundingsLookup(t,e,s){}getNoteX(t,e){return 0}getNoteY(t,e){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}}class Yh extends va{Pw=0;Ky;Qy=[];constructor(t,e,s,i,n=1){super(t,e),this.Qy=Yh.getSymbols(s),this.Pw=n,this.Ky=i}static getSymbols(t){const e=[];for(;t>0;){const s=t%10;e.unshift(Yh.getSymbol(s)),t=t/10|0}return e}static getSymbol(t){switch(t){case 0:return at.TimeSig0;case 1:return at.TimeSig1;case 2:return at.TimeSig2;case 3:return at.TimeSig3;case 4:return at.TimeSig4;case 5:return at.TimeSig5;case 6:return at.TimeSig6;case 7:return at.TimeSig7;case 8:return at.TimeSig8;case 9:return at.TimeSig9;default:return at.None}}doLayout(){let t=0;for(const e of this.Qy)t+=this.renderer.smuflMetrics.glyphWidths.get(e);this.width=t}paint(t,e,s){switch(this.Ky){case it.Top:e+=this.renderer.smuflMetrics.glyphBottom.get(this.Qy[0]);break;case it.Bottom:e+=this.renderer.smuflMetrics.glyphTop.get(this.Qy[0])}s.fillMusicFontSymbols(t+this.x,e+this.y,this.Pw,this.Qy)}}class Kh extends va{static Zy=[at.RestHBarLeft,at.RestHBarMiddle,at.RestHBarMiddle,at.RestHBarMiddle,at.RestHBarRight];tk=[];constructor(){super(0,0)}doLayout(){this.width=Kh.Zy.reduce((t,e)=>t+this.renderer.smuflMetrics.glyphWidths.get(e),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));const t=this.renderer.additionalMultiRestBars.length+1;this.tk=Yh.getSymbols(t)}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.renderer.height/2,1,Kh.Zy);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(t+this.x+this.width/2,e+this.y+i|0,1,this.tk,!0)}}class Qh extends Aa{constructor(t){super(Qh.ek(t),t),this.preNotes=new Jh,this.onNotes=new qh}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new Kh),super.doLayout()}static ek(t){if(t.voice.beats.length>1)return t.voice.beats[0];const e=new Kt;return e.voice=t.voice,e}}!function(t){t[t.TopWithStem=0]="TopWithStem",t[t.Top=1]="Top",t[t.Center=2]="Center",t[t.Bottom=3]="Bottom",t[t.BottomWithStem=4]="BottomWithStem",t[t.StemUp=5]="StemUp",t[t.StemDown=6]="StemDown"}(oh||(oh={})),function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(ch||(ch={}));class Zh{sk=new yh;ik=new Map;nk=new yh;rk=[];get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}scoreRenderer;staff;layoutingInfo;bar;additionalMultiRestBars=null;get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}x=0;y=0;width=0;computedWidth=0;height=0;index=0;topOverflow=0;bottomOverflow=0;helpers;isLinkedToPrevious=!1;canWrap=!0;get showMultiBarRest(){return!1}constructor(t,e){this.scoreRenderer=t,this.bar=e,e&&(this.helpers=new Ph(this))}registerTies(t){this.rk.push(...t)}get middleYPosition(){return 0}registerOverflowTop(t){return(t=Math.ceil(t))>this.topOverflow&&(this.topOverflow=t,!0)}registerOverflowBottom(t){return(t=Math.ceil(t))>this.bottomOverflow&&(this.bottomOverflow=t,!0)}scaleToWidth(t){const e=t-this.sk.width-this.nk.width;for(const t of this.ik.values())t.scaleToWidth(e);this.nk.x=this.sk.x+this.sk.width+e,this.width=t}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}wasFirstOfLine=!1;get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){const t=this.layoutingInfo,e=this.sk.width;t.preBeatSize<e&&(t.preBeatSize=e);for(const e of this.ik.values())e.registerLayoutingInfo(t),e.x,e.width;const s=this.nk.width;t.postBeatSize<s&&(t.postBeatSize=s)}ak=0;applyLayoutingInfo(){if(this.ak>=this.layoutingInfo.version)return!1;this.ak=this.layoutingInfo.version,this.sk.width=this.layoutingInfo.preBeatSize;let t=this.sk.x+this.sk.width;for(const e of this.ik.values()){e.x=this.sk.x+this.sk.width,e.applyLayoutingInfo(this.layoutingInfo);const s=e.x+e.width;t<s&&(t=s)}this.nk.x=Math.floor(t),this.nk.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this.nk.x+this.nk.width),this.computedWidth=this.width;const e=this.barDisplayWidth;return e>0&&this.scoreRenderer.layout.systemsLayoutMode===hh.FromModelWithWidths&&(this.width=e,this.computedWidth=e),!0}isFinalized=!1;finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const i of this.rk)if(i.doLayout(),i.height>0){const n=i.y+i.height-s;n>0&&this.registerOverflowBottom(n)&&(t=!0);const r=i.y-e;r<0&&this.registerOverflowTop(-1*r)&&(t=!0)}return t}topPadding=0;bottomPadding=0;doLayout(){if(!this.bar)return;this.helpers.initialize(),this.rk=[],this.sk=new yh,this.sk.renderer=this,this.ik.clear(),this.nk=new yh,this.nk.renderer=this;for(let t=0;t<this.bar.voices.length;t++){const e=this.bar.voices[t];if(this.hasVoiceContainer(e)){const s=new Bh(0,0,e);s.renderer=this,this.ik.set(this.bar.voices[t].index,s)}}if(this.bar.simileMark===E.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){const t=new Qh(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(t)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width;const t=this.height,e=this.sk.glyphs;if(e)for(const s of e){const e=s.getBoundingBoxTop();e<0&&this.registerOverflowTop(-1*e);const i=e+s.height;i>t&&this.registerOverflowBottom(i-t)}const s=this.nk.glyphs;if(s)for(const e of s){const s=e.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=s+e.height;i>t&&this.registerOverflowBottom(i-t)}}hasVoiceContainer(t){return!(!this.additionalMultiRestBars&&0!==t.index)||!t.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);const t=this.ik,e=this.beatGlyphsStart;let s=e;for(const i of t.values()){i.x=e,i.doLayout();const t=i.x+i.width;s<t&&(s=t)}this.nk.x=Math.floor(s),this.width=Math.ceil(this.nk.x+this.nk.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(t){t.renderer=this,this.sk.addGlyph(t)}addBeatGlyph(t){t.renderer=this,t.preNotes.renderer=this,t.onNotes.renderer=this,t.onNotes.beamingHelper=this.helpers.beamHelperLookup[t.beat.voice.index].get(t.beat.index),this.getVoiceContainer(t.beat.voice).addGlyph(t)}getVoiceContainer(t){return this.ik.has(t.index)?this.ik.get(t.index):void 0}getBeatContainer(t){return this.getVoiceContainer(t.voice)?.beatGlyphs?.[t.index]}getPreNotesGlyphForBeat(t){return this.getBeatContainer(t)?.preNotes}getOnNotesGlyphForBeat(t){return this.getBeatContainer(t)?.onNotes}paint(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this.sk.paint(t+this.x,e+this.y,s);for(const i of this.ik.values())i.paint(t+this.x,e+this.y,s);s.color=this.resources.mainGlyphColor,this.nk.paint(t+this.x,e+this.y,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this.sk.x+this.sk.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new ve;i.bar=this.bar,i.visualBounds=new Pe,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new Pe,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i);for(const[t,n]of this.ik){const r=this.bar.isEmpty&&0===t;if(!n.voice.isEmpty||r)for(let t=0,a=n.beatGlyphs.length;t<a;t++){n.beatGlyphs[t].buildBoundingsLookup(i,e+this.x+n.x,s+this.y+n.y,r)}}}addPostBeatGlyph(t){this.nk.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const t of this.bar.voices)this.hasVoiceContainer(t)&&this.createVoiceGlyphs(t)}createVoiceGlyphs(t){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this.sk.x+this.sk.width}get postBeatGlyphsStart(){return this.nk.x}getBeatX(t,e=ah.PreNotes){const s=this.getBeatContainer(t);if(s)switch(e){case ah.PreNotes:return s.voiceContainer.x+s.x;case ah.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case ah.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case ah.Stem:const e=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(t):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+e;case ah.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case ah.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],ah.OnNotes);return e+(this.postBeatGlyphsStart-e)*t}getNoteX(t,e){const s=this.getBeatContainer(t.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(t,e):0}getNoteY(t,e){const s=this.getOnNotesGlyphForBeat(t.beat);return s?s.getNoteY(t,e):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this.sk=new yh,this.sk.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){const i=kh.voice(s,W.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case E.Simple:s.beginGroup(Aa.getGroupId(this.bar.voices[0].beats[0])),Lt.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+this.height/2,1,at.Repeat1Bar,!0),s.endGroup();break;case E.SecondOfDouble:s.beginGroup(Aa.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Aa.getGroupId(this.bar.previousBar.voices[0].beats[0])),Lt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height/2,1,at.Repeat2Bars,!0),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(t){}getBeatDirection(t){return this.helpers.getBeamingHelperForBeat(t).direction}}!function(t){t[t.SinglePreBeat=0]="SinglePreBeat",t[t.SingleOnBeat=1]="SingleOnBeat",t[t.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",t[t.GroupedOnBeat=3]="GroupedOnBeat",t[t.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",t[t.FullBar=5]="FullBar"}(lh||(lh={}));class to extends va{hk=[];Xy=[];isEmpty=!0;previousBand=null;isLinkedToPrevious=!1;firstBeat=null;lastBeat=null;height=0;originalHeight=0;voice;info;slot=null;constructor(t,e){super(0,0),this.voice=t,this.info=e}doLayout(){super.doLayout();for(let t=0;t<this.renderer.bar.voices.length;t++)this.Xy.push(new Map),this.hk.push([])}createGlyph(t){if(t.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,t)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!t.isBefore(this.firstBeat)||(this.firstBeat=t),!this.lastBeat||t.isAfter(this.lastBeat))switch(this.lastBeat=t,this.info.sizingMode){case lh.SingleOnBeatToEnd:case lh.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const e=this.ck(this.info.sizingMode,t);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}ck(t,e){let s;switch(t){case lh.FullBar:case lh.SinglePreBeat:case lh.SingleOnBeat:case lh.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,e),s.renderer=this.renderer,s.beat=e,s.doLayout(),this.Xy[e.voice.index].set(e.index,s),this.hk[e.voice.index].push(s),s;case lh.GroupedOnBeat:case lh.GroupedOnBeatToEnd:const i=t===lh.GroupedOnBeat?lh.SingleOnBeat:lh.SingleOnBeatToEnd;if(e.index>0||this.renderer.index>0){const t=e.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,t)){let s=null;if(e.index>0&&this.Xy[e.voice.index].has(t.index))s=this.Xy[e.voice.index].get(t.index);else if(this.renderer.index>0){const e=this.renderer.previousRenderer.getBand(t.voice,this.info.effectId);if(e){const i=e.Xy[t.voice.index];i.has(t.index)&&(s=i.get(t.index))}}const n=this.ck(i,e);return s&&this.info.canExpand(t,e)&&(s.nextGlyph=n,n.previousGlyph=s,this.isLinkedToPrevious=!0),n}return this.ck(i,e)}return this.ck(i,e);default:return this.ck(lh.SingleOnBeat,e)}}paint(t,e,s){super.paint(t,e,s);for(let i=0,n=this.hk.length;i<n;i++){const n=this.hk[i];for(let i=0,r=n.length;i<r;i++){const r=n[i],a=kh.beat(s,yt.Effects,r.beat,!1);try{r.paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let t=0;t<this.Xy.length;t++)for(const e of this.Xy[t].keys())this.lk(this.info.sizingMode,this.renderer.bar.voices[t].beats[e])}lk(t,e){const s=this.Xy[e.voice.index].get(e.index),i=this.renderer.getBeatContainer(e);switch(t){case lh.SinglePreBeat:const t=this.renderer.layoutingInfo.getPreBeatSize(e);s.x=this.renderer.beatGlyphsStart+i.x-t;break;case lh.SingleOnBeat:case lh.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x;break;case lh.SingleOnBeatToEnd:case lh.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{const t=this.renderer.layoutingInfo.getPostBeatSize(e);s.width=t}break;case lh.FullBar:s.width=this.renderer.width}}}class eo{uniqueEffectId=null;y=0;height=0;firstBeat=null;lastBeat=null}class so{bands;shared;constructor(){this.bands=[],this.shared=new eo}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),this.shared.firstBeat&&!t.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=t.firstBeat),this.shared.lastBeat&&!t.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return(!this.shared.uniqueEffectId&&t.info.canShareBand||t.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(t.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class io{uk;slots;constructor(){this.slots=[],this.uk=new Map}getOrCreateSlot(t){if(this.uk.has(t.info.effectId)){const e=this.uk.get(t.info.effectId);if(e.canBeUsed(t))return e}for(const e of this.slots)if(e.canBeUsed(t))return e;const e=new so;return this.slots.push(e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this.uk.set(t.info.effectId,e)}}class no extends Zh{dk;fk=[];pk=new Map;sizingInfo=null;constructor(t,e,s){super(t,e),this.dk=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.bk(),super.updateSizes()}finalizeRenderer(){let t=super.finalizeRenderer();return this.bk()&&(t=!0),t}bk(){if(!this.sizingInfo)return!1;let t=0;for(const e of this.sizingInfo.slots){e.shared.y=t;for(const s of e.bands)s.y=t,s.height=e.shared.height;t+=e.shared.height+this.settings.display.effectBandPaddingBottom}return t=Math.ceil(t),t!==this.height&&(this.height=t,!0)}applyLayoutingInfo(){const t=!super.applyLayoutingInfo();if(this.index>0){const t=this.previousRenderer;this.sizingInfo=t.sizingInfo}else this.sizingInfo=new io;for(const t of this.fk)t.resetHeight(),t.alignGlyphs(),t.isEmpty||this.sizingInfo.register(t);return this.bk(),t}scaleToWidth(t){super.scaleToWidth(t);for(const t of this.fk)t.alignGlyphs()}createBeatGlyphs(){this.fk=[],this.pk=new Map;for(const t of this.bar.voices)if(this.hasVoiceContainer(t))for(const e of this.dk){const s=new to(t,e);s.renderer=this,s.doLayout(),this.fk.push(s),this.pk.set(`${t.index}.${e.effectId}`,s)}super.createBeatGlyphs();for(const t of this.fk)t.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){for(const e of t.beats){const s=new Aa(e,this.getVoiceContainer(t));s.preNotes=new Jh,s.onNotes=new qh,this.addBeatGlyph(s);for(const t of this.fk)t.createGlyph(e)}}paint(t,e,s){this.paintBackground(t,e,s);for(const i of this.fk)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(t+this.x,e+this.y,s)}getBand(t,e){const s=`${t.index}.${e}`;return this.pk.has(s)?this.pk.get(s):null}}class ro extends gh{infos;mk;get staffId(){return this.mk}shouldShow;getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(t,e,s=null){super(),this.infos=e,this.mk=t,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(t,e){const s=this.shouldShow;return super.canCreate(t,e)&&(!s||s(t,e))}create(t,e){return new no(t,e,this.infos.filter(e=>t.settings.notation.isNotationElementVisible(e.notationElement)))}}class ao extends Na{gk;wk="";yk;kk;Sn;constructor(t,e,s,i,n,r){super(t,e),this.gk=Ht.getAlternateEndingsList(s),this.yk=i,this.kk=n,this.Sn=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let t="";for(let e=0,s=this.gk.length;e<s;e++)t+=this.gk[e]+1,t+=". ";this.wk=t}paint(t,e,s){let i=this.kk?this.width-s.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===L.LightHeavy&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),t=(0|t)+s.lineWidth/2,e=(0|e)+s.lineWidth/2,this.Sn&&(t+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this.yk?(s.moveTo(t+this.x,e+this.y+this.height),s.lineTo(t+this.x,e+this.y)):s.moveTo(t+this.x,e+this.y),s.lineTo(t+this.x+i,e+this.y),this.kk&&s.lineTo(t+this.x+i,e+this.y+this.height),s.stroke(),this.yk){const i=s.textBaseline;s.textBaseline=it.Top;const n=this.renderer.resources;s.font=n.wordsFont,s.fillText(this.wk,t+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,e+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=i}}}class ho{get effectId(){return this.notationElement.toString()}}class oo extends ho{get notationElement(){return t.NotationElement.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return lh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&0!==e.voice.bar.masterBar.alternateEndings}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let n=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(t=>t.index>=s.index)||(n=!1);const r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new ao(0,0,s.alternateEndings,i,n,r)}canExpand(t,e){return!0}}class co extends Na{endPosition;forceGroupedRendering=!1;endOnBarLine=!1;constructor(t){super(),this.endPosition=t}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(t,e,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(t,e,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const n=i.renderer,r=i.beat,a=this.endPosition,h=t-this.renderer.x,o=this.calculateEndX(n,r,h,a);this.paintGrouped(t,e,o,s)}calculateEndX(t,e,s,i){return e?s+t.x+t.getBeatX(e,i):s+t.x+this.x+this.width}paintNonGrouped(t,e,s){const i=t-this.renderer.x,n=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(t,e,n,s)}}class lo extends co{Sk;Bk;_k=0;constructor(t,e=!0){super(ah.OnNotes),this.Sk=t,this.Bk=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=ah.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;const t=this.renderer.scoreRenderer.canvas.measureText(this.Sk);this.height=t.height,this._k=t.width}paintNonGrouped(t,e,s){const i=this.renderer.resources;s.font=i.effectFont;const n=s.textBaseline;s.textBaseline=it.Middle,s.fillText(this.Sk,t+this.x-this._k/2,e+this.y+this.height/2),s.textBaseline=n}paintGrouped(t,e,s,i){this.paintNonGrouped(t,e,i);const n=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,a=this.renderer.smuflMetrics.pedalLineThickness,h=t+this.x+this._k/2+n/2,o=e+this.y+this.height/2-a/2;if(this.Bk){if(s>h){let t=h;for(;t<s;){const e=Math.min(t+r,s);i.fillRect(t,o,e-t,a),t+=r+n}i.fillRect(s,o-r/2+a/2,a,r)}}else i.fillRect(h,o,s-h,a),i.fillRect(s-a,o,a,r/2)}}class uo extends ho{get notationElement(){return t.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){let s="";switch(e.barreShape){case mt.None:case mt.Full:break;case mt.Half:s+="1/2"}return s+=`B ${uo.toRoman(e.barreFret)}`,new lo(s,!1)}static xk=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);static toRoman(t){let e="";if(t>0)for(const[s,i]of uo.xk){const n=Math.floor(t/i);t-=n*i,e+=s.repeat(n)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}}class fo extends Na{u;Tk="";Mk=0;vk=0;constructor(t){super(0,0),this.u=t}doLayout(){const t=this.u/6e4|0,e=(this.u-6e4*t)/1e3|0;this.Tk=`${t}:${e.toString().padStart(2,"0")}`;const s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.timerFont;const i=s.measureText(this.Tk);this.vk=s.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this.Mk=i.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this.vk+2*this.renderer.smuflMetrics.beatTimerPadding}paint(t,e,s){const i=this.Mk/2|0;s.strokeRect(t+this.x-i,e+this.y+this.renderer.smuflMetrics.beatTimerPadding,this.Mk,this.vk);const n=s.font,r=s.textBaseline,a=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=it.Middle,s.textAlign=st.Center,s.fillText(this.Tk,t+this.x,e+this.y+this.height/2),s.font=n,s.textBaseline=r,s.textAlign=a}}class po extends ho{get notationElement(){return t.NotationElement.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new fo(e.timer??0)}canExpand(t,e){return!0}}class bo extends ho{get notationElement(){return t.NotationElement.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.index&&0===e.voice.bar.index&&0!==e.voice.bar.staff.capo}createNewGlyph(t,e){return new Dh(0,0,`Capo. fret ${e.voice.bar.staff.capo}`,t.resources.effectFont,st.Left)}canExpand(t,e){return!1}}class mo extends ho{get notationElement(){return t.NotationElement.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(t,e){return new Dh(0,0,e.chord.name,t.resources.effectFont,st.Center)}canExpand(t,e){return!1}}class go extends co{Fn;constructor(t,e,s){super(ah.EndBeat),this.Fn=c.None,this.Fn=s,this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.DynamicCrescendoHairpin)}paintGrouped(t,e,s,i){const n=t+this.x,r=this.height,a=this.renderer.smuflMetrics.glyphWidths.get(at.NoteheadBlack)/2;i.beginPath(),this.Fn===c.Crescendo?(s-=a,i.moveTo(s,e+this.y),i.lineTo(n,e+this.y+r/2),i.lineTo(s,e+this.y+r)):(s-=a,i.moveTo(n,e+this.y),i.lineTo(s,e+this.y+r/2),i.lineTo(n,e+this.y+r));const h=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=h}}class wo extends ho{get notationElement(){return t.NotationElement.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==c.None}createNewGlyph(t,e){return new go(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class yo extends va{Qy;Pw=1;constructor(t){super(0,0),this.Qy=t}doLayout(){this.height=0;const t=this.renderer.smuflMetrics.directionsScale;this.Pw=t;for(const e of this.Qy){const s=this.renderer.smuflMetrics.glyphHeights.get(e)*t;s>this.height&&(this.height=s)}}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.height,this.Pw,this.Qy,!0)}}class ko extends va{Tk;constructor(t){super(0,0),this.Tk=t}doLayout(){const t=this.renderer.scoreRenderer.canvas;t.font=this.renderer.resources.directionsFont,this.height=t.measureText(this.Tk).height}paint(t,e,s){const i=s.font,n=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=it.Middle,s.textAlign=st.Right,s.fillText(this.Tk,t+this.x,e+this.y+this.height/2),s.font=i,s.textBaseline=n,s.textAlign=r}}class So extends Na{Nk;Pk=[];Ek=[];constructor(t,e,s){super(t,e),this.Nk=s}doLayout(){const t=this.Nk;t.has(Qe.TargetSegnoSegno)&&this.Pk.push(new yo([at.Segno,at.Segno])),t.has(Qe.TargetSegno)&&this.Pk.push(new yo([at.Segno])),t.has(Qe.TargetDoubleCoda)&&this.Pk.push(new yo([at.Coda,at.Coda])),t.has(Qe.TargetCoda)&&this.Pk.push(new yo([at.Coda])),t.has(Qe.TargetFine)&&this.Ek.push(new ko("Fine")),t.has(Qe.JumpDaDoubleCoda)&&this.Ek.push(new ko("To Double Coda")),t.has(Qe.JumpDaCoda)&&this.Ek.push(new ko("To Coda")),t.has(Qe.JumpDalSegnoSegno)&&this.Ek.push(new ko("D.S.S.")),t.has(Qe.JumpDalSegnoSegnoAlCoda)&&this.Ek.push(new ko("D.S.S. al Coda")),t.has(Qe.JumpDalSegnoSegnoAlDoubleCoda)&&this.Ek.push(new ko("D.S.S. al Double Coda")),t.has(Qe.JumpDalSegnoSegnoAlFine)&&this.Ek.push(new ko("D.S.S. al Fine")),t.has(Qe.JumpDalSegno)&&this.Ek.push(new ko("D.S.")),t.has(Qe.JumpDalSegnoAlCoda)&&this.Ek.push(new ko("D.S. al Coda")),t.has(Qe.JumpDalSegnoAlDoubleCoda)&&this.Ek.push(new ko("D.S. al Double Coda")),t.has(Qe.JumpDalSegnoAlFine)&&this.Ek.push(new ko("D.S. al Fine")),t.has(Qe.JumpDaCapo)&&this.Ek.push(new ko("D.C.")),t.has(Qe.JumpDaCapoAlCoda)&&this.Ek.push(new ko("D.C. al Coda")),t.has(Qe.JumpDaCapoAlDoubleCoda)&&this.Ek.push(new ko("D.C. al Double Coda")),t.has(Qe.JumpDaCapoAlFine)&&this.Ek.push(new ko("D.C. al Fine"));const e=this.Ck(this.Pk),s=this.Ck(this.Ek);this.height=Math.max(e,s)}Ck(t){let e=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of t)i.y=e,i.renderer=this.renderer,i.doLayout(),e+=i.height+s;return e}paint(t,e,s){for(const i of this.Pk)i.paint(t+this.x,e+this.y,s);for(const i of this.Ek)i.paint(t+this.x+this.width,e+this.y,s)}}class Bo extends ho{get notationElement(){return t.NotationElement.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return lh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&null!==e.voice.bar.masterBar.directions&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new So(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}class _o extends Pa{constructor(t,e,s){super(t,e,1,_o.Fk(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(at.DynamicForte);const t=this.renderer.smuflMetrics.glyphTop.get(at.DynamicForte);this.offsetY=t}static Fk(t){switch(t){case n.PPP:return at.DynamicPPP;case n.PP:return at.DynamicPP;case n.P:return at.DynamicPiano;case n.MP:return at.DynamicMP;case n.MF:return at.DynamicMF;case n.F:return at.DynamicForte;case n.FF:return at.DynamicFF;case n.FFF:return at.DynamicFFF;case n.PPPP:return at.DynamicPPPP;case n.PPPPP:case n.PPPPPP:return at.DynamicPPPPP;case n.FFFF:return at.DynamicFFFF;case n.FFFFF:return at.DynamicFFFFF;case n.FFFFFF:return at.DynamicFFFFFF;case n.SF:return at.DynamicSforzando1;case n.SFP:return at.DynamicSforzandoPiano;case n.SFPP:return at.DynamicSforzandoPianissimo;case n.FP:return at.DynamicFortePiano;case n.RF:return at.DynamicRinforzando1;case n.RFZ:return at.DynamicRinforzando2;case n.SFZ:return at.DynamicSforzato;case n.SFFZ:return at.DynamicSforzatoFF;case n.FZ:return at.DynamicForzando;case n.N:return at.DynamicNiente;case n.PF:return at.DynamicPF;case n.SFZP:return at.DynamicSforzatoPiano;default:return at.None}}}class xo extends ho{get notationElement(){return t.NotationElement.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return this.Ak(e)}Ak(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this.Dk(t);let s=0===t.voice.index&&!e||t.dynamics!==e?.dynamics;if(s&&t.voice.index>0)for(const e of t.voice.bar.voices)if(e.index<t.voice.index){const i=e.getBeatAtPlaybackStart(t.playbackStart);i&&t.dynamics===i.dynamics&&this.Ak(i)&&(s=!1)}return s}Dk(t){let e=t.previousBeat;for(;null!=e;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new _o(0,0,e.dynamics)}canExpand(t,e){return!0}}class To extends Pa{constructor(t){super(0,0,1,To.Fk(t)),this.center=!0}static Fk(t){switch(t){case pt.FadeIn:return at.GuitarFadeIn;case pt.FadeOut:return at.GuitarFadeOut;case pt.VolumeSwell:return at.GuitarVolumeSwell}return at.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class Mo extends ho{get notationElement(){return t.NotationElement.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==pt.None}createNewGlyph(t,e){return new To(e.fade)}canExpand(t,e){return!0}}class vo extends Pa{constructor(t,e,s){super(t,e,1,vo.Fk(s))}static Fk(t){switch(t){case Pt.Short:return at.FermataShortAbove;case Pt.Medium:return at.FermataAbove;case Pt.Long:return at.FermataLongAbove;default:return at.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class No extends ho{get notationElement(){return t.NotationElement.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.voice.index&&!!e.fermata}createNewGlyph(t,e){return new vo(0,0,e.fermata.type)}canExpand(t,e){return!0}}class Po{line=0;symbols;color;constructor(t,e){this.line=t,this.symbols=e}}class Eo extends wh{dk=new Map;constructor(){super(0,0)}get isEmpty(){return 0===this.dk.size}addFingers(e){const s=this.renderer.settings;if(s.notation.fingeringMode!==t.FingeringMode.ScoreDefault&&s.notation.fingeringMode!==t.FingeringMode.ScoreForcePiano)return;const i=Eo.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.leftHandFinger,!0);i!==at.None&&this.Lk(e,i);const n=Eo.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.rightHandFinger,!1);n!==at.None&&this.Lk(e,n)}static fingerToMusicFontSymbol(e,s,i,n){if(e.notation.fingeringMode===t.FingeringMode.ScoreForcePiano||e.notation.fingeringMode===t.FingeringMode.SingleNoteEffectBandForcePiano||de.isPiano(s.voice.bar.staff.track.playbackInfo.program))switch(i){case f.Unknown:case f.NoOrDead:return at.None;case f.Thumb:return at.Fingering1;case f.IndexFinger:return at.Fingering2;case f.MiddleFinger:return at.Fingering3;case f.AnnularFinger:return at.Fingering4;case f.LittleFinger:return at.Fingering5;default:return at.None}if(n)switch(i){case f.Unknown:return at.None;case f.NoOrDead:return at.Fingering0;case f.Thumb:return at.FingeringTLower;case f.IndexFinger:return at.Fingering1;case f.MiddleFinger:return at.Fingering2;case f.AnnularFinger:return at.Fingering3;case f.LittleFinger:return at.Fingering4;default:return at.None}switch(i){case f.Unknown:case f.NoOrDead:return at.None;case f.Thumb:return at.FingeringPLower;case f.IndexFinger:return at.FingeringILower;case f.MiddleFinger:return at.FingeringMLower;case f.AnnularFinger:return at.FingeringALower;case f.LittleFinger:return at.FingeringCLower;default:return at.None}}Lk(t,e){const s=this.renderer,i=s.getNoteLine(t);if(this.dk.has(i)){this.dk.get(i).symbols.push(e)}else{const n=new Po(i,[e]);n.color=kh.noteColor(s.resources,ut.StandardNotationEffects,t),this.dk.set(i,n)}}doLayout(){const t=this.renderer;for(const[e,s]of this.dk){const e=new Ea(0,0,1,s.symbols);e.colorOverride=s.color,e.renderer=t,e.y=t.getScoreY(s.line),e.doLayout(),e.offsetY=e.height/2,this.addGlyph(e),this.width=Math.max(this.width,e.width)}for(const t of this.glyphs){const e=t;e.x=this.width/2,e.center=!0}}}class Co extends ho{get notationElement(){return t.NotationElement.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(e,s){return!(0!==s.voice.index||s.isRest||e.notation.fingeringMode!==t.FingeringMode.SingleNoteEffectBand&&e.notation.fingeringMode!==t.FingeringMode.SingleNoteEffectBandForcePiano)&&(1===s.notes.length&&s.notes[0].isFingering)}createNewGlyph(t,e){let s=f.Unknown,i=!1;const n=e.notes[0];n.leftHandFinger!==f.Unknown?(s=n.leftHandFinger,i=!0):n.rightHandFinger!==f.Unknown&&(s=n.rightHandFinger);const r=Eo.fingerToMusicFontSymbol(t.settings,e,s,i),a=new Pa(0,0,1,r);return a.center=!0,a.renderer=t,a.doLayout(),a.offsetY=t.smuflMetrics.glyphTop.get(a.symbol),a}canExpand(t,e){return!0}}class Fo extends ho{get notationElement(){return t.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(t,e){return new Dh(0,0,"Free time",t.resources.effectFont,st.Left)}canExpand(t,e){return!0}}class Ao extends Pa{constructor(t,e,s=!1){super(t,e,Ca.GraceScale,at.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class Do extends ho{Wk;Rk;constructor(t,e){super(),this.Wk=t,this.Rk=e}get notationElement(){return t.NotationElement.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){const s=this.Rk;return e.golpe===this.Wk&&(!s||s(t,e))}createNewGlyph(t,e){return new Ao(0,0,!0)}canExpand(t,e){return!1}}class Lo extends ho{lastCreateInfo=null;shouldCreateGlyph(t,e){this.lastCreateInfo=[];for(let t=0,s=e.notes.length;t<s;t++){const s=e.notes[t];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(t,e){return!0}}class Wo extends Lo{Ok;ge=null;Ik;get effectId(){return this.Ik}get notationElement(){return t.NotationElement.EffectHarmonics}constructor(t){switch(super(),this.Ok=t,t){case p.None:this.Ik="harmonics-none";break;case p.Natural:this.Ik="harmonics-natural";break;case p.Artificial:this.Ik="harmonics-artificial";break;case p.Pinch:this.Ik="harmonics-pinch";break;case p.Tap:this.Ik="harmonics-tap";break;case p.Semi:this.Ik="harmonics-semi";break;case p.Feedback:this.Ik="harmonics-feedback";break;default:this.Ik=""}}shouldCreateGlyphForNote(t){return!(!t.isHarmonic||t.harmonicType!==this.Ok)&&(t.beat!==this.ge&&(this.ge=t.beat),!0)}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){return new lo(Wo.harmonicToString(this.Ok))}static harmonicToString(t){switch(t){case p.Natural:return"N.H.";case p.Artificial:return"A.H.";case p.Pinch:return"P.H.";case p.Tap:return"T.H.";case p.Semi:return"S.H.";case p.Feedback:return"Fdbk."}return""}}class Ro extends Pa{constructor(){super(0,0,1,at.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class Oo extends Lo{get notationElement(){return t.NotationElement.EffectTap}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new Ro}}class Io extends ho{get notationElement(){return t.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){return new lo("LetRing")}canExpand(t,e){return!0}}class Go extends Na{my;font;textAlign;constructor(t,e,s,i,n=st.Center){super(t,e),this.my=s,this.font=i,this.textAlign=n}doLayout(){super.doLayout(),this.height=this.font.size*this.my.length}paint(t,e,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this.my.length;i++)this.my[i]&&s.fillText(this.my[i],t+this.x,e+this.y+i*this.font.size);s.textAlign=i}}class $o extends ho{get notationElement(){return t.NotationElement.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(t,e){return new Go(0,0,e.lyrics,t.resources.effectFont,st.Center)}canExpand(t,e){return!0}}class Vo extends ho{get notationElement(){return t.NotationElement.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return lh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(t,e){return new Dh(0,0,e.voice.bar.masterBar.section.marker?`[${e.voice.bar.masterBar.section.marker}] ${e.voice.bar.masterBar.section.text}`:e.voice.bar.masterBar.section.text,t.resources.markerFont,st.Left)}canExpand(t,e){return!0}}class Ho extends Pa{constructor(t){super(0,0,1,Ho.Fk(t)),this.center=!0}static Fk(t){switch(t){case lt.InvertedTurn:return at.OrnamentTurnInverted;case lt.Turn:return at.OrnamentTurn;case lt.UpperMordent:return at.OrnamentShortTrill;case lt.LowerMordent:return at.OrnamentMordent}return at.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(at.OrnamentMordent)}}class Uo extends ho{get notationElement(){return t.NotationElement.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(t=>t.ornament!==lt.None)}createNewGlyph(t,e){return new Ho(e.notes.find(t=>t.ornament!==lt.None).ornament)}canExpand(t,e){return!1}}class zo extends co{Gk;$k;constructor(t,e){super(ah.PostNotes),this.Gk=t,this.$k=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.QuindicesimaAlta)}paintNonGrouped(t,e,s){this.Vk(t,e,s)}Vk(t,e,s){let i=0;switch(this.Gk){case m.S:i=this.renderer.smuflMetrics.glyphWidths.get(at.QuindicesimaAlta),Lt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,at.QuindicesimaAlta,!1);break;case m._:i=this.renderer.smuflMetrics.glyphWidths.get(at.OttavaAlta),Lt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,at.OttavaAlta,!1);break;case m.T:i=this.renderer.smuflMetrics.glyphWidths.get(at.OttavaBassaVb),Lt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,at.OttavaBassaVb,!1);break;case m.M:i=1*(this.renderer.smuflMetrics.glyphWidths.get(at.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(at.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(at.OctaveBaselineB)),Lt.fillMusicFontSymbolsSafe(s,t+this.x-i/2,e+this.y+this.height,1,[at.Quindicesima,at.OctaveBaselineM,at.OctaveBaselineB],!1)}return i/2}paintGrouped(t,e,s,i){const n=this.Vk(t,e,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,a=t+this.x+n+r;let h=e+this.y;const o=.5*this.height;h+=this.$k?0:this.height;const c=this.renderer.smuflMetrics.lineRangedGlyphDashSize,l=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>a){let t=a;for(;t<s;)i.beginPath(),i.moveTo(t,0|h),i.lineTo(Math.min(t+c,s),0|h),t+=c+r,i.stroke();i.beginPath(),this.$k?(i.moveTo(s,h),i.lineTo(s,h+o)):(i.moveTo(s,h),i.lineTo(s,h-o)),i.stroke()}i.lineWidth=l}}class jo extends ho{$k;get effectId(){return"ottavia-"+(this.$k?"above":"below")}get notationElement(){return t.NotationElement.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.GroupedOnBeat}constructor(t){super(),this.$k=t}shouldCreateGlyph(t,e){switch(e.ottava){case m.S:case m._:return this.$k;case m.T:case m.M:return!this.$k}return!1}createNewGlyph(t,e){return new zo(e.ottava,this.$k)}canExpand(t,e){return t.ottava===e.ottava}}class Xo extends Lo{get notationElement(){return t.NotationElement.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){return new lo("P.M.")}}class Jo extends Lo{get notationElement(){return t.NotationElement.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===w.PickSlideDown||t.slideOutType===w.PickSlideUp}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){return new lo("P.S.")}}class qo extends Pa{constructor(t,e,s){super(t,e,Ca.GraceScale,qo.Fk(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static Fk(t){switch(t){case ot.Up:return at.StringsUpBow;case ot.Down:return at.StringsDownBow;default:return at.None}}}class Yo extends ho{get notationElement(){return t.NotationElement.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==ot.None}createNewGlyph(t,e){return new qo(0,0,e.pickStroke)}canExpand(t,e){return!0}}class Ko extends ho{get notationElement(){return t.NotationElement.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return lh.GroupedOnBeat}createNewGlyph(t,e){return new lo("rasg.")}canExpand(t,e){return!0}}class Qo extends co{Wk;Hk=at.None;Uk=0;zk=0;jk;constructor(t,e,s,i=!1){super(ah.EndBeat),this.Wk=s,this.x=t,this.y=e,this.jk=i}doLayout(){switch(super.doLayout(),this.Wk){case y.Slight:this.Hk=this.slightVibratoGlyph;break;case y.Wide:this.Hk=this.wideVibratoGlyph}this.Uk=this.renderer.smuflMetrics.repeatOffsetX.get(this.Hk),this.zk=this.renderer.smuflMetrics.glyphTop.get(this.Hk),this.height=this.renderer.smuflMetrics.glyphHeights.get(this.Hk)}paintGrouped(t,e,s,i){let n=(s-(t+this.x))/this.Uk;this.jk||(n=Math.floor(n)),n<1&&(n=1);const r=[];for(let t=0;t<n;t++)r.push(this.Hk);i.fillMusicFontSymbols(t+this.x,e+this.y+this.zk,1,r,!1)}}class Zo extends Qo{get slightVibratoGlyph(){return at.GuitarVibratoStroke}get wideVibratoGlyph(){return at.GuitarWideVibratoStroke}}class tc extends Qo{get slightVibratoGlyph(){return at.WiggleSawtoothNarrow}get wideVibratoGlyph(){return at.WiggleSawtooth}}class ec extends ho{get notationElement(){return t.NotationElement.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===y.Slight}createNewGlyph(t,e){return new tc(0,0,y.Slight)}canExpand(t,e){return!0}}class sc extends Lo{Xk;get notationElement(){return t.NotationElement.EffectSlightNoteVibrato}shouldCreateGlyphForNote(t){let e=t.vibrato===y.Slight||t.isTieDestination&&t.tieOrigin.vibrato===y.Slight;return this.Xk&&e&&t.isTieDestination&&t.tieOrigin.hasBend&&(e=!1),e}get sizingMode(){return lh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new Zo(0,0,y.Slight)}constructor(t){super(),this.Xk=t}}class ic extends Na{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.KeyboardPedalPed)}paint(t,e,s){const i=this.renderer,n=e+this.y,r=this.height,a=i.bar.sustainPedals,h=this.renderer.smuflMetrics.glyphWidths.get(at.KeyboardPedalPed),o=this.renderer.smuflMetrics.glyphWidths.get(at.KeyboardPedalUp);let c=0;for(;c<a.length;){let e=a[c];for(;null!=e;){const i=t+this.renderer.getRatioPositionX(e.ratioPosition);let l=0;if(e.pedalType===A.Down?(Lt.fillMusicFontSymbolSafe(s,i,n+r,1,at.KeyboardPedalPed,!0),l=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding):e.pedalType===A.Up&&(Lt.fillMusicFontSymbolSafe(s,i,n+r,1,at.KeyboardPedalUp,!0),l=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding),e.nextPedalMarker)if(e.nextPedalMarker.bar===e.bar){let a=t+this.renderer.getRatioPositionX(e.nextPedalMarker.ratioPosition);switch(e.nextPedalMarker.pedalType){case A.Down:a-=h/2;break;case A.Hold:break;case A.Up:a-=o/2}const c=i+l;a>c&&s.fillRect(c,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-c,this.renderer.smuflMetrics.pedalLineThickness)}else{const e=t+this.x+this.width,a=i+l;s.fillRect(a,n+r-this.renderer.smuflMetrics.pedalLineThickness,e-a,this.renderer.smuflMetrics.pedalLineThickness)}if(0===c&&e.previousPedalMarker){const e=t+this.x,a=i-l;s.fillRect(e,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-e,this.renderer.smuflMetrics.pedalLineThickness)}c++,null!=e.nextPedalMarker&&e.nextPedalMarker.bar!==e.bar?(e=null,c=a.length):e=e.nextPedalMarker}}}}class nc extends ho{get notationElement(){return t.NotationElement.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new ic}canExpand(t,e){return!0}}class rc extends ho{get notationElement(){return t.NotationElement.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(t,e){const s=t.resources;return e.slap?new Dh(0,0,"S",s.effectFont,st.Center):e.pop?new Dh(0,0,"P",s.effectFont,st.Center):new Dh(0,0,"T",s.effectFont,st.Center)}canExpand(t,e){return!0}}class ac extends Na{Jk;constructor(t){super(0,0),this.Jk=t}doLayout(){super.doLayout();const t=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(at.MetNoteQuarterUp)*t.engravingSettings.tempoNoteScale}paint(t,e,s){for(const i of this.Jk){let n=t+this.renderer.getRatioPositionX(i.ratioPosition);const r=this.renderer.resources;s.font=r.markerFont;const a=e+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(at.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,h=s.textBaseline;if(s.textBaseline=it.Alphabetic,i.text){const t=`${i.text} `,e=s.measureText(t);s.fillText(t,n,a),n+=e.width}else n-=r.engravingSettings.glyphWidths.get(at.MetNoteQuarterUp)/2;Lt.fillMusicFontSymbolSafe(s,n,a,r.engravingSettings.tempoNoteScale,at.MetNoteQuarterUp),n+=this.renderer.smuflMetrics.glyphWidths.get(at.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,n,a),s.textBaseline=h,n+=s.measureText(` = ${i.value.toString()}`).width}}}class hc extends ho{get notationElement(){return t.NotationElement.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return lh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.tempoAutomations.some(t=>t.isVisible)}createNewGlyph(t,e){return new ac(e.voice.bar.masterBar.tempoAutomations.filter(t=>t.isVisible))}canExpand(t,e){return!0}}class oc extends ho{get notationElement(){return t.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(t,e){return new Dh(0,0,e.text,t.resources.effectFont,st.Left)}canExpand(t,e){return!0}}class cc extends co{constructor(t,e){super(ah.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.OrnamentTrill)}paintGrouped(t,e,s,i){const n=this.renderer.smuflMetrics.glyphWidths.get(at.OrnamentTrill),r=t+this.x+n,a=this.renderer.smuflMetrics.repeatOffsetX.get(at.WiggleTrill),h=Math.ceil((s-r)/a),o=[at.OrnamentTrill];for(let t=0;t<h;t++)o.push(at.WiggleTrill);i.fillMusicFontSymbols(t+this.x-n/2,e+this.y+this.height,1,o,!1)}}class lc extends Lo{get notationElement(){return t.NotationElement.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return lh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new cc(0,0)}}!function(t){t[t.EighthEighth=0]="EighthEighth",t[t.SixteenthSixteenth=1]="SixteenthSixteenth",t[t.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",t[t.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",t[t.EighthDottedSixteenth=4]="EighthDottedSixteenth",t[t.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",t[t.SixteenthEighthDotted=6]="SixteenthEighthDotted",t[t.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"}(uh||(uh={}));class uc extends Na{qk;Yk=0;Kk=0;constructor(t){super(0,0),this.qk=t}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(at.MetNoteQuarterUp)*t,this.Yk=this.renderer.smuflMetrics.glyphHeights.get(at.Tuplet3)*t,this.Kk=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this.Yk}paint(t,e,s){t+=this.x,e+=this.y;let i=uh.EighthEighth,n=uh.EighthEighth;switch(this.qk){case rt.NoTripletFeel:i=uh.EighthEighth,n=uh.EighthEighth;break;case rt.Triplet8th:i=uh.EighthEighth,n=uh.QuarterTripletEighthTriplet;break;case rt.Triplet16th:i=uh.SixteenthSixteenth,n=uh.EighthSixteenthTriplet;break;case rt.Dotted8th:i=uh.EighthEighth,n=uh.EighthDottedSixteenth;break;case rt.Dotted16th:i=uh.SixteenthSixteenth,n=uh.SixteenthDottedThirtySecond;break;case rt.Scottish8th:i=uh.EighthEighth,n=uh.SixteenthEighthDotted;break;case rt.Scottish16th:i=uh.SixteenthSixteenth,n=uh.ThirtySecondSixteenthDotted}const r=this.renderer.smuflMetrics.tempoNoteScale,a=e+this.renderer.smuflMetrics.glyphTop.get(at.MetNoteQuarterUp)*r,h=e+this.height,o=s.textBaseline;s.textBaseline=it.Bottom,s.font=this.renderer.resources.effectFont,s.fillText("(",t,h),t+=s.measureText("( ").width,t=this.Qk(t,a+this.Yk,s,i),s.fillText(" = ",t,h),t+=s.measureText(" = ").width,t=this.Qk(t,a+this.Yk,s,n),s.fillText(" )",t,h),s.textBaseline=o}Qk(t,e,s,i){const n=this.renderer.smuflMetrics.tempoNoteScale;let r=[],a=[];const h=[];let o=at.None;switch(i){case uh.EighthEighth:h.push(st.Center),r=[at.MetNoteQuarterUp],a=[at.MetNoteQuarterUp];break;case uh.SixteenthSixteenth:h.push(st.Center),h.push(st.Center),r=[at.MetNoteQuarterUp],a=[at.MetNoteQuarterUp];break;case uh.QuarterTripletEighthTriplet:r=[at.MetNoteQuarterUp],a=[at.MetNote8thUp],o=at.Tuplet3;break;case uh.EighthSixteenthTriplet:h.push(st.Center),h.push(st.Right),r=[at.MetNoteQuarterUp],a=[at.MetNoteQuarterUp],o=at.Tuplet3;break;case uh.EighthDottedSixteenth:h.push(st.Center),h.push(st.Right),r=[at.MetNoteQuarterUp,at.Space,at.MetAugmentationDot],a=[at.MetNoteQuarterUp];break;case uh.SixteenthDottedThirtySecond:h.push(st.Center),h.push(st.Center),h.push(st.Right),r=[at.MetNoteQuarterUp,at.Space,at.MetAugmentationDot],a=[at.MetNoteQuarterUp];break;case uh.SixteenthEighthDotted:h.push(st.Center),h.push(st.Left),r=[at.MetNoteQuarterUp],a=[at.MetNoteQuarterUp,at.Space,at.MetAugmentationDot];break;case uh.ThirtySecondSixteenthDotted:h.push(st.Center),h.push(st.Center),h.push(st.Left),r=[at.MetNoteQuarterUp],a=[at.MetNoteQuarterUp,at.Space,at.MetAugmentationDot]}const c=this.renderer.smuflMetrics.glyphWidths.get(at.MetNoteQuarterUp)*n,l=t+c-this.renderer.smuflMetrics.stemThickness*n,u=l+2*c+this.renderer.smuflMetrics.stemThickness*n,d=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,f=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,p=this.renderer.smuflMetrics.brokenBeamWidth*n;let b=e-this.renderer.smuflMetrics.glyphHeights.get(at.MetNoteQuarterUp)*n+d;if(o!==at.None){const e=(t+u)/2,i=b-this.Yk-this.Kk,r=this.renderer.smuflMetrics.glyphTop.get(o)*n,a=this.renderer.smuflMetrics.glyphWidths.get(o)*n;Lt.fillMusicFontSymbolSafe(s,e,i+r,n,o,!0);const h=e-a/2-this.Kk,c=e+a/2+this.Kk,l=this.Yk/2,d=s.lineWidth;s.beginPath(),s.moveTo(t,i+l+l),s.lineTo(t,i+l),s.lineTo(h,i+l),s.moveTo(c,i+l),s.lineTo(u,i+l),s.lineTo(u,i+l+l),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*n,s.stroke(),s.lineWidth=d}s.fillMusicFontSymbols(t,e,n,r,!1),t+=c,t+=c,s.fillMusicFontSymbols(t,e,n,a,!1),t+=c,a[a.length-1]!==at.MetAugmentationDot&&a[0]!==at.MetNote8thUp||(t+=c);for(const t of h){switch(t){case st.Left:s.fillRect(l,b,p,d);break;case st.Center:s.fillRect(l,b,u-l,d);break;case st.Right:s.fillRect(u-p,b,p,d)}b+=d+f}return t}}class dc extends ho{get notationElement(){return t.NotationElement.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return lh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.index&&(0===e.voice.bar.masterBar.index&&e.voice.bar.masterBar.tripletFeel!==rt.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new uc(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class fc extends Pa{constructor(t){super(0,0,1,fc.Fk(t)),this.center=!0}static Fk(t){switch(t){case bt.Open:return at.GuitarOpenPedal;case bt.Closed:return at.GuitarClosePedal}return at.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class pc extends ho{get notationElement(){return t.NotationElement.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==bt.None}createNewGlyph(t,e){return new fc(e.wahPedal)}canExpand(t,e){return!1}}class bc extends ho{get notationElement(){return t.NotationElement.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return lh.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new lo("w/bar")}canExpand(t,e){return!0}}class mc extends ho{get notationElement(){return t.NotationElement.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return lh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===y.Wide}createNewGlyph(t,e){return new tc(0,0,y.Wide)}canExpand(t,e){return!0}}class gc extends Lo{get notationElement(){return t.NotationElement.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===y.Wide||t.isTieDestination&&t.tieOrigin.vibrato===y.Wide}get sizingMode(){return lh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new Zo(0,0,y.Wide)}}class wc{x=0;width=0;masterBars=[]}class yc extends Xh{Zk=null;get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let t=this.pagePadding[0];return this.Zk&&(t+=this.Zk.accoladeWidth),t}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case t.SystemsLayoutMode.Automatic:this.systemsLayoutMode=hh.Automatic;break;case t.SystemsLayoutMode.UseModelLayout:this.systemsLayoutMode=hh.FromModelWithWidths}const e=this.renderer.score;let s=this.renderer.settings.display.startBar;s--,s=Math.min(e.masterBars.length-1,Math.max(0,s));let i=s,n=this.renderer.settings.display.barCount;n<=0&&(n=e.masterBars.length),n=s+n-1,n=Math.min(e.masterBars.length-1,Math.max(0,n)),this.Zk=this.createEmptyStaffSystem(),this.Zk.isLast=!0,this.Zk.x=this.pagePadding[0],this.Zk.y=this.pagePadding[1];const r=this.renderer.settings.display.barCountPerPartial,a=[];let h=new wc,o=0;for(;i<=n;){const t=this.multiBarRestInfo,s=null!==t&&t.has(i)?t.get(i):null,n=this.Zk.addBars(this.renderer.tracks,i,s);if(0===h.masterBars.length&&n.isLinkedToPrevious&&a.length>0){const t=a[a.length-1];t.masterBars.push(e.masterBars[i]),t.width+=n.width,o+=n.width,h.x+=o}else h.masterBars.push(e.masterBars[i]),h.width+=n.width,h.masterBars.length>=r&&(0===a.length&&(h.width+=this.Zk.accoladeWidth+this.pagePadding[0]),o+=h.width,a.push(h),j.debug(this.name,`Finished partial from bar ${h.masterBars[0].index} to ${h.masterBars[h.masterBars.length-1].index}`,null),h=new wc,h.x=o);i++}h.masterBars.length>0&&(0===a.length&&(h.width+=this.Zk.accoladeWidth+this.pagePadding[0]),a.push(h),j.debug(this.name,`Finished partial from bar ${h.masterBars[0].index} to ${h.masterBars[h.masterBars.length-1].index}`,null)),this.tS(),this.height=Math.floor(this.Zk.y+this.Zk.height),this.width=this.Zk.x+this.Zk.width+this.pagePadding[2],i=0;let c=0;for(let t=0;t<a.length;t++){const e=a[t],s=new xe;s.x=c,s.y=0,s.totalWidth=this.width,s.totalHeight=this.height,s.width=e.width,s.height=this.height,s.firstMasterBarIndex=e.masterBars[0].index,s.lastMasterBarIndex=e.masterBars[e.masterBars.length-1].index,c+=e.width;const n=i,r=t;this.Zk.buildBoundingsLookup(0,0),this.registerPartial(s,t=>{let s=this.Zk.getBarX(e.masterBars[0].index)+this.Zk.accoladeWidth;0===r&&(s-=this.Zk.x+this.Zk.accoladeWidth),t.color=this.renderer.settings.display.resources.mainGlyphColor,t.textAlign=st.Left,j.debug(this.name,`Rendering partial from bar ${e.masterBars[0].index} to ${e.masterBars[e.masterBars.length-1].index}`,null),this.Zk.paintPartial(-s,this.Zk.y,t,n,e.masterBars.length)}),i+=e.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}tS(){this.Zk.scaleToWidth(this.Zk.width),this.Zk.finalizeSystem()}}class kc extends Xh{eS=[];sS=[];iS=[];get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case t.SystemsLayoutMode.Automatic:this.systemsLayoutMode=hh.Automatic;break;case t.SystemsLayoutMode.UseModelLayout:this.systemsLayoutMode=hh.FromModelWithScale}let e=this.pagePadding[1];this.width=this.renderer.width,this.sS=[],e=this.nS(e,-1),e=this.rS(e,-1),e=this.aS(e,-1),e=this.hS(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let t=this.pagePadding[0];return this.eS.length>0&&(t+=this.eS[0].accoladeWidth),t}doResize(){let t=this.pagePadding[1];this.width=this.renderer.width;const e=this.height;t=this.nS(t,e),t=this.rS(t,e),t=this.aS(t,e),t=this.oS(t,e),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}rS(t,e=-1){if(!this.tuningGlyph)return t;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),n=new xe;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+n.height:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=st.Center,this.tuningGlyph.paint(0,0,t)}),t+i}aS(t,e=-1){if(!this.chordDiagrams)return t;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),n=new xe;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+i:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=st.Center,this.chordDiagrams.paint(0,0,t)}),t+i}nS(t,e=-1){j.debug(this.name,"Layouting score info");const s=new xe;s.x=0,s.y=t;let i=0;const n=this.renderer.settings.display.resources,r=[];for(const[t,e]of Xh.headerElements.value)if(this.headerGlyphs.has(t)){const e=this.headerGlyphs.get(t);e.y=i,this.alignScoreInfoGlyph(e);let s=e.font.size;if(t===nt.Words&&this.headerGlyphs.has(nt.Music)){this.headerGlyphs.get(nt.Music).textAlign!==e.textAlign&&(s=0)}i+=s,r.push(e)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=e<0?t+s.height:e,this.registerPartial(s,t=>{t.color=n.scoreInfoColor,t.textAlign=st.Center;for(const e of r)e.paint(0,0,t)})),t+i}oS(t,e){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===hh.FromModelWithScale)for(let s=0;s<this.eS.length;s++){const i=this.eS[s];this.cS(i),t+=this.lS(i,e)}else{this.eS=[];let s=0;const i=this.uS;let n=this.createEmptyStaffSystem();for(n.index=this.eS.length,n.x=this.pagePadding[0],n.y=t;s<this.sS.length;){let r=this.sS[s];if(n.width+r.width<=i||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,r),s++;else{for(;r&&!r.canWrap&&n.masterBarsRenderers.length>1;)r=n.revertLastBar(),s--;n.isFull=!0,n.isLast=this.lastBarIndex===n.lastBarIndex,this.eS.push(n),this.cS(n),t+=this.lS(n,e),n=this.createEmptyStaffSystem(),n.index=this.eS.length,n.x=this.pagePadding[0],n.y=t}}n.isLast=this.lastBarIndex===n.lastBarIndex,this.cS(n),t+=this.lS(n,e)}return t}hS(t){let e=this.firstBarIndex;const s=this.lastBarIndex;for(this.eS=[];e<=s;){const i=this.dS(e,s);this.eS.push(i),i.x=this.pagePadding[0],i.y=t,e=i.lastBarIndex+1,this.cS(i),j.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),t+=this.lS(i,t)}return t}lS(t,e){const s=Math.floor(t.height),i=new xe;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=st.Left,t.paint(0,-i.y/this.renderer.settings.display.scale,e)}),s}cS(t){t.isFull||t.width>this.uS||this.renderer.settings.display.justifyLastSystem?t.scaleToWidth(this.uS):t.scaleToWidth(t.width),t.finalizeSystem()}fS(t){let e=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===hh.FromModelWithScale){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),e=t<i.length?i[t]:s}return e}dS(t,e){const s=this.createEmptyStaffSystem();s.index=this.eS.length;const i=this.fS(s.index),n=this.uS,r=e+1;let a=t;for(;a<r;){if(this.iS.length>0)for(const t of this.iS)s.addMasterBarRenderers(this.renderer.tracks,t),a=t.lastMasterBarIndex;else{const t=this.multiBarRestInfo,e=null!==t&&t.has(a)?t.get(a):null,i=s.addBars(this.renderer.tracks,a,e);this.sS.push(i),a=i.lastMasterBarIndex}this.iS=[];let t=!1;if((-1===i&&s.width>=n&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(t=!0),t){let t=s.revertLastBar();if(t)for(this.iS.push(t);t&&!t.canWrap&&s.masterBarsRenderers.length>1;)t=s.revertLastBar(),t&&this.iS.push(t);return s.isFull=!0,s.isLast=!1,this.iS.reverse(),s}let e=!1,r=!0;for(const t of this.renderer.tracks)t.lineBreaks&&t.lineBreaks.has(a+1)?e=!0:r=!1;if(e&&r)return s.isFull=!0,s.isLast=!1,s;s.x=0,a++}return s.isLast=e===s.lastBarIndex,s}get uS(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class Sc extends va{constructor(t,e,s){super(t,e),this.width=s}}class Bc extends va{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}}class _c extends Bc{pS;constructor(t,e,s){super(t,e),this.pS=s}doLayout(){this.width=this.pS?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(t,e,s){s.fillRect(t+this.x,e+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}}class xc extends Bc{paint(t,e,s){const i=this.renderer.smuflMetrics.thinBarlineThickness/2,n=this.renderer.getLineHeight(1);let r=e+this.y+.5*n+i;const a=e+this.y+this.height;for(;r<a;)s.fillCircle(t+this.x,r,i),r+=n}}class Tc extends Bc{paint(t,e,s){const i=this.renderer.smuflMetrics.dashedBarlineDashLength,n=t+this.x-this.width/2,r=Math.ceil(this.height/2/i),a=e+this.y+this.height,h=this.renderer.smuflMetrics.dashedBarlineGapLength,o=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),r<1)s.moveTo(n,e+this.y),s.lineTo(n,a);else{let t=e+this.y;for(;t<a;){s.moveTo(n,t);const e=Math.min(a-t,i);s.lineTo(n,t+e),t+=i+h}}s.stroke(),s.lineWidth=o}}class Mc extends Bc{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(t,e,s){s.fillRect(t+this.x,e+this.y,this.width,this.height)}}class vc extends Bc{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(at.RepeatDot)}paint(t,e,s){const i=this.renderer,n=i.heightLineCount%2==0?1:.5,r=e+this.y+this.height/2,a=i.getLineHeight(n),h=i.smuflMetrics.glyphTop.get(at.RepeatDot)-i.smuflMetrics.glyphHeights.get(at.RepeatDot)/2;Lt.fillMusicFontSymbolSafe(s,t+this.x,r+h-a,1,at.RepeatDot),Lt.fillMusicFontSymbolSafe(s,t+this.x,r+h+a,1,at.RepeatDot)}}class Nc extends Bc{paint(t,e,s){const i=this.renderer;if(i.drawnLineCount-1<=2)return;const n=i.smuflMetrics.staffLineThickness/2,r=(i.drawnLineCount-1)/2,a=i.getLineY(r-1)-n,h=i.getLineY(r+1)+n;s.fillRect(t+this.x,e+a,i.smuflMetrics.thinBarlineThickness,h-a)}}class Pc extends Bc{paint(t,e,s){const i=this.renderer.getLineHeight(1),n=-i/2+1;s.fillRect(t+this.x,e+this.y+n,1,i)}}class Ec extends yh{bS;constructor(t){super(),this.bS=t}doLayout(){const t=this.renderer.bar,e=t.masterBar,s=this.bS?t.getActualBarLineRight():t.getActualBarLineLeft(0===this.renderer.index),i=this.bS&&e.isRepeatEnd||!this.bS&&e.isRepeatStart;let n=L.Automatic;if(!this.bS){const t=this.renderer.previousRenderer;if(t&&t.staff===this.renderer.staff&&(n=t.bar.getActualBarLineRight(),s===n))return}switch(this.bS&&e.isRepeatEnd&&(this.addGlyph(new vc(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case L.Dashed:this.addGlyph(new Tc(0,0));break;case L.Dotted:this.addGlyph(new xc(0,0));break;case L.Heavy:n!==L.LightHeavy&&n!==L.HeavyHeavy&&this.addGlyph(new Mc(0,0));break;case L.HeavyHeavy:n!==L.LightHeavy&&n!==L.Heavy&&this.addGlyph(new Mc(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Mc(0,0));break;case L.HeavyLight:n!==L.LightHeavy&&n!==L.Heavy&&n!==L.HeavyHeavy&&this.addGlyph(new Mc(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new _c(0,0,i));break;case L.LightHeavy:n!==L.HeavyLight&&n!==L.Regular&&n!==L.LightLight&&this.addGlyph(new _c(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Mc(0,0));break;case L.LightLight:n!==L.HeavyLight&&n!==L.Regular&&this.addGlyph(new _c(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new _c(0,0,i));break;case L.None:break;case L.Regular:n!==L.HeavyLight&&n!==L.LightLight&&this.addGlyph(new _c(0,0,i));break;case L.Short:this.addGlyph(new Nc(0,0));break;case L.Tick:this.addGlyph(new Pc(0,0))}this.bS||e.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new vc(0,0)));const r=this.renderer,a=r.smuflMetrics.staffLineThickness,h=this.y+r.topPadding-a,o=this.y+this.renderer.height-this.renderer.bottomPadding-h;for(const t of this.glyphs)t.y=h,t.height=o}paint(t,e,s){const i=this.renderer,n=kh.bar(s,i.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class Cc extends va{mS=0;constructor(t,e,s){super(t,e),this.mS=0,this.mS=s}doLayout(){this.width=0}paint(t,e,s){const i=kh.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const i=this.renderer.resources,n=s.textAlign;s.font=i.barNumberFont,s.textAlign=st.Right;const r=`x${this.mS}`,a=s.measureText(r).width/1.5;s.fillText(r,t+this.x-a,e+this.y),s.textAlign=n}finally{i?.[Symbol.dispose]?.()}}}class Fc extends va{gS;constructor(t,e,s){super(t,e),this.gS=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this.gS).width}paint(t,e,s){if(!this.renderer.staff.isFirstInSystem)return;const i=kh.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=it.Top,s.font=i.barNumberFont,s.fillText(this.gS,t+this.x,e+this.y),s.textBaseline=n}finally{i?.[Symbol.dispose]?.()}}}class Ac extends Zh{firstLineY=0;wS=!1;tupletSize=0;get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const t=this.lineOffset*(this.heightLineCount-1),e=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(t-e)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(at.Tuplet0),super.doLayout()}getLineY(t){return this.firstLineY+this.getLineHeight(t)}getLineHeight(t){return this.lineOffset*t}paintBackground(t,e,s){super.paintBackground(t,e,s),this.paintStaffLines(t,e,s),this.paintSimileMark(t,e,s)}paintStaffLines(t,e,s){const i=kh.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const i=[];for(let t=0,e=this.drawnLineCount;t<e;t++)i.push([]);this.additionalMultiRestBars||this.collectSpaces(i);for(const t of i)t.sort((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0);const n=this.width,r=this.smuflMetrics.staffLineThickness/2;for(let a=0;a<this.drawnLineCount;a++){const h=this.getLineY(a)-r;let o=0;for(const n of i[a])s.fillRect(t+this.x+o,e+this.y+h,n[0]-o,this.smuflMetrics.staffLineThickness),o=n[0]+n[1];s.fillRect(t+this.x+o,e+this.y+h,n-o,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(t){}createStartSpacing(){if(this.wS)return;const t=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new Sc(0,0,t)),this.wS=!0}paintTuplets(t,e,s,i,n=!1){for(const r of this.bar.voices)if(this.hasVoiceContainer(r)){const a=this.getVoiceContainer(r);for(const r of a.tupletGroups)this.yS(t+this.beatGlyphsStart,e,s,r,i,n)}}getTupletBeamDirection(t){return this.getBeamDirection(t)}yS(t,e,s,i,n,r){const a=this.resources,h=s.textAlign,o=s.textBaseline;let c;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=st.Center,s.textBaseline=it.Middle;const l=i.beats[0].tupletNumerator,u=i.beats[0].tupletDenominator;if(2===l&&3===u)c=[at.Tuplet2];else if(3===l&&2===u)c=[at.Tuplet3];else if(4===l&&6===u)c=[at.Tuplet4];else if(5===l&&4===u)c=[at.Tuplet5];else if(6===l&&4===u)c=[at.Tuplet6];else if(7===l&&4===u)c=[at.Tuplet7];else if(9===l&&8===u)c=[at.Tuplet9];else if(10===l&&8===u)c=[at.Tuplet1,at.Tuplet0];else if(11===l&&8===u)c=[at.Tuplet1,at.Tuplet1];else if(12===l&&8===u)c=[at.Tuplet1,at.Tuplet2];else if(13===l&&8===u)c=[at.Tuplet1,at.Tuplet3];else{c=[];const t=at.Tuplet0;l>10?(c.push(t+Math.floor(l/10)),c.push(t+(l-10))):c.push(t+l),c.push(at.TupletColon),u>10?(c.push(t+Math.floor(u/10)),c.push(t+(u-10))):c.push(t+u)}const d=this.tupletOffset,f=this.tupletSize,p=kh.beat(s,n,i.beats[0]);try{const n=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){const n=i.beats[0],h=i.beats[i.beats.length-1];let o=null,l=null;for(let t=0;t<i.beats.length;t++)if(!i.beats[t].isRest){o=i.beats[t];break}for(let t=i.beats.length-1;t>=0;t--)if(!i.beats[t].isRest){l=i.beats[t];break}let u=!1;o||(o=n,u=!0),l||(l=h);const p=this.getBeatX(n,ah.OnNotes)-this.beatGlyphsStart,b=this.getBeatX(h,ah.PostNotes)-this.beatGlyphsStart,m=this.helpers.beamHelperLookup[i.voice.index].get(o.index),g=this.helpers.beamHelperLookup[i.voice.index].get(l.index),w=this.getTupletBeamDirection(m);let y=this.calculateBeamYWithDirection(m,p,w),k=this.calculateBeamYWithDirection(g,b,w);u&&(y=Math.max(y,k),k=y);const S=d+.5*f;w===At.Down?(y+=S,k+=S):(y-=S,k-=S);const B=c.reduce((t,e)=>t+a.engravingSettings.glyphWidths.get(e),0),_=.5*a.engravingSettings.oneStaffSpace,x=(p+b)/2,T=x-B/2-_,M=x+B/2+_,v=(k-y)/(b-p),N=y-v*p,P=v*T+N,E=v*x+N,C=v*M+N,F=w===At.Down?y-.5*f:y+.5*f,A=w===At.Down?k-.5*f:k+.5*f,D=s.lineWidth%2==0?0:.5;t+=D,e+=D,T>p&&(s.beginPath(),s.moveTo(t+this.x+p,e+this.y+F),r?s.quadraticCurveTo(t+this.x+(T+p)/2,e+this.y+P,t+this.x+T,e+this.y+P):(s.lineTo(t+this.x+p,e+this.y+y),s.lineTo(t+this.x+T,e+this.y+P)),s.moveTo(t+this.x+M,e+this.y+C),r?s.quadraticCurveTo(t+this.x+(b+M)/2,e+this.y+C,t+this.x+b,e+this.y+A):(s.lineTo(t+this.x+b,e+this.y+k),s.lineTo(t+this.x+b,e+this.y+A)),s.stroke()),s.fillMusicFontSymbols(t+this.x+x,e+this.y+E+.5*f,1,c,!0)}else for(const n of i.beats){const r=this.helpers.beamHelperLookup[i.voice.index].get(n.index);if(!r)continue;const a=this.getTupletBeamDirection(r),h=r.getBeatLineX(n);let o=this.calculateBeamYWithDirection(r,h,a);a===At.Down?o+=d+f:o-=d+f,s.fillMusicFontSymbols(t+this.x+h,e+this.y+o,1,c,!0)}s.textAlign=h,s.textBaseline=o,s.lineWidth=n}finally{p?.[Symbol.dispose]?.()}}paintBeams(t,e,s,i,n){for(const r of this.helpers.beamHelpers)for(const a of r)this.kS(t+this.beatGlyphsStart,e,s,a,i,n)}drawBeamHelperAsFlags(t){return 1===t.beats.length}kS(t,e,s,i,n,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isRestBeamHelper||(this.drawBeamHelperAsFlags(i)?this.paintFlag(t,e,s,i,n):this.paintBar(t,e,s,i,r))}shouldPaintFlag(e,s){return e.graceType!==u.BendGrace&&(!e.deadSlapped&&(!!s.hasBeatLineX(e)&&((e.graceType===u.None||this.settings.notation.notationMode!==t.NotationMode.SongBook)&&(e.duration!==l.Whole&&e.duration!==l.DoubleWhole&&e.duration!==l.QuadrupleWhole))))}paintFlag(t,e,s,i,n){for(const r of i.beats){if(!this.shouldPaintFlag(r,i))continue;const a=r.graceType!==u.None,h=i.getBeatLineX(r),o=this.getBeamDirection(i),c=e+this.y+this.getFlagTopY(r,o),l=e+this.y+this.getFlagBottomY(r,o);let d=0;if(d=o===At.Down?l:c,!i.hasLine(!0,r))continue;this.paintBeamingStem(r,e+this.y,t+this.x+h,c,l,s);const f=kh.beat(s,n,r);try{let e=0;if(i.hasFlag(!0,r)){const i=new Fa(t+this.x+h,d,r.duration,o,a);i.renderer=this,i.doLayout(),i.paint(0,0,s),e=i.width/2}r.graceType===u.BeforeBeat&&(o===At.Down?Lt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+l-this.smuflMetrics.glyphHeights.get(at.GraceNoteSlashStemDown))/2,Ca.GraceScale,at.GraceNoteSlashStemDown,!0):Lt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+l+this.smuflMetrics.glyphHeights.get(at.GraceNoteSlashStemUp))/2,Ca.GraceScale,at.GraceNoteSlashStemUp,!0))}finally{f?.[Symbol.dispose]?.()}}}getFlagStemSize(t,e=!1){let s=0;switch(t){case l.QuadrupleWhole:case l.Half:case l.Quarter:case l.Eighth:case l.Sixteenth:case l.ThirtySecond:case l.SixtyFourth:case l.OneHundredTwentyEighth:case l.TwoHundredFiftySixth:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(t);break;default:s=e?this.smuflMetrics.standardStemLength:0}return s}recreatePreBeatGlyphs(){this.wS=!1,super.recreatePreBeatGlyphs()}calculateBeamY(t,e){return this.calculateBeamYWithDirection(t,e,this.getBeamDirection(t))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new Ec(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new Fc(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();const t=this.lastBar;this.addPostBeatGlyph(new Ec(!0)),t.masterBar.isRepeatEnd&&t.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Cc(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(t,e,s,i,n){const r=this.getBeamDirection(i),a=i.graceType!==u.None?Ca.GraceScale:1;let h=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*a,o=this.smuflMetrics.beamThickness*a;r===At.Down&&(h=-h,o=-o);for(let c=0,l=i.beats.length;c<l;c++){const l=i.beats[c];if(!i.hasBeatLineX(l)||l.deadSlapped)continue;const u=i.getBeatLineX(l),d=e+this.y+this.getBarLineStart(l,r),f=e+this.y+this.calculateBeamY(i,u)|0;d<f?this.paintBeamingStem(l,e+this.y,t+this.x+u,d,f,s):this.paintBeamingStem(l,e+this.y,t+this.x+u,f,d,s);const p=kh.beat(s,n,l);try{const n=this.smuflMetrics.brokenBeamWidth*a,r=Ht.getIndex(l.duration)-2,d=e+this.y;for(let e=0;e<r;e++){let a=0,f=0,p=0,b=0;const m=d+e*h;if(c<i.beats.length-1){const h=Th.isFullBarJoin(l,i.beats[c+1],e);if(e===r-1&&h&&l.beamingMode===wt.ForceSplitOnSecondaryToNext)a=u,f=a+n,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Ac.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o),f=i.getBeatLineX(i.beats[c+1]),a=f-n,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Ac.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o);else{if(h)a=u,f=i.getBeatLineX(i.beats[c+1]);else{if(0!==c&&Th.isFullBarJoin(i.beats[c-1],l,e))continue;a=u,f=a+n}p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),0===e&&(p|=0,b|=0),Ac.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o)}}else c>0&&!Th.isFullBarJoin(l,i.beats[c-1],e)&&(a=u-n,f=u,f=u,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Ac.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o))}}finally{p?.[Symbol.dispose]?.()}}if(i.graceType===u.BeforeBeat){const n=i.getBeatLineX(i.beats[0]),a=this.smuflMetrics.glyphWidths.get(at.Flag8thUp)*Ca.GraceScale;let c=e+this.y+this.calculateBeamY(i,n)|0;c+=o+h,r===At.Down?Lt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Ca.GraceScale,at.GraceNoteSlashStemDown,!0):Lt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Ca.GraceScale,at.GraceNoteSlashStemUp,!0)}}static paintSingleBar(t,e,s,i,n,r){t.beginPath(),t.moveTo(e,s),t.lineTo(i,n),t.lineTo(i,n+r),t.lineTo(e,s+r),t.closePath(),t.fill()}}class Dc extends va{startBeat;endBeat;yOffset=0;forEnd;startNoteRenderer=null;endNoteRenderer=null;tieDirection=At.Up;constructor(t,e,s){super(0,0),this.startBeat=t,this.endBeat=e,this.forEnd=s}SS=0;BS=0;_S=0;xS=0;TS=0;MS=!1;doLayout(){if(this.width=0,!this.endBeat)return void(this.MS=!1);const t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=t;const e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=e,this.SS=0,this._S=0,this.BS=0,this.xS=0,this.height=0,this.MS=!1,this.tieDirection=t?this.getBeamDirection(this.startBeat,t):this.getBeamDirection(this.endBeat,e),!this.forEnd&&t?(t!==e?(this.SS=t.x+this.getStartX(),this.BS=t.y+this.getStartY()+this.yOffset,e&&t.staff===e.staff?(this._S=e.x+this.getEndX(),this.xS=e.y+this.getEndY()+this.yOffset):(this._S=t.x+t.width,this.xS=this.BS)):(this.SS=t.x+this.getStartX(),this._S=e.x+this.getEndX(),this.BS=t.y+this.getStartY()+this.yOffset,this.xS=e.y+this.getEndY()+this.yOffset),this.MS=!0):t&&t.staff===e.staff||(this.SS=e.x,this._S=e.x+this.getEndX(),this.BS=e.y+this.getEndY()+this.yOffset,this.xS=this.BS,this.MS=!0),this.MS)if(this.y=Math.min(this.BS,this.xS),this.shouldDrawBendSlur())this.TS=0;else{this.TS=this.getTieHeight(this.SS,this.BS,this._S,this.xS);const t=Dc.calculateActualTieHeight(1,this.SS,this.BS,this._S,this.xS,this.tieDirection===At.Down,this.TS,this.renderer.smuflMetrics.tieMidpointThickness);if(this.height=t.h,this.tieDirection===At.Up){const e=this.y-t.y;e>0&&(this.y-=e)}}}paint(t,e,s){this.MS&&(this.shouldDrawBendSlur()?Dc.drawBendSlur(s,t+this.SS,e+this.BS,t+this._S,e+this.xS,this.tieDirection===At.Down,1,this.renderer.smuflMetrics.tieHeight):Dc.paintTie(s,1,t+this.SS,e+this.BS,t+this._S,e+this.xS,this.tieDirection===At.Down,this.TS,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(t,e,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(t,e){return At.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(t,e,s,i,n,r,a,h){const o=Dc.vS(t,e,s,i,n,r,a,h);e=o[0],s=o[1];const c=o[2],l=o[3];i=o[6],n=o[7];const u=(e-c)/(e-2*c+i),d=Dc.NS(e,s,c,l,i,n,u),f=d.length>0?Math.min(e,i,d[0]):Math.min(e,i),p=d.length>0?Math.max(e,i,d[0]):Math.max(e,i),b=(s-l)/(s-2*l+n),m=Dc.NS(e,s,c,l,i,n,b),g=m.length>0?Math.min(s,n,m[1]):Math.min(s,n),w=m.length>0?Math.max(s,n,m[1]):Math.max(s,n),y=new Pe;return y.x=f,y.y=g,y.w=p-f,y.h=w-g,y}static NS(t,e,s,i,n,r,a){if(a<=0||1<=a)return[];const h=t+(s-t)*a,o=e+(i-e)*a;return[h+(s+(n-s)*a-h)*a,o+(i+(r-i)*a-o)*a]}static vS(t,e,s,i,n,r,a,h){if(e===i&&s===n)return[];if(i<e){let t=e;e=i,i=t,t=s,s=n,n=t}a*=t,h*=t,r&&(a*=-1,h*=-1),t>=1&&(h*=1.2);const o=n-s,c=i-e,l=Math.sqrt(c*c+o*o);let u=e+.25*l,d=s-a,f=e+.75*l,p=s-a,b=e+.75*l,m=s-a-h,g=e+.25*l,w=s-a-h;const y=Math.atan2(o,c);return[u,d]=Dc.PS(u,d,e,s,y),[f,p]=Dc.PS(f,p,e,s,y),[b,m]=Dc.PS(b,m,e,s,y),[g,w]=Dc.PS(g,w,e,s,y),[e,s,u,d,f,p,i,n,b,m,g,w,e,s]}static PS(t,e,s,i,n){const r=t-s,a=e-i;return[s+(r*Math.cos(n)-a*Math.sin(n)),i+(r*Math.sin(n)+a*Math.cos(n))]}static paintTie(t,e,s,i,n,r,a,h,o){const c=Dc.vS(e,s,i,n,r,a,h,o);t.beginPath(),t.moveTo(c[0],c[1]),t.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]),t.bezierCurveTo(c[8],c[9],c[10],c[11],c[12],c[13]),t.closePath(),t.fill()}static drawBendSlur(t,e,s,i,n,r,a,h,o){let c=n-s,l=i-e;const u=Math.sqrt(c*c+l*l);r?c*=-1:l*=-1,c/=u,l/=u;let d=h*a;i-e<20&&(d/=2);const f=(i+e)/2+d*c,p=(n+s)/2+d*l;if(t.beginPath(),t.moveTo(e,s),t.lineTo(f,p),t.lineTo(i,n),t.stroke(),o){const e=t.measureText(o).width,s=r?0:-t.font.size;t.fillText(o,f-e/2,p+s)}}}class Lc extends Dc{startNote;endNote;constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}get ES(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return At.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,oh.Top)}getEndY(){return this.getStartY()}getStartX(){return this.ES?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,ch.Center)}getEndX(){return this.ES?this.endNoteRenderer.getNoteX(this.endNote,ch.Left):this.endNoteRenderer.getNoteX(this.endNote,ch.Center)}}class Wc extends Dc{startNote;endNote;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}get ES(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.ES?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return this.ES?At.Up:Wc.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?At.Up:At.Down}getStartY(){return this.ES?this.startNoteRenderer.getNoteY(this.startNote,oh.Center):this.tieDirection===At.Up?this.startNoteRenderer.getNoteY(this.startNote,oh.Top):this.startNoteRenderer.getNoteY(this.startNote,oh.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.ES?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,ch.Center)}getEndX(){return this.ES?this.endNoteRenderer.getNoteX(this.endNote,ch.Left):this.endNoteRenderer.getNoteX(this.endNote,ch.Center)}}class Rc extends Wc{CS;FS;constructor(t,e,s,i=!1){super(t,e,i),this.CS=At.Up,this.FS=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.FS!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;switch(this.CS){case At.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case At.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),n=this.getBeamDirection(this.startBeat,i),r=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${n}`,a=this.renderer;a.staff.getSharedLayoutData(r,!1)||(a.staff.setSharedLayoutData(r,!0),super.paint(t,e,s))}}class Oc extends Aa{AS=[];createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible){const e=new Lc(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination){const e=new Lc(t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new Lc(t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.AS)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new Rc(t,t.effectSlurDestination,!1,!1);this.AS.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.AS)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new Rc(t.effectSlurOrigin,t,!1,!0);this.AS.push(e),this.addTie(e)}}}}}class Ic extends va{DS;ge;gS;constructor(t,e,s,i,n){super(t,e),this.DS=i,this.gS=s,this.ge=n}paint(t,e,s){const i=this.ge.isRest?kh.beat(s,yt.NumberedRests,this.ge):this.ge.notes.length>0?kh.note(s,ut.NumberedNumber,this.ge.notes[0]):void 0;try{const i=this.renderer.resources;s.font=this.DS?i.numberedNotationGraceFont:i.numberedNotationFont,s.textBaseline=it.Middle,s.textAlign=st.Left,s.fillText(this.gS.toString(),t+this.x,e+this.y)}finally{i?.[Symbol.dispose]?.()}}doLayout(){const t=this.renderer.resources,e=this.DS?t.numberedNotationGraceFont:t.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=e;const i=s.measureText(`${this.gS}`);this.height=i.height,this.width=i.width}}class Gc{x=0;y=-3e3;width=0}class $c extends wh{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((t,e)=>t.y<e.y?-1:t.y>e.y?1:0);const t=[];t.push(new Gc);for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.renderer=this.renderer,s.doLayout();let i=0;for(;t[i].y>s.y;)i++,i===t.length&&t.push(new Gc);s.x=i,t[i].y=s.y+s.height,t[i].width<s.width&&(t[i].width=s.width)}this.width=0;const e=this.renderer.smuflMetrics.accidentalPadding;for(const s of t)this.width+=s.width+e,s.x=this.width;for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e],i=t[s.x];s.x=this.width-i.x}}}class Vc extends Pa{constructor(t,e,s,i){super(t,e,i,Vc.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case ht.Natural:return at.AccidentalNatural;case ht.Sharp:return at.AccidentalSharp;case ht.Flat:return at.AccidentalFlat;case ht.NaturalQuarterNoteUp:return at.AccidentalQuarterToneSharpNaturalArrowUp;case ht.SharpQuarterNoteUp:return at.AccidentalThreeQuarterTonesSharpArrowUp;case ht.FlatQuarterNoteUp:return at.AccidentalQuarterToneFlatArrowUp;case ht.DoubleSharp:return at.AccidentalDoubleSharp;case ht.DoubleFlat:return at.AccidentalDoubleFlat}return at.None}}class Hc extends Pa{constructor(t,e){super(t,e,1,at.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class Uc extends va{ge;constructor(t,e,s){super(t,e),this.ge=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(t,e,s){const i=kh.beat(s,yt.NumberedDuration,this.ge);try{const i=this.renderer.smuflMetrics.numberedDashGlyphPadding;s.fillRect(t+this.x,Math.ceil(e+this.y-this.height),this.width-i,this.height)}finally{i?.[Symbol.dispose]?.()}}}class zc extends va{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(at.NoteheadSlashWhiteHalf)}paint(t,e,s){const i=this.renderer,n=i.getLineHeight(i.heightLineCount-1),r=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-n/2,a=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(t+this.x,e+r),s.lineTo(t+this.x+this.width,e+r+n),s.moveTo(t+this.x,e+r+n),s.lineTo(t+this.x+this.width,e+r),s.stroke(),s.lineWidth=a}}class jc extends Jh{isNaturalizeAccidental=!1;accidental=ht.None;get effectElement(){return yt.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const t=new $c;if(t.renderer=this.renderer,this.container.beat.notes.length>0){const e=this.container.beat.notes[0],s=e?e.accidentalMode:b.Default,i=fi.getNoteValue(e);let n=Ht.computeAccidental(this.renderer.bar.keySignature,s,i,e.hasQuarterToneOffset);if(n===ht.Natural){n=this.renderer.bar.keySignature+7<7?ht.Sharp:ht.Flat,this.isNaturalizeAccidental=!0}if(n!==ht.None){this.accidental=n;const s=this.renderer,i=kh.noteColor(s.resources,ut.NumberedAccidentals,e),r=new Vc(0,s.getLineY(0),n,e.beat.graceType!==u.None?Ca.GraceScale*Ca.GraceScale:Ca.GraceScale);r.colorOverride=i,r.renderer=this.renderer,t.addGlyph(r),this.addNormal(t),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}class Xc extends qh{noteHeads=null;deadSlapped=null;octaveDots=0;get effectElement(){return yt.NumberedEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case ch.Left:break;case ch.Center:t+=s.width/2;break;case ch.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new Ce;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Pe,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(){return this.LS(oh.Center)}getHighestNoteY(){return this.LS(oh.Center)}getNoteY(t,e){return this.LS(e)}LS(t){let e=null;if(this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e){let s=this.y+e.y;switch(t){case oh.Top:case oh.TopWithStem:s-=e.height/2;break;case oh.Center:break;case oh.Bottom:case oh.BottomWithStem:s+=e.height/2;case oh.StemUp:case oh.StemDown:}return s}return 0}updateBeamingHelper(){if(this.beamingHelper){let t=null;this.noteHeads?t=this.noteHeads:this.deadSlapped&&(t=this.deadSlapped),t&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+t.x,this.container.x+this.x+t.x+t.width)}}static majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61];static minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];doLayout(){const t=this.renderer;t.shortestDuration<this.container.beat.duration&&(t.shortestDuration=this.container.beat.duration);const e=t.getLineY(t.getNoteLine());if(!this.container.beat.isEmpty){let s="0";if(this.container.beat.notes.length>0){const e=this.renderer.bar.keySignatureType,i=this.renderer.bar.keySignature,n=i+7,r=(e===F.Minor?Xc.minorKeySignatureOneValues:Xc.majorKeySignatureOneValues)[n],a=this.container.beat.notes[0];if(a.isDead)s="X";else{const e=a.displayValue-r,h=e<0?(e%12+12)%12:e%12;let o=e<0?(Math.abs(e)+12)/12|0:e/12|0;e<0&&(o*=-1),this.octaveDots=o,t.registerOctave(o);let c=(Ht.keySignatureIsSharp(i)||Ht.keySignatureIsNatural(i)?fi.flatNoteSteps:fi.sharpNoteSteps)[h]+1;Ht.accidentalNotes[h]&&!this.container.preNotes.isNaturalizeAccidental&&(n<7?c++:c--),s=c.toString()}}if(this.container.beat.deadSlapped){const t=new zc;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else{const t=this.container.beat.graceType!==u.None,i=new Ic(0,e,s,t,this.container.beat);this.noteHeads=i,this.addNormal(i)}if(this.container.beat.dots>0&&this.container.beat.duration>=l.Quarter)for(let e=0;e<this.container.beat.dots;e++){const e=new Hc(0,t.getLineY(0));e.renderer=this.renderer,this.addEffect(e)}let i=0;switch(this.container.beat.duration){case l.QuadrupleWhole:i=16;break;case l.DoubleWhole:i=8;break;case l.Whole:i=4;break;case l.Half:i=2}let n=i;for(let t=0;t<this.container.beat.dots;t++)n=n/2|0,i+=n;for(let e=0;e<i-1;e++){const e=new Uc(0,t.getLineY(0),this.container.beat);e.renderer=this.renderer,this.addNormal(e)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class Jc extends va{WS;colorOverride;constructor(t){super(0,0),this.WS=t}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this.WS?Dc.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y+this.height,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):Dc.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class qc extends wh{RS=0;OS=0;IS;GS;barSubElement=D.StandardNotationTimeSignature;constructor(t,e,s,i,n,r){super(t,e),this.RS=s,this.OS=i,this.IS=n,this.GS=r}paint(t,e,s){const i=kh.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this.IS&&2===this.RS&&2===this.OS){const t=new Pa(0,0,this.commonScale,at.TimeSigCutCommon);this.addGlyph(t),super.doLayout()}else if(this.IS&&4===this.RS&&4===this.OS){const t=new Pa(0,0,this.commonScale,at.TimeSigCommon);this.addGlyph(t),super.doLayout()}else{const t=new Yh(0,0,this.RS,it.Top,this.numberScale),e=new Yh(0,0,this.OS,it.Bottom,this.numberScale);this.addGlyph(t),this.addGlyph(e),super.doLayout();const s=this.width;t.x=(s-t.width)/2,e.x=(s-e.width)/2,this.width=Math.max(t.x+t.width,e.x+e.width)}if(this.GS){const t=2*this.renderer.smuflMetrics.oneStaffSpace,e=new Jc(!0);e.renderer=this.renderer,e.y=-t,e.height=2*t,e.doLayout();for(const t of this.glyphs)t.x+=e.width;this.width+=e.width,this.addGlyph(e);const s=new Jc(!1);s.renderer=this.renderer,s.x=this.width,s.y=-t,s.height=2*t,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class Yc extends qc{get commonScale(){return 1}get numberScale(){return 1}}class Kc extends va{$S;VS;Tk="";HS=ht.None;US=0;constructor(t,e,s,i){super(t,e),this.$S=s,this.VS=i}doLayout(){super.doLayout();const t="1 = ";let e="",s=ht.None;switch(this.VS){case F.Major:switch(this.$S){case C.Cb:e="  C",s=ht.Flat;break;case C.Gb:e="  G",s=ht.Flat;break;case C.Db:e="  D",s=ht.Flat;break;case C.Ab:e="  A",s=ht.Flat;break;case C.Eb:e="  E",s=ht.Flat;break;case C.Bb:e="  B",s=ht.Flat;break;case C.F:e="F";break;case C.C:e="C",s=ht.None;break;case C.G:e="G",s=ht.None;break;case C.D:e="D",s=ht.None;break;case C.A:e="A",s=ht.None;break;case C.E:e="E",s=ht.None;break;case C.B:e="B",s=ht.None;break;case C.FSharp:e="  F",s=ht.Sharp;break;case C.CSharp:e="  C",s=ht.Sharp}break;case F.Minor:switch(this.$S){case C.Cb:e="  a",s=ht.Flat;break;case C.Gb:e="  e",s=ht.Flat;break;case C.Db:e="  b",s=ht.Flat;break;case C.Ab:e="f",s=ht.None;break;case C.Eb:e="c",s=ht.None;break;case C.Bb:e="g",s=ht.None;break;case C.F:e="d";break;case C.C:e="a",s=ht.None;break;case C.G:e="e",s=ht.None;break;case C.D:e="b",s=ht.None;break;case C.A:e="  f",s=ht.Sharp;break;case C.E:e="  c",s=ht.Sharp;break;case C.B:e="  g",s=ht.Sharp;break;case C.FSharp:e="  d",s=ht.Sharp;break;case C.CSharp:e="  a",s=ht.Sharp}}this.Tk=t+e,this.HS=s;const i=this.renderer.scoreRenderer.canvas,n=this.renderer.resources;i.font=n.numberedNotationFont,this.US=i.measureText(t).width,this.width=i.measureText(t+e).width}paint(t,e,s){const i=kh.bar(s,D.NumberedKeySignature,this.renderer.bar);try{const i=this.renderer.resources;s.font=i.numberedNotationFont,s.textBaseline=it.Middle,s.fillText(this.Tk,t+this.x,e+this.y),this.HS!==ht.None&&Lt.fillMusicFontSymbolSafe(s,t+this.x+this.US,e+this.y,1,Vc.getMusicSymbol(this.HS),!1)}finally{i?.[Symbol.dispose]?.()}}}class Qc extends Ac{static StaffId="numbered";simpleWhammyOverflow=0;zS;shortestDuration=l.QuadrupleWhole;lowestOctave=null;highestOctave=null;get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(at.AugmentationDot)}registerOctave(t){null===this.lowestOctave?(this.lowestOctave=t,this.highestOctave=t):(t<this.lowestOctave&&(this.lowestOctave=t),t>this.highestOctave&&(this.highestOctave=t))}get repeatsBarSubElement(){return D.NumberedRepeats}get barNumberBarSubElement(){return D.NumberedBarNumber}get barLineBarSubElement(){return D.NumberedBarLines}get staffLineBarSubElement(){return D.NumberedStaffLine}constructor(t,e){super(t,e),this.zS=!e.staff.showSlash&&!e.staff.showTablature&&!e.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,yt.NumberedDuration,yt.NumberedDuration),this.paintTuplets(t,e,s,yt.NumberedTuplet,!0)}doLayout(){super.doLayout();let t=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)){if(this.getVoiceContainer(e).tupletGroups.length>0){t=!0;break}}if(t&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){const t=Ht.getIndex(this.shortestDuration)-2,e=this.dotSpacing;if(t>0){const s=(t-1)*this.smuflMetrics.numberedBarRendererBarSpacing+this.smuflMetrics.numberedBarRendererBarSize;let i=0;const n=this.lowestOctave;null!==n&&(i=Math.abs(n)*e+this.smuflMetrics.glyphHeights.get(at.AugmentationDot)),this.registerOverflowBottom(s+i)}const s=this.highestOctave;if(null!==s){const t=Math.abs(s)*e+this.smuflMetrics.glyphHeights.get(at.AugmentationDot);this.registerOverflowTop(t)}}}paintFlag(t,e,s,i,n){this.paintBar(t,e,s,i,n)}paintBar(t,e,s,i,n){if(0===i.beats.length)return;const r=this.resources;for(let a=0,h=i.beats.length;a<h;a++){const h=i.beats[a],o=kh.beat(s,n,h);try{const n=this.smuflMetrics.numberedBarRendererBarSpacing,o=this.smuflMetrics.numberedBarRendererBarSize,c=Ht.getIndex(h.duration)-2,l=e+this.y,u=this.getBeatX(h,ah.PreNotes)-this.beatGlyphsStart,d=this.calculateBeamY(i,u);for(let e=0;e<c;e++){let r=0,c=0,f=0;const p=l+e*n;a===i.beats.length-1?(r=u,c=this.getBeatX(h,ah.PostNotes)-this.beatGlyphsStart):(r=u,c=this.getBeatX(i.beats[a+1],ah.PreNotes)-this.beatGlyphsStart),f=p+d,s.fillRect(t+this.x+r,f,c-r,o)}const f=this.getBeatContainer(h).onNotes;let p=f instanceof Xc?f.octaveDots:0;const b=this.dotSpacing;let m=0,g=0;p>0?(m=l+this.getLineY(0)-r.numberedNotationFont.size,g=-1*b):p<0&&(m=l+d+c*(n+o),g=b);const w=this.getBeatX(h,ah.MiddleNotes)-this.beatGlyphsStart;p=Math.abs(p);for(let e=0;e<p;e++)Lt.fillMusicFontSymbolSafe(s,t+this.x+w,m,1,at.AugmentationDot,!0),m+=g}finally{o?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+1.5*this.resources.numberedNotationFont.size}getFlagTopY(t,e){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(t,e){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(t){return At.Down}getTupletBeamDirection(t){return At.Up}getNoteY(t,e){let s=super.getNoteY(t,e);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(t,e,s){const i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size}getBarLineStart(t,e){const s=this.smuflMetrics.glyphHeights.get(at.NoteheadBlack);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this.zS)&&this.addPreBeatGlyph(new Ec(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new Fc(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){this.bar.previousBar&&this.bar.keySignature===this.bar.previousBar.keySignature||(this.createStartSpacing(),this.jS()),this.zS&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.XS())}jS(){this.addPreBeatGlyph(new Kc(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}XS(){this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new Yc(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=D.NumberedTimeSignature,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this.zS&&super.createPostBeatGlyphs()}createVoiceGlyphs(t){for(const e of t.beats){const s=new Oc(e,this.getVoiceContainer(t));s.preNotes=0===t.index?new jc:new Jh,s.onNotes=0===t.index?new Xc:new qh,this.addBeatGlyph(s)}}paintBeamingStem(t,e,s,i,n,r){}}class Zc extends gh{get staffId(){return Qc.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Qc(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class tl extends Pa{JS;qS;constructor(t,e,s,i){super(t,e,1,tl.Fk(s,i)),this.JS=s,this.qS=i}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(at.GClef),this.offsetX=this.width/2}static Fk(t,e){switch(t){case P.Neutral:return at.UnpitchedPercussionClef1;case P.C3:case P.C4:return e===m.T?at.CClef8vb:at.CClef;case P.F4:switch(e){case m.S:return at.FClef15ma;case m._:return at.FClef8va;case m.T:return at.FClef8vb;case m.M:return at.FClef15mb;default:return at.FClef}case P.G2:switch(e){case m.S:return at.GClef15ma;case m._:return at.GClef8va;case m.T:return at.GClef8vb;case m.M:return at.GClef15mb;default:return at.GClef}default:return at.None}}paint(t,e,s){const i=kh.bar(s,D.StandardNotationClef,this.renderer.bar);try{switch(super.paint(t,e,s),this.JS){case P.C3:case P.C4:if(this.qS===m.T)return;break;case P.F4:case P.G2:return}let i,n=!1;switch(this.qS){case m.S:i=at.Clef15,n=!0;break;case m._:i=at.Clef8,n=!0;break;case m.T:i=at.Clef8;break;case m.M:i=at.Clef15;break;default:return}const r=this.width/2,a=n?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(i);Lt.fillMusicFontSymbolSafe(s,t+this.x+r,e+this.y-a,1,i,!0)}finally{i?.[Symbol.dispose]?.()}}}class el extends Na{xe;constructor(t,e,s){super(t,e),this.xe=s}static Fk(t,e){switch(t){case d.None:return at.None;case d.Normal:return e?at.ArticAccentAbove:at.ArticAccentBelow;case d.Heavy:return e?at.ArticMarcatoAbove:at.ArticMarcatoBelow;case d.Tenuto:return e?at.ArticTenutoAbove:at.ArticTenutoBelow;default:return at.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(at.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(at.ArticAccentAbove)}paint(t,e,s){const i=this.renderer.getBeatDirection(this.xe.beat),n=el.Fk(this.xe.accentuated,i===At.Down),r=i===At.Up?e+this.y:e+this.y+this.height;Lt.fillMusicFontSymbolSafe(s,t+this.x,r,1,n,!0)}}class sl extends Pa{constructor(t,e,s){super(t,e,s?Ca.GraceScale:1,at.NoteheadXOrnate)}}class il extends Pa{constructor(t,e,s,i){super(t,e,i?Ca.GraceScale:1,il.Fk(s))}static Fk(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:case l.Whole:case l.Half:return at.NoteheadDiamondWhiteWide;default:return at.NoteheadDiamondBlackWide}}}class nl{line=0;isGhost;color;constructor(t,e,s){this.line=t,this.isGhost=e,this.color=s}}class rl extends va{WS;dk=[];YS=[];isEmpty=!0;constructor(t){super(0,0),this.WS=t}addParenthesis(e){const s=this.renderer,i=s.getNoteLine(e),n=e.isGhost||this.KS(e)&&s.settings.notation.isNotationElementVisible(t.NotationElement.ParenthesisOnTiedBends),r=kh.noteColor(s.resources,ut.Effects,e);this.QS(new nl(i,n,r))}addParenthesisOnLine(t,e){const s=new nl(t,e,void 0);this.QS(s)}QS(t){this.dk.push(t),t.isGhost&&(this.isEmpty=!1)}KS(t){return!!t.isTieDestination&&(!!t.tieOrigin.hasBend||this.KS(t.tieOrigin))}doLayout(){const t=this.renderer;this.dk.sort((t,e)=>t.line-e.line);let e=null;const s=t.getScoreHeight(1);for(let i=0,n=this.dk.length;i<n;i++){let n;if(this.dk[i].isGhost)if(e){const n=t.getScoreY(this.dk[i].line)+s;e.height=n-e.y}else n=new Jc(this.WS),n.colorOverride=this.dk[i].color,n.renderer=this.renderer,n.y=t.getScoreY(this.dk[i].line)-s,n.height=2*s,n.doLayout(),this.YS.push(n),e=n;else e=null}this.width=this.YS.length>0?this.YS[0].width:0}paint(t,e,s){super.paint(t,e,s);for(const i of this.YS)i.paint(t+this.x,e+this.y,s)}}class al{glyph;steps=0;constructor(t,e){this.glyph=t,this.steps=e}}class hl extends va{dk=[];minNote=null;maxNote=null;upLineX=0;downLineX=0;noteStartX=0;constructor(){super(0,0)}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(t,e){const s=new al(t,e);this.dk.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this.dk.sort((t,e)=>e.steps-t.steps);let t=0,e=0,s=!0,i=0,n=!1;const r=this.direction,a=this.renderer.smuflMetrics,h=this.scale,o=new Map;for(let r=0,c=this.dk.length;r<c;r++){const c=this.dk[r].glyph;if(c.renderer=this.renderer,c.doLayout(),r>0&&Math.abs(i-this.dk[r].steps)<=1?s?(s=!1,o.set(r,!1)):(n=!0,s=!0,o.set(r,!0)):(s=!1,o.set(r,!1)),a.stemUp.has(c.symbol)){const e=a.stemUp.get(c.symbol).x*h;e>t&&(t=e)}else{const e=a.glyphWidths.get(c.symbol)*h;e>t&&(t=e)}if(a.stemDown.has(c.symbol)){const s=a.stemDown.get(c.symbol).x*h;if(s>e){const i=s-e;e=s,t+=i}}i=this.dk[r].steps}const c=n||r===At.Up?t:e;let l=0;for(let t=0,s=this.dk.length;t<s;t++){const s=this.dk[t].glyph;o.get(t)?s.x=c:(s.x=e,a.stemDown.has(s.symbol)&&(s.x-=a.stemDown.get(s.symbol).x*h)),s.x+=this.noteStartX,l=Math.max(l,s.x+s.width),s instanceof Ca&&s.centerOnStem&&(s.x=c)}n?(this.upLineX=c,this.downLineX=c):(this.upLineX=t,this.downLineX=e),this.width=l}paint(t,e,s){t+=this.x,e+=this.y,this.ZS(t,e,s);const i=this.dk;for(const n of i)n.glyph.renderer=this.renderer,n.glyph.paint(t,e,s)}ZS(t,e,s){if(!this.minNote)return;const i=this.renderer,n=kh.bar(s,D.StandardNotationStaffLine,i.bar,!0);try{const n=this.scale,r=this.renderer.smuflMetrics.legerLineExtension*n,a=this.width-this.noteStartX+2*r,h=i.getLineHeight(1),o=i.getLineY(-1),c=i.getLineY(i.drawnLineCount),l=i.getLineY(this.minNote.steps/2),u=i.getLineY(this.maxNote.steps/2),d=this.renderer.smuflMetrics.legerLineThickness*n/2;let f=o;for(;f>=l;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f-=h;for(f=c;f<=u;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f+=h}finally{n?.[Symbol.dispose]?.()}}}class ol extends Pa{constructor(t,e,s){super(t,e,1,ol.Fk(s))}static Fk(t){switch(t){case l.ThirtySecond:return at.Tremolo3;case l.Sixteenth:return at.Tremolo2;case l.Eighth:return at.Tremolo1;default:return at.None}}}class cl extends hl{tB=new Map;eB=[];sB=null;iB=null;aboveBeatEffects=new Map;belowBeatEffects=new Map;beat;beamingHelper;get direction(){return this.beamingHelper.direction}get scale(){return this.beat.graceType!==u.None?Ca.GraceScale:1}getNoteX(t,e){if(this.tB.has(t.id)){const s=this.tB.get(t.id);let i=this.x+s.x;switch(e){case ch.Left:break;case ch.Center:i+=s.width/2;break;case ch.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this.tB.has(t.id)){const s=this.tB.get(t.id);return this.LS(s,e)}return 0}LS(t,e){let s=this.y+t.y;const i=this.beat.graceType!==u.None?Ca.GraceScale:1;switch(e){case oh.TopWithStem:s-=(this.renderer.smuflMetrics.stemUp.has(t.symbol)?this.renderer.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*i,s-=this.renderer.smuflMetrics.standardStemLength*i;const e=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(e,s);case oh.Top:s-=t.height/2;break;case oh.Center:break;case oh.Bottom:s+=t.height/2;break;case oh.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*i,s+=this.renderer.smuflMetrics.standardStemLength*i;const n=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(n,s);case oh.StemUp:s-=(this.renderer.smuflMetrics.stemUp.has(t.symbol)?this.renderer.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*i;break;case oh.StemDown:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*i}return s}addMainNoteGlyph(t,e,s){super.add(t,s),this.tB.set(e.id,t),this.eB.push(e)}addEffectNoteGlyph(t,e){super.add(t,e)}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.upLineX,t+this.x+this.downLineX)}doLayout(){super.doLayout();const t=this.renderer;this.beat.deadSlapped&&(this.sB=new zc,this.sB.renderer=this.renderer,this.sB.doLayout(),this.width=this.sB.width);let e=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=t.getScoreY(0),e=t.getScoreY(t.heightLineCount)):this.direction===At.Up?(s=this.LS(this.maxNote.glyph,oh.Bottom)+i,e=this.LS(this.minNote.glyph,oh.TopWithStem)-i):(s=this.LS(this.maxNote.glyph,oh.BottomWithStem)+i,e=this.LS(this.minNote.glyph,oh.Top)-i);let n=null,r=null;for(const t of this.aboveBeatEffects.values())t.renderer=this.renderer,t.doLayout(),e-=t.height,t.y=e,(null===n||n>e)&&(n=e),(null===r||r<e)&&(r=e),e-=i;for(const t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout(),t.y=s,(null===n||n>s)&&(n=s),(null===r||r<s)&&(r=s),s+=t.height+i;if(null!==n&&t.registerBeatEffectOverflows(n,r??0),this.beat.isTremolo&&!this.beat.deadSlapped){const t=this.direction;let e=0;if(t===At.Up){e=(this.LS(this.minNote.glyph,oh.TopWithStem)+this.LS(this.minNote.glyph,oh.StemUp))/2}else{e=(this.LS(this.maxNote.glyph,oh.StemDown)+this.LS(this.maxNote.glyph,oh.BottomWithStem))/2}let s=t===At.Up?this.upLineX:this.downLineX;const i=this.beat.tremoloSpeed;this.beat.duration<l.Half&&(s=this.width/2),this.iB=new ol(s,e,i),this.iB.renderer=this.renderer,this.iB.doLayout()}}buildBoundingsLookup(t,e,s){for(const i of this.eB)if(this.tB.has(i.id)){const n=this.tB.get(i.id),r=new Ce;r.note=i,r.noteHeadBounds=new Pe,r.noteHeadBounds.x=e+this.x+n.x,r.noteHeadBounds.y=s+this.y+n.y-n.height/2,r.noteHeadBounds.w=n.width,r.noteHeadBounds.h=n.height,t.addNote(r)}}paint(t,e,s){this.qy(t,e,s),super.paint(t,e,s)}qy(t,e,s){const i=kh.beat(s,yt.StandardNotationEffects,this.beat);try{for(const i of this.aboveBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);for(const i of this.belowBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);this.iB&&this.iB.paint(t,e,s),this.sB&&this.sB.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class ll extends Pa{beamingHelper;constructor(t,e,s){super(t,e,1,ll.getSymbol(s))}static getSymbol(t){switch(t){case l.QuadrupleWhole:return at.RestLonga;case l.DoubleWhole:return at.RestDoubleWhole;case l.Whole:return at.RestWhole;case l.Half:return at.RestHalf;case l.Quarter:return at.RestQuarter;case l.Eighth:return at.Rest8th;case l.Sixteenth:return at.Rest16th;case l.ThirtySecond:return at.Rest32nd;case l.SixtyFourth:return at.Rest64th;case l.OneHundredTwentyEighth:return at.Rest128th;case l.TwoHundredFiftySixth:return at.Rest256th;default:return at.None}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){this.internalPaint(t,e,s,yt.StandardNotationRests)}internalPaint(t,e,s,i){const n=kh.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class ul extends hl{ge;nB=!1;rB=new Map;aB=new $c;hB=null;oB=null;isEmpty=!0;get scale(){return Ca.GraceScale}get direction(){return At.Up}noteHeadOffset=0;constructor(t,e=!1){super(),this.ge=t,this.nB=e,e&&(this.hB=new rl(!0),this.oB=new rl(!1))}containsNoteValue(t){return this.rB.has(t)}getNoteValueY(t){return this.rB.has(t)?this.y+this.rB.get(t).y:0}addGlyph(t,e,s){const i=this.renderer,n=new Ca(0,0,l.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this.ge,t,e,!0),a=i.accidentalHelper.getNoteLineForValue(t,!1);if(n.y=i.getScoreY(a),this.nB&&(this.hB.renderer=this.renderer,this.oB.renderer=this.renderer,this.hB.addParenthesisOnLine(a,!0),this.oB.addParenthesisOnLine(a,!0)),r!==ht.None){const t=new Vc(0,n.y,r,Ca.GraceScale);t.renderer=this.renderer,this.aB.renderer=this.renderer,this.aB.addGlyph(t)}this.rB.set(t,n),this.add(n,a),this.isEmpty=!1}doLayout(){let t=0;this.nB&&(this.hB.x=t,this.hB.renderer=this.renderer,this.hB.doLayout(),t+=this.hB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.aB.isEmpty||(t+=this.aB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.aB.x=t,this.aB.renderer=this.renderer,this.aB.doLayout(),t+=this.aB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=t,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this.nB&&(this.oB.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.oB.renderer=this.renderer,this.oB.doLayout(),this.width+=this.oB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(t,e,s){this.aB.isEmpty||this.aB.paint(t+this.x,e+this.y,s),this.nB&&(this.hB.paint(t+this.x,e+this.y,s),this.oB.paint(t+this.x,e+this.y,s)),super.paint(t,e,s)}}class dl extends va{bendNoteHeads=[];drawBendSlur(t,e,s,i,n,r,a,h){Dc.drawBendSlur(t,e,s,i,n,r,a,this.renderer.smuflMetrics.tieHeight,h)}doLayout(){super.doLayout(),this.width=0;for(const t of this.bendNoteHeads)t.doLayout(),this.width+=t.width}getTieDirection(t,e){return e.getBeatDirection(t)===At.Up?At.Down:At.Up}}class fl extends dl{ge;cB=null;constructor(t){super(0,0),this.ge=t}doLayout(){const e=this.renderer.settings.notation.notationMode;switch(this.ge.whammyBarType){case dt.None:case dt.Custom:case dt.Hold:return;case dt.Dive:case dt.PrediveDive:{const t=new ul(this.ge,!1);this.cB=t,t.renderer=this.renderer;const e=this.ge.whammyBarPoints[this.ge.whammyBarPoints.length-1];for(const s of this.ge.notes)s.isTieOrigin||t.addGlyph(this.lB(s,e),e.value%2!=0,void 0);t.doLayout(),this.bendNoteHeads.push(t)}break;case dt.Dip:if(e===t.NotationMode.SongBook){const t=this.renderer.resources;this.renderer.simpleWhammyOverflow=t.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{const e=new ul(this.ge,!1);if(e.renderer=this.renderer,this.renderer.settings.notation.notationMode===t.NotationMode.GuitarPro){const t=this.ge.whammyBarPoints[1];for(const s of this.ge.notes)e.addGlyph(this.lB(s,this.ge.whammyBarPoints[1]),t.value%2!=0,void 0)}e.doLayout(),this.bendNoteHeads.push(e);const s=new ul(this.ge,!1);if(s.renderer=this.renderer,this.cB=s,this.renderer.settings.notation.notationMode===t.NotationMode.GuitarPro){const t=this.ge.whammyBarPoints[this.ge.whammyBarPoints.length-1];for(const e of this.ge.notes)s.addGlyph(this.lB(e,t),t.value%2!=0,void 0)}s.doLayout(),this.bendNoteHeads.push(s)}case dt.Predive:}super.doLayout()}paint(e,s,i){const n=this.ge;switch(n.whammyBarType){case dt.None:case dt.Custom:return}const r=this.renderer.settings.notation.notationMode,h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),o=kh.beat(i,yt.StandardNotationEffects,n);try{const o=e+h.x+h.getBeatX(n,ah.MiddleNotes),c=this.getTieDirection(n,h);let l=1===this.ge.notes.length?c:At.Up;const u=i.textAlign,d=this.renderer.smuflMetrics.glyphHeights.get(at.NoteheadBlack);for(let u=0;u<n.notes.length;u++){const f=n.notes[u],p=kh.note(i,ut.StandardNotationEffects,f);try{let p=s+h.y;u>0&&u>=(this.ge.notes.length/2|0)&&(l=At.Down),l===At.Down?p+=h.getNoteY(f,oh.Bottom):p+=h.getNoteY(f,oh.Top);let b=e+h.x;n.isLastOfVoice?b+=h.postBeatGlyphsStart:b+=h.getBeatX(n,ah.EndBeat),this.cB&&(b-=this.cB.upLineX);const m=n.whammyStyle===a.Gradual&&0===u?"grad.":"";let g=null;f.isTieOrigin&&(g=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,f.tieDestination.beat.voice.bar),g&&g.staff===h.staff?b=e+g.x+g.getBeatX(f.tieDestination.beat,ah.MiddleNotes):g=null);let w=d*Ca.GraceScale*.5;l===At.Up&&(w=-w);const y=n.whammyBarPoints.length>0?this.lB(f,n.whammyBarPoints[n.whammyBarPoints.length-1]):0;let k=0,S=!1;switch(this.bendNoteHeads.length>0&&this.bendNoteHeads[0].containsNoteValue(y)?(k=this.bendNoteHeads[0].getNoteValueY(y)+w,S=!0):g&&(f.isTieOrigin&&f.tieDestination.beat.hasWhammyBar||f.beat.isContinuedWhammy)?(k=s+g.y+g.getNoteY(f.tieDestination,oh.Top),S=!0,l===At.Down&&(k+=d)):f.isTieOrigin&&(k=g?s+g.y+g.getNoteY(f.tieDestination,oh.Top):p,l===At.Down&&(k+=d)),n.whammyBarType){case dt.Hold:f.isTieOrigin&&Dc.paintTie(i,1,o,p,b,k,c===At.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case dt.Dive:if(0===u){this.bendNoteHeads[0].x=b-this.bendNoteHeads[0].noteHeadOffset;const t=this.bendNoteHeads[0].y;this.bendNoteHeads[0].y=s+h.y,this.bendNoteHeads[0].paint(0,0,i),this.bendNoteHeads[0].containsNoteValue(y)&&(k-=t,k+=this.bendNoteHeads[0].y)}S?this.drawBendSlur(i,o,p,b,k,l===At.Down,1,m):f.isTieOrigin&&Dc.paintTie(i,1,o,p,b,k,c===At.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case dt.Dip:if(r===t.NotationMode.SongBook){if(0===u){const t=e+h.x+h.getBeatX(this.ge,ah.OnNotes),n=e+h.x+h.getBeatX(this.ge,ah.PostNotes),r=(t+n)/2,a=((this.ge.whammyBarPoints[1].value-this.ge.whammyBarPoints[0].value)/4|0).toString();i.font=this.renderer.resources.tablatureFont,i.fillText(a,r,s+this.y);const o=s+this.y+i.font.size,c=o+this.renderer.smuflMetrics.songBookWhammyDipHeight;this.ge.whammyBarPoints[1].value>this.ge.whammyBarPoints[0].value?(i.moveTo(t,c),i.lineTo(r,o),i.lineTo(n,c)):(i.moveTo(t,o),i.lineTo(r,c),i.lineTo(n,o)),i.stroke()}f.isTieOrigin&&Dc.paintTie(i,1,o,p,b,k,c===At.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)}else{const t=(o+b)/2;this.bendNoteHeads[0].x=t-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=s+h.y,this.bendNoteHeads[0].paint(0,0,i);const e=this.lB(f,n.whammyBarPoints[1]),r=this.bendNoteHeads[0].getNoteValueY(e)+w;this.drawBendSlur(i,o,p,t,r,l===At.Down,1,m),this.bendNoteHeads[1].x=b-this.bendNoteHeads[1].noteHeadOffset,this.bendNoteHeads[1].y=s+h.y,this.bendNoteHeads[1].paint(0,0,i),k=this.bendNoteHeads[1].getNoteValueY(y)+w,this.drawBendSlur(i,t,r,b,k,l===At.Down,1,m)}break;case dt.PrediveDive:case dt.Predive:let a=e+h.x+h.getBeatX(f.beat,ah.PreNotes);a+=h.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;const d=s+h.y+h.getScoreY(h.accidentalHelper.getNoteLineForValue(f.displayValue-(f.beat.whammyBarPoints[0].value/2|0),!1))+w;this.drawBendSlur(i,a,d,o,p,l===At.Down,1,m),this.bendNoteHeads.length>0&&(this.bendNoteHeads[0].x=b-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=s+h.y,this.bendNoteHeads[0].paint(0,0,i),this.drawBendSlur(i,o,p,b,k,l===At.Down,1,m))}}finally{p?.[Symbol.dispose]?.()}}i.textAlign=u}finally{o?.[Symbol.dispose]?.()}}lB(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class pl extends Pa{DS;uB;constructor(t,e,s,i,n){super(t,e,n?Ca.GraceScale:1,s.getSymbol(i)),this.DS=n,this.uB=s}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const n=this.DS?1:0;Lt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.symbol,!1),this.uB.techniqueSymbol!==at.None&&this.uB.techniqueSymbolPlacement===ct.Inside&&Lt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.uB.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(at.NoteheadBlack)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(at.NoteheadBlack))}}class bl extends Pa{constructor(t,e){super(t,e,Ca.GraceScale,at.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class ml extends Pa{constructor(t,e){super(t,e,.5,at.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class gl extends Na{dB=new Set;addString(t){this.dB.add(t)}doLayout(){const t=this.renderer.smuflMetrics.glyphWidths.get(at.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(t+this.renderer.smuflMetrics.stringNumberCirclePadding)*this.dB.size,this.width=t}paint(t,e,s){const i=this.renderer.bar.staff.tuning.length;let n=0;const r=this.renderer.smuflMetrics.glyphWidths.get(at.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const a of this.dB){const h=i-a,o=at.GuitarString1+h;Lt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+r+n,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,o,!0),n+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class wl extends Pa{beatEffects=new Map;beamingHelper;noteHeadElement=ut.SlashNoteHead;effectElement=yt.SlashEffects;Hk;constructor(t,e,s,i,n){super(t,e,i?Ca.GraceScale:1,wl.getSymbol(s)),this.Hk=wl.getSymbol(s),this.beat=n}paint(t,e,s){const i=0===this.beat.notes.length?void 0:kh.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(t,e,s),this.qy(t,e,s)}finally{i?.[Symbol.dispose]?.()}}qy(t,e,s){const i=kh.beat(s,this.effectElement,this.beat);try{for(const i of this.beatEffects.values())i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.onNoteEffectPadding;let e=this.renderer.smuflMetrics.glyphHeights.get(this.Hk);for(const s of this.beatEffects.values())s.y+=e,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),e+=s.height+t}static getSymbol(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:case l.Whole:return at.NoteheadSlashWhiteWhole;case l.Half:return at.NoteheadSlashWhiteHalf;default:return at.NoteheadSlashHorizontalEnds}}updateBeamingHelper(t){if(this.beamingHelper){const e=this.Hk,s=this.renderer.smuflMetrics.stemUp.has(e)?this.renderer.smuflMetrics.stemUp.get(e).x:0,i=this.renderer.smuflMetrics.stemDown.has(e)?this.renderer.smuflMetrics.stemDown.get(e).x:0;this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+s,t+this.x+i)}}}class yl extends qh{fB=-1e3;pB=!1;noteHeads=null;restGlyph=null;get effectElement(){return yt.StandardNotationEffects}getNoteX(t,e){return this.noteHeads?this.noteHeads.getNoteX(t,e):0}buildBoundingsLookup(t,e,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(t,e+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(t,e){return this.noteHeads?this.noteHeads.getNoteY(t,e):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this.fB)){this.fB=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this.fB;const t=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;t.has(this.container.beat.playbackStart)&&t.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&t.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this.pB=!0)}}paint(t,e,s){this.pB||super.paint(t,e,s)}doLayout(){const t=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let e=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===l.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(e-=2);const s=new ll(0,t.getScoreY(e),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const e=Th.computeLineHeightsForRest(this.container.beat.duration),i=s.y-t.getScoreHeight(e[0]),n=s.y+t.getScoreHeight(e[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,i,n)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,e),this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){const t=new wh(0,0);t.renderer=this.renderer,this.bB(e,t),this.addEffect(t)}}else{const e=new cl;this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;const s=new rl(!1);s.renderer=this.renderer;for(const t of this.container.beat.notes)!t.isVisible||t.beat.slashed&&0!==t.index||(this.mB(t),s.addParenthesis(t));if(this.addNormal(e),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const t=new fl(this.container.beat);t.renderer=this.renderer,t.doLayout(),this.container.ties.push(t)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){const e=new wh(0,0);e.renderer=this.renderer;for(const s of this.container.beat.notes){this.bB(t.getNoteLine(s),e).colorOverride=kh.noteColor(t.resources,ut.StandardNotationEffects,s)}this.addEffect(e)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}bB(t,e){const s=this.renderer,i=new Hc(0,s.getScoreY(t));return e.addGlyph(i),i}gB(t){const e=this.container.beat.graceType!==u.None,s=t.style;if(void 0!==s?.noteHead){const i=new Ca(0,0,t.beat.duration,e);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(t.beat.voice.bar.staff.isPercussion){const s=zt.getArticulation(t);if(s)return new pl(0,0,s,t.beat.duration,e);j.warning("Rendering",`No articulation found for percussion instrument ${t.percussionArticulation}`)}return t.beat.slashed?new wl(0,0,t.beat.duration,e,t.beat):t.isDead?new sl(0,0,e):t.beat.graceType===u.BendGrace?new Ca(0,0,l.Quarter,!0):t.harmonicType===p.Natural?new il(0,0,t.beat.duration,e):new Ca(0,0,t.beat.duration,e)}mB(t){if(t.beat.graceType===u.BendGrace&&!t.hasBend)return;const e=this.renderer,s=this.gB(t);let i;if(s.colorOverride=kh.noteColor(e.resources,ut.StandardNotationNoteHead,t),i=t.beat.slashed?e.heightLineCount-1:e.getNoteLine(t),s.y=e.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,t,i),!t.beat.slashed&&t.harmonicType!==p.None&&t.harmonicType!==p.Natural){const n=t.displayValue+t.harmonicPitch,r=new il(0,0,t.beat.duration,this.container.beat.graceType!==u.None);r.colorOverride=s.colorOverride,i=e.accidentalHelper.getNoteLineForValue(n,!1),r.y=e.getScoreY(i),this.noteHeads.addEffectNoteGlyph(r,i)}const n=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,a=this.beamingHelper.direction===At.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!n.has("Staccato")&&a.set("Staccato",new bl(0,0)),t.accentuated!==d.Normal||n.has("Accent")||a.set("Accent",new el(0,0,t)),t.accentuated!==d.Heavy||n.has("HAccent")||a.set("HAccent",new el(0,0,t)),t.accentuated!==d.Tenuto||n.has("Tenuto")||a.set("Tenuto",new el(0,0,t)),t.showStringNumber&&t.isStringed){let e;r.has("StringNumber")?e=r.get("StringNumber"):(e=new gl(0,0),r.set("StringNumber",e)),e.addString(t.string)}if(t.isPercussion){const e=zt.getArticulation(t);if(e&&e.techniqueSymbolPlacement!==ct.Inside){let t;switch(e.techniqueSymbolPlacement){case ct.Above:t=this.noteHeads.aboveBeatEffects;break;case ct.Below:t=this.noteHeads.belowBeatEffects;break;case ct.Outside:t=a;break;default:return}switch(e.techniqueSymbol){case at.PictEdgeOfCymbal:t.set("PictEdgeOfCymbal",new ml(0,0));break;case at.ArticStaccatoAbove:t.set("ArticStaccatoAbove",new bl(0,0));break;case at.StringsUpBow:t.set("StringsUpBow",new qo(0,0,ot.Up));break;case at.StringsDownBow:t.set("StringsDownBow",new qo(0,0,ot.Down));break;case at.GuitarGolpe:t.set("GuitarGolpe",new Ao(0,0,!0))}}}}}class kl extends va{ge;wB;constructor(t){super(0,0),this.ge=t}doLayout(){if(this.ge.brushType===o.ArpeggioUp||this.ge.brushType===o.ArpeggioDown){const t=new Zo(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.wB=t,this.width=t.height}else this.width=0}paint(t,e,s){if(this.ge.brushType===o.ArpeggioUp||this.ge.brushType===o.ArpeggioDown){const i=this.renderer,n=i.lineOffset,r=e+this.y+(i.getNoteY(this.ge.maxNote,oh.Bottom)-n),a=e+this.y+i.getNoteY(this.ge.minNote,oh.Top)+n,h=t+this.x+this.width/2,c=this.renderer.smuflMetrics.glyphWidths.get(at.ArrowheadBlackDown),l=this.wB;if(this.ge.brushType===o.ArpeggioUp){const e=r+c,i=a-c;l.width=Math.abs(i-e),s.beginRotate(t+this.x,i,-90),l.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(h,a),s.lineTo(h+c/2,a-c),s.lineTo(h-c/2,a-c),s.closePath(),s.fill()}else if(this.ge.brushType===o.ArpeggioDown){const e=r+c,i=a;l.width=Math.abs(i-e),s.beginRotate(t+this.x,e,90),l.paint(0,-l.height,s),s.endRotate(),s.beginPath(),s.moveTo(h,r),s.lineTo(h+c/2,r+c),s.lineTo(h-c/2,r+c),s.closePath(),s.fill()}}}}class Sl extends Jh{yB=null;get prebendNoteHeadOffset(){return this.yB?this.yB.x+this.yB.noteHeadOffset:0}get effectElement(){return yt.StandardNotationEffects}accidentals=null;doLayout(){if(!this.container.beat.isRest){const t=new $c;t.renderer=this.renderer;const e=new Eo;e.renderer=this.renderer;const s=new rl(!0);s.renderer=this.renderer;const i=new ul(this.container.beat,!0);this.yB=i,i.renderer=this.renderer;let n=!1;for(const r of this.container.beat.notes){const a=kh.noteColor(this.renderer.resources,ut.StandardNotationEffects,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case h.PrebendBend:case h.Prebend:case h.PrebendRelease:i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,a)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case dt.PrediveDive:case dt.Predive:this.yB.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,a)}switch(this.kB(r,t),s.addParenthesis(r),e.addFingers(r),r.slideInType){case g.IntoFromBelow:case g.IntoFromAbove:n=!0}}}n&&this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==u.None?Ca.GraceScale:1))),i.isEmpty||(this.addEffect(i),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1)))),this.container.beat.brushType!==o.None&&(this.addEffect(new kl(this.container.beat)),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1)))),e.isEmpty||(this.isEmpty||this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1))),this.addEffect(e),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1)))),s.isEmpty||this.addEffect(s),t.isEmpty||(this.accidentals=t,this.isEmpty||this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1))),this.addNormal(t),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Ca.GraceScale:1))))}super.doLayout()}kB(t,e){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(t),n=s.getNoteLine(t);const r=this.container.beat.graceType!==u.None,a=kh.noteColor(s.resources,ut.StandardNotationAccidentals,t),h=r?Ca.GraceScale:1;if(i!==ht.None){const t=new Vc(0,s.getScoreY(n),i,h);t.colorOverride=a,t.renderer=this.renderer,e.addGlyph(t)}if(t.harmonicType!==p.None&&t.harmonicType!==p.Natural){const o=t.displayValue+t.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(t.beat,o,r,!1),n=s.accidentalHelper.getNoteLineForValue(o,!1);const c=new Vc(0,s.getScoreY(n),i,h);c.colorOverride=a,c.renderer=this.renderer,e.addGlyph(c)}}}class Bl extends dl{ge;eB=[];SB=null;BB=null;constructor(t){super(0,0),this.ge=t}addBends(t){if(this.eB.push(t),t.isTieOrigin)return;const e=kh.noteColor(this.renderer.resources,ut.StandardNotationEffects,t);switch(t.bendType){case h.Bend:case h.PrebendRelease:case h.PrebendBend:{let s=this.SB;s||(s=new ul(t.beat,!1),s.renderer=this.renderer,this.SB=s,this.bendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.lB(t,i),i.value%2!=0,e)}break;case h.Release:if(!t.isTieOrigin){let s=this.SB;s||(s=new ul(t.beat,!1),s.renderer=this.renderer,this.SB=s,this.bendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.lB(t,i),i.value%2!=0,e)}break;case h.BendRelease:{let s=this.BB;s||(s=new ul(t.beat,!1),this.BB=s,s.renderer=this.renderer,this.bendNoteHeads.push(s));const i=t.bendPoints[1];s.addGlyph(this.lB(t,t.bendPoints[1]),i.value%2!=0,e);let n=this.SB;n||(n=new ul(t.beat,!1),n.renderer=this.renderer,this.SB=n,this.bendNoteHeads.push(n));const r=t.bendPoints[t.bendPoints.length-1];n.addGlyph(this.lB(t,r),r.value%2!=0,e)}}}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.ge.voice.bar),n=t+i.x+i.getBeatX(this.ge,ah.MiddleNotes);let r=t+i.x;this.ge.isLastOfVoice?r+=i.postBeatGlyphsStart:r+=i.getBeatX(this.ge.nextBeat,ah.PreNotes),this.SB&&(r-=this.SB.upLineX);const o=(n+r)/2;this.BB&&(this.BB.x=o-this.BB.noteHeadOffset,this.BB.y=e+i.y,this.BB.paint(0,0,s)),this.SB&&(this.SB.x=r-this.SB.noteHeadOffset,this.SB.y=e+i.y,this.SB.paint(0,0,s)),this.eB.sort((t,e)=>e.displayValue-t.displayValue);const c=this.ge.graceType===u.BendGrace?this.ge.nextBeat:this.ge;let l=1===this.eB.length?this.getTieDirection(c,i):At.Up;const d=this.renderer.smuflMetrics.glyphHeights.get(at.NoteheadBlack);for(let c=0;c<this.eB.length;c++){const u=this.eB[c],f=kh.note(s,ut.StandardNotationEffects,u);try{c>0&&c>=(this.eB.length/2|0)&&(l=At.Down);let f=e+i.y+i.getNoteY(u,oh.Top),p=d*Ca.GraceScale*.5;l===At.Down&&(f+=d);const b=u.bendStyle===a.Gradual?"grad.":"";if(u.isTieOrigin){const r=u.tieDestination,a=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(a&&a.staff===i.staff){const i=t+a.x+a.getBeatX(r.beat,ah.MiddleNotes);let o=e+a.y+a.getNoteY(r,oh.Top);l===At.Down&&(o+=d),u.bendType===h.Hold||u.bendType===h.Prebend?Dc.paintTie(s,1,n,f,i,o,l===At.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,i,o,l===At.Down,1,b)}else{const r=t+i.x+i.width,a=u.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(u.beat,a,!1,!0);const o=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(a,!1));u.bendType===h.Hold||u.bendType===h.Prebend?Dc.paintTie(s,1,n,f,r,o,l===At.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,r,o,l===At.Down,1,b)}switch(u.bendType){case h.Prebend:case h.PrebendBend:case h.PrebendRelease:let r=t+i.x+i.getBeatX(u.beat,ah.PreNotes);r+=i.getPreNotesGlyphForBeat(u.beat).prebendNoteHeadOffset;const a=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(u.displayValue-(u.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,r,a,n,f,l===At.Down,1)}}else{l===At.Up&&(p=-p);let a=0,c=0;switch(u.bendType){case h.Bend:a=this.lB(u,u.bendPoints[u.bendPoints.length-1]),c=this.SB.getNoteValueY(a)+p,this.drawBendSlur(s,n,f,r,c,l===At.Down,1,b);break;case h.BendRelease:const d=this.lB(u,u.bendPoints[1]),m=this.BB.getNoteValueY(d)+p;this.drawBendSlur(s,n,f,o,m,l===At.Down,1,b),a=this.lB(u,u.bendPoints[u.bendPoints.length-1]),c=this.SB.getNoteValueY(a)+p,this.drawBendSlur(s,o,m,r,c,l===At.Down,1,b);break;case h.Release:this.bendNoteHeads.length>0&&(a=this.lB(u,u.bendPoints[u.bendPoints.length-1]),c=this.bendNoteHeads[0].getNoteValueY(a)+p,this.drawBendSlur(s,n,f,r,c,l===At.Down,1,b));break;case h.Prebend:case h.PrebendBend:case h.PrebendRelease:let g=t+i.x+i.getBeatX(u.beat,ah.PreNotes);g+=i.getPreNotesGlyphForBeat(u.beat).prebendNoteHeadOffset;const w=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(u.displayValue-(u.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,g,w,n,f,l===At.Down,1),this.bendNoteHeads.length>0&&(a=this.lB(u,u.bendPoints[u.bendPoints.length-1]),c=this.bendNoteHeads[0].getNoteValueY(a)+p,this.drawBendSlur(s,n,f,r,c,l===At.Down,1,b))}}}finally{f?.[Symbol.dispose]?.()}}}lB(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class _l extends Dc{constructor(t,e,s=!1){super(t,e,s)}doLayout(){super.doLayout()}getBeamDirection(t,e){return t.isRest?At.Up:e.getBeatDirection(t)===At.Up?At.Down:At.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===At.Up?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,oh.Top):this.startNoteRenderer.getNoteY(this.startBeat.minNote,oh.Bottom)}getEndY(){const t=this.endNoteRenderer;if(this.endBeat.isRest)return this.tieDirection===At.Up?t.getScoreY(9):t.getScoreY(0);const e=this.startNoteRenderer.getBeatDirection(this.startBeat),s=t.getBeatDirection(this.endBeat);return e!==s&&this.startBeat.graceType===u.None?s===this.tieDirection?this.tieDirection===At.Up?t.getNoteY(this.endBeat.maxNote,oh.TopWithStem):t.getNoteY(this.endBeat.minNote,oh.BottomWithStem):this.tieDirection===At.Up?t.getNoteY(this.endBeat.maxNote,oh.BottomWithStem):t.getNoteY(this.endBeat.minNote,oh.TopWithStem):this.tieDirection===At.Up?t.getNoteY(this.endBeat.maxNote,oh.Top):t.getNoteY(this.endBeat.minNote,oh.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,ah.MiddleNotes)}getEndX(){const t=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>l.Whole&&t===this.tieDirection?ah.Stem:ah.MiddleNotes)}}class xl extends va{_B;xB;TB;MB;constructor(t,e,s,i){super(0,0),this._B=e,this.xB=t,this.TB=s,this.MB=i}doLayout(){this.width=0}paint(t,e,s){this.vB(t,e,s),this.NB(t,e,s)}vB(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth;let r=t+i.x+i.getNoteX(this.TB,ch.Left)-i.smuflMetrics.preNoteEffectPadding;const a=e+i.y+i.getNoteY(this.TB,oh.Center);let h=r-n,o=e+i.y;switch(this.xB){case g.IntoFromBelow:o+=i.getNoteY(this.TB,oh.Bottom);break;case g.IntoFromAbove:o+=i.getNoteY(this.TB,oh.Top);break;default:return}const c=this.PB(i,this.TB.beat);h-=c,r-=c,this.EB(s,!1,h,r,o,a)}PB(t,e){const s=t.getPreNotesGlyphForBeat(e);return s&&s.accidentals?s.accidentals.width:0}NB(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding;let a=0,h=0,o=0,c=0,l=!1;switch(this._B){case w.Shift:case w.Legato:if(a=t+i.x+i.getBeatX(this.TB.beat,ah.PostNotes)+r,h=e+i.y+i.getNoteY(this.TB,oh.Center),this.TB.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.TB.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.TB.slideTarget.beat,ah.PreNotes)-r,c=e+s.y+s.getNoteY(this.TB.slideTarget,oh.Center)):(o=t+i.x+i.width,c=this.TB.slideTarget.realValue>this.TB.realValue?e+i.y+i.getNoteY(this.TB,oh.Top):e+i.y+i.getNoteY(this.TB,oh.Bottom))}else o=t+i.x+this.MB.x,c=h;break;case w.OutUp:a=t+i.x+i.getNoteX(this.TB,ch.Right)+r,h=e+i.y+i.getNoteY(this.TB,oh.Center),o=a+n,c=e+i.y+i.getNoteY(this.TB,oh.Top);break;case w.OutDown:a=t+i.x+i.getNoteX(this.TB,ch.Right)+r,h=e+i.y+i.getNoteY(this.TB,oh.Center),o=a+n,c=e+i.y+i.getNoteY(this.TB,oh.Bottom);break;case w.PickSlideUp:a=t+i.x+i.getNoteX(this.TB,ch.Right)+2*r,h=e+i.y+i.getNoteY(this.TB,oh.Center),c=e+i.y+i.getNoteY(this.TB,oh.Top),o=t+i.x+i.width,this.TB.beat.nextBeat&&this.TB.beat.nextBeat.voice===this.TB.beat.voice&&(o=t+i.x+i.getBeatX(this.TB.beat.nextBeat,ah.PreNotes)),l=!0;break;case w.PickSlideDown:a=t+i.x+i.getNoteX(this.TB,ch.Right)+2*r,h=e+i.y+i.getNoteY(this.TB,oh.Center),c=e+i.y+i.getNoteY(this.TB,oh.Bottom),o=t+i.x+i.width,this.TB.beat.nextBeat&&this.TB.beat.nextBeat.voice===this.TB.beat.voice&&(o=t+i.x+i.getBeatX(this.TB.beat.nextBeat,ah.PreNotes)),l=!0;break;default:return}this.EB(s,l,a,o,h,c)}EB(t,e,s,i,n,r){if(e){const e=new Zo(0,0,y.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class Tl extends _l{TB;CB;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.TB=t,this.CB=e}getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){return this.FB()?this.tieDirection===At.Up?this.startNoteRenderer.getNoteY(this.TB,oh.Top):this.startNoteRenderer.getNoteY(this.TB,oh.Bottom):this.startNoteRenderer.getNoteY(this.TB,oh.Center)}getEndY(){return this.AB()?this.DB()?this.tieDirection===At.Up?this.endNoteRenderer.getNoteY(this.CB,oh.TopWithStem):this.endNoteRenderer.getNoteY(this.CB,oh.BottomWithStem):this.tieDirection===At.Up?this.endNoteRenderer.getNoteY(this.CB,oh.Top):this.endNoteRenderer.getNoteY(this.CB,oh.Bottom):this.endNoteRenderer.getNoteY(this.CB,oh.Center)}FB(){return this.TB===this.TB.beat.maxNote&&this.tieDirection===At.Up||this.TB===this.TB.beat.minNote&&this.tieDirection===At.Down}AB(){return this.TB.beat.graceType===u.None&&(this.CB===this.CB.beat.maxNote&&this.tieDirection===At.Up||this.CB===this.CB.beat.minNote&&this.tieDirection===At.Down)}DB(){const t=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==t.getBeatDirection(this.endBeat)&&this.startBeat.graceType===u.None}getStartX(){return this.FB()?this.startNoteRenderer.getBeatX(this.TB.beat,ah.MiddleNotes):this.startNoteRenderer.getNoteX(this.TB,ch.Right)}getEndX(){return this.AB()?this.DB()?this.endNoteRenderer.getBeatX(this.CB.beat,ah.Stem):this.endNoteRenderer.getNoteX(this.CB,ch.Center):this.endNoteRenderer.getBeatX(this.CB.beat,ah.PreNotes)}}class Ml extends Dc{startNote;endNote;constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return e.getBeatDirection(t)===At.Up?At.Down:At.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===At.Up?this.startNoteRenderer.getNoteY(this.startNote,oh.Top):this.startNoteRenderer.getNoteY(this.startNote,oh.Bottom)}getEndY(){const t=this.endNoteRenderer;return this.endBeat.isRest?this.tieDirection===At.Up?t.getScoreY(9):t.getScoreY(0):this.tieDirection===At.Up?t.getNoteY(this.endNote,oh.Top):t.getNoteY(this.endNote,oh.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,ah.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,ah.PreNotes)}}class vl extends Aa{LB=null;WB=null;RB=null;doLayout(){this.WB=null,this.RB=null,super.doLayout(),this.LB&&(this.LB.renderer=this.renderer,this.LB.doLayout(),this.updateWidth())}createTies(t){if(t.isVisible){if(t.isTieOrigin&&!t.hasBend&&!t.beat.hasWhammyBar&&t.beat.graceType!==u.BendGrace&&t.tieDestination&&t.tieDestination.isVisible){const e=new Ml(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&!t.tieOrigin.hasBend&&!t.beat.hasWhammyBar){const e=new Ml(t.tieOrigin,t,!0);this.addTie(e)}if(t.slideInType!==g.None||t.slideOutType!==w.None){const e=new xl(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.isSlurOrigin&&t.slurDestination&&t.slurDestination.isVisible){const e=new Tl(t,t.slurDestination,!1);this.addTie(e)}if(t.isSlurDestination){const e=new Tl(t.slurOrigin,t,!0);this.addTie(e)}if(!this.WB&&t.isEffectSlurOrigin&&t.effectSlurDestination){const e=new Tl(t,t.effectSlurDestination,!1);this.WB=e,this.addTie(e)}if(!this.RB&&t.beat.isEffectSlurDestination&&t.beat.effectSlurOrigin){const e=this.onNotes.beamingHelper.direction,s=e===At.Up?t.beat.effectSlurOrigin.minNote:t.beat.effectSlurOrigin.maxNote,i=e===At.Up?t.beat.minNote:t.beat.maxNote,n=new Tl(s,i,!0);this.RB=n,this.addTie(n)}if(t.hasBend){if(!this.LB){const e=new Bl(t.beat);this.LB=e,e.renderer=this.renderer,this.addTie(e)}this.LB.addBends(t)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let t=this.beat.nextBeat;for(;t.nextBeat&&t.nextBeat.isLegatoDestination;)t=t.nextBeat;this.addTie(new _l(this.beat,t,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let t=this.beat.previousBeat;for(;t.previousBeat&&t.previousBeat.isLegatoOrigin;)t=t.previousBeat;this.addTie(new _l(t,this.beat,!0))}}}}class Nl extends yh{paint(t,e,s){const i=kh.bar(s,D.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class Pl extends Ac{static StaffId="score";static OB=[-1,2,-2,1,4,0,3];static IB=[3,0,4,1,5,2,6];simpleWhammyOverflow=0;beatEffectsMinY=null;beatEffectsMaxY=null;accidentalHelper;constructor(t,e){super(t,e),this.accidentalHelper=new fi(this)}get repeatsBarSubElement(){return D.StandardNotationRepeats}get barNumberBarSubElement(){return D.StandardNotationBarNumber}get barLineBarSubElement(){return D.StandardNotationBarLines}get staffLineBarSubElement(){return D.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(t,e){const s=this.beatEffectsMinY;(null==s||t<s)&&(this.beatEffectsMinY=t);const i=this.beatEffectsMaxY;(null==i||e>i)&&(this.beatEffectsMaxY=e)}getScoreY(t){return super.getLineY(t/2)}getScoreHeight(t){return super.getLineHeight(t/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.simpleWhammyOverflow,i=this.beatEffectsMinY;if(null!==i){const e=t-i;e>0&&this.registerOverflowTop(e)}const n=this.beatEffectsMaxY;if(null!==n){const t=n-e;t>0&&this.registerOverflowBottom(t)}this.registerOverflowTop(s);const r=this.getScoreHeight(1);let a=0,h=0;for(const t of this.helpers.beamHelpers)for(const e of t)if(e.isRestBeamHelper){if(e.minRestLine){const t=this.getScoreY(e.maxRestLine)-r;t<a&&(a=t)}if(e.maxRestLine){const t=this.getScoreY(e.maxRestLine)+r;t<a&&(a=t)}}else if(1===e.beats.length)if(e.beats[0].duration>=l.Half)if(e.direction===At.Up){let t=this.getFlagTopY(e.beats[0],e.direction);e.hasTuplet&&(t-=this.tupletSize+this.tupletOffset),t<a&&(a=t);const s=this.getFlagBottomY(e.beats[0],e.direction)+r;s>h&&(h=s)}else{let t=this.getFlagBottomY(e.beats[0],e.direction);e.hasTuplet&&(t+=this.tupletSize+this.tupletOffset),t>h&&(h=t);const s=this.getFlagTopY(e.beats[0],e.direction)-r;s<a&&(a=s)}else{const t=this.getBeatContainer(e.beats[0]);if(t){let s=t.onNotes.getHighestNoteY()-r,i=t.onNotes.getLowestNoteY()+r;e.direction===At.Up?e.hasTuplet&&(s-=this.tupletSize+this.tupletOffset):e.hasTuplet&&(i+=this.tupletSize+this.tupletOffset),i>h&&(h=i),s<a&&(a=s)}}else{this.GB(e,e.direction);const t=e.drawingInfos.get(e.direction);if(e.direction===At.Up){let s=Math.min(t.startY,t.endY);e.hasTuplet&&(s-=this.tupletSize+this.tupletOffset),s<a&&(a=s);const i=this.getBarLineStart(e.beatOfLowestNote,e.direction)+r;i>h&&(h=i)}else{let s=Math.max(t.startY,t.endY);e.hasTuplet&&(s+=this.tupletSize+this.tupletOffset),s>h&&(h=s);const i=this.getBarLineStart(e.beatOfHighestNote,e.direction)-r;i<a&&(a=i)}}a<t&&this.registerOverflowTop(Math.abs(a)+s),h>e&&this.registerOverflowBottom(Math.abs(h)-e)}}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,yt.StandardNotationFlags,yt.StandardNotationBeams),this.paintTuplets(t,e,s,yt.StandardNotationTuplet)}$B(){const t=(this.heightLineCount-1)/2;return this.getLineY(t)}getFlagTopY(t,e){if(t.slashed){let s=this.$B();const i=wl.getSymbol(t.duration),n=t.graceType!==u.None?Ca.GraceScale:1;return e===At.Down?s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*n:0:(s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*n:0,s-=this.smuflMetrics.standardStemLength+n),s}const s=this.accidentalHelper.getMinLineNote(t);if(s)return this.getBeatContainer(t).onNotes.getNoteY(s,e===At.Up?oh.TopWithStem:oh.StemDown);let i=this.getScoreY(this.accidentalHelper.getMinLine(t));if(e===At.Up){const e=t.graceType!==u.None?Ca.GraceScale:1;i-=this.smuflMetrics.standardStemLength*e}return i}getFlagBottomY(t,e){if(t.slashed){let s=this.$B();const i=wl.getSymbol(t.duration),n=t.graceType!==u.None?Ca.GraceScale:1;return e===At.Down?(s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*n:0,s+=this.smuflMetrics.standardStemLength+n):s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*n:0,s}const s=this.accidentalHelper.getMaxLineNote(t);if(s)return this.getBeatContainer(t).onNotes.getNoteY(s,e===At.Up?oh.StemUp:oh.BottomWithStem);let i=this.getScoreY(this.accidentalHelper.getMaxLine(t));if(e===At.Down){const e=t.graceType!==u.None?Ca.GraceScale:1;i+=this.smuflMetrics.standardStemLength*e}return i}getBeamDirection(t){return t.direction}centerStaffStemY(t){return this.bar.staff.standardNotationLineCount===ke.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):t.direction===At.Up?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}getStemBottomY(t){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(t,e){if(t.beat.slashed){const t=(this.heightLineCount-1)/2;return this.getLineY(t)}let s=super.getNoteY(t,e);if(Number.isNaN(s)){const i=fi.computeLineWithoutAccidentals(this.bar,t);s=this.getScoreY(i);const n=t.beat.graceType===u.None?1:Ca.GraceScale,r=this.smuflMetrics.standardStemLength*n,a=this.smuflMetrics.glyphHeights.get(Ca.getSymbol(t.beat.duration))*n;switch(e){case oh.TopWithStem:s-=r;break;case oh.Top:s-=a/2;break;case oh.Center:break;case oh.Bottom:s+=a/2;break;case oh.BottomWithStem:s+=r;case oh.StemUp:case oh.StemDown:}}return s}applyLayoutingInfo(){const t=super.applyLayoutingInfo();if(t&&this.bar.isMultiVoice){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<t&&this.registerOverflowTop(Math.abs(s[0])),s[1]>e&&this.registerOverflowBottom(Math.abs(s[1])-e)}return t}calculateBeamYWithDirection(t,e,s){return 0===t.beats.length?s===At.Up?this.getFlagTopY(t.beats[0],s):this.getFlagBottomY(t.beats[0],s):(this.GB(t,s),t.drawingInfos.get(s).calcY(e))}GB(t,e){if(!t.drawingInfos.has(e)){const s=t.graceType!==u.None?Ca.GraceScale:1,i=Ht.getIndex(t.shortestDuration)-2;let n=this.smuflMetrics.standardStemLength*s;if(t.tremoloDuration){const e=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*s;t.shortestDuration>l.Eighth?t.tremoloDuration===l.Eighth?n+=e:n+=1.5*e:t.tremoloDuration===l.ThirtySecond&&(n+=1.5*e)}const r=new xh;t.drawingInfos.set(e,r);const a=t.beats[0],h=t.beats[t.beats.length-1],o=t.isRestBeamHelper;r.startBeat=a,r.startX=t.getBeatLineX(a),r.startY=o?e===At.Up?this.getScoreY(t.minRestLine):this.getScoreY(t.maxRestLine):e===At.Up?this.getFlagTopY(a,e):this.getFlagBottomY(a,e),r.endBeat=h,r.endX=t.getBeatLineX(h),r.endY=o?e===At.Up?this.getScoreY(t.minRestLine):this.getScoreY(t.maxRestLine):e===At.Up?this.getFlagTopY(h,e):this.getFlagBottomY(h,e);const c=this.smuflMetrics.oneStaffSpace;if(e===At.Down&&r.startY>r.endY&&r.startY-r.endY>c&&(r.endY=r.startY-c),e===At.Down&&r.endY>r.startY&&r.endY-r.startY>c&&(r.startY=r.endY-c),e===At.Up&&r.startY<r.endY&&r.endY-r.startY>c&&(r.endY=r.startY+c),e===At.Up&&r.endY<r.startY&&r.startY-r.endY>c&&(r.startY=r.endY+c),t.beats.length>1){if(e===At.Up){const e=this.getScoreY(this.accidentalHelper.getMinLine(t.beatOfHighestNote))-n,s=r.calcY(t.getBeatLineX(t.beatOfHighestNote))-e;s>0&&(r.startY-=s,r.endY-=s)}else{const e=this.getScoreY(this.accidentalHelper.getMaxLine(t.beatOfLowestNote))+n-r.calcY(t.getBeatLineX(t.beatOfLowestNote));e>0&&(r.startY+=e,r.endY+=e)}if(null!==t.minRestLine||null!==t.maxRestLine){const s=t.graceType!==u.None?Ca.GraceScale:1;let n=i*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*s;if(n+=this.smuflMetrics.beamSpacing,e===At.Up&&null!==t.minRestLine){const e=this.getScoreY(t.minRestLine)-n,s=r.calcY(t.getBeatLineX(t.beatOfMinRestLine))-e;s>0&&(r.startY-=s,r.endY-=s)}else if(e===At.Down&&null!==t.maxRestLine){const e=this.getScoreY(t.maxRestLine)+n-r.calcY(t.getBeatLineX(t.beatOfMaxRestLine));e>0&&(r.startY+=e,r.endY+=e)}}if(t.slashBeats.length>0)for(const e of t.slashBeats){const s=r.calcY(t.getBeatLineX(e)),i=(t.direction===At.Up?this.getFlagTopY(e,t.direction):this.getFlagBottomY(e,t.direction))-s;i>0&&(r.startY+=i,r.endY+=i)}}if(i>2&&!o){const t=this.smuflMetrics.beamSpacing*s,n=this.smuflMetrics.beamThickness*s,a=i*n+(i-1)*t;if(e===At.Up){const e=r.startY+2*n+t-a,s=r.startY-e;s>0&&(r.startY-=s,r.endY-=s)}else{const e=r.startY-2*n+t+a-r.startY;e>0&&(r.startY+=e,r.endY+=e)}}}}getBarLineStart(t,e){if(t.slashed)return e===At.Down?this.getFlagTopY(t,e):this.getFlagBottomY(t,e);if(e===At.Up){const e=this.accidentalHelper.getMaxLineNote(t);return e?this.getBeatContainer(t).onNotes.getNoteY(e,oh.StemUp):this.getScoreY(this.accidentalHelper.getMaxLine(t))}const s=this.accidentalHelper.getMinLineNote(t);return s?this.getBeatContainer(t).onNotes.getNoteY(s,oh.StemDown):this.getScoreY(this.accidentalHelper.getMinLine(t))}createLinePreBeatGlyphs(){let t=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case P.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case P.F4:e=2;break;case P.C3:e=4;break;case P.C4:e=2;break;case P.G2:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new tl(0,this.getScoreY(e),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.preBeatGlyphSpacing)),t=!0}(t||0===this.index&&this.bar.keySignature!==C.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.jS()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.XS())}jS(){let t=0;const e=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case P.Neutral:t=0;break;case P.G2:t=1;break;case P.F4:t=3;break;case P.C3:t=2;break;case P.C4:t=0}const i=new Nl;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const n=new Map,r=[];if(Ht.keySignatureIsSharp(e))for(let s=0;s<Math.abs(e);s++){const e=Pl.OB[s]+t;r.push(new Vc(0,this.getScoreY(e),ht.Sharp,1)),n.set(e,!0)}else for(let s=0;s<Math.abs(e);s++){const e=Pl.IB[s]+t;r.push(new Vc(0,this.getScoreY(e),ht.Flat,1)),n.set(e,!0)}if(this.bar.keySignature===C.C){const e=Math.abs(s),r=Ht.keySignatureIsSharp(s)?Pl.OB:Pl.IB;for(let s=0;s<e;s++){const e=r[s]+t;n.has(e)||i.addGlyph(new Vc(0,this.getScoreY(r[s]+t),ht.Natural,1))}}for(const t of r)i.addGlyph(t);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.preBeatGlyphSpacing))}XS(){const t=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new Yc(0,this.getScoreY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(t){for(const e of t.beats){const s=new vl(e,this.getVoiceContainer(t));s.preNotes=new Sl,s.onNotes=new yl,this.addBeatGlyph(s)}}getNoteLine(t){return this.accidentalHelper.getNoteLine(t)}completeBeamingHelper(t){if(this.bar.isMultiVoice&&t.highestNoteInHelper&&t.lowestNoteInHelper){let e=0,s=0,i=0;t.hasTuplet&&(i+=2*this.resources.effectFont.size),t.direction===At.Up?(e=this.getNoteY(t.highestNoteInHelper,oh.TopWithStem)-i,s=this.getNoteY(t.lowestNoteInHelper,oh.Bottom)):(e=this.getNoteY(t.highestNoteInHelper,oh.Top),s=this.getNoteY(t.lowestNoteInHelper,oh.BottomWithStem)+i);for(const i of t.beats)this.helpers.collisionHelper.reserveBeatSlot(i,e,s)}}paintBeamingStem(t,e,s,i,n,r){const a=kh.beat(r,yt.StandardNotationStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}}class El extends gh{get staffId(){return Pl.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Pl(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class Cl extends Dc{startNote;endNote;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}get ES(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.ES?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return At.Down}static getBeamDirectionForNote(t){return At.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,oh.Center)}getEndY(){return this.getStartY()}getStartX(){return this.ES?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,ch.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,ch.Left)}}class Fl extends Aa{VB=null;createTies(t){if(t.isVisible){if(!this.VB&&t.isTieOrigin&&t.tieDestination.isVisible){const e=new Cl(t,t.tieDestination,!1);this.VB=e,this.addTie(e)}if(!this.VB&&t.isTieDestination){const e=new Cl(t.tieOrigin,t,!0);this.VB=e,this.addTie(e)}}}}class Al extends ll{updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){super.internalPaint(t,e,s,yt.SlashRests)}}class Dl extends qh{noteHeads=null;deadSlapped=null;restGlyph=null;get effectElement(){return yt.SlashEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case ch.Left:break;case ch.Center:t+=s.width/2;break;case ch.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new Ce;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Pe,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(t,e){let s=null,i=at.None;if(this.noteHeads?(s=this.noteHeads,i=wl.getSymbol(t.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let t=this.y+s.y;switch(e){case oh.Top:case oh.TopWithStem:t-=s.height/2;break;case oh.Center:break;case oh.Bottom:case oh.BottomWithStem:t+=s.height/2;break;case oh.StemUp:t-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case oh.StemDown:t-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0}return t}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){const t=this.renderer,e=t.getNoteLine(),s=t.getLineY(e);if(this.container.beat.deadSlapped){const t=new zc;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const t=new Al(0,s,this.container.beat.duration);this.restGlyph=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper,this.addNormal(t),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const t=this.container.beat.graceType!==u.None,e=new wl(0,s,this.container.beat.duration,t,this.container.beat);this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new Hc(0,t.getLineY(t.getNoteLine())-t.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class Ll extends Ac{static StaffId="slash";simpleWhammyOverflow=0;HB;constructor(t,e){super(t,e),this.HB=!e.staff.showTablature&&!e.staff.showStandardNotation,this.helpers.preferredBeamDirection=At.Up}get repeatsBarSubElement(){return D.SlashRepeats}get barNumberBarSubElement(){return D.SlashBarNumber}get barLineBarSubElement(){return D.SlashBarLines}get staffLineBarSubElement(){return D.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,yt.SlashFlags,yt.SlashBeams),this.paintTuplets(t,e,s,yt.SlashTuplet)}doLayout(){super.doLayout();let t=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)){if(this.getVoiceContainer(e).tupletGroups.length>0){t=!0;break}}t&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(t,e){const s=this.smuflMetrics.glyphHeights.get(at.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return e===At.Up&&(i-=this.getFlagStemSize(t.duration,!0)),i}getFlagBottomY(t,e){const s=this.smuflMetrics.glyphHeights.get(at.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return e===At.Down&&(i+=this.getFlagStemSize(t.duration,!0)),i}getBeamDirection(t){return At.Up}getNoteY(t,e){let s=super.getNoteY(t,e);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(t,e,s){return this.getLineY(0)-this.getFlagStemSize(t.shortestDuration)}getBarLineStart(t,e){const s=this.smuflMetrics.glyphHeights.get(at.NoteheadSlashWhiteHalf);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this.HB&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.XS())}XS(){this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new Yc(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=D.SlashTimeSignature,this.addPreBeatGlyph(e)}createVoiceGlyphs(t){for(const e of t.beats){const s=new Fl(e,this.getVoiceContainer(t));s.preNotes=new Jh,s.onNotes=0===t.index?new Dl:new qh,this.addBeatGlyph(s)}}paintBeamingStem(t,e,s,i,n,r){const a=kh.beat(r,yt.SlashStem,t);try{const t=r.lineWidth;r.lineWidth=this.smuflMetrics.stemThickness,r.beginPath(),r.moveTo(s,i),r.lineTo(s,n),r.stroke(),r.lineWidth=t}finally{a?.[Symbol.dispose]?.()}}}class Wl extends gh{get staffId(){return Ll.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Ll(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class Rl extends V{lineValue=0;constructor(t=0,e=0){super(t,e),this.lineValue=e}}class Ol extends va{eB=[];UB=new Map;zB=-1;jB=-1;XB=-1;JB=-1;qB=-1;YB=-1;KB=-1;constructor(){super(0,0)}addBends(t){this.eB.push(t);const e=this.QB(t);this.UB.set(t.id,e),(-1===this.KB||this.KB<t.maxBendPoint.value)&&(this.KB=t.maxBendPoint.value);let s=0;switch(t.bendType){case h.Bend:s=e[1].value,t.isTieOrigin?(-1===this.JB||s<this.JB)&&(this.JB=s):(-1===this.XB||s<this.XB)&&(this.XB=s);break;case h.Release:s=e[1].value,t.isTieOrigin?(-1===this.YB||s<this.YB)&&(this.YB=s):s>0&&(-1===this.qB||s<this.qB)&&(this.qB=s);break;case h.BendRelease:s=e[1].value,(-1===this.jB||s<this.jB)&&(this.jB=s),s=e[2].value,t.isTieOrigin?(-1===this.YB||s<this.YB)&&(this.YB=s):s>0&&(-1===this.qB||s<this.qB)&&(this.qB=s);break;case h.Prebend:s=e[0].value,(-1===this.zB||s<this.zB)&&(this.zB=s);break;case h.PrebendBend:s=e[0].value,(-1===this.zB||s<this.zB)&&(this.zB=s),s=e[1].value,t.isTieOrigin?(-1===this.JB||s<this.JB)&&(this.JB=s):(-1===this.XB||s<this.XB)&&(this.XB=s);break;case h.PrebendRelease:s=e[0].value,(-1===this.zB||s<this.zB)&&(this.zB=s),s=e[1].value,t.isTieOrigin?(-1===this.YB||s<this.YB)&&(this.YB=s):s>0&&(-1===this.qB||s<this.qB)&&(this.qB=s)}}doLayout(){super.doLayout();const t=this.KB*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(t);let e=0;for(const t of this.eB){const s=this.UB.get(t.id);switch(t.bendType){case h.Bend:s[1].lineValue=t.isTieOrigin?this.JB:this.XB;break;case h.Release:e=t.isTieOrigin?this.YB:this.qB,e>=0&&(s[1].lineValue=e);break;case h.BendRelease:s[1].lineValue=this.jB,e=t.isTieOrigin?this.YB:this.qB,e>=0&&(s[2].lineValue=e);break;case h.Prebend:s[0].lineValue=this.zB;break;case h.PrebendBend:s[0].lineValue=this.zB,s[1].lineValue=t.isTieOrigin?this.JB:this.XB;break;case h.PrebendRelease:s[0].lineValue=this.zB,e=t.isTieOrigin?this.YB:this.qB,e>=0&&(s[1].lineValue=e)}}this.width=0,this.eB.sort((t,e)=>t.isStringed?t.string-e.string:t.realValue-e.realValue)}QB(t){const e=[];switch(t.bendType){case h.Custom:for(const s of t.bendPoints)e.push(new Rl(s.offset,s.value));break;case h.BendRelease:e.push(new Rl(0,t.bendPoints[0].value)),e.push(new Rl(V.MaxPosition/2|0,t.bendPoints[1].value)),e.push(new Rl(V.MaxPosition,t.bendPoints[3].value));break;case h.Bend:case h.Hold:case h.Prebend:case h.PrebendBend:case h.PrebendRelease:case h.Release:e.push(new Rl(0,t.bendPoints[0].value)),e.push(new Rl(V.MaxPosition,t.bendPoints[1].value))}return e}paint(t,e,s){const i=s.color;this.eB.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const n of this.eB){const r=this.UB.get(n.id),o=this.renderer;let c=n,l=!1,u=null,d=!1;const f=n.bendStyle===a.Gradual?"grad.":"";let p=null;for(;c.isTieOrigin;){const t=c.tieDestination;if(u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,t.beat.voice.bar),!u||o.staff!==u.staff)break;if(c=t,l=!0,c.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||c.vibrato!==y.None){d=!0;break}}p=c.beat,u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,p.voice.bar),p.isLastOfVoice&&!c.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(p=null);let b=0,m=0;const g=e+o.y,w=this.renderer.smuflMetrics.glyphWidths.get(at.ArrowheadBlackDown);b=t+o.x,r[0].value>0||n.isContinuedBend?b+=o.getBeatX(n.beat,ah.MiddleNotes):b+=o.getNoteX(n,ch.Right),m=!p||p.isLastOfVoice&&!d?t+u.x+u.postBeatGlyphsStart:d||!p.nextBeat?t+u.x+u.getBeatX(p,ah.MiddleNotes):n.bendType===h.Hold?t+u.x+u.getBeatX(p.nextBeat,ah.OnNotes):t+u.x+u.getBeatX(p.nextBeat,ah.PreNotes),l||(m-=w);const k=(m-b)/V.MaxPosition;s.beginPath();for(let t=0,e=r.length-1;t<e;t++){const e=r[t];let i=r[t+1];0!==t||0===e.value||n.isTieDestination||this.ZB(n,new Rl(0,0),e,b,g,k,f,s),n.bendType!==h.Prebend?(0===t&&(b+=this.renderer.smuflMetrics.postNoteEffectPadding),this.ZB(n,e,i,b,g,k,f,s)):n.isTieOrigin&&n.tieDestination.hasBend&&(i=new Rl(V.MaxPosition,e.value),i.lineValue=e.lineValue,this.ZB(n,e,i,b,g,k,f,s))}if(c.vibrato!==y.None){const i=m-t+w-u.x,n=g-e-this.renderer.smuflMetrics.tabBendPerValueHeight*r[r.length-1].lineValue,a=new Zo(i,n,c.vibrato);a.beat=c.beat,a.renderer=u,a.doLayout(),a.paint(t+u.x,e,s)}s.color=i}}ZB(t,e,s,i,n,r,a,h){const o=this.renderer,c=this.renderer.resources,l=o.lineOffset/2,u=i+r*e.offset,d=this.renderer.smuflMetrics.tabBendPerValueHeight;let f=n-d*e.lineValue;0===e.value?s.offset===e.offset?f+=o.getNoteY(t.beat.maxStringNote,oh.Top)-l/2:f+=o.getNoteY(t,oh.Center):f+=l;const p=i+r*s.offset;let b=n-d*s.lineValue;0===s.lineValue?b+=o.getNoteY(t,oh.Center):b+=l;let m=0;const g=this.renderer.smuflMetrics.glyphWidths.get(at.ArrowheadBlackDown);s.value>e.value?(b+g>f&&(b=f-g),h.beginPath(),h.moveTo(p,b),h.lineTo(p-.5*g,b+g),h.lineTo(p+.5*g,b+g),h.closePath(),h.fill(),m=g):s.value!==e.value&&(b<f&&(b=f+g),h.beginPath(),h.moveTo(p,b),h.lineTo(p-.5*g,b-g),h.lineTo(p+.5*g,b-g),h.closePath(),h.fill(),m=-g);const w=h.lineWidth;if(h.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,h.beginPath(),e.value===s.value){if(e.lineValue>0){let t=p;const e=this.renderer.smuflMetrics.tabBendDashSize,s=u+e;if((t-u)/(2*e)<1)h.moveTo(t,f),h.lineTo(u,f);else for(;t>s;)h.moveTo(t,f),h.lineTo(t-e,f),t-=2*e;h.stroke()}}else p>u?(h.moveTo(u,f),h.bezierCurveTo((u+p)/2,f,p,f,p,b+m),h.stroke()):(h.moveTo(u,f),h.lineTo(p,b),h.stroke());if(a&&e.offset<s.offset){h.font=c.graceFont;const t=h.measureText(a);let e=0,s=0;if(f>b){const i=Math.abs(f-b);e=i>t.height?f-i/2:f,s=(u+p-t.width)/2}else e=f,s=p-t.width;h.fillText(a,s,e)}if(0!==s.value&&e.value!==s.value){let t=s.value;const i=s.value>e.value;t=Math.abs(t);let r="";if(4===t)r="full",t-=4;else if(t>=4||t<=-4){const e=t/4|0;r+=e,t-=4*e}if(t>0&&(r+=Ol.getFractionSign(t)),""!==r){b=n-d*s.value;let t=b;i||(t=f+1*Math.abs(b-f)/3),h.font=c.tablatureFont;const e=h.measureText(r),a=t-e.height/1.5,o=p-e.width/2;h.fillText(r,o,a-c.engravingSettings.tabBendLabelPadding)}}h.lineWidth=w}static getFractionSign(t){switch(t){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${t}/ 4`}}}class Il extends va{xB;_B;TB;MB;constructor(t,e,s,i){super(0,0),this.xB=t,this._B=e,this.TB=s,this.MB=i}doLayout(){this.width=0}paint(t,e,s){this.vB(t,e,s),this.t_(t,e,s)}vB(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0;const l=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this.xB){case g.IntoFromBelow:o=t+i.x+i.getNoteX(this.TB,ch.Left)-l,c=e+i.y+i.getNoteY(this.TB,oh.Center)-r,a=o-n,h=e+i.y+i.getNoteY(this.TB,oh.Center)+r;break;case g.IntoFromAbove:o=t+i.x+i.getNoteX(this.TB,ch.Left)-l,c=e+i.y+i.getNoteY(this.TB,oh.Center)+r,a=o-n,h=e+i.y+i.getNoteY(this.TB,oh.Center)-r;break;default:return}this.EB(s,!1,a,o,h,c)}t_(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0,l=!1;const u=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._B){case w.Shift:case w.Legato:if(a=t+i.x+i.getBeatX(this.TB.beat,ah.PostNotes)+u,h=e+i.y+i.getNoteY(this.TB,oh.Center),this.TB.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.TB.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.TB.slideTarget.beat,ah.OnNotes)-u,c=e+s.y+s.getNoteY(this.TB.slideTarget,oh.Center)):(o=t+i.x+i.width,c=h),this.TB.slideTarget.fret>this.TB.fret?(h+=r,c-=r):(h-=r,c+=r)}else o=t+i.x+this.MB.x,c=h;break;case w.OutUp:a=t+i.x+i.getNoteX(this.TB,ch.Right)+u,h=e+i.y+i.getNoteY(this.TB,oh.Center)+r,o=a+n,c=e+i.y+i.getNoteY(this.TB,oh.Center)-r;break;case w.OutDown:a=t+i.x+i.getNoteX(this.TB,ch.Right)+u,h=e+i.y+i.getNoteY(this.TB,oh.Center)-r,o=a+n,c=e+i.y+i.getNoteY(this.TB,oh.Center)+r;break;case w.PickSlideDown:a=t+i.x+i.getNoteX(this.TB,ch.Right)+2*u,h=e+i.y+i.getNoteY(this.TB,oh.Center),o=t+i.x+i.width,c=h+3*r,this.TB.beat.nextBeat&&this.TB.beat.nextBeat.voice===this.TB.beat.voice&&(o=t+i.x+i.getBeatX(this.TB.beat.nextBeat,ah.PreNotes)),l=!0;break;case w.PickSlideUp:a=t+i.x+i.getNoteX(this.TB,ch.Right)+2*u,h=e+i.y+i.getNoteY(this.TB,oh.Center),o=t+i.x+i.width,c=h-3*r,this.TB.beat.nextBeat&&this.TB.beat.nextBeat.voice===this.TB.beat.voice&&(o=t+i.x+i.getBeatX(this.TB.beat.nextBeat,ah.PreNotes)),l=!0;break;default:return}this.EB(s,l,a,o,h,c)}EB(t,e,s,i,n,r){if(e){const e=new Zo(0,0,y.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class Gl extends Wc{CS;FS;constructor(t,e,s,i=!1){super(t,e,i),this.CS=Wc.getBeamDirectionForNote(t),this.FS=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.FS!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;if(this.CS!==Wc.getBeamDirectionForNote(t))return!1;switch(this.CS){case At.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case At.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),n=this.getBeamDirection(this.startBeat,i),r=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${n}`,a=this.renderer;a.staff.getSharedLayoutData(r,!1)||(a.staff.setSharedLayoutData(r,!0),super.paint(t,e,s))}}class $l extends Aa{LB=null;AS=[];drawBeamHelperAsFlags(t){return t.hasFlag(this.renderer.drawBeamHelperAsFlags(t),this.beat)}doLayout(){this.AS=[],super.doLayout(),this.LB&&(this.LB.renderer=this.renderer,this.LB.doLayout(),this.updateWidth())}createTies(t){if(!t.isVisible)return;const e=this.renderer;if(t.isTieOrigin&&e.showTiedNotes&&t.tieDestination.isVisible){const e=new Wc(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&e.showTiedNotes){const e=new Wc(t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new Wc(t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.AS)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new Gl(t,t.effectSlurDestination,!1,!1);this.AS.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.AS)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new Gl(t.effectSlurOrigin,t,!1,!0);this.AS.push(e),this.addTie(e)}}if(t.slideInType!==g.None||t.slideOutType!==w.None){const e=new Il(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.hasBend){if(!this.LB){const t=new Ol;this.LB=t,t.renderer=this.renderer,this.addTie(t)}this.LB.addBends(t)}}}class Vl extends va{xe;e_=null;s_=null;i_=0;isEmpty=!1;noteStringWidth=0;constructor(t,e,s){super(t,e),this.xe=s}doLayout(){const e=this.xe;let s=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===p.Natural&&0!==e.harmonicValue&&(s=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)0===e.beat.index&&this.renderer.settings.notation.notationMode===t.NotationMode.GuitarPro||(e.bendType===h.Bend||e.bendType===h.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TabNotesOnTiedBends)?this.e_=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this.e_="";else if(this.e_=e.isDead?"x":s.toString(),e.isGhost)this.e_=`(${this.e_})`;else if(e.harmonicType===p.Natural){const t=this.e_.indexOf(String.fromCharCode(46));t>=0&&(this.e_=this.e_.substr(0,t+2)),this.e_=`<${this.e_}>`}if(e.isTrill)this.s_=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(Ht.isAlmostEqualTo(e.harmonicValue,0))this.s_="";else switch(e.harmonicType){case p.Artificial:case p.Pinch:case p.Tap:case p.Semi:case p.Feedback:let t=(s+e.harmonicValue).toString();const i=t.indexOf(String.fromCharCode(46));i>=0&&(t=t.substr(0,i+2)),this.s_=`<${t}>`;break;default:this.s_=""}if(this.isEmpty=!this.e_,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const t=!!this.s_;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this.e_+(t?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,t&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this.i_=3+this.renderer.scoreRenderer.canvas.measureText(this.s_).width,this.width+=this.i_)}}paint(t,e,s){if(this.isEmpty)return;const i=this.noteStringWidth+this.i_,n=t+this.x+(this.width-i)/2;this.paintTrill(n,e,s);const r=kh.note(s,ut.GuitarTabFretNumber,this.xe);try{s.fillText(this.e_,n,e+this.y)}finally{r?.[Symbol.dispose]?.()}}paintTrill(t,e,s){const i=kh.note(s,ut.GuitarTabFretNumber,this.xe);try{const i=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this.s_,t+this.noteStringWidth,e+this.y),this.renderer.scoreRenderer.canvas.font=i}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(t,e,s){const i=new Ce;i.note=this.xe,i.noteHeadBounds=new Pe,i.noteHeadBounds.x=e+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}class Hl extends va{eB=[];sB=null;DS;beat;beamingHelper;maxStringNote=null;minStringNote=null;beatEffects=new Map;notesPerString=new Map;noteStringWidth=0;constructor(t,e,s){super(t,e),this.DS=s}buildBoundingsLookup(t,e,s){for(const i of this.eB)i.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteX(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.x+s.x;switch(e){case ch.Left:break;case ch.Center:i+=s.noteStringWidth/2;break;case ch.Right:i+=s.width}return i}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,oh.Center):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,oh.Center):0}getNoteY(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.y+s.y;switch(e){case oh.Top:case oh.TopWithStem:i-=s.height/2;break;case oh.Center:break;case oh.Bottom:case oh.BottomWithStem:i+=s.height/2;case oh.StemUp:case oh.StemDown:}return i}return 0}doLayout(){let t=0;if(this.beat.deadSlapped)this.sB=new zc,this.sB.renderer=this.renderer,this.sB.doLayout(),t=this.sB.width,this.noteStringWidth=t;else{let e=0;for(let s=0,i=this.eB.length;s<i;s++){const i=this.eB[s];i.renderer=this.renderer,i.doLayout(),i.width>t&&(t=i.width),i.noteStringWidth>e&&(e=i.noteStringWidth)}this.noteStringWidth=e;const s=this.renderer.resources.tablatureFont.size;let i=this.getNoteY(this.minStringNote,oh.Center)+s/2;const n=this.renderer.smuflMetrics.onNoteEffectPadding;for(const t of this.beatEffects.values())t.y+=i,t.x+=this.width/2,t.renderer=this.renderer,i+=t.height+n,t.doLayout()}this.width=t}addNoteGlyph(t,e){this.eB.push(t),this.notesPerString.set(e.string,t),(!this.minStringNote||e.string<this.minStringNote.string)&&(this.minStringNote=e),(!this.maxStringNote||e.string>this.maxStringNote.string)&&(this.maxStringNote=e)}paint(t,e,s){if(t+=this.x,e+=this.y,this.beat.deadSlapped)this.sB?.paint(t,e,s);else{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=it.Middle,s.font=this.DS?i.graceFont:i.tablatureFont;const r=this.eB,a=this.width;for(const i of r)i.renderer=this.renderer,i.width=a,i.paint(t,e,s);s.textBaseline=n;const h=kh.beat(s,yt.GuitarTabEffects,this.beat);try{for(const i of this.beatEffects.values())i.paint(t,e,s)}finally{h?.[Symbol.dispose]?.()}}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}}class Ul extends Pa{n_;beamingHelper;constructor(t,e,s,i){super(t,e,1,ll.getSymbol(i)),this.n_=s}doLayout(){super.doLayout()}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){if(this.n_){const i=kh.beat(s,yt.GuitarTabRests,this.beat);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class zl extends va{static r_="tab.whammy.topoffset";static a_="tab.whammy.bottomffset";ge;UB;h_=!1;constructor(t){super(0,0),this.ge=t,this.UB=this.QB(t)}QB(t){if(t.whammyBarType===dt.Custom)return t.whammyBarPoints;const e=[];switch(t.whammyBarType){case dt.Dive:case dt.Hold:case dt.PrediveDive:case dt.Predive:e.push(new V(0,t.whammyBarPoints[0].value)),e.push(new V(V.MaxPosition,t.whammyBarPoints[1].value));break;case dt.Dip:e.push(new V(0,t.whammyBarPoints[0].value)),e.push(new V(V.MaxPosition/2|0,t.whammyBarPoints[1].value)),e.push(new V(V.MaxPosition,t.whammyBarPoints[t.whammyBarPoints.length-1].value))}return e}doLayout(){super.doLayout(),this.h_=this.renderer.settings.notation.notationMode===t.NotationMode.SongBook&&this.ge.whammyBarType===dt.Dip;let e=null,s=null,i=this.ge;for(;i&&i.hasWhammyBar;)(!e||e.value>i.minWhammyPoint.value)&&(e=i.minWhammyPoint),(!s||s.value<i.maxWhammyPoint.value)&&(s=i.maxWhammyPoint),i=i.nextBeat;let n=s.value>0?Math.abs(this.o_(s.value)):0;(n>0||0!==this.ge.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys))&&(n+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding);const r=e.value<0?Math.abs(this.o_(e.value)):0,a=this.renderer.staff.getSharedLayoutData(zl.r_,-1);let h=a;n>a&&(this.renderer.staff.setSharedLayoutData(zl.r_,n),h=n);const o=this.renderer.staff.getSharedLayoutData(zl.a_,-1);let c=o;r>o&&(this.renderer.staff.setSharedLayoutData(zl.a_,r),c=o),this.height=n+r,this.renderer.registerOverflowTop(h+c)}o_(t){if(0===t)return 0;let e=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(t)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return t<0&&(e=-e),e}paint(e,s,i){const n=kh.beat(i,yt.StandardNotationEffects,this.ge);try{const n=this.renderer;let r=this.ge.nextBeat,h=null,o=ah.PreNotes;r&&(h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.voice.bar),h&&h.staff===n.staff&&(h===n||r.hasWhammyBar)?o=!r.hasWhammyBar||n.settings.notation.notationMode===t.NotationMode.SongBook&&r.whammyBarType===dt.Dip?ah.PreNotes:ah.MiddleNotes:(r=null,h=null));let c=0,l=0;this.h_?(c=e+n.x+n.getBeatX(this.ge,ah.OnNotes),l=e+n.x+n.getBeatX(this.ge,ah.PostNotes)):(c=e+n.x+n.getBeatX(this.ge,ah.MiddleNotes),l=h?e+h.x+h.getBeatX(r,o):e+n.x+n.postBeatGlyphsStart);const u=i.textAlign,d=i.textBaseline;if(i.textAlign=st.Center,i.textBaseline=it.Alphabetic,this.UB.length>=2){const t=(l-c)/V.MaxPosition;i.beginPath();const e=s+this.renderer.staff.getSharedLayoutData(zl.r_,0);let n=this.ge.whammyStyle===a.Gradual?"grad.":"";for(let s=0,r=this.UB.length-1;s<r;s++){const r=this.UB[s],a=this.UB[s+1];let h=0===s;0!==s||0===r.value||this.ge.isContinuedWhammy||(this.c_(!1,new V(0,0),r,c,e,t,i),h=!1),this.c_(h,r,a,c,e,t,i,n),n=""}i.stroke()}i.textAlign=u,i.textBaseline=d}finally{n?.[Symbol.dispose]?.()}}c_(e,s,i,n,r,a,h,o){const c=n+a*s.offset,l=n+a*i.offset,u=r-this.o_(s.value),d=r-this.o_(i.value);if(s.offset===i.offset){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(d-u)/(2*t)<1)h.moveTo(c,u),h.lineTo(l,d);else{const e=Math.max(u,d);let s=Math.min(u,d);for(;e>s;)h.moveTo(c,s),h.lineTo(c,s+t),s+=2*t}h.stroke()}else if(s.value===i.value){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(l-c)/(2*t)<1)h.moveTo(c,u),h.lineTo(l,d);else{let e=Math.max(c,l);const s=Math.min(c,l);for(;e>s;)h.moveTo(e,u),h.lineTo(e-t,u),e-=2*t}h.stroke()}else h.moveTo(c,u),h.lineTo(l,d);const f=this.renderer.smuflMetrics.tabWhammyTextPadding;!e||this.ge.isContinuedWhammy||this.h_||(this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys)&&h.fillText("0",c,u-f),o&&h.fillText(o,c,u-f));let p=Math.abs(i.value);if((0!==p||this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys)&&!this.h_)&&s.value!==i.value){let t="";if(i.value<0&&(t+="-"),p>=4){const e=p/4|0;t+=e,p-=4*e}else 0===p&&(t+="0");p>0&&(t+=Ol.getFractionSign(p));let e=0;e=this.h_||s.offset===i.offset?Math.min(u,d):d;const n=l;h.fillText(t,n,e-f)}}}class jl extends qh{slash=null;noteNumbers=null;restGlyph=null;get effectElement(){return yt.GuitarTabEffects}getNoteX(t,e){return this.noteNumbers?this.noteNumbers.getNoteX(t,e):0}getNoteY(t,e){return this.noteNumbers?this.noteNumbers.getNoteY(t,e):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(t,e,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(t,e+this.x,s+this.y)}doLayout(){const e=this.renderer,s=[];if(this.container.beat.isRest){const t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getTabY(t),i=new Ul(0,s,e.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.container.beat.dots>0&&e.showRests)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new Hc(0,s))}else{const i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==u.None;let n;if(this.container.beat.slashed&&!this.container.beat.notes.some(t=>t.isTieDestination)){const t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getLineY(t),r=new wl(0,s,this.container.beat.duration,i,this.container.beat);r.noteHeadElement=ut.GuitarTabFretNumber,r.effectElement=yt.GuitarTabEffects,this.slash=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addNormal(r),n=r.beatEffects}else{const t=new Hl(0,0,i);this.noteNumbers=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;for(const t of this.container.beat.notes)t.isVisible&&this.mB(t);this.addNormal(t),n=t.beatEffects}if(this.container.beat.hasWhammyBar){const t=new zl(this.container.beat);t.renderer=this.renderer,t.doLayout(),this.container.ties.push(t)}if(this.container.beat.isTremolo&&!n.has("tremolo")){const t=this.container.beat.tremoloSpeed,e=new ol(0,0,t);e.offsetY=this.renderer.smuflMetrics.glyphTop.get(e.symbol),n.set("tremolo",e),s.push(e)}if(this.container.beat.dots>0&&e.rhythmMode!==t.TabRhythmMode.Hidden)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new Hc(0,e.lineOffset*e.bar.staff.tuning.length+e.settings.notation.rhythmHeight))}if(this.isEmpty)return;let i=0;for(let t=0,e=this.glyphs.length;t<e;t++){const e=this.glyphs[t];e.x=i,e.renderer=this.renderer,e.doLayout(),i+=e.width}this.width=i,this.computedWidth=i,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(const t of s)t.x=this.centerX}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}mB(t){const e=this.renderer,s=new Vl(0,0,t),i=t.beat.voice.bar.staff.tuning.length-t.string;s.y=e.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,t);const n=s.y-s.height/2,r=n+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,n,r)}}class Xl extends va{ge;wB;constructor(t){super(0,0),this.ge=t}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(at.ArrowheadBlackDown),this.ge.brushType===o.ArpeggioUp){const t=new Zo(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.wB=t}else if(this.ge.brushType===o.ArpeggioDown){const t=new Zo(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.wB=t}}paint(t,e,s){const i=this.renderer,n=e+this.x+i.getNoteY(this.ge.maxStringNote,oh.Top),r=e+this.y+i.getNoteY(this.ge.minStringNote,oh.Bottom),a=t+this.x+this.width/2,h=this.renderer.smuflMetrics.glyphWidths.get(at.ArrowheadBlackDown);if(this.ge.brushType!==o.None){if(this.ge.brushType===o.BrushUp||this.ge.brushType===o.BrushDown)s.beginPath(),s.moveTo(a,n),s.lineTo(a,r),s.stroke();else if(this.ge.brushType===o.ArpeggioUp){const e=this.wB,i=n,a=r-h;e.width=Math.abs(a-i),s.beginRotate(t+this.x,a,-90),e.paint(0,(this.width-e.height)/2,s),s.endRotate()}else if(this.ge.brushType===o.ArpeggioDown){const e=this.wB,i=n+h,a=r;e.width=Math.abs(a-i),s.beginRotate(t+this.x,i,90),e.paint(0,-(this.width-e.height/2),s),s.endRotate()}this.ge.brushType===o.BrushUp||this.ge.brushType===o.ArpeggioUp?(s.beginPath(),s.moveTo(a,r),s.lineTo(a+h/2,r-h),s.lineTo(a-h/2,r-h),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(a,n),s.lineTo(a+h/2,n+h),s.lineTo(a-h/2,n+h),s.closePath(),s.fill())}}}class Jl extends Jh{doLayout(){this.container.beat.brushType===o.None||this.container.beat.isRest||(this.addEffect(new Xl(this.container.beat)),this.addNormal(new Sc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return yt.GuitarTabEffects}}class ql extends Pa{constructor(t,e){super(t,e,1,at.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?at.FourStringTabClef:at.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(at.GClef),this.offsetX=this.width/2}}class Yl extends qc{doLayout(){this.barSubElement=D.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Ca.GraceScale:1}}class Kl extends Ac{static StaffId="tab";l_=!1;showTimeSignature=!1;showRests=!1;showTiedNotes=!1;u_=!1;get showMultiBarRest(){return this.u_}get repeatsBarSubElement(){return D.GuitarTabsRepeats}get barNumberBarSubElement(){return D.GuitarTabsBarNumber}get barLineBarSubElement(){return D.GuitarTabsBarLines}get staffLineBarSubElement(){return D.GuitarTabsStaffLine}constructor(t,e){super(t,e),e.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this.u_=!0)}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===t.TabRhythmMode.Automatic&&(e=this.bar.staff.showStandardNotation?t.TabRhythmMode.Hidden:t.TabRhythmMode.ShowWithBars),e}getTabY(t){return super.getLineY(t)}getTabHeight(t){return super.getLineHeight(t)}collectSpaces(t){const e=this.smuflMetrics.staffLineThickness;for(const s of this.bar.voices)if(this.hasVoiceContainer(s)){const i=this.getVoiceContainer(s);for(const s of i.beatGlyphs){const n=s.onNotes,r=n.noteNumbers;if(r)for(const[a,h]of r.notesPerString)h.isEmpty||t[this.bar.staff.tuning.length-a].push(new Float32Array([i.x+s.x+n.x+r.x-e,r.width+2*e]))}}}adjustSizes(){if(this.rhythmMode!==t.TabRhythmMode.Hidden){let t=l.Whole;for(const e of this.helpers.beamHelpers)for(const s of e)s.tremoloDuration&&(!t||t<s.tremoloDuration)&&(t=s.tremoloDuration);switch(t){case l.Eighth:this.height+=this.smuflMetrics.glyphHeights.get(at.Tremolo1);break;case l.Sixteenth:this.height+=this.smuflMetrics.glyphHeights.get(at.Tremolo2);break;case l.ThirtySecond:this.height+=this.smuflMetrics.glyphHeights.get(at.Tremolo3)}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),this.rhythmMode!==t.TabRhythmMode.Hidden){this.l_=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)){if(this.getVoiceContainer(t).tupletGroups.length>0){this.l_=!0;break}}this.l_&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){const t=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new ql(0,this.getTabY(t)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.XS())}XS(){this.addPreBeatGlyph(new Sc(0,0,this.smuflMetrics.oneStaffSpace));const t=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Yl(0,this.getTabY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(t){if(this.additionalMultiRestBars){const e=new Qh(this.getVoiceContainer(t));this.addBeatGlyph(e)}else for(const e of t.beats){const s=new $l(e,this.getVoiceContainer(t));s.preNotes=new Jl,s.onNotes=new jl,this.addBeatGlyph(s)}}paint(e,s,i){super.paint(e,s,i),this.rhythmMode!==t.TabRhythmMode.Hidden&&(this.paintBeams(e,s,i,yt.GuitarTabFlags,yt.GuitarTabBeams),this.paintTuplets(e,s,i,yt.GuitarTabTuplet))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===t.TabRhythmMode.ShowWithBeams}getFlagTopY(t,e){const s=this.getOnNotesGlyphForBeat(t);return s.noteNumbers&&t.duration!==l.Half?s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,oh.Bottom)+this.smuflMetrics.staffLineThickness:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(t,e){return this.getFlagAndBarPos()}getFlagStemSize(t,e=!1){return 0}getBarLineStart(t,e){return this.getFlagTopY(t,e)}getBeamDirection(t){return At.Down}getFlagAndBarPos(){return this.height-(this.l_?this.tupletSize/2:0)}calculateBeamYWithDirection(t,e,s){return this.getFlagAndBarPos()}shouldPaintFlag(t,e){return!!super.shouldPaintFlag(t,e)&&(t.graceType===u.None&&this.drawBeamHelperAsFlags(e))}paintBeamingStem(t,e,s,i,n,r){if(n<i){const t=n;n=i,i=t}const a=kh.beat(r,yt.GuitarTabStem,t);try{let a=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(t.displayStart)&&(a=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(t.displayStart).slots.slice(),a.sort((t,e)=>t.topY-e.topY));let h=n;for(;h>i;){let t=i;if(!(a.length>0&&a[a.length-1].bottomY>t)){r.fillRect(s,t,this.smuflMetrics.stemThickness,h-t);break}{const i=a.pop();t=e+i.bottomY,r.fillRect(s,t,this.smuflMetrics.stemThickness,h-t),h=e+i.topY}}}finally{a?.[Symbol.dispose]?.()}}}class Ql extends gh{showTimeSignature=null;showRests=null;showTiedNotes=null;get staffId(){return Kl.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){const s=new Kl(t,e);return null!==this.showRests&&(s.showRests=this.showRests),null!==this.showTimeSignature&&(s.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(s.showTiedNotes=this.showTiedNotes),s}}class Zl{vertical;createLayout;constructor(t,e){this.vertical=t,this.createLayout=e}}class tu{supportsWorkers;createCanvas;constructor(t,e){this.supportsWorkers=t,this.createCanvas=e}}class eu{static d_="before-slash-always";static f_="before-score-always";static p_="before-score-hideable";static b_="before-numbered-always";static m_="before-tab-always";static g_="before-tab-hideable";static w_="before-end-always";static highDpiFactor=1;static y_=void 0;static get globalThis(){if(void 0===eu.y_){try{eu.y_=globalThis}catch{}void 0===eu.y_&&(eu.y_=self),void 0===eu.y_&&(eu.y_=global),void 0===eu.y_&&(eu.y_=window),void 0===eu.y_&&(eu.y_=Function("return this")())}return eu.y_}static webPlatform=eu.k_();static isWebPackBundled=eu.S_();static isViteBundled=eu.B_();static scriptFile=eu.__();static fontDirectory=eu.x_();static get isRunningInWorker(){return"WorkerGlobalScope"in eu.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in eu.globalThis}static createWebWorker;static createAudioWorklet;static throttle(t,e){let s=0;return()=>{eu.globalThis.clearTimeout(s),s=eu.globalThis.setTimeout(t,e)}}static __(){if(!eu.isRunningInWorker&&eu.globalThis.ALPHATAB_ROOT){let t=eu.globalThis.ALPHATAB_ROOT;return t=eu.ensureFullUrl(t),t=eu.T_(t),t}try{const t={};if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in eu.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let e="";const s=eu.globalThis.location;if(e+=s.protocol?.toString(),e+="//"?.toString(),s.hostname&&(e+=s.hostname?.toString()),s.port&&(e+=":"?.toString(),e+=s.port?.toString()),!t.startsWith("/")){const t=s.pathname.split("/").slice(0,-1).join("/");t.length>0&&(t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString())}return t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString(),e}return t}static T_(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static x_(){if(!eu.isRunningInWorker&&eu.globalThis.ALPHATAB_FONT)return eu.ensureFullUrl(eu.globalThis.ALPHATAB_FONT);const t=eu.scriptFile;if(t){const e=t.lastIndexOf(String.fromCharCode(47));if(e>=0)return`${t.substr(0,e)}/font/`}return null}static M_(){if(!eu.isRunningInWorker&&eu.globalThis&&"jQuery"in eu.globalThis){const t=eu.globalThis.jQuery,e=new rh;t.fn.alphaTab=function(t){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?e.exec(this[0],t,s):this.each((i,n)=>{e.exec(n,t,s)})},t.alphaTab={restore:rh.restore},t.fn.alphaTab.fn=e}}static renderEngines=eu.v_();static layoutEngines=eu.N_();static staveProfiles=eu.P_();static getRenderEngineFactory(t){return t&&eu.renderEngines.has(t)?eu.renderEngines.get(t):eu.renderEngines.get("default")}static getLayoutEngineFactory(e){return e&&eu.layoutEngines.has(e)?eu.layoutEngines.get(e):eu.layoutEngines.get(t.LayoutMode.Page)}static buildImporters(){return[new js,new ui,new ai,new gi,new zs,new Ve]}static v_(){const t=new Map;return t.set("svg",new tu(!0,()=>new mh)),t.set("default",t.get("svg")),t.set("skia",new tu(!1,()=>new ph)),eu.E_(t),t}static enableAlphaSkia(t,e){ph.enable(t,e)}static registerAlphaSkiaCustomFont(t){return ph.registerFont(t)}static E_(t){t.set("html5",new tu(!1,()=>new ua))}static C_(){return[new ro(eu.d_,[new hc,new dc,new Vo,new Bo,new oo,new Fo,new oc,new po,new mo]),new Wl,new ro(eu.f_,[new No,new uo,new Uo,new Ko,new pc]),new ro(eu.p_,[new bc,new lc,new jo(!0),new mc,new ec,new gc,new sc(!1),new Oo,new Do(ft.Finger)],(t,e)=>e.showStandardNotation),new El,new ro(eu.b_,[new wo,new jo(!1),new xo,new Do(ft.Thumb,(t,e)=>e.voice.bar.staff.showStandardNotation),new nc]),new Zc,new ro(eu.m_,[new $o]),new ro(eu.g_,[new lc,new mc,new ec,new gc,new sc(!0),new rc,new Mo,new Wo(p.Natural),new Wo(p.Artificial),new Wo(p.Pinch),new Wo(p.Tap),new Wo(p.Semi),new Wo(p.Feedback),new Io,new bo,new Co,new Xo,new Yo,new Jo,new Oo,new Do(ft.Finger,(t,e)=>!e.voice.bar.staff.showStandardNotation)],(t,e)=>e.showTablature),new Ql,new ro(eu.w_,[new Do(ft.Thumb,(t,e)=>!e.voice.bar.staff.showStandardNotation)])]}static P_(){const e=new Map,s=eu.C_();e.set(t.StaveProfile.Default,s),e.set(t.StaveProfile.ScoreTab,s);const i=new Set([eu.d_,eu.f_,eu.b_,eu.m_,Pl.StaffId,eu.w_]);e.set(t.StaveProfile.Score,s.filter(t=>i.has(t.staffId)));const n=new Set([eu.d_,eu.f_,eu.b_,eu.m_,Kl.StaffId,eu.w_]);return e.set(t.StaveProfile.Tab,eu.C_().filter(t=>{if(t instanceof Ql){const e=t;e.showTimeSignature=!0,e.showRests=!0,e.showTiedNotes=!0}return n.has(t.staffId)})),e.set(t.StaveProfile.TabMixed,eu.C_().filter(t=>{if(t instanceof Ql){const e=t;e.showTimeSignature=!1,e.showRests=!1,e.showTiedNotes=!1}return n.has(t.staffId)})),e}static N_(){const e=new Map;return e.set(t.LayoutMode.Page,new Zl(!0,t=>new kc(t))),e.set(t.LayoutMode.Horizontal,new Zl(!1,t=>new yc(t))),e}static initializeMain(e,s){eu.isRunningInWorker||eu.isRunningInAudioWorklet||(eu.webPlatform!==t.WebPlatform.Browser&&eu.webPlatform!==t.WebPlatform.BrowserModule||(eu.M_(),eu.highDpiFactor=window.devicePixelRatio),eu.createWebWorker=e,eu.createAudioWorklet=s)}static get alphaTabWorker(){return eu.globalThis.Worker}static get alphaTabUrl(){return eu.globalThis.URL}static initializeWorker(){if(!eu.isRunningInWorker)throw new R(t.AlphaTabErrorType.General,"Not running in worker, cannot run worker initialization");la.init(),ha.init(),eu.createWebWorker=e=>{throw new R(t.AlphaTabErrorType.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!eu.isRunningInAudioWorklet)throw new R(t.AlphaTabErrorType.General,"Not running in audio worklet, cannot run worklet initialization");_i.init()}static S_(){try{if("function"==typeof __webpack_require__)return!0}catch{}return!1}static B_(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static k_(){if(!(void 0!==eu.globalThis.Window&&eu.globalThis instanceof eu.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return t.WebPlatform.NodeJs}catch{}try{const e={};if(e&&"string"==typeof e&&!e.startsWith("file://"))return t.WebPlatform.BrowserModule}catch{}return t.WebPlatform.Browser}static printEnvironmentInfo(t=!0){const e=t?t=>{j.log.debug("VersionInfo",t)}:t=>{j.debug("VersionInfo",t)};O.print(e),e(`High DPI: ${eu.highDpiFactor}`),eu.F_(e)}static F_(e){e(`Platform: ${t.WebPlatform[eu.webPlatform]}`),e(`WebPack: ${eu.isWebPackBundled}`),e(`Vite: ${eu.isViteBundled}`),eu.webPlatform!==t.WebPlatform.NodeJs&&(e(`Browser: ${navigator.userAgent}`),e(`Window Size: ${window.outerWidth}x${window.outerHeight}`),e(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){const e=t.A_;if(e)return eu.prepareForPostMessage(e)}return t}static quoteJsonString(t){return JSON.stringify(t)}}t.FontFileFormat=void 0,(dh=t.FontFileFormat||(t.FontFileFormat={}))[dh.EmbeddedOpenType=0]="EmbeddedOpenType",dh[dh.Woff=1]="Woff",dh[dh.Woff2=2]="Woff2",dh[dh.OpenType=3]="OpenType",dh[dh.TrueType=4]="TrueType",dh[dh.Svg=5]="Svg";class su{scriptFile=null;fontDirectory=null;smuflFontSources=null;static buildDefaultSmuflFontSources(e){const s=new Map,i=e??"";return s.set(t.FontFileFormat.Woff2,`${i}Bravura.woff2`),s.set(t.FontFileFormat.Woff,`${i}Bravura.woff`),s.set(t.FontFileFormat.OpenType,`${i}Bravura.otf`),s}file=null;tex=!1;tracks=null;enableLazyLoading=!0;engine="default";logLevel=t.LogLevel.Info;useWorkers=!0;includeNoteBounds=!1;constructor(){this.scriptFile=eu.scriptFile,this.fontDirectory=eu.fontDirectory}}const iu=Object.freeze(Object.defineProperty({__proto__:null,get AlphaTexAccidentalMode(){return _t},AlphaTexDiagnosticBag:re,get AlphaTexDiagnosticCode(){return Bt},get AlphaTexDiagnosticsSeverity(){return St},AlphaTexLexer:oe,get AlphaTexNodeType(){return kt},get AlphaTexParseMode(){return Mt},AlphaTexParser:ce,get AlphaTexStaffNoteKind(){return xt},get ArgumentListParseTypesMode(){return Tt}},Symbol.toStringTag,{value:"Module"})),nu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexErrorWithDiagnostics:Ge,AlphaTexImporter:Ve,ScoreImporter:Re,ScoreLoader:za,UnsupportedFormatError:Oe,alphaTex:iu},Symbol.toStringTag,{value:"Module"})),ru=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:Ie,IOHelper:he},Symbol.toStringTag,{value:"Module"}));class au{data;settings;init(t,e){this.data=t,this.settings=e}export(t,e=null){const s=Ie.withCapacity(1024);return this.init(s,e??new Fr),this.writeScore(t),s.toArray()}}class hu{tex="";isStartOfLine=!0;indentString="";currentIndent=0;indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}D_(){if(this.isStartOfLine&&this.indentString.length>0)for(let t=0;t<this.currentIndent;t++)this.tex+=this.indentString;this.isStartOfLine=!1}write(t){this.D_(),this.tex+=t,this.isStartOfLine=!1}writeString(t){this.D_(),this.tex+=eu.quoteJsonString(t)}writeLine(t){this.D_(),void 0!==t&&(this.tex+=t),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class ou{L_;W_=!1;get tex(){return this.L_.tex}constructor(t){const e=new hu;this.W_=t.exporter.comments,e.indentString=t.exporter.indent>0?" ".repeat(t.exporter.indent):"",this.L_=e}writeScoreNode(t){this.R_(t.leadingComments);for(const e of t.bars)this.O_(e);this.R_(t.trailingComments)}O_(t){this.R_(t.leadingComments),this.I_(t.metaData),this.L_.indent();for(const e of t.beats)this.G_(e);this.L_.outdent(),this.R_(t.trailingComments),this.V_(t.pipe,!0)}G_(t){this.R_(t.leadingComments),t.durationChange&&this.H_(t.durationChange),t.rest?this.U_(t.rest):t.notes&&this.z_(t.notes),this.V_(t.durationDot,!1),this.U_(t.durationValue),this.V_(t.beatMultiplier,!1),this.U_(t.beatMultiplierValue),t.beatEffects&&this.j_(t.beatEffects,!1),this.R_(t.trailingComments),this.L_.writeLine()}z_(t){this.R_(t.leadingComments),this.V_(t.openParenthesis,!1);let e=!0;for(const s of t.notes)e||this.L_.write(" "),this.X_(s),e=!1;this.V_(t.closeParenthesis,!1),this.R_(t.trailingComments)}X_(t){this.R_(t.leadingComments),this.U_(t.noteValue),this.V_(t.noteStringDot,!1),this.U_(t.noteString),t.noteEffects&&this.j_(t.noteEffects,!1),this.R_(t.trailingComments)}H_(t){this.R_(t.leadingComments),this.V_(t.colon,!1),this.U_(t.value),t.properties&&(this.L_.write(" "),this.j_(t.properties,!1)),this.R_(t.trailingComments),this.L_.write(" ")}I_(t){for(const e of t)this.J_(e)}q_=0;Y_=0;K_=0;J_(t){switch(t.tag.tag.text){case"track":this.q_>0&&this.L_.outdent();break;case"staff":this.Y_>0&&this.L_.outdent();break;case"voice":this.K_>0&&this.L_.outdent()}this.R_(t.leadingComments),this.V_(t.tag.prefix,!1),this.U_(t.tag.tag);let e=!0;switch(t.propertiesBeforeArguments?(t.properties&&(this.L_.write(" "),this.j_(t.properties,!1)),t.arguments&&(this.L_.write(" "),this.Q_(t.arguments))):(t.arguments&&(this.L_.write(" "),this.Q_(t.arguments)),t.properties&&(this.L_.write(" "),this.j_(t.properties,!0),e=!1)),t.trailingComments&&(this.L_.write(" "),this.R_(t.trailingComments)),t.tag.tag.text){case"track":this.q_++,this.Y_=0,this.K_=0,this.L_.indent();break;case"staff":this.Y_++,this.K_=0,this.L_.indent();break;case"voice":this.K_++,this.L_.indent()}e&&this.L_.writeLine()}j_(t,e){this.R_(t.leadingComments),this.V_(t.openBrace,e),e&&this.L_.indent();let s=!0;for(const i of t.properties)s||e||this.L_.write(" "),this.Z_(i),s=!1,e&&this.L_.writeLine();e&&this.L_.outdent(),this.V_(t.closeBrace,e),this.R_(t.trailingComments)}Z_(t){this.R_(t.leadingComments),this.U_(t.property),t.arguments&&(this.L_.write(" "),this.Q_(t.arguments)),this.R_(t.trailingComments)}Q_(t){this.R_(t.leadingComments),this.V_(t.openParenthesis,!1);let e=!0;for(const s of t.arguments)e||this.L_.write(" "),this.U_(s),e=!1;this.V_(t.closeParenthesis,!1),this.R_(t.trailingComments)}U_(t){if(t){switch(this.R_(t.leadingComments),t.nodeType){case kt.Ident:this.L_.write(t.text);break;case kt.Arguments:this.Q_(t);break;case kt.Number:this.L_.write(t.value.toString());break;case kt.String:this.L_.writeString(t.text)}this.R_(t.trailingComments)}}V_(t,e){if(t){switch(this.R_(t.leadingComments),t.nodeType){case kt.Dot:this.L_.write(".");break;case kt.Backslash:this.L_.write("\\");break;case kt.DoubleBackslash:this.L_.write("\\\\");break;case kt.Pipe:this.L_.write("|");break;case kt.LBrace:this.L_.write("{");break;case kt.RBrace:this.L_.write("}");break;case kt.LParen:this.L_.write("(");break;case kt.RParen:this.L_.write(")");break;case kt.Colon:this.L_.write(":");break;case kt.Asterisk:this.L_.write("*")}this.R_(t.trailingComments),e&&this.L_.writeLine()}}R_(t){if(this.W_&&t)for(const e of t){let t=e.text;t.startsWith(" ")||(t=` ${t}`),e.multiLine?(t.endsWith(" ")||(t+=" "),this.L_.write(`/*${t}*/`)):this.L_.writeLine(`//${t}`)}}}var cu;!function(t){t[t.SteelGuitar=1]="SteelGuitar",t[t.AcousticGuitar=2]="AcousticGuitar",t[t.TwelveStringGuitar=3]="TwelveStringGuitar",t[t.ElectricGuitar=4]="ElectricGuitar",t[t.Bass=5]="Bass",t[t.ClassicalGuitar=23]="ClassicalGuitar",t[t.UprightBass=6]="UprightBass",t[t.Ukulele=7]="Ukulele",t[t.Banjo=8]="Banjo",t[t.Mandolin=9]="Mandolin",t[t.Piano=10]="Piano",t[t.Synth=12]="Synth",t[t.Strings=11]="Strings",t[t.Brass=13]="Brass",t[t.Reed=14]="Reed",t[t.Woodwind=15]="Woodwind",t[t.Vocal=16]="Vocal",t[t.PitchedIdiophone=17]="PitchedIdiophone",t[t.Fx=21]="Fx",t[t.PercussionKit=18]="PercussionKit",t[t.Idiophone=19]="Idiophone",t[t.Membraphone=20]="Membraphone"}(cu||(cu={}));class lu{icon=cu.Piano;instrumentSetName;instrumentSetType;constructor(t,e,s=null){if(this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const t=e.split(" ");t[0]=t[0].substr(0,1).toLowerCase()+t[0].substr(1),this.instrumentSetType=t.join("")}}}class uu{static ha=44100;tx=new Map;static sx=new Map([[0,new lu(cu.Piano,"Acoustic Piano")],[1,new lu(cu.Piano,"Acoustic Piano")],[2,new lu(cu.Piano,"Electric Piano")],[3,new lu(cu.Piano,"Acoustic Piano")],[4,new lu(cu.Piano,"Electric Piano")],[5,new lu(cu.Piano,"Electric Piano")],[6,new lu(cu.Piano,"Harpsichord")],[7,new lu(cu.Piano,"Harpsichord")],[8,new lu(cu.PitchedIdiophone,"Celesta")],[9,new lu(cu.PitchedIdiophone,"Vibraphone")],[10,new lu(cu.PitchedIdiophone,"Vibraphone")],[11,new lu(cu.PitchedIdiophone,"Vibraphone")],[12,new lu(cu.PitchedIdiophone,"Xylophone")],[13,new lu(cu.PitchedIdiophone,"Xylophone")],[14,new lu(cu.PitchedIdiophone,"Vibraphone")],[15,new lu(cu.Banjo,"Banjo")],[16,new lu(cu.Piano,"Electric Organ")],[17,new lu(cu.Piano,"Electric Organ")],[18,new lu(cu.Piano,"Electric Organ")],[19,new lu(cu.Piano,"Electric Organ")],[20,new lu(cu.Piano,"Electric Organ")],[21,new lu(cu.Piano,"Electric Organ")],[22,new lu(cu.Woodwind,"Recorder")],[23,new lu(cu.Piano,"Electric Organ")],[24,new lu(cu.ClassicalGuitar,"Nylon Guitar")],[25,new lu(cu.SteelGuitar,"Steel Guitar")],[26,new lu(cu.SteelGuitar,"Electric Guitar")],[27,new lu(cu.ElectricGuitar,"Electric Guitar")],[28,new lu(cu.ElectricGuitar,"Electric Guitar")],[29,new lu(cu.ElectricGuitar,"Electric Guitar")],[30,new lu(cu.SteelGuitar,"Electric Guitar")],[31,new lu(cu.SteelGuitar,"Electric Guitar")],[32,new lu(cu.Bass,"Acoustic Bass")],[33,new lu(cu.Bass,"Electric Bass")],[34,new lu(cu.Bass,"Electric Bass")],[35,new lu(cu.Bass,"Acoustic Bass")],[36,new lu(cu.Bass,"Electric Bass")],[37,new lu(cu.Bass,"Electric Bass")],[38,new lu(cu.Synth,"Synth Bass")],[39,new lu(cu.Synth,"Synth Bass")],[40,new lu(cu.Strings,"Violin")],[41,new lu(cu.Strings,"Viola")],[42,new lu(cu.Strings,"Cello")],[43,new lu(cu.Strings,"Contrabass")],[44,new lu(cu.Strings,"Violin")],[45,new lu(cu.Strings,"Violin")],[46,new lu(cu.Piano,"Harp")],[47,new lu(cu.Membraphone,"Timpani")],[48,new lu(cu.Strings,"Violin")],[49,new lu(cu.Strings,"Violin")],[50,new lu(cu.Strings,"Violin")],[51,new lu(cu.Strings,"Violin")],[52,new lu(cu.Vocal,"Voice")],[53,new lu(cu.Vocal,"Voice")],[54,new lu(cu.Vocal,"Voice")],[55,new lu(cu.Synth,"Pad Synthesizer")],[56,new lu(cu.Brass,"Trumpet")],[57,new lu(cu.Brass,"Trombone")],[58,new lu(cu.Brass,"Tuba")],[59,new lu(cu.Brass,"Trumpet")],[60,new lu(cu.Brass,"French Horn")],[61,new lu(cu.Brass,"Trumpet")],[62,new lu(cu.Brass,"Trumpet")],[63,new lu(cu.Brass,"Trumpet")],[64,new lu(cu.Reed,"Saxophone")],[65,new lu(cu.Reed,"Saxophone")],[66,new lu(cu.Reed,"Saxophone")],[67,new lu(cu.Reed,"Saxophone")],[68,new lu(cu.Reed,"Oboe")],[69,new lu(cu.Reed,"English Horn")],[70,new lu(cu.Reed,"Bassoon")],[71,new lu(cu.Reed,"Clarinet")],[72,new lu(cu.Reed,"Piccolo")],[73,new lu(cu.Woodwind,"Flute")],[74,new lu(cu.Woodwind,"Recorder")],[75,new lu(cu.Woodwind,"Flute")],[76,new lu(cu.Woodwind,"Recorder")],[77,new lu(cu.Woodwind,"Flute")],[78,new lu(cu.Woodwind,"Recorder")],[79,new lu(cu.Woodwind,"Flute")],[80,new lu(cu.Synth,"Lead Synthesizer")],[81,new lu(cu.Synth,"Lead Synthesizer")],[82,new lu(cu.Synth,"Lead Synthesizer")],[83,new lu(cu.Synth,"Lead Synthesizer")],[84,new lu(cu.Synth,"Lead Synthesizer")],[85,new lu(cu.Synth,"Lead Synthesizer")],[86,new lu(cu.Synth,"Lead Synthesizer")],[87,new lu(cu.Synth,"Lead Synthesizer")],[88,new lu(cu.Synth,"Pad Synthesizer")],[89,new lu(cu.Synth,"Pad Synthesizer")],[90,new lu(cu.Synth,"Pad Synthesizer")],[91,new lu(cu.Synth,"Pad Synthesizer")],[92,new lu(cu.Synth,"Pad Synthesizer")],[93,new lu(cu.Synth,"Pad Synthesizer")],[94,new lu(cu.Synth,"Pad Synthesizer")],[95,new lu(cu.Synth,"Pad Synthesizer")],[96,new lu(cu.Fx,"Pad Synthesizer")],[97,new lu(cu.Fx,"Pad Synthesizer")],[98,new lu(cu.Fx,"Pad Synthesizer")],[99,new lu(cu.Fx,"Pad Synthesizer")],[100,new lu(cu.Fx,"Lead Synthesizer")],[101,new lu(cu.Fx,"Lead Synthesizer")],[102,new lu(cu.Fx,"Lead Synthesizer")],[103,new lu(cu.Fx,"Trumpet")],[104,new lu(cu.ElectricGuitar,"Banjo")],[105,new lu(cu.Banjo,"Banjo")],[106,new lu(cu.Ukulele,"Ukulele")],[107,new lu(cu.Banjo,"Banjo")],[108,new lu(cu.PitchedIdiophone,"Xylophone")],[109,new lu(cu.Reed,"Bassoon")],[110,new lu(cu.Strings,"Violin")],[111,new lu(cu.Woodwind,"Flute")],[112,new lu(cu.PitchedIdiophone,"Xylophone")],[113,new lu(cu.Idiophone,"Celesta")],[114,new lu(cu.PitchedIdiophone,"Vibraphone")],[115,new lu(cu.Idiophone,"Xylophone")],[116,new lu(cu.Membraphone,"Xylophone")],[117,new lu(cu.Membraphone,"Xylophone")],[118,new lu(cu.Membraphone,"Xylophone")],[119,new lu(cu.Idiophone,"Celesta")],[120,new lu(cu.Fx,"Steel Guitar")],[121,new lu(cu.Fx,"Recorder")],[122,new lu(cu.Fx,"Recorder")],[123,new lu(cu.Fx,"Recorder")],[124,new lu(cu.Fx,"Recorder")],[125,new lu(cu.Fx,"Recorder")],[126,new lu(cu.Fx,"Recorder")],[127,new lu(cu.Fx,"Timpani")]]);static ix=new lu(cu.PercussionKit,"Drums","drumKit");writeXml(t){const e=new Es;return this.tx=new Map,this.nx(e,t),e.toFormattedString("",!0)}nx(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const n=s.addElement("Encoding");n.addElement("EncodingDescription").innerText="GP8";const r=new Ms;r.nodeType=qe.Comment,r.value=`Written by alphaTab ${O.version} (${O.commit})`,n.addChild(r),this.hx(s,e),this.ox(s,e),this.lx(s,e),this.ux(s,e),this.bx(s,e),this.mx(s,e),this.gx(s,e);const a=s.addElement("Bars"),h=s.addElement("Voices"),o=s.addElement("Beats"),c=s.addElement("Notes"),l=s.addElement("Rhythms");for(const t of e.tracks)for(const e of t.staves)for(const t of e.bars){this.wx(a,t);for(const e of t.voices){this.yx(h,e);for(const t of e.beats){this.kx(o,t,l);for(const e of t.notes)this.Sx(c,e)}}}}gx(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("Assets").addElement("Asset");s.attributes.set("id",this.oa),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}oa;Bx;backingTrackAssetFileName;lx(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("BackingTrack");this.oa="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";const n=void 0!==this.Bx?this.Bx:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}Sx(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this._x(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case d.Normal:i|=8;break;case d.Heavy:i|=4;break;case d.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const t=s.addElement("Tie");t.attributes.set("origin",e.isTieOrigin?"true":"false"),t.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case y.Slight:s.addElement("Vibrato").innerText="Slight";break;case y.Wide:s.addElement("Vibrato").innerText="Wide"}if(e.isFingering){switch(e.leftHandFinger){case f.Thumb:s.addElement("LeftFingering").innerText="P";break;case f.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case f.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case f.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case f.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(e.rightHandFinger){case f.Thumb:s.addElement("RightFingering").innerText="P";break;case f.IndexFinger:s.addElement("RightFingering").innerText="I";break;case f.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case f.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case f.LittleFinger:s.addElement("RightFingering").innerText="C"}}e.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=e.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",e.ornament!==lt.None&&(s.addElement("Ornament").innerText=lt[e.ornament])}_x(t,e){const s=t.addElement("Properties");if(this.xx(s,e),this.Tx(s,e),e.isStringed&&(this.Mx(s,"String","String",(e.string-1).toString()),this.Mx(s,"Fret","Fret",e.fret.toString()),this.Mx(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this.Mx(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this.Mx(s,"Octave","Number",e.octave.toString()),this.Mx(s,"Tone","Step",e.tone.toString()),this.Mx(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this.Mx(s,"Tapped","Enable",null),e.harmonicType!==p.None){switch(e.harmonicType){case p.Natural:this.Mx(s,"HarmonicType","HType","Natural");break;case p.Artificial:this.Mx(s,"HarmonicType","HType","Artificial");break;case p.Pinch:this.Mx(s,"HarmonicType","HType","Pinch");break;case p.Tap:this.Mx(s,"HarmonicType","HType","Tap");break;case p.Semi:this.Mx(s,"HarmonicType","HType","Semi");break;case p.Feedback:this.Mx(s,"HarmonicType","HType","Feedback")}0!==e.harmonicValue&&this.Mx(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this.Mx(s,"Muted","Enable",null),e.isPalmMute&&this.Mx(s,"PalmMuted","Enable",null),e.hasBend&&this.vx(s,e),e.isHammerPullOrigin&&this.Mx(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this.Mx(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this.Mx(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case g.IntoFromAbove:i|=32;break;case g.IntoFromBelow:i|=16}switch(e.slideOutType){case w.Shift:i|=1;break;case w.Legato:i|=2;break;case w.OutDown:i|=4;break;case w.OutUp:i|=8;break;case w.PickSlideDown:i|=64;break;case w.PickSlideUp:i|=128}i>0&&this.Mx(s,"Slide","Flags",i.toString())}Tx(t,e){e.isPercussion?this.Nx(t,"ConcertPitch","C","-1",""):this.Px(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode,e.beat.voice.bar.keySignature)}xx(t,e){e.isPercussion?this.Nx(t,"ConcertPitch","C","-1",""):this.Px(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode,e.beat.voice.bar.keySignature)}static Ex=["C","C","D","D","E","F","F","G","G","A","A","B"];Px(t,e,s,i,n){let r=0,a=0,h="",o="";const c=()=>{switch(r=s%12,a=s/12|0,h=uu.Ex[r],Ht.computeAccidental(n,b.Default,s,!1)){case ht.None:case ht.Natural:o="";break;case ht.Sharp:o="#";break;case ht.Flat:o="b";break;case ht.DoubleSharp:o="x";break;case ht.DoubleFlat:o="bb"}};switch(c(),i){case b.Default:break;case b.ForceNone:case b.ForceNatural:o="";break;case b.ForceSharp:o="#";break;case b.ForceDoubleSharp:"#"===o&&(s-=2,c()),o="x";break;case b.ForceFlat:"#"===o&&(s+=1,c()),o="b";break;case b.ForceDoubleFlat:"#"===o&&(s+=2,c()),o="bb"}this.Nx(t,e,h,a.toString(),o)}Nx(t,e,s,i,n){const r=t.addElement("Property");r.attributes.set("name",e);const a=r.addElement("Pitch");a.addElement("Step").innerText=s,a.addElement("Accidental").innerText=n,a.addElement("Octave").innerText=i}vx(t,e){e.hasBend&&e.bendPoints.length<=4&&this.Cx(t,e.bendPoints)}Cx(t,e){this.Mx(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let n,r;switch(e.length){case 4:n=e[1],r=e[2];break;case 3:n=e[1],r=e[1];break;default:n=new V((s.offset+i.offset)/2,(s.value+i.value)/2),r=n}this.Mx(t,"BendDestinationOffset","Float",this.Gh(i.offset).toString()),this.Mx(t,"BendDestinationValue","Float",this.Ih(i.value).toString()),this.Mx(t,"BendMiddleOffset1","Float",this.Gh(n.offset).toString()),this.Mx(t,"BendMiddleOffset2","Float",this.Gh(r.offset).toString()),this.Mx(t,"BendMiddleValue","Float",this.Ih(n.value).toString()),this.Mx(t,"BendOriginOffset","Float",this.Gh(s.offset).toString()),this.Mx(t,"BendOriginValue","Float",this.Ih(s.value).toString())}Ih(t){return 25*t}Gh(t){return t/V.MaxPosition*100}kx(t,e,s){const i=t.addElement("Beat");if(i.attributes.set("id",e.id.toString()),i.addElement("Dynamic").innerText=n[e.dynamics],e.fade!==pt.None&&(i.addElement("Fadding").innerText=pt[e.fade]),e.isTremolo)switch(e.tremoloSpeed){case l.Eighth:i.addElement("Tremolo").innerText="1/2";break;case l.Sixteenth:i.addElement("Tremolo").innerText="1/4";break;case l.ThirtySecond:i.addElement("Tremolo").innerText="1/8"}switch(e.hasChord&&i.addElement("Chord").setCData(e.chordId),e.crescendo!==c.None&&(i.addElement("Hairpin").innerText=c[e.crescendo]),e.brushType){case o.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case o.ArpeggioDown:i.addElement("Arpeggio").innerText="Down"}switch(e.text&&i.addElement("FreeText").setCData(e.text),e.graceType){case u.OnBeat:case u.BeforeBeat:i.addElement("GraceNotes").innerText=u[e.graceType]}if(e.ottava!==m.Regular&&(i.addElement("Ottavia").innerText=m[e.ottava].substr(1)),e.hasWhammyBar&&this.Ax(i,e),e.isLegatoOrigin||e.isLegatoDestination){const t=i.addElement("Legato");t.attributes.set("origin",e.isLegatoOrigin?"true":"false"),t.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this.Dx(i,e,s),null!==e.preferredBeamDirection)switch(e.preferredBeamDirection){case At.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case At.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&i.addElement("Slashed"),e.deadSlapped&&i.addElement("DeadSlapped"),e.notes.length>0&&(i.addElement("Notes").innerText=e.notes.map(t=>t.id).join(" ")),e.golpe!==ft.None&&(i.addElement("Golpe").innerText=ft[e.golpe]),e.wahPedal!==bt.None&&(i.addElement("Wah").innerText=bt[e.wahPedal]),e.showTimer&&(i.addElement("Timer").innerText=(e.timer??0).toString()),this.Lx(i,e),this.Wx(i,e),e.lyrics&&e.lyrics.length>0&&this.Rx(i,e.lyrics)}Rx(t,e){const s=t.addElement("Lyrics");for(const t of e){s.addElement("Line").setCData(t)}}Wx(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this.Ox(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case wt.ForceSplitToNext:this.Ox(s,"1124204546","Int","2");break;case wt.ForceMergeWithNext:this.Ox(s,"1124204546","Int","1");break;case wt.ForceSplitOnSecondaryToNext:this.Ox(s,"1124204552","Int","1")}}Lx(t,e){const s=t.addElement("Properties");switch(e.brushType){case o.BrushUp:this.Mx(s,"Brush","Direction","Up");break;case o.BrushDown:this.Mx(s,"Brush","Direction","Down")}switch(e.pickStroke){case ot.Up:this.Mx(s,"PickStroke","Direction","Up");break;case ot.Down:this.Mx(s,"PickStroke","Direction","Down")}switch(e.slap&&this.Mx(s,"Slapped","Enable",null),e.pop&&this.Mx(s,"Popped","Enable",null),e.vibrato){case y.Wide:this.Mx(s,"VibratoWTremBar","Strength","Wide");break;case y.Slight:this.Mx(s,"VibratoWTremBar","Strength","Slight")}if(e.isBarre)switch(this.Mx(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case mt.Full:this.Mx(s,"BarreString","String","0");break;case mt.Half:this.Mx(s,"BarreString","String","1")}if(e.rasgueado!==gt.None){let t="";switch(e.rasgueado){case gt.Ii:t="ii_1";break;case gt.Mi:t="mi_1";break;case gt.MiiTriplet:t="mii_1";break;case gt.MiiAnapaest:t="mii_2";break;case gt.PmpTriplet:t="pmp_1";break;case gt.PmpAnapaest:t="pmp_2";break;case gt.PeiTriplet:t="pei_1";break;case gt.PeiAnapaest:t="pei_2";break;case gt.PaiTriplet:t="pai_1";break;case gt.PaiAnapaest:t="pai_2";break;case gt.AmiTriplet:t="ami_1";break;case gt.AmiAnapaest:t="ami_2";break;case gt.Ppp:t="ppp_1";break;case gt.Amii:t="amii_1";break;case gt.Amip:t="amip_1";break;case gt.Eami:t="eami_1";break;case gt.Eamii:t="eamii_1";break;case gt.Peami:t="peami_1"}this.Mx(s,"Rasgueado","Rasgueado",t)}}Dx(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let n;if(this.tx.has(i))n=this.tx.get(i);else{n=this.tx.size.toString(),this.tx.set(i,n);const t=s.addElement("Rhythm");if(t.attributes.set("id",n),e.hasTuplet){const s=t.addElement("PrimaryTuplet");s.attributes.set("num",e.tupletNumerator.toString()),s.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&t.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let r="Quarter";switch(e.duration){case l.QuadrupleWhole:r="Long";break;case l.DoubleWhole:r="DoubleWhole";break;case l.Whole:r="Whole";break;case l.Half:r="Half";break;case l.Quarter:r="Quarter";break;case l.Eighth:r="Eighth";break;case l.Sixteenth:r="16th";break;case l.ThirtySecond:r="32nd";break;case l.SixtyFourth:r="64th";break;case l.OneHundredTwentyEighth:r="128th";break;case l.TwoHundredFiftySixth:r="256th"}t.addElement("NoteValue").innerText=r}t.addElement("Rhythm").attributes.set("ref",n)}Ax(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this.Ix(t,e.whammyBarPoints)}Ix(t,e){const s=t.addElement("Whammy"),i=e[0],n=e[e.length-1];let r,a;switch(e.length){case 4:r=e[1],a=e[2];break;case 3:r=e[1],a=e[1];break;default:r=new V((i.offset+n.offset)/2,(i.value+n.value)/2),a=r}s.attributes.set("destinationOffset",this.Gh(n.offset).toString()),s.attributes.set("destinationValue",this.Ih(n.value).toString()),s.attributes.set("middleOffset1",this.Gh(r.offset).toString()),s.attributes.set("middleOffset2",this.Gh(a.offset).toString()),s.attributes.set("middleValue",this.Ih(r.value).toString()),s.attributes.set("originOffset",this.Gh(i.offset).toString()),s.attributes.set("originValue",this.Ih(i.value).toString())}hx(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}ox(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(t=>t.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===e.masterBars[0].tempoAutomations.length){const t=i.addElement("Automation");t.addElement("Type").innerText="Tempo",t.addElement("Linear").innerText="false",t.addElement("Bar").innerText="0",t.addElement("Position").innerText="0",t.addElement("Visible").innerText="true",t.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(t.addElement("Text").innerText=e.tempoLabel)}const n=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(t=>0===t.ratioPosition&&0===t.syncPointValue.barOccurence):void 0,r=n?n.syncPointValue.millisecondOffset:0;this.Bx=r/1e3*uu.ha*-1|0;const a=new U(()=>Ta.buildModifiedTempoLookup(e));for(const t of e.masterBars){for(const e of t.tempoAutomations){const s=i.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=e.isLinear?"true":"false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText=e.isVisible?"true":"false",s.addElement("Value").innerText=`${e.value} 2`,e.text&&(s.addElement("Text").innerText=e.text)}if(t.syncPoints)for(const s of t.syncPoints){const n=i.addElement("Automation");n.addElement("Type").innerText="SyncPoint",n.addElement("Linear").innerText="false",n.addElement("Bar").innerText=t.index.toString(),n.addElement("Position").innerText=s.ratioPosition.toString(),n.addElement("Visible").innerText=s.isVisible?"true":"false";const h=n.addElement("Value");h.addElement("BarIndex").innerText=t.index.toString(),h.addElement("BarOccurrence").innerText=s.syncPointValue.barOccurence.toString(),h.addElement("ModifiedTempo").innerText=a.value.get(s).syncBpm.toString(),h.addElement("OriginalTempo").innerText=e.tempo.toString();let o=(s.syncPointValue.millisecondOffset-r)/1e3*uu.ha;o=Math.floor(o+.5),h.addElement("FrameOffset").innerText=o.toString()}}}ux(t,e){t.addElement("AudioTracks")}bx(t,e){const s=t.addElement("Tracks");for(const t of e.tracks)this.Gx(s,t)}Gx(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=de.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=uu.$x(e.playbackInfo).toString(),this.Vx(s,e),this.Hx(s,e),this.Ux(s,e),s.addElement("ForcedSound").innerText="-1",this.zx(s,e),e.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":e.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this.jx(s,e),this.Xx(s,e),this.Jx(s,e)}static $x(t){return 9===t.primaryChannel?uu.ix.icon:uu.sx.has(t.program)?uu.sx.get(t.program).icon:cu.SteelGuitar}qx(t,e,s,i,n,r,a,h,o=0){const c=t.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(n);const l=c.addElement("MIDI"),u=de.bankToLsbMsb(h);l.addElement("LSB").innerText=u[0].toString(),l.addElement("MSB").innerText=u[1].toString(),l.addElement("Program").innerText=a.toString();const d=e.addElement("Automation");d.addElement("Type").innerText="Sound",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=r.toString(),d.addElement("Position").innerText=o.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").setCData(`${i};${s};${n}`)}Jx(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const t=`Track_${e.index}_Initial`,n=`Midi/${e.playbackInfo.program}`,a="Factory";let h=!1,o=e.playbackInfo.bank;for(const c of e.staves)for(const l of c.bars)for(const c of l.voices)for(const u of c.beats){const c=u.getAutomation(r.Instrument),d=0===l.index&&0===u.index,f=u.getAutomation(r.Bank);if(f&&(o=f.value),c){const r=d?t:`ProgramChange_${u.id}`,f=d?n:`Midi/${c.value}`,p=d?a:"User";d||h||(this.qx(s,i,t,n,a,e.staves[0].bars[0].index,e.playbackInfo.program,e.playbackInfo.bank),h=!0),this.qx(s,i,r,f,p,l.index,c.value,o,c.ratioPosition),d&&(h=!0)}}}for(const t of e.staves)for(const e of t.bars)for(const t of e.sustainPedals)if(t.pedalType!==A.Hold){const s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=e.index.toString(),s.addElement("Position").innerText=t.ratioPosition.toString(),s.addElement("Visible").innerText="true",t.pedalType){case A.Down:s.addElement("Value").innerText="0 1";break;case A.Up:s.addElement("Value").innerText="0 3"}}}zx(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}Ux(t,e){const s=t.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56");s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}Xx(t,e){const s=t.addElement("Staves");for(const t of e.staves)this.Yx(s,t)}Yx(t,e){const s=t.addElement("Staff").addElement("Properties");if(this.Mx(s,"CapoFret","Fret",e.capo.toString()),this.Mx(s,"FretCount","Fret","24"),e.tuning.length>0){const t=s.addElement("Property");switch(t.attributes.set("name","Tuning"),t.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),t.addElement("Label").setCData(e.tuningName),t.addElement("LabelVisible").innerText=e.tuningName?"true":"false",t.addElement("Flat"),e.tuning.length){case 3:t.addElement("Instrument").innerText="Shamisen";break;case 4:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":42===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Cello":43===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Contrabass":40===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Violin":41===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Viola":t.addElement("Instrument").innerText="Bass";break;case 5:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":t.addElement("Instrument").innerText="Bass";break;case 6:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;case 7:e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;default:t.addElement("Instrument").innerText="Guitar"}}this.Mx(s,"PartialCapoFret","Fret","0"),this.Mx(s,"PartialCapoStringFlags","Bitset",e.tuning.map(t=>"0").join("")),this.Mx(s,"TuningFlat","Enable",null),this.Kx(s,e,"DiagramCollection"),this.Kx(s,e,"DiagramWorkingSet")}Kx(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const n=i.addElement("Items"),r=e.chords;if(r)for(const[t,e]of r){const s=n.addElement("Item");s.attributes.set("id",t),s.attributes.set("name",e.name);const i=s.addElement("Diagram");i.attributes.set("stringCount",e.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(e.firstFret-1).toString()),i.attributes.set("barStates",e.strings.map(t=>"1").join(" "));const r=[],a=new Map;for(let t=0;t<e.strings.length;t++){const s=e.strings[t];if(-1!==s){const n=i.addElement("Fret"),h=e.strings.length-1-t;n.attributes.set("string",h.toString()),n.attributes.set("fret",(s-e.firstFret+1).toString()),a.has(s)||(a.set(s,[]),r.push(s)),a.get(s).push(h)}}r.sort();const h=i.addElement("Fingering");if(e.barreFrets.length>0){const t=[f.LittleFinger,f.AnnularFinger,f.MiddleFinger,f.IndexFinger];for(const s of r){const i=a.get(s);if(i.length>1&&e.barreFrets.indexOf(s)>=0){const n=t.length>0?t.pop():f.IndexFinger;for(const t of i){const i=h.addElement("Position");switch(n){case f.LittleFinger:i.attributes.set("finger","Pinky");break;case f.AnnularFinger:i.attributes.set("finger","Ring");break;case f.MiddleFinger:i.attributes.set("finger","Middle");break;case f.IndexFinger:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-e.firstFret+1).toString()),i.attributes.set("string",t.toString())}}}}const o=i.addElement("Property");o.attributes.set("name","ShowName"),o.attributes.set("type","bool"),o.attributes.set("value",e.showName?"true":"false");const c=i.addElement("Property");c.attributes.set("name","ShowDiagram"),c.attributes.set("type","bool"),c.attributes.set("value",e.showDiagram?"true":"false");const l=i.addElement("Property");l.attributes.set("name","ShowFingering"),l.attributes.set("type","bool"),l.attributes.set("value",e.showFingering?"true":"false");const u=i.addElement("Chord"),d=u.addElement("KeyNote");d.attributes.set("step","C"),d.attributes.set("accidental","Natural");const p=u.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");const b=u.addElement("Degree");b.attributes.set("interval","Third"),b.attributes.set("alteration","Major"),b.attributes.set("omitted","false");const m=u.addElement("Degree");m.attributes.set("interval","Fifth"),m.attributes.set("alteration","Perfect"),m.attributes.set("omitted","false")}}Mx(t,e,s,i){const n=t.addElement("Property");n.attributes.set("name",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}Ox(t,e,s,i){const n=t.addElement("XProperty");n.attributes.set("id",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}jx(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const t of e.staves[0].bars)for(const e of t.voices)if(!e.isEmpty)for(const s of e.beats)if(s.lyrics)for(let e=0;e<s.lyrics.length;e++){for(;e>=i.length;){const e=new ge;e.startBar=t.index,e.text="[Empty]",i.push(e)}const n=i[e];n.text="[Empty]"===n.text?s.lyrics[e]:`${n.text} ${s.lyrics[e].split(" ").join("+")}`}for(let t=0;t<i.length;t++){const e=s.addElement("Line");e.addElement("Text").setCData(i[t].text),e.addElement("Offset").innerText=i[t].startBar.toString()}}Hx(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),n=e.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=n.toString(),s.addElement("Octave").innerText=i.toString()}Vx(t,e){const s=t.addElement("InstrumentSet"),i=e.staves[0];if(s.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),e.percussionArticulations.length>0||i.isPercussion){const t=e.percussionArticulations.length>0?e.percussionArticulations:Array.from(zt.instrumentArticulations.values());s.addElement("Name").innerText=uu.ix.instrumentSetName,s.addElement("Type").innerText=uu.ix.instrumentSetType;let i="",n=new Ms;const r=new Map,a=s.addElement("Elements");for(const e of t){{const t=a.addElement("Element");let s=e.elementType;if(r.has(s)){const t=r.get(s);s+=` ${t}`,r.set(s,t+1)}else r.set(s,1);i=s,t.addElement("Name").innerText=s,t.addElement("Type").innerText=e.elementType,n=t.addElement("Articulations")}const t=n.addElement("Articulation");switch(t.addElement("Name").innerText=`${i} ${n.childNodes.length}`,t.addElement("StaffLine").innerText=e.staffLine.toString(),t.addElement("Noteheads").innerText=[this.Qx(e.noteHeadDefault),this.Qx(e.noteHeadHalf),this.Qx(e.noteHeadWhole)].join(" "),e.techniqueSymbolPlacement){case ct.Below:t.addElement("TechniquePlacement").innerText="below";break;case ct.Outside:t.addElement("TechniquePlacement").innerText="outside";break;case ct.Inside:t.addElement("TechniquePlacement").innerText="inside";break;case ct.Above:t.addElement("TechniquePlacement").innerText="above"}t.addElement("TechniqueSymbol").innerText=this.Qx(e.techniqueSymbol),t.addElement("InputMidiNumbers").innerText="",t.addElement("OutputMidiNumber").innerText=e.outputMidiNumber.toString()}}else{const t=uu.sx.has(e.playbackInfo.program)?uu.sx.get(e.playbackInfo.program):uu.sx.get(0);s.addElement("Name").innerText=t.instrumentSetName,s.addElement("Type").innerText=t.instrumentSetType;const i=s.addElement("Elements").addElement("Element");i.addElement("Pitched").innerText="Pitched",i.addElement("Type").innerText="pitched",i.addElement("SoundbankName").innerText="";const n=i.addElement("Articulations").addElement("Articulation");n.addElement("Name").innerText="",n.addElement("StaffLine").innerText="0",n.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",n.addElement("TechniquePlacement").innerText="outside",n.addElement("TechniqueSymbol").innerText="",n.addElement("InputMidiNumbers").innerText="",n.addElement("OutputRSESound").innerText="",n.addElement("OutputMidiNumber").innerText="0"}}Qx(t){if(t===at.None)return"";const e=at[t];return e.substring(0,1).toLowerCase()+e.substring(1)}mx(t,e){const s=t.addElement("MasterBars");for(const t of e.masterBars)this.Zx(s,t)}Zx(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");let n=e.score.tracks[0].staves[0].bars[e.index].keySignature;const r=e.score.tracks[0].staves[0].bars[e.index].keySignatureType,a=Ht.flooredDivision(e.score.tracks[0].staves[0].displayTranspositionPitch,12);n=Ht.transposeKey(n,-a),i.addElement("AccidentalCount").innerText=n.toString(),i.addElement("Mode").innerText=F[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.isFreeTime&&s.addElement("FreeTime");const h=[];for(const t of e.score.tracks)for(const s of t.staves)h.push(s.bars[e.index].id.toString());if(s.addElement("Bars").innerText=h.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const t=s.addElement("Section");t.addElement("Letter").setCData(e.section.marker),t.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const t=s.addElement("Repeat");t.attributes.set("start",e.isRepeatStart?"true":"false"),t.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&t.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let t=e.alternateEndings;const i=[];let n=0;for(;t>0;)1==(t>>n&1)&&(i.push(n+1),t&=~(1<<n)),n++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(e.tripletFeel!==rt.NoTripletFeel&&(s.addElement("TripletFeel").innerText=rt[e.tripletFeel]),e.directions&&e.directions.size>0){const t=s.addElement("Directions");for(const s of e.directions)switch(s){case Qe.TargetFine:t.addElement("Target").innerText="Fine";break;case Qe.TargetSegno:t.addElement("Target").innerText="Segno";break;case Qe.TargetSegnoSegno:t.addElement("Target").innerText="SegnoSegno";break;case Qe.TargetCoda:t.addElement("Target").innerText="Coda";break;case Qe.TargetDoubleCoda:t.addElement("Target").innerText="DoubleCoda";break;case Qe.JumpDaCapo:t.addElement("Jump").innerText="DaCapo";break;case Qe.JumpDaCapoAlCoda:t.addElement("Jump").innerText="DaCapoAlCoda";break;case Qe.JumpDaCapoAlDoubleCoda:t.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case Qe.JumpDaCapoAlFine:t.addElement("Jump").innerText="DaCapoAlFine";break;case Qe.JumpDalSegno:t.addElement("Jump").innerText="DaSegno";break;case Qe.JumpDalSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoAlCoda";break;case Qe.JumpDalSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case Qe.JumpDalSegnoAlFine:t.addElement("Jump").innerText="DaSegnoAlFine";break;case Qe.JumpDalSegnoSegno:t.addElement("Jump").innerText="DaSegnoSegno";break;case Qe.JumpDalSegnoSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case Qe.JumpDalSegnoSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case Qe.JumpDalSegnoSegnoAlFine:t.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case Qe.JumpDaCoda:t.addElement("Jump").innerText="DaCoda";break;case Qe.JumpDaDoubleCoda:t.addElement("Jump").innerText="DaDoubleCoda"}}this.tT(s,e)}tT(t,e){const s=e.fermata?.size??0;if(0!==s&&s>0){const s=t.addElement("Fermatas");for(const[t,i]of e.fermata)this.eT(s,t,i)}}eT(t,e,s){let i=-1,n=1;if(e>0)for(;n<10&&(i=e/I.QuarterTime*n,i!==Math.floor(i));)i=-1,n++;else i=0,n=1;if(-1===i)return;const r=t.addElement("Fermata");r.addElement("Type").innerText=Pt[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${n}`}wx(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(t=>t.isEmpty?"-1":t.id.toString()).join(" "),s.addElement("Clef").innerText=P[e.clef],e.clefOttava!==m.Regular&&(s.addElement("Ottavia").innerText=m[e.clefOttava].substr(1)),e.simileMark!==E.None&&(s.addElement("SimileMark").innerText=E[e.simileMark])}yx(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(t=>t.id).join(" ")}}class du{static sT=du.iT();static iT(){const t=new Uint32Array(256);for(let e=0;e<t.length;e++){let s=e;for(let t=0;t<8;t++)s=1&~s?s>>>1:s>>>1^3988292384;t[e]=s}return t}static nT=4294967295;rT=du.nT;get value(){return~this.rT}constructor(){this.reset()}update(t,e,s){for(let i=0;i<s;i++)this.rT=du.sT[255&(this.rT^t[e+i])]^this.rT>>>8}reset(){this.rT=du.nT}}class fu{static maxWbits=15;static wsize=1<<fu.maxWbits;static wmask=fu.wsize-1;static minMatch=3;static maxMatch=258;static defaultMemLevel=8;static pendingBufSize=1<<fu.defaultMemLevel+8;static hashBits=fu.defaultMemLevel+7;static hashSize=1<<fu.hashBits;static hashShift=(fu.hashBits+fu.minMatch-1)/fu.minMatch;static hashMask=fu.hashSize-1;static minLookahead=fu.maxMatch+fu.minMatch+1;static maxDist=fu.wsize-fu.minLookahead}class pu{static aT=16;static hT=17;static oT=18;freqs;length=null;minNumCodes;numCodes=0;cT=null;lT;uT;Ri;constructor(t,e,s,i){this.Ri=t,this.minNumCodes=s,this.uT=i,this.freqs=new Int16Array(e),this.lT=new Int32Array(i)}reset(){for(let t=0;t<this.freqs.length;t++)this.freqs[t]=0;this.cT=null,this.length=null}buildTree(){const t=this.freqs.length,e=new Int32Array(t);let s=0,i=0;for(let n=0;n<t;n++){const t=this.freqs[n];if(0!==t){let r=s++;for(;r>0;){const s=Math.floor((r-1)/2);if(!(this.freqs[e[s]]>t))break;e[r]=e[s],r=s}e[r]=n,i=n}}for(;s<2;){const t=i<2?++i:0;e[s++]=t}this.numCodes=Math.max(i+1,this.minNumCodes);const n=s,r=new Int32Array(4*s-2),a=new Int32Array(2*s-1);let h=n;for(let t=0;t<s;t++){const s=e[t];r[2*t]=s,r[2*t+1]=-1,a[t]=this.freqs[s]<<8,e[t]=t}do{const t=e[0];let i=e[--s],n=0,o=1;for(;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*o+1;let c=a[i];for(;o=n,n>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i;const l=e[0];i=h++,r[2*i]=t,r[2*i+1]=l;const u=Math.min(255&a[t],255&a[l]);for(c=a[t]+a[l]-u+1,a[i]=c,n=0,o=1;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*n+1;for(;o=n,o>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i}while(s>1);this.dT(r)}dT(t){this.length=new Uint8Array(this.freqs.length);const e=Math.floor(t.length/2),s=Math.floor((e+1)/2);let i=0;for(let t=0;t<this.uT;t++)this.lT[t]=0;const n=new Int32Array(e);n[e-1]=0;for(let s=e-1;s>=0;s--)if(-1!==t[2*s+1]){let e=n[s]+1;e>this.uT&&(e=this.uT,i++),n[t[2*s]]=e,n[t[2*s+1]]=e}else{const e=n[s];this.lT[e-1]++,this.length[t[2*s]]=n[s]}if(0===i)return;let r=this.uT-1;do{for(;0===this.lT[--r];);do{this.lT[r]--,this.lT[++r]++,i-=1<<this.uT-1-r}while(i>0&&r<this.uT-1)}while(i>0);this.lT[this.uT-1]+=i,this.lT[this.uT-2]-=i;let a=2*s;for(let e=this.uT;0!==e;e--){let s=this.lT[e-1];for(;s>0;){const i=2*t[a++];-1===t[i+1]&&(this.length[t[i]]=e,s--)}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.freqs[a]++,i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););i<s?t.freqs[n]+=i:0!==n?t.freqs[pu.aT]++:i<=10?t.freqs[pu.hT]++:t.freqs[pu.oT]++}}setStaticCodes(t,e){this.cT=t,this.length=e}buildCodes(){const t=new Int32Array(this.uT);let e=0;this.cT=new Int16Array(this.freqs.length);for(let s=0;s<this.uT;s++)t[s]=e,e+=this.lT[s]<<15-s;for(let e=0;e<this.numCodes;e++){const s=this.length[e];s>0&&(this.cT[e]=bu.bitReverse(t[s-1]),t[s-1]+=1<<16-s)}}writeTree(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.writeSymbol(a),i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););if(i<s)for(;i-- >0;)t.writeSymbol(n);else 0!==n?(t.writeSymbol(pu.aT),this.Ri.pending.writeBits(i-3,2)):i<=10?(t.writeSymbol(pu.hT),this.Ri.pending.writeBits(i-3,3)):(t.writeSymbol(pu.oT),this.Ri.pending.writeBits(i-11,7))}}writeSymbol(t){this.Ri.pending.writeBits(65535&this.cT[t],this.length[t])}}class bu{static fT=1<<fu.defaultMemLevel+6;static pT=286;static storedBlock=0;static staticTrees=1;static dynTrees=2;static bT=30;static mT=new Int16Array(bu.pT);static gT=new Uint8Array(bu.pT);static wT=new Int16Array(bu.bT);static yT=new Uint8Array(bu.bT);static staticInit(){let t=0;for(;t<144;)bu.mT[t]=bu.bitReverse(48+t<<8),bu.gT[t++]=8;for(;t<256;)bu.mT[t]=bu.bitReverse(256+t<<7),bu.gT[t++]=9;for(;t<280;)bu.mT[t]=bu.bitReverse(-256+t<<9),bu.gT[t++]=7;for(;t<bu.pT;)bu.mT[t]=bu.bitReverse(-88+t<<8),bu.gT[t++]=8;for(t=0;t<bu.bT;t++)bu.wT[t]=bu.bitReverse(t<<11),bu.yT[t]=5}static kT=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static ST=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]);static bitReverse(t){return bu.ST[15&t]<<12|bu.ST[t>>4&15]<<8|bu.ST[t>>8&15]<<4|bu.ST[t>>12]}static BT=19;static _T=256;pending;xT;TT;MT;vT;NT;PT=0;ET=0;constructor(t){this.pending=t,this.xT=new pu(this,bu.pT,257,15),this.TT=new pu(this,bu.bT,1,15),this.MT=new pu(this,bu.BT,4,7),this.vT=new Int16Array(bu.fT),this.NT=new Uint8Array(bu.fT)}isFull(){return this.PT>=bu.fT}reset(){this.PT=0,this.ET=0,this.xT.reset(),this.TT.reset(),this.MT.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((bu.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this.xT.freqs[bu._T]++,this.xT.buildTree(),this.TT.buildTree(),this.xT.calcBLFreq(this.MT),this.TT.calcBLFreq(this.MT),this.MT.buildTree();let n=4;for(let t=18;t>n;t--)this.MT.length[bu.kT[t]]>0&&(n=t+1);let r=14+3*n+this.MT.getEncodedLength()+this.xT.getEncodedLength()+this.TT.getEncodedLength()+this.ET,a=this.ET;for(let t=0;t<bu.pT;t++)a+=this.xT.freqs[t]*bu.gT[t];for(let t=0;t<bu.bT;t++)a+=this.TT.freqs[t]*bu.yT[t];r>=a&&(r=a),e>=0&&s+4<r>>3?this.flushStoredBlock(t,e,s,i):r===a?(this.pending.writeBits((bu.staticTrees<<1)+(i?1:0),3),this.xT.setStaticCodes(bu.mT,bu.gT),this.TT.setStaticCodes(bu.wT,bu.yT),this.compressBlock(),this.reset()):(this.pending.writeBits((bu.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(n),this.compressBlock(),this.reset())}sendAllTrees(t){this.MT.buildCodes(),this.xT.buildCodes(),this.TT.buildCodes(),this.pending.writeBits(this.xT.numCodes-257,5),this.pending.writeBits(this.TT.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this.MT.length[bu.kT[e]],3);this.xT.writeTree(this.MT),this.TT.writeTree(this.MT)}compressBlock(){for(let t=0;t<this.PT;t++){const e=255&this.NT[t];let s=this.vT[t];if(0!==s--){const t=bu.CT(e);this.xT.writeSymbol(t);let i=Math.floor((t-261)/4);i>0&&i<=5&&this.pending.writeBits(e&(1<<i)-1,i);const n=bu.FT(s);this.TT.writeSymbol(n),i=Math.floor(n/2)-1,i>0&&this.pending.writeBits(s&(1<<i)-1,i)}else this.xT.writeSymbol(e)}this.xT.writeSymbol(bu._T)}tallyDist(t,e){this.vT[this.PT]=t,this.NT[this.PT++]=e-3;const s=bu.CT(e-3);this.xT.freqs[s]++,s>=265&&s<285&&(this.ET+=Math.floor((s-261)/4));const i=bu.FT(t-1);return this.TT.freqs[i]++,i>=4&&(this.ET+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this.vT[this.PT]=0,this.NT[this.PT++]=t,this.xT.freqs[t]++,this.isFull()}static CT(t){if(255===t)return 285;let e=257;for(;t>=8;)e+=4,t>>=1;return e+t}static FT(t){let e=0;for(;t>=4;)e+=2,t>>=1;return e+t}}bu.staticInit();class mu{static AT=4096;DT;LT=128;WT=128;RT=8;OT=0;IT;Xi;ef;GT;$T=0;VT=null;HT=0;UT=0;zT=!1;jT=0;XT=0;JT;Ri;inputCrc;constructor(t){this.JT=t,this.Ri=new bu(t),this.inputCrc=new du,this.Xi=new Uint8Array(2*fu.wsize),this.ef=new Int16Array(fu.hashSize),this.GT=new Int16Array(fu.wsize),this.DT=1,this.IT=1}reset(){this.Ri.reset(),this.inputCrc.reset(),this.DT=1,this.IT=1,this.$T=0,this.zT=!1,this.XT=fu.minMatch-1;for(let t=0;t<fu.hashSize;t++)this.ef[t]=0;for(let t=0;t<fu.wsize;t++)this.GT[t]=0}qT(){this.OT=this.Xi[this.IT]<<fu.hashShift^this.Xi[this.IT+1]}needsInput(){return this.UT===this.HT}setInput(t,e,s){const i=e+s;this.VT=t,this.HT=e,this.UT=i}deflate(t,e){let s;do{this.fillWindow();const i=t&&this.HT===this.UT;s=this.YT(i,e)}while(this.JT.isFlushed&&s);return s}YT(t,e){if(this.$T<fu.minLookahead&&!t)return!1;for(;this.$T>=fu.minLookahead||t;){if(0===this.$T)return this.zT&&this.Ri.tallyLit(255&this.Xi[this.IT-1]),this.zT=!1,this.Ri.flushBlock(this.Xi,this.DT,this.IT-this.DT,e),this.DT=this.IT,!1;this.IT>=2*fu.wsize-fu.minLookahead&&this.KT();const t=this.jT;let s=this.XT;if(this.$T>=fu.minMatch){const t=this.QT();0!==t&&this.IT-t<=fu.maxDist&&this.ZT(t)&&this.XT===fu.minMatch&&this.IT-this.jT>mu.AT&&(this.XT=fu.minMatch-1)}if(s>=fu.minMatch&&this.XT<=s){this.Ri.tallyDist(this.IT-1-t,s),s-=2;do{this.IT++,this.$T--,this.$T>=fu.minMatch&&this.QT()}while(--s>0);this.IT++,this.$T--,this.zT=!1,this.XT=fu.minMatch-1}else this.zT&&this.Ri.tallyLit(255&this.Xi[this.IT-1]),this.zT=!0,this.IT++,this.$T--;if(this.Ri.isFull()){let t=this.IT-this.DT;this.zT&&t--;const s=e&&0===this.$T&&!this.zT;return this.Ri.flushBlock(this.Xi,this.DT,t,s),this.DT+=t,!s}}return!0}ZT(t){let e,s=this.IT;const i=s+Math.min(fu.maxMatch,this.$T)-1,n=Math.max(s-fu.maxDist,0),r=this.Xi,a=this.GT;let h=this.LT;const o=Math.min(this.WT,this.$T);if(this.XT=Math.max(this.XT,fu.minMatch-1),s+this.XT>i)return!1;let c=r[s+this.XT-1],l=r[s+this.XT];this.XT>=this.RT&&(h>>=2);do{if(e=t,s=this.IT,r[e+this.XT]===l&&r[e+this.XT-1]===c&&r[e]===r[s]&&r[++e]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++e])break;break;case 2:if(r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 3:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 4:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 5:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 6:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 7:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break}if(r[s]===r[e])do{if(s===i){++s,++e;break}}while(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]);if(s-this.IT>this.XT){if(this.jT=t,this.XT=s-this.IT,this.XT>=o)break;c=r[s-1],l=r[s]}t=65535&a[t&fu.wmask]}}while(t>n&&0!==--h);return this.XT>=fu.minMatch}QT(){const t=(this.OT<<fu.hashShift^this.Xi[this.IT+(fu.minMatch-1)])&fu.hashMask,e=this.ef[t];return this.GT[this.IT&fu.wmask]=e,this.ef[t]=this.IT,this.OT=t,65535&e}fillWindow(){if(this.IT>=fu.wsize+fu.maxDist&&this.KT(),this.$T<fu.minLookahead&&this.HT<this.UT){let t=2*fu.wsize-this.$T-this.IT;t>this.UT-this.HT&&(t=this.UT-this.HT),this.Xi.set(this.VT.subarray(this.HT,this.HT+t),this.IT+this.$T),this.inputCrc.update(this.VT,this.HT,t),this.HT+=t,this.$T+=t}this.$T>=fu.minMatch&&this.qT()}KT(){this.Xi.set(this.Xi.subarray(fu.wsize,fu.wsize+fu.wsize),0),this.jT-=fu.wsize,this.IT-=fu.wsize,this.DT-=fu.wsize;for(let t=0;t<fu.hashSize;++t){const e=65535&this.ef[t];this.ef[t]=e>=fu.wsize?e-fu.wsize:0}for(let t=0;t<fu.wsize;t++){const e=65535&this.GT[t];this.GT[t]=e>=fu.wsize?e-fu.wsize:0}}}class gu{si;tM=0;Ou=0;Li=0;bitCount=0;get isFlushed(){return 0===this.Ou}constructor(t){this.si=new Uint8Array(t)}reset(){this.tM=0,this.Ou=0,this.bitCount=0}writeShortMSB(t){this.si[this.Ou++]=t>>8&255,this.si[this.Ou++]=255&t}writeShort(t){this.si[this.Ou++]=t,this.si[this.Ou++]=t>>8}writeBlock(t,e,s){this.si.set(t.subarray(e,e+s),this.Ou),this.Ou+=s}flush(t,e,s){return this.bitCount>=8&&(this.si[this.Ou++]=255&this.Li,this.Li>>=8,this.bitCount-=8),s>this.Ou-this.tM?(s=this.Ou-this.tM,t.set(this.si.subarray(this.tM,this.tM+s),e),this.tM=0,this.Ou=0):(t.set(this.si.subarray(this.tM,this.tM+s),e),this.tM+=s),s}writeBits(t,e){this.Li|=t<<this.bitCount,this.bitCount+=e,this.bitCount>=16&&(this.si[this.Ou++]=255&this.Li,this.si[this.Ou++]=this.Li>>8&255,this.Li>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this.si[this.Ou++]=255&this.Li,this.bitCount>8&&(this.si[this.Ou++]=this.Li>>8&255)),this.Li=0,this.bitCount=0}}class wu{static eM=4;static isFinishing=8;static sM=16;static iM=20;static nM=28;static rM=30;oi=0;JT;aM;get inputCrc(){return this.aM.inputCrc.value}constructor(){this.JT=new gu(fu.pendingBufSize),this.aM=new mu(this.JT),this.reset()}get isNeedingInput(){return this.aM.needsInput()}get isFinished(){return this.oi===wu.rM&&this.JT.isFlushed}reset(){this.oi=wu.sM,this.JT.reset(),this.aM.reset()}setInput(t,e,s){this.aM.setInput(t,e,s)}deflate(t,e,s){const i=s;for(;;){const n=this.JT.flush(t,e,s);if(e+=n,0===(s-=n)||this.oi===wu.rM)break;if(!this.aM.deflate(0!==(this.oi&wu.eM),0!==(this.oi&wu.isFinishing)))switch(this.oi){case wu.sM:return i-s;case wu.iM:let t=8+(7&-this.JT.bitCount);for(;t>0;)this.JT.writeBits(2,10),t-=10;this.oi=wu.sM;break;case wu.nM:this.JT.alignToByte(),this.oi=wu.rM}}return i-s}finish(){this.oi|=wu.eM|wu.isFinishing}}class yu{entry;localHeaderOffset;compressedSize;crc32;compressionMode;constructor(t,e,s,i,n){this.entry=t,this.crc32=e,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=n}}class ku{jl;hM=[];oM=new wu;constructor(t){this.jl=t}writeEntry(t){const e=xs.CompressionMethodDeflate,s=Ie.empty(),i=this.cM(s,t.data,e),n=s.toArray(),r=new yu(t,i,this.jl.bytesWritten,e,s.length);this.hM.push(r),he.writeInt32LE(this.jl,xs.LocalFileHeaderSignature),he.writeUInt16LE(this.jl,10),he.writeUInt16LE(this.jl,2048),he.writeUInt16LE(this.jl,e),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt32LE(this.jl,i),he.writeInt32LE(this.jl,n.length),he.writeInt32LE(this.jl,t.data.length),he.writeInt16LE(this.jl,t.fullName.length),he.writeInt16LE(this.jl,0);const a=he.stringToBytes(t.fullName);this.jl.write(a,0,a.length),this.jl.write(n,0,n.length)}cM(t,e,s){if(s!==xs.CompressionMethodDeflate){const s=new du;return s.update(e,0,e.length),t.write(e,0,e.length),s.value}const i=new Uint8Array(512);for(this.oM.reset(),this.oM.setInput(e,0,e.length);!this.oM.isNeedingInput;){const e=this.oM.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}for(this.oM.finish();!this.oM.isFinished;){const e=this.oM.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}return this.oM.inputCrc}end(){const t=this.jl.bytesWritten;for(const t of this.hM)this.lM(t);const e=this.jl.bytesWritten;this.uM(t,e)}uM(t,e){he.writeInt32LE(this.jl,xs.EndOfCentralDirSignature),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,this.hM.length),he.writeInt16LE(this.jl,this.hM.length),he.writeInt32LE(this.jl,e-t),he.writeInt32LE(this.jl,t),he.writeInt16LE(this.jl,0)}lM(t){he.writeInt32LE(this.jl,xs.CentralFileHeaderSignature),he.writeUInt16LE(this.jl,10),he.writeUInt16LE(this.jl,10),he.writeUInt16LE(this.jl,2048),he.writeUInt16LE(this.jl,t.compressionMode),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt32LE(this.jl,t.crc32),he.writeInt32LE(this.jl,t.compressedSize),he.writeInt32LE(this.jl,t.entry.data.length),he.writeInt16LE(this.jl,t.entry.fullName.length),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt16LE(this.jl,0),he.writeInt32LE(this.jl,0),he.writeInt32LE(this.jl,t.localHeaderOffset);const e=he.stringToBytes(t.entry.fullName);this.jl.write(e,0,e.length)}}const Su=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:class extends au{hi=We.instance;get name(){return"alphaTex"}exportToString(t,e=null){return this.settings=e??new Fr,this.scoreToAlphaTexString(t)}writeScore(t){const e=he.stringToBytes(this.scoreToAlphaTexString(t));this.data.write(e,0,e.length)}scoreToAlphaTexString(t){const e=new ou(this.settings);return e.writeScoreNode(this.ue(t)),e.tex}ue(t){const e={nodeType:kt.Score,bars:[]};for(const s of t.tracks)this.dM(e,s);return 0===e.bars.length?e.bars.push({nodeType:kt.Bar,metaData:this.hi.buildScoreMetaDataNodes(t),beats:[]}):e.bars[0].metaData=this.hi.buildScoreMetaDataNodes(t).concat(e.bars[0].metaData),e.bars.push({nodeType:kt.Bar,metaData:this.hi.buildSyncPointNodes(t),beats:[]}),e}dM(t,e){for(const s of e.staves)this.Hw(t,s)}Hw(t,e){const s=Math.max(...e.filledVoices)+1;if(0===e.bars.length){const s={nodeType:kt.Bar,metaData:this.hi.buildBarMetaDataNodes(e,void 0,0,!1),beats:[],pipe:void 0};t.bars.push(s)}else for(let i=0;i<s;i++)this.fM(t,i,e,s>1)}fM(t,e,s,i){for(const n of s.bars)this.fe(t,n,e,i)}fe(t,e,s,i){const n={nodeType:kt.Bar,metaData:this.hi.buildBarMetaDataNodes(e.staff,e,s,i),beats:[],pipe:void 0};if(e.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{const t=e.voices[s];if(t.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{for(const e of t.beats)n.beats.push(this.ge(e));n.beats.length>0&&(n.beats[0].leadingComments??=[],n.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} contents`}))}}e.index<e.staff.bars.length-1&&(n.pipe={nodeType:kt.Pipe}),t.bars.push(n)}ge(t){const e={nodeType:kt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return t.isRest?e.rest={nodeType:kt.Ident,text:"r"}:e.notes=this.eB(t.notes),e.durationDot={nodeType:kt.Dot},e.durationValue={nodeType:kt.Number,value:t.duration},e.beatEffects=this.gi(t),e}gi(t){const e=this.hi.buildBeatEffects(t);return e.length>0?{nodeType:kt.Props,openBrace:{nodeType:kt.LBrace},properties:e,closeBrace:{nodeType:kt.RBrace}}:void 0}eB(t){const e={nodeType:kt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===t.length||t.length>1)&&(e.openParenthesis={nodeType:kt.LParen},e.closeParenthesis={nodeType:kt.RParen});for(const s of t)e.notes.push(this.xe(s));return e}xe(t){const e={nodeType:kt.Note,noteValue:{nodeType:kt.Ident,text:""}};if(t.isPercussion)e.noteValue={nodeType:kt.String,text:zt.getArticulationName(t)};else if(t.isPiano)e.noteValue={nodeType:kt.Ident,text:ye.getTextForTuning(t.realValueWithoutHarmonic,!0)};else{if(!t.isStringed)throw new Error("What kind of note");{e.noteValue={nodeType:kt.Number,value:t.fret},e.noteStringDot={nodeType:kt.Dot};const s=t.beat.voice.bar.staff.tuning.length-t.string+1;e.noteString={nodeType:kt.Number,value:s}}}return e.noteEffects=this.wi(t),e}wi(t){const e=this.hi.buildNoteEffects(t);return e.length>0?{nodeType:kt.Props,openBrace:{nodeType:kt.LBrace},properties:e,closeBrace:{nodeType:kt.RBrace}}:void 0}},Gp7Exporter:class extends au{get name(){return"Guitar Pro 7-8"}writeScore(t){j.debug(this.name,"Writing data entries");const e=new uu,s=e.writeXml(t),i=qs.writeForScore(t),n=si.writeForScore(t),r=ri.writeForScore(t);j.debug(this.name,"Writing ZIP entries");const a=new ku(this.data);a.writeEntry(new xs("VERSION",he.stringToBytes("7.0"))),a.writeEntry(new xs("Content/",new Uint8Array(0))),a.writeEntry(new xs("Content/BinaryStylesheet",i)),a.writeEntry(new xs("Content/PartConfiguration",n)),a.writeEntry(new xs("Content/LayoutConfiguration",r)),a.writeEntry(new xs("Content/score.gpif",he.stringToBytes(s))),e.backingTrackAssetFileName&&a.writeEntry(new xs(e.backingTrackAssetFileName,t.backingTrack.rawAudioFile)),a.end()}},ScoreExporter:au},Symbol.toStringTag,{value:"Module"}));class Bu extends vi{constructor(){super(0,0,ss.EndOfTrack)}writeTo(e){throw new R(t.AlphaTabErrorType.General,"Deprecated event, serialization not supported")}}var _u,xu,Tu;!function(t){t[t.SequenceNumber=0]="SequenceNumber",t[t.TextEvent=1]="TextEvent",t[t.CopyrightNotice=2]="CopyrightNotice",t[t.SequenceOrTrackName=3]="SequenceOrTrackName",t[t.InstrumentName=4]="InstrumentName",t[t.LyricText=5]="LyricText",t[t.MarkerText=6]="MarkerText",t[t.CuePoint=7]="CuePoint",t[t.PatchName=8]="PatchName",t[t.PortName=9]="PortName",t[t.MidiChannel=32]="MidiChannel",t[t.MidiPort=33]="MidiPort",t[t.EndOfTrack=47]="EndOfTrack",t[t.Tempo=81]="Tempo",t[t.SmpteOffset=84]="SmpteOffset",t[t.TimeSignature=88]="TimeSignature",t[t.KeySignature=89]="KeySignature",t[t.SequencerSpecific=127]="SequencerSpecific"}(_u||(_u={}));class Mu extends Bu{get metaStatus(){return _u.EndOfTrack}}!function(t){t[t.SystemExclusive=240]="SystemExclusive",t[t.MtcQuarterFrame=241]="MtcQuarterFrame",t[t.SongPosition=242]="SongPosition",t[t.SongSelect=243]="SongSelect",t[t.TuneRequest=246]="TuneRequest",t[t.SystemExclusive2=247]="SystemExclusive2"}(xu||(xu={}));class vu extends Bu{}!function(t){t[t.MetronomeTick=0]="MetronomeTick",t[t.Rest=1]="Rest"}(Tu||(Tu={}));const Nu=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:da,AlphaTabMetronomeEvent:Ei,AlphaTabRestEvent:Ci,AlphaTabSysExEvent:Pi,get AlphaTabSystemExclusiveEvents(){return Tu},BeatTickLookup:ma,BeatTickLookupItem:ba,ControlChangeEvent:Li,get ControllerType(){return ls},DeprecatedMidiEvent:Bu,EndOfTrackEvent:Gi,MasterBarTickLookup:wa,MasterBarTickLookupTempoChange:ga,MetaDataEvent:class extends Mu{data=new Uint8Array},MetaEvent:Mu,get MetaEventType(){return _u},MetaNumberEvent:class extends Mu{value=0},Midi20PerNotePitchBendEvent:class extends Bu{noteKey=0;pitch=0},MidiEvent:vi,get MidiEventType(){return ss},MidiFile:Mi,get MidiFileFormat(){return es},MidiFileGenerator:Ta,MidiTickLookup:ka,MidiTickLookupFindBeatResult:ya,get MidiTickLookupFindBeatResultCursorMode(){return ks},MidiTrack:Ti,NoteBendEvent:Ii,NoteEvent:Fi,NoteOffEvent:Di,NoteOnEvent:Ai,PitchBendEvent:Oi,ProgramChangeEvent:Wi,SystemCommonEvent:vu,get SystemCommonType(){return xu},SystemExclusiveEvent:class extends vu{static AlphaTabManufacturerId=125;data=new Uint8Array;get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}},TempoChangeEvent:Ri,TimeSignatureEvent:Ni},Symbol.toStringTag,{value:"Module"})),Pu=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return d},get AccidentalType(){return ht},Automation:$,get AutomationType(){return r},BackingTrack:Ys,Bar:Q,get BarLineStyle(){return L},BarStyle:K,get BarSubElement(){return D},get BarreShape(){return mt},Beat:Kt,get BeatBeamingMode(){return wt},BeatStyle:Yt,get BeatSubElement(){return yt},BendPoint:V,get BendStyle(){return a},get BendType(){return h},get BracketExtendMode(){return T},get BrushType(){return o},Chord:fe,get Clef(){return P},Color:be,get CrescendoType(){return c},get Direction(){return Qe},get Duration(){return l},get DynamicValue(){return n},ElementStyle:q,get FadeType(){return pt},Fermata:me,get FermataType(){return Pt},get Fingers(){return f},Font:cr,get FontStyle(){return us},get FontWeight(){return ds},get GolpeType(){return ft},GraceGroup:Z,get GraceType(){return u},get HarmonicType(){return p},HeaderFooterStyle:Wt,InstrumentArticulation:Ut,JsonConverter:aa,get KeySignature(){return C},get KeySignatureType(){return F},Lyrics:ge,MasterBar:It,get MusicFontSymbol(){return at},Note:Jt,get NoteAccidentalMode(){return b},get NoteOrnament(){return lt},NoteStyle:Xt,get NoteSubElement(){return ut},get Ottavia(){return m},get PickStroke(){return ot},PlaybackInformation:Se,get Rasgueado(){return gt},RenderStylesheet:X,RepeatGroup:J,Score:Ot,ScoreStyle:Rt,get ScoreSubElement(){return nt},Section:we,get SimileMark(){return E},get SlideInType(){return g},get SlideOutType(){return w},Staff:ke,SustainPedalMarker:Y,get SustainPedalMarkerType(){return A},SyncPointData:G,get TechniqueSymbolPlacement(){return ct},Track:_e,get TrackNameMode(){return v},get TrackNameOrientation(){return N},get TrackNamePolicy(){return M},TrackStyle:Be,get TrackSubElement(){return Ct},get TripletFeel(){return rt},Tuning:ye,TupletGroup:qt,get VibratoType(){return y},Voice:et,VoiceStyle:tt,get VoiceSubElement(){return W},get WahPedal(){return bt},get WhammyType(){return dt}},Symbol.toStringTag,{value:"Module"})),Eu=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:mh,Cursors:Qa,FontSizeDefinition:oa,FontSizes:ca,MeasuredText:Dt,SvgCanvas:bh,get TextAlign(){return st},get TextBaseline(){return it}},Symbol.toStringTag,{value:"Module"})),Cu=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:La,AlphaSynth:nr,AlphaSynthAudioWorkletOutput:xi,AlphaSynthBase:ir,AlphaSynthScriptProcessorOutput:qa,AlphaSynthWebAudioOutputBase:Bi,AlphaSynthWebWorkerApi:Ya,AudioExportChunk:sr,AudioExportOptions:er,BackingTrackSyncPoint:Vi,CircularSampleBuffer:wi,MidiEventsPlayedEventArgs:Zn,PlaybackRange:$a,PlaybackRangeChangedEventArgs:tr,get PlayerState(){return is},PlayerStateChangedEventArgs:ji,PositionChangedEventArgs:Xi},Symbol.toStringTag,{value:"Module"})),Fu=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));eu.isRunningInWorker?eu.initializeWorker():eu.isRunningInAudioWorklet?eu.initializeAudioWorklet():eu.initializeMain(e=>{if(eu.webPlatform===t.WebPlatform.NodeJs)throw new R(t.AlphaTabErrorType.General,"Workers not yet supported in Node.js");if(eu.webPlatform===t.WebPlatform.BrowserModule||eu.isWebPackBundled||eu.isViteBundled){j.debug("AlphaTab","Creating webworker");try{return new eu.alphaTabWorker(new eu.alphaTabUrl("./alphaTab.worker.ts",{}),{type:"module"})}catch(t){j.debug("AlphaTab","ESM webworker construction with direct URL failed",t)}let t="";try{t=new eu.alphaTabUrl("./alphaTab.worker.ts",{});const e=`import ${JSON.stringify(t)}`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(e){j.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!e.core.scriptFile)throw new Error("Could not detect alphaTab script file");t=e.core.scriptFile;const s=`import ${JSON.stringify(e.core.scriptFile)}`,i=new Blob([s],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(t){j.debug("AlphaTab","ESM webworker construction with blob import failed",e.core.scriptFile,t)}}if(!e.core.scriptFile)throw new R(t.AlphaTabErrorType.General,"Could not detect alphaTab script file, cannot initialize renderer");try{j.debug("AlphaTab","Creating Blob worker");const t=`importScripts('${e.core.scriptFile}')`,s=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(s))}catch{return j.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(e.core.scriptFile)}},(e,s)=>{if(eu.webPlatform===t.WebPlatform.NodeJs)throw new R(t.AlphaTabErrorType.General,"Audio Worklets not yet supported in Node.js");if(eu.webPlatform===t.WebPlatform.BrowserModule||eu.isWebPackBundled||eu.isViteBundled){j.debug("AlphaTab","Creating Module worklet");return e.audioWorklet.addModule(new eu.alphaTabUrl("./alphaTab.worklet.ts",{}))}return j.debug("AlphaTab","Creating Script worklet"),e.audioWorklet.addModule(s.core.scriptFile)}),t.AlphaTabApi=nh,t.AlphaTabApiBase=Ha,t.AlphaTabError=R,t.ConsoleLogger=z,t.CoreSettings=su,t.DisplaySettings=pr,t.EngravingSettings=dr,t.EngravingStemInfo=ur,t.Environment=eu,t.ExporterSettings=Cr,t.FileLoadError=Ua,t.FormatError=pe,t.ImporterSettings=br,t.Logger=j,t.NotationSettings=H,t.PlayerSettings=wr,t.ProgressEventArgs=ih,t.RenderEngineFactory=tu,t.RenderingResources=fr,t.ResizeEventArgs=Ma,t.Settings=Fr,t.SlidePlaybackSettings=gr,t.VibratoPlaybackSettings=mr,t.exporter=Su,t.importer=nu,t.io=ru,t.json=Fu,t.meta=O,t.midi=Nu,t.model=Pu,t.platform=Eu,t.rendering=Le,t.synth=Cu,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});