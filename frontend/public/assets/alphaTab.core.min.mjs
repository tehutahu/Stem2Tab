/*!
 * alphaTab v1.7.1 (, build 24)
 *
 * Copyright © 2025, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */
class t{t;i=new Set;constructor(t){this.t=t,window.addEventListener("resize",this.o.bind(this),!1)}observe(t){this.i.add(t)}unobserve(t){this.i.delete(t)}disconnect(){this.i.clear()}o(){const t=[];for(const e of this.i)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this.t(t,this)}}class e{t;l=[];u=null;constructor(t){this.t=t,window.addEventListener("resize",()=>this.p,!0),document.addEventListener("scroll",()=>this.p,!0)}p(){this.u||(this.u=setTimeout(()=>{this.m(),this.u=null},100))}observe(t){this.l.indexOf(t)>=0||(this.l.push(t),this.p())}unobserve(t){this.l=this.l.filter(e=>e!==t)}m(){const t=[];for(const e of this.l){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this.t(t,this)}}var s,i,n,r,a,h,o,c,l,u,d,f,p,b,m,g,w,y,k,S,B,_,x,T,M,v,N,P,E,F,C,A,D,L;void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=t),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=e),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...t){this.innerHTML="",this.append(...t)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(t,e){return this.replace(new RegExp(t,"g"),e)}),function(t){t[t.General=0]="General",t[t.Format=1]="Format",t[t.AlphaTex=2]="AlphaTex"}(s||(s={}));class W extends Error{type;constructor(t,e="",s){super(e??"",{cause:s}),this.type=t}}class O{static version="1.7.1";static date="2025-12-02T16:54:46.381Z";static commit="e487b958158892679a115693547661dc49a78e16";static print(t){t(`alphaTab ${O.version}`),t(`commit: ${O.commit}`),t(`build date: ${O.date}`)}}!function(t){t[t.PPP=0]="PPP",t[t.PP=1]="PP",t[t.P=2]="P",t[t.MP=3]="MP",t[t.MF=4]="MF",t[t.F=5]="F",t[t.FF=6]="FF",t[t.FFF=7]="FFF",t[t.PPPP=8]="PPPP",t[t.PPPPP=9]="PPPPP",t[t.PPPPPP=10]="PPPPPP",t[t.FFFF=11]="FFFF",t[t.FFFFF=12]="FFFFF",t[t.FFFFFF=13]="FFFFFF",t[t.SF=14]="SF",t[t.SFP=15]="SFP",t[t.SFPP=16]="SFPP",t[t.FP=17]="FP",t[t.RF=18]="RF",t[t.RFZ=19]="RFZ",t[t.SFZ=20]="SFZ",t[t.SFFZ=21]="SFFZ",t[t.FZ=22]="FZ",t[t.N=23]="N",t[t.PF=24]="PF",t[t.SFZP=25]="SFZP"}(i||(i={}));class R{static QuarterTime=960;static k=15;static VelocityIncrement=16;static ticksToMillis(t,e){return t*(6e4/(e*R.QuarterTime))|0}static millisToTicks(t,e){return t/(6e4/(e*R.QuarterTime))|0}static toTicks(t){return R.valueToTicks(t)}static valueToTicks(t){let e=t;return e<0&&(e=1/-e),R.QuarterTime*(4/e)|0}static applyDot(t,e){return e?t+3*(t/4|0):t+(t/2|0)}static applyTuplet(t,e,s){return t*s/e|0}static removeTuplet(t,e,s){return t*e/s|0}static dynamicToVelocity(t,e=0){let s=1;switch(t){case i.PPP:s=R.k+0*R.VelocityIncrement;break;case i.PP:s=R.k+1*R.VelocityIncrement;break;case i.P:s=R.k+2*R.VelocityIncrement;break;case i.MP:s=R.k+3*R.VelocityIncrement;break;case i.MF:s=R.k+4*R.VelocityIncrement;break;case i.F:s=R.k+5*R.VelocityIncrement;break;case i.FF:s=R.k+6*R.VelocityIncrement;break;case i.FFF:s=R.k+7*R.VelocityIncrement;break;case i.PPPP:s=10;break;case i.PPPPP:s=5;break;case i.PPPPPP:s=3;break;case i.FFFF:s=R.k+8*R.VelocityIncrement;break;case i.FFFFF:s=R.k+9*R.VelocityIncrement;break;case i.FFFFFF:s=R.k+10*R.VelocityIncrement;break;case i.SF:case i.SFP:case i.SFZP:case i.SFPP:case i.SFZ:case i.FZ:s=R.k+6*R.VelocityIncrement;break;case i.FP:case i.RF:case i.RFZ:case i.SFFZ:s=R.k+5*R.VelocityIncrement;break;case i.N:s=1;break;case i.PF:s=R.k+(4.5*R.VelocityIncrement|0)}return s+=e*R.VelocityIncrement,Math.min(Math.max(s,1),127)}}!function(t){t[t.Tempo=0]="Tempo",t[t.Volume=1]="Volume",t[t.Instrument=2]="Instrument",t[t.Balance=3]="Balance",t[t.SyncPoint=4]="SyncPoint",t[t.Bank=4]="Bank"}(n||(n={}));class I{barOccurence=0;millisecondOffset=0}class G{isLinear=!1;type=n.Tempo;value=0;syncPointValue;ratioPosition=0;text="";isVisible=!0;static buildTempoAutomation(t,e,s,i,r=!0){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),h=new G;return h.type=n.Tempo,h.isLinear=t,h.ratioPosition=e,h.value=s*a[i],h.isVisible=r,h}static buildInstrumentAutomation(t,e,s){const i=new G;return i.type=n.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}class ${static MaxPosition=60;static MaxValue=12;offset;value;constructor(t=0,e=0){this.offset=t,this.value=e}}!function(t){t[t.Default=0]="Default",t[t.Gradual=1]="Gradual",t[t.Fast=2]="Fast"}(r||(r={})),function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Bend=2]="Bend",t[t.Release=3]="Release",t[t.BendRelease=4]="BendRelease",t[t.Hold=5]="Hold",t[t.Prebend=6]="Prebend",t[t.PrebendBend=7]="PrebendBend",t[t.PrebendRelease=8]="PrebendRelease"}(a||(a={})),function(t){t[t.None=0]="None",t[t.BrushUp=1]="BrushUp",t[t.BrushDown=2]="BrushDown",t[t.ArpeggioUp=3]="ArpeggioUp",t[t.ArpeggioDown=4]="ArpeggioDown"}(h||(h={})),function(t){t[t.None=0]="None",t[t.Crescendo=1]="Crescendo",t[t.Decrescendo=2]="Decrescendo"}(o||(o={})),function(t){t[t.QuadrupleWhole=-4]="QuadrupleWhole",t[t.DoubleWhole=-2]="DoubleWhole",t[t.Whole=1]="Whole",t[t.Half=2]="Half",t[t.Quarter=4]="Quarter",t[t.Eighth=8]="Eighth",t[t.Sixteenth=16]="Sixteenth",t[t.ThirtySecond=32]="ThirtySecond",t[t.SixtyFourth=64]="SixtyFourth",t[t.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",t[t.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(c||(c={})),function(t){t[t.None=0]="None",t[t.OnBeat=1]="OnBeat",t[t.BeforeBeat=2]="BeforeBeat",t[t.BendGrace=3]="BendGrace"}(l||(l={})),function(t){t[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Heavy=2]="Heavy",t[t.Tenuto=3]="Tenuto"}(u||(u={})),function(t){t[t.Unknown=-2]="Unknown",t[t.NoOrDead=-1]="NoOrDead",t[t.Thumb=0]="Thumb",t[t.IndexFinger=1]="IndexFinger",t[t.MiddleFinger=2]="MiddleFinger",t[t.AnnularFinger=3]="AnnularFinger",t[t.LittleFinger=4]="LittleFinger"}(d||(d={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Artificial=2]="Artificial",t[t.Pinch=3]="Pinch",t[t.Tap=4]="Tap",t[t.Semi=5]="Semi",t[t.Feedback=6]="Feedback"}(f||(f={})),function(t){t[t.Default=0]="Default",t[t.ForceNone=1]="ForceNone",t[t.ForceNatural=2]="ForceNatural",t[t.ForceSharp=3]="ForceSharp",t[t.ForceDoubleSharp=4]="ForceDoubleSharp",t[t.ForceFlat=5]="ForceFlat",t[t.ForceDoubleFlat=6]="ForceDoubleFlat"}(p||(p={})),function(t){t[t.S=0]="_15ma",t[t._=1]="_8va",t[t.Regular=2]="Regular",t[t.T=3]="_8vb",t[t.M=4]="_15mb"}(b||(b={})),function(t){t[t.None=0]="None",t[t.IntoFromBelow=1]="IntoFromBelow",t[t.IntoFromAbove=2]="IntoFromAbove"}(m||(m={})),function(t){t[t.None=0]="None",t[t.Shift=1]="Shift",t[t.Legato=2]="Legato",t[t.OutUp=3]="OutUp",t[t.OutDown=4]="OutDown",t[t.PickSlideDown=5]="PickSlideDown",t[t.PickSlideUp=6]="PickSlideUp"}(g||(g={})),function(t){t[t.None=0]="None",t[t.Slight=1]="Slight",t[t.Wide=2]="Wide"}(w||(w={})),function(t){t[t.Hidden=0]="Hidden",t[t.ShowWithBeams=1]="ShowWithBeams",t[t.ShowWithBars=2]="ShowWithBars",t[t.Automatic=3]="Automatic"}(y||(y={})),function(t){t[t.ScoreDefault=0]="ScoreDefault",t[t.ScoreForcePiano=1]="ScoreForcePiano",t[t.SingleNoteEffectBand=2]="SingleNoteEffectBand",t[t.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano"}(k||(k={})),function(t){t[t.GuitarPro=0]="GuitarPro",t[t.SongBook=1]="SongBook"}(S||(S={})),function(t){t[t.ScoreTitle=0]="ScoreTitle",t[t.ScoreSubTitle=1]="ScoreSubTitle",t[t.ScoreArtist=2]="ScoreArtist",t[t.ScoreAlbum=3]="ScoreAlbum",t[t.ScoreWords=4]="ScoreWords",t[t.ScoreMusic=5]="ScoreMusic",t[t.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",t[t.ScoreCopyright=7]="ScoreCopyright",t[t.GuitarTuning=8]="GuitarTuning",t[t.TrackNames=9]="TrackNames",t[t.ChordDiagrams=10]="ChordDiagrams",t[t.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",t[t.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",t[t.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",t[t.EffectAlternateEndings=14]="EffectAlternateEndings",t[t.EffectCapo=15]="EffectCapo",t[t.EffectChordNames=16]="EffectChordNames",t[t.EffectCrescendo=17]="EffectCrescendo",t[t.EffectDynamics=18]="EffectDynamics",t[t.EffectFadeIn=19]="EffectFadeIn",t[t.EffectFermata=20]="EffectFermata",t[t.EffectFingering=21]="EffectFingering",t[t.EffectHarmonics=22]="EffectHarmonics",t[t.EffectLetRing=23]="EffectLetRing",t[t.EffectLyrics=24]="EffectLyrics",t[t.EffectMarker=25]="EffectMarker",t[t.EffectOttavia=26]="EffectOttavia",t[t.EffectPalmMute=27]="EffectPalmMute",t[t.EffectPickSlide=28]="EffectPickSlide",t[t.EffectPickStroke=29]="EffectPickStroke",t[t.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",t[t.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",t[t.EffectTap=32]="EffectTap",t[t.EffectTempo=33]="EffectTempo",t[t.EffectText=34]="EffectText",t[t.EffectTrill=35]="EffectTrill",t[t.EffectTripletFeel=36]="EffectTripletFeel",t[t.EffectWhammyBar=37]="EffectWhammyBar",t[t.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",t[t.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",t[t.EffectLeftHandTap=40]="EffectLeftHandTap",t[t.EffectFreeTime=41]="EffectFreeTime",t[t.EffectSustainPedal=42]="EffectSustainPedal",t[t.EffectGolpe=43]="EffectGolpe",t[t.EffectWahPedal=44]="EffectWahPedal",t[t.EffectBeatBarre=45]="EffectBeatBarre",t[t.EffectNoteOrnament=46]="EffectNoteOrnament",t[t.EffectRasgueado=47]="EffectRasgueado",t[t.EffectDirections=48]="EffectDirections",t[t.EffectBeatTimer=49]="EffectBeatTimer"}(B||(B={}));class V{notationMode=S.GuitarPro;fingeringMode=k.ScoreDefault;elements=new Map;static defaultElements=new Map([[B.ZerosOnDiveWhammys,!1]]);rhythmMode=y.Automatic;rhythmHeight=15;transpositionPitches=[];displayTranspositionPitches=[];smallGraceTabNotes=!0;extendBendArrowsOnTiedNotes=!0;extendLineEffectsToBeatEnd=!1;slurHeight=5;isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!V.defaultElements.has(t)||V.defaultElements.get(t)}}class H{v;L=void 0;get hasValue(){return void 0!==this.L}constructor(t){this.v=t}get value(){return void 0===this.L&&(this.L=this.v()),this.L}reset(){this.L=void 0}}!function(t){t[t.None=0]="None",t[t.Debug=1]="Debug",t[t.Info=2]="Info",t[t.Warning=3]="Warning",t[t.Error=4]="Error"}(_||(_={}));class U{static logLevel=_.Info;static W(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(U.W(t,e),...s)}warning(t,e,...s){console.warn(U.W(t,e),...s)}info(t,e,...s){console.info(U.W(t,e),...s)}error(t,e,...s){console.error(U.W(t,e),...s)}}class z{static logLevel=_.Info;static log=new U;static O(t){return z.logLevel!==_.None&&t>=z.logLevel}static debug(t,e,...s){z.O(_.Debug)&&z.log.debug(t,e,...s)}static warning(t,e,...s){z.O(_.Warning)&&z.log.warning(t,e,...s)}static info(t,e,...s){z.O(_.Info)&&z.log.info(t,e,...s)}static error(t,e,...s){z.O(_.Error)&&z.log.error(t,e,...s)}}!function(t){t[t.NoBrackets=0]="NoBrackets",t[t.GroupStaves=1]="GroupStaves",t[t.GroupSimilarInstruments=2]="GroupSimilarInstruments"}(x||(x={})),function(t){t[t.Hidden=0]="Hidden",t[t.FirstSystem=1]="FirstSystem",t[t.AllSystems=2]="AllSystems"}(T||(T={})),function(t){t[t.FullName=0]="FullName",t[t.ShortName=1]="ShortName"}(M||(M={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(v||(v={}));class j{hideDynamics=!1;bracketExtendMode=x.GroupStaves;useSystemSignSeparator=!1;globalDisplayTuning=!0;perTrackDisplayTuning=null;globalDisplayChordDiagramsOnTop=!0;perTrackChordDiagramsOnTop=null;singleTrackTrackNamePolicy=T.FirstSystem;multiTrackTrackNamePolicy=T.FirstSystem;firstSystemTrackNameMode=M.ShortName;otherSystemsTrackNameMode=M.ShortName;firstSystemTrackNameOrientation=v.Vertical;otherSystemsTrackNameOrientation=v.Vertical;multiTrackMultiBarRest=!1;perTrackMultiBarRest=null}class X{masterBars=[];opening=null;get openings(){const t=this.opening;return t?[t]:[]}closings=[];get isOpened(){return!0===this.opening?.isRepeatStart}isClosed=!1;addMasterBar(t){null===this.opening&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class J{colors=new Map}!function(t){t[t.Neutral=0]="Neutral",t[t.C3=1]="C3",t[t.C4=2]="C4",t[t.F4=3]="F4",t[t.G2=4]="G2"}(N||(N={})),function(t){t[t.None=0]="None",t[t.Simple=1]="Simple",t[t.FirstOfDouble=2]="FirstOfDouble",t[t.SecondOfDouble=3]="SecondOfDouble"}(P||(P={})),function(t){t[t.Cb=-7]="Cb",t[t.Gb=-6]="Gb",t[t.Db=-5]="Db",t[t.Ab=-4]="Ab",t[t.Eb=-3]="Eb",t[t.Bb=-2]="Bb",t[t.F=-1]="F",t[t.C=0]="C",t[t.G=1]="G",t[t.D=2]="D",t[t.A=3]="A",t[t.E=4]="E",t[t.B=5]="B",t[t.FSharp=6]="FSharp",t[t.CSharp=7]="CSharp"}(E||(E={})),function(t){t[t.Major=0]="Major",t[t.Minor=1]="Minor"}(F||(F={})),function(t){t[t.Down=0]="Down",t[t.Hold=1]="Hold",t[t.Up=2]="Up"}(C||(C={}));class q{ratioPosition=0;pedalType=C.Down;bar;nextPedalMarker=null;previousPedalMarker=null}!function(t){t[t.StandardNotationRepeats=0]="StandardNotationRepeats",t[t.GuitarTabsRepeats=1]="GuitarTabsRepeats",t[t.SlashRepeats=2]="SlashRepeats",t[t.NumberedRepeats=3]="NumberedRepeats",t[t.StandardNotationBarNumber=4]="StandardNotationBarNumber",t[t.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",t[t.SlashBarNumber=6]="SlashBarNumber",t[t.NumberedBarNumber=7]="NumberedBarNumber",t[t.StandardNotationBarLines=8]="StandardNotationBarLines",t[t.GuitarTabsBarLines=9]="GuitarTabsBarLines",t[t.SlashBarLines=10]="SlashBarLines",t[t.NumberedBarLines=11]="NumberedBarLines",t[t.StandardNotationClef=12]="StandardNotationClef",t[t.GuitarTabsClef=13]="GuitarTabsClef",t[t.StandardNotationKeySignature=14]="StandardNotationKeySignature",t[t.NumberedKeySignature=15]="NumberedKeySignature",t[t.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",t[t.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",t[t.SlashTimeSignature=18]="SlashTimeSignature",t[t.NumberedTimeSignature=19]="NumberedTimeSignature",t[t.StandardNotationStaffLine=20]="StandardNotationStaffLine",t[t.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",t[t.SlashStaffLine=22]="SlashStaffLine",t[t.NumberedStaffLine=23]="NumberedStaffLine"}(A||(A={}));class Y extends J{}!function(t){t[t.Automatic=0]="Automatic",t[t.Dashed=1]="Dashed",t[t.Dotted=2]="Dotted",t[t.Heavy=3]="Heavy",t[t.HeavyHeavy=4]="HeavyHeavy",t[t.HeavyLight=5]="HeavyLight",t[t.LightHeavy=6]="LightHeavy",t[t.LightLight=7]="LightLight",t[t.None=8]="None",t[t.Regular=9]="Regular",t[t.Short=10]="Short",t[t.Tick=11]="Tick"}(D||(D={}));class K{static R=0;static resetIds(){K.R=0}id=K.R++;index=0;nextBar=null;previousBar=null;clef=N.G2;clefOttava=b.Regular;staff;voices=[];simileMark=P.None;I=new Set([0]);get isMultiVoice(){return this.I.size>1}get filledVoices(){return this.I}displayScale=1;displayWidth=-1;sustainPedals=[];get masterBar(){return this.staff.track.score.masterBars[this.index]}$=!0;V=!0;get isEmpty(){return this.$}get hasChanges(){if(0===this.index)return!0;return!(this.keySignature===this.previousBar.keySignature&&this.keySignatureType===this.previousBar.keySignatureType&&this.clef===this.previousBar.clef&&this.clefOttava===this.previousBar.clefOttava)||(this.simileMark!==P.None||this.sustainPedals.length>0||this.barLineLeft!==D.Automatic||this.barLineRight!==D.Automatic)}get isRestOnly(){return this.V}barLineLeft=D.Automatic;barLineRight=D.Automatic;keySignature=E.C;keySignatureType=F.Major;getActualBarLineLeft(t){return K.H(this,!1,t)}getActualBarLineRight(){return K.H(this,!0,!1)}static U(t,e,s){let i;return i=e?t.isRepeatEnd?D.LightHeavy:t.nextMasterBar?t.isFreeTime?D.Dashed:t.isDoubleBar?D.LightLight:D.Regular:D.LightHeavy:t.isRepeatStart?D.HeavyLight:s?D.Regular:D.None,i}static H(t,e,s){const i=t.masterBar,n=e?t.barLineRight:t.barLineLeft;let r;return r=n===D.Automatic?K.U(i,e,s):n,r}style;addVoice(t){t.bar=this,t.index=this.voices.length,this.voices.push(t)}finish(t,e=null){this.I.clear(),this.I.add(0),this.$=!0,this.V=!0;for(let s=0,i=this.voices.length;s<i;s++){const i=this.voices[s];i.finish(t,e),i.isEmpty||(this.$=!1,this.I.add(s)),i.isRestOnly||(this.V=!1)}const s=this.sustainPedals;if(s.length>0){let t=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],t.pedalType===C.Up&&(t=null));const e=null!==t&&t.pedalType!==C.Up;for(const i of s){if(t&&t.pedalType!==C.Up){if(t.bar===this&&i.ratioPosition<=t.ratioPosition)continue;t.nextPedalMarker=i,i.previousPedalMarker=t}e&&i.pedalType===C.Down&&(i.pedalType=C.Hold),i.bar=this,this.sustainPedals.push(i),t=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(t.pedalType!==C.Up){const e=new q;e.ratioPosition=0,e.bar=this,e.pedalType=C.Hold,this.sustainPedals.push(e),t.nextPedalMarker=e,e.previousPedalMarker=t}}}calculateDuration(){let t=0;for(const e of this.voices){const s=e.calculateDuration();s>t&&(t=s)}return t}}class Q{beats=[];id="empty";isComplete=!1;addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}!function(t){t[t.Glyphs=0]="Glyphs"}(L||(L={}));class Z extends J{}let tt=class t{j;$=!0;V=!0;static X=0;static resetIds(){t.X=0}id=t.X++;index=0;bar;beats=[];get isEmpty(){return this.$}style;forceNonEmpty(){this.$=!1}get isRestOnly(){return this.V}insertBeat(t,e){e.nextBeat=t.nextBeat,e.nextBeat&&(e.nextBeat.previousBeat=e),e.previousBeat=t,e.voice=this,t.nextBeat=e,this.beats.splice(t.index+1,0,e)}addBeat(t){t.voice=this,t.index=this.beats.length,this.beats.push(t),t.isEmpty||(this.$=!1),t.isRest||(this.V=!1)}J(t,e=null){if(this.bar){if(t.index<this.beats.length-1)t.nextBeat=this.beats[t.index+1],t.nextBeat.previousBeat=t;else if(t.isLastOfVoice&&t.voice.bar.nextBar){const e=this.bar.nextBar.voices[this.index];e.beats.length>0?(t.nextBeat=e.beats[0],t.nextBeat.previousBeat=t):t.nextBeat.previousBeat=t}t.chain(e)}}addGraceBeat(t){if(0===this.beats.length)return void this.addBeat(t);const e=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(t),this.addBeat(e),this.$=!1,this.V=!1}getBeatAtPlaybackStart(t){return this.j.has(t)?this.j.get(t):null}finish(t,e=null){this.$=!0,this.V=!0,this.j=new Map;let s=null;for(let t=0;t<this.beats.length;t++){const i=this.beats[t];i.index=t,this.J(i,e),i.graceType===l.None?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new Q),s.addBeat(i)),i.isEmpty||(this.$=!1),i.isRest||(this.V=!1)}let i=0,n=0;for(let s=0;s<this.beats.length;s++){const r=this.beats[s];if(r.index=s,r.finish(t,e),r.graceType===l.None){if(r.graceGroup){const t=r.graceGroup.beats[0],e=r.graceGroup.beats[r.graceGroup.beats.length-1];if(t.graceType!==l.BendGrace){const s=e.playbackStart+e.playbackDuration-t.playbackStart;switch(t.graceType){case l.BeforeBeat:t.previousBeat?(t.previousBeat.playbackDuration-=s,n=t.previousBeat.voice===this?t.previousBeat.playbackStart+t.previousBeat.playbackDuration:-s):n=-s;for(const t of r.graceGroup.beats)this.j.delete(t.playbackStart),t.playbackStart=n,this.j.set(t.playbackStart,r),n+=t.playbackDuration;break;case l.OnBeat:r.playbackDuration-=s,n=e.voice===this?e.playbackStart+e.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=n,this.j.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=n;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,n+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const t=this.beats[this.beats.length-1],e=this.beats[0];return t.playbackStart+t.playbackDuration-e.playbackStart}};var et,st,it,nt,rt,at,ht,ot,ct,lt,ut,dt,ft,pt,bt,mt,gt,wt,yt,kt,St,Bt,_t,xt,Tt,Mt,vt,Nt,Pt,Et,Ft,Ct;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(et||(et={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom",t[t.Alphabetic=3]="Alphabetic"}(st||(st={}));class At{width;height;constructor(t,e){this.width=t,this.height=e}}class Dt{static fillMusicFontSymbolSafe(t,e,s,i,n,r){t.settings.display.resources.engravingSettings.hasSymbol(n)&&t.fillMusicFontSymbol(e,s,i,n,r)}static fillMusicFontSymbolsSafe(t,e,s,i,n,r){const a=n.filter(e=>t.settings.display.resources.engravingSettings.hasSymbol(e));0!==a.length&&t.fillMusicFontSymbols(e,s,i,a,r)}}!function(t){t[t.Title=0]="Title",t[t.SubTitle=1]="SubTitle",t[t.Artist=2]="Artist",t[t.Album=3]="Album",t[t.Words=4]="Words",t[t.Music=5]="Music",t[t.WordsAndMusic=6]="WordsAndMusic",t[t.Transcriber=7]="Transcriber",t[t.Copyright=8]="Copyright",t[t.CopyrightSecondLine=9]="CopyrightSecondLine",t[t.ChordDiagramList=10]="ChordDiagramList"}(it||(it={}));class Lt{template;isVisible;textAlign;constructor(t="",e=void 0,s=et.Left){this.template=t,this.isVisible=e,this.textAlign=s}static equals(t,e){return(void 0===t.isVisible||t.isVisible)===(void 0===e.isVisible||e.isVisible)&&(t.template===e.template&&t.textAlign===e.textAlign)}buildText(t){let e=!1,s=!1;const i=this.template.replace(Lt.q,(i,n)=>{s=!0;let r="";switch(n){case"TITLE":r=t.title;break;case"SUBTITLE":r=t.subTitle;break;case"ARTIST":r=t.artist;break;case"ALBUM":r=t.album;break;case"WORDS":case"WORDSMUSIC":r=t.words;break;case"MUSIC":r=t.music;break;case"TABBER":r=t.tab;break;case"COPYRIGHT":r=t.copyright;break;default:r=""}return r&&(e=!0),r});return s&&!e?"":i}static q=/%([^%]+)%/g}class Wt extends J{headerAndFooter=new Map;static defaultHeaderAndFooter=new Map([[it.Title,new Lt("%TITLE%",void 0,et.Center)],[it.SubTitle,new Lt("%SUBTITLE%",void 0,et.Center)],[it.Artist,new Lt("%ARTIST%",void 0,et.Center)],[it.Album,new Lt("%ALBUM%",void 0,et.Center)],[it.Words,new Lt("Words by %WORDS%",void 0,et.Left)],[it.Music,new Lt("Music by %MUSIC%",void 0,et.Right)],[it.WordsAndMusic,new Lt("Words & Music by %MUSIC%",void 0,et.Right)],[it.Transcriber,new Lt("Tabbed by %TABBER%",!1,et.Right)],[it.Copyright,new Lt("%COPYRIGHT%",void 0,et.Center)],[it.CopyrightSecondLine,new Lt("All Rights Reserved - International Copyright Secured",!0,et.Center)]])}class Ot{Y=null;K=[];Z=0;static resetIds(){K.resetIds(),Yt.resetIds(),tt.resetIds(),Xt.resetIds()}album="";artist="";copyright="";instructions="";music="";notices="";subTitle="";title="";words="";tab="";get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}masterBars=[];tracks=[];defaultSystemsLayout=3;systemsLayout=[];stylesheet=new j;backingTrack;style;rebuildRepeatGroups(){this.Y=null,this.K=[],this.Z=0;for(const t of this.masterBars)this.tt(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,0!==this.masterBars.length&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this.tt(t),this.masterBars.push(t)}tt(t){t.isRepeatStart?(this.Y?.isClosed&&(this.K.pop(),this.Z--),this.Y=new X,this.K.push(this.Y),this.Z++):this.Y||(this.Y=new X,this.K.push(this.Y)),this.Y.addMasterBar(t),t.isRepeatEnd&&this.Z>1&&(this.K.pop(),this.Z--,this.Y=this.K.length>0?this.K[this.K.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e)}applyFlatSyncPoints(t){for(const t of this.masterBars)t.syncPoints=void 0;for(const e of t){const t=new G;t.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),t.type=n.SyncPoint,t.syncPointValue=new I,t.syncPointValue.millisecondOffset=e.millisecondOffset,t.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(t)}for(const t of this.masterBars)t.syncPoints&&t.syncPoints.sort((t,e)=>{const s=t.syncPointValue.barOccurence-e.syncPointValue.barOccurence;return 0!==s?s:t.ratioPosition-e.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}!function(t){t[t.NoTripletFeel=0]="NoTripletFeel",t[t.Triplet16th=1]="Triplet16th",t[t.Triplet8th=2]="Triplet8th",t[t.Dotted16th=3]="Dotted16th",t[t.Dotted8th=4]="Dotted8th",t[t.Scottish16th=5]="Scottish16th",t[t.Scottish8th=6]="Scottish8th"}(nt||(nt={}));class Rt{static MaxAlternateEndings=8;alternateEndings=0;nextMasterBar=null;previousMasterBar=null;index=0;get hasChanges(){if(0===this.index)return!1;return!(this.timeSignatureCommon===this.previousMasterBar.timeSignatureCommon&&this.timeSignatureNumerator===this.previousMasterBar.timeSignatureNumerator&&this.timeSignatureDenominator===this.previousMasterBar.timeSignatureDenominator&&this.tripletFeel===this.previousMasterBar.tripletFeel)||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(t){this.score.tracks[0].staves[0].bars[this.index].keySignature=t}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(t){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=t}isDoubleBar=!1;isRepeatStart=!1;get isRepeatEnd(){return this.repeatCount>0}repeatCount=0;repeatGroup;timeSignatureNumerator=4;timeSignatureDenominator=4;timeSignatureCommon=!1;isFreeTime=!1;tripletFeel=nt.NoTripletFeel;section=null;get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}tempoAutomations=[];syncPoints;score;fermata=null;start=0;isAnacrusis=!1;displayScale=1;displayWidth=-1;directions=null;calculateDuration(t=!0){if(this.isAnacrusis&&t){let t=0;for(const e of this.score.tracks)for(const s of e.staves){const e=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;e>t&&(t=e)}return t}return this.timeSignatureNumerator*R.valueToTicks(this.timeSignatureDenominator)}addFermata(t,e){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(t,e)}addDirection(t){null==this.directions&&(this.directions=new Set),this.directions.add(t)}getFermata(t){const e=this.fermata;return null===e?null:e.has(t.playbackStart)?e.get(t.playbackStart):0===t.index&&e.has(0)?e.get(0):null}addSyncPoint(t){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(t)}}class It{static DefaultChannelCount=17;static MetronomeChannel=It.DefaultChannelCount-1;static MetronomeKey=33;static AudioChannels=2;static MinVolume=0;static MinProgram=0;static MaxProgram=127;static MinPlaybackSpeed=.125;static MaxPlaybackSpeed=8;static PercussionChannel=9;static PercussionBank=128;static MaxPitchWheel=16384;static MaxPitchWheel20=4294967296;static DefaultPitchWheel=It.MaxPitchWheel/2;static MicroBufferCount=32;static MicroBufferSize=64}!function(t){t[t.None=-1]="None",t[t.Space=32]="Space",t[t.Brace=57344]="Brace",t[t.BracketTop=57347]="BracketTop",t[t.BracketBottom=57348]="BracketBottom",t[t.SystemDivider=57351]="SystemDivider",t[t.GClef=57424]="GClef",t[t.GClef15mb=57425]="GClef15mb",t[t.GClef8vb=57426]="GClef8vb",t[t.GClef8va=57427]="GClef8va",t[t.GClef15ma=57428]="GClef15ma",t[t.CClef=57436]="CClef",t[t.CClef8vb=57437]="CClef8vb",t[t.FClef=57442]="FClef",t[t.FClef15mb=57443]="FClef15mb",t[t.FClef8vb=57444]="FClef8vb",t[t.FClef8va=57445]="FClef8va",t[t.FClef15ma=57446]="FClef15ma",t[t.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",t[t.SixStringTabClef=57453]="SixStringTabClef",t[t.FourStringTabClef=57454]="FourStringTabClef",t[t.Clef8=57469]="Clef8",t[t.Clef15=57470]="Clef15",t[t.TimeSig0=57472]="TimeSig0",t[t.TimeSig1=57473]="TimeSig1",t[t.TimeSig2=57474]="TimeSig2",t[t.TimeSig3=57475]="TimeSig3",t[t.TimeSig4=57476]="TimeSig4",t[t.TimeSig5=57477]="TimeSig5",t[t.TimeSig6=57478]="TimeSig6",t[t.TimeSig7=57479]="TimeSig7",t[t.TimeSig8=57480]="TimeSig8",t[t.TimeSig9=57481]="TimeSig9",t[t.TimeSigCommon=57482]="TimeSigCommon",t[t.TimeSigCutCommon=57483]="TimeSigCutCommon",t[t.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",t[t.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",t[t.NoteheadWhole=57506]="NoteheadWhole",t[t.NoteheadHalf=57507]="NoteheadHalf",t[t.NoteheadBlack=57508]="NoteheadBlack",t[t.NoteheadNull=57509]="NoteheadNull",t[t.NoteheadXOrnate=57514]="NoteheadXOrnate",t[t.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",t[t.NoteheadPlusWhole=57517]="NoteheadPlusWhole",t[t.NoteheadPlusHalf=57518]="NoteheadPlusHalf",t[t.NoteheadPlusBlack=57519]="NoteheadPlusBlack",t[t.NoteheadSquareWhite=57528]="NoteheadSquareWhite",t[t.NoteheadSquareBlack=57529]="NoteheadSquareBlack",t[t.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",t[t.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",t[t.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",t[t.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",t[t.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",t[t.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",t[t.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",t[t.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",t[t.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",t[t.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",t[t.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",t[t.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",t[t.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",t[t.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",t[t.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",t[t.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",t[t.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",t[t.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",t[t.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",t[t.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",t[t.NoteheadCircleX=57523]="NoteheadCircleX",t[t.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",t[t.NoteheadXWhole=57511]="NoteheadXWhole",t[t.NoteheadXHalf=57512]="NoteheadXHalf",t[t.NoteheadXBlack=57513]="NoteheadXBlack",t[t.NoteheadParenthesis=57550]="NoteheadParenthesis",t[t.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",t[t.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",t[t.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",t[t.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",t[t.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",t[t.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",t[t.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",t[t.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",t[t.NoteheadCircledBlack=57572]="NoteheadCircledBlack",t[t.NoteheadCircledHalf=57573]="NoteheadCircledHalf",t[t.NoteheadCircledWhole=57574]="NoteheadCircledWhole",t[t.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",t[t.NoteheadCircleSlash=57591]="NoteheadCircleSlash",t[t.NoteheadHeavyX=57592]="NoteheadHeavyX",t[t.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",t[t.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",t[t.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",t[t.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",t[t.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",t[t.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",t[t.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",t[t.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",t[t.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",t[t.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",t[t.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",t[t.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",t[t.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",t[t.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",t[t.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",t[t.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",t[t.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",t[t.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",t[t.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",t[t.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",t[t.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",t[t.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",t[t.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",t[t.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",t[t.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",t[t.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",t[t.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",t[t.NoteQuarterUp=57813]="NoteQuarterUp",t[t.Note8thUp=57815]="Note8thUp",t[t.MetNoteQuarterUp=60581]="MetNoteQuarterUp",t[t.MetNote8thUp=60583]="MetNote8thUp",t[t.MetAugmentationDot=60599]="MetAugmentationDot",t[t.ArrowheadBlackUp=60280]="ArrowheadBlackUp",t[t.ArrowheadBlackDown=60284]="ArrowheadBlackDown",t[t.AugmentationDot=57831]="AugmentationDot",t[t.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",t[t.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",t[t.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",t[t.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",t[t.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",t[t.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",t[t.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",t[t.TextAugmentationDot=57852]="TextAugmentationDot",t[t.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",t[t.TextTuplet3LongStem=57858]="TextTuplet3LongStem",t[t.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",t[t.Tremolo3=57890]="Tremolo3",t[t.Tremolo2=57889]="Tremolo2",t[t.Tremolo1=57888]="Tremolo1",t[t.Flag8thUp=57920]="Flag8thUp",t[t.Flag8thDown=57921]="Flag8thDown",t[t.Flag16thUp=57922]="Flag16thUp",t[t.Flag16thDown=57923]="Flag16thDown",t[t.Flag32ndUp=57924]="Flag32ndUp",t[t.Flag32ndDown=57925]="Flag32ndDown",t[t.Flag64thUp=57926]="Flag64thUp",t[t.Flag64thDown=57927]="Flag64thDown",t[t.Flag128thUp=57928]="Flag128thUp",t[t.Flag128thDown=57929]="Flag128thDown",t[t.Flag256thUp=57930]="Flag256thUp",t[t.Flag256thDown=57931]="Flag256thDown",t[t.AccidentalFlat=57952]="AccidentalFlat",t[t.AccidentalNatural=57953]="AccidentalNatural",t[t.AccidentalSharp=57954]="AccidentalSharp",t[t.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",t[t.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",t[t.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",t[t.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",t[t.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",t[t.RepeatDot=57412]="RepeatDot",t[t.Segno=57415]="Segno",t[t.Coda=57416]="Coda",t[t.ArticAccentAbove=58528]="ArticAccentAbove",t[t.ArticAccentBelow=58529]="ArticAccentBelow",t[t.ArticStaccatoAbove=58530]="ArticStaccatoAbove",t[t.ArticStaccatoBelow=58531]="ArticStaccatoBelow",t[t.ArticTenutoAbove=58532]="ArticTenutoAbove",t[t.ArticTenutoBelow=58533]="ArticTenutoBelow",t[t.ArticMarcatoAbove=58540]="ArticMarcatoAbove",t[t.ArticMarcatoBelow=58541]="ArticMarcatoBelow",t[t.FermataAbove=58560]="FermataAbove",t[t.FermataShortAbove=58564]="FermataShortAbove",t[t.FermataLongAbove=58566]="FermataLongAbove",t[t.RestLonga=58593]="RestLonga",t[t.RestDoubleWhole=58594]="RestDoubleWhole",t[t.RestWhole=58595]="RestWhole",t[t.RestHalf=58596]="RestHalf",t[t.RestQuarter=58597]="RestQuarter",t[t.Rest8th=58598]="Rest8th",t[t.Rest16th=58599]="Rest16th",t[t.Rest32nd=58600]="Rest32nd",t[t.Rest64th=58601]="Rest64th",t[t.Rest128th=58602]="Rest128th",t[t.Rest256th=58603]="Rest256th",t[t.RestHBarLeft=58607]="RestHBarLeft",t[t.RestHBarMiddle=58608]="RestHBarMiddle",t[t.RestHBarRight=58609]="RestHBarRight",t[t.Repeat1Bar=58624]="Repeat1Bar",t[t.Repeat2Bars=58625]="Repeat2Bars",t[t.Ottava=58640]="Ottava",t[t.OttavaAlta=58641]="OttavaAlta",t[t.OttavaBassaVb=58652]="OttavaBassaVb",t[t.Quindicesima=58644]="Quindicesima",t[t.QuindicesimaAlta=58645]="QuindicesimaAlta",t[t.DynamicPPPPPP=58663]="DynamicPPPPPP",t[t.DynamicPPPPP=58664]="DynamicPPPPP",t[t.DynamicPPPP=58665]="DynamicPPPP",t[t.DynamicPPP=58666]="DynamicPPP",t[t.DynamicPP=58667]="DynamicPP",t[t.DynamicPiano=58656]="DynamicPiano",t[t.DynamicMP=58668]="DynamicMP",t[t.DynamicMF=58669]="DynamicMF",t[t.DynamicPF=58670]="DynamicPF",t[t.DynamicForte=58658]="DynamicForte",t[t.DynamicFF=58671]="DynamicFF",t[t.DynamicFFF=58672]="DynamicFFF",t[t.DynamicFFFF=58673]="DynamicFFFF",t[t.DynamicFFFFF=58674]="DynamicFFFFF",t[t.DynamicFFFFFF=58675]="DynamicFFFFFF",t[t.DynamicFortePiano=58676]="DynamicFortePiano",t[t.DynamicNiente=58662]="DynamicNiente",t[t.DynamicSforzando1=58678]="DynamicSforzando1",t[t.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",t[t.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",t[t.DynamicSforzato=58681]="DynamicSforzato",t[t.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",t[t.DynamicSforzatoFF=58683]="DynamicSforzatoFF",t[t.DynamicRinforzando1=58684]="DynamicRinforzando1",t[t.DynamicRinforzando2=58685]="DynamicRinforzando2",t[t.DynamicForzando=58677]="DynamicForzando",t[t.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",t[t.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",t[t.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",t[t.OrnamentTrill=58726]="OrnamentTrill",t[t.OrnamentTurn=58727]="OrnamentTurn",t[t.OrnamentTurnInverted=58728]="OrnamentTurnInverted",t[t.OrnamentShortTrill=58732]="OrnamentShortTrill",t[t.OrnamentMordent=58733]="OrnamentMordent",t[t.StringsDownBow=58896]="StringsDownBow",t[t.StringsUpBow=58898]="StringsUpBow",t[t.KeyboardPedalPed=58960]="KeyboardPedalPed",t[t.KeyboardPedalUp=58965]="KeyboardPedalUp",t[t.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",t[t.GuitarString0=59443]="GuitarString0",t[t.GuitarString1=59444]="GuitarString1",t[t.GuitarString2=59445]="GuitarString2",t[t.GuitarString3=59446]="GuitarString3",t[t.GuitarString4=59447]="GuitarString4",t[t.GuitarString5=59448]="GuitarString5",t[t.GuitarString6=59449]="GuitarString6",t[t.GuitarString7=59450]="GuitarString7",t[t.GuitarString8=59451]="GuitarString8",t[t.GuitarString9=59452]="GuitarString9",t[t.GuitarOpenPedal=59453]="GuitarOpenPedal",t[t.GuitarClosePedal=59455]="GuitarClosePedal",t[t.GuitarGolpe=59458]="GuitarGolpe",t[t.GuitarFadeIn=59459]="GuitarFadeIn",t[t.GuitarFadeOut=59460]="GuitarFadeOut",t[t.GuitarVolumeSwell=59461]="GuitarVolumeSwell",t[t.FretboardFilledCircle=59480]="FretboardFilledCircle",t[t.FretboardX=59481]="FretboardX",t[t.FretboardO=59482]="FretboardO",t[t.Tuplet0=59520]="Tuplet0",t[t.Tuplet1=59521]="Tuplet1",t[t.Tuplet2=59522]="Tuplet2",t[t.Tuplet3=59523]="Tuplet3",t[t.Tuplet4=59524]="Tuplet4",t[t.Tuplet5=59525]="Tuplet5",t[t.Tuplet6=59526]="Tuplet6",t[t.Tuplet7=59527]="Tuplet7",t[t.Tuplet8=59528]="Tuplet8",t[t.Tuplet9=59529]="Tuplet9",t[t.TupletColon=59530]="TupletColon",t[t.WiggleTrill=60068]="WiggleTrill",t[t.GuitarVibratoStroke=60082]="GuitarVibratoStroke",t[t.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",t[t.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",t[t.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",t[t.WiggleSawtooth=60091]="WiggleSawtooth",t[t.OctaveBaselineM=60565]="OctaveBaselineM",t[t.OctaveBaselineB=60563]="OctaveBaselineB",t[t.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",t[t.Fingering0=60688]="Fingering0",t[t.Fingering1=60689]="Fingering1",t[t.Fingering2=60690]="Fingering2",t[t.Fingering3=60691]="Fingering3",t[t.Fingering4=60692]="Fingering4",t[t.Fingering5=60693]="Fingering5",t[t.FingeringPLower=60695]="FingeringPLower",t[t.FingeringTLower=60696]="FingeringTLower",t[t.FingeringILower=60697]="FingeringILower",t[t.FingeringMLower=60698]="FingeringMLower",t[t.FingeringALower=60699]="FingeringALower",t[t.FingeringCLower=60700]="FingeringCLower"}(rt||(rt={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Sharp=2]="Sharp",t[t.Flat=3]="Flat",t[t.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",t[t.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",t[t.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",t[t.DoubleSharp=7]="DoubleSharp",t[t.DoubleFlat=8]="DoubleFlat"}(at||(at={}));class Gt{note=null;tone=new $t;octave=0;get realValue(){return 12*this.octave+this.tone.noteValue}}class $t{noteValue;accidentalMode;constructor(t=0,e=p.Default){this.noteValue=t,this.accidentalMode=e}}class Vt{static getIndex(t){return t<0?0:0|Math.log2(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return 0===t}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static isTuning(t){return!!Vt.parseTuning(t)}static tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]);static parseTuning(t){let e="",s="";for(let i=0;i<t.length;i++){const n=t.charCodeAt(i);if(n>=48&&n<=57){if(!e)return null;s+=String.fromCharCode(n)}else if(0===e.length){if(!Vt.tuningLetters.has(n))return null;e+=String.fromCharCode(n)}else e+=String.fromCharCode(n)}if(!s||!e)return null;const i=new Gt;i.octave=Number.parseInt(s,10)+1,i.note=e.toLowerCase();const n=Vt.getToneForText(i.note);return null===n?null:(i.tone=n,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(t){const e=Vt.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,n;switch(e.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!Vt.accidentalModeMapping.has(s))return null;switch(n=Vt.parseAccidentalMode(s),n){case p.Default:case p.ForceNone:case p.ForceNatural:break;case p.ForceSharp:i++;break;case p.ForceDoubleSharp:i+=2;break;case p.ForceFlat:i--;break;case p.ForceDoubleFlat:i-=2}return new $t(i,n)}static reverseAccidentalModeMapping=new Map([[p.Default,"d"],[p.ForceNone,"forcenone"],[p.ForceNatural,"forcenatural"],[p.ForceSharp,"#"],[p.ForceDoubleSharp,"x"],[p.ForceFlat,"b"],[p.ForceDoubleFlat,"bb"]]);static accidentalModeMapping=new Map([["default",p.Default],["d",p.Default],["",p.Default],["forcenone",p.ForceNone],["-",p.ForceNone],["forcenatural",p.ForceNatural],["n",p.ForceNatural],["forcesharp",p.ForceSharp],["#",p.ForceSharp],["forcedoublesharp",p.ForceDoubleSharp],["##",p.ForceDoubleSharp],["x",p.ForceDoubleSharp],["forceflat",p.ForceFlat],["b",p.ForceFlat],["forcedoubleflat",p.ForceDoubleFlat],["bb",p.ForceDoubleFlat]]);static parseAccidentalMode(t){const e=t.toLowerCase();return Vt.accidentalModeMapping.has(e)?Vt.accidentalModeMapping.get(e):p.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&t))+s,t>>=4}while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<Rt.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(t[0].index)))return null;const n=new Map,r=t[0].score;let a=e,h=r.tempo;for(;a<=s;){const i=a;let o=null;for(;a<=s;){const s=r.masterBars[a];let n=!1;for(const t of s.tempoAutomations)t.value!==h&&(n=!0),h=t.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&n||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0)break;if(i>e&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let c=!0;for(const e of t){for(const t of e.staves){const e=t.bars[s.index];if(!e.isRestOnly){c=!1;break}if(e.index>0&&(e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType)){c=!1;break}}if(!c)break}if(!c)break;if(a++,s.index>i&&(null===o?o=[s.index]:o.push(s.index)),s.isRepeatEnd)break}o?n.set(i,o):a++}return n}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let s,i=t.style;if(t.style||(i=new Wt,t.style=i),i.headerAndFooter.has(e))s=i.headerAndFooter.get(e);else{if(s=new Lt,Wt.defaultHeaderAndFooter.has(e)){const t=Wt.defaultHeaderAndFooter.get(e);s.template=t.template,s.textAlign=t.textAlign}i.headerAndFooter.set(e,s)}return s}static consolidate(t){if(0===t.masterBars.length){const e=new Rt;t.addMasterBar(e);const s=new G;s.isLinear=!1,s.type=n.Tempo,s.value=t.tempo,e.tempoAutomations.push(s);const i=new K;t.tracks[0].staves[0].addBar(i);const r=new tt;i.addVoice(r);const a=new Yt;return a.isEmpty=!0,void r.addBeat(a)}const e=new Set([It.PercussionChannel]);for(const s of t.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=It.PercussionChannel,s.playbackInfo.secondaryChannel=It.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==It.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==It.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const e of s.staves){for(const t of e.bars)for(const e of t.voices)if(e.isEmpty&&0===e.beats.length){const t=new Yt;t.isEmpty=!0,e.addBeat(t)}const s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<t.masterBars.length;){const t=new K;e.addBar(t);const i=t.previousBar;i&&(t.clef=i.clef,t.clefOttava=i.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);for(let e=0;e<s;e++){const e=new tt;t.addVoice(e);const s=new Yt;s.isEmpty=!0,e.addBeat(s)}}}}if(t.masterBars.length>0){if(!t.masterBars[0].tempoAutomations.find(t=>t.type===n.Tempo&&0===t.ratioPosition)){const e=new G;e.isLinear=!1,e.type=n.Tempo,e.value=t.tempo,e.text=t.tempoLabel,e.isVisible=!1,t.masterBars[0].tempoAutomations.push(e)}}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];if(!s.isEmpty||s.hasChanges)return}for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];t.bars.pop(),s.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static et=[];static getAllMusicFontSymbols(){return 0===Vt.et.length&&(Vt.et=Object.values(rt).filter(t=>"number"==typeof t).map(t=>t)),Vt.et}static displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]);static flooredDivision(t,e){return t-e*Math.floor(t/e)}static st(t){const e=[];for(const s of t){const t=[];e.push(t);for(const e of s){const s=Number.parseInt(e.charAt(0),10)*("b"===e.charAt(1)?-1:1);t.push(s)}}return e}static it=Vt.st([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]);static transposeKey(t,e){if(0===e)return t;if(e<0){const s=Vt.it[-e].indexOf(t);return-1===s?t:s-7}return Vt.it[e][t+7]}static nt=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]];static accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1];static computeAccidental(t,e,s,i,n=null){const r=t+7,a=s%12,h=r<7?at.Flat:at.Sharp,o=Vt.nt[r][a],c=Vt.accidentalNotes[a];let l=at.None;if(i)switch(l=c?h:at.Natural,l){case at.Natural:l=at.NaturalQuarterNoteUp;break;case at.Sharp:l=at.SharpQuarterNoteUp;break;case at.Flat:l=at.FlatQuarterNoteUp}else{switch(e){case p.ForceSharp:l=at.Sharp;break;case p.ForceDoubleSharp:l=at.DoubleSharp;break;case p.ForceFlat:l=at.Flat;break;case p.ForceDoubleFlat:l=at.DoubleFlat;break;default:c?l=h:o&&(l=at.Natural)}l!==at.None?null!=n?n===l&&(l=at.None):o&&l===h&&(l=at.None):null!==n&&(l=n===at.Natural?at.None:at.Natural)}return l}static toArticulationId(t){return t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}}!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down"}(ht||(ht={})),function(t){t[t.Above=0]="Above",t[t.Inside=1]="Inside",t[t.Below=2]="Below",t[t.Outside=3]="Outside"}(ot||(ot={}));class Ht{elementType;staffLine;noteHeadDefault;noteHeadHalf;noteHeadWhole;techniqueSymbol;techniqueSymbolPlacement;outputMidiNumber;constructor(t="",e=0,s=0,i=rt.None,n=rt.None,r=rt.None,a=rt.None,h=ot.Inside){this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=n!==rt.None?n:i,this.noteHeadWhole=r!==rt.None?r:i,this.techniqueSymbol=a,this.techniqueSymbolPlacement=h}getSymbol(t){switch(t){case c.Whole:return this.noteHeadWhole;case c.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class Ut{static rt=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]];static articulationFromElementVariation(t,e){return t<Ut.rt.length?(e>=Ut.rt.length&&(e=0),Ut.rt[t][e]):38}static instrumentArticulations=new Map([[38,new Ht("snare",3,38,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[37,new Ht("snare",3,37,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[91,new Ht("snare",3,38,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite)],[42,new Ht("hiHat",-1,42,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[92,new Ht("hiHat",-1,46,rt.NoteheadCircleSlash,rt.NoteheadCircleSlash,rt.NoteheadCircleSlash)],[46,new Ht("hiHat",-1,46,rt.NoteheadCircleX,rt.NoteheadCircleX,rt.NoteheadCircleX)],[44,new Ht("hiHat",9,44,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[35,new Ht("kickDrum",8,35,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[36,new Ht("kickDrum",7,36,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[50,new Ht("tom",1,50,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[48,new Ht("tom",2,48,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[47,new Ht("tom",4,47,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[45,new Ht("tom",5,45,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[43,new Ht("tom",6,43,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[93,new Ht("ride",0,51,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.PictEdgeOfCymbal,ot.Below)],[51,new Ht("ride",0,51,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[53,new Ht("ride",0,53,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite)],[94,new Ht("ride",0,51,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.ArticStaccatoAbove,ot.Above)],[55,new Ht("splash",-2,55,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[95,new Ht("splash",-2,55,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.ArticStaccatoAbove,ot.Below)],[52,new Ht("china",-3,52,rt.NoteheadHeavyXHat,rt.NoteheadHeavyXHat,rt.NoteheadHeavyXHat)],[96,new Ht("china",-3,52,rt.NoteheadHeavyXHat,rt.NoteheadHeavyXHat,rt.NoteheadHeavyXHat)],[49,new Ht("crash",-2,49,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.NoteheadHeavyX)],[97,new Ht("crash",-2,49,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.ArticStaccatoAbove,ot.Below)],[57,new Ht("crash",-1,57,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.NoteheadHeavyX)],[98,new Ht("crash",-1,57,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.NoteheadHeavyX,rt.ArticStaccatoAbove,ot.Below)],[99,new Ht("cowbell",1,56,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpHalf,rt.NoteheadTriangleUpWhole)],[100,new Ht("cowbell",1,56,rt.NoteheadXBlack,rt.NoteheadXHalf,rt.NoteheadXWhole)],[56,new Ht("cowbell",0,56,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpHalf,rt.NoteheadTriangleUpWhole)],[101,new Ht("cowbell",0,56,rt.NoteheadXBlack,rt.NoteheadXHalf,rt.NoteheadXWhole)],[102,new Ht("cowbell",-1,56,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpHalf,rt.NoteheadTriangleUpWhole)],[103,new Ht("cowbell",-1,56,rt.NoteheadXBlack,rt.NoteheadXHalf,rt.NoteheadXWhole)],[77,new Ht("woodblock",-9,77,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack)],[76,new Ht("woodblock",-10,76,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack)],[60,new Ht("bongo",-4,60,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[104,new Ht("bongo",-5,60,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.NoteheadParenthesis,ot.Inside)],[105,new Ht("bongo",-6,60,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[61,new Ht("bongo",-7,61,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[106,new Ht("bongo",-8,61,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.NoteheadParenthesis,ot.Inside)],[107,new Ht("bongo",-16,61,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[66,new Ht("timbale",10,66,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[65,new Ht("timbale",9,65,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[68,new Ht("agogo",12,68,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[67,new Ht("agogo",11,67,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[64,new Ht("conga",17,64,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[108,new Ht("conga",16,64,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[109,new Ht("conga",15,64,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.NoteheadParenthesis,ot.Inside)],[63,new Ht("conga",14,63,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[110,new Ht("conga",13,63,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[62,new Ht("conga",19,62,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.NoteheadParenthesis,ot.Inside)],[72,new Ht("whistle",-11,72,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[71,new Ht("whistle",-17,71,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[73,new Ht("guiro",38,73,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[74,new Ht("guiro",37,74,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[86,new Ht("surdo",36,86,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[87,new Ht("surdo",35,87,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadParenthesis,ot.Inside)],[54,new Ht("tambourine",3,54,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack)],[111,new Ht("tambourine",2,54,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.StringsUpBow,ot.Below)],[112,new Ht("tambourine",1,54,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.NoteheadTriangleUpBlack,rt.StringsDownBow,ot.Below)],[113,new Ht("tambourine",-7,54,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[79,new Ht("cuica",30,79,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[78,new Ht("cuica",29,78,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[58,new Ht("vibraslap",28,58,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[81,new Ht("triangle",27,81,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[80,new Ht("triangle",26,80,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadParenthesis,ot.Inside)],[114,new Ht("grancassa",25,43,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[115,new Ht("piatti",18,49,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[116,new Ht("piatti",24,49,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[69,new Ht("cabasa",23,69,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[117,new Ht("cabasa",22,69,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.StringsUpBow,ot.Below)],[85,new Ht("castanets",21,85,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[75,new Ht("claves",20,75,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[70,new Ht("maraca",-12,70,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[118,new Ht("maraca",-13,70,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.StringsUpBow,ot.Below)],[119,new Ht("maraca",-14,70,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[120,new Ht("maraca",-15,70,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.StringsUpBow,ot.Below)],[82,new Ht("shaker",-23,54,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[122,new Ht("shaker",-24,54,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.StringsUpBow,ot.Below)],[84,new Ht("bellTree",-18,53,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[123,new Ht("bellTree",-19,53,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole,rt.StringsUpBow,ot.Below)],[83,new Ht("jingleBell",-20,53,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[124,new Ht("unpitched",-21,62,rt.NoteheadNull,rt.NoteheadNull,rt.NoteheadNull,rt.GuitarGolpe,ot.Above)],[125,new Ht("unpitched",-22,62,rt.NoteheadNull,rt.NoteheadNull,rt.NoteheadNull,rt.GuitarGolpe,ot.Below)],[39,new Ht("handClap",3,39,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[40,new Ht("snare",3,40,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[31,new Ht("snare",3,40,rt.NoteheadSlashedBlack2,rt.NoteheadSlashedBlack2,rt.NoteheadSlashedBlack2)],[41,new Ht("tom",5,41,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole)],[59,new Ht("ride",2,59,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.PictEdgeOfCymbal,ot.Below)],[126,new Ht("ride",2,59,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[127,new Ht("ride",2,59,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite,rt.NoteheadDiamondWhite)],[29,new Ht("ride",2,59,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.ArticStaccatoAbove,ot.Above)],[30,new Ht("crash",-3,49,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[33,new Ht("snare",3,37,rt.NoteheadXBlack,rt.NoteheadXBlack,rt.NoteheadXBlack)],[34,new Ht("snare",3,38,rt.NoteheadBlack,rt.NoteheadBlack,rt.NoteheadBlack)]]);static instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);static getArticulationName(t){const e=Ut.getArticulation(t);let s=t.percussionArticulation;e&&(s=e.outputMidiNumber);for(const[t,e]of Ut.instrumentArticulationNames)if(e===s)return t;return"unknown"}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:Ut.getArticulationByInputMidiNumber(e)}static getElementAndVariation(t){const e=Ut.getArticulation(t);if(!e)return[-1,-1];for(let t=0;t<Ut.rt.length;t++){const s=Ut.rt[t];for(let i=0;i<s.length;i++){const n=Ut.getArticulationByInputMidiNumber(s[i]);if(n?.outputMidiNumber===e.outputMidiNumber)return[t,i]}}return[-1,-1]}static getArticulationByInputMidiNumber(t){return Ut.instrumentArticulations.has(t)?Ut.instrumentArticulations.get(t):null}}!function(t){t[t.None=0]="None",t[t.InvertedTurn=1]="InvertedTurn",t[t.Turn=2]="Turn",t[t.UpperMordent=3]="UpperMordent",t[t.LowerMordent=4]="LowerMordent"}(ct||(ct={}));class zt{tieDestinationNoteId=-1;tieOriginNoteId=-1;slurDestinationNoteId=-1;slurOriginNoteId=-1;hammerPullDestinationNoteId=-1;hammerPullOriginNoteId=-1;slideTargetNoteId=-1;slideOriginNoteId=-1}!function(t){t[t.Effects=0]="Effects",t[t.StandardNotationNoteHead=1]="StandardNotationNoteHead",t[t.StandardNotationAccidentals=2]="StandardNotationAccidentals",t[t.StandardNotationEffects=3]="StandardNotationEffects",t[t.GuitarTabFretNumber=4]="GuitarTabFretNumber",t[t.GuitarTabEffects=5]="GuitarTabEffects",t[t.SlashNoteHead=6]="SlashNoteHead",t[t.SlashEffects=7]="SlashEffects",t[t.NumberedNumber=8]="NumberedNumber",t[t.NumberedAccidentals=9]="NumberedAccidentals",t[t.NumberedEffects=10]="NumberedEffects"}(lt||(lt={}));class jt extends J{noteHead;noteHeadCenterOnStem}class Xt{static globalNoteId=0;static resetIds(){Xt.globalNoteId=0}id=Xt.globalNoteId++;index=0;accentuated=u.None;bendType=a.None;bendStyle=r.Default;bendOrigin=null;isContinuedBend=!1;bendPoints=null;maxBendPoint=null;get hasBend(){return null!==this.bendPoints&&this.bendType!==a.None}get isStringed(){return this.string>=0}fret=-1;string=-1;showStringNumber=!1;get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}octave=-1;tone=-1;get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?Ut.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?Ut.getElementAndVariation(this)[1]:-1}percussionArticulation=-1;isVisible=!0;isLeftHandTapped=!1;isHammerPullOrigin=!1;get isHammerPullDestination(){return!!this.hammerPullOrigin}hammerPullOrigin=null;hammerPullDestination=null;get isSlurOrigin(){return!!this.slurDestination}isSlurDestination=!1;slurOrigin=null;slurDestination=null;get isHarmonic(){return this.harmonicType!==f.None}harmonicType=f.None;harmonicValue=0;isGhost=!1;isLetRing=!1;letRingDestination=null;isPalmMute=!1;palmMuteDestination=null;isDead=!1;isStaccato=!1;slideInType=m.None;slideOutType=g.None;slideTarget=null;slideOrigin=null;vibrato=w.None;tieOrigin=null;tieDestination=null;isTieDestination=!1;get isTieOrigin(){return null!==this.tieDestination}leftHandFinger=d.Unknown;rightHandFinger=d.Unknown;get isFingering(){return this.leftHandFinger!==d.Unknown||this.rightHandFinger!==d.Unknown}trillValue=-1;get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}trillSpeed=c.ThirtySecond;durationPercent=1;accidentalMode=p.Default;beat;dynamics=i.F;isEffectSlurOrigin=!1;hasEffectSlur=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;ornament=ct.None;style;get stringTuning(){return this.beat.voice.bar.staff.capo+Xt.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(t,e){return t.tuning.length>0?t.tuning[t.tuning.length-(e-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){const s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let e=this.calculateRealValue(t,!1);return this.isStringed&&(this.harmonicType===f.Natural?e=this.harmonicPitch+this.stringTuning-s:e+=this.harmonicPitch),e}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===f.None||!this.isStringed)return 0;const t=this.harmonicValue;return Vt.isAlmostEqualTo(t,2.4)?36:Vt.isAlmostEqualTo(t,2.7)?34:t<3?0:t<=3.5?31:t<=4?28:t<=5?24:t<=6?34:t<=7?19:t<=8.5?36:t<=9?28:t<=10?34:t<=11?0:t<=12?12:t<14?0:t<=15?34:t<=16?28:t<=17?36:t<=18?0:t<=19?19:t<=21?0:t<=22?36:t<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let t=this.realValue;switch(this.harmonicType!==f.Natural&&this.harmonicType!==f.None&&(t-=this.harmonicPitch),this.beat.ottava){case b.S:t-=24;break;case b._:t-=12;break;case b.Regular:break;case b.T:t+=12;break;case b.M:t+=24}switch(this.beat.voice.bar.clefOttava){case b.S:t-=24;break;case b._:t-=12;break;case b.Regular:break;case b.T:t+=12;break;case b.M:t+=24}return t-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(t){let e=this.bendPoints;null===e&&(e=[],this.bendPoints=e),e.push(t),(!this.maxBendPoint||t.value>this.maxBendPoint.value)&&(this.maxBendPoint=t),this.bendType===a.None&&(this.bendType=a.Custom)}finish(t,e=null){const s=new H(()=>Xt.nextNoteOnSameLine(this)),i=t&&t.notation.notationMode===S.SongBook;if(this.isTieDestination&&(this.chain(e),i&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(s.value&&s.value.isLetRing?this.letRingDestination=s.value:this.letRingDestination=this,i&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(s.value&&s.value.isPalmMute?this.palmMuteDestination=s.value:this.palmMuteDestination=this),this.isHammerPullOrigin){const t=Xt.findHammerPullDestination(this);t?(this.hammerPullDestination=t,t.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case g.Shift:case g.Legato:this.slideTarget||(this.slideTarget=s.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=g.None}let n=null;this.isHammerPullOrigin&&this.hammerPullDestination?n=this.hammerPullDestination:this.slideOutType===g.Legato&&this.slideTarget&&(n=this.slideTarget),n&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===ht.None?(this.effectSlurOrigin.effectSlurDestination=n,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=n,this.effectSlurDestination.effectSlurOrigin=this));const r=this.bendPoints,h=null!=r&&r.length>0;if(h){const t=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=t}else this.bendType=a.None;if(h&&this.bendType===a.Custom)if(4===r.length){const t=r[0],e=r[1],s=r[2],i=r[3];e.value===s.value?i.value>t.value?e.value>i.value?this.bendType=a.BendRelease:!this.isContinuedBend&&t.value>0?(this.bendType=a.PrebendBend,r.splice(2,1),r.splice(1,1)):(this.bendType=a.Bend,r.splice(2,1),r.splice(1,1)):i.value<t.value?this.isContinuedBend?(this.bendType=a.Release,r.splice(2,1),r.splice(1,1)):(this.bendType=a.PrebendRelease,r.splice(2,1),r.splice(1,1)):e.value>t.value?this.bendType=a.BendRelease:t.value>0&&!this.isContinuedBend?(this.bendType=a.Prebend,r.splice(2,1),r.splice(1,1)):(this.bendType=a.Hold,r.splice(2,1),r.splice(1,1)):z.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===r.length){const t=r[0],e=r[1];e.value>t.value?!this.isContinuedBend&&t.value>0?this.bendType=a.PrebendBend:this.bendType=a.Bend:e.value<t.value?this.isContinuedBend?this.bendType=a.Release:this.bendType=a.PrebendRelease:t.value>0&&!this.isContinuedBend?this.bendType=a.Prebend:this.bendType=a.Hold}this.initialBendValue>0&&(this.accidentalMode=p.Default)}static ht=3;static nextNoteOnSameLine(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Xt.ht;){const s=e.getNoteOnString(t.string);if(s)return s;e=e.nextBeat}return null}static findHammerPullDestination(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Xt.ht;){let s=e.getNoteOnString(t.string);if(s)return s;for(let i=t.string;i>0;i--)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}e=e.nextBeat}return null}static findTieOrigin(t){let e=t.beat.previousBeat;for(;e&&e.voice.bar.index>=t.beat.voice.bar.index-Xt.ht;){if(t.isStringed){const s=e.getNoteOnString(t.string);if(s)return s}else if(-1===t.octave&&-1===t.tone){if(t.index<e.notes.length)return e.notes[t.index]}else{const s=e.getNoteWithRealValue(t.realValue);if(s)return s}e=e.previousBeat}return null}static ot="NoteIdLookup";ct=null;chain(t=null){if(null!==t)if(null!==this.ct){let e;t.has(Xt.ot)?e=t.get(Xt.ot):(e=new Map,t.set(Xt.ot,e)),-1===this.ct.hammerPullDestinationNoteId&&-1===this.ct.tieDestinationNoteId&&-1===this.ct.slurDestinationNoteId&&-1===this.ct.slideTargetNoteId||e.set(this.id,this),-1!==this.ct.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this.ct.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this.ct.tieOriginNoteId&&(this.tieOrigin=e.get(this.ct.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this.ct.slurOriginNoteId&&(this.slurOrigin=e.get(this.ct.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this.ct.slideOriginNoteId&&(this.slideOrigin=e.get(this.ct.slideOriginNoteId),this.slideOrigin.slideTarget=this),this.ct=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const t=this.tieOrigin??Xt.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(t){null!==this.tieDestination&&t.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&t.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&t.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&t.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&t.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&t.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&t.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&t.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(t,e){switch(t){case"tiedestinationnoteid":return null==this.ct&&(this.ct=new zt),this.ct.tieDestinationNoteId=e,!0;case"tieoriginnoteid":return null==this.ct&&(this.ct=new zt),this.ct.tieOriginNoteId=e,!0;case"slurdestinationnoteid":return null==this.ct&&(this.ct=new zt),this.ct.slurDestinationNoteId=e,!0;case"sluroriginnoteid":return null==this.ct&&(this.ct=new zt),this.ct.slurOriginNoteId=e,!0;case"hammerpulloriginnoteid":return null==this.ct&&(this.ct=new zt),this.ct.hammerPullOriginNoteId=e,!0;case"hammerpulldestinationnoteid":return null==this.ct&&(this.ct=new zt),this.ct.hammerPullDestinationNoteId=e,!0;case"slidetargetnoteid":return null==this.ct&&(this.ct=new zt),this.ct.slideTargetNoteId=e,!0;case"slideoriginnoteid":return null==this.ct&&(this.ct=new zt),this.ct.slideOriginNoteId=e,!0}return!1}}class Jt{static lt=1920;static ut=960;static dt=480;static ft=240;static bt=120;static gt=60;static wt=30;static yt=15;static kt=[Jt.lt,Jt.ut,Jt.dt,Jt.ft,Jt.bt,Jt.gt,Jt.wt,Jt.yt];St=!0;totalDuration=0;beats=[];voice;isFull=!1;constructor(t){this.voice=t}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==l.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.playbackDuration!==this.beats[0].playbackDuration&&(this.St=!1),this.beats.push(t),this.totalDuration+=t.playbackDuration,this.St)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const e of Jt.kt)if(this.totalDuration===e*t){this.isFull=!0;break}}return!0}}!function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Dive=2]="Dive",t[t.Dip=3]="Dip",t[t.Hold=4]="Hold",t[t.Predive=5]="Predive",t[t.PrediveDive=6]="PrediveDive"}(ut||(ut={})),function(t){t[t.None=0]="None",t[t.Thumb=1]="Thumb",t[t.Finger=2]="Finger"}(dt||(dt={})),function(t){t[t.None=0]="None",t[t.FadeIn=1]="FadeIn",t[t.FadeOut=2]="FadeOut",t[t.VolumeSwell=3]="VolumeSwell"}(ft||(ft={})),function(t){t[t.None=0]="None",t[t.Open=1]="Open",t[t.Closed=2]="Closed"}(pt||(pt={})),function(t){t[t.None=0]="None",t[t.Full=1]="Full",t[t.Half=2]="Half"}(bt||(bt={})),function(t){t[t.None=0]="None",t[t.Ii=1]="Ii",t[t.Mi=2]="Mi",t[t.MiiTriplet=3]="MiiTriplet",t[t.MiiAnapaest=4]="MiiAnapaest",t[t.PmpTriplet=5]="PmpTriplet",t[t.PmpAnapaest=6]="PmpAnapaest",t[t.PeiTriplet=7]="PeiTriplet",t[t.PeiAnapaest=8]="PeiAnapaest",t[t.PaiTriplet=9]="PaiTriplet",t[t.PaiAnapaest=10]="PaiAnapaest",t[t.AmiTriplet=11]="AmiTriplet",t[t.AmiAnapaest=12]="AmiAnapaest",t[t.Ppp=13]="Ppp",t[t.Amii=14]="Amii",t[t.Amip=15]="Amip",t[t.Eami=16]="Eami",t[t.Eamii=17]="Eamii",t[t.Peami=18]="Peami"}(mt||(mt={})),function(t){t[t.Auto=0]="Auto",t[t.ForceSplitToNext=1]="ForceSplitToNext",t[t.ForceMergeWithNext=2]="ForceMergeWithNext",t[t.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"}(gt||(gt={})),function(t){t[t.Effects=0]="Effects",t[t.StandardNotationStem=1]="StandardNotationStem",t[t.StandardNotationFlags=2]="StandardNotationFlags",t[t.StandardNotationBeams=3]="StandardNotationBeams",t[t.StandardNotationTuplet=4]="StandardNotationTuplet",t[t.StandardNotationEffects=5]="StandardNotationEffects",t[t.StandardNotationRests=6]="StandardNotationRests",t[t.GuitarTabStem=7]="GuitarTabStem",t[t.GuitarTabFlags=8]="GuitarTabFlags",t[t.GuitarTabBeams=9]="GuitarTabBeams",t[t.GuitarTabTuplet=10]="GuitarTabTuplet",t[t.GuitarTabEffects=11]="GuitarTabEffects",t[t.GuitarTabRests=12]="GuitarTabRests",t[t.SlashStem=13]="SlashStem",t[t.SlashFlags=14]="SlashFlags",t[t.SlashBeams=15]="SlashBeams",t[t.SlashTuplet=16]="SlashTuplet",t[t.SlashRests=17]="SlashRests",t[t.SlashEffects=18]="SlashEffects",t[t.NumberedDuration=19]="NumberedDuration",t[t.NumberedEffects=20]="NumberedEffects",t[t.NumberedRests=21]="NumberedRests",t[t.NumberedTuplet=22]="NumberedTuplet"}(wt||(wt={}));class qt extends J{}class Yt{static Bt=0;static resetIds(){Yt.Bt=0}id=Yt.Bt++;index=0;previousBeat=null;nextBeat=null;get isLastOfVoice(){return this.index===this.voice.beats.length-1}voice;notes=[];noteStringLookup=new Map;noteValueLookup=new Map;isEmpty=!1;whammyStyle=r.Default;ottava=b.Regular;fermata=null;isLegatoOrigin=!1;get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}minNote=null;maxNote=null;maxStringNote=null;minStringNote=null;duration=c.Quarter;get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===c.Whole}isLetRing=!1;isPalmMute=!1;automations=[];dots=0;get fadeIn(){return this.fade===ft.FadeIn}set fadeIn(t){this.fade=t?ft.FadeIn:ft.None}fade=ft.None;lyrics=null;get hasRasgueado(){return this.rasgueado!==mt.None}pop=!1;slap=!1;tap=!1;text=null;slashed=!1;deadSlapped=!1;brushType=h.None;brushDuration=0;tupletDenominator=-1;tupletNumerator=-1;get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}tupletGroup=null;isContinuedWhammy=!1;whammyBarType=ut.None;whammyBarPoints=null;maxWhammyPoint=null;minWhammyPoint=null;get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==ut.None}vibrato=w.None;chordId=null;get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}graceType=l.None;graceGroup=null;graceIndex=-1;pickStroke=ht.None;get isTremolo(){return!!this.tremoloSpeed}tremoloSpeed=null;crescendo=o.None;displayStart=0;get displayEnd(){return this.displayStart+this.displayDuration}playbackStart=0;displayDuration=0;playbackDuration=0;overrideDisplayDuration;golpe=dt.None;get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}dynamics=i.F;invertBeamDirection=!1;preferredBeamDirection=null;isEffectSlurOrigin=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;beamingMode=gt.Auto;wahPedal=pt.None;barreFret=-1;barreShape=bt.None;get isBarre(){return this.barreShape!==bt.None&&this.barreFret>=0}rasgueado=mt.None;showTimer=!1;timer=null;style;addWhammyBarPoint(t){let e=this.whammyBarPoints;null===e&&(e=[],this.whammyBarPoints=e),e.push(t),(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t),(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t),this.whammyBarType===ut.None&&(this.whammyBarType=ut.Custom)}removeWhammyBarPoint(t){const e=this.whammyBarPoints;if(null===e||t<0||t>=e.length)return;e.splice(t,1);const s=e[t];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const t of e)(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const t of e)(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t)}}addNote(t){t.beat=this,t.index=this.notes.length,this.notes.push(t),t.isStringed&&this.noteStringLookup.set(t.string,t)}removeNote(t){const e=this.notes.indexOf(t);e>=0&&(this.notes.splice(e,1),t.isStringed&&this.noteStringLookup.delete(t.string))}getAutomation(t){for(let e=0,s=this.automations.length;e<s;e++){const s=this.automations[e];if(s.type===t)return s}return null}getNoteOnString(t){return this.noteStringLookup.has(t)?this.noteStringLookup.get(t):null}_t(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let t=R.toTicks(this.duration);return 2===this.dots?t=R.applyDot(t,!0):1===this.dots&&(t=R.applyDot(t,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(t=R.applyTuplet(t,this.tupletNumerator,this.tupletDenominator)),t}updateDurations(){const t=this._t();switch(this.playbackDuration=t,this.graceType){case l.BeforeBeat:case l.OnBeat:switch(this.duration){case c.Sixteenth:this.playbackDuration=R.toTicks(c.SixtyFourth);break;case c.ThirtySecond:this.playbackDuration=R.toTicks(c.OneHundredTwentyEighth);break;default:this.playbackDuration=R.toTicks(c.ThirtySecond)}this.displayDuration=0;break;case l.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=t;const e=this.previousBeat;e&&e.graceType===l.BendGrace&&(this.playbackDuration=e.playbackDuration)}}finishTuplet(){const t=this.previousBeat;let e=t?t.tupletGroup:null;(this.hasTuplet||this.graceType!==l.None&&e)&&(t&&e&&e.check(this)||(e=new Jt(this.voice),e.check(this)),this.tupletGroup=e);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const t of this.automations)0===t.ratioPosition&&(t.ratioPosition=this.playbackStart/s),t.type!==n.Tempo&&i.push(t);this.automations=i}finish(t,e=null){switch(null===this.getAutomation(n.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(G.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case l.OnBeat:case l.BeforeBeat:const t=this.graceGroup.beats.length;this.duration=1===t?c.Eighth:2===t?c.Sixteenth:c.ThirtySecond}this.brushType===h.None&&(this.brushDuration=0);const s=t?t.notation.notationMode:S.GuitarPro;let i="grad"===this.text||"grad."===this.text;i&&s===S.SongBook&&(this.text="");let o=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let u=0,d=!1;for(let n=0,h=this.notes.length;n<h;n++){const h=this.notes[n];if(h.dynamics=this.dynamics,h.finish(t,e),h.isLetRing&&(this.isLetRing=!0),h.isPalmMute&&(this.isPalmMute=!0),s===S.SongBook&&h.hasBend&&this.graceType!==l.BendGrace){if(!h.isTieOrigin)switch(h.bendType){case a.Bend:case a.PrebendRelease:case a.PrebendBend:o=!0}i||h.bendStyle===r.Gradual?(i=!0,h.bendStyle=r.Gradual,o=!1):h.bendStyle=r.Fast}h.isVisible&&(u++,(!this.minNote||h.realValue<this.minNote.realValue)&&(this.minNote=h),(!this.maxNote||h.realValue>this.maxNote.realValue)&&(this.maxNote=h),(!this.minStringNote||h.string<this.minStringNote.string)&&(this.minStringNote=h),(!this.maxStringNote||h.string>this.maxStringNote.string)&&(this.maxStringNote=h),h.hasEffectSlur&&(d=!0))}if(d&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===u&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&t&&t.notation.notationMode===S.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let t=this.previousBeat;for(;t&&t.isRest;)this.isLetRing||(t.isLetRing=!1),this.isPalmMute||(t.isPalmMute=!1),t=t.previousBeat}const f=this.whammyBarPoints,p=null!==f&&f.length>0;if(p){const t=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=t}else this.whammyBarType=ut.None;if(p&&this.whammyBarType===ut.Custom)if(s===S.SongBook&&(this.whammyStyle=i?r.Gradual:r.Fast),4===f.length){const t=f[0],e=f[1],i=f[2],n=f[3];e.value===i.value&&(t.value<e.value&&e.value<n.value||t.value>e.value&&e.value>n.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=ut.Dive:this.whammyBarType=ut.PrediveDive,f.splice(2,1),f.splice(1,1)):t.value>e.value&&e.value<n.value||t.value<e.value&&e.value>n.value?(this.whammyBarType=ut.Dip,e.offset!==i.offset&&s!==S.SongBook||f.splice(2,1)):t.value===e.value&&e.value===n.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=ut.Hold:this.whammyBarType=ut.Predive,f.splice(2,1),f.splice(1,1)))}else if(2===f.length){const t=f[0],e=f[1];t.value<e.value||t.value>e.value?0===t.value||this.isContinuedWhammy?this.whammyBarType=ut.Dive:this.whammyBarType=ut.PrediveDive:t.value===e.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=ut.Hold:this.whammyBarType=ut.Predive)}if(this.updateDurations(),o){const t=ee.clone(this);t.id=Yt.Bt++,t.pickStroke=ht.None;for(let e=0,s=t.notes.length;e<s;e++){const s=t.notes[e],i=this.notes[e];if(s.bendType=a.None,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=r.Default,s.id=Xt.globalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){const t=Xt.findTieOrigin(i);if(t&&t.hasBend){s.bendType=a.Hold;const t=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new $(0,t.value)),s.addBendPoint(new $($.MaxPosition,t.value))}}s.isTieDestination=!0}this.graceType=l.BendGrace,this.graceGroup=new Q,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,t),t.graceGroup=new Q,t.graceGroup.addBeat(this),t.graceGroup.isComplete=!0,t.graceGroup.finish()}}isBefore(t){return this.voice.bar.index<t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index<t.index}isAfter(t){return this.voice.bar.index>t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index>t.index}hasNoteOnString(t){return this.noteStringLookup.has(t)}getNoteWithRealValue(t){return this.noteValueLookup.has(t)?this.noteValueLookup.get(t):null}chain(t=null){for(const e of this.notes)this.noteValueLookup.set(e.realValue,e),e.chain(t)}}class Kt{static clone(t){const e=new $;return e.offset=t.offset,e.value=t.value,e}}class Qt{static clone(t){const e=new Xt;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(Kt.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class Zt{static clone(t){const e=new I;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class te{static clone(t){const e=new G;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?Zt.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e.isVisible=t.isVisible,e}}class ee{static clone(t){const e=new Yt;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(Qt.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(te.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(Kt.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloSpeed=t.tremoloSpeed,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}class se{static xt(t){const e=new Map;for(const[s,i]of t)e.has(i)||e.set(i,s);return e}static whammyType=new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]]);static whammyTypeReversed=se.xt(se.whammyType);static bendStyle=new Map([["default",0],["gradual",1],["fast",2]]);static bendStyleReversed=se.xt(se.bendStyle);static graceType=new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]]);static graceTypeReversed=se.xt(se.graceType);static fermataType=new Map([["short",0],["medium",1],["long",2]]);static fermataTypeReversed=se.xt(se.fermataType);static alphaTexAccidentalMode=new Map([["auto",0],["explicit",1]]);static alphaTexAccidentalModeReversed=se.xt(se.alphaTexAccidentalMode);static noteAccidentalMode=new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]]);static noteAccidentalModeReversed=se.xt(se.noteAccidentalMode);static barreShape=new Map([["full",1],["half",2]]);static barreShapeReversed=se.xt(se.barreShape);static ottavia=new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]]);static ottaviaReversed=se.xt(se.ottavia);static rasgueado=new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]]);static rasgueadoReversed=se.xt(se.rasgueado);static dynamicValue=new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]]);static dynamicValueReversed=se.xt(se.dynamicValue);static bracketExtendMode=new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]]);static bracketExtendModeReversed=se.xt(se.bracketExtendMode);static trackNamePolicy=new Map([["hidden",0],["firstsystem",1],["allsystems",2]]);static trackNamePolicyReversed=se.xt(se.trackNamePolicy);static trackNameOrientation=new Map([["horizontal",0],["vertical",1]]);static trackNameOrientationReversed=se.xt(se.trackNameOrientation);static trackNameMode=new Map([["fullname",0],["shortname",1]]);static trackNameModeReversed=se.xt(se.trackNameMode);static textAlign=new Map([["left",0],["center",1],["right",2]]);static textAlignReversed=se.xt(se.textAlign);static bendType=new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]]);static bendTypeReversed=se.xt(se.bendType);static keySignature=new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]]);static keySignatureReversed=se.xt(se.keySignature);static keySignatureType=new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]]);static keySignatureTypeReversed=se.xt(se.keySignatureType);static clef=new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]]);static clefReversed=se.xt(se.clef);static tripletFeel=new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]);static tripletFeelReversed=se.xt(se.tripletFeel);static barLineStyle=new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]]);static barLineStyleReversed=se.xt(se.barLineStyle);static simileMark=new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]]);static simileMarkReversed=se.xt(se.simileMark);static direction=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]);static directionReversed=se.xt(se.direction);static keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]);static keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]])}class ie{static Tt(t){return t?{expectedTypes:new Set(t[0]),parseMode:t[1],allowedValues:t.length>2&&t[2]&&t[2].length>0?new Set(t[2]):void 0,reservedIdentifiers:t.length>3&&t[3]&&t[3].length>0?new Set(t[3]):void 0}:null}static Mt(t){return null==t?null:t.map(t=>({isStrict:t.length>0&&null===t[0],parameters:t.map(ie.Tt).filter(t=>null!==t)}))}static vt(t){return new Map(t.map(t=>[t[0],null===t[1]?null:new Map(t[1].map(t=>[t[0],ie.Mt(t[1])]))]))}static Nt(t){return new Map(t.map(t=>[t[0],ie.Mt(t[1])]))}static Pt(t){return new Map(t.map(t=>[t[0],ie.Mt(t[1])]))}static scoreMetaDataSignatures=ie.Pt([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]]]);static staffMetaDataSignatures=ie.Pt([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]]);static structuralMetaDataSignatures=ie.Pt([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]]);static barMetaDataSignatures=ie.Pt([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null]]);static metaDataProperties=ie.vt([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null]]);static metaDataSignatures=[ie.scoreMetaDataSignatures,ie.staffMetaDataSignatures,ie.structuralMetaDataSignatures,ie.barMetaDataSignatures];static durationChangeProperties=ie.Nt([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]]);static beatProperties=ie.Nt([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0,["8","16","32"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]]);static noteProperties=ie.Nt([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]])}!function(t){t[t.Dot=0]="Dot",t[t.Backslash=1]="Backslash",t[t.DoubleBackslash=2]="DoubleBackslash",t[t.Pipe=3]="Pipe",t[t.LBrace=4]="LBrace",t[t.RBrace=5]="RBrace",t[t.LParen=6]="LParen",t[t.RParen=7]="RParen",t[t.Colon=8]="Colon",t[t.Asterisk=9]="Asterisk",t[t.Ident=10]="Ident",t[t.Tag=11]="Tag",t[t.Meta=12]="Meta",t[t.Arguments=13]="Arguments",t[t.Props=14]="Props",t[t.Prop=15]="Prop",t[t.Number=16]="Number",t[t.String=17]="String",t[t.Score=18]="Score",t[t.Bar=19]="Bar",t[t.Beat=20]="Beat",t[t.Duration=21]="Duration",t[t.NoteList=22]="NoteList",t[t.Note=23]="Note"}(yt||(yt={})),function(t){t[t.Hint=0]="Hint",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(kt||(kt={})),function(t){t[t.AT001=1]="AT001",t[t.AT002=2]="AT002",t[t.AT003=3]="AT003",t[t.AT004=4]="AT004",t[t.AT005=5]="AT005",t[t.AT006=6]="AT006",t[t.AT200=200]="AT200",t[t.AT201=201]="AT201",t[t.AT202=202]="AT202",t[t.AT203=203]="AT203",t[t.AT204=204]="AT204",t[t.AT205=205]="AT205",t[t.AT206=206]="AT206",t[t.AT207=207]="AT207",t[t.AT208=208]="AT208",t[t.AT209=209]="AT209",t[t.AT210=210]="AT210",t[t.AT211=211]="AT211",t[t.AT212=212]="AT212",t[t.AT213=213]="AT213",t[t.AT214=214]="AT214",t[t.AT215=215]="AT215",t[t.AT216=216]="AT216",t[t.AT217=217]="AT217",t[t.AT218=218]="AT218",t[t.AT219=219]="AT219",t[t.AT220=220]="AT220",t[t.AT300=300]="AT300",t[t.AT301=301]="AT301",t[t.AT302=302]="AT302",t[t.AT303=303]="AT303",t[t.AT304=304]="AT304",t[t.AT305=305]="AT305",t[t.AT306=306]="AT306",t[t.AT400=400]="AT400"}(St||(St={}));class ne{Et=!1;items=[];get errors(){return this.items.filter(t=>t.severity===kt.Error)}get hasErrors(){return this.Et}push(t){this.items.push(t),t.severity===kt.Error&&(this.Et=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}!function(t){t[t.Auto=0]="Auto",t[t.Explicit=1]="Explicit"}(Bt||(Bt={})),function(t){t[t.Pitched=0]="Pitched",t[t.Fretted=1]="Fretted",t[t.Articulation=2]="Articulation"}(_t||(_t={})),function(t){t[t.Required=0]="Required",t[t.Optional=1]="Optional",t[t.RequiredAsFloat=2]="RequiredAsFloat",t[t.OptionalAsFloat=3]="OptionalAsFloat",t[t.RequiredAsValueList=4]="RequiredAsValueList",t[t.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"}(xt||(xt={}));class re{static Ft=new ArrayBuffer(8);static Ct=new Uint8Array(re.Ft);static At=new DataView(re.Ft);static float64ToBytes(t){return re.At.setFloat64(0,t,!0),re.Ct}static bytesToInt64LE(t){re.Ct.set(t,0);const e=re.At.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return re.Ct.set(t,0),re.At.getFloat64(0,!0)}static bytesToFloat32LE(t){return re.Ct.set(t,0),re.At.getFloat32(0,!0)}static float32BEToBytes(t){return re.At.setFloat32(0,t,!1),re.Ct.slice(0,4)}static uint16ToInt16(t){return re.At.setUint16(0,t,!0),re.At.getInt16(0,!0)}static int16ToUint32(t){return re.At.setInt16(0,t,!0),re.At.getUint32(0,!0)}static int32ToUint16(t){return re.At.setInt32(0,t,!0),re.At.getUint16(0,!0)}static int32ToInt16(t){return re.At.setInt32(0,t,!0),re.At.getInt16(0,!0)}static int32ToUint32(t){return re.At.setInt32(0,t,!0),re.At.getUint32(0,!0)}static uint8ToInt8(t){return re.At.setUint8(0,t),re.At.getInt8(0)}}class ae{static readInt32BE(t){return t.readByte()<<24|t.readByte()<<16|t.readByte()<<8|t.readByte()}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),re.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),re.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),re.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){const s=t[e],i=t[e+1],n=t[e+2];return t[e+3]<<24|n<<16|i<<8|s}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return re.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return re.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),n=t.readByte();return re.int32ToUint32(e<<24|s<<16|i<<8|n)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return re.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return re.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),ae.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;0!==s;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let n=0;n<e;n++){const e=t.readByte();0===e&&-1===i&&(i=n),s+=String.fromCharCode(e)}const n=s;return i>=0?n.substr(0,i):n}static readSInt8(t){const e=t.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return 8388608&~s||(s|=255<<24),s}static readInt16(t,e){return re.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=ae.Dt(t);s&&(e=s),e||(e="utf-8");return new TextDecoder(e).decode(t.buffer)}static Dt(t){return t.length>2&&254===t[0]&&255===t[1]?"utf-16be":t.length>2&&255===t[0]&&254===t[1]?"utf-16le":t.length>4&&0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]?"utf-32be":t.length>4&&255===t[0]&&254===t[1]&&0===t[2]&&0===t[3]?"utf-32le":null}static stringToBytes(t){return(new TextEncoder).encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(255&e)}static writeInt32LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(255&e)}static writeFloat32BE(t,e){const s=re.float32BEToBytes(e);t.write(s,0,s.length)}static*iterateCodepoints(t){let e=0;for(;e<t.length;){let s=t.charCodeAt(e);ae.isLeadingSurrogate(s)&&e+1<t.length&&(e++,s=1024*(s-55296)+(t.charCodeAt(e)-56320)+65536),e++,yield s}}static isLeadingSurrogate(t){return t>=55296&&t<=56319}static isTrailingSurrogate(t){return t>=56320&&t<=57343}}class he{static Lt=0;Wt;Ot=he.Lt;Rt=0;It=1;Gt=1;fatalError=!1;$t={line:0,col:0,offset:0};Vt;Ht;Ut;zt;lexerDiagnostics=new ne;constructor(t){this.Wt=[...ae.iterateCodepoints(t)],this.Rt=0,this.It=1,this.Gt=1,this.Ot=this.Wt.length>0?this.Wt[0]:he.Lt}peekToken(){if(this.fatalError)return;let t=this.zt;return t||(t=this.jt(),this.zt=t,t)}extendToFloat(t){if(46!==this.Ot||this.Rt+1>=this.Wt.length||!he.Xt(this.Wt[this.Rt+1]))return t;let e=this.Rt+2;for(;e<this.Wt.length&&he.Xt(this.Wt[e]);)e++;if(e<this.Wt.length&&he.Jt(this.Wt[e]))return t;const s=e-this.Rt-1;return this.Rt+=s,this.Gt+=s,this.qt(),t.end=this.Yt(),t.value=Number.parseFloat(String.fromCodePoint(...this.Wt.slice(t.start.offset,t.end.offset))),t}advance(){this.Ut=this.zt,this.zt=void 0}qt(){const t=this.Wt;let e=this.Rt;if(e<t.length-1){10===t[e]?(this.Ht=void 0,++this.It,this.Gt=1):++this.Gt,++e;const s=t[e];return this.Ot=s,this.Rt=e,s}return this.Ot!==he.Lt&&(this.Ot=he.Lt,++this.Gt,this.Rt=t.length),he.Lt}previousTokenEndLocation(){return this.Ut?.end??this.Yt()}currentTokenLocation(){return this.zt?.start??this.Yt()}Yt(){return{line:this.It,col:this.Gt,offset:this.Rt}}jt(){for(this.Vt=void 0;this.Ot!==he.Lt&&!this.fatalError;)if(this.$t=this.Yt(),he.Kt.has(this.Ot)){const t=he.Kt.get(this.Ot)(this);if(t)return this.Ht=t,t}else{if(he.Jt(this.Ot)){const t=this.Qt();return this.Ht=t,t}this.Ot=this.qt()}}Zt(){this.Ot=this.qt(),47===this.Ot?this.te():42===this.Ot?this.ee():(this.lexerDiagnostics.push({code:St.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this.Ot)}'`,severity:kt.Error,start:this.$t,end:this.Yt()}),this.fatalError=!0)}static Kt=new Map([[47,t=>t.Zt()],[34,t=>t.se()],[39,t=>t.se()],[45,t=>t.Qt()],[46,t=>t.ie({nodeType:yt.Dot})],[58,t=>t.ie({nodeType:yt.Colon})],[40,t=>t.ie({nodeType:yt.LParen})],[41,t=>t.ie({nodeType:yt.RParen})],[123,t=>t.ie({nodeType:yt.LBrace})],[125,t=>t.ie({nodeType:yt.RBrace})],[124,t=>t.ie({nodeType:yt.Pipe})],[42,t=>t.ie({nodeType:yt.Asterisk})],[92,t=>t.ne()],[9,t=>t.re()],[10,t=>t.re()],[11,t=>t.re()],[13,t=>t.re()],[32,t=>t.re()]]);ne(){const t=this.Yt();let e,s;this.Ot=this.qt(),92===this.Ot?(this.Ot=this.qt(),s=this.Yt(),e={nodeType:yt.DoubleBackslash,start:t,end:s}):(s=this.Yt(),e={nodeType:yt.Backslash,start:t,end:s});let i="";for(;he.Jt(this.Ot);)i+=String.fromCodePoint(this.Ot),this.Ot=this.qt();if(0===i.length)return void this.lexerDiagnostics.push({code:St.AT002,message:"Missing identifier after meta data start",severity:kt.Error,start:this.$t,end:this.Yt()});return{nodeType:yt.Tag,leadingComments:this.Vt,start:this.$t,end:this.Yt(),prefix:e,tag:{nodeType:yt.Ident,text:i,start:s,end:this.Yt()}}}ie(t){return t.leadingComments=this.Vt,t.start=this.$t,this.Ot=this.qt(),t.end=this.Yt(),t}se(){const t=this.Ot;this.Ot=this.qt();let e="",s=-1;for(;this.Ot!==t&&this.Ot!==he.Lt;){let i=-1;if(92===this.Ot)if(this.Ot=this.qt(),92===this.Ot)i=92;else if(this.Ot===t)i=t;else if(82===this.Ot||114===this.Ot)i=13;else if(78===this.Ot||110===this.Ot)i=10;else if(84===this.Ot||116===this.Ot)i=9;else{if(117!==this.Ot)return this.lexerDiagnostics.push({code:St.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this.Ot)}'.`,severity:kt.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);{let t="";for(let e=0;e<4;e++){if(this.Ot=this.qt(),this.Ot===he.Lt)return this.lexerDiagnostics.push({code:St.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:kt.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);t+=String.fromCodePoint(this.Ot)}if(i=Number.parseInt(t,16),Number.isNaN(i))return this.lexerDiagnostics.push({code:St.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:kt.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0)}}else i=this.Ot;ae.isLeadingSurrogate(s)&&ae.isTrailingSurrogate(i)?(i=1024*(s-55296)+(i-56320)+65536,e+=String.fromCodePoint(i)):ae.isLeadingSurrogate(i)||(ae.isLeadingSurrogate(s)&&(e+=String.fromCodePoint(s)),i>0&&(e+=String.fromCodePoint(i))),s=i,this.Ot=this.qt()}if(this.Ot===he.Lt)return this.lexerDiagnostics.push({code:St.AT006,message:"Unexpected end of file. String not closed.",severity:kt.Error,start:this.$t,end:this.Yt()}),void(this.fatalError=!0);const i={nodeType:yt.String,text:e,leadingComments:this.Vt,start:this.$t,end:this.Yt()};return this.Ot=this.qt(),i}ee(){const t=this.Ht,e={start:this.$t,end:this.Yt(),text:"",multiLine:!0};for(;this.Ot!==he.Lt;)if(42===this.Ot){if(this.Ot=this.qt(),47===this.Ot){this.Ot=this.qt();break}e.text+=`*${String.fromCodePoint(this.Ot)}`,e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Rt}else this.Ot=this.qt(),e.text+=String.fromCodePoint(this.Ot),e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Rt;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Vt??=[],this.Vt.push(e))}Qt(){let t="",e=!0,s=this.Ot;45===s&&(t+=String.fromCodePoint(s),s=this.qt(),he.Xt(s)||(e=!1));let i=!0;do{e?he.Xt(s)?(t+=String.fromCodePoint(s),s=this.qt(),i=!0):he.Jt(s)?(e=!1,t+=String.fromCodePoint(s),s=this.qt(),i=!0):i=!1:he.Jt(s)?(t+=String.fromCodePoint(s),s=this.qt(),i=!0):i=!1}while(i);if(e){return{nodeType:yt.Number,leadingComments:this.Vt,start:this.$t,end:this.Yt(),value:Number.parseInt(t,10)}}return{nodeType:yt.Ident,leadingComments:this.Vt,start:this.$t,end:this.Yt(),text:t}}te(){const t=this.Ht,e={start:this.$t,end:this.Yt(),text:"",multiLine:!1};let s=this.Ot;for(;s!==he.Lt&&(s=this.qt(),10!==s&&s!==he.Lt);)e.text+=String.fromCodePoint(s),e.end.line=this.It,e.end.col=this.Gt,e.end.offset=this.Rt;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Vt??=[],this.Vt.push(e))}re(){let t=this.Ot;for(;he.ae(t);)10===t&&(this.Ht=void 0),t=this.qt()}static Xt(t){return t>=48&&t<=57}static he(){const t=new Set;for(const e of he.Kt.keys())t.add(e);return t.delete(45),t.add(he.Lt),t}static oe=he.he();static Jt(t){return!he.oe.has(t)}static ae(t){return 32===t||10===t||13===t||9===t||11===t}}!function(t){t[t.ForModelImport=0]="ForModelImport",t[t.Full=1]="Full"}(Tt||(Tt={}));class oe{lexer;ce;le=le.instance;mode=Tt.ForModelImport;get lexerDiagnostics(){return this.lexer.lexerDiagnostics}parserDiagnostics=new ne;addParserDiagnostic(t){this.parserDiagnostics.push(t)}unexpectedToken(t,e,s){t?this.addParserDiagnostic({code:St.AT202,message:`Unexpected '${yt[t.nodeType]}' token. Expected one of following: ${e.map(t=>yt[t]).join(",")}`,severity:kt.Error,start:t.start,end:t.end}):this.addParserDiagnostic({code:St.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:kt.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}constructor(t){this.lexer=new he(t)}read(){return this.ue(),this.ce}ue(){this.ce={nodeType:yt.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this.de()}finally{this.ce.end=this.lexer.previousTokenEndLocation()}}de(){let t=this.lexer.peekToken();for(;t;)this.fe(),t=this.lexer.peekToken()}fe(){const t={nodeType:yt.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this.ce.bars.push(t);try{this.pe(t),this.be(t);const e=this.lexer.peekToken();e?.nodeType===yt.Pipe&&(t.pipe=e,this.lexer.advance()),(t.metaData.length>0||t.beats.length>0||t.pipe)&&(t.end=this.lexer.previousTokenEndLocation())}finally{t.end=this.lexer.previousTokenEndLocation()}}pe(t){let e=this.lexer.peekToken();for(;e&&(e.nodeType===yt.Tag||e.nodeType===yt.Dot);)e.nodeType===yt.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:St.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:kt.Hint,start:e.start,end:e.end})):this.me(t.metaData),e=this.lexer.peekToken()}be(t){let e=this.lexer.peekToken();for(;e&&e.nodeType!==yt.Pipe&&e.nodeType!==yt.Dot&&e.nodeType!==yt.Tag;){const s=this.ge();s&&t.beats.push(s),e=this.lexer.peekToken()}}ge(){const t={nodeType:yt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(this.we(t),this.ye(t),!t.notes&&!t.rest)return t;this.ke(t),this.Se(t),t.beatEffects=this.Be(t=>this.le.readBeatPropertyArguments(this,t)),void 0!==t.beatMultiplierValue&&t.beatEffects?.openBrace&&this.addParserDiagnostic({code:St.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:kt.Warning,start:t.beatMultiplier.start,end:t.beatMultiplierValue.end}),this.Se(t)}finally{t.end=this.lexer.previousTokenEndLocation()}return t}ke(t){const e=this.lexer.peekToken();if(e?.nodeType!==yt.Dot)return;t.durationDot=e,this.lexer.advance();const s=this.lexer.peekToken();if(s?.nodeType===yt.Number)return t.durationValue=s,void this.lexer.advance();s?.nodeType!==yt.Tag?s&&this.unexpectedToken(s,[yt.Number],!0):t.durationDot=void 0}we(t){const e=this.lexer.peekToken();if(e?.nodeType!==yt.Colon)return;this.lexer.advance();const s={nodeType:yt.Duration,colon:e,value:void 0,properties:void 0,start:e.start};t.durationChange=s;try{const t=this.lexer.peekToken();if(!t||t.nodeType!==yt.Number)return void this.addParserDiagnostic({code:St.AT201,message:"Missing duration value after ':'.",severity:kt.Error,start:e.start,end:e.end});this.lexer.advance(),s.value=t,s.properties=this.Be(t=>this.le.readDurationChangePropertyArguments(this,t))}finally{s.end=this.lexer.previousTokenEndLocation()}}ye(t){const e=this.lexer.peekToken();if(e)if(e.nodeType===yt.Ident&&"r"===e.text)t.rest=e,this.lexer.advance();else if(e.nodeType===yt.LParen)t.notes=this._e(e);else{const s=this.xe(e);s&&(t.notes={nodeType:yt.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}Se(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==yt.Asterisk)return;this.lexer.advance(),t.beatMultiplier=e;const s=this.lexer.peekToken();s&&s.nodeType===yt.Number?(t.beatMultiplierValue=s,this.lexer.advance()):this.addParserDiagnostic({code:St.AT200,message:"Missing beat multiplier value after '*'.",severity:kt.Error,start:t.beatMultiplier.start,end:t.beatMultiplier.end})}_e(t){const e={nodeType:yt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{e.openParenthesis=t,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==yt.RParen;){const t=this.xe(s);if(!t)break;e.notes.push(t),s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===yt.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:St.AT206,message:"Unexpected end of file. Group not closed.",severity:kt.Error,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}xe(t){const e={nodeType:yt.Note,noteValue:{nodeType:yt.Ident,text:""},start:t.start};try{let s=!1;switch(t.nodeType){case yt.Number:e.noteValue=t,this.lexer.advance(),s=!0;break;case yt.String:case yt.Ident:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0}break;default:return void this.unexpectedToken(t,[yt.Number,yt.String,yt.Ident],!0)}if(s){const t=this.lexer.peekToken();if(t?.nodeType===yt.Dot){const s=t;this.lexer.advance();const i=this.lexer.peekToken();if(!i)return void this.unexpectedToken(i,[yt.Number],!0);if(i.nodeType===yt.Tag)return e;if(i.nodeType!==yt.Number)return void this.unexpectedToken(i,[yt.Number],!0);e.noteStringDot=s,e.noteString=i,this.lexer.advance()}}e.noteEffects=this.Be(t=>this.le.readNotePropertyArguments(this,t))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}me(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==yt.Tag)return;const s={nodeType:yt.Meta,tag:e,start:e.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),t.push(s);try{const t=this.lexer.peekToken();t?.nodeType===yt.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this.Be(t=>this.le.readMetaDataPropertyArguments(this,s.tag,t)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this.le.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:St.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:kt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}),this.addParserDiagnostic({code:St.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:kt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})))):(s.arguments=this.argumentList(),s.arguments||(s.arguments=this.le.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:St.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:kt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})),s.properties=this.Be(t=>this.le.readMetaDataPropertyArguments(this,s.tag,t)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Be(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==yt.LBrace)return;const s={nodeType:yt.Props,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e?.nodeType===yt.Ident;)s.properties.push(this.Te(e,t)),e=this.lexer.peekToken();const i=this.lexer.peekToken();i?.nodeType===yt.RBrace?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:St.AT206,message:"Unexpected end of file. Group not closed.",severity:kt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Te(t,e){const s={nodeType:yt.Prop,property:t,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=e(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:St.AT303,message:"Property args should be wrapped into parenthesis.",severity:kt.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const t=this.lexer.peekToken();if(t?.nodeType!==yt.LParen)return;const e={nodeType:yt.Arguments,openParenthesis:t,arguments:[],closeParenthesis:void 0,start:t.start};this.lexer.advance();try{let t=this.lexer.peekToken();for(;t&&t?.nodeType!==yt.RParen;){switch(t.nodeType){case yt.Ident:case yt.String:e.arguments.push(t),this.lexer.advance();break;case yt.Number:e.arguments.push(this.lexer.extendToFloat(t)),this.lexer.advance();break;default:this.unexpectedToken(t,[yt.Ident,yt.String,yt.Number],!1),this.lexer.advance()}t=this.lexer.peekToken()}const s=this.lexer.peekToken();s?.nodeType===yt.RParen?(e.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:St.AT206,message:"Unexpected end of file. Group not closed.",severity:kt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}}class ce{static ident(t){return{nodeType:yt.Ident,text:t}}static string(t){return{nodeType:yt.String,text:t}}static number(t){return{nodeType:yt.Number,value:t}}static meta(t,e,s){return{nodeType:yt.Meta,tag:{nodeType:yt.Tag,prefix:{nodeType:yt.Backslash},tag:{nodeType:yt.Ident,text:t}},arguments:e,properties:s,propertiesBeforeArguments:!1}}static identMeta(t,e){return ce.meta(t,ce.identValue(e))}static numberMeta(t,e){return ce.meta(t,ce.numberValue(e))}static args(t,e=void 0){const s={nodeType:yt.Arguments,arguments:t.filter(t=>void 0!==t)};if((void 0===e?s.arguments.length>1:e)&&(s.openParenthesis={nodeType:yt.LParen},s.closeParenthesis={nodeType:yt.RParen}),0!==s.arguments.length)return s}static stringValue(t){return ce.args([ce.string(t)])}static identValue(t){return ce.args([ce.ident(t)])}static numberValue(t){return ce.args([ce.number(t)])}static props(t){const e={nodeType:yt.Props,properties:[],openBrace:{nodeType:yt.LBrace},closeBrace:{nodeType:yt.RBrace}};for(const s of t)s&&e.properties.push({nodeType:yt.Prop,property:ce.ident(s[0]),arguments:s[1]});return e}static prop(t,e,s){t.push({nodeType:yt.Prop,property:ce.ident(e),arguments:s})}}class le{static instance=new le;static Me=new Set([yt.LParen,yt.String,yt.Ident,yt.Number]);readMetaDataArguments(t,e){const s=e.tag.text.toLowerCase();for(const e of ie.metaDataSignatures)if(e.has(s)){const i=e.get(s);return i?this.ve(t,i):void 0}t.addParserDiagnostic({code:St.AT204,message:`Unrecognized metadata '${e.tag.text}'.`,severity:kt.Error,start:e.start,end:e.end}),t.lexer.fatalError=!0}readMetaDataPropertyArguments(t,e,s){const i=e.tag.text.toLowerCase();if(!ie.metaDataProperties.has(i))return;const n=ie.metaDataProperties.get(i);return this.Ne(t,[n],s)}readBeatPropertyArguments(t,e){return this.Ne(t,[ie.beatProperties],e)}readDurationChangePropertyArguments(t,e){return this.Ne(t,[ie.durationChangeProperties],e)}readNotePropertyArguments(t,e){return this.Ne(t,[ie.noteProperties,ie.beatProperties],e)}Ne(t,e,s){const i=s.property.text.toLowerCase(),n=new Set([yt.Ident,yt.RBrace]);for(const s of e)if(s.has(i)){const e=s.get(i);return e?this.ve(t,e,n):void this.Pe(t,[],n)}let r=t.lexer.peekToken();for(;r&&r.nodeType!==yt.Ident&&r.nodeType!==yt.RBrace;)t.lexer.advance(),r=t.lexer.peekToken();t.addParserDiagnostic({code:St.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:kt.Error,start:s.property.start,end:r?.start??t.lexer.currentTokenLocation()})}ve(t,e,s){if(1===e.length&&0===e[0].parameters.length)return;const i=[],n=t.lexer.peekToken()?.start,r=void 0!==s,a=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),h=this.Ee(t,a,i,s),o=this.Fe(t,a,i,s,e,n);return r&&this.Pe(t,e,s),this.Ce(i,n,t.lexer.previousTokenEndLocation(),o,h)}Fe(t,e,s,i,n,r){const a=t.lexer.peekToken();let h=!1;return 1!==e.size&&void 0===a?(t.addParserDiagnostic({code:St.AT203,start:t.lexer.currentTokenLocation(),end:t.lexer.currentTokenLocation(),severity:kt.Error,message:"Unexpected end of file."}),h=!0):0===e.size&&(void 0!==a&&0===s.length&&i&&!i.has(a.nodeType)&&(s.push(t.lexer.peekToken()),t.lexer.advance()),t.addParserDiagnostic({code:St.AT219,message:`Error parsing arguments: no overload matched arguments ${le.generateSignaturesFromArguments(s)}. Signatures:\n${le.generateSignatures(n)}`,severity:kt.Error,start:r,end:t.lexer.previousTokenEndLocation()}),h=!0),h}Ce(t,e,s,i,n){if(0===t.length)return;const r=ce.args(t,!1);return r.start=e,r.end=s,r.validated=!i,n&&(n.length>1&&le.sortCandidates(n),r.signatureCandidateIndices=n.map(t=>t[0])),r}Ee(t,e,s,i){const n=t.mode===Tt.Full,r=(i,r)=>{const a=e.get(r);if(i.nodeType===yt.LParen){const e=t.argumentList();if(e)for(const t of e.arguments)n&&(t.parameterIndices||(t.parameterIndices=new Map),t.parameterIndices.set(r,a.parameterIndex)),s.push(t)}else{const e=i;n&&(e.parameterIndices||(e.parameterIndices=new Map),e.parameterIndices.set(r,a.parameterIndex)),0!==s.length&&s[s.length-1]===e||(s.push(e),t.lexer.advance())}},a=e=>{t.lexer.extendToFloat(e)},h=le.Me;for(;e.size>1||e.size>0&&!le.Ae(e);){const s=t.lexer.peekToken();if(!s||!h.has(s.nodeType))break;if(!le.filterSignatureCandidates(e,s,void 0!==i&&i.has(s.nodeType),r,a))break}const o=t.mode===Tt.Full?Array.from(e.entries()):void 0;return le.filterIncompleteCandidates(e),o}static sortCandidates(t){t.length<2||t.sort((t,e)=>{const s=Math.abs(t[1].parameterIndex-t[1].signature.parameters.length),i=Math.abs(e[1].parameterIndex-e[1].signature.parameters.length);if(s===i){const s=t[1].parameterValueMatches;return e[1].parameterValueMatches-s}return s-i})}Pe(t,e,s){const i=t.lexer.currentTokenLocation();let n=t.lexer.peekToken(),r=!1;const a=le.Me;for(;n&&!s.has(n.nodeType);)a.has(n.nodeType)?(t.lexer.advance(),r=!0,n=t.lexer.peekToken()):n=void 0;r&&t.addParserDiagnostic({code:St.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:\n${le.generateSignatures(e)}`,severity:kt.Error,start:i,end:t.lexer.previousTokenEndLocation()})}static Ae(t){for(const e of t.values())if(e.parameterIndex===e.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(t){const e=new Set;for(const[s,i]of t)for(let t=i.parameterIndex;t<i.signature.parameters.length;t++){switch(i.signature.parameters[t].parseMode){case xt.Required:case xt.RequiredAsFloat:e.add(s)}}for(const s of e)t.delete(s)}static generateSignaturesFromArguments(t){return t?`(${t.map(t=>yt[t.nodeType]).join(", ")})`:"()"}static generateSignatures(t,e){return 0===t.length?"()":t.map((t,s)=>le.De(t,void 0!==e&&e.size>1&&e.has(s))).join("\n")}static De(t,e){const s=e?" ~":"";return`(${t.parameters.map(le.Le).join(", ")})${s}`}static Le(t,e){const s=Array.from(t.expectedTypes);let i=`v${e}`;switch(t.parseMode){case xt.Optional:case xt.OptionalAsFloat:i+="?"}if(t.allowedValues&&t.allowedValues.size<5){const e=Array.from(t.allowedValues);if(s[0]===yt.String)i=e.map(t=>`"${t}"`).join("|");else i=e.join("|")}else i=Array.from(t.expectedTypes).map(t=>yt[t]).join("|");switch(t.parseMode){case xt.RequiredAsValueList:case xt.ValueListWithoutParenthesis:i+="[]"}return i}static filterSignatureCandidates(t,e,s,i,n){const r=new Set;let a=!1;for(const[h,o]of t){let t=!1;for(;!t;){const c=o.parameterIndex<o.signature.parameters.length?o.signature.parameters[o.parameterIndex]:void 0;if(c)if(o.signature.isStrict&&o.parameterIndex>0)r.add(h),t=!0;else if((c.expectedTypes.has(e.nodeType)||le.We(e,c))&&le.Oe(e,c,n))switch(t=!0,a=!0,i(e,h),c.allowedValues&&o.parameterValueMatches++,c.parseMode){case xt.ValueListWithoutParenthesis:o.parameterHasValues=!0;break;case xt.RequiredAsValueList:default:o.parameterIndex++,o.parameterHasValues=!1}else switch(c.parseMode){case xt.ValueListWithoutParenthesis:o.parameterIndex++,o.parameterHasValues=!1;break;case xt.Required:case xt.RequiredAsFloat:r.add(h),t=!0;break;case xt.Optional:case xt.OptionalAsFloat:case xt.RequiredAsValueList:o.parameterIndex++,o.parameterHasValues=!1}else s||r.add(h),t=!0}}if(a)for(const e of r)t.delete(e);return a}static Oe(t,e,s){switch(t.nodeType){case yt.Ident:const i=t;return e?.allowedValues?e.allowedValues.has(i.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(i.text.toLowerCase());case yt.String:const n=t;return!e?.allowedValues||e.allowedValues.has(n.text.toLowerCase());case yt.Number:switch(e?.parseMode??xt.Optional){case xt.RequiredAsFloat:case xt.OptionalAsFloat:return s?.(t),!0;default:return!0}case yt.LParen:return!0}return!1}static We(t,e){return t.nodeType===yt.LParen&&(e.expectedTypes.has(yt.Arguments)||e.parseMode===xt.ValueListWithoutParenthesis||e.parseMode===xt.RequiredAsValueList)}}!function(t){t[t.Applied=0]="Applied",t[t.NotAppliedSemanticError=1]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"}(Mt||(Mt={})),function(t){t[t.AppliedNewTrack=0]="AppliedNewTrack",t[t.AppliedNewStaff=1]="AppliedNewStaff",t[t.AppliedNewVoice=2]="AppliedNewVoice",t[t.NotAppliedSemanticError=3]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"}(vt||(vt={}));class ue{static Re=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);static getValue(t){return ue.Re||(ue.Re=new Map),t=t.toLowerCase().replaceAll(" ",""),ue.Re.has(t)?ue.Re.get(t):0}static getName(t){for(const[e,s]of ue.Re)if(s===t)return e;return t.toString()}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||105===t||43===t}static isBass(t){return t>=32&&t<=39}static bankToLsbMsb(t){return[127&t,t>>7&127]}}class de{name="";firstFret=1;strings=[];barreFrets=[];staff;showName=!0;showDiagram=!0;showFingering=!0;get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class fe extends W{constructor(t){super(s.Format,t)}}class pe{static BlackRgb="#000000";constructor(t,e,s,i=255){this.raw=(255&i)<<24|(255&t)<<16|(255&e)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${Vt.toHexString(this.r,2)}${Vt.toHexString(this.g,2)}${Vt.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}raw=0;get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}rgba;static random(t=100){return new pe(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,t)}static fromJson(t){if(t instanceof pe)return t;switch(typeof t){case"number":{const e=new pe(0,0,0,0);return e.raw=t,e.updateRgba(),e}case"string":{const e=t;if(e.startsWith("#")){if(4===e.length)return new pe(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16));if(5===e.length)return new pe(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16),17*Number.parseInt(e[4],16));if(7===e.length)return new pe(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(9===e.length)return new pe(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s)throw new fe("No values specified for rgb/rgba function");const i=e.substring(t+1,s).split(",");if(3===i.length)return new pe(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10));if(4===i.length)return new pe(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10),255*Number.parseFloat(i[3]))}return null}}throw new fe("Unsupported format for color")}static toJson(t){return null===t?null:t.raw}}!function(t){t[t.Short=0]="Short",t[t.Medium=1]="Medium",t[t.Long=2]="Long"}(Nt||(Nt={}));class be{type=Nt.Short;length=0}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.Text=2]="Text",t[t.Comment=3]="Comment",t[t.Dash=4]="Dash"}(Pt||(Pt={}));class me{static Ie=10;static Ge=9;static $e=13;static Ve=32;static He=93;static Ue=91;static ze=45;startBar=0;text="";chunks;finish(t=!1){this.chunks=[],this.je(this.text,0,this.chunks,t)}je(t,e,s,i){if(!t)return;let n=Pt.Begin,r=Pt.Begin,a=!1,h=0;for(;e<t.length;){const s=t.charCodeAt(e);switch(n){case Pt.IgnoreSpaces:switch(s){case me.Ie:case me.$e:case me.Ge:break;case me.Ve:if(!a){n=r;continue}break;default:a=!1,n=r;continue}break;case Pt.Begin:if(s!==me.Ue){h=e,n=Pt.Text;continue}n=Pt.Comment;break;case Pt.Comment:if(s===me.He)n=Pt.Begin;break;case Pt.Text:switch(s){case me.ze:n=Pt.Dash;break;case me.$e:case me.Ie:case me.Ve:const s=t.substr(h,e-h);this.Xe(s,i),n=Pt.IgnoreSpaces,r=Pt.Begin}break;case Pt.Dash:if(s!==me.ze){const s=t.substr(h,e-h);this.Xe(s,i),a=!0,n=Pt.IgnoreSpaces,r=Pt.Begin;continue}}e+=1}n===Pt.Text&&e!==h&&this.Xe(t.substr(h,e-h),i)}Xe(t,e){t=this.Je(t),(!e||t.length>0&&"-"!==t)&&this.chunks.push(t)}Je(t){const e=t.split("+").join(" ");let s=e.length;for(;s>0&&"_"===e.charAt(s-1);)s--;return s!==e.length?e.substr(0,s):e}}class ge{marker="";text=""}class we{static qe=[];static Ye=[];static Ke=[];static Qe=[];static Ze=new Map;static noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];static getTextForTuning(t,e){const s=we.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){const s=t/12|0,i=t%12;return[we.noteNames[i],(s+e).toString()]}static getDefaultTuningFor(t){if(we.Ze.has(t)){const e=we.Ze.get(t);return new we(e.name,e.tunings,e.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return we.qe;case 6:return we.Ye;case 5:return we.Ke;case 4:return we.Qe}return[]}static initialize(){we.Ze.set(7,new we("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),we.qe.push(we.Ze.get(7)),we.Ze.set(6,new we("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),we.Ye.push(we.Ze.get(6)),we.Ye.push(new we("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),we.Ye.push(new we("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),we.Ye.push(new we("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),we.Ye.push(new we("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),we.Ye.push(new we("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),we.Ye.push(new we("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),we.Ye.push(new we("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),we.Ye.push(new we("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),we.Ye.push(new we("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),we.Ye.push(new we("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),we.Ye.push(new we("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),we.Ye.push(new we("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),we.Ye.push(new we("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),we.Ye.push(new we("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),we.Ye.push(new we("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),we.Ye.push(new we("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),we.Ye.push(new we("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),we.Ye.push(new we("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),we.Ye.push(new we("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),we.Ye.push(new we("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),we.Ye.push(new we("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),we.Ye.push(new we("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),we.Ye.push(new we("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),we.Ye.push(new we("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),we.Ye.push(new we("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),we.Ye.push(new we("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),we.Ye.push(new we("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),we.Ye.push(new we("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),we.Ye.push(new we("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),we.Ye.push(new we("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),we.Ze.set(5,new we("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),we.Ke.push(we.Ze.get(5)),we.Ke.push(new we("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),we.Ke.push(new we("Banjo Open D Tuning",[62,57,54,50,69],!1)),we.Ke.push(new we("Banjo Open G Tuning",[62,59,55,50,67],!1)),we.Ke.push(new we("Banjo G Minor Tuning",[62,58,55,50,67],!1)),we.Ke.push(new we("Banjo G Modal Tuning",[62,57,55,50,67],!1)),we.Ze.set(4,new we("Bass Standard Tuning",[43,38,33,28],!0)),we.Qe.push(we.Ze.get(4)),we.Qe.push(new we("Bass Tune down ½ step",[42,37,32,27],!1)),we.Qe.push(new we("Bass Tune down 1 step",[41,36,31,26],!1)),we.Qe.push(new we("Bass Tune down 2 step",[39,34,29,24],!1)),we.Qe.push(new we("Bass Dropped D Tuning",[43,38,33,26],!1)),we.Qe.push(new we("Ukulele C Tuning",[45,40,36,43],!1)),we.Qe.push(new we("Ukulele G Tuning",[52,47,43,38],!1)),we.Qe.push(new we("Mandolin Standard Tuning",[64,57,50,43],!1)),we.Qe.push(new we("Mandolin or Violin Tuning",[76,69,62,55],!1)),we.Qe.push(new we("Viola Tuning",[69,62,55,48],!1)),we.Qe.push(new we("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=we.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const i=e[s];let n=!0;for(let e=0,s=t.length;e<s;e++)if(t[e]!==i.tunings[e]){n=!1;break}if(n)return new we(i.name,i.tunings,i.isStandard)}return null}isStandard;name;tunings;constructor(t="",e=null,s=!1){this.isStandard=s,this.name=t,this.tunings=e??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const t=we.findTuning(this.tunings);t&&(0===this.name.length&&(this.name=t.name),this.isStandard=t.isStandard)}}we.initialize();class ye{static DefaultStandardNotationLineCount=5;index=0;track;bars=[];chords=null;capo=0;transpositionPitch=0;displayTranspositionPitch=0;stringTuning=new we("",[],!1);get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}showSlash=!1;showNumbered=!1;showTablature=!0;showStandardNotation=!0;isPercussion=!1;standardNotationLineCount=ye.DefaultStandardNotationLineCount;I=new Set([0]);get filledVoices(){return this.I}finish(t,e=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish();for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(t,e);for(const t of this.bars[s].filledVoices)this.I.add(t)}}addChord(t,e){e.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(t,e)}hasChord(t){return this.chords?.has(t)??!1}getChord(t){return this.chords?.get(t)??null}addBar(t){const e=this.bars;t.staff=this,t.index=e.length,e.length>0&&(t.previousBar=e[e.length-1],t.previousBar.nextBar=t),e.push(t)}}class ke{volume=15;balance=8;port=1;program=0;bank=0;primaryChannel=0;secondaryChannel=0;isMute=!1;isSolo=!1}!function(t){t[t.TrackName=0]="TrackName",t[t.BracesAndBrackets=1]="BracesAndBrackets",t[t.SystemSeparator=2]="SystemSeparator",t[t.StringTuning=3]="StringTuning"}(Et||(Et={}));class Se extends J{}class Be{static ts=10;index=0;score;staves=[];playbackInfo=new ke;color=new pe(200,0,0,255);name="";isVisibleOnMultiTrack=!0;shortName="";defaultSystemsLayout=3;systemsLayout=[];lineBreaks;get isPercussion(){return this.staves.some(t=>t.isPercussion)}addLineBreaks(t){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(t)}percussionArticulations=[];style;ensureStaveCount(t){for(;this.staves.length<t;)this.addStaff(new ye)}addStaff(t){t.index=this.staves.length,t.track=this,this.staves.push(t)}finish(t,e=null){this.shortName||(this.shortName=this.name,this.shortName.length>Be.ts&&(this.shortName=this.shortName.substr(0,Be.ts)));for(const s of this.staves)s.finish(t,e),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(t){for(const e of t)e.finish();const e=this.staves[0];for(let s=0;s<t.length;s++){const i=t[s];if(i.startBar>=0&&i.startBar<e.bars.length){let n=e.bars[i.startBar].voices[0].beats[0];for(let e=0;e<i.chunks.length&&n;e++){for(;n&&(n.isEmpty||n.isRest);)n=n.nextBeat;n&&(n.lyrics||(n.lyrics=new Array(t.length),n.lyrics.fill("")),n.lyrics[s]=i.chunks[e],n=n.nextBeat)}}}}}class _e{id=Vt.newGuid();x=0;y=0;width=0;height=0;totalWidth=0;totalHeight=0;firstMasterBarIndex=-1;lastMasterBarIndex=-1;renderResult=null}!function(t){t[t.Page=0]="Page",t[t.Horizontal=1]="Horizontal"}(Ft||(Ft={}));class xe{es=[];ss;constructor(t=void 0){this.ss=t}on(t){return this.es.push(t),this.ss?.()&&t(),()=>{this.off(t)}}off(t){this.es=this.es.filter(e=>e!==t)}trigger(){for(const t of this.es)t()}}class Te{es=[];ss;constructor(t=void 0){this.ss=t}on(t){if(this.es.push(t),this.ss){const e=this.ss();null!==e&&t(e)}return()=>{this.off(t)}}off(t){this.es=this.es.filter(e=>e!==t)}trigger(t){for(const e of this.es)e(t)}}class Me{masterBarBounds;visualBounds;realBounds;bar;beats=[];addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((t,e)=>t.realBounds.x-e.realBounds.x);for(const e of this.beats)e.finish(t)}}class ve{barBounds;visualBounds;onNotesX=0;realBounds;beat;notes=null;addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s){const s=i.noteHeadBounds.y+i.noteHeadBounds.h,n=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=n&&e<=s)return i.note}return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class Ne{x=0;y=0;w=0;h=0;scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}}class Pe{index=0;isFirstOfLine=!1;visualBounds;realBounds;lineAlignedBounds;bars=[];staffSystemBounds=null;get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t){let e=null;for(const s of this.bars){const i=s.findBeatAtPos(t);if(i&&(!e||e.realBounds.x<i.realBounds.x)){const s=Math.abs(i.realBounds.x-t);(!e||s<1e7)&&(e=i)}}return e?e.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((t,e)=>t.realBounds.y<e.realBounds.y?-1:t.realBounds.y>e.realBounds.y?1:t.realBounds.x<e.realBounds.x?-1:t.realBounds.x>e.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class Ee{beatBounds;noteHeadBounds;note;finish(t=1){this.noteHeadBounds.scaleWith(t)}}class Fe{index=0;visualBounds;realBounds;bars=[];boundsLookup;finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class Ce{toJson(){const t={},e=[];t.staffSystems=e;for(const t of this.staffSystems){const s={};s.visualBounds=this.ns(t.visualBounds),s.realBounds=this.ns(t.realBounds),s.bars=[];for(const e of t.bars){const t={};t.lineAlignedBounds=this.ns(e.lineAlignedBounds),t.visualBounds=this.ns(e.visualBounds),t.realBounds=this.ns(e.realBounds),t.index=e.index,t.bars=[];for(const s of e.bars){const e={};e.visualBounds=this.ns(s.visualBounds),e.realBounds=this.ns(s.realBounds),e.beats=[];for(const t of s.beats){const s={};s.visualBounds=this.ns(t.visualBounds),s.realBounds=this.ns(t.realBounds),s.onNotesX=t.onNotesX;const i=s;if(i.beatIndex=t.beat.index,i.voiceIndex=t.beat.voice.index,i.barIndex=t.beat.voice.bar.index,i.staffIndex=t.beat.voice.bar.staff.index,i.trackIndex=t.beat.voice.bar.staff.track.index,t.notes){const e=[];s.notes=e;for(const s of t.notes){const t={};t.index=s.note.index,t.noteHeadBounds=this.ns(s.noteHeadBounds),e.push(t)}}e.beats.push(s)}t.bars.push(e)}s.bars.push(t)}e.push(s)}return t}static fromJson(t,e){const s=new Ce,i=t.staffSystems;for(const t of i){const i=new Fe;i.visualBounds=Ce.rs(t.visualBounds),i.realBounds=Ce.rs(t.realBounds),s.addStaffSystem(i);for(const s of t.bars){const t=new Pe;t.index=s.index,t.isFirstOfLine=s.isFirstOfLine,t.lineAlignedBounds=Ce.rs(s.lineAlignedBounds),t.visualBounds=Ce.rs(s.visualBounds),t.realBounds=Ce.rs(s.realBounds),i.addBar(t);for(const i of s.bars){const s=new Me;s.visualBounds=Ce.rs(i.visualBounds),s.realBounds=Ce.rs(i.realBounds),t.addBar(s);for(const t of i.beats){const i=new ve;i.visualBounds=Ce.rs(t.visualBounds),i.realBounds=Ce.rs(t.realBounds),i.onNotesX=t.onNotesX;const n=t;if(i.beat=e.tracks[n.trackIndex].staves[n.staffIndex].bars[n.barIndex].voices[n.voiceIndex].beats[n.beatIndex],t.notes){i.notes=[];for(const e of t.notes){const t=new Ee,s=e;t.note=i.beat.notes[s.index],t.noteHeadBounds=Ce.rs(e.noteHeadBounds),i.addNote(t)}}s.addBeat(i)}}}}return s}static rs(t){const e=new Ne;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}ns(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}j=new Map;hs=new Map;cs=null;staffSystems=[];isFinished=!1;finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this.cs=t}addMasterBar(t){t.staffSystemBounds?this.hs.set(t.index,t):(t.staffSystemBounds=this.cs,this.hs.set(t.index,t),this.cs.addBar(t))}addBeat(t){this.j.has(t.beat.id)||this.j.set(t.beat.id,[]),this.j.get(t.beat.id)?.push(t)}findMasterBarByIndex(t){return this.hs.has(t)?this.hs.get(t):null}findMasterBar(t){const e=t.index;return this.hs.has(e)?this.hs.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this.j.has(e)?this.j.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,n=-1;for(;s<=i;){const t=(i+s)/2|0,r=this.staffSystems[t];if(e>=r.realBounds.y&&e<=r.realBounds.y+r.realBounds.h){n=t;break}e<r.realBounds.y?i=t-1:s=t+1}if(-1===n)return null;const r=this.staffSystems[n].findBarAtPos(t);return r?r.findBeatAtPos(t):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const t of i){const i=t.findNoteAtPos(e,s);if(i)return i}return null}}class Ae{ls=Ft.Page;us=null;ds=null;canvas=null;score=null;tracks=null;layout=null;settings;boundsLookup=null;width=0;constructor(t){this.settings=t,this.fs(),this.ps()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}fs(){return this.us!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=tu.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this.us=this.settings.core.engine,!0)}ps(){return(!this.layout||this.ls!==this.settings.display.layoutMode)&&(this.layout=tu.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this.ls=this.settings.display.layoutMode,!0)}renderScore(t,e){try{this.score=t;let s=null;if(null!=t&&null!=e){if(e){s=[];for(const i of e)i>=0&&i<t.tracks.length&&s.push(t.tracks[i])}else s=t.tracks.slice(0);0===s.length&&t.tracks.length>0&&s.push(t.tracks[0])}this.tracks=s,this.render()}catch(t){this.error.trigger(t)}}renderTracks(t){0===t.length?this.score=null:this.score=t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(z.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):z.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(t){this.error.trigger(t)}}render(){if(0!==this.width)if(this.boundsLookup=new Ce,this.fs(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){z.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let t=0;t<this.tracks.length;t++){const e=this.tracks[t];z.debug("Rendering",`Track ${t}: ${e.name}`)}this.preRender.trigger(!1),this.ps(),this.bs(),z.debug("Rendering","Rendering finished")}else z.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this.ds=null,this.gs(),this.postRenderFinished.trigger(),z.debug("Rendering","Clearing finished");else z.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.ps()||this.fs()||this.ds!==this.tracks||!this.tracks?(z.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(z.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new Ce,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.gs(),this.postRenderFinished.trigger()):z.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),z.debug("Rendering","Resize finished")}bs(){z.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this.ds=this.tracks,this.gs(),this.postRenderFinished.trigger()}preRender=new Te;renderFinished=new Te;partialRenderFinished=new Te;partialLayoutFinished=new Te;postRenderFinished=new xe;error=new Te;gs(){this.boundsLookup?.finish(this.settings.display.scale);const t=new _e;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down"}(Ct||(Ct={}));const De=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:Me,get BeamDirection(){return Ct},BeatBounds:ve,Bounds:Ne,BoundsLookup:Ce,MasterBarBounds:Pe,NoteBounds:Ee,RenderFinishedEventArgs:_e,ScoreRenderer:Ae,StaffSystemBounds:Fe},Symbol.toStringTag,{value:"Module"}));class Le{static instance=new Le;applyScoreMetaData(t,e,s){const i=this.ws(t,[ie.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return e.title=s.arguments.arguments[0].text,this.ys(t,e,it.Title,s),Mt.Applied;case"subtitle":return e.subTitle=s.arguments.arguments[0].text,this.ys(t,e,it.SubTitle,s),Mt.Applied;case"artist":return e.artist=s.arguments.arguments[0].text,this.ys(t,e,it.Artist,s),Mt.Applied;case"album":return e.album=s.arguments.arguments[0].text,this.ys(t,e,it.Album,s),Mt.Applied;case"words":return e.words=s.arguments.arguments[0].text,this.ys(t,e,it.Words,s),Mt.Applied;case"music":return e.music=s.arguments.arguments[0].text,this.ys(t,e,it.Music,s),Mt.Applied;case"copyright":return e.copyright=s.arguments.arguments[0].text,this.ys(t,e,it.Copyright,s),Mt.Applied;case"instructions":return e.instructions=s.arguments.arguments[0].text,Mt.Applied;case"notices":return e.notices=s.arguments.arguments[0].text,Mt.Applied;case"tab":return e.tab=s.arguments.arguments[0].text,this.ys(t,e,it.Transcriber,s),Mt.Applied;case"copyright2":return this.ys(t,e,it.CopyrightSecondLine,s,0),Mt.Applied;case"wordsandmusic":return this.ys(t,e,it.WordsAndMusic,s,0),Mt.Applied;case"defaultsystemslayout":return e.defaultSystemsLayout=s.arguments.arguments[0].value,Mt.Applied;case"systemslayout":for(const t of s.arguments.arguments)e.systemsLayout.push(t.value);return Mt.Applied;case"hidedynamics":return e.stylesheet.hideDynamics=!0,Mt.Applied;case"showdynamics":return e.stylesheet.hideDynamics=!1,Mt.Applied;case"bracketextendmode":const i=Le.ks(t,s.arguments,"bracket extend mode",se.bracketExtendMode);return void 0===i?Mt.NotAppliedSemanticError:(e.stylesheet.bracketExtendMode=i,Mt.Applied);case"usesystemsignseparator":return e.stylesheet.useSystemSignSeparator=!0,Mt.Applied;case"multibarrest":return e.stylesheet.multiTrackMultiBarRest=!0,Mt.Applied;case"singletracktracknamepolicy":const n=Le.ks(t,s.arguments,"track name policy",se.trackNamePolicy);return void 0===n?Mt.NotAppliedSemanticError:(e.stylesheet.singleTrackTrackNamePolicy=n,Mt.Applied);case"multitracktracknamepolicy":const r=Le.ks(t,s.arguments,"track name policy",se.trackNamePolicy);return void 0===r?Mt.NotAppliedSemanticError:(e.stylesheet.multiTrackTrackNamePolicy=r,Mt.Applied);case"firstsystemtracknamemode":const a=Le.ks(t,s.arguments,"track name mode",se.trackNameMode);return void 0===a?Mt.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameMode=a,Mt.Applied);case"othersystemstracknamemode":const h=Le.ks(t,s.arguments,"track name mode",se.trackNameMode);return void 0===h?Mt.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameMode=h,Mt.Applied);case"firstsystemtracknameorientation":const o=Le.ks(t,s.arguments,"track name orientation",se.trackNameOrientation);return void 0===o?Mt.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameOrientation=o,Mt.Applied);case"othersystemstracknameorientation":const c=Le.ks(t,s.arguments,"track name orientation",se.trackNameOrientation);return void 0===c?Mt.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameOrientation=c,Mt.Applied);default:return Mt.NotAppliedUnrecognizedMarker}}ws(t,e,s,i,n){const r=e.find(t=>t.has(i));if(!r)return Mt.NotAppliedUnrecognizedMarker;const a=r.get(i);if(a)return this.Ss(t,a,s,n)?void 0:Mt.NotAppliedSemanticError;n&&t.addSemanticDiagnostic({code:St.AT300,message:"Expected no arguments, but found some.",start:n.start,end:n.end,severity:kt.Warning})}applyStaffMetaData(t,e,s){const i=this.ws(t,[ie.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return e.capo=s.arguments.arguments[0].value,Mt.Applied;case"tuning":const i=[];let n=!1,r="";for(let a=0;a<s.arguments.arguments.length;a++){const h=s.arguments.arguments[a],o=h.text;switch(o){case"piano":case"none":case"voice":t.applyStaffNoteKind(e,_t.Pitched),a=s.arguments.arguments.length;break;case"hide":n=!0,t.addSemanticDiagnostic({code:St.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:kt.Warning});break;default:const c=Vt.parseTuning(o);if(c)i.push(c.realValue);else if(a===s.arguments.arguments.length-1&&i.length>0)r=o,t.addSemanticDiagnostic({code:St.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:kt.Warning});else{const e=Array.from(Vt.tuningLetters).join(","),s=Array.from(Vt.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected tuning value '${o}', expected: <note><accidental><octave> where <note>=oneOf(${e}) <accidental>=oneOf(${s}), <octave>=number`,start:h.start,end:h.end,severity:kt.Error})}}}return t.state.staffHasExplicitTuning.add(e),t.state.staffTuningApplied.delete(e),e.stringTuning=new we,e.stringTuning.tunings=i,e.stringTuning.name=r,this.Bs(t,e,e.stringTuning,s),n&&(e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1)),Mt.Applied;case"instrument":return t.state.staffTuningApplied.delete(e),this._s(t,e.track,s.arguments),Mt.Applied;case"bank":return e.track.playbackInfo.bank=s.arguments.arguments[0].value,Mt.Applied;case"lyrics":const a=new me;return a.startBar=0,a.text="",2===s.arguments.arguments.length?(a.startBar=s.arguments.arguments[0].value,a.text=s.arguments.arguments[1].text):a.text=s.arguments.arguments[0].text,t.state.lyrics.get(e.track.index).push(a),Mt.Applied;case"chord":const h=new de;this.xs(t,h,s),h.name=s.arguments.arguments[0].text;for(let e=1;e<s.arguments.arguments.length;e++){const i=s.arguments.arguments[e];if(i.nodeType===yt.Number)h.strings.push(i.value);else if(i.nodeType===yt.Ident){const e=i.text;"x"===e?h.strings.push(-1):t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected chord value '${e}', expected: 'x'`,severity:kt.Error,start:i.start,end:i.end})}}return e.addChord(Le.Ts(e,h.name),h),Mt.Applied;case"articulation":const o=t.state.percussionArticulationNames,c=s.arguments.arguments[0].text;if("defaults"===c){for(const[t,e]of Ut.instrumentArticulationNames)o.set(t.toLowerCase(),e),o.set(Vt.toArticulationId(t),e);return Mt.Applied}if(2===s.arguments.arguments.length){const e=s.arguments.arguments[1].value;if(Ut.instrumentArticulations.has(e))return o.set(c.toLowerCase(),e),Mt.Applied;{const i=Array.from(Ut.instrumentArticulations.keys()).map(t=>`${t}`).join(",");return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected articulation value '${e}', expected: ${i}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:kt.Error}),Mt.NotAppliedSemanticError}}return Mt.Applied;case"accidentals":return Le.Ms(t,s.arguments);case"displaytranspose":return e.displayTranspositionPitch=-1*s.arguments.arguments[0].value,t.state.staffHasExplicitDisplayTransposition.add(e),Mt.Applied;case"transpose":return e.transpositionPitch=-1*s.arguments.arguments[0].value,Mt.Applied;default:return Mt.NotAppliedUnrecognizedMarker}}applyBarMetaData(t,e,s){const i=this.ws(t,[ie.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const i=this.vs(s);return t.state.syncPoints.push(i),Mt.Applied;case"tempo":let r=0;const a=s.arguments.arguments[r++].value;let h="",o=!0,c=0;for(;r<s.arguments.arguments.length;){switch(s.arguments.arguments[r].nodeType){case yt.Ident:case yt.String:const t=s.arguments.arguments[r].text;"hide"===t?o=!1:h=t;break;case yt.Number:c=s.arguments.arguments[r].value}r++}let l=e.masterBar.tempoAutomations.find(t=>t.ratioPosition===c);return l||(l=new G,e.masterBar.tempoAutomations.push(l)),l.isLinear=!1,l.type=n.Tempo,l.value=a,l.text=h,l.ratioPosition=c,l.isVisible=o,Mt.Applied;case"rc":return e.masterBar.repeatCount=s.arguments.arguments[0].value,Mt.Applied;case"ae":for(const i of s.arguments.arguments)if(i.nodeType===yt.Number){const s=i.value;if(s<1||s>31)return t.addSemanticDiagnostic({code:St.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:kt.Error,start:i.start,end:i.end}),Mt.NotAppliedSemanticError;e.masterBar.alternateEndings|=1<<s-1}else t.addSemanticDiagnostic({code:St.AT202,message:`Unexpected '${yt[i.nodeType]}' token. Expected one of following: ${yt[yt.Number]}`,severity:kt.Error,start:i.start,end:i.end});return Mt.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case yt.Number:e.masterBar.timeSignatureNumerator=s.arguments.arguments[0].value,e.masterBar.timeSignatureDenominator=s.arguments.arguments[1].value;break;case yt.Ident:case yt.String:const i=s.arguments.arguments[0].text;if("common"!==i.toLowerCase())return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected time signature value '${i}', expected: common or two numbers`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Mt.NotAppliedSemanticError;e.masterBar.timeSignatureCommon=!0,e.masterBar.timeSignatureNumerator=4,e.masterBar.timeSignatureDenominator=4}return Mt.Applied;case"ks":const u=Le.ks(t,s.arguments,"key signature",se.keySignature);if(void 0===u)return Mt.NotAppliedSemanticError;const d=Le.ks(t,s.arguments,"key signature type",se.keySignatureType);return void 0===d?Mt.NotAppliedSemanticError:(e.keySignature=u,e.keySignatureType=d,Mt.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case yt.Ident:case yt.String:const i=Le.ks(t,s.arguments,"clef",se.clef);if(void 0===i)return Mt.NotAppliedSemanticError;e.clef=i;break;case yt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.clef=N.Neutral;break;case 43:e.clef=N.G2;break;case 65:e.clef=N.F4;break;case 48:e.clef=N.C3;break;case 60:e.clef=N.C4;break;default:return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected clef value '${n}', expected: ${Array.from(se.clef.keys()).join(",")}`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Mt.NotAppliedSemanticError}}return Mt.Applied;case"section":const f=new ge;return 1===s.arguments.arguments.length?f.text=s.arguments.arguments[0].text:(f.marker=s.arguments.arguments[0].text,f.text=s.arguments.arguments[1].text),e.masterBar.section=f,Mt.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case yt.Ident:case yt.String:const i=Le.ks(t,s.arguments,"triplet feel",se.tripletFeel);if(void 0===i)return Mt.NotAppliedSemanticError;e.masterBar.tripletFeel=i;break;case yt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.masterBar.tripletFeel=nt.NoTripletFeel;break;case 1:e.masterBar.tripletFeel=nt.Triplet16th;break;case 2:e.masterBar.tripletFeel=nt.Triplet8th;break;case 3:e.masterBar.tripletFeel=nt.Dotted16th;break;case 4:e.masterBar.tripletFeel=nt.Dotted8th;break;case 5:e.masterBar.tripletFeel=nt.Scottish16th;break;case 6:e.masterBar.tripletFeel=nt.Scottish8th;break;default:return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected triplet feel value '${n}', expected: ${Array.from(se.tripletFeel.keys()).join(",")}`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Mt.NotAppliedSemanticError}}return Mt.Applied;case"barlineleft":const p=Le.ks(t,s.arguments,"bar line",se.barLineStyle);return void 0===p?Mt.NotAppliedSemanticError:(e.barLineLeft=p,Mt.Applied);case"barlineright":const b=Le.ks(t,s.arguments,"bar line",se.barLineStyle);return void 0===b?Mt.NotAppliedSemanticError:(e.barLineRight=b,Mt.Applied);case"accidentals":return Le.Ms(t,s.arguments);case"jump":const m=Le.ks(t,s.arguments,"direction",se.direction);return void 0===m?Mt.NotAppliedSemanticError:(e.masterBar.addDirection(m),Mt.Applied);case"ottava":const g=Le.ks(t,s.arguments,"clef ottava",se.ottavia);return void 0===g?Mt.NotAppliedSemanticError:(e.clefOttava=g,Mt.Applied);case"simile":const w=Le.ks(t,s.arguments,"simile mark",se.simileMark);return void 0===w?Mt.NotAppliedSemanticError:(e.simileMark=w,Mt.Applied);case"width":return e.masterBar.displayWidth=s.arguments.arguments[0].value,e.displayWidth=e.masterBar.displayWidth,Mt.Applied;case"scale":return e.masterBar.displayScale=s.arguments.arguments[0].value,e.displayScale=e.masterBar.displayScale,Mt.Applied;case"spd":const y=new q;return y.pedalType=C.Down,y.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(y),Mt.Applied;case"spu":const k=new q;return k.pedalType=C.Up,k.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(k),Mt.Applied;case"sph":const S=new q;return S.pedalType=C.Hold,S.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(S),Mt.Applied;case"ft":return e.masterBar.isFreeTime=!0,Mt.Applied;case"ro":return e.masterBar.isRepeatStart=!0,Mt.Applied;case"ac":return e.masterBar.isAnacrusis=!0,Mt.Applied;case"db":return e.masterBar.isDoubleBar=!0,e.barLineRight=D.LightLight,Mt.Applied;default:return Mt.NotAppliedUnrecognizedMarker}}static Ms(t,e){const s=Le.ks(t,e,"accidental mode",se.alphaTexAccidentalMode);return void 0===s?Mt.NotAppliedSemanticError:(t.state.accidentalMode=s,Mt.Applied)}static Ts(t,e){return e.toLowerCase()+t.index+t.track.index}vs(t){const e=t.arguments.arguments[0].value,s=t.arguments.arguments[1].value,i=t.arguments.arguments[2].value;let n=0;return t.arguments.arguments.length>3&&(n=t.arguments.arguments[3].value),{barIndex:e,barOccurence:s,barPosition:n,millisecondOffset:i}}Ss(t,e,s,i){if(!i){return!!e.some(t=>0===t.parameters.length||!t.parameters.some(t=>t.parseMode===xt.Required||t.parseMode===xt.RequiredAsFloat||t.parseMode===xt.RequiredAsValueList))||(t.addSemanticDiagnostic({code:St.AT219,message:`Error parsing arguments: no overload matched arguments ${le.generateSignaturesFromArguments(void 0)}. Signatures: ${le.generateSignatures(e)}`,severity:kt.Error,start:s.start,end:s.end}),!1)}if(i.validated)return!0;let n=!1;const r=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),a=t.parseMode===Tt.Full,h=a?(t,e)=>{const s=r.get(e),i=t;i.parameterIndices||(i.parameterIndices=new Map),i.parameterIndices.set(e,s.parameterIndex)}:(t,e)=>{};for(const t of i.arguments)if(le.filterSignatureCandidates(r,t,!1,h),0===r.size)break;const o=a?Array.from(r.entries()):void 0;return le.filterIncompleteCandidates(r),0===r.size&&(t.addSemanticDiagnostic({code:St.AT219,message:`Error parsing arguments: no overload matched arguments ${le.generateSignaturesFromArguments(i.arguments)}. Signatures:\n${le.generateSignatures(e)}`,severity:kt.Error,start:i.start,end:i.end}),n=!0),o&&(le.sortCandidates(o),i.signatureCandidateIndices=o.map(t=>t[0])),!n}ys(t,e,s,i,n=1){const r=i.arguments.arguments.length-n;if(r<1)return;const a=Vt.getOrCreateHeaderFooterStyle(e,s);void 0===a.isVisible&&(a.isVisible=!0);const h=i.arguments.arguments[n].text;if(h?a.template=h:a.isVisible=!1,r<2)return;const o=Le.ks(t,i.arguments,"textAlign",se.textAlign,n+1);void 0!==o&&(a.textAlign=o)}_s(t,e,s){switch(s.arguments[0].nodeType){case yt.Number:const i=s.arguments[0].value;i>=0&&i<=127?e.playbackInfo.program=i:t.addSemanticDiagnostic({code:St.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:kt.Error});break;case yt.Ident:case yt.String:const n=s.arguments[0].text.toLowerCase();if("percussion"===n){for(const s of e.staves)t.applyStaffNoteKind(s,_t.Articulation);e.playbackInfo.primaryChannel=It.PercussionChannel,e.playbackInfo.secondaryChannel=It.PercussionChannel}else e.playbackInfo.program=ue.getValue(n)}}xs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Ns(t,[ie.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":e.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":e.showDiagram=Le.Ps(i.arguments.arguments,0);break;case"showfingering":e.showFingering=Le.Ps(i.arguments.arguments,0);break;case"showname":e.showName=Le.Ps(i.arguments.arguments,0);break;case"barre":e.barreFrets=i.arguments.arguments.map(t=>t.value)}}Bs(t,e,s,i){if(i.properties)for(const n of i.properties.properties)if(this.Ns(t,[ie.metaDataProperties.get("tuning")],n))switch(n.property.text.toLowerCase()){case"hide":e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1);break;case"label":s.name=n.arguments.arguments[0].text}}static Ps(t,e){if(e>=t.length)return!0;const s=t[e];switch(s.nodeType){case yt.String:case yt.Ident:return"false"!==s.text;case yt.Number:return 0!==s.value;default:return!1}}applyStructuralMetaData(t,e){const s=this.ws(t,[ie.structuralMetaDataSignatures],e,e.tag.tag.text.toLowerCase(),e.arguments);if(void 0!==s)switch(s){case Mt.NotAppliedSemanticError:return vt.NotAppliedSemanticError;case Mt.NotAppliedUnrecognizedMarker:return vt.NotAppliedUnrecognizedMarker}switch(e.tag.tag.text.toLowerCase()){case"staff":const s=t.startNewStaff();return this.Es(t,s,e),vt.AppliedNewStaff;case"track":const i=t.startNewTrack();return e.arguments&&e.arguments.arguments.length>0&&(i.name=e.arguments.arguments[0].text,e.arguments.arguments.length>1&&(i.shortName=e.arguments.arguments[1].text)),this.Fs(t,i,e),vt.AppliedNewTrack;case"voice":return t.startNewVoice(),vt.AppliedNewVoice;default:return vt.NotAppliedUnrecognizedMarker}}Ns(t,e,s){const i=this.ws(t,e,s,s.property.text.toLowerCase(),s.arguments);if(void 0!==i)switch(i){case Mt.Applied:case Mt.NotAppliedSemanticError:return!1;case Mt.NotAppliedUnrecognizedMarker:const i=e.flatMap(t=>Array.from(t.keys()));return t.addSemanticDiagnostic({code:St.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${i}`,severity:kt.Error,start:s.start,end:s.end}),!1}return!0}Es(t,e,s){if(!s.properties)return;let i=!1,n=!1,r=!1,a=!1;for(const h of s.properties.properties)if(this.Ns(t,[ie.metaDataProperties.get("staff")],h))switch(h.property.text.toLowerCase()){case"score":i=!0,h.arguments&&h.arguments.arguments.length>0&&(e.standardNotationLineCount=h.arguments.arguments[0].value);break;case"tabs":n=!0;break;case"slash":r=!0;break;case"numbered":a=!0}(i||n||r||a)&&(e.showStandardNotation=i,e.showTablature=n,e.showSlash=r,e.showNumbered=a)}Fs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Ns(t,[ie.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{e.color=pe.fromJson(i.arguments.arguments[0].text)}catch{t.addSemanticDiagnostic({code:St.AT213,message:"Invalid format for color",severity:kt.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":e.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":e.systemsLayout=i.arguments.arguments.map(t=>t.value);break;case"volume":e.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":e.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":e.playbackInfo.isMute=!0;break;case"solo":e.playbackInfo.isSolo=!0;break;case"multibarrest":e.score.stylesheet.perTrackMultiBarRest||(e.score.stylesheet.perTrackMultiBarRest=new Set),e.score.stylesheet.perTrackMultiBarRest.add(e.index);break;case"instrument":this._s(t,e,i.arguments);break;case"bank":e.playbackInfo.bank=i.arguments.arguments[0].value}}applyBeatDurationProperty(t,e){const s=this.ws(t,[ie.durationChangeProperties],e,e.property.text.toLowerCase(),e.arguments);if(void 0!==s)return s;if("tu"===e.property.text.toLowerCase()){if(2===e.arguments.arguments.length)t.state.currentTupletNumerator=e.arguments.arguments[0].value,t.state.currentTupletDenominator=e.arguments.arguments[1].value;else{const s=e.arguments.arguments[0].value;t.state.currentTupletNumerator=s;const i=Le.Cs(s);i<0?(t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected default tuplet value '${s}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:kt.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=i}return Mt.Applied}return Mt.NotAppliedUnrecognizedMarker}static Cs(t){switch(t){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}As=void 0;get allKnownMetaDataTags(){if(!this.As){this.As=new Set;const t=[ie.scoreMetaDataSignatures.keys(),ie.structuralMetaDataSignatures.keys(),ie.staffMetaDataSignatures.keys(),ie.barMetaDataSignatures.keys()];for(const e of t)for(const t of e)this.As.add(t)}return this.As}Ds=void 0;get knownScoreMetaDataTags(){return this.Ds||(this.Ds=new Set(ie.scoreMetaDataSignatures.keys())),this.Ds}Ls=void 0;get knownStructuralMetaDataTags(){return this.Ls||(this.Ls=new Set(ie.structuralMetaDataSignatures.keys())),this.Ls}Ws=void 0;get knownBarMetaDataTags(){return this.Ws||(this.Ws=new Set(ie.barMetaDataSignatures.keys())),this.Ws}Os=void 0;get knownStaffMetaDataTags(){return this.Os||(this.Os=new Set(ie.staffMetaDataSignatures.keys())),this.Os}Rs=void 0;get knownBeatDurationProperties(){return this.Rs||(this.Rs=new Set(ie.durationChangeProperties.keys())),this.Rs}Is=void 0;get knownBeatProperties(){return this.Is||(this.Is=new Set(ie.beatProperties.keys())),this.Is}Gs=void 0;get knownNoteProperties(){return this.Gs||(this.Gs=new Set(ie.noteProperties.keys())),this.Gs}applyBeatProperty(t,e,s){const i=s.property.text.toLowerCase(),r=this.ws(t,[ie.beatProperties],s,i,s.arguments);if(void 0!==r)return r;switch(i){case"f":return e.fade=ft.FadeIn,Mt.Applied;case"fo":return e.fade=ft.FadeOut,Mt.Applied;case"vs":return e.fade=ft.VolumeSwell,Mt.Applied;case"v":return e.vibrato=w.Slight,Mt.Applied;case"vw":return e.vibrato=w.Wide,Mt.Applied;case"s":return e.slap=!0,Mt.Applied;case"p":return e.pop=!0,Mt.Applied;case"tt":return e.tap=!0,Mt.Applied;case"txt":return e.text=s.arguments.arguments[0].text,Mt.Applied;case"lyrics":let r=0,a="";for(2===s.arguments.arguments.length?(r=s.arguments.arguments[0].value,a=s.arguments.arguments[1].text):a=s.arguments.arguments[0].text,e.lyrics||(e.lyrics=[]);e.lyrics.length<=r;)e.lyrics.push("");return e.lyrics[r]=a,Mt.Applied;case"dd":return e.dots=2,Mt.Applied;case"d":return e.dots=1,Mt.Applied;case"su":return e.pickStroke=ht.Up,Mt.Applied;case"sd":return e.pickStroke=ht.Down,Mt.Applied;case"tu":if(2===s.arguments.arguments.length)e.tupletNumerator=s.arguments.arguments[0].value,e.tupletDenominator=s.arguments.arguments[1].value;else{const i=s.arguments.arguments[0].value;e.tupletNumerator=i;const n=Le.Cs(i);if(n<0)return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),e.tupletNumerator=-1,e.tupletDenominator=-1,Mt.NotAppliedSemanticError;e.tupletDenominator=n}return Mt.Applied;case"tb":case"tbe":let u=0,d=!0,f=!1;for(;d;)switch(s.arguments.arguments[u].nodeType){case yt.Ident:case yt.String:const i=s.arguments.arguments[u].text.toLowerCase();if(se.whammyType.has(i))e.whammyBarType=se.whammyType.get(i),f=!0,u++;else{if(!se.bendStyle.has(i))return f?Le.ks(t,s.arguments,"whammy style",se.bendStyle,u):Le.ks(t,s.arguments,"whammy type",se.whammyType,u),Mt.NotAppliedSemanticError;e.whammyStyle=se.bendStyle.get(i),u++}break;default:d=!1}const p=this.$s(t,s,u,"tbe"===i);if(p)for(const t of p)e.addWhammyBarPoint(t);return Mt.Applied;case"bu":return Le.Vs(e,s,h.BrushUp,.25),Mt.Applied;case"bd":return Le.Vs(e,s,h.BrushDown,.25),Mt.Applied;case"au":return Le.Vs(e,s,h.ArpeggioUp,1),Mt.Applied;case"ad":return Le.Vs(e,s,h.ArpeggioDown,1),Mt.Applied;case"ch":const b=s.arguments.arguments[0].text,m=Le.Ts(e.voice.bar.staff,b);if(!e.voice.bar.staff.hasChord(m)){const t=new de;t.showDiagram=!1,t.name=b,e.voice.bar.staff.addChord(m,t)}return e.chordId=m,Mt.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const i=Le.ks(t,s.arguments,"whammy style",se.graceType);if(void 0===i)return Mt.NotAppliedSemanticError;e.graceType=i}else e.graceType=l.BeforeBeat;return Mt.Applied;case"dy":const g=Le.ks(t,s.arguments,"dynamic",se.dynamicValue);return void 0===g?Mt.NotAppliedSemanticError:(e.dynamics=g,t.state.currentDynamics=g,Mt.Applied);case"cre":return e.crescendo=o.Crescendo,Mt.Applied;case"dec":return e.crescendo=o.Decrescendo,Mt.Applied;case"tempo":const y=s.arguments.arguments[0].value;let k="",S=!0;if(s.arguments.arguments.length>2){k=s.arguments.arguments[1].text;const e=s.arguments.arguments[2].text;if("hide"!==e)return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected third tempo property value '${e}', expected: 'hide'`,severity:kt.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),Mt.NotAppliedSemanticError;S=!1}else s.arguments.arguments.length>1&&(k=s.arguments.arguments[1].text,"hide"===k&&(S=!1,k=""));const B=new G;return B.isLinear=!1,B.type=n.Tempo,B.value=y,B.text=k,B.isVisible=S,e.automations.push(B),e.voice.bar.masterBar.tempoAutomations.push(B),Mt.Applied;case"volume":const _=new G;return _.isLinear=!0,_.type=n.Volume,_.value=s.arguments.arguments[0].value,e.automations.push(_),Mt.Applied;case"balance":const x=new G;return x.isLinear=!0,x.type=n.Balance,x.value=Vt.clamp(s.arguments.arguments[0].value,0,16),e.automations.push(x),Mt.Applied;case"tp":if(e.tremoloSpeed=c.Eighth,s.arguments&&s.arguments.arguments.length>0){const i=s.arguments.arguments[0].value;switch(i){case 8:e.tremoloSpeed=c.Eighth;break;case 16:e.tremoloSpeed=c.Sixteenth;break;case 32:e.tremoloSpeed=c.ThirtySecond;break;default:return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected tremolo speed value '${i}, expected: 8, 16 or 32`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Mt.NotAppliedSemanticError}}return Mt.Applied;case"spd":return Le.Hs(t,e,C.Down),Mt.Applied;case"sph":return Le.Hs(t,e,C.Hold),Mt.Applied;case"spu":return Le.Hs(t,e,C.Up),Mt.Applied;case"spe":return Le.Hs(t,e,C.Up,!0),Mt.Applied;case"slashed":return e.slashed=!0,Mt.Applied;case"ds":return e.deadSlapped=!0,1===e.notes.length&&e.notes[0].isDead&&e.removeNote(e.notes[0]),Mt.Applied;case"glpf":return e.golpe=dt.Finger,Mt.Applied;case"glpt":return e.golpe=dt.Thumb,Mt.Applied;case"waho":return e.wahPedal=pt.Open,Mt.Applied;case"wahc":return e.wahPedal=pt.Closed,Mt.Applied;case"barre":if(e.barreFret=s.arguments.arguments[0].value,e.barreShape=bt.Full,s.arguments.arguments.length>1){const i=Le.ks(t,s.arguments,"barre shape",se.barreShape,1);if(void 0===i)return Mt.NotAppliedSemanticError;e.barreShape=i}return Mt.Applied;case"rasg":const T=Le.ks(t,s.arguments,"rasgueado pattern",se.rasgueado);return void 0===T?Mt.NotAppliedSemanticError:(e.rasgueado=T,Mt.Applied);case"ot":const M=Le.ks(t,s.arguments,"ottava",se.ottavia);return void 0===M?Mt.NotAppliedSemanticError:(e.ottava=M,Mt.Applied);case"legatoorigin":return e.isLegatoOrigin=!0,Mt.Applied;case"instrument":let v=0;switch(s.arguments.arguments[0].nodeType){case yt.Ident:case yt.String:v=ue.getValue(s.arguments.arguments[0].text);break;case yt.Number:v=s.arguments.arguments[0].value}const N=new G;return N.isLinear=!1,N.type=n.Instrument,N.value=v,e.automations.push(N),Mt.Applied;case"bank":const P=new G;return P.isLinear=!1,P.type=n.Bank,P.value=s.arguments.arguments[0].value,e.automations.push(P),Mt.Applied;case"fermata":const E=Le.ks(t,s.arguments,"fermata",se.fermataType);if(void 0===E)return Mt.NotAppliedSemanticError;const F=new be;return F.type=E,s.arguments.arguments.length>1&&(F.length=s.arguments.arguments[1].value),e.fermata=F,Mt.Applied;case"beam":const A=s.arguments.arguments[0].text;switch(A.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=Ct.Up;break;case"down":e.preferredBeamDirection=Ct.Down;break;case"auto":e.beamingMode=gt.Auto;break;case"split":e.beamingMode=gt.ForceSplitToNext;break;case"merge":e.beamingMode=gt.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=gt.ForceSplitOnSecondaryToNext;break;default:const i=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected beam value '${A}', expected: ${i.join(",")}`,severity:kt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Mt.NotAppliedSemanticError}return Mt.Applied;case"timer":return e.showTimer=!0,Mt.Applied}return Mt.NotAppliedUnrecognizedMarker}static Hs(t,e,s,i=!1){const n=new q;n.pedalType=s,n.ratioPosition=i?1:.001*e.voice.bar.sustainPedals.length,t.state.sustainPedalToBeat.set(n,e),e.voice.bar.sustainPedals.push(n)}static Vs(t,e,s,i){t.brushType=s,e.arguments&&e.arguments.arguments.length>0?t.brushDuration=e.arguments.arguments[0].value:(t.updateDurations(),t.brushDuration=t.playbackDuration*i/t.notes.length)}applyNoteProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.ws(t,[ie.noteProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"b":case"be":let n=0,r=!0,a=!1;for(;r;)switch(s.arguments.arguments[n].nodeType){case yt.Ident:case yt.String:const i=s.arguments.arguments[n].text.toLowerCase();if(se.bendType.has(i))e.bendType=se.bendType.get(i),a=!0,n++;else{if(!se.bendStyle.has(i))return a?Le.ks(t,s.arguments,"bend style",se.bendStyle,n):Le.ks(t,s.arguments,"bend type",se.bendType,n),Mt.NotAppliedSemanticError;e.bendStyle=se.bendStyle.get(i),n++}break;default:r=!1}const h=this.$s(t,s,n,"be"===i);if(h)for(const t of h)e.addBendPoint(t);return Mt.Applied;case"nh":return e.harmonicType=f.Natural,e.harmonicValue=Vt.deltaFretToHarmonicValue(e.fret),Mt.Applied;case"ah":return e.harmonicType=f.Artificial,e.harmonicValue=Le.Us(s.arguments,e.harmonicValue),Mt.Applied;case"th":return e.harmonicType=f.Tap,e.harmonicValue=Le.Us(s.arguments,e.harmonicValue),Mt.Applied;case"ph":return e.harmonicType=f.Pinch,e.harmonicValue=Le.Us(s.arguments,e.harmonicValue),Mt.Applied;case"sh":return e.harmonicType=f.Semi,e.harmonicValue=Le.Us(s.arguments,e.harmonicValue),Mt.Applied;case"fh":return e.harmonicType=f.Feedback,e.harmonicValue=Le.Us(s.arguments,e.harmonicValue),Mt.Applied;case"tr":const o=s.arguments.arguments[0].value;let l=c.Sixteenth;if(s.arguments.arguments.length>1){const e=s.arguments.arguments[1].value;switch(e){case 16:l=c.Sixteenth;break;case 32:l=c.ThirtySecond;break;case 64:l=c.SixtyFourth;break;default:return t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected trill duration value '${e}', expected: 16, 32 or 64`,severity:kt.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),Mt.NotAppliedSemanticError}}return e.trillValue=o+e.stringTuning,e.trillSpeed=l,Mt.Applied;case"v":return e.vibrato=w.Slight,Mt.Applied;case"vw":return e.vibrato=w.Wide,Mt.Applied;case"sl":return e.slideOutType=g.Legato,Mt.Applied;case"ss":return e.slideOutType=g.Shift,Mt.Applied;case"sib":return e.slideInType=m.IntoFromBelow,Mt.Applied;case"sia":return e.slideInType=m.IntoFromAbove,Mt.Applied;case"sou":return e.slideOutType=g.OutUp,Mt.Applied;case"sod":return e.slideOutType=g.OutDown,Mt.Applied;case"psd":return e.slideOutType=g.PickSlideDown,Mt.Applied;case"psu":return e.slideOutType=g.PickSlideUp,Mt.Applied;case"h":return e.isHammerPullOrigin=!0,Mt.Applied;case"lht":return e.isLeftHandTapped=!0,Mt.Applied;case"g":return e.isGhost=!0,Mt.Applied;case"ac":return e.accentuated=u.Normal,Mt.Applied;case"hac":return e.accentuated=u.Heavy,Mt.Applied;case"ten":return e.accentuated=u.Tenuto,Mt.Applied;case"pm":return e.isPalmMute=!0,Mt.Applied;case"st":return e.isStaccato=!0,Mt.Applied;case"lr":return e.isLetRing=!0,Mt.Applied;case"x":return e.isDead=!0,Mt.Applied;case"-":case"t":return e.isTieDestination=!0,Mt.Applied;case"lf":let p=d.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Le.zs(t,s.arguments);if(void 0===e)return Mt.NotAppliedSemanticError;p=e}return e.leftHandFinger=p,Mt.Applied;case"rf":let b=d.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Le.zs(t,s.arguments);if(void 0===e)return Mt.NotAppliedSemanticError;b=e}return e.rightHandFinger=b,Mt.Applied;case"acc":return e.accidentalMode=Vt.parseAccidentalMode(s.arguments.arguments[0].text),Mt.Applied;case"turn":return e.ornament=ct.Turn,Mt.Applied;case"iturn":return e.ornament=ct.InvertedTurn,Mt.Applied;case"umordent":return e.ornament=ct.UpperMordent,Mt.Applied;case"lmordent":return e.ornament=ct.LowerMordent,Mt.Applied;case"string":return e.showStringNumber=!0,Mt.Applied;case"hide":return e.isVisible=!1,Mt.Applied;case"slur":const y=s.arguments.arguments[0].text;if(t.state.slurs.has(y)){const s=t.state.slurs.get(y);s.slurDestination=e,e.slurOrigin=s,e.isSlurDestination=!0}else t.state.slurs.set(y,e);return Mt.Applied;default:return this.applyBeatProperty(t,e.beat,s)}return Mt.NotAppliedUnrecognizedMarker}static zs(t,e){const s=e.arguments[0].value;switch(s){case 1:return d.Thumb;case 2:return d.IndexFinger;case 3:return d.MiddleFinger;case 4:return d.AnnularFinger;case 5:return d.LittleFinger;default:return void t.addSemanticDiagnostic({code:St.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:e.arguments[0].start,end:e.arguments[0].end,severity:kt.Error})}}static Us(t,e){return t&&(e=t.arguments[0].value),e}$s(t,e,s,i){let n=e.arguments.arguments,r=n.length-s,a=e.arguments;r>0&&n[s].nodeType===yt.Arguments&&(n=n[s].arguments,s=0,r=n.length,a=n[s]);const h=i?2:1;if(r%h!==0){const s=Math.ceil(r/h),i=s*h;return void t.addSemanticDiagnostic({code:St.AT214,message:`The '${e.property.text}' effect needs ${h} arguments per item. With ${s} points, ${i} arguments are needed, only ${r} arguments found.`,severity:kt.Error,start:a.end,end:a.end})}const o=[];let c=s;for(;c<n.length;){let t=0,e=0;i?(t=n[c++].value,e=n[c++].value):(t=0,e=n[c++].value),o.push(new $(t,e))}if(o.length>0){if(o.length>60&&o.splice(60,o.length-60),i)o.sort((t,e)=>t.offset-e.offset);else{const t=o.length,e=$.MaxPosition/(t-1)|0;let s=0;for(;s<t;)o[s].offset=Math.min($.MaxPosition,s*e),s++}return o}}static ks(t,e,s,i,n=0){if(n>=e.arguments.length)return;const r=e.arguments[n].text;return i.has(r.toLowerCase())?i.get(r.toLowerCase()):void t.addSemanticDiagnostic({code:St.AT209,message:`Unexpected ${s} value '${r}', expected: ${Array.from(i.keys()).join(",")}`,severity:kt.Error,start:e.arguments[n].start,end:e.arguments[n].end})}static js=new Ot;static Xs=new Be;buildScoreMetaDataNodes(t){const e=[];return Le.Js(e,"album",t,t.album,it.Album),Le.Js(e,"artist",t,t.artist,it.Artist),Le.Js(e,"copyright",t,t.copyright,it.Copyright),Le.Js(e,"copyright2",t,void 0,it.CopyrightSecondLine),Le.Js(e,"wordsandmusic",t,void 0,it.WordsAndMusic,!0),Le.Js(e,"instructions",t,t.instructions,void 0),Le.Js(e,"music",t,t.music,it.Music),Le.Js(e,"notices",t,t.notices,void 0),Le.Js(e,"subtitle",t,t.subTitle,it.SubTitle),Le.Js(e,"title",t,t.title,it.Title),Le.Js(e,"words",t,t.words,it.Words),Le.Js(e,"tab",t,t.tab,it.Transcriber),t.defaultSystemsLayout!==Le.js.defaultSystemsLayout&&e.push(ce.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&e.push(ce.meta("systemsLayout",ce.args(t.systemsLayout.map(t=>ce.number(t))))),Le.qs(e,t.stylesheet),e.length>0&&(e[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),e}static qs(t,e){const s=t.length;e.hideDynamics&&t.push(ce.meta("hideDynamics")),e.bracketExtendMode!==Le.js.stylesheet.bracketExtendMode&&t.push(ce.identMeta("bracketExtendMode",se.bracketExtendModeReversed.get(e.bracketExtendMode))),e.useSystemSignSeparator&&t.push(ce.meta("useSystemSignSeparator")),e.multiTrackMultiBarRest&&t.push(ce.meta("multiBarRest")),e.singleTrackTrackNamePolicy!==Le.js.stylesheet.singleTrackTrackNamePolicy&&t.push(ce.identMeta("singleTrackTrackNamePolicy",se.trackNamePolicyReversed.get(e.singleTrackTrackNamePolicy))),e.multiTrackTrackNamePolicy!==Le.js.stylesheet.multiTrackTrackNamePolicy&&t.push(ce.identMeta("multiTrackTrackNamePolicy",se.trackNamePolicyReversed.get(e.multiTrackTrackNamePolicy))),e.firstSystemTrackNameMode!==Le.js.stylesheet.firstSystemTrackNameMode&&t.push(ce.identMeta("firstSystemTrackNameMode",se.trackNameModeReversed.get(e.firstSystemTrackNameMode))),e.otherSystemsTrackNameMode!==Le.js.stylesheet.otherSystemsTrackNameMode&&t.push(ce.identMeta("otherSystemsTrackNameMode",se.trackNameModeReversed.get(e.otherSystemsTrackNameMode))),e.firstSystemTrackNameOrientation!==Le.js.stylesheet.firstSystemTrackNameOrientation&&t.push(ce.identMeta("firstSystemTrackNameOrientation",se.trackNameOrientationReversed.get(e.firstSystemTrackNameOrientation))),e.otherSystemsTrackNameOrientation!==Le.js.stylesheet.otherSystemsTrackNameOrientation&&t.push(ce.identMeta("otherSystemsTrackNameOrientation",se.trackNameOrientationReversed.get(e.otherSystemsTrackNameOrientation))),s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static Js(t,e,s,i,n,r=!1){if(void 0!==i&&0===i.length&&!r)return;const a=[];if(void 0!==i&&a.push(ce.string(i)),void 0!==n){const t=s.style&&s.style.headerAndFooter.has(n)?s.style.headerAndFooter.get(n):void 0,e=Wt.defaultHeaderAndFooter.has(n)?Wt.defaultHeaderAndFooter.get(n):void 0;!t||e&&Lt.equals(e,t)||(a.push(ce.string(!1===t.isVisible?"":t.template)),a.push(ce.ident(se.textAlignReversed.get(t.textAlign))))}void 0===i&&0===a.length||void 0!==i&&0===i.length&&1===a.length||t.push(ce.meta(e,ce.args(a)))}buildSyncPointNodes(t){const e=[],s=t.exportFlatSyncPoints();for(const t of s)e.push(ce.meta("sync",ce.args([ce.number(t.barIndex),ce.number(t.barOccurence),ce.number(t.millisecondOffset),t.barPosition>0?ce.number(t.barPosition):void 0])));return e}buildBarMetaDataNodes(t,e,s,i){const n=[];if(Le.Ys(e,t,n,i,s),!e)return n;0===s&&0===t.index&&0===t.track.index&&Le.Ks(n,e.masterBar);const r=n.length;0===s&&0===e.index&&0===t.index&&0===t.track.index&&n.push(ce.identMeta("accidentals","auto")),0!==e.index&&e.clef===e.previousBar?.clef||n.push(ce.identMeta("clef",se.clefReversed.get(e.clef))),(0===e.index&&e.clefOttava!==b.Regular||e.clefOttava!==e.previousBar?.clefOttava)&&n.push(ce.identMeta("ottava",se.ottaviaReversed.get(e.clefOttava))),(0===e.index&&e.simileMark!==P.None||e.simileMark!==e.previousBar?.simileMark)&&n.push(ce.identMeta("simile",se.simileMarkReversed.get(e.simileMark))),1!==e.displayScale&&n.push(ce.numberMeta("scale",e.displayScale)),e.displayWidth>0&&n.push(ce.numberMeta("width",e.displayWidth));for(const t of e.sustainPedals){let e="";switch(t.pedalType){case C.Down:e="spd";break;case C.Hold:e="sph";break;case C.Up:e="spu"}e&&n.push(ce.numberMeta(e,t.ratioPosition))}if(e.barLineLeft!==D.Automatic&&n.push(ce.identMeta("barLineLeft",se.barLineStyleReversed.get(e.barLineLeft))),e.barLineRight!==D.Automatic&&n.push(ce.identMeta("barLineRight",se.barLineStyleReversed.get(e.barLineRight))),0===e.index||e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType){let t="";t=e.keySignatureType===F.Minor?se.keySignaturesMinorReversed.get(e.keySignature):se.keySignaturesMajorReversed.get(e.keySignature),n.push(ce.identMeta("ks",t))}return r<n.length&&(n[r].leadingComments=[{multiLine:!1,text:`Bar ${e.index+1} Metadata`}]),n}static Qs(t,e){const s=t.length;if(0!==e.capo&&t.push(ce.numberMeta("capo",e.capo)),e.isPercussion)t.push(ce.identMeta("articulation","defaults"));else if(e.isStringed){const s=ce.meta("tuning",ce.args(e.stringTuning.tunings.map(t=>ce.ident(we.getTextForTuning(t,!0)))));t.push(s),e.track.score.stylesheet.perTrackDisplayTuning&&e.track.score.stylesheet.perTrackDisplayTuning.has(e.track.index)&&(s.properties=ce.props([["hide",void 0]])),e.stringTuning.name.length>0&&(s.properties??=ce.props([]),ce.prop(s.properties.properties,"label",ce.stringValue(e.stringTuning.name)))}0!==e.transpositionPitch&&t.push(ce.numberMeta("transpose",-e.transpositionPitch));const i=Vt.displayTranspositionPitches.has(e.track.playbackInfo.program)?Vt.displayTranspositionPitches.get(e.track.playbackInfo.program):0;if(e.displayTranspositionPitch!==i&&t.push(ce.numberMeta("displaytranspose",-e.displayTranspositionPitch)),null!=e.chords)for(const[s,i]of e.chords)t.push(Le.Zs(i));s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Staff ${e.index+1} Metadata`}])}static Zs(t){const e=ce.meta("chord",ce.args([ce.string(t.name)],!0),ce.props([t.firstFret>=0?["firstfret",ce.numberValue(t.firstFret)]:void 0,["showdiagram",ce.identValue(t.showDiagram?"true":"false")],["showfingering",ce.identValue(t.showFingering?"true":"false")],["showname",ce.identValue(t.showName?"true":"false")],t.barreFrets.length>0?["barre",ce.args(t.barreFrets.map(t=>ce.number(t)))]:void 0]));for(let s=0;s<t.staff.tuning.length;s++)s<t.strings.length&&t.strings[s]>=0?e.arguments.arguments.push(ce.number(t.strings[s])):e.arguments.arguments.push(ce.ident("x"));return e}static Ks(t,e){const s=t.length;if(0!==e.alternateEndings&&t.push(ce.meta("ae",ce.args(Vt.getAlternateEndingsList(e.alternateEndings).map(t=>ce.number(t+1))))),e.isRepeatStart&&t.push(ce.meta("ro")),e.isRepeatEnd&&t.push(ce.numberMeta("rc",e.repeatCount)),0!==e.index&&e.timeSignatureCommon===e.previousMasterBar?.timeSignatureCommon&&e.timeSignatureNumerator===e.previousMasterBar.timeSignatureNumerator&&e.timeSignatureDenominator===e.previousMasterBar.timeSignatureDenominator||(e.timeSignatureCommon?t.push(ce.identMeta("ts","common")):t.push(ce.meta("ts",ce.args([ce.number(e.timeSignatureNumerator),ce.number(e.timeSignatureDenominator)])))),(e.index>0&&e.tripletFeel!==e.previousMasterBar?.tripletFeel||0===e.index&&e.tripletFeel!==nt.NoTripletFeel)&&t.push(ce.identMeta("tf",se.tripletFeelReversed.get(e.tripletFeel))),e.isFreeTime&&t.push(ce.meta("ft")),null!=e.section&&t.push(ce.meta("section",ce.args([ce.string(e.section.marker),ce.string(e.section.text)]))),e.isAnacrusis&&t.push(ce.meta("ac")),1!==e.displayScale&&t.push(ce.numberMeta("scale",e.displayScale)),e.displayWidth>0&&t.push(ce.numberMeta("width",e.displayWidth)),e.directions)for(const s of e.directions)t.push(ce.identMeta("jump",se.directionReversed.get(s)));for(const s of e.tempoAutomations){const e=ce.meta("tempo",ce.args([ce.number(s.value),s.text?ce.string(s.text):void 0,s.ratioPosition>0?ce.number(s.ratioPosition):void 0,s.isVisible?void 0:ce.ident("hide")]));1===e.arguments.arguments.length&&(e.arguments.openParenthesis=void 0,e.arguments.closeParenthesis=void 0),t.push(e)}s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Masterbar ${e.index+1} Metadata`}])}static Ys(t,e,s,i,n){if((void 0===t||0===t.index)&&(0===n&&(0===e.index&&s.push(Le.ti(e.track)),s.push(Le.ei(e)),Le.Qs(s,e)),i)){const t=ce.meta("voice");t.trailingComments=[{multiLine:!0,text:`Voice ${n+1}`}],s.push(t)}}static ei(t){const e=ce.meta("staff",void 0,ce.props([t.showStandardNotation?["score",ce.args([t.standardNotationLineCount!==ye.DefaultStandardNotationLineCount?ce.number(t.standardNotationLineCount):void 0])]:void 0,t.showTablature?["tabs",void 0]:void 0,t.showSlash?["slash",void 0]:void 0,t.showNumbered?["numbered",void 0]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static ti(t){const e=ce.meta("track",ce.args([ce.string(t.name),t.shortName.length>0?ce.string(t.shortName):void 0]),ce.props([t.color.rgba!==Le.Xs.color.rgba?["color",ce.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==Le.Xs.defaultSystemsLayout?["defaultSystemsLayout",ce.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",ce.args(t.systemsLayout.map(t=>ce.number(t)))]:void 0,["volume",ce.numberValue(t.playbackInfo.volume)],["balance",ce.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",ce.identValue(t.isPercussion?"percussion":ue.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",ce.numberValue(t.playbackInfo.bank)]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(t){const e=[];if(t.hasBend){const s=ce.args([ce.ident(se.bendTypeReversed.get(t.bendType)),t.bendStyle!==r.Default?ce.ident(se.bendStyleReversed.get(t.bendStyle)):void 0],!0);for(const e of t.bendPoints)s.arguments.push(ce.number(e.offset)),s.arguments.push(ce.number(e.value));ce.prop(e,"be",s)}let s="";switch(t.harmonicType){case f.Natural:ce.prop(e,"nh");break;case f.Artificial:s="ah";break;case f.Pinch:s="ph";break;case f.Tap:s="th";break;case f.Semi:s="sh";break;case f.Feedback:s="fh"}switch(s&&ce.prop(e,s,ce.numberValue(t.harmonicValue)),t.showStringNumber&&ce.prop(e,"string"),t.isTrill&&ce.prop(e,"tr",ce.args([ce.number(t.trillFret),ce.number(t.trillSpeed)])),t.vibrato){case w.Slight:ce.prop(e,"v");break;case w.Wide:ce.prop(e,"vw")}switch(t.slideInType){case m.IntoFromBelow:ce.prop(e,"sib");break;case m.IntoFromAbove:ce.prop(e,"sia")}switch(t.slideOutType){case g.Shift:ce.prop(e,"ss");break;case g.Legato:ce.prop(e,"sl");break;case g.OutUp:ce.prop(e,"sou");break;case g.OutDown:ce.prop(e,"sod");break;case g.PickSlideDown:ce.prop(e,"psd");break;case g.PickSlideUp:ce.prop(e,"psu")}switch(t.isHammerPullOrigin&&ce.prop(e,"h"),t.isLeftHandTapped&&ce.prop(e,"lht"),t.isGhost&&ce.prop(e,"g"),t.accentuated){case u.Normal:ce.prop(e,"ac");break;case u.Heavy:ce.prop(e,"hac");break;case u.Tenuto:ce.prop(e,"ten")}if(t.isPalmMute&&ce.prop(e,"pm"),t.isStaccato&&ce.prop(e,"st"),t.isLetRing&&ce.prop(e,"lr"),t.isDead&&ce.prop(e,"x"),t.isTieDestination&&ce.prop(e,"t"),t.leftHandFinger>=d.Thumb&&ce.prop(e,"lf",ce.numberValue(t.leftHandFinger+1)),t.rightHandFinger>=d.Thumb&&ce.prop(e,"rf",ce.numberValue(t.rightHandFinger+1)),t.isVisible||ce.prop(e,"hide"),t.isSlurOrigin){const s=`s${t.id}`;ce.prop(e,"slur",ce.identValue(s))}if(t.isSlurDestination){const s=`s${t.slurOrigin.id}`;ce.prop(e,"slur",ce.identValue(s))}switch(t.accidentalMode!==p.Default&&ce.prop(e,"acc",ce.identValue(Vt.reverseAccidentalModeMapping.get(t.accidentalMode))),t.ornament){case ct.InvertedTurn:ce.prop(e,"iturn");break;case ct.Turn:ce.prop(e,"turn");break;case ct.UpperMordent:ce.prop(e,"umordent");break;case ct.LowerMordent:ce.prop(e,"lmordent")}return e}buildBeatEffects(t){const e=[];switch(t.fade){case ft.FadeIn:ce.prop(e,"f");break;case ft.FadeOut:ce.prop(e,"fo");break;case ft.VolumeSwell:ce.prop(e,"vs")}if(t.vibrato===w.Slight?ce.prop(e,"v"):t.vibrato===w.Wide&&ce.prop(e,"vw"),t.slap&&ce.prop(e,"s"),t.pop&&ce.prop(e,"p"),t.tap&&ce.prop(e,"tt"),t.dots>=2?ce.prop(e,"dd"):t.dots>0&&ce.prop(e,"d"),t.pickStroke===ht.Up?ce.prop(e,"su"):t.pickStroke===ht.Down&&ce.prop(e,"sd"),t.hasTuplet&&ce.prop(e,"tu",ce.args([ce.number(t.tupletNumerator),ce.number(t.tupletDenominator)])),t.hasWhammyBar){const s=ce.args([ce.ident(se.whammyTypeReversed.get(t.whammyBarType)),ce.ident(se.bendStyleReversed.get(t.whammyStyle))],!0);for(const e of t.whammyBarPoints)s.arguments.push(ce.number(e.offset)),s.arguments.push(ce.number(e.value));ce.prop(e,"tbe",s)}let s="";switch(t.brushType){case h.BrushUp:s="bu";break;case h.BrushDown:s="bd";break;case h.ArpeggioUp:s="au";break;case h.ArpeggioDown:s="ad"}if(s&&ce.prop(e,s,ce.numberValue(t.brushDuration)),null!=t.chord&&ce.prop(e,"ch",ce.stringValue(t.chord.name)),t.ottava!==b.Regular&&ce.prop(e,"ot",ce.identValue(se.ottaviaReversed.get(t.ottava))),t.hasRasgueado&&ce.prop(e,"rasg",ce.identValue(se.rasgueadoReversed.get(t.rasgueado))),null!=t.text&&ce.prop(e,"txt",ce.stringValue(t.text)),null!=t.lyrics&&t.lyrics.length>0)if(t.lyrics.length>1)for(let s=0;s<t.lyrics.length;s++)ce.prop(e,"lyrics",ce.args([ce.number(s),ce.string(t.lyrics[s])]));else ce.prop(e,"lyrics",ce.stringValue(t.lyrics[0]));switch(t.graceType!==l.None&&ce.prop(e,"gr",t.graceType===l.BeforeBeat?void 0:ce.identValue(se.graceTypeReversed.get(t.graceType))),t.isTremolo&&ce.prop(e,"tp",ce.numberValue(t.tremoloSpeed)),t.crescendo){case o.Crescendo:ce.prop(e,"cre");break;case o.Decrescendo:ce.prop(e,"dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&ce.prop(e,"dy",ce.identValue(se.dynamicValueReversed.get(t.dynamics)));null!=t.fermata&&ce.prop(e,"fermata",ce.args([ce.ident(se.fermataTypeReversed.get(t.fermata.type)),ce.number(t.fermata.length)])),t.isLegatoOrigin&&ce.prop(e,"legatoorigin");for(const s of t.automations)switch(s.type){case n.Tempo:ce.prop(e,"tempo",ce.args([ce.number(s.value),0===s.text.length?void 0:ce.string(s.text)]));break;case n.Volume:ce.prop(e,"volume",ce.numberValue(s.value));break;case n.Instrument:t.voice.bar.staff.isPercussion||ce.prop(e,"instrument",ce.identValue(ue.getName(s.value)));break;case n.Balance:ce.prop(e,"balance",ce.numberValue(s.value))}switch(t.wahPedal){case pt.Open:ce.prop(e,"waho");break;case pt.Closed:ce.prop(e,"wahc")}switch(t.isBarre&&ce.prop(e,"barre",ce.args([ce.number(t.barreFret),ce.ident(se.barreShapeReversed.get(t.barreShape))])),t.slashed&&ce.prop(e,"slashed"),t.deadSlapped&&ce.prop(e,"ds"),t.golpe){case dt.Thumb:ce.prop(e,"glpt");break;case dt.Finger:ce.prop(e,"glpf")}t.invertBeamDirection?ce.prop(e,"beam",ce.identValue("invert")):null!==t.preferredBeamDirection&&ce.prop(e,"beam",ce.identValue(Ct[t.preferredBeamDirection]));let i="";switch(t.beamingMode){case gt.ForceSplitToNext:i="split";break;case gt.ForceMergeWithNext:i="merge";break;case gt.ForceSplitOnSecondaryToNext:i="splitsecondary"}return i&&ce.prop(e,"beam",ce.identValue(i)),t.showTimer&&ce.prop(e,"timer"),e}}class We{data;settings;init(t,e){this.data=t,this.settings=e,Ot.resetIds()}}class Oe extends W{constructor(t=null,e){super(s.Format,t??"Unsupported format",e)}}class Re{si;length=0;position=0;get bytesWritten(){return this.position}getBuffer(){return this.si}static empty(){return Re.withCapacity(0)}static withCapacity(t){const e=new Re;return e.si=new Uint8Array(t),e}static fromBuffer(t){const e=new Re;return e.si=t,e.length=t.length,e}static fromString(t){const e=ae.stringToBytes(t);return Re.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this.si[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this.si.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this.ii(e),this.si[this.position]=255&t,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this.ii(i);const n=Math.min(s,t.length-e);this.si.set(t.subarray(e,e+n),this.position),i>this.length&&(this.length=i),this.position=i}ii(t){if(t>this.si.length){let e=t;e<256&&(e=256),e<2*this.si.length&&(e=2*this.si.length);const s=new Uint8Array(e);this.length>0&&s.set(this.si.subarray(0,0+this.length),0),this.si=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this.si.subarray(0,0+this.length),0),t}copyTo(t){t.write(this.si,0,this.length)}}class Ie extends W{lexerDiagnostics;parserDiagnostics;semanticDiagnostics;*iterateDiagnostics(){if(this.lexerDiagnostics)for(const t of this.lexerDiagnostics.items)yield t;if(this.parserDiagnostics)for(const t of this.parserDiagnostics.items)yield t;if(this.semanticDiagnostics)for(const t of this.semanticDiagnostics.items)yield t}constructor(t,e,i,n){super(s.AlphaTex,t),this.lexerDiagnostics=e,this.parserDiagnostics=i,this.semanticDiagnostics=n}toString(){return[this.message,"lexer diagnostics:",Ie.ni(this.lexerDiagnostics,"  "),"parser diagnostics:",Ie.ni(this.parserDiagnostics,"  "),"semantic diagnostics:",Ie.ni(this.semanticDiagnostics,"  ")].join("\n")}static ni(t,e){return t?t.items.map(t=>`${e}${kt[t.severity]} AT${t.code.toString().padStart(3,"0")}${Ie.ri(t)}: ${t.message}`).join("\n"):`${e}none`}static ri(t){let e="";return t.start&&(e+=`(${t.start.line},${t.start.col})`),t.end&&(e.length>0&&(e+="->"),e+=`(${t.end.line},${t.end.col})`),e}}class Ge{trackChannel=0;score;currentTrack;currentStaff;barIndex=0;voiceIndex=0;ignoredInitialVoice=!1;ignoredInitialStaff=!1;ignoredInitialTrack=!1;currentDuration=c.Quarter;articulationValueToIndex=new Map;hasAnyProperData=!1;percussionArticulationNames=new Map;slurs=new Map;lyrics=new Map;sustainPedalToBeat=new Map;staffTuningApplied=new Set;staffNoteKind=new Map;staffHasExplicitTuning=new Set;staffHasExplicitDisplayTransposition=new Set;staffDisplayTranspositionApplied=new Set;staffInitialClef=new Map;syncPoints=[];currentDynamics=i.F;accidentalMode=Bt.Explicit;currentTupletNumerator=-1;currentTupletDenominator=-1;scoreNode}class $e extends We{ai;hi=Le.instance;oi=new Ge;get state(){return this.oi}get scoreNode(){return this.oi.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this.ai.lexerDiagnostics}get parserDiagnostics(){return this.ai.parserDiagnostics}get parser(){return this.ai}get parseMode(){return this.ai.mode}logErrors=!1;semanticDiagnostics=new ne;addSemanticDiagnostic(t){this.semanticDiagnostics.push(t)}initFromString(t,e){this.data=Re.empty(),this.ai=new oe(t),this.settings=e,Ot.resetIds()}readScore(){let t;this.oi=new Ge,this.ci(),this.data.length>0&&(this.ai=new oe(ae.toString(this.data.readAll(),this.settings.importer.encoding)));try{t=this.ai.read(),this.oi.scoreNode=t}catch(t){throw this.logErrors&&z.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Oe("Error parsing alphaTex, check inner error for details",t)}if(this.ai.parserDiagnostics.hasErrors||this.ai.lexer.lexerDiagnostics.hasErrors){const t=new Ie("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&z.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Oe("Error parsing alphaTex, check diagnostics on inner error for details",t)}if(0===t.bars.length)throw new Oe("No alphaTex data found");if(this.de(t),this.semanticDiagnostics.hasErrors){if(this.oi.hasAnyProperData){const t=new Ie("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&z.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),t}throw new Oe("No alphaTex data found")}Vt.consolidate(this.oi.score),this.oi.score.finish(this.settings),Vt.trimEmptyBarsAtEnd(this.oi.score),this.oi.score.rebuildRepeatGroups(),this.oi.score.applyFlatSyncPoints(this.oi.syncPoints);for(const[t,e]of this.oi.lyrics)this.oi.score.tracks[t].applyLyrics(e);for(const[t,e]of this.oi.sustainPedalToBeat)if(t.ratioPosition<1){const s=e.voice.bar.masterBar.calculateDuration();t.ratioPosition=e.playbackStart/s}return this.oi.score}ci(){this.oi.score=new Ot,this.li()}li(){this.oi.currentTrack=new Be,this.oi.currentTrack.ensureStaveCount(1),this.oi.currentTrack.playbackInfo.program=25,this.oi.currentTrack.playbackInfo.primaryChannel=this.oi.trackChannel++,this.oi.currentTrack.playbackInfo.secondaryChannel=this.oi.trackChannel++;const t=this.oi.currentTrack.staves[0];t.displayTranspositionPitch=0,t.stringTuning=we.getDefaultTuningFor(6),this.oi.articulationValueToIndex.clear(),this.ui(t),this.oi.score.addTrack(this.oi.currentTrack),this.oi.lyrics.set(this.oi.currentTrack.index,[]),this.oi.currentDynamics=i.F,this.oi.currentTupletDenominator=-1,this.oi.currentTupletNumerator=-1}ui(t){this.oi.currentStaff&&(this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff)),this.oi.currentStaff=t,this.oi.slurs.clear(),this.oi.barIndex=0,this.oi.voiceIndex=0}de(t){if(t.bars.length>0)for(const e of t.bars)this.fe(e);else this.pi(this.oi.currentStaff),this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff)}fe(t){const e=this.bi(t);this.di(this.oi.currentStaff),this.fi(this.oi.currentStaff),0===e.index&&this.oi.staffInitialClef.has(this.oi.currentStaff)&&(e.clef=this.oi.staffInitialClef.get(this.oi.currentStaff));const s=e.voices[this.oi.voiceIndex];for(const e of t.beats)this.ge(s,e);if(0===s.beats.length){const t=new Yt;t.isEmpty=!0,s.addBeat(t)}}ge(t,e){if(e.durationChange&&this.ke(e.durationChange),!e.notes&&!e.rest)return;const s=new Yt;if(t.addBeat(s),e.notes)for(const t of e.notes.notes)this.xe(s,t);else e.rest;e.durationValue&&(this.oi.currentDuration=this.mi(e.durationValue)),s.duration=this.oi.currentDuration,s.dynamics=this.oi.currentDynamics,-1===this.oi.currentTupletNumerator||s.hasTuplet||(s.tupletNumerator=this.oi.currentTupletNumerator,s.tupletDenominator=this.oi.currentTupletDenominator);let i=1;void 0!==e.beatMultiplierValue&&(i=e.beatMultiplierValue.value),e.beatEffects&&this.gi(s,e.beatEffects);for(let e=0;e<i-1;e++)t.addBeat(ee.clone(s))}gi(t,e){for(const s of e.properties){switch(this.hi.applyBeatProperty(this,t,s)){case Mt.Applied:case Mt.NotAppliedSemanticError:this.oi.hasAnyProperData=!0;break;case Mt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:St.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:kt.Error,start:s.start,end:s.end})}}}ke(t){if(t.value&&(this.oi.currentDuration=this.mi(t.value)),this.oi.currentTupletNumerator=-1,this.oi.currentTupletDenominator=-1,t.properties)for(const e of t.properties.properties){switch(this.hi.applyBeatDurationProperty(this,e)){case Mt.Applied:case Mt.NotAppliedSemanticError:this.oi.hasAnyProperData=!0;break;case Mt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:St.AT212,message:`Unrecogized property '${e.property.text}', expected one of ${t}`,severity:kt.Error,start:e.start,end:e.end})}}}mi(t){switch(t.value){case-4:return c.QuadrupleWhole;case-2:return c.DoubleWhole;case 1:return c.Whole;case 2:return c.Half;case 4:return c.Quarter;case 8:return c.Eighth;case 16:return c.Sixteenth;case 32:return c.ThirtySecond;case 64:return c.SixtyFourth;case 128:return c.OneHundredTwentyEighth;case 256:return c.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:St.AT209,message:`Unexpected duration value '${t.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:kt.Error,start:t.start,end:t.end}),this.oi.currentDuration}}xe(t,e){let s=!1,i=!1,n=-1,r=-1,a=-1,h=p.Default;const o=e.noteValue;let c,l=this.oi.staffNoteKind.has(this.oi.currentStaff)?this.oi.staffNoteKind.get(this.oi.currentStaff):void 0;switch(o.nodeType){case yt.Number:n=o.value,c=void 0!==e.noteString?_t.Fretted:_t.Articulation;break;case yt.String:case yt.Ident:const t=o.text;if(s="x"===t,i="-"===t,i||s)n=0,c=e.noteStringDot&&e.noteString?_t.Fretted:void 0;else{const e=Vt.parseTuning(t);if(e)c=_t.Pitched,r=e.octave,a=e.tone.noteValue,this.oi.accidentalMode===Bt.Explicit&&(h=e.tone.accidentalMode);else{c=_t.Articulation;const e=t.toLowerCase(),s=this.oi.percussionArticulationNames;if(void 0===l&&0===s.size)for(const[t,e]of Ut.instrumentArticulationNames)s.set(t.toLowerCase(),e),s.set(Vt.toArticulationId(t),e);if(!s.has(e))return this.addSemanticDiagnostic({code:St.AT209,message:`Unexpected percussion articulation value '${e}', expected: oneOf(${Array.from(this.oi.percussionArticulationNames.keys()).join(",")}).`,severity:kt.Error,start:o.start,end:o.end}),void(n=Array.from(Ut.instrumentArticulationNames.values())[0]);n=s.get(e)}}}void 0!==c?void 0===l?(l=c,this.applyStaffNoteKind(this.oi.currentStaff,l)):l!==c&&this.addSemanticDiagnostic({code:St.AT218,message:`Wrong note kind '${_t[c]}' for staff with note kind ''${_t[l]}'. Do not mix incompatible staves and notes.`,severity:kt.Error,start:o.start,end:o.end}):void 0!==l&&(c=l);const u=new Xt;if(u.isDead=s,(s||i)&&(u.fret=n),u.isTieDestination=i,void 0!==c&&c===l)switch(c){case _t.Pitched:u.octave=r,u.tone=a,u.accidentalMode=h;break;case _t.Fretted:if(!e.noteString)return void this.addSemanticDiagnostic({code:St.AT207,message:"Missing string for fretted note.",severity:kt.Error,start:o.end,end:o.end});const t=e.noteString.value;if(t<1||t>this.oi.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:St.AT208,message:`Note string is out of range. Available range: 1-${this.oi.currentStaff.tuning.length}`,severity:kt.Error,start:o.end,end:o.end});u.string=this.oi.currentStaff.tuning.length-(t-1),i||(u.fret=n);break;case _t.Articulation:let s=0;if(this.oi.articulationValueToIndex.has(n))s=this.oi.articulationValueToIndex.get(n);else{s=this.oi.currentTrack.percussionArticulations.length;const t=Ut.getArticulationByInputMidiNumber(n);if(null===t)return void this.addSemanticDiagnostic({code:St.AT209,message:`Unexpected articulation value '${n}', expected: oneOf(${Array.from(Ut.instrumentArticulations.keys()).join(",")}).`,severity:kt.Error,start:o.end,end:o.end});this.oi.currentTrack.percussionArticulations.push(t),this.oi.articulationValueToIndex.set(n,s)}u.percussionArticulation=s}t.addNote(u),this.oi.hasAnyProperData=!0,e.noteEffects&&this.wi(u,e.noteEffects)}getStaffNoteKind(t){return this.oi.staffNoteKind.has(t)?this.oi.staffNoteKind.get(t):void 0}applyStaffNoteKind(t,e){switch(this.oi.staffNoteKind.set(t,e),e){case _t.Pitched:t.isPercussion=!1,t.stringTuning.reset(),this.oi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0);break;case _t.Fretted:t.isPercussion=!1,this.di(t),this.fi(t);break;case _t.Articulation:t.isPercussion=!0,t.stringTuning.reset(),this.oi.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0)}}wi(t,e){for(const s of e.properties){let e=this.hi.applyNoteProperty(this,t,s);switch(e===Mt.NotAppliedUnrecognizedMarker&&(e=this.hi.applyBeatProperty(this,t.beat,s)),e){case Mt.Applied:case Mt.NotAppliedSemanticError:break;case Mt.NotAppliedUnrecognizedMarker:const t=Array.from(this.hi.knownNoteProperties).concat(Array.from(this.hi.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:St.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:kt.Error,start:s.start,end:s.end})}}}fi(t){if(!this.oi.staffDisplayTranspositionApplied.has(t)&&!this.oi.staffHasExplicitDisplayTransposition.has(t)){const e=t.track.playbackInfo.program;Vt.displayTranspositionPitches.has(e)?t.displayTranspositionPitch=Vt.displayTranspositionPitches.get(e):this.oi.currentStaff.displayTranspositionPitch=0,this.oi.staffDisplayTranspositionApplied.add(t)}}di(t){const e=t.track.playbackInfo.program;this.oi.staffTuningApplied.has(t)||this.oi.staffHasExplicitTuning.has(t)||(t.stringTuning.reset(),15===e||e>=24&&e<=31?t.stringTuning.tunings=we.getDefaultTuningFor(6).tunings:e>=32&&e<=39?(t.stringTuning.tunings=[43,38,33,28],this.oi.staffInitialClef.set(t,N.F4)):40===e||44===e||45===e||48===e||49===e||50===e||51===e?t.stringTuning.tunings=[52,57,50,43]:41===e?t.stringTuning.tunings=[57,50,43,36]:42===e?t.stringTuning.tunings=[45,38,31,24]:43===e?t.stringTuning.tunings=[43,38,33,28]:105===e?t.stringTuning.tunings=[50,47,43,38,55]:106===e?t.stringTuning.tunings=[57,52,45]:107===e?t.stringTuning.tunings=[52,45,38,31]:110===e?t.stringTuning.tunings=[64,57,50,43]:this.oi.staffNoteKind.has(t)&&this.oi.staffNoteKind.get(t)===_t.Fretted&&(t.stringTuning=we.getDefaultTuningFor(6)),this.oi.staffTuningApplied.add(t))}bi(t){let e=this.oi.score.masterBars.length>0?void 0:[],i=this.oi.currentStaff,n=!1,r=!1,a=!1;const h=()=>{e&&(e=void 0,i=this.oi.currentStaff,n=!1,r=!1,a=!1)},o=new H(()=>{const t=this.pi(this.oi.currentStaff);if(e){for(const s of e)this.hi.applyBarMetaData(this,t,s);h()}return t});for(const c of t.metaData){const t=c.tag.tag.text.toLowerCase();if(this.hi.knownStructuralMetaDataTags.has(t)){this.oi.hasAnyProperData=!0;switch(this.hi.applyStructuralMetaData(this,c)){case vt.AppliedNewTrack:r||n?a=!0:(n=!0,i=this.oi.currentStaff),o.reset();break;case vt.AppliedNewStaff:r?a=!0:(r=!0,i=this.oi.currentStaff),o.reset()}if(e&&a){if(0!==i.bars.length)throw new W(s.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");{const t=new K;i.addBar(t);const s=new tt;if(t.addVoice(s),i.bars.length>this.oi.score.masterBars.length){const t=new Rt;this.oi.score.addMasterBar(t)}for(const s of e)this.hi.applyBarMetaData(this,t,s);h()}}}else if(this.hi.knownScoreMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,this.hi.applyScoreMetaData(this,this.oi.score,c);else if(this.hi.knownStaffMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,this.hi.applyStaffMetaData(this,this.oi.currentStaff,c);else if(this.hi.knownBarMetaDataTags.has(c.tag.tag.text.toLowerCase()))this.oi.hasAnyProperData=!0,e?e.push(c):this.hi.applyBarMetaData(this,o.value,c);else{const t=Array.from(this.hi.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:St.AT204,message:`Unrecognized metadata '${c.tag.tag.text}', expected one of: ${t}`,severity:kt.Error,start:c.tag.start,end:c.tag.end})}}return o.value}pi(t){if(this.oi.barIndex<t.bars.length){const e=t.bars[this.oi.barIndex];return this.oi.barIndex++,e}const e=0===t.bars.length?1:t.bars[0].voices.length,s=new K;t.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this.oi.barIndex++,s.index>0&&(s.clef=s.previousBar.clef);for(let t=0;t<e;t++){const t=new tt;s.addVoice(t)}if(this.oi.currentStaff.bars.length>this.oi.score.masterBars.length){const t=new Rt;this.oi.score.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this.oi.ignoredInitialVoice=!1,this.oi.ignoredInitialStaff||this.oi.currentTrack.staves[0].bars.length>0){const t=this.oi.currentStaff.isPercussion;this.oi.currentTrack.ensureStaveCount(this.oi.currentTrack.staves.length+1);const e=this.oi.currentTrack.staves[this.oi.currentTrack.staves.length-1];this.ui(e),t&&this.applyPercussionStaff(this.oi.currentStaff),this.oi.currentDynamics=i.F}else this.oi.ignoredInitialStaff=!0;return this.oi.currentStaff}applyPercussionStaff(t){t.isPercussion=!0,t.showTablature=!1,t.track.playbackInfo.program=0}startNewTrack(){return this.oi.ignoredInitialVoice=!1,this.oi.ignoredInitialStaff=!1,this.oi.ignoredInitialTrack||this.oi.score.masterBars.length>0?this.li():this.oi.ignoredInitialTrack=!0,this.oi.currentTrack}startNewVoice(){if(0!==this.oi.voiceIndex||0!==this.oi.currentStaff.bars.length&&(1!==this.oi.currentStaff.bars.length||!this.oi.currentStaff.bars[0].isEmpty||this.oi.ignoredInitialVoice)){for(const t of this.oi.currentStaff.bars){const e=new tt;t.addVoice(e)}this.oi.voiceIndex++,this.oi.barIndex=0,this.oi.currentTupletDenominator=-1,this.oi.currentTupletNumerator=-1}else this.oi.ignoredInitialVoice=!0}}let Ve=class{};class He extends Ve{n;constructor(t){super(),this.n=t}}class Ue extends Ve{left;right;constructor(t,e){super(),this.left=t,this.right=e}}class ze extends Ve{n;table;constructor(t,e){super(),this.n=t,this.table=e}}class je{static make(t,e,s,i){const n=[],r=[];if(i>32)throw new fe("Invalid huffman");for(let t=0;t<i;t++)n.push(0),r.push(0);for(let r=0;r<s;r++){const s=t[r+e];if(s>=i)throw new fe("Invalid huffman");n[s]++}let a=0;for(let t=1;t<i-1;t++)a=a+n[t]<<1,r[t]=a;const h=new Map;for(let i=0;i<s;i++){const s=t[i+e];if(0!==s){const t=r[s-1];r[s-1]=t+1,h.set(t<<5|s,i)}}return je.yi(new Ue(je.ki(h,i,0,1),je.ki(h,i,1,1)))}static ki(t,e,s,i){if(i>e)throw new fe("Invalid huffman");const n=s<<5|i;return t.has(n)?new He(t.get(n)):(s<<=1,i+=1,new Ue(je.ki(t,e,s,i),je.ki(t,e,1|s,i)))}static yi(t){const e=je.Si(t);if(0===e)return t;if(1===e){if(t instanceof Ue)return new Ue(je.yi(t.left),je.yi(t.right));throw new fe("assert")}const s=1<<e,i=[];for(let t=0;t<s;t++)i.push(new He(-1));return je.Bi(i,0,0,e,t),new ze(e,i)}static Bi(t,e,s,i,n){n instanceof Ue&&i>0?(je.Bi(t,e,s+1,i-1,n.left),je.Bi(t,e|1<<s,s+1,i-1,n.right)):t[e]=je.yi(n)}static Si(t){if(t instanceof He)return 0;if(t instanceof ze)throw new fe("assert");if(t instanceof Ue){const e=je.Si(t.left),s=je.Si(t.right);return 1+(e<s?e:s)}return 0}}var Xe,Je,qe,Ye,Ke,Qe,Ze,ts,es,ss,is,ns,rs,as,hs,os,cs,ls,us,ds,fs,ps,bs,ms,gs,ws,ys,ks;!function(t){t[t.Head=0]="Head",t[t.Block=1]="Block",t[t.CData=2]="CData",t[t.Flat=3]="Flat",t[t.Crc=4]="Crc",t[t.Dist=5]="Dist",t[t.DistOne=6]="DistOne",t[t.Done=7]="Done"}(Xe||(Xe={}));class Ss{static _i=32768;static xi=65536;buffer=new Uint8Array(Ss.xi);pos=0;slide(){const t=new Uint8Array(Ss.xi);this.pos-=Ss._i,t.set(this.buffer.subarray(Ss._i,Ss._i+this.pos),0),this.buffer=t}addBytes(t,e,s){this.pos+s>Ss.xi&&this.slide(),this.buffer.set(t.subarray(e,e+s),this.pos),this.pos+=s}addByte(t){this.pos===Ss.xi&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}class Bs{static Ti=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1];static Ni=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];static Pi=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1];static Ei=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];static Fi=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static Ci=Bs.Ai();static Ai(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return je.make(t,0,288,10)}Di=0;Li=0;oi=Xe.Block;Wi=!1;Oi=Bs.Ci;Ri=null;Gi=0;$i=0;Vi=0;Hi=null;Ui=0;zi;ji=[];Xi=new Ss;constructor(t){this.zi=t;for(let t=0;t<19;t++)this.ji.push(-1)}readBytes(t,e,s){if(this.Vi=s,this.Ui=e,this.Hi=t,s>0)for(;this.Ji(););return s-this.Vi}Ji(){switch(this.oi){case Xe.Head:const t=this.zi.readByte();if(8!==(15&t))throw new fe("Invalid data");const e=this.zi.readByte(),s=!!(32&e);if(((t<<8)+e)%31!=0)throw new fe("Invalid data");if(s)throw new fe("Unsupported dictionary");return this.oi=Xe.Block,!0;case Xe.Crc:return this.oi=Xe.Done,!0;case Xe.Done:return!1;case Xe.Block:switch(this.Wi=this.qi(),this.Yi(2)){case 0:this.Gi=ae.readUInt16LE(this.zi);if(ae.readUInt16LE(this.zi)!==65535-this.Gi)throw new fe("Invalid data");this.oi=Xe.Flat;const t=this.Ji();return this.Ki(),t;case 1:return this.Oi=Bs.Ci,this.Ri=null,this.oi=Xe.CData,!0;case 2:const e=this.Yi(5)+257,s=this.Yi(5)+1,i=this.Yi(4)+4;for(let t=0;t<i;t++)this.ji[Bs.Fi[t]]=this.Yi(3);for(let t=i;t<19;t++)this.ji[Bs.Fi[t]]=0;this.Oi=je.make(this.ji,0,19,8);const n=[];for(let t=0;t<e+s;t++)n.push(0);return this.Qi(n,e+s),this.Ri=je.make(n,e,s,16),this.Oi=je.make(n,0,e,16),this.oi=Xe.CData,!0;default:throw new fe("Invalid data")}case Xe.Flat:{const t=this.Gi<this.Vi?this.Gi:this.Vi,e=ae.readByteArray(this.zi,t);return this.Gi-=t,this.Zi(e,0,t),0===this.Gi&&(this.oi=this.Wi?Xe.Crc:Xe.Block),this.Vi>0}case Xe.DistOne:{const t=this.Gi<this.Vi?this.Gi:this.Vi;return this.tn(t),this.Gi-=t,0===this.Gi&&(this.oi=Xe.CData),this.Vi>0}case Xe.Dist:for(;this.Gi>0&&this.Vi>0;){const t=this.Gi<this.$i?this.Gi:this.$i,e=this.Vi<t?this.Vi:t;this.en(this.$i,e),this.Gi-=e}return 0===this.Gi&&(this.oi=Xe.CData),this.Vi>0;case Xe.CData:let i=this.sn(this.Oi);if(i<256)return this.nn(i),this.Vi>0;if(256===i)return this.oi=this.Wi?Xe.Crc:Xe.Block,!0;i=i-257&255;let n=Bs.Ti[i];if(-1===n)throw new fe("Invalid data");this.Gi=Bs.Ni[i]+this.Yi(n);const r=this.Ri,a=r?this.sn(r):this.rn(5);if(n=Bs.Pi[a],-1===n)throw new fe("Invalid data");if(this.$i=Bs.Ei[a]+this.Yi(n),this.$i>this.Xi.available())throw new fe("Invalid data");return this.oi=1===this.$i?Xe.DistOne:Xe.Dist,!0}return!1}tn(t){const e=this.Xi.getLastChar();for(let s=0;s<t;s++)this.nn(e)}nn(t){this.Xi.addByte(t),this.Hi[this.Ui]=t,this.Vi--,this.Ui++}en(t,e){this.Zi(this.Xi.buffer,this.Xi.pos-t,e)}qi(){0===this.Di&&(this.Di=8,this.Li=this.zi.readByte());const t=!(1&~this.Li);return this.Di--,this.Li=this.Li>>1,t}Yi(t){for(;this.Di<t;)this.Li=this.Li|this.zi.readByte()<<this.Di,this.Di+=8;const e=this.Li&(1<<t)-1;return this.Di-=t,this.Li=this.Li>>t,e}rn(t){return 0===t?0:this.qi()?1<<t-1|this.rn(t-1):this.rn(t-1)}Ki(){this.Li=0,this.Di=0}Zi(t,e,s){this.Xi.addBytes(t,e,s),this.Hi.set(t.subarray(e,e+s),this.Ui),this.Vi-=s,this.Ui+=s}Qi(t,e){let s=0,i=0;for(;s<e;){const n=this.sn(this.Oi);switch(n){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=n,t[s]=n,s++;break;case 16:const r=s+3+this.Yi(2);if(r>e)throw new fe("Invalid data");for(;s<r;)t[s]=i,s++;break;case 17:if(s+=3+this.Yi(3),s>e)throw new fe("Invalid data");break;case 18:if(s+=11+this.Yi(7),s>e)throw new fe("Invalid data");break;default:throw new fe("Invalid data")}}}sn(t){if(t instanceof He)return t.n;if(t instanceof Ue)return this.sn(this.qi()?t.right:t.left);if(t instanceof ze)return this.sn(t.table[this.Yi(t.n)]);throw new fe("Invalid data")}}class _s{static OptionalDataDescriptorSignature=134695760;static CompressionMethodDeflate=8;static LocalFileHeaderSignature=67324752;static CentralFileHeaderSignature=33639248;static EndOfCentralDirSignature=101010256;fullName;fileName;data;constructor(t,e){this.fullName=t;const s=t.lastIndexOf("/");this.fileName=-1===s||s===t.length-1?this.fullName:t.substr(s+1),this.data=e}}class xs{an;constructor(t){this.an=t}read(){const t=[];for(;;){const e=this.hn();if(!e)break;t.push(e)}return t}hn(){const t=this.an;if(ae.readInt32LE(t)!==_s.LocalFileHeaderSignature)return null;ae.readUInt16LE(t);const e=ae.readUInt16LE(t),s=ae.readUInt16LE(t),i=0!==s;if(i&&s!==_s.CompressionMethodDeflate)return null;ae.readInt16LE(this.an),ae.readInt16LE(this.an),ae.readInt32LE(t),ae.readInt32LE(t);const n=ae.readInt32LE(t),r=ae.readInt16LE(t),a=ae.readInt16LE(t),h=ae.toString(ae.readByteArray(t,r),"utf-8");let o;if(t.skip(a),i){const t=Re.empty(),e=new Bs(this.an),s=new Uint8Array(65536);for(;;){const i=e.readBytes(s,0,s.length);if(t.write(s,0,i),i<s.length)break}o=t.toArray()}else o=ae.readByteArray(this.an,n);if(8&e){ae.readInt32LE(this.an)===_s.OptionalDataDescriptorSignature&&ae.readInt32LE(this.an),ae.readInt32LE(this.an),ae.readInt32LE(this.an)}return new _s(h,o)}}!function(t){t[t.None=0]="None",t[t.Element=1]="Element",t[t.Text=2]="Text",t[t.CDATA=3]="CDATA",t[t.Document=4]="Document",t[t.DocumentType=5]="DocumentType",t[t.Comment=6]="Comment"}(Je||(Je={}));class Ts{nodeType=Je.None;localName=null;value=null;childNodes=[];attributes=new Map;firstChild=null;firstElement=null;*childElements(){for(const t of this.childNodes)t.nodeType===Je.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,t.nodeType!==Je.Element&&t.nodeType!==Je.CDATA||(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this.cn(this.childNodes,s,t,e),s}cn(t,e,s,i=!1){for(const n of t)n&&n.nodeType===Je.Element&&n.localName===s&&e.push(n),i&&this.cn(n.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===Je.Element&&e.localName===t)return e;return null}addElement(t){const e=new Ts;return e.nodeType=Je.Element,e.localName=t,this.addChild(e),e}get innerText(){if(this.nodeType===Je.Element||this.nodeType===Je.Document){if(this.firstElement&&this.firstElement.nodeType===Je.CDATA)return this.firstElement.innerText;let t="";for(const e of this.childNodes)t+=e.innerText?.toString();return t.trim()}return this.value??""}set innerText(t){const e=new Ts;e.nodeType=Je.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new Ts;e.nodeType=Je.CDATA,e.value=t,this.childNodes=[e]}}class Ms extends W{xml;pos=0;constructor(t,e,i){super(s.Format,t),this.xml=e,this.pos=i}}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.BeginNode=2]="BeginNode",t[t.TagName=3]="TagName",t[t.Body=4]="Body",t[t.AttribName=5]="AttribName",t[t.Equals=6]="Equals",t[t.AttvalBegin=7]="AttvalBegin",t[t.AttribVal=8]="AttribVal",t[t.Childs=9]="Childs",t[t.Close=10]="Close",t[t.WaitEnd=11]="WaitEnd",t[t.WaitEndRet=12]="WaitEndRet",t[t.Pcdata=13]="Pcdata",t[t.Header=14]="Header",t[t.Comment=15]="Comment",t[t.Doctype=16]="Doctype",t[t.Cdata=17]="Cdata",t[t.Escape=18]="Escape"}(qe||(qe={}));class vs{static CharCodeLF=10;static CharCodeTab=9;static CharCodeCR=13;static CharCodeSpace=32;static CharCodeLowerThan=60;static CharCodeAmp=38;static CharCodeBrackedClose=93;static CharCodeBrackedOpen=91;static CharCodeGreaterThan=62;static CharCodeExclamation=33;static CharCodeUpperD=68;static CharCodeLowerD=100;static CharCodeMinus=45;static CharCodeQuestion=63;static CharCodeSlash=47;static CharCodeEquals=61;static CharCodeDoubleQuote=34;static CharCodeSingleQuote=39;static CharCodeSharp=35;static CharCodeLowerX=120;static CharCodeLowerA=97;static CharCodeLowerZ=122;static CharCodeUpperA=65;static CharCodeUpperZ=90;static CharCode0=48;static CharCode9=57;static CharCodeColon=58;static CharCodeDot=46;static CharCodeUnderscore=95;static CharCodeSemi=59;static ln=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);static parse(t,e,s){let i=t.charCodeAt(e),n=qe.Begin,r=qe.Begin,a=0,h="",o=qe.Begin,c=null,l=null,u=0,d=0;for(;e<t.length;){switch(i=t.charCodeAt(e),n){case qe.IgnoreSpaces:switch(i){case vs.CharCodeLF:case vs.CharCodeCR:case vs.CharCodeTab:case vs.CharCodeSpace:break;default:n=r;continue}break;case qe.Begin:if(i!==vs.CharCodeLowerThan){a=e,n=qe.Pcdata;continue}n=qe.IgnoreSpaces,r=qe.BeginNode;break;case qe.Pcdata:if(i===vs.CharCodeLowerThan){h+=t.substr(a,e-a);const i=new Ts;i.nodeType=Je.Text,i.value=h,h="",s.addChild(i),n=qe.IgnoreSpaces,r=qe.BeginNode}else i===vs.CharCodeAmp&&(h+=t.substr(a,e-a),n=qe.Escape,o=qe.Pcdata,a=e+1);break;case qe.Cdata:if(i===vs.CharCodeBrackedClose&&t.charCodeAt(e+1)===vs.CharCodeBrackedClose&&t.charCodeAt(e+2)===vs.CharCodeGreaterThan){const i=new Ts;i.nodeType=Je.CDATA,i.value=t.substr(a,e-a),s.addChild(i),e+=2,n=qe.Begin}break;case qe.BeginNode:switch(i){case vs.CharCodeExclamation:if(t.charCodeAt(e+1)===vs.CharCodeBrackedOpen){if(e+=2,"CDATA["!==t.substr(e,6).toUpperCase())throw new Ms("Expected <![CDATA[",t,e);e+=5,n=qe.Cdata,a=e+1}else if(t.charCodeAt(e+1)===vs.CharCodeUpperD||t.charCodeAt(e+1)===vs.CharCodeLowerD){if("OCTYPE"!==t.substr(e+2,6).toUpperCase())throw new Ms("Expected <!DOCTYPE",t,e);e+=8,n=qe.Doctype,a=e+1}else{if(t.charCodeAt(e+1)!==vs.CharCodeMinus||t.charCodeAt(e+2)!==vs.CharCodeMinus)throw new Ms("Expected \x3c!--",t,e);e+=2,n=qe.Comment,a=e+1}break;case vs.CharCodeQuestion:n=qe.Header,a=e;break;case vs.CharCodeSlash:if(!s)throw new Ms("Expected node name",t,e);a=e+1,n=qe.IgnoreSpaces,r=qe.Close;break;default:n=qe.TagName,a=e;continue}break;case qe.TagName:if(!vs.un(i)){if(e===a)throw new Ms("Expected node name",t,e);c=new Ts,c.nodeType=Je.Element,c.localName=t.substr(a,e-a),s.addChild(c),n=qe.IgnoreSpaces,r=qe.Body;continue}break;case qe.Body:switch(i){case vs.CharCodeSlash:n=qe.WaitEnd;break;case vs.CharCodeGreaterThan:n=qe.Childs;break;default:n=qe.AttribName,a=e;continue}break;case qe.AttribName:if(!vs.un(i)){if(a===e)throw new Ms("Expected attribute name",t,e);if(l=t.substr(a,e-a),c.attributes.has(l))throw new Ms(`Duplicate attribute [${l}]`,t,e);n=qe.IgnoreSpaces,r=qe.Equals;continue}break;case qe.Equals:if(i!==vs.CharCodeEquals)throw new Ms("Expected =",t,e);n=qe.IgnoreSpaces,r=qe.AttvalBegin;break;case qe.AttvalBegin:switch(i){case vs.CharCodeDoubleQuote:case vs.CharCodeSingleQuote:h="",n=qe.AttribVal,a=e+1,d=i}break;case qe.AttribVal:if(i===vs.CharCodeAmp)h+=t.substr(a,e-a),n=qe.Escape,o=qe.AttribVal,a=e+1;else if(i===d){h+=t.substr(a,e-a);const s=h;h="",c.attributes.set(l,s),n=qe.IgnoreSpaces,r=qe.Body}break;case qe.Childs:a=e=vs.parse(t,e,c),n=qe.Begin;break;case qe.WaitEnd:if(i!==vs.CharCodeGreaterThan)throw new Ms("Expected >",t,e);n=qe.Begin;break;case qe.WaitEndRet:if(i===vs.CharCodeGreaterThan)return e;throw new Ms("Expected >",t,e);case qe.Close:if(!vs.un(i)){if(a===e)throw new Ms("Expected node name",t,e);if(t.substr(a,e-a)!==s.localName)throw new Ms(`Expected </${s.localName}>`,t,e);n=qe.IgnoreSpaces,r=qe.WaitEndRet;continue}break;case qe.Comment:i===vs.CharCodeMinus&&t.charCodeAt(e+1)===vs.CharCodeMinus&&t.charCodeAt(e+2)===vs.CharCodeGreaterThan&&(e+=2,n=qe.Begin);break;case qe.Doctype:if(i===vs.CharCodeBrackedOpen)u++;else if(i===vs.CharCodeBrackedClose)u--;else if(i===vs.CharCodeGreaterThan&&0===u){const i=new Ts;i.nodeType=Je.DocumentType,i.value=t.substr(a,e-a),s.addChild(i),n=qe.Begin}break;case qe.Header:i===vs.CharCodeQuestion&&t.charCodeAt(e+1)===vs.CharCodeGreaterThan&&(e++,n=qe.Begin);break;case qe.Escape:if(i===vs.CharCodeSemi){const s=t.substr(a,e-a);if(s.charCodeAt(0)===vs.CharCodeSharp){const t=s.charCodeAt(1)===vs.CharCodeLowerX?Number.parseInt(`0${s.substr(1,s.length-1)}`,10):Number.parseInt(s.substr(1,s.length-1),10);h+=String.fromCharCode(t)}else vs.ln.has(s)?h+=vs.ln.get(s):h+=`&${s};`?.toString();a=e+1,n=o}else vs.un(i)||i===vs.CharCodeSharp||(h+="&",h+=t.substr(a,e-a),a=--e+1,n=o)}e++}if(n===qe.Begin&&(a=e,n=qe.Pcdata),n===qe.Pcdata){if(e!==a){h+=t.substr(a,e-a);const i=new Ts;i.nodeType=Je.Text,i.value=h,s.addChild(i)}return e}if(n===qe.Escape&&o===qe.Pcdata){h+="&",h+=t.substr(a,e-a);const i=new Ts;return i.nodeType=Je.Text,i.value=h,s.addChild(i),e}throw new Ms("Unexpected end",t,e)}static un(t){return t>=vs.CharCodeLowerA&&t<=vs.CharCodeLowerZ||t>=vs.CharCodeUpperA&&t<=vs.CharCodeUpperZ||t>=vs.CharCode0&&t<=vs.CharCode9||t===vs.CharCodeColon||t===vs.CharCodeDot||t===vs.CharCodeUnderscore||t===vs.CharCodeMinus}}class Ns{dn=[];pn;bn;mn;gn;constructor(t,e){this.pn=t,this.bn=e,this.gn="",this.mn=!0}writeNode(t){switch(t.nodeType){case Je.None:break;case Je.Element:this.dn.length>0&&this.wn(),this.yn(`<${t.localName}`);for(const[e,s]of t.attributes)this.yn(` ${e}="`),this.kn(s),this.yn('"');if(0===t.childNodes.length)this.yn("/>");else{if(this.yn(">"),1!==t.childNodes.length||t.firstElement){this.Sn();for(const e of t.childNodes)e.nodeType!==Je.Element&&e.nodeType!==Je.Comment||this.writeNode(e);this.Bn(),this.wn()}else this.writeNode(t.childNodes[0]);this.yn(`</${t.localName}>`)}break;case Je.Text:t.value&&this.yn(t.value);break;case Je.CDATA:null!==t.value&&this.yn(`<![CDATA[${t.value}]]>`);break;case Je.Document:this.bn&&this.yn('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case Je.DocumentType:this.yn(`<!DOCTYPE ${t.value}>`);break;case Je.Comment:this.yn(`\x3c!-- ${t.value} --\x3e`)}}Bn(){this.gn=this.gn.substr(0,this.gn.length-this.pn.length)}Sn(){this.gn+=this.pn}kn(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this.dn.push("&lt;");break;case">":this.dn.push("&gt;");break;case"&":this.dn.push("&amp;");break;case"'":this.dn.push("&apos;");break;case'"':this.dn.push("&quot;");break;default:this.dn.push(s)}}}static write(t,e,s){const i=new Ns(e,s);return i.writeNode(t),i.toString()}yn(t){this.mn&&this.dn.push(this.gn),this.dn.push(t),this.mn=!1}wn(t=null){t&&this.yn(t),this.pn.length>0&&!this.mn&&(this.dn.push("\n"),this.mn=!0)}toString(){return this.dn.join("").trimRight()}}class Ps extends Ts{constructor(){super(),this.nodeType=Je.Document}parse(t){vs.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return Ns.write(this,t,e)}}class Es{noteRange=1;x=0;y=0}!function(t){t[t.None=0]="None",t[t.Rectangle=1]="Rectangle",t[t.Ellipse=2]="Ellipse",t[t.Circle=3]="Circle"}(Ye||(Ye={}));class Fs extends Es{align=et.Left;frame=Ye.None;text="";fontFace="";weight=0;height=0}class Cs extends Es{chord=new de}class As extends Es{}class Ds extends Es{}class Ls extends Es{number=0}class Ws extends Es{decrescendo=!1}class Os extends Es{allNumbers=!1;firstNumber=0;lastNumber=0}class Rs extends Es{octave=1}class Is extends Es{}class Gs{defaultClef=N.G2;description="";percussion=!1;instrument=0;volume=0;transpose=0;index=0}class $s{from=0;to=0;curly=!1}class Vs{currentBarIndex=-1;currentBarComplete=!0;currentBarDuration=0;currentPosition=0;voiceStemDir=null;repeatCount=0;repeatEnd=null}class Hs{score;_n=0;xn=gt.Auto;Tn;Mn;vn=!0;Nn=-1;parseXml(t,e){this.Tn=new Map,this.Pn=[],this.En=new Map,this.Mn=new Map,this.Fn=new Map,this.Cn=new Map,this.vn=!0;const s=new Ps;try{s.parse(t)}catch(t){throw new Oe("Could not parse XML",t)}this.An(s),this.Dn(),this.score.finish(e)}Dn(){Vt.consolidate(this.score),Hs.Ln(this.Fn,(t,e)=>{e.isLegatoOrigin=!0}),Hs.Ln(this.Cn,(t,e)=>{e.crescendo=t.decrescendo?o.Decrescendo:o.Crescendo})}static Ln(t,e){for(const[s,i]of t){const t=i.noteRange;let n=s;for(let s=0;s<t;s++)if(e(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else{if(!(n.voice.bar.index+1<n.voice.bar.staff.bars.length))break;n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0]}}}An(t){const e=t.firstElement;if(!e)throw new Oe("No valid XML");if("score"!==e.localName)throw new Oe('Root node of XML was not "score"');this.score=new Ot;for(const t of e.childElements())switch(t.localName){case"info":this.Wn(t);break;case"layout":this.On(t);break;case"gallery":this.Rn(t);break;case"pageObjects":this.In(t);break;case"systems":this.Gn(t)}}$n=new Map;On(t){for(const e of t.childElements())switch(e.localName){case"staves":this.Vn(e);break;case"brackets":this.Hn(e)}const e=this.Un.filter(t=>!!t.curly);e.sort((t,e)=>t.from-e.from);let s=0,i=null;for(let t=0;t<this.zn.length;t++){const n=this.zn[t];for(;s<e.length&&t>e[s].to;)s++;i&&s<e.length&&t>e[s].from&&t<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new Be,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._n++,i.playbackInfo.secondaryChannel=this._n++),this.score.addTrack(i));const r=i.staves[i.staves.length-1];r.isPercussion=n.percussion,r.transpositionPitch=n.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this.$n.set(n.index,r)}}Un=[];Hn(t){for(const e of t.childElements())if("bracket"===e.localName)this.jn(e)}jn(t){const e=new $s;e.from=Number.parseInt(t.getAttribute("from"),10),e.to=Number.parseInt(t.getAttribute("to"),10),t.attributes.has("curly")&&(e.curly="true"===t.attributes.get("curly")),this.Un.push(e)}Vn(t){for(const e of t.childElements())if("staffLayout"===e.localName)this.Xn(e)}Jn=new Map;zn=[];Xn(t){const e=new Gs;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this.qn(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this.Jn.set(e.description,e),e.index=this.zn.length,this.zn.push(e)}qn(t){switch(t){case"treble":return N.G2;case"bass":return N.F4;case"alto":case"tenor":return N.C4}return N.G2}Yn(t){return t.endsWith("-")?b.T:t.endsWith("+")?b._:b.Regular}Gn(t){for(const e of t.childElements())if("system"===e.localName)this.Kn(e)}Kn(t){t.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.Nn=Number.parseInt(t.attributes.get("tempo"),10)),"0"===t.getAttribute("beamGrouping")&&(this.xn=gt.ForceSplitToNext);for(const e of t.childElements())if("staves"===e.localName)this.Qn(t,e);this.vn=!1}Qn(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())if("staff"===i.localName)this.Zn(t,s,i)}tr=new Rt;er;Zn(t,e,s){const i=s.getAttribute("layout");this.er=this.Jn.get(i),this.tr.timeSignatureNumerator=4,this.tr.timeSignatureDenominator=4,this.tr.timeSignatureCommon=!1,this.sr(s.getAttribute("defaultTime"));const n=this.$n.get(this.er.index);for(;n.bars.length<e;)this.ir(n);for(const r of s.childElements())if("voices"===r.localName)this.nr(i,n,t,e,r)}sr(t){switch(t){case"allaBreve":case"C":this.tr.timeSignatureNumerator=2,this.tr.timeSignatureDenominator=2,this.tr.timeSignatureCommon=!0;break;case"longAllaBreve":this.tr.timeSignatureNumerator=4,this.tr.timeSignatureDenominator=4,this.tr.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this.tr.timeSignatureNumerator=Number.parseInt(e[0],10),this.tr.timeSignatureDenominator=Number.parseInt(e[1],10),this.tr.timeSignatureCommon=!1}}}nr(t,e,s,i,n){let r=0;for(const a of n.childElements())if("voice"===a.localName)this.rr(t,e,s,r,i,a),r++}ar(t,e){return e<t.bars.length?t.bars[e]:this.ir(t)}ir(t){const e=new K;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this.er.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const t=new Rt;this.score.addMasterBar(t),t.index>0?t.tripletFeel=t.previousMasterBar.tripletFeel:this.Nn>0&&t.tempoAutomations.push(G.buildTempoAutomation(!1,0,this.Nn,0)),t.timeSignatureDenominator=this.tr.timeSignatureDenominator,t.timeSignatureNumerator=this.tr.timeSignatureNumerator,t.timeSignatureCommon=this.tr.timeSignatureCommon}return e}hr=new Map;cr;lr;ur;pi(t,e){this.cr.currentBarIndex++,this.lr=this.ar(t,this.cr.currentBarIndex),this.cr.currentBarDuration=this.lr.masterBar.calculateDuration(!1),this.cr.currentBarComplete=!1,this.cr.currentPosition=0,this.dr(t,e)}rr(t,e,s,i,r,a){const h=`${t}_${i}`;if(this.cr&&!this.cr.currentBarComplete&&(this.lr.masterBar.isAnacrusis=!0),this.hr.has(h)?(this.cr=this.hr.get(h),this.lr=this.ar(e,this.cr.currentBarIndex),this.dr(e,i)):(this.cr=new Vs,this.cr.currentBarIndex=r-1,this.hr.set(h,this.cr),this.pi(e,i)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this.cr.voiceStemDir=Ct.Up;break;case"down":this.cr.voiceStemDir=Ct.Down;break;default:this.cr.voiceStemDir=null}else this.cr.voiceStemDir=null;const o=a.findChildElement("noteObjects");if(s.attributes.has("tempo")){const t=new G;t.isLinear=!0,t.type=n.Tempo,t.value=Number.parseInt(s.attributes.get("tempo"),10),t.ratioPosition=this.cr.currentPosition/this.cr.currentBarDuration,this.lr.masterBar.tempoAutomations.push(t)}if(o)for(const t of o.childElements())switch(this.cr.currentBarComplete&&"barline"!==t.localName&&this.pi(e,i),t.localName){case"clefSign":this.lr.clef=this.qn(t.getAttribute("clef")),this.lr.clefOttava=this.Yn(t.getAttribute("clef"));break;case"keySign":this.lr.keySignature=Number.parseInt(t.getAttribute("fifths"),10);break;case"timeSign":this.sr(t.getAttribute("time")),this.lr.masterBar.timeSignatureDenominator=this.tr.timeSignatureDenominator,this.lr.masterBar.timeSignatureNumerator=this.tr.timeSignatureNumerator,this.lr.masterBar.timeSignatureCommon=this.tr.timeSignatureCommon,this.cr.currentPosition=0,this.cr.currentBarDuration=this.lr.masterBar.calculateDuration(!1);break;case"barline":switch(t.getAttribute("type")){case"double":this.lr.barLineRight=D.LightLight,this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0;break;case"end":this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0);break;case"repEnd":this.cr.repeatEnd=this.lr.masterBar,this.lr.masterBar.repeatCount<this.cr.repeatCount&&(this.lr.masterBar.repeatCount=this.cr.repeatCount),this.pr(t),this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0;break;case"repBegin":this.pi(e,i),this.lr.masterBar.isRepeatStart=!0,this.cr.repeatEnd=null,this.cr.repeatCount=0;break;case"repEndBegin":this.cr.repeatEnd=this.lr.masterBar,this.lr.masterBar.repeatCount<this.cr.repeatCount&&(this.lr.masterBar.repeatCount=this.cr.repeatCount),this.pr(t),this.pi(e,i),this.lr.masterBar.isRepeatStart=!0;break;default:this.cr.currentBarComplete||(this.lr.masterBar.isAnacrusis=!0),this.cr.currentBarComplete=!0}break;case"chord":const s=new Yt;this.br(s,this.ur),s.beamingMode=this.xn,this.cr.voiceStemDir&&(s.preferredBeamDirection=this.cr.voiceStemDir),this.mi(s,t.findChildElement("duration")),s.updateDurations(),this.cr.currentPosition+=s.playbackDuration,this.ur.addBeat(s),this.mr(s,t),this.cr.currentPosition>=this.cr.currentBarDuration&&(this.cr.currentBarComplete=!0);break;case"rest":const n=this.gr(t.findChildElement("duration"));n&&(this.br(n,this.ur),n.updateDurations(),this.cr.currentPosition+=n.playbackDuration,this.ur.addBeat(n),this.cr.currentPosition>=this.cr.currentBarDuration&&(this.cr.currentBarComplete=!0))}}br(t,e){const s=this.wr(e);s&&(t.dynamics=s.dynamics)}wr(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length){const s=e.voices[t.index];return this.wr(s)}}return null}dr(t,e){for(;this.lr.voices.length<e+1;)this.lr.addVoice(new tt);(!this.Mn.has(t.track.index)||this.Mn.get(t.track.index)<this.lr.voices.length)&&this.Mn.set(t.track.index,this.lr.voices.length),this.ur=this.lr.voices[e]}mr(t,e){const s=new Xt;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=Ct.Up;break;case"down":t.preferredBeamDirection=Ct.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=u.Normal;break;case"strongAccent":s.accentuated=u.Heavy}break;case"lyric":this.yr(t,i);break;case"drawObjects":this.kr(t,i);break;case"heads":this.Sr(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=gt.ForceMergeWithNext;break;case"divide":t.beamingMode=gt.ForceSplitToNext}}}Sr(t,e,s){for(const i of s.childElements())if("head"===i.localName)this.Br(t,e,i)}Pn;En;Fn;Cn;Br(t,e,s){const i=new Xt,n=Vt.parseTuning(s.getAttribute("pitch"));i.octave=n.octave-1,i.tone=n.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const t of s.childElements())switch(t.localName){case"alter":t.attributes.has("step")&&(i.tone+=Number.parseInt(t.attributes.get("step"),10));break;case"tie":t.attributes.has("begin")?this.En.has(i.id)||(this.En.set(i.id,!0),this.Pn.push(i)):t.attributes.has("end")&&this.Pn.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this.Pn[0],this.Pn.splice(0,1),this.En.delete(i.id))}}kr(t,e){for(const s of e.childElements())if("drawObj"===s.localName){const e=this._r(s);if(e)if(e instanceof Fs)e.fontFace.startsWith("capella")?"u"===e.text?(t.fermata=new be,t.fermata.type=Nt.Medium):"f"===e.text?t.dynamics=i.F:"j"===e.text&&(t.dynamics=i.MF):this.vn&&""===this.score.title&&e.align===et.Center&&e.height>16&&e.weight>400?this.score.title=e.text:this.vn&&""===this.score.artist&&e.align===et.Center&&e.y<0?this.score.artist=e.text:this.vn&&""===this.score.music&&e.align===et.Right&&e.y<0?this.score.music=e.text:e.text.startsWith("by capella")||(t.text=e.text);else if(e instanceof Cs);else if(e instanceof Ds)t.vibrato=w.Slight;else if(e instanceof Ws)t.crescendo=e.decrescendo?o.Decrescendo:o.Crescendo,e.noteRange++,this.Cn.set(t,e);else if(e instanceof As){const s=e;this.Fn.set(t,s)}else e instanceof Os&&this.Tr(e)}}pr(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);t&&t instanceof Os&&this.Tr(t)}}Tr(t){if(t.lastNumber>0?(this.cr.repeatCount=t.lastNumber,this.cr.repeatEnd&&this.cr.repeatEnd.repeatCount<this.cr.repeatCount&&(this.cr.repeatEnd.repeatCount=this.cr.repeatCount)):t.firstNumber>0&&(this.cr.repeatCount=t.firstNumber,this.cr.repeatEnd&&this.cr.repeatEnd.repeatCount<this.cr.repeatCount&&(this.cr.repeatEnd.repeatCount=this.cr.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e|=1<<s-1;this.lr.masterBar.alternateEndings=e}else t.lastNumber>0?this.lr.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this.lr.masterBar.alternateEndings=1<<t.firstNumber-1)}yr(t,e){for(const s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let e=s.innerText;"true"===s.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}gr(t){const e=t.getAttribute("base");if(-1!==e.indexOf("/")){const e=new Yt;return e.beamingMode=this.xn,this.mi(e,t),e}if(1===Number.parseInt(e,10)){const t=new Yt;return t.beamingMode=this.xn,t.duration=c.Whole,t}return z.warning("Importer","Multi-Bar rests are not supported"),null}Mr(t){switch(t){case"2/1":return c.DoubleWhole;case"1/1":return c.Whole;case"1/2":return c.Half;case"1/4":return c.Quarter;case"1/8":return c.Eighth;case"1/16":return c.Sixteenth;case"1/32":return c.ThirtySecond;case"1/64":return c.SixtyFourth;case"1/128":return c.OneHundredTwentyEighth;default:return z.warning("Importer","Unsupported duration"),c.Quarter}}mi(t,e){const s=e.getAttribute("base");t.duration=this.Mr(s),e.attributes.has("dots")&&(t.dots=Number.parseInt(e.attributes.get("dots"),10));const i=e.findChildElement("tuplet");if(i){t.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const e="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1;let n=0;for(;e*Math.pow(2,n+s)<t.tupletNumerator;)n++;t.tupletDenominator=e*Math.pow(2,n)}}In(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);if(t&&t instanceof Fs)switch(t.align){case et.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case et.Right:this.score.artist||(this.score.artist=e.innerText)}}}Rn(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this._r(e);t&&this.Tn.set(e.getAttribute("name"),t)}}_r(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this.vr(i);break;case"guitar":e=this.Nr(i);break;case"slur":e=this.Pr(i);break;case"wavyLine":e=this.Er(i);break;case"bracket":e=this.Fr(i);break;case"wedge":e=this.Cr(i);break;case"volta":e=this.Ar(i);break;case"octaveClef":e=this.Dr(i);break;case"trill":e=this.Lr(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return e&&(e.noteRange=s),e}Lr(t){return new Is}Dr(t){const e=new Rs;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"),10)),e}Ar(t){const e=new Os;return e.allNumbers="true"===t.attributes.get("allNumbers"),t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"),10)),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"),10)),e}Cr(t){const e=new Ws;return e.decrescendo="true"===t.attributes.get("decrescendo"),e}Fr(t){const e=new Ls;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"),10)),e}Er(t){return new Ds}Pr(t){return new As}Nr(t){const e=new Cs,s=t.innerText.trim();for(let t=0;t<s.length;t++)"/"===s.charAt(t)?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(t),10));return e}vr(t){const e=new Fs;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=et.Left;break;case"center":e.align=et.Center;break;case"right":e.align=et.Right}switch(t.getAttribute("frame")){case"rectangle":e.frame=Ye.Rectangle;break;case"ellipse":e.frame=Ye.Ellipse;break;case"circle":e.frame=Ye.Circle;break;case"none":e.frame=Ye.None}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":e.text=s.innerText}else e.text=t.innerText;return e}Wn(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText}}}class Us extends We{get name(){return"Capella"}readScore(){z.debug(this.name,"Loading ZIP entries");let t,e=null;if(t=new xs(this.data).read(),z.debug(this.name,"Zip entries loaded"),t.length>0){for(const s of t)if("score.xml"===s.fileName)e=ae.toString(s.data,this.settings.importer.encoding)}else this.data.reset(),e=ae.toString(this.data.readAll(),this.settings.importer.encoding);if(!e)throw new Oe("No valid capella file");z.debug(this.name,"Start Parsing score.xml");try{const t=new Hs;t.parseXml(e,this.settings),z.debug(this.name,"score.xml parsed");return t.score}catch(t){throw new Oe("Failed to parse CapXML",t)}}}!function(t){t[t.TargetFine=0]="TargetFine",t[t.TargetSegno=1]="TargetSegno",t[t.TargetSegnoSegno=2]="TargetSegnoSegno",t[t.TargetCoda=3]="TargetCoda",t[t.TargetDoubleCoda=4]="TargetDoubleCoda",t[t.JumpDaCapo=5]="JumpDaCapo",t[t.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",t[t.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",t[t.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",t[t.JumpDalSegno=9]="JumpDalSegno",t[t.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",t[t.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",t[t.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",t[t.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",t[t.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",t[t.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",t[t.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",t[t.JumpDaCoda=17]="JumpDaCoda",t[t.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"}(Ke||(Ke={}));class zs extends We{static Wr="FICHIER GUITAR PRO ";Or=0;ue;Rr=nt.NoTripletFeel;Ir=0;Gr=[];$r=0;Vr=0;Hr=[];Ur=new Set;zr=new Map;jr=new Map;Xr=new Map;Jr=new Map;Nn;get name(){return"Guitar Pro 3-5"}readScore(){if(this.Jr.clear(),this.readVersion(),this.ue=new Ot,this.readScoreInformation(),this.Or<500&&(this.Rr=js.gpReadBool(this.data)?nt.Triplet8th:nt.NoTripletFeel),this.Or>=400&&this.readLyrics(),this.Or>=510&&this.data.skip(19),this.Nn=G.buildTempoAutomation(!1,0,0,0),this.Or>=500&&(this.readPageSetup(),this.Nn.text=js.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this.Nn.value=ae.readInt32LE(this.data),this.Or>=510&&js.gpReadBool(this.data),ae.readInt32LE(this.data),this.Or>=400&&this.data.readByte(),this.readPlaybackInfos(),this.Or>=500&&(this.qr(Ke.TargetCoda),this.qr(Ke.TargetDoubleCoda),this.qr(Ke.TargetSegno),this.qr(Ke.TargetSegnoSegno),this.qr(Ke.TargetFine),this.qr(Ke.JumpDaCapo),this.qr(Ke.JumpDaCapoAlCoda),this.qr(Ke.JumpDaCapoAlDoubleCoda),this.qr(Ke.JumpDaCapoAlFine),this.qr(Ke.JumpDalSegno),this.qr(Ke.JumpDalSegnoAlCoda),this.qr(Ke.JumpDalSegnoAlDoubleCoda),this.qr(Ke.JumpDalSegnoAlFine),this.qr(Ke.JumpDalSegnoSegno),this.qr(Ke.JumpDalSegnoSegnoAlCoda),this.qr(Ke.JumpDalSegnoSegnoAlDoubleCoda),this.qr(Ke.JumpDalSegnoSegnoAlFine),this.qr(Ke.JumpDaCoda),this.qr(Ke.JumpDaDoubleCoda),this.data.skip(4)),this.$r=ae.readInt32LE(this.data),this.Vr=ae.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this.ue.masterBars.length>0){const t=G.buildTempoAutomation(!1,0,this.ue.tempo,2);t.text=this.ue.tempoLabel,this.ue.masterBars[0].tempoAutomations.push(t)}return Vt.consolidate(this.ue),this.ue.finish(this.settings),this.Gr&&this.Ir>=0&&this.ue.tracks[this.Ir].applyLyrics(this.Gr),this.ue}qr(t){let e,s=ae.readInt16LE(this.data);-1!==s&&(s--,this.Jr.has(s)?e=this.Jr.get(s):(e=[],this.Jr.set(s,e)),e.push(t))}readVersion(){let t=js.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!t.startsWith(zs.Wr))throw new Oe("Unsupported format");t=t.substr(zs.Wr.length+1);const e=t.indexOf(String.fromCharCode(46));this.Or=100*Number.parseInt(t.substr(0,e),10)+Number.parseInt(t.substr(e+1),10),z.debug(this.name,`Guitar Pro version ${t} detected`)}readScoreInformation(){this.ue.title=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.subTitle=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.artist=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.album=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.words=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.music=this.Or>=500?js.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this.ue.words,this.ue.copyright=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.tab=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.ue.instructions=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const t=ae.readInt32LE(this.data);let e="";for(let s=0;s<t;s++)s>0&&(e+="\r\n"),e+=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this.ue.notices=e}readLyrics(){this.Gr=[],this.Ir=ae.readInt32LE(this.data)-1;for(let t=0;t<5;t++){const t=new me;t.startBar=ae.readInt32LE(this.data)-1,t.text=js.gpReadStringInt(this.data,this.settings.importer.encoding),this.Gr.push(t)}}readPageSetup(){this.data.skip(28);const t=ae.readInt16LE(this.data);Vt.getOrCreateHeaderFooterStyle(this.ue,it.Title).isVisible=!!(1&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Title).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.SubTitle).isVisible=!!(2&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.SubTitle).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Artist).isVisible=!!(4&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Artist).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Album).isVisible=!!(8&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Album).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Words).isVisible=!!(16&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Words).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Music).isVisible=!!(32&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Music).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.WordsAndMusic).isVisible=!!(64&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.WordsAndMusic).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Copyright).isVisible=!!(128&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.Copyright).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),Vt.getOrCreateHeaderFooterStyle(this.ue,it.CopyrightSecondLine).isVisible=!!(128&t),Vt.getOrCreateHeaderFooterStyle(this.ue,it.CopyrightSecondLine).template=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),js.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this.Hr=[];let t=0;for(let e=0;e<64;e++){const e=new ke;e.primaryChannel=t++,e.secondaryChannel=t++,e.program=ae.readInt32LE(this.data),e.volume=this.data.readByte(),e.balance=this.data.readByte(),this.data.skip(6),this.Hr.push(e)}}readMasterBars(){for(let t=0;t<this.$r;t++)this.readMasterBar()}readMasterBar(){let t=null;this.ue.masterBars.length>0&&(t=this.ue.masterBars[this.ue.masterBars.length-1]);const e=new Rt;!t&&this.Nn.value>0&&e.tempoAutomations.push(this.Nn);const s=this.data.readByte();if(1&s?e.timeSignatureNumerator=this.data.readByte():t&&(e.timeSignatureNumerator=t.timeSignatureNumerator),2&s?e.timeSignatureDenominator=this.data.readByte():t&&(e.timeSignatureDenominator=t.timeSignatureDenominator),e.isRepeatStart=!!(4&s),8&s&&(e.repeatCount=this.data.readByte()+(this.Or>=500?0:1)),16&s&&this.Or<500){let s=t,i=0;for(;s&&(!s.isRepeatEnd||s===t)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let n=0;const r=this.data.readByte();for(let t=0;t<8;t++){const e=1<<t;r>t&&0===(i&e)&&(n|=e)}e.alternateEndings=n}if(32&s){const t=new ge;t.text=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.marker="",js.gpReadColor(this.data,!1),e.section=t}if(64&s&&this.jr.set(this.ue.masterBars.length,[ae.readSInt8(this.data),this.data.readByte()]),this.Or>=500&&3&s&&this.data.skip(4),this.Or>=500&&(e.alternateEndings=this.data.readByte()),this.Or>=500){switch(this.data.readByte()){case 1:e.tripletFeel=nt.Triplet8th;break;case 2:e.tripletFeel=nt.Triplet16th}this.data.readByte()}else e.tripletFeel=this.Rr;const i=!!(128&s);e.isDoubleBar=i;const n=this.ue.masterBars.length;if(this.Jr.has(n))for(const t of this.Jr.get(n))e.addDirection(t);this.ue.addMasterBar(e),i&&this.Ur.add(e.index)}readTracks(){for(let t=0;t<this.Vr;t++)this.readTrack()}readTrack(){const t=new Be;t.ensureStaveCount(1),this.ue.addTrack(t);const e=t.staves[0],s=this.data.readByte();t.name=js.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),1&s&&(e.isPercussion=!0),this.Or>=500&&(t.isVisibleOnMultiTrack=!!(8&s)),null===this.ue.stylesheet.perTrackDisplayTuning&&(this.ue.stylesheet.perTrackDisplayTuning=new Map),this.ue.stylesheet.perTrackDisplayTuning.set(t.index,!!(128&s));const i=ae.readInt32LE(this.data),n=[];for(let t=0;t<7;t++){const e=ae.readInt32LE(this.data);i>t&&n.push(e)}e.stringTuning.tunings=n;const r=ae.readInt32LE(this.data),a=ae.readInt32LE(this.data)-1,h=ae.readInt32LE(this.data)-1;if(this.data.skip(4),a>=0&&a<this.Hr.length){const i=this.Hr[a];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=h,ue.isGuitar(i.program)&&(e.displayTranspositionPitch=-12),t.playbackInfo=i}if(e.capo=ae.readInt32LE(this.data),t.color=js.gpReadColor(this.data,!1),this.Or>=500){const s=this.data.readByte();e.showTablature=!!(1&s),e.showStandardNotation=!!(2&s);const i=!!(100&s);null===this.ue.stylesheet.perTrackChordDiagramsOnTop&&(this.ue.stylesheet.perTrackChordDiagramsOnTop=new Map),this.ue.stylesheet.perTrackChordDiagramsOnTop.set(t.index,i),this.data.readByte(),this.data.readByte(),t.playbackInfo.bank=this.data.readByte(),this.data.readByte();12===ae.readInt32LE(this.data)?this.zr.set(a,N.F4):this.zr.set(a,N.G2),ae.readInt32LE(this.data),ae.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this.Yr(),this.Or>=510&&(this.data.skip(4),js.gpReadStringIntByte(this.data,this.settings.importer.encoding),js.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else ue.isBass(t.playbackInfo.program)?this.zr.set(a,N.F4):this.zr.set(a,N.G2)}readBars(){for(let t=0;t<this.$r;t++)for(let t=0;t<this.Vr;t++)this.readBar(this.ue.tracks[t])}readBar(t){const e=new K,s=t.staves[0];if(s.isPercussion?e.clef=N.Neutral:this.zr.has(t.index)&&(e.clef=this.zr.get(t.index)),s.addBar(e),this.jr.has(e.index)){const t=this.jr.get(e.index);e.keySignature=t[0],e.keySignatureType=t[1]}else e.index>0&&(e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);this.Ur.has(e.index)&&(e.barLineRight=D.LightLight);let i=1;this.Or>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(t,e)}readVoice(t,e){const s=ae.readInt32LE(this.data);if(0===s)return;const i=new tt;e.addVoice(i);for(let n=0;n<s;n++)this.readBeat(t,e,i)}readBeat(t,e,s){const i=new Yt,n=this.data.readByte();if(1&n&&(i.dots=1),64&n){const t=this.data.readByte();i.isEmpty=!(2&t)}s.addBeat(i);switch(ae.readSInt8(this.data)){case-2:i.duration=c.Whole;break;case-1:i.duration=c.Half;break;case 0:i.duration=c.Quarter;break;case 1:i.duration=c.Eighth;break;case 2:i.duration=c.Sixteenth;break;case 3:i.duration=c.ThirtySecond;break;case 4:i.duration=c.SixtyFourth;break;default:i.duration=c.Quarter}if(32&n)switch(i.tupletNumerator=ae.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&n&&this.readChord(i);const r=this.settings.importer.beatTextAsLyrics&&t.index!==this.Ir;if(4&n){const e=js.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){const s=new me;s.text=e.trim(),s.finish(!0);const i=[];for(let t=s.chunks.length-1;t>=0;t--)i.push(s.chunks[t]);this.Xr.set(t.index,i)}else i.text=e}let a=f.None;8&n&&(a=this.readBeatEffects(i)),16&n&&this.readMixTableChange(i);const h=this.data.readByte();for(let n=6;n>=0;n--)if(h&1<<n&&6-n<e.staff.tuning.length){const r=this.readNote(t,e,s,i,6-n);a!==f.None&&(r.harmonicType=a,r.harmonicType===f.Natural&&(r.harmonicValue=Vt.deltaFretToHarmonicValue(r.fret)))}if(this.Or>=500){const t=ae.readInt16LE(this.data);if(1&t&&i.index>0&&(s.beats[i.index-1].beamingMode=gt.ForceSplitToNext),2&t&&(i.preferredBeamDirection=Ct.Down),4&t&&i.index>0&&(s.beats[i.index-1].beamingMode=gt.ForceMergeWithNext),8&t&&(i.preferredBeamDirection=Ct.Up),16&t&&(i.ottava=b._),32&t&&(i.ottava=b.T),64&t&&(i.ottava=b.S),256&t&&(i.ottava=b.M),2048&t){const t=0!==this.data.readByte();i.index>0&&t&&(s.beats[i.index-1].beamingMode=gt.ForceSplitOnSecondaryToNext)}}r&&!i.isRest&&this.Xr.has(t.index)&&this.Xr.get(t.index).length>0&&(i.lyrics=[this.Xr.get(t.index).pop()])}readChord(t){const e=new de,s=Vt.newGuid();if(this.Or>=500){this.data.skip(17),e.name=js.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=ae.readInt32LE(this.data);for(let s=0;s<7;s++){const i=ae.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else if(0!==this.data.readByte())if(this.Or>=400){this.data.skip(16),e.name=js.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=ae.readInt32LE(this.data);for(let s=0;s<7;s++){const i=ae.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else{this.data.skip(25),e.name=js.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),e.firstFret=ae.readInt32LE(this.data);for(let s=0;s<6;s++){const i=ae.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}this.data.skip(36)}else{const s=this.Or>=406?7:6;if(e.name=js.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.firstFret=ae.readInt32LE(this.data),e.firstFret>0)for(let i=0;i<s;i++){const s=ae.readInt32LE(this.data);i<t.voice.bar.staff.tuning.length&&e.strings.push(s)}}e.name&&(t.chordId=s,t.voice.bar.staff.addChord(t.chordId,e))}readBeatEffects(t){const e=this.data.readByte();let s=0;if(this.Or>=400&&(s=this.data.readByte()),16&e&&(t.fade=ft.FadeIn),(this.Or<400&&1&e||2&e)&&(t.vibrato=w.Slight),1&s&&(t.rasgueado=mt.Ii),32&e&&this.Or>=400){switch(ae.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}}else if(32&e){switch(ae.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}this.data.skip(4)}if(4&s&&this.readTremoloBarEffect(t),64&e){let e=0,s=0;this.Or<500?(s=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),s=this.data.readByte()),e>0?(t.brushType=h.BrushUp,t.brushDuration=zs.Kr(e)):s>0&&(t.brushType=h.BrushDown,t.brushDuration=zs.Kr(s))}if(2&s)switch(ae.readSInt8(this.data)){case 0:t.pickStroke=ht.None;break;case 1:t.pickStroke=ht.Up;break;case 2:t.pickStroke=ht.Down}if(this.Or<400){if(4&e)return f.Natural;if(8&e)return f.Artificial}return f.None}readTremoloBarEffect(t){this.data.readByte(),ae.readInt32LE(this.data);const e=ae.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new $(0,0);e.offset=ae.readInt32LE(this.data),e.value=ae.readInt32LE(this.data)/zs.Qr|0,js.gpReadBool(this.data),t.addWhammyBarPoint(e)}}static Kr(t){switch(t){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}Yr(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(t){const e=new Xs;e.instrument=ae.readSInt8(this.data),this.Or>=500&&this.Yr(),e.volume=ae.readSInt8(this.data),e.balance=ae.readSInt8(this.data);const s=ae.readSInt8(this.data),i=ae.readSInt8(this.data),r=ae.readSInt8(this.data),a=ae.readSInt8(this.data);if(this.Or>=500&&(e.tempoName=js.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.tempo=ae.readInt32LE(this.data),e.volume>=0&&this.data.readByte(),e.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),r>=0&&this.data.readByte(),a>=0&&this.data.readByte(),e.tempo>=0&&(e.duration=ae.readSInt8(this.data),this.Or>=510&&this.data.readByte()),this.Or>=400&&this.data.readByte(),this.Or>=500){const e=ae.readSInt8(this.data);e>=100?t.wahPedal=pt.Closed:e>=0&&(t.wahPedal=pt.Open)}if(this.Or>=510&&(js.gpReadStringIntByte(this.data,this.settings.importer.encoding),js.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.volume>=0){const s=new G;s.isLinear=!0,s.type=n.Volume,s.value=e.volume,t.automations.push(s)}if(e.balance>=0){const s=new G;s.isLinear=!0,s.type=n.Balance,s.value=e.balance,t.automations.push(s)}if(e.instrument>=0){const s=new G;s.isLinear=!0,s.type=n.Instrument,s.value=e.instrument,t.automations.push(s)}if(e.tempo>=0){const s=new G;s.isLinear=!0,s.type=n.Tempo,s.value=e.tempo,t.automations.push(s),t.voice.bar.masterBar.tempoAutomations.some(t=>t.ratioPosition===s.ratioPosition&&t.value===s.value)||t.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(t,e,s,i,n){const r=new Xt;r.string=e.staff.tuning.length-n;const a=this.data.readByte();if(2&a?r.accentuated=u.Heavy:64&a&&(r.accentuated=u.Normal),r.isGhost=!!(4&a),32&a){const t=this.data.readByte();3===t?r.isDead=!0:2===t&&(r.isTieDestination=!0)}if(1&a&&this.Or<500&&(this.data.readByte(),this.data.readByte()),16&a){const t=ae.readSInt8(this.data);r.dynamics=this.toDynamicValue(t),i.dynamics=r.dynamics}32&a&&(r.fret=ae.readSInt8(this.data)),128&a&&(r.leftHandFinger=ae.readSInt8(this.data),r.rightHandFinger=ae.readSInt8(this.data));let h=!1;if(this.Or>=500){1&a&&(r.durationPercent=ae.readFloat64BE(this.data));h=!!(2&this.data.readByte())}if(i.addNote(r),8&a&&this.readNoteEffects(t,s,i,r),e.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),h){const t=Vt.computeAccidental(e.keySignature,p.Default,r.realValueWithoutHarmonic,!1);t===at.Sharp?r.accidentalMode=p.ForceFlat:t===at.Flat&&(r.accidentalMode=p.ForceSharp)}return r}toDynamicValue(t){switch(t){case 1:return i.PPP;case 2:return i.PP;case 3:return i.P;case 4:return i.MP;case 5:return i.MF;case 6:default:return i.F;case 7:return i.FF;case 8:return i.FFF}}readNoteEffects(t,e,s,i){const n=this.data.readByte();let r=0;this.Or>=400&&(r=this.data.readByte()),1&n&&this.readBend(i),16&n&&this.readGrace(e,i),4&r&&this.readTremoloPicking(s),8&r?this.readSlide(i):this.Or<400&&4&n&&(i.slideOutType=g.Shift),16&r&&this.readArtificialHarmonic(i),32&r&&this.readTrill(i),i.isLetRing=!!(8&n),i.isHammerPullOrigin=!!(2&n),64&r&&(i.vibrato=w.Slight),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}static Qr=25;readBend(t){this.data.readByte(),ae.readInt32LE(this.data);const e=ae.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new $(0,0);e.offset=ae.readInt32LE(this.data),e.value=ae.readInt32LE(this.data)/zs.Qr|0,js.gpReadBool(this.data),t.addBendPoint(e)}}readGrace(t,e){const s=new Yt,i=new Xt;i.string=e.string,i.fret=ae.readSInt8(this.data),s.duration=c.ThirtySecond,s.dynamics=this.toDynamicValue(ae.readSInt8(this.data));switch(ae.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=g.Legato,i.slideTarget=e;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this.Or<500)s.graceType=l.BeforeBeat;else{const t=this.data.readByte();i.isDead=!!(1&t),s.graceType=2&t?l.OnBeat:l.BeforeBeat}t.addGraceBeat(s),s.addNote(i)}readTremoloPicking(t){switch(this.data.readByte()){case 1:t.tremoloSpeed=c.Eighth;break;case 2:t.tremoloSpeed=c.Sixteenth;break;case 3:t.tremoloSpeed=c.ThirtySecond}}readSlide(t){if(this.Or>=500){const e=ae.readSInt8(this.data);1&e?t.slideOutType=g.Shift:2&e?t.slideOutType=g.Legato:4&e?t.slideOutType=g.OutDown:8&e&&(t.slideOutType=g.OutUp),16&e?t.slideInType=m.IntoFromBelow:32&e&&(t.slideInType=m.IntoFromAbove)}else{switch(ae.readSInt8(this.data)){case 1:t.slideOutType=g.Shift;break;case 2:t.slideOutType=g.Legato;break;case 3:t.slideOutType=g.OutDown;break;case 4:t.slideOutType=g.OutUp;break;case-1:t.slideInType=m.IntoFromBelow;break;case-2:t.slideInType=m.IntoFromAbove}}}readArtificialHarmonic(t){const e=this.data.readByte();if(this.Or>=500)switch(e){case 1:t.harmonicType=f.Natural,t.harmonicValue=Vt.deltaFretToHarmonicValue(t.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),t.harmonicType=f.Artificial;break;case 3:t.harmonicType=f.Tap,t.harmonicValue=Vt.deltaFretToHarmonicValue(this.data.readByte());break;case 4:t.harmonicType=f.Pinch,t.harmonicValue=12;break;case 5:t.harmonicType=f.Semi,t.harmonicValue=12}else if(this.Or>=400)switch(e){case 1:t.harmonicType=f.Natural;break;case 3:t.harmonicType=f.Tap;break;case 4:t.harmonicType=f.Pinch;break;case 5:t.harmonicType=f.Semi;break;case 15:case 17:case 22:t.harmonicType=f.Artificial}}readTrill(t){switch(t.trillValue=this.data.readByte()+t.stringTuning,this.data.readByte()){case 1:t.trillSpeed=c.Sixteenth;break;case 2:t.trillSpeed=c.ThirtySecond;break;case 3:t.trillSpeed=c.SixtyFourth}}}class js{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),n=t.readByte();let r=255;return e?r=t.readByte():t.skip(1),new pe(s,i,n,r)}static gpReadBool(t){return 0!==t.readByte()}static gpReadStringIntUnused(t,e){return t.skip(4),js.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return js.gpReadString(t,ae.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=ae.readInt32LE(t)-1;return t.readByte(),js.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),ae.toString(i,s)}static gpWriteString(t,e){const s=ae.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),n=js.gpReadString(t,i,s);return i<e&&t.skip(e-i),n}}class Xs{volume=-1;balance=-1;instrument=-1;tempoName="";tempo=-1;duration=-1}!function(t){t[t.Boolean=0]="Boolean",t[t.Integer=1]="Integer",t[t.Float=2]="Float",t[t.String=3]="String",t[t.Point=4]="Point",t[t.Size=5]="Size",t[t.Rectangle=6]="Rectangle",t[t.Color=7]="Color"}(Qe||(Qe={}));class Js{Zr=new Map;raw=new Map;constructor(t){t&&this.ta(t)}ta(t){const e=Re.fromBuffer(t),s=ae.readInt32BE(e);for(let t=0;t<s;t++){const t=js.gpReadString(e,e.readByte(),"utf-8"),s=e.readByte();switch(this.Zr.set(t,s),s){case Qe.Boolean:const s=1===e.readByte();this.addValue(t,s);break;case Qe.Integer:const i=ae.readInt32BE(e);this.addValue(t,i);break;case Qe.Float:const n=ae.readFloat32BE(e);this.addValue(t,n);break;case Qe.String:const r=js.gpReadString(e,ae.readInt16BE(e),"utf-8");this.addValue(t,r);break;case Qe.Point:const a=ae.readInt32BE(e),h=ae.readInt32BE(e);this.addValue(t,new $(a,h));break;case Qe.Size:const o=ae.readInt32BE(e),c=ae.readInt32BE(e);this.addValue(t,new $(o,c));break;case Qe.Rectangle:const l=new Ne;l.x=ae.readInt32BE(e),l.y=ae.readInt32BE(e),l.w=ae.readInt32BE(e),l.h=ae.readInt32BE(e),this.addValue(t,l);break;case Qe.Color:const u=js.gpReadColor(e,!0);this.addValue(t,u)}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=T.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=T.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==T.Hidden)switch(s){case 0:case 1:t.stylesheet.singleTrackTrackNamePolicy=T.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=T.AllSystems}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==T.Hidden)switch(s){case 0:case 1:t.stylesheet.multiTrackTrackNamePolicy=T.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=T.AllSystems}break;case"System/shortTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameMode=s?M.ShortName:M.FullName;break;case"System/shortTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameMode=s?M.ShortName:M.FullName;break;case"System/horizontalTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameOrientation=s?v.Horizontal:v.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameOrientation=s?v.Horizontal:v.Vertical;break;case"Header/Title":Vt.getOrCreateHeaderFooterStyle(t,it.Title).template=s;break;case"Header/TitleAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Title).textAlign=this.ea(s);break;case"Header/drawTitle":Vt.getOrCreateHeaderFooterStyle(t,it.Title).isVisible=s;break;case"Header/Subtitle":Vt.getOrCreateHeaderFooterStyle(t,it.SubTitle).template=s;break;case"Header/SubtitleAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.SubTitle).textAlign=this.ea(s);break;case"Header/drawSubtitle":Vt.getOrCreateHeaderFooterStyle(t,it.SubTitle).isVisible=s;break;case"Header/Artist":Vt.getOrCreateHeaderFooterStyle(t,it.Artist).template=s;break;case"Header/ArtistAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Artist).textAlign=this.ea(s);break;case"Header/drawArtist":Vt.getOrCreateHeaderFooterStyle(t,it.Artist).isVisible=s;break;case"Header/Album":Vt.getOrCreateHeaderFooterStyle(t,it.Album).template=s;break;case"Header/AlbumAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Album).textAlign=this.ea(s);break;case"Header/drawAlbum":Vt.getOrCreateHeaderFooterStyle(t,it.Album).isVisible=s;break;case"Header/Words":Vt.getOrCreateHeaderFooterStyle(t,it.Words).template=s;break;case"Header/WordsAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Words).textAlign=this.ea(s);break;case"Header/drawWords":Vt.getOrCreateHeaderFooterStyle(t,it.Words).isVisible=s;break;case"Header/Music":Vt.getOrCreateHeaderFooterStyle(t,it.Music).template=s;break;case"Header/MusicAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Music).textAlign=this.ea(s);break;case"Header/drawMusic":Vt.getOrCreateHeaderFooterStyle(t,it.Music).isVisible=s;break;case"Header/WordsAndMusic":Vt.getOrCreateHeaderFooterStyle(t,it.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.WordsAndMusic).textAlign=this.ea(s);break;case"Header/drawWordsAndMusic":Vt.getOrCreateHeaderFooterStyle(t,it.WordsAndMusic).isVisible=s;break;case"Header/Tabber":Vt.getOrCreateHeaderFooterStyle(t,it.Transcriber).template=s;break;case"Header/TabberAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Transcriber).textAlign=this.ea(s);break;case"Header/drawTabber":Vt.getOrCreateHeaderFooterStyle(t,it.Transcriber).isVisible=s;break;case"Footer/Copyright":Vt.getOrCreateHeaderFooterStyle(t,it.Copyright).template=s;break;case"Footer/CopyrightAlignment":Vt.getOrCreateHeaderFooterStyle(t,it.Copyright).textAlign=this.ea(s);break;case"Footer/drawCopyright":Vt.getOrCreateHeaderFooterStyle(t,it.Copyright).isVisible=s;break;case"Footer/Copyright2":Vt.getOrCreateHeaderFooterStyle(t,it.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":Vt.getOrCreateHeaderFooterStyle(t,it.CopyrightSecondLine).textAlign=this.ea(s);break;case"Footer/drawCopyright2":Vt.getOrCreateHeaderFooterStyle(t,it.CopyrightSecondLine).isVisible=s}}ea(t){switch(t){case 0:return et.Left;case 1:return et.Center;case 2:return et.Right}return et.Left}addValue(t,e,s){this.raw.set(t,e),void 0!==s&&this.Zr.set(t,s)}writeTo(t){ae.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this.sa(e,s);switch(js.gpWriteString(t,e),t.writeByte(i),i){case Qe.Boolean:t.writeByte(s?1:0);break;case Qe.Integer:ae.writeInt32BE(t,s);break;case Qe.Float:ae.writeFloat32BE(t,s);break;case Qe.String:const e=ae.stringToBytes(s);ae.writeInt16BE(t,e.length),t.write(e,0,e.length);break;case Qe.Point:case Qe.Size:ae.writeInt32BE(t,s.offset),ae.writeInt32BE(t,s.value);break;case Qe.Rectangle:ae.writeInt32BE(t,s.x),ae.writeInt32BE(t,s.y),ae.writeInt32BE(t,s.w),ae.writeInt32BE(t,s.h);break;case Qe.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a)}}}sa(t,e){if(this.Zr.has(t))return this.Zr.get(t);const i=typeof e;switch(typeof e){case"string":return Qe.String;case"number":return e===(0|e)?Qe.Integer:Qe.Float;case"object":if(e instanceof $)return Qe.Point;if(e instanceof Ne)return Qe.Rectangle;if(e instanceof pe)return Qe.Color}throw new W(s.General,`Unknown value type in BinaryStylesheet: ${i}`)}static writeForScore(t){const e=new Js;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,Qe.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,Qe.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,Qe.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,Qe.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,Qe.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case T.Hidden:e.addValue("System/showTrackNameSingle",!1,Qe.Boolean);break;case T.FirstSystem:e.addValue("System/trackNameModeSingle",0,Qe.Integer);break;case T.AllSystems:e.addValue("System/trackNameModeSingle",2,Qe.Integer)}switch(t.stylesheet.multiTrackTrackNamePolicy){case T.Hidden:e.addValue("System/showTrackNameMulti",!1,Qe.Boolean);break;case T.FirstSystem:e.addValue("System/trackNameModeMulti",0,Qe.Integer);break;case T.AllSystems:e.addValue("System/trackNameModeMulti",2,Qe.Integer)}switch(t.stylesheet.firstSystemTrackNameMode){case M.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,Qe.Boolean);break;case M.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,Qe.Boolean)}switch(t.stylesheet.otherSystemsTrackNameMode){case M.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,Qe.Boolean);break;case M.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,Qe.Boolean)}switch(t.stylesheet.firstSystemTrackNameOrientation){case v.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,Qe.Boolean);break;case v.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,Qe.Boolean)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case v.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,Qe.Boolean);break;case v.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,Qe.Boolean)}const s=t.style;if(s)for(const[t,i]of s.headerAndFooter)switch(t){case it.Title:Js.ia(e,i,"Header/","Title");break;case it.SubTitle:Js.ia(e,i,"Header/","Subtitle");break;case it.Artist:Js.ia(e,i,"Header/","Artist");break;case it.Album:Js.ia(e,i,"Header/","Album");break;case it.Words:Js.ia(e,i,"Header/","Words");break;case it.Music:Js.ia(e,i,"Header/","Music");break;case it.WordsAndMusic:Js.ia(e,i,"Header/","WordsAndMusic");break;case it.Transcriber:Js.ia(e,i,"Header/","Tabber");break;case it.Copyright:Js.ia(e,i,"Footer/","Copyright");break;case it.CopyrightSecondLine:Js.ia(e,i,"Footer/","Copyright2")}const i=Re.withCapacity(128);return e.writeTo(i),i.toArray()}static ia(t,e,s,i){t.addValue(`${s}${i}`,e.template,Qe.String),t.addValue(`${s}${i}Alignment`,e.textAlign,Qe.Integer),void 0!==e.isVisible&&t.addValue(`${s}draw${i}`,e.isVisible,Qe.Boolean)}}class qs{rawAudioFile}class Ys{id="";dots=0;tupletDenominator=-1;tupletNumerator=-1;value=c.Quarter}class Ks{name="";path="";role="";get uniqueId(){return`${this.path};${this.name};${this.role}`}program=0;bank=0}class Qs{static na="-1";static ra=$.MaxPosition/100;static aa=.04;static ha=44100;score;oa;ca;la;ua;da;fa;pa;ba;ma;ga;wa;ya;ka;Sa;Ba;_a;xa;Ta;Ma;va;Na=!1;Pa;Ea=!1;Fa=0;Ur=new Set;jr=new Map;loadAsset;parseXml(t,e){this.ca=new Map,this.la=new Map,this.ua=new Map,this.da=[],this.fa=new Map,this.pa=[],this.ba=[],this.ga=new Map,this.ma=new Map,this.wa=new Map,this.ya=new Map,this.Sa=new Map,this.ka=new Map,this.Ba=new Map,this.xa=new Map,this._a=new Map,this.Ta=new Map,this.Ma=new Map,this.va=new Map,this.Ea=!1;const s=new Ps;try{s.parse(t)}catch(t){throw new Oe("Could not parse XML",t)}if(this.An(s),this.Ca(),Vt.consolidate(this.score),this.score.finish(e),!this.Ea&&this.Ma.size>0)for(const[t,e]of this.Ma){this.fa.get(t).applyLyrics(e)}}An(t){const e=t.firstElement;if(e){if("GPIF"!==e.localName)throw new Oe("Root node of XML was not GPIF");this.score=new Ot;for(const t of e.childElements())switch(t.localName){case"Score":this.Aa(t);break;case"MasterTrack":this.Da(t);break;case"BackingTrack":this.La(t);break;case"Tracks":this.Wa(t);break;case"MasterBars":this.Oa(t);break;case"Bars":this.Ra(t);break;case"Voices":this.nr(t);break;case"Beats":this.Ia(t);break;case"Notes":this.Ga(t);break;case"Rhythms":this.$a(t);break;case"Assets":this.Va(t)}}}Va(t){for(const e of t.childElements())if("Asset"===e.localName)e.getAttribute("id")===this.oa&&this.Ha(e)}Ha(t){let e="";for(const s of t.childElements())if("EmbeddedFilePath"===s.localName)e=s.innerText;const s=this.loadAsset;if(s){const t=s(e);t?this.score.backingTrack.rawAudioFile=t:this.score.backingTrack=void 0}}Aa(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const t=e.innerText;""!==t&&(t&&!this.score.words&&(this.score.words=t),t&&!this.score.music&&(this.score.music=t));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=Qs.Ua(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=Qs.za(e.innerText).map(t=>Qs.Ua(t,4))}}static Ua(t,e){if(!t)return e;const s=Number.parseInt(t,10);return Number.isNaN(s)?e:s}static ja(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static za(t,e=" "){return t?t.split(e).map(t=>t.trim()).filter(t=>t.length>0):[]}La(t){const e=new qs;let s=!1,i="",n="";for(const e of t.childElements())switch(e.localName){case"Enabled":s="true"===e.innerText;break;case"Source":i=e.innerText;break;case"AssetId":n=e.innerText;break;case"FramePadding":this.Fa=Qs.Ua(e.innerText,0)/Qs.ha*1e3}s&&"Local"===i&&(this.score.backingTrack=e,this.oa=n)}Da(t){for(const e of t.childElements())switch(e.localName){case"Automations":this.Xa(e,this.ca,null,null);break;case"Tracks":this.da=Qs.za(e.innerText);break;case"Anacrusis":this.Na=!0}}Xa(t,e,s,i){for(const n of t.childElements())if("Automation"===n.localName)this.Ja(n,e,s,i)}Ja(t,e,s,i){let r,a=null,h=!1,o=-1,c=0,l=0,u=null,d=0,f=null,p=!0;for(const e of t.childElements())switch(e.localName){case"Type":a=e.innerText;break;case"Linear":h="true"===e.innerText.toLowerCase();break;case"Bar":o=Qs.Ua(e.innerText,0);break;case"Position":c=Qs.ja(e.innerText,0);break;case"Value":if(e.firstElement&&e.firstElement.nodeType===Je.CDATA)u=e.innerText;else if(e.firstElement&&e.firstElement.nodeType===Je.Element&&"SyncPoint"===a){r=new I;for(const t of e.childElements())switch(t.localName){case"BarIndex":o=Qs.Ua(t.innerText,0);break;case"BarOccurrence":r.barOccurence=Qs.Ua(t.innerText,0);break;case"FrameOffset":const e=Qs.ja(t.innerText,0);r.millisecondOffset=e/Qs.ha*1e3}}else{const t=Qs.za(e.innerText);1===t.length?(l=Qs.ja(t[0],0),d=1):(l=Qs.ja(t[0],0),d=Qs.Ua(t[1],0))}break;case"Text":f=e.innerText;break;case"Visible":p="true"===e.innerText.toLowerCase()}if(!a)return;const b=[];switch(a){case"Tempo":b.push(G.buildTempoAutomation(h,c,l,d,p));break;case"SyncPoint":const t=new G;t.type=n.SyncPoint,t.isLinear=h,t.ratioPosition=c,t.syncPointValue=r,t.isVisible=p,b.push(t);break;case"Sound":if(u&&s&&s.has(u)){const t=new G;t.type=n.Bank,t.ratioPosition=c,t.value=s.get(u).bank,t.isVisible=p,b.push(t);const e=G.buildInstrumentAutomation(h,c,s.get(u).program);b.push(e)}break;case"SustainPedal":if(i){let t;i.has(o)?t=i.get(o):(t=[],i.set(o,t));const e=new q;switch(e.ratioPosition=c,d){case 1:e.pedalType=C.Down;break;case 3:e.pedalType=C.Up}t.push(e)}}if(b.length){if(f)for(const t of b)t.text=f;if(o>=0){e.has(o)||e.set(o,[]);for(const t of b)e.get(o).push(t)}}}Wa(t){for(const e of t.childElements())if("Track"===e.localName)this.qa(e)}qa(t){this.Pa=new Map;const e=new Be;e.ensureStaveCount(1);e.staves[0].showStandardNotation=!0;const s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Name":e.name=i.innerText;break;case"Color":const t=Qs.za(i.innerText);if(t.length>=3){const s=Qs.Ua(t[0],0),i=Qs.Ua(t[1],0),n=Qs.Ua(t[2],0);e.color=new pe(s,i,n,255)}break;case"Instrument":const n=i.getAttribute("ref");(n.endsWith("-gs")||n.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.Ya(e,i);break;case"NotationPatch":this.Ka(e,i);break;case"ShortName":e.shortName=i.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=Qs.Ua(i.innerText,4);break;case"SystemsLayout":e.systemsLayout=Qs.za(i.innerText).map(t=>Qs.Ua(t,4));break;case"Lyrics":this.Qa(s,i);break;case"Properties":this.Za(e,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.th(e,i);break;case"Sounds":this.eh(s,e,i);break;case"PlaybackState":const r=i.innerText;e.playbackInfo.isSolo="Solo"===r,e.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.sh(s,e,i);break;case"Staves":this.Qn(e,i);break;case"Transpose":this.ih(s,e,i);break;case"RSE":this.nh(e,i);break;case"Automations":this.rh(s,i)}this.fa.set(s,e)}rh(t,e){const s=new Map;this.la.set(t,s);const i=new Map;this.ua.set(t,i),this.Xa(e,s,this.va.get(t),i)}Ka(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const e=Qs.Ua(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e;break;case"Elements":this.ah(t,s)}}Ya(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const e of t.staves)e.isPercussion=!0;break;case"Elements":this.ah(t,s);break;case"LineCount":const e=Qs.Ua(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e}}ah(t,e){for(const s of e.childElements())if("Element"===s.localName)this.hh(t,s)}hh(t,e){const s=e.findChildElement("Type")?.innerText??"";for(const i of e.childElements())switch(i.localName){case"Name":case"Articulations":this.oh(t,i,s)}}oh(t,e,s){for(const i of e.childElements())if("Articulation"===i.localName)this.uh(t,i,s)}uh(t,e,s){const i=new Ht;i.outputMidiNumber=-1,i.elementType=s;let n="";for(const t of e.childElements()){const e=t.innerText;switch(t.localName){case"Name":n=t.innerText;break;case"OutputMidiNumber":i.outputMidiNumber=Qs.Ua(e,0);break;case"TechniqueSymbol":i.techniqueSymbol=this.dh(e);break;case"TechniquePlacement":switch(e){case"outside":i.techniqueSymbolPlacement=ot.Outside;break;case"inside":i.techniqueSymbolPlacement=ot.Inside;break;case"above":i.techniqueSymbolPlacement=ot.Above;break;case"below":i.techniqueSymbolPlacement=ot.Below}break;case"Noteheads":const s=Qs.za(e);s.length>=1&&(i.noteHeadDefault=this.fh(s[0])),s.length>=2&&(i.noteHeadHalf=this.fh(s[1])),s.length>=3&&(i.noteHeadWhole=this.fh(s[2])),i.noteHeadHalf===rt.None&&(i.noteHeadHalf=i.noteHeadDefault),i.noteHeadWhole===rt.None&&(i.noteHeadWhole=i.noteHeadDefault);break;case"StaffLine":i.staffLine=Qs.Ua(e,0)}}-1!==i.outputMidiNumber?(t.percussionArticulations.push(i),n.length>0&&this.Pa.set(n,i)):n.length>0&&this.Pa.has(n)&&(this.Pa.get(n).staffLine=i.staffLine)}dh(t){switch(t){case"pictEdgeOfCymbal":return rt.PictEdgeOfCymbal;case"articStaccatoAbove":return rt.ArticStaccatoAbove;case"noteheadParenthesis":return rt.NoteheadParenthesis;case"stringsUpBow":return rt.StringsUpBow;case"stringsDownBow":return rt.StringsDownBow;case"guitarGolpe":return rt.GuitarGolpe;default:return rt.None}}fh(t){switch(t){case"noteheadDoubleWholeSquare":return rt.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return rt.NoteheadDoubleWhole;case"noteheadWhole":return rt.NoteheadWhole;case"noteheadHalf":return rt.NoteheadHalf;case"noteheadBlack":return rt.NoteheadBlack;case"noteheadNull":return rt.NoteheadNull;case"noteheadXOrnate":return rt.NoteheadXOrnate;case"noteheadTriangleUpWhole":return rt.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return rt.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return rt.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return rt.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return rt.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return rt.NoteheadDiamondWhiteWide;case"noteheadCircleX":return rt.NoteheadCircleX;case"noteheadXWhole":return rt.NoteheadXWhole;case"noteheadXHalf":return rt.NoteheadXHalf;case"noteheadXBlack":return rt.NoteheadXBlack;case"noteheadParenthesis":return rt.NoteheadParenthesis;case"noteheadSlashedBlack2":return rt.NoteheadSlashedBlack2;case"noteheadCircleSlash":return rt.NoteheadCircleSlash;case"noteheadHeavyX":return rt.NoteheadHeavyX;case"noteheadHeavyXHat":return rt.NoteheadHeavyXHat;default:return z.warning("GPIF","Unknown notehead symbol",t),rt.None}}Qn(t,e){let s=0;for(const i of e.childElements())if("Staff"===i.localName){t.ensureStaveCount(s+1);const e=t.staves[s];this.Zn(e,i),s++}}Zn(t,e){for(const s of e.childElements())if("Properties"===s.localName)this.ph(t,s)}ph(t,e){for(const s of e.childElements())if("Property"===s.localName)this.bh(t,s)}bh(t,e){switch(e.getAttribute("name")){case"Tuning":for(const s of e.childElements())switch(s.localName){case"Pitches":const i=Qs.za(e.findChildElement("Pitches")?.innerText),n=new Array(i.length);for(let t=0;t<n.length;t++)n[n.length-1-t]=Qs.Ua(i[t],0);t.stringTuning.tunings=n;break;case"Label":t.stringTuning.name=s.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.mh(t,e);break;case"CapoFret":const s=Qs.Ua(e.findChildElement("Fret")?.innerText,0);t.capo=s}}Qa(t,e){const s=[];for(const t of e.childElements())if("Line"===t.localName)s.push(this.gh(t));this.Ma.set(t,s)}gh(t){const e=new me;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=Qs.Ua(s.innerText,0);break;case"Text":e.text=s.innerText}return e}wh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.yh(t,e)}mh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.kh(t,e)}yh(t,e){const s=new de,i=e.getAttribute("id");for(const e of t.staves)e.addChord(i,s);this.Sh(s,e)}kh(t,e){const s=new de,i=e.getAttribute("id");t.addChord(i,s),this.Sh(s,e)}Sh(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s)return t.showDiagram=!1,void(t.showFingering=!1);const i=Qs.Ua(s.getAttribute("stringCount"),6),n=Qs.Ua(s.getAttribute("baseFret"),0);t.firstFret=n+1;for(let e=0;e<i;e++)t.strings.push(-1);for(const e of s.childElements())switch(e.localName){case"Fret":const s=Qs.Ua(e.getAttribute("string"),0);t.strings[i-s-1]=n+Qs.Ua(e.getAttribute("fret"),0);break;case"Fingering":const r=new Map;for(const s of e.childElements())if("Position"===s.localName){let e=d.Unknown;const i=n+Qs.Ua(s.getAttribute("fret"),0);switch(s.getAttribute("finger")){case"Index":e=d.IndexFinger;break;case"Middle":e=d.MiddleFinger;break;case"Rank":e=d.AnnularFinger;break;case"Pinky":e=d.LittleFinger;break;case"Thumb":e=d.Thumb}e!==d.Unknown&&(r.has(e)?t.barreFrets.push(i):r.set(e,!0))}break;case"Property":switch(e.getAttribute("name")){case"ShowName":t.showName="true"===e.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===e.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===e.getAttribute("value")}}}Za(t,e){for(const s of e.childElements())if("Property"===s.localName)this.Bh(t,s)}Bh(t,e){switch(e.getAttribute("name")){case"Tuning":const s=Qs.za(e.findChildElement("Pitches")?.innerText),i=new Array(s.length);for(let t=0;t<i.length;t++)i[i.length-1-t]=Qs.Ua(s[t],0);for(const e of t.staves)e.stringTuning.tunings=i,e.showStandardNotation=!0,e.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.wh(t,e);break;case"CapoFret":const n=Qs.Ua(e.findChildElement("Fret")?.innerText,0);for(const e of t.staves)e.capo=n}}th(t,e){for(const s of e.childElements())switch(s.localName){case"Program":t.playbackInfo.program=Qs.Ua(s.innerText,0);break;case"Port":t.playbackInfo.port=Qs.Ua(s.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=Qs.Ua(s.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=Qs.Ua(s.innerText,0)}if("Percussion"===e.getAttribute("table"))for(const e of t.staves)e.isPercussion=!0}eh(t,e,s){for(const i of s.childElements())if("Sound"===i.localName)this._h(t,e,i)}_h(t,e,s){const i=new Ks;for(const t of s.childElements())switch(t.localName){case"Name":i.name=t.innerText;break;case"Path":i.path=t.innerText;break;case"Role":i.role=t.innerText;break;case"MIDI":this.xh(i,t)}this.va.has(t)||(this.va.set(t,new Map),e.playbackInfo.program=i.program,e.playbackInfo.bank=i.bank),this.va.get(t).set(i.uniqueId,i)}xh(t,e){let s=0,i=0;for(const n of e.childElements())switch(n.localName){case"Program":t.program=Qs.Ua(n.innerText,0);break;case"MSB":s=Qs.Ua(n.innerText,0);break;case"LSB":i=Qs.Ua(n.innerText,0)}t.bank=(127&s)<<7|i}sh(t,e,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const t of e.staves)t.displayTranspositionPitch=Qs.Ua(i.innerText,0);break;case"NominalKey":const s=Math.max(0,we.noteNames.indexOf(i.innerText));this.Th.set(t,s)}}Th=new Map;ih(t,e,s){let i=0,n=0;for(const t of s.childElements())switch(t.localName){case"Chromatic":n=Qs.Ua(t.innerText,0);break;case"Octave":i=Qs.Ua(t.innerText,0)}const r=12*i+n;for(const t of e.staves)t.displayTranspositionPitch=r;const a=Vt.flooredDivision(r,12);this.Th.set(t,a)}nh(t,e){for(const s of e.childElements())if("ChannelStrip"===s.localName)this.Mh(t,s)}Mh(t,e){for(const s of e.childElements())if("Parameters"===s.localName)this.Nh(t,s)}Nh(t,e){if(e.firstChild&&e.firstChild.value){const s=Qs.za(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(16*Qs.ja(s[11],.5)),t.playbackInfo.volume=Math.floor(16*Qs.ja(s[12],.9)))}}Oa(t){for(const e of t.childElements())if("MasterBar"===e.localName)this.Ph(e)}Ph(t){const e=new Rt;0===this.pa.length&&this.Na&&(e.isAnacrusis=!0);for(const s of t.childElements())switch(s.localName){case"Time":const t=s.innerText.split("/");e.timeSignatureNumerator=Qs.Ua(t[0],4),e.timeSignatureDenominator=Qs.Ua(t[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this.Ur.add(e);break;case"Section":e.section=new ge,e.section.marker=s.findChildElement("Letter")?.innerText??"",e.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(e.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(e.repeatCount=Qs.Ua(s.getAttribute("count"),1));break;case"AlternateEndings":const i=Qs.za(s.innerText);let n=0;for(let t=0;t<i.length;t++)n|=1<<-1+Qs.Ua(i[t],0);e.alternateEndings=n;break;case"Bars":this.ba.push(Qs.za(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":e.tripletFeel=nt.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=nt.Triplet8th;break;case"Triplet16th":e.tripletFeel=nt.Triplet16th;break;case"Dotted8th":e.tripletFeel=nt.Dotted8th;break;case"Dotted16th":e.tripletFeel=nt.Dotted16th;break;case"Scottish8th":e.tripletFeel=nt.Scottish8th;break;case"Scottish16th":e.tripletFeel=nt.Scottish16th}break;case"Key":const r=Qs.Ua(s.findChildElement("AccidentalCount")?.innerText,0),a=s.findChildElement("Mode");let h=F.Major;if(a)switch(a.innerText.toLowerCase()){case"major":h=F.Major;break;case"minor":h=F.Minor}this.jr.set(this.pa.length,[r,h]);break;case"Fermatas":this.Eh(e,s);break;case"XProperties":this.Fh(e,s);break;case"Directions":this.Ch(e,s)}this.pa.push(e)}Ch(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(Ke.TargetCoda);break;case"DoubleCoda":t.addDirection(Ke.TargetDoubleCoda);break;case"Segno":t.addDirection(Ke.TargetSegno);break;case"SegnoSegno":t.addDirection(Ke.TargetSegnoSegno);break;case"Fine":t.addDirection(Ke.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(Ke.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(Ke.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(Ke.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(Ke.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(Ke.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(Ke.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(Ke.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(Ke.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(Ke.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(Ke.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(Ke.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(Ke.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(Ke.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(Ke.JumpDaDoubleCoda)}}}Eh(t,e){for(const s of e.childElements())if("Fermata"===s.localName)this.Ah(t,s)}Ah(t,e){let s=0;const i=new be;for(const t of e.childElements())switch(t.localName){case"Type":switch(t.innerText){case"Short":i.type=Nt.Short;break;case"Medium":i.type=Nt.Medium;break;case"Long":i.type=Nt.Long}break;case"Length":i.length=Qs.ja(t.innerText,0);break;case"Offset":const e=t.innerText.split("/");if(2===e.length){s=Qs.Ua(e[0],4)/Qs.Ua(e[1],4)*R.QuarterTime|0}}t.addFermata(s,i)}Ra(t){for(const e of t.childElements())if("Bar"===e.localName)this.Dh(e)}Dh(t){const e=new K,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this.ga.set(s,Qs.za(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=N.Neutral;break;case"G2":e.clef=N.G2;break;case"F4":e.clef=N.F4;break;case"C4":e.clef=N.C4;break;case"C3":e.clef=N.C3}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=b._;break;case"15ma":e.clefOttava=b.S;break;case"8vb":e.clefOttava=b.T;break;case"15mb":e.clefOttava=b.M}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=P.Simple;break;case"FirstOfDouble":e.simileMark=P.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=P.SecondOfDouble}break;case"XProperties":this.Lh(i,e)}this.ma.set(s,e)}nr(t){for(const e of t.childElements())if("Voice"===e.localName)this.rr(e)}rr(t){const e=new tt,s=t.getAttribute("id");for(const e of t.childElements())if("Beats"===e.localName)this.ya.set(s,Qs.za(e.innerText));this.wa.set(s,e)}Ia(t){for(const e of t.childElements())if("Beat"===e.localName)this.Wh(e)}Wh(t){const e=new Yt,s=t.getAttribute("id");for(const n of t.childElements())switch(n.localName){case"Notes":this.xa.set(s,Qs.za(n.innerText));break;case"Rhythm":this.ka.set(s,n.getAttribute("ref"));break;case"Fadding":switch(n.innerText){case"FadeIn":e.fade=ft.FadeIn;break;case"FadeOut":e.fade=ft.FadeOut;break;case"VolumeSwell":e.fade=ft.VolumeSwell}break;case"Tremolo":switch(n.innerText){case"1/2":e.tremoloSpeed=c.Eighth;break;case"1/4":e.tremoloSpeed=c.Sixteenth;break;case"1/8":e.tremoloSpeed=c.ThirtySecond}break;case"Chord":e.chordId=n.innerText;break;case"Hairpin":switch(n.innerText){case"Crescendo":e.crescendo=o.Crescendo;break;case"Decrescendo":e.crescendo=o.Decrescendo}break;case"Arpeggio":"Up"===n.innerText?e.brushType=h.ArpeggioUp:e.brushType=h.ArpeggioDown;break;case"Properties":this.Oh(n,e);break;case"XProperties":this.Rh(n,e);break;case"FreeText":e.text=n.innerText;break;case"TransposedPitchStemOrientation":switch(n.innerText){case"Upward":e.preferredBeamDirection=Ct.Up;break;case"Downward":e.preferredBeamDirection=Ct.Down}break;case"Dynamic":switch(n.innerText){case"PPP":e.dynamics=i.PPP;break;case"PP":e.dynamics=i.PP;break;case"P":e.dynamics=i.P;break;case"MP":e.dynamics=i.MP;break;case"MF":e.dynamics=i.MF;break;case"F":e.dynamics=i.F;break;case"FF":e.dynamics=i.FF;break;case"FFF":e.dynamics=i.FFF}break;case"GraceNotes":switch(n.innerText){case"OnBeat":e.graceType=l.OnBeat;break;case"BeforeBeat":e.graceType=l.BeforeBeat}break;case"Legato":"true"===n.getAttribute("origin")&&(e.isLegatoOrigin=!0);break;case"Whammy":const t=new $(0,0);t.value=this.Ih(Qs.ja(n.getAttribute("originValue"),0)),t.offset=this.Gh(Qs.ja(n.getAttribute("originOffset"),0)),e.addWhammyBarPoint(t);const r=new $(0,0);r.value=this.Ih(Qs.ja(n.getAttribute("middleValue"),0)),r.offset=this.Gh(Qs.ja(n.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(r);const a=new $(0,0);a.value=this.Ih(Qs.ja(n.getAttribute("middleValue"),0)),a.offset=this.Gh(Qs.ja(n.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(a);const u=new $(0,0);u.value=this.Ih(Qs.ja(n.getAttribute("destinationValue"),0)),u.offset=this.Gh(Qs.ja(n.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(u);break;case"Ottavia":switch(n.innerText){case"8va":e.ottava=b._;break;case"8vb":e.ottava=b.T;break;case"15ma":e.ottava=b.S;break;case"15mb":e.ottava=b.M}break;case"Lyrics":e.lyrics=this.$h(n),this.Ea=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(n.innerText){case"Finger":e.golpe=dt.Finger;break;case"Thumb":e.golpe=dt.Thumb}break;case"Wah":switch(n.innerText){case"Open":e.wahPedal=pt.Open;break;case"Closed":e.wahPedal=pt.Closed}break;case"UserTransposedPitchStemOrientation":switch(n.innerText){case"Downward":e.preferredBeamDirection=Ct.Down;break;case"Upward":e.preferredBeamDirection=Ct.Up}break;case"Timer":e.showTimer=!0,e.timer=Qs.Ua(n.innerText,-1),e.timer<0&&(e.timer=null)}this.Sa.set(s,e)}$h(t){const e=[];for(const s of t.childElements())if("Line"===s.localName)e.push(s.innerText);return e}Rh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){let t=0;switch(s.getAttribute("id")){case"1124204546":switch(t=Qs.Ua(s.findChildElement("Int")?.innerText,0),t){case 1:e.beamingMode=gt.ForceMergeWithNext;break;case 2:e.beamingMode=gt.ForceSplitToNext}break;case"1124204552":if(t=Qs.Ua(s.findChildElement("Int")?.innerText,0),1===t)e.beamingMode!==gt.ForceSplitToNext&&(e.beamingMode=gt.ForceSplitOnSecondaryToNext);break;case"1124204545":t=Qs.Ua(s.findChildElement("Int")?.innerText,0),e.invertBeamDirection=1===t;break;case"687935489":t=Qs.Ua(s.findChildElement("Int")?.innerText,0),e.brushDuration=t}}}Lh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){if("1124139520"===s.getAttribute("id")){const t=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=Qs.ja(t?.innerText,1)}}}Fh(t,e){for(const s of e.childElements())if("XProperty"===s.localName){if("1124073984"===s.getAttribute("id"))t.displayScale=Qs.ja(s.findChildElement("Double")?.innerText,1)}}Oh(t,e){let s=!1,i=null,n=null,r=null,a=null,o=null;for(const c of t.childElements())if("Property"===c.localName){switch(c.getAttribute("name")){case"Brush":"Up"===c.findChildElement("Direction")?.innerText?e.brushType=h.BrushUp:e.brushType=h.BrushDown;break;case"PickStroke":"Up"===c.findChildElement("Direction")?.innerText?e.pickStroke=ht.Up:e.pickStroke=ht.Down;break;case"Slapped":c.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":c.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch(c.findChildElement("Strength")?.innerText){case"Wide":e.vibrato=w.Wide;break;case"Slight":e.vibrato=w.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new $(0,0)),i.value=this.Ih(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new $(0,0)),i.offset=this.Gh(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":n=this.Ih(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.Gh(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":a=this.Gh(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":o||(o=new $($.MaxPosition,0)),o.value=this.Ih(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":o||(o=new $(0,0)),o.offset=this.Gh(Qs.ja(c.findChildElement("Float")?.innerText,0));break;case"BarreFret":e.barreFret=Qs.Ua(c.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(c.findChildElement("String")?.innerText){case"0":e.barreShape=bt.Full;break;case"1":e.barreShape=bt.Half}break;case"Rasgueado":switch(c.findChildElement("Rasgueado")?.innerText){case"ii_1":e.rasgueado=mt.Ii;break;case"mi_1":e.rasgueado=mt.Mi;break;case"mii_1":e.rasgueado=mt.MiiTriplet;break;case"mii_2":e.rasgueado=mt.MiiAnapaest;break;case"pmp_1":e.rasgueado=mt.PmpTriplet;break;case"pmp_2":e.rasgueado=mt.PmpAnapaest;break;case"pei_1":e.rasgueado=mt.PeiTriplet;break;case"pei_2":e.rasgueado=mt.PeiAnapaest;break;case"pai_1":e.rasgueado=mt.PaiTriplet;break;case"pai_2":e.rasgueado=mt.PaiAnapaest;break;case"ami_1":e.rasgueado=mt.AmiTriplet;break;case"ami_2":e.rasgueado=mt.AmiAnapaest;break;case"ppp_1":e.rasgueado=mt.Ppp;break;case"amii_1":e.rasgueado=mt.Amii;break;case"amip_1":e.rasgueado=mt.Amip;break;case"eami_1":e.rasgueado=mt.Eami;break;case"eamii_1":e.rasgueado=mt.Eamii;break;case"peami_1":e.rasgueado=mt.Peami}}}s&&(i||(i=new $(0,0)),o||(o=new $($.MaxPosition,0)),e.addWhammyBarPoint(i),r&&n&&e.addWhammyBarPoint(new $(r,n)),a&&n&&e.addWhammyBarPoint(new $(a,n)),r||a||!n||e.addWhammyBarPoint(new $($.MaxPosition/2|0,n)),e.addWhammyBarPoint(o))}Ga(t){for(const e of t.childElements())if("Note"===e.localName)this.Vh(e)}Vh(t){const e=new Xt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this.Hh(i,e,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=Qs.Ua(i.innerText,-1),e.trillSpeed=c.Sixteenth;break;case"Accent":const t=Qs.Ua(i.innerText,0);1&t&&(e.isStaccato=!0),4&t&&(e.accentuated=u.Heavy),8&t&&(e.accentuated=u.Normal),16&t&&(e.accentuated=u.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=w.Slight;break;case"Wide":e.vibrato=w.Wide}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=d.Thumb;break;case"I":e.leftHandFinger=d.IndexFinger;break;case"M":e.leftHandFinger=d.MiddleFinger;break;case"A":e.leftHandFinger=d.AnnularFinger;break;case"C":e.leftHandFinger=d.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=d.Thumb;break;case"I":e.rightHandFinger=d.IndexFinger;break;case"M":e.rightHandFinger=d.MiddleFinger;break;case"A":e.rightHandFinger=d.AnnularFinger;break;case"C":e.rightHandFinger=d.LittleFinger}break;case"InstrumentArticulation":e.percussionArticulation=Qs.Ua(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=ct.Turn;break;case"InvertedTurn":e.ornament=ct.InvertedTurn;break;case"UpperMordent":e.ornament=ct.UpperMordent;break;case"LowerMordent":e.ornament=ct.LowerMordent}}this._a.set(s,e)}Hh(t,e,s){let i=!1,n=null,r=null,a=null,h=null,o=null,c=-1,l=-1,u=!1;for(const d of t.childElements())if("Property"===d.localName){switch(d.getAttribute("name")){case"ShowStringNumber":d.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=Qs.Ua(d.findChildElement("String")?.innerText,0)+1;break;case"Fret":e.fret=Qs.Ua(d.findChildElement("Fret")?.innerText,0);break;case"Element":c=Qs.Ua(d.findChildElement("Element")?.innerText,0);break;case"Variation":l=Qs.Ua(d.findChildElement("Variation")?.innerText,0);break;case"Tapped":this.Ta.set(s,!0);break;case"HarmonicType":const t=d.findChildElement("HType");if(t)switch(t.innerText){case"NoHarmonic":e.harmonicType=f.None;break;case"Natural":e.harmonicType=f.Natural;break;case"Artificial":e.harmonicType=f.Artificial;break;case"Pinch":e.harmonicType=f.Pinch;break;case"Tap":e.harmonicType=f.Tap;break;case"Semi":e.harmonicType=f.Semi;break;case"Feedback":e.harmonicType=f.Feedback}break;case"HarmonicFret":const b=d.findChildElement("HFret");b&&(e.harmonicValue=Qs.ja(b.innerText,0));break;case"Muted":d.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":d.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=Qs.Ua(d.findChildElement("Number")?.innerText,0),-1===e.tone&&(e.tone=0);break;case"Tone":e.tone=Qs.Ua(d.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":u||this.Uh(d,e);break;case"TransposedPitch":e.accidentalMode=p.Default,this.Uh(d,e),u=!0;break;case"Bended":i=!0;break;case"BendOriginValue":n||(n=new $(0,0)),n.value=this.Ih(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":n||(n=new $(0,0)),n.offset=this.Gh(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.Ih(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":a=this.Gh(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":h=this.Gh(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":o||(o=new $($.MaxPosition,0)),o.value=this.Ih(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":o||(o=new $(0,0)),o.offset=this.Gh(Qs.ja(d.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":d.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const w=Qs.Ua(d.findChildElement("Flags")?.innerText,0);1&w?e.slideOutType=g.Shift:2&w?e.slideOutType=g.Legato:4&w?e.slideOutType=g.OutDown:8&w&&(e.slideOutType=g.OutUp),16&w?e.slideInType=m.IntoFromBelow:32&w&&(e.slideInType=m.IntoFromAbove),64&w?e.slideOutType=g.PickSlideDown:128&w&&(e.slideOutType=g.PickSlideUp)}}i&&(n||(n=new $(0,0)),o||(o=new $($.MaxPosition,0)),e.addBendPoint(n),a&&r&&e.addBendPoint(new $(a,r)),h&&r&&e.addBendPoint(new $(h,r)),a||h||!r||e.addBendPoint(new $($.MaxPosition/2|0,r)),e.addBendPoint(o)),-1!==c&&-1!==l&&(e.percussionArticulation=Ut.articulationFromElementVariation(c,l))}Uh(t,e){const s=t.findChildElement("Pitch");if(s)for(const t of s.childElements())if("Accidental"===t.localName)switch(t.innerText){case"x":e.accidentalMode=p.ForceDoubleSharp;break;case"#":e.accidentalMode=p.ForceSharp;break;case"b":e.accidentalMode=p.ForceFlat;break;case"bb":e.accidentalMode=p.ForceDoubleFlat}}Ih(t){return t*Qs.aa|0}Gh(t){return t*Qs.ra}$a(t){for(const e of t.childElements())if("Rhythm"===e.localName)this.zh(e)}zh(t){const e=new Ys,s=t.getAttribute("id");e.id=s;for(const s of t.childElements())switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":e.value=c.QuadrupleWhole;break;case"DoubleWhole":e.value=c.DoubleWhole;break;case"Whole":e.value=c.Whole;break;case"Half":e.value=c.Half;break;case"Quarter":e.value=c.Quarter;break;case"Eighth":e.value=c.Eighth;break;case"16th":e.value=c.Sixteenth;break;case"32nd":e.value=c.ThirtySecond;break;case"64th":e.value=c.SixtyFourth;break;case"128th":e.value=c.OneHundredTwentyEighth;break;case"256th":e.value=c.TwoHundredFiftySixth}break;case"PrimaryTuplet":e.tupletNumerator=Qs.Ua(s.getAttribute("num"),-1),e.tupletDenominator=Qs.Ua(s.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=Qs.Ua(s.getAttribute("count"),0)}this.Ba.set(s,e)}Ca(){for(let t=0,e=this.pa.length;t<e;t++){const e=this.pa[t];this.score.addMasterBar(e)}const t=this.pa[this.pa.length-1];this.Ur.has(t)&&(this.Ur.delete(t),t.isDoubleBar=!1);const e=[];for(const t of this.da){if(!t)continue;const s=this.fa.get(t);this.score.addTrack(s),e.push(t)}let s;for(const t of this.ba){let i=0,n=0;s=[E.C,F.Major],this.Th.has(e[0])&&(s=[Vt.transposeKey(s[0],this.Th.get(e[0])),s[1]]);for(let r=0;r<t.length&&n<this.score.tracks.length;r++){const a=t[r];if(a!==Qs.na){const t=this.ma.get(a),r=this.score.tracks[n],h=r.staves[i];h.addBar(t);const o=h.bars.length-1;if(this.jr.has(o)&&(s=this.jr.get(o),this.Th.has(e[n])&&(s=[Vt.transposeKey(s[0],this.Th.get(e[n])),s[1]])),t.keySignature=s[0],t.keySignatureType=s[1],this.Ur.has(t.masterBar)&&(t.barLineRight=D.LightLight),this.ga.has(a))for(const e of this.ga.get(a))if(e!==Qs.na){const s=this.wa.get(e);if(t.addVoice(s),this.ya.has(e))for(const t of this.ya.get(e))if(t!==Qs.na){const e=ee.clone(this.Sa.get(t));s.addBeat(e);const i=this.ka.get(t),n=this.Ba.get(i);if(e.duration=n.value,e.dots=n.dots,e.tupletNumerator=n.tupletNumerator,e.tupletDenominator=n.tupletDenominator,this.xa.has(t))for(const s of this.xa.get(t))if(s!==Qs.na){const t=Qt.clone(this._a.get(s));h.isPercussion?(t.fret=-1,t.string=-1):t.percussionArticulation=-1,e.addNote(t),this.Ta.has(s)&&(e.tap=!0)}}}else{const e=new tt;t.addVoice(e);const s=new Yt;s.isEmpty=!0,s.duration=c.Quarter,e.addBeat(s)}i===r.staves.length-1?(n++,i=0):i++,s=[E.C,F.Major],n<e.length&&this.Th.has(e[n])&&(s=[Vt.transposeKey(s[0],this.Th.get(e[n])),s[1]])}else n++}}for(const t of this.da){if(!t)continue;const e=this.fa.get(t);let s=!1;for(const t of e.staves)if(t.isPercussion){s=!0;break}if(s||(e.percussionArticulations=[]),this.la.has(t)){const s=this.la.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){const s=e.staves[0].bars[t];if(s.voices.length>0&&s.voices[0].beats.length>0){const t=s.voices[0].beats[0];for(const e of i){e.type===n.Bank&&0===e.value&&0===s.index||t.automations.push(e)}}}}if(this.ua.has(t)){const s=this.ua.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){e.staves[0].bars[t].sustainPedals=i}}}for(const[t,e]of this.ca){const s=this.score.masterBars[t];for(let t=0,i=e.length;t<i;t++){const i=e[t];switch(i.type){case n.Tempo:s.tempoAutomations.push(i);break;case n.SyncPoint:i.syncPointValue.millisecondOffset-=this.Fa,s.addSyncPoint(i)}}}}}class Zs{isMultiRest=!1;trackViewGroups=[]}class ti{showNumbered=!1;showSlash=!1;showStandardNotation=!1;showTablature=!1}class ei{scoreViews=[];apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const t of i.staves)t.isPercussion||(t.showTablature=s.showTablature),t.showStandardNotation=s.showStandardNotation,t.showSlash=s.showSlash,t.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}constructor(t){const e=Re.fromBuffer(t),s=ae.readInt32BE(e);for(let t=0;t<s;t++){const t=new Zs;this.scoreViews.push(t),t.isMultiRest=js.gpReadBool(e);const s=ae.readInt32BE(e);for(let i=0;i<s;i++){let s=e.readByte();0===s&&(s=1);const i=new ti;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),t.trackViewGroups.push(i)}}}static writeForScore(t){const e=Re.withCapacity(128),s=[new Zs];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const e of t.tracks){const i=new ti;i.showStandardNotation=e.staves[0].showStandardNotation,i.showTablature=e.staves[0].showTablature,i.showSlash=e.staves[0].showSlash,i.showNumbered=e.staves[0].showNumbered,s[0].trackViewGroups.push(i);const n=new Zs;n.isMultiRest=!0===t.stylesheet.perTrackMultiBarRest?.has(e.index),n.trackViewGroups.push(i),s.push(n)}ae.writeInt32BE(e,s.length);for(const t of s){e.writeByte(t.isMultiRest?1:0),ae.writeInt32BE(e,t.trackViewGroups.length);for(const s of t.trackViewGroups){let t=0;s.showStandardNotation&&(t|=1),s.showTablature&&(t|=2),s.showSlash&&(t|=4),s.showNumbered&&(t|=8),e.writeByte(t)}}return ae.writeInt32BE(e,1),e.toArray()}}class si{trackViewGroups=[]}class ii{isVisible=!1}!function(t){t[t.PageVertical=0]="PageVertical",t[t.PageGrid=1]="PageGrid",t[t.PageParchment=2]="PageParchment",t[t.ScreenVertical=3]="ScreenVertical",t[t.ScreenHorizontal=4]="ScreenHorizontal",t[t.PageHorizontal=5]="PageHorizontal"}(Ze||(Ze={}));class ni{zoomLevel=4;view=Ze.PageVertical;muiltiVoiceCursor=!1;scoreViews=[];constructor(t,e){const s=Re.fromBuffer(e);this.zoomLevel=ae.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=t.scoreViews.length;for(let e=0;e<i;e++){const i=new si;this.scoreViews.push(i);const n=t.scoreViews[e];for(let t=0;t<n.trackViewGroups.length;t++){const t=new ii;t.isVisible=0!==s.readByte(),i.trackViewGroups.push(t)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){t.tracks[e].isVisibleOnMultiTrack=s.isVisible}e++}}}static writeForScore(t){const e=Re.withCapacity(128);ae.writeInt32BE(e,4),e.writeByte(0);const s=t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice;e.writeByte(s?255:0);for(const s of t.tracks)e.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of t.tracks)e.writeByte(255);return e.toArray()}}class ri extends We{get name(){return"Guitar Pro 7-8"}readScore(){z.debug(this.name,"Loading ZIP entries");const t=new xs(this.data);let e;try{e=t.read()}catch(t){throw new Oe("No Zip archive",t)}z.debug(this.name,"Zip entries loaded");let s=null,i=null,n=null,r=null;const a=new Map;for(const t of e)switch(a.set(t.fullName,t),t.fileName){case"score.gpif":s=ae.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=t.data;break;case"PartConfiguration":n=t.data;break;case"LayoutConfiguration":r=t.data}if(!s)throw new Oe("No score.gpif found in zip archive");z.debug(this.name,"Start Parsing score.gpif");const h=new Qs;h.loadAsset=t=>{if(a.has(t))return a.get(t).data},h.parseXml(s,this.settings),z.debug(this.name,"score.gpif parsed");const o=h.score;if(i){z.debug(this.name,"Start Parsing BinaryStylesheet");new Js(i).apply(o),z.debug(this.name,"BinaryStylesheet parsed")}let c=null;if(n&&(z.debug(this.name,"Start Parsing Part Configuration"),c=new ei(n),c.apply(o),z.debug(this.name,"Part Configuration parsed")),r&&null!=c){z.debug(this.name,"Start Parsing Layout Configuration");new ni(c,r).apply(o),z.debug(this.name,"Layout Configuration parsed")}return o}}class ai extends W{constructor(){super(s.Format,"Unexpected end of data within reader")}}class hi{static jh=8;Xh=0;Jh=hi.jh;qh;constructor(t){this.qh=t}readByte(){return this.readBits(8)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){let e=0,s=t-1;for(;s>=0;)e|=this.readBit()<<s,s--;return e}readBitsReversed(t){let e=0;for(let s=0;s<t;s++)e|=this.readBit()<<s;return e}readBit(){if(this.Jh>=8){if(this.Xh=this.qh.readByte(),-1===this.Xh)throw new ai;this.Jh=0}const t=this.Xh>>hi.jh-this.Jh-1&1;return this.Jh++,t}readAll(){const t=Re.empty();try{for(;;)t.writeByte(255&this.readByte())}catch(t){if(!(t instanceof ai))throw t}return t.toArray()}}class oi{fileName="";fileSize=0;data=null}class ci{static HeaderBcFs="BCFS";static HeaderBcFz="BCFZ";fileFilter;files=[];constructor(){this.files=[],this.fileFilter=t=>!0}load(t){const e=new hi(t);this.Yh(e)}readHeader(t){return this.Kh(t.readBytes(4),0,4)}decompress(t,e=!1){const s=Re.empty();let i;const n=this.Qh(t.readBytes(4),0);try{for(;s.length<n;){if(1===t.readBits(1)){const e=t.readBits(4),n=t.readBitsReversed(e),r=t.readBitsReversed(e),a=s.length-n,h=Math.min(n,r);i=s.getBuffer(),s.write(i,a,h)}else{const e=t.readBitsReversed(2);for(let i=0;i<e;i++)s.writeByte(t.readByte())}}}catch(t){if(!(t instanceof ai))throw t}i=s.getBuffer();const r=e?4:0,a=s.length-r,h=new Uint8Array(a),o=a;return h.set(i.subarray(r,r+o),0),h}Yh(t){const e=this.readHeader(t);if("BCFZ"===e)this.Zh(this.decompress(t,!0));else{if("BCFS"!==e)throw new Oe("Unsupported format");this.Zh(t.readAll())}}Zh(t){const e=4096;let s=e;for(;s+3<t.length;){if(2===this.Qh(t,s)){const i=new oi;i.fileName=this.Kh(t,s+4,127),i.fileSize=this.Qh(t,s+140);const n=!this.fileFilter||this.fileFilter(i.fileName);n&&this.files.push(i);const r=s+148;let a=0,h=0;const o=n?Re.withCapacity(i.fileSize):null;for(;a=this.Qh(t,r+4*h++),0!==a;)s=a*e,n&&o.write(t,s,e);if(n){i.data=new Uint8Array(Math.min(i.fileSize,o.length));const t=o.toArray();i.data.set(t.subarray(0,0+i.data.length),0)}}s+=e}}Kh(t,e,s){let i="";for(let n=0;n<s;n++){const s=255&t[e+n];if(0===s)break;i+=String.fromCharCode(s)}return i}Qh(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}}class li extends We{get name(){return"Guitar Pro 6"}readScore(){z.debug(this.name,"Loading GPX filesystem");const t=new ci;t.fileFilter=t=>t.endsWith("score.gpif")||t.endsWith("BinaryStylesheet")||t.endsWith("PartConfiguration")||t.endsWith("LayoutConfiguration"),t.load(this.data),z.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,n=null;for(const r of t.files)switch(r.fileName){case"score.gpif":e=ae.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":n=r.data}if(!e)throw new Oe("No score.gpif found in GPX");z.debug(this.name,"Start Parsing score.gpif");const r=new Qs;r.parseXml(e,this.settings),z.debug(this.name,"score.gpif parsed");const a=r.score;if(s){z.debug(this.name,"Start Parsing BinaryStylesheet");new Js(s).apply(a),z.debug(this.name,"BinaryStylesheet parsed")}let h=null;if(i&&(z.debug(this.name,"Start Parsing Part Configuration"),h=new ei(i),h.apply(a),z.debug(this.name,"Part Configuration parsed")),n&&null!=h){z.debug(this.name,"Start Parsing Layout Configuration");new ni(h,n).apply(a),z.debug(this.name,"Layout Configuration parsed")}return a}}class ui{maxLine=-1e3;maxLineNote=null;minLine=-1e3;minLineNote=null}class di{fe;eo;static so=7;static io=[38,32,30,26,38];static sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6];static flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];no=new Map;ro=new Map;ao=new Map;ho=new Map;oo=new Map;maxLineBeat=null;minLineBeat=null;maxLine=-1e3;minLine=-1e3;constructor(t){this.eo=t,this.fe=t.bar}static getPercussionLine(t,e){return e<t.staff.track.percussionArticulations.length?t.staff.track.percussionArticulations[e].staffLine:Ut.getArticulationByInputMidiNumber(e)?.staffLine??0}static getNoteValue(t){if(t.isPercussion)return t.percussionArticulation;let e=t.displayValue;switch(t.accidentalMode){case p.ForceDoubleFlat:e+=2;break;case p.ForceDoubleSharp:e-=2;break;case p.ForceFlat:e+=1;break;case p.ForceSharp:e-=1}return e}applyAccidental(t){const e=di.getNoteValue(t),s=t.hasQuarterToneOffset;return this.co(e,s,t.beat,!1,t)}applyAccidentalForValue(t,e,s,i){return this.co(e,s,t,i,null)}static computeLineWithoutAccidentals(t,e){let s=0;const i=di.getNoteValue(e);return s=e.isPercussion?di.getPercussionLine(t,i):di.calculateNoteSteps(t.keySignature,t.clef,i),s}co(t,e,s,i,n=null){let r=0,a=at.None;if(null!=n?n.isPercussion:this.fe.staff.isPercussion)r=di.getPercussionLine(this.fe,t);else{const s=n?n.accidentalMode:p.Default;r=di.calculateNoteSteps(this.fe.keySignature,this.fe.clef,t);const i=this.no.has(r)?this.no.get(r):null;a=Vt.computeAccidental(this.fe.keySignature,s,t,e,i);let h=!1;switch(a){case at.NaturalQuarterNoteUp:case at.SharpQuarterNoteUp:case at.FlatQuarterNoteUp:break;default:if(n&&n.isTieDestination&&0===n.beat.index){const t=this.eo.scoreRenderer.layout?.getRendererForBar(this.eo.staff.staffId,n.tieOrigin.beat.voice.bar);if(t&&t.staff===this.eo.staff){t.accidentalHelper.getNoteLine(n.tieOrigin)===r&&(h=!0)}}h?a=at.None:a!==at.None&&this.no.set(r,a)}}return n?(this.ro.set(n.id,r),this.ho.set(t,n)):this.ao.set(t,r),(-1e3===this.minLine||this.minLine<r)&&(this.minLine=r,this.minLineBeat=s),(-1e3===this.maxLine||this.maxLine>r)&&(this.maxLine=r,this.maxLineBeat=s),i||this.lo(s,r,n),a}lo(t,e,s){let i;this.oo.has(t.id)?i=this.oo.get(t.id):(i=new ui,this.oo.set(t.id,i)),(-1e3===i.minLine||e<i.minLine)&&(i.minLine=e,i.minLineNote=s),(-1e3===i.minLine||e>i.maxLine)&&(i.maxLine=e,i.maxLineNote=s)}getMaxLine(t){return this.oo.has(t.id)?this.oo.get(t.id).maxLine:0}getMaxLineNote(t){return this.oo.has(t.id)?this.oo.get(t.id).maxLineNote:null}getMinLine(t){return this.oo.has(t.id)?this.oo.get(t.id).minLine:0}getMinLineNote(t){return this.oo.has(t.id)?this.oo.get(t.id).minLineNote:null}static calculateNoteSteps(t,e,s){const i=t,n=e,r=s%12,a=(s/12|0)-1;let h=di.io[n];h-=a*di.so;return h-=(Vt.keySignatureIsSharp(i)||Vt.keySignatureIsNatural(i)?di.sharpNoteSteps:di.flatNoteSteps)[r],h}getNoteLine(t){return this.ro.get(t.id)}getNoteLineForValue(t,e=!1){return this.ao.has(t)?this.ao.get(t):e&&this.ho.has(t)?this.getNoteLine(this.ho.get(t)):0}}class fi{slurStarts;currentDynamics=i.F;tieStarts;tieStartIds;slideOrigins=new Map;transpose=0;isExplicitlyBeamed=!1;constructor(){this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class pi extends Ht{outputMidiChannel=-1;outputMidiProgram=-1;outputMidiBank=-1;outputVolume=-1;outputBalance=-1}class bi{track;firstArticulation;instruments=new Map;uo=new Map;do=0;fo=new Map;constructor(t){this.track=t}getLyricLine(t){if(this.fo.has(t))return this.fo.get(t);const e=this.do;return this.fo.set(t,e),this.do++,e}static po=new Ht("Default",0,0,rt.NoteheadBlack,rt.NoteheadHalf,rt.NoteheadWhole);getOrCreateArticulation(t,e){const s=12*e.octave+e.tone,i=`${t}_${s}`;if(this.uo.has(i))return this.uo.get(i);let n;n=this.instruments.has(t)?this.instruments.get(t):bi.po;const r=this.track.percussionArticulations.length,a=e.beat.voice.bar;let h;h=0===s?4:di.calculateNoteSteps(a.keySignature,a.clef,s);const o=h-(9-(2*e.beat.voice.bar.staff.standardNotationLineCount-1)),c=new Ht(n.elementType,o,n.outputMidiNumber,n.noteHeadDefault,n.noteHeadHalf,n.noteHeadWhole,n.techniqueSymbol,n.techniqueSymbolPlacement);return this.uo.set(i,r),this.track.percussionArticulations.push(c),r}}class mi extends We{ue;bo=new Map;mo=new Map;wo=new Map;yo=1;ko=i.F;get name(){return"MusicXML"}readScore(){const t=this.So(),e=new Ps;try{e.parse(t)}catch(t){throw new Oe("Unsupported format",t)}return this.ue=new Ot,this.ue.stylesheet.hideDynamics=!0,this.An(e),Vt.consolidate(this.ue),this.ue.finish(this.settings),this.ue.rebuildRepeatGroups(),this.ue}So(){const t=new xs(this.data);let e;try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),ae.toString(this.data.readAll(),this.settings.importer.encoding);const s=e.find(t=>"META-INF/container.xml"===t.fullName);if(!s)throw new Oe("No compressed MusicXML");const i=new Ps;try{i.parse(ae.toString(s.data,this.settings.importer.encoding))}catch(t){throw new Oe("Malformed container.xml, could not parse as XML",t)}const n=i.firstElement;if(!n||"container"!==n.localName)throw new Oe("Malformed container.xml, root element not 'container'");const r=n.findChildElement("rootfiles");if(!r)throw new Oe("Malformed container.xml, 'container/rootfiles' not found");let a="";for(const t of r.childElements())if("rootfile"===t.localName){a=t.getAttribute("full-path");break}if(!a)throw new Oe("Unsupported compressed MusicXML, missing rootfile");const h=e.find(t=>t.fullName===a);if(!h)throw new Oe(`Malformed container.xml, '${a}' not contained in zip`);return ae.toString(h.data,this.settings.importer.encoding)}An(t){const e=t.firstElement;if(!e)throw new Oe("Unsupported format");switch(e.localName){case"score-partwise":this.Bo(e);break;case"score-timewise":this._o(e);break;default:throw new Oe("Unsupported format")}}Bo(t){for(const e of t.childElements())switch(e.localName){case"credit":this.xo(e);break;case"identification":this.To(e);break;case"movement-title":this.Mo(e);break;case"part":this.vo(e);break;case"part-list":this.No(e);break;case"work":this.Po(e)}}_o(t){let e=0;for(const s of t.childElements())switch(s.localName){case"credit":this.xo(s);break;case"identification":this.To(s);break;case"movement-title":this.Mo(s);break;case"part-list":this.No(s);break;case"work":this.Po(s);break;case"measure":this.Eo(s,e),e++}}xo(t){if("1"!==t.getAttribute("page","1"))return;const e=[];let s=null,i="";for(const n of t.childElements())switch(n.localName){case"credit-type":e.push(n.innerText);break;case"credit-words":null===s&&(s=n),i+=n.innerText}if(e.length>0)for(const t of e)switch(t){case"title":this.ue.title=mi.Fo(i);break;case"subtitle":this.ue.subTitle=mi.Fo(i);break;case"composer":case"arranger":this.ue.artist=mi.Fo(i);break;case"lyricist":this.ue.words=mi.Fo(i);break;case"rights":this.ue.copyright=mi.Fo(i)}else if(s){const t=s.getAttribute("font-size","0"),e=s.getAttribute("font-size","top"),n=s.getAttribute("halign","left");if("top"===e){if(i.includes("copyright")||i.includes("Copyright")||i.includes("©")||i.includes("(c)")||i.includes("(C)"))return void(this.ue.copyright=mi.Fo(i));if("center"===n||"center"===t){if(0===this.ue.title.length)return void(this.ue.title=mi.Fo(i));if(0===this.ue.subTitle.length)return void(this.ue.subTitle=mi.Fo(i));if(0===this.ue.album.length)return void(this.ue.album=mi.Fo(i))}else if(("right"===n||"right"===t)&&0===this.ue.music.length)return void(this.ue.music=mi.Fo(i));if(0===this.ue.artist.length)return void(this.ue.artist=mi.Fo(i));if(0===this.ue.words.length)return void(this.ue.words=mi.Fo(i))}}}static Fo(t){return t.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","  ").replaceAll(" "," ")}To(t){for(const e of t.childElements())switch(e.localName){case"creator":if(e.attributes.has("type"))switch(e.attributes.get("type")){case"composer":this.ue.artist=mi.Fo(e.innerText);break;case"lyricist":this.ue.words=mi.Fo(e.innerText);break;case"arranger":this.ue.music=mi.Fo(e.innerText)}else this.ue.artist=mi.Fo(e.innerText);break;case"rights":this.ue.copyright.length>0&&(this.ue.copyright+=", "),this.ue.copyright+=e.innerText,e.attributes.has("type")&&(this.ue.copyright+=` (${e.attributes.get("type")})`);break;case"encoding":this.Co(e)}}Co(t){for(const e of t.childElements())switch(e.localName){case"encoder":this.ue.tab.length>0&&(this.ue.tab+=", "),this.ue.tab+=e.innerText,e.attributes.has("type")&&(this.ue.tab+=` (${e.attributes.get("type")})`);break;case"encoding-description":this.ue.notices+=mi.Fo(e.innerText)}}Mo(t){0===this.ue.title.length?this.ue.title=mi.Fo(t.innerText):this.ue.subTitle=mi.Fo(t.innerText)}No(t){for(const e of t.childElements())if("score-part"===e.localName)this.Ao(e)}Ao(t){const e=new Be;e.ensureStaveCount(1),this.ue.addTrack(e);const s=t.attributes.get("id"),i=new bi(e);this.bo.set(s,i),this.mo.set(e.index,i);for(const s of t.childElements())switch(s.localName){case"part-name":e.name=mi.Fo(s.innerText);break;case"part-name-display":e.name=this.Do(s);break;case"part-abbreviation":e.shortName=mi.Fo(s.innerText);break;case"part-abbreviation-display":e.shortName=this.Do(s);break;case"score-instrument":this.Lo(s,i);break;case"midi-device":s.attributes.has("port")&&(e.playbackInfo.port=Number.parseInt(s.attributes.get("port"),10));break;case"midi-instrument":this.Wo(s,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(e.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(e.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(e.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(e.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(e.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,e.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}Lo(t,e){const s=new pi;e.firstArticulation||(e.firstArticulation=s),e.instruments.set(t.getAttribute("id",""),s)}Wo(t,e){const s=t.getAttribute("id","");if(!e.instruments.has(s))return;const i=e.instruments.get(s);for(const e of t.childElements())switch(e.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(e.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(e.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(e.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(e.innerText,10)-1;break;case"volume":i.outputVolume=mi.Oo(Number.parseFloat(e.innerText));break;case"pan":i.outputBalance=mi.Ro(Number.parseFloat(e.innerText))}}static Oo(t){return 0|mi.Io(0,100,0,16,t)}static Ro(t){return 0|mi.Io(-90,90,0,16,t)}static Io(t,e,s,i,n){return s+(i-s)*((n-t)/(e-t))}Do(t){let e="";for(const s of t.childElements())switch(s.localName){case"display-text":e+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":e+="♯";break;case"natural":e+="♮";break;case"flat":e+="♭";break;case"double-sharp":e+="𝄪";break;case"sharp-sharp":e+="♯♯";break;case"flat-flat":e+="𝄫";break;case"natural-sharp":e+="♮♯";break;case"natural-flat":e+="♮♭";break;case"sharp-down":e+="𝄱";break;case"sharp-up":e+="𝄰";break;case"natural-down":e+="𝄯";break;case"natural-up":e+="𝄮";break;case"flat-down":e+="𝄭";break;case"flat-up":e+="𝄬";break;case"arrow-down":e+="↓";break;case"arrow-up":e+="↑";break;case"triple-sharp":e+="♯𝄪";break;case"triple-flat":e+="𝄬𝄬𝄬";break;case"sharp-1":e+="♯¹";break;case"sharp-2":e+="♯²";break;case"sharp-3":e+="♯³";break;case"sharp-4":e+="♯⁴";break;case"sharp-5":e+="♯⁵";break;case"flat-1":e+="♭¹";break;case"flat-2":e+="♭²";break;case"flat-3":e+="♭³";break;case"flat-4":e+="♭⁴";break;case"flat-5":e+="♭⁵"}}return mi.Fo(e)}Po(t){for(const e of t.childElements())if("work-title"===e.localName)this.ue.title=mi.Fo(e.innerText)}vo(t){const e=t.attributes.get("id");if(!e||!this.bo.has(e))return;const s=this.bo.get(e).track;let i=0;for(const e of t.childElements())if("measure"===e.localName)this.Go(e,s,i),i++}Go(t,e,s){const i=this.$o(t,s);this.Vo(t,i,e)}Eo(t,e){const s=this.$o(t,e);for(const e of t.childElements())if("part"===e.localName)this.Ho(e,s)}$o(t,e){const s="yes"===t.attributes.get("implicit");for(;this.ue.masterBars.length<=e;){const t=new Rt;s&&(t.isAnacrusis=!0),this.ue.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return this.ue.masterBars[e]}Ho(t,e){const s=t.attributes.get("id");if(!s||!this.bo.has(s))return;const i=this.bo.get(s).track;this.Vo(t,e,i)}Uo=0;zo=null;Vo(t,e,s){this.Uo=0,this.zo=null,e.alternateEndings=this.jo;const i=[];for(const n of t.childElements())switch(n.localName){case"note":this.Vh(n,e,s);break;case"backup":this.Xo(n);break;case"forward":this.Jo(n);break;case"direction":this.qo(n,e,s);break;case"attributes":this.Yo(n,e,s);break;case"harmony":this.Ko(n,s);break;case"print":this.Qo(n,e,s);break;case"sound":this._h(n,e,s);break;case"barline":i.push(n)}for(const t of i)this.Zo(t,e,s);this.tc(e,s);const n=this.ec(s,0);this.ar(n,e),this.sc=null}Qo(t,e,s){("yes"===t.getAttribute("new-system","no")||"yes"===t.getAttribute("new-page","no"))&&s.addLineBreaks(e.index)}tc(t,e){if(null!==this.nc){for(const s of e.staves){const e=this.ar(s,t);e.simileMark=this.nc,e.simileMark!==P.None&&this.rc(e)}this.nc===P.FirstOfDouble?this.nc=P.SecondOfDouble:this.nc=null}if(null!==this.ac){const s=Array.from(this.ac.keys());for(const i of s){const s=this.ec(e,i),n=this.ar(s,t);n.simileMark=this.ac.get(i),n.simileMark!==P.None&&this.rc(n),n.simileMark===P.FirstOfDouble?this.ac.set(i,P.SecondOfDouble):this.ac.delete(i)}0===this.ac.size&&(this.ac=null)}}rc(t){for(const e of t.voices){const t=new Yt;t.isEmpty=!0,e.addBeat(t)}}Zo(t,e,s){for(const i of t.childElements())switch(i.localName){case"bar-style":this.hc(i,e,s,t.getAttribute("location","right"));break;case"ending":this.oc(i,e);break;case"repeat":this.cc(i,e)}}cc(t,e){const s=t.getAttribute("direction");let i=Number.parseInt(t.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?e.repeatCount=i:"forward"===s&&(e.isRepeatStart=!0)}jo=0;oc(t,e){const s=t.getAttribute("number").split(",").map(t=>Number.parseInt(t,10));let i=0;for(const t of s)i|=1<<t-1&255;switch(e.alternateEndings=i,t.getAttribute("type","")){case"start":this.jo=this.jo|i;break;case"stop":case"discontinue":this.jo=this.jo&~i}}hc(t,e,s,i){let n=D.Automatic;switch(t.innerText){case"dashed":n=D.Dashed;break;case"dotted":n=D.Dotted;break;case"heavy":n=D.Heavy;break;case"heavy-heavy":n=D.HeavyHeavy;break;case"heavy-light":n=D.HeavyLight;break;case"light-heavy":n=D.LightHeavy;break;case"light-light":n=D.LightLight;break;case"none":n=D.None;break;case"regular":n=D.Regular;break;case"short":n=D.Short;break;case"tick":n=D.Tick}for(const t of s.staves){const s=this.ar(t,e);switch(i){case"left":s.barLineLeft=n;break;case"right":s.barLineRight=n}}}_h(t,e,s){for(const s of t.childElements())switch(s.localName){case"midi-instrument":this.lc(s,e);break;case"swing":this.uc(s,e)}if(t.attributes.has("coda")&&e.addDirection(Ke.TargetCoda),t.attributes.has("tocoda")&&e.addDirection(Ke.JumpDaCoda),t.attributes.has("dacapo")&&e.addDirection(Ke.JumpDaCapo),t.attributes.has("dalsegno")&&e.addDirection(Ke.JumpDalSegno),t.attributes.has("fine")&&e.addDirection(Ke.TargetFine),t.attributes.has("segno")&&e.addDirection(Ke.TargetSegno),t.attributes.has("pan")){this.dc||(this.dc=[]);const e=new G;e.type=n.Balance,e.value=mi.Ro(Number.parseFloat(t.attributes.get("pan"))),this.dc.push(e)}if(t.attributes.has("tempo")){this.dc||(this.dc=[]);const e=new G;e.type=n.Tempo,e.value=mi.Oo(Number.parseFloat(t.attributes.get("tempo"))),this.dc.push(e)}}uc(t,e){let s=0,i=0,n=null;for(const r of t.childElements())switch(r.localName){case"straight":return void(e.tripletFeel=nt.NoTripletFeel);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":n=this.fc(r)}n||(n=c.Eighth),n===c.Eighth?2===s&&1===i?e.tripletFeel=nt.Triplet8th:3===s&&1===i?e.tripletFeel=nt.Dotted8th:1===s&&3===i&&(e.tripletFeel=nt.Scottish8th):n===c.Sixteenth&&(2===s&&1===i?e.tripletFeel=nt.Triplet16th:3===s&&1===i?e.tripletFeel=nt.Dotted16th:1===s&&3===i&&(e.tripletFeel=nt.Scottish16th))}dc=null;bc=null;mc=null;gc=!1;wc=!1;yc=null;kc=null;lc(t,e){let s;for(const e of t.childElements())switch(e.localName){case"midi-bank":this.dc||(this.dc=[]),s=new G,s.type=n.Bank,s.value=Number.parseInt(e.innerText,10)-1,this.dc.push(s);break;case"midi-program":this.dc||(this.dc=[]),s=new G,s.type=n.Instrument,s.value=Number.parseInt(e.innerText,10)-1,this.dc.push(s);break;case"volume":this.dc||(this.dc=[]),s=new G,s.type=n.Volume,s.value=mi.Oo(Number.parseFloat(e.innerText)),this.dc.push(s);break;case"pan":this.dc||(this.dc=[]),s=new G,s.type=n.Balance,s.value=mi.Ro(Number.parseFloat(e.innerText)),this.dc.push(s)}}Ko(t,e){const s=new de;let i=!1,n="";for(const e of t.childElements())switch(e.localName){case"root":s.name=this.Sc(e);break;case"kind":s.name=s.name+this.Bc(e),"yes"===e.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this._c(e,s);break;case"degree":n+=this.xc(e)}n&&(s.name+=i?`(${n})`:n),null===this.bc&&(this.bc=s)}xc(t){let e="",s="",i="";for(const n of t.childElements())switch(n.localName){case"degree-value":e=n.innerText;break;case"degree-alter":switch(n.innerText){case"-1":s="♭";break;case"1":s="♯"}break;case"degree-type":i+=n.getAttribute("text","")}return`${i}${s}${e}`}Sc(t){let e="",s="";for(const i of t.childElements())switch(i.localName){case"root-step":e=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return e+s}Bc(t){const e=t.getAttribute("text");let s="";if(e)s=e;else{const e=t.innerText;switch(e){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="○";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="○7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="⍉";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="♭II";break;case"Italian":s="It⁺⁶";break;case"French":case"German":s="Fr⁺⁶";break;default:s=e}}return s}_c(t,e){for(const s of t.childElements())switch(s.localName){case"frame-strings":const t=Number.parseInt(s.innerText,10);e.strings=new Array(t);for(let s=0;s<t;s++)e.strings[s]=-1;break;case"first-fret":e.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,n=null;for(const t of s.childElements())switch(t.localName){case"string":i=Number.parseInt(t.innerText,10);break;case"fret":n=Number.parseInt(t.innerText,10),i&&n>=0&&(e.strings[i-1]=n);break;case"barre":i&&n&&"start"===t.getAttribute("type")&&e.barreFrets.push(n)}}}Yo(t,e,s){let i,n,r;if(null==this.zo)for(const a of t.childElements())switch(a.localName){case"divisions":this.yo=Number.parseFloat(a.innerText);break;case"key":this.Tc(a,e,s);break;case"time":this.sr(a,e);break;case"staves":s.ensureStaveCount(Number.parseInt(a.innerText,10));break;case"clef":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.ec(s,i),r=this.ar(n,e),this.qn(a,r);break;case"staff-details":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.ec(s,i),this.Mc(a,n);break;case"transpose":this.ih(a,s);break;case"measure-style":this.vc(a,s,!1)}else for(const e of t.childElements())switch(e.localName){case"divisions":this.yo=Number.parseFloat(e.innerText);break;case"measure-style":this.vc(e,s,!0)}}nc=null;ac=null;Nc=!1;vc(t,e,s){for(const e of t.childElements())switch(e.localName){case"measure-repeat":if(!s){let s=null;switch(e.getAttribute("type")){case"start":switch(Number.parseInt(e.getAttribute("slashes","1"),10)){case 1:s=P.Simple;break;case 2:s=P.FirstOfDouble}break;case"stop":s=null}if(t.attributes.has("number")){this.ac=this.ac??new Map;const e=Number.parseInt(t.attributes.get("number"),10)-1;null==s?this.ac.delete(e):this.ac.set(e,s)}else this.nc=s}break;case"slash":switch(e.getAttribute("type")){case"start":this.Nc=!0;break;case"stop":this.Nc=!1}}}ih(t,e){let s=0;for(const e of t.childElements())switch(e.localName){case"chromatic":s+=Number.parseFloat(e.innerText);break;case"octave-change":s+=12*Number.parseFloat(e.innerText)}if(t.attributes.has("number")){const i=this.ec(e,Number.parseInt(t.attributes.get("number"),10)-1);this.Pc(i).transpose=s,i.displayTranspositionPitch=s}else for(const t of e.staves)this.Pc(t).transpose=s,t.displayTranspositionPitch=s}Mc(t,e){for(const s of t.childElements())switch(s.localName){case"staff-lines":e.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this.Ec(s,e);break;case"capo":e.capo=Number.parseInt(s.innerText,10)}}Ec(t,e){0===e.stringTuning.tunings.length&&(e.showTablature=!0,e.showStandardNotation=!1,e.stringTuning.tunings=new Array(e.standardNotationLineCount).fill(0));const s=Number.parseInt(t.getAttribute("line"),10);let i="C",n="",r=0;for(const e of t.childElements())switch(e.localName){case"tuning-step":i=e.innerText;break;case"tuning-alter":r=Number.parseFloat(e.innerText);break;case"tuning-octave":n=e.innerText}const a=Vt.getTuningForText(i+n)+r;e.tuning[e.tuning.length-s]=a}qn(t,e){let s="s",i=0;for(const n of t.childElements())switch(n.localName){case"sign":s=n.innerText.toLowerCase();break;case"line":i=Number.parseInt(n.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(n.innerText,10)){case-2:e.clefOttava=b.M;break;case-1:e.clefOttava=b.T;break;case 1:e.clefOttava=b._;break;case 2:e.clefOttava=b.M}}switch(s){case"g":default:e.clef=N.G2;break;case"f":e.clef=N.F4;break;case"c":e.clef=3===i?N.C3:N.C4;break;case"percussion":e.clef=N.Neutral,e.staff.isPercussion=!0;break;case"tab":e.clef=N.G2,e.staff.showTablature=!0}}sr(t,e){let s=!1,i=!1;for(const n of t.childElements()){const t=n.innerText;switch(n.localName){case"beats":s||(-1===t.indexOf("+")?e.timeSignatureNumerator=Number.parseInt(t,10):e.timeSignatureNumerator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),s=!0);break;case"beat-type":i||(-1===t.indexOf("+")?e.timeSignatureDenominator=Number.parseInt(t,10):e.timeSignatureDenominator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),i=!0)}}switch(t.getAttribute("symbol","")){case"common":case"cut":e.timeSignatureCommon=!0}}sc=null;Tc(t,e,s){let i,n,r=-E.C,a="";for(const e of t.childElements())switch(e.localName){case"fifths":r=Number.parseInt(e.innerText,10);break;case"mode":a=e.innerText}if(i=-7<=r&&r<=7?r:E.C,n="minor"===a?F.Minor:F.Major,t.attributes.has("number")){const r=this.ec(s,Number.parseInt(t.attributes.get("number"),10)-1),a=this.ar(r,e);a.keySignature=i,a.keySignatureType=n}else{this.sc=[i,n];for(const t of s.staves)t.bars.length>e.index&&(t.bars[e.index].keySignature=i,t.bars[e.index].keySignatureType=n)}}qo(t,e,s){const i=[];let r=null,a=-1,h=-1;for(const e of t.childElements())switch(e.localName){case"direction-type":const t=e.firstElement;t&&i.push(t);break;case"offset":r=Number.parseFloat(e.innerText);break;case"voice":break;case"staff":a=Number.parseInt(e.innerText,10)-1;break;case"sound":e.attributes.has("tempo")&&(h=Number.parseFloat(e.attributes.get("tempo")))}let c=null;c=a>=0?this.ec(s,a):null!==this.zo?this.zo.voice.bar.staff:this.ec(s,0);const l=c?this.ar(c,e):null,u=()=>{let t=this.Uo;null!==r&&(t+=r);return t/e.calculateDuration(!1)};if(h>0){const t=new G;t.type=n.Tempo,t.value=h,t.ratioPosition=u(),this.Fc(e,t)||e.tempoAutomations.push(t)}let d="";for(const t of i)switch(t.localName){case"rehearsal":e.section=new ge,e.section.marker=t.innerText;break;case"segno":e.addDirection(Ke.TargetSegno);break;case"coda":e.addDirection(Ke.TargetCoda);break;case"words":d=t.innerText;break;case"wedge":switch(t.getAttribute("type")){case"crescendo":this.mc=o.Crescendo;break;case"diminuendo":this.mc=o.Decrescendo;break;case"stop":this.mc=null}break;case"dynamics":const s=this.Cc(t);null!==s&&(this.ko=s,this.ue.stylesheet.hideDynamics=!1);break;case"dashes":const i=t.getAttribute("type","start");switch(d){case"LetRing":this.gc="start"===i||"continue"===i;break;case"P.M.":this.wc="start"===i||"continue"===i}d="";break;case"pedal":const n=this.Ac(t);if(n&&l){n.ratioPosition=u();const t=l.sustainPedals.length>0&&l.sustainPedals[l.sustainPedals.length-1].pedalType!==C.Up;(n.pedalType!==C.Up||t)&&l.sustainPedals.push(n)}break;case"metronome":this.Dc(t,e,u());break;case"octave-shift":this.yc=this.Lc(t)}d&&(this.kc=d)}Lc(t){const e=t.getAttribute("type");switch(Number.parseInt(t.getAttribute("size","8"),10)){case 15:switch(e){case"up":return b.M;case"down":return b.S;case"stop":return b.Regular;case"continue":return this.yc}break;case 8:switch(e){case"up":return b.T;case"down":return b._;case"stop":return b.Regular;case"continue":return this.yc}}return null}Dc(t,e,s){let i=null,r=-1;for(const e of t.childElements())switch(e.localName){case"beat-unit":i=this.fc(e);break;case"per-minute":r=Number.parseFloat(e.innerText)}if(null!==i&&r>0){const t=new G;t.type=n.Tempo,t.value=r*(i/4)|0,t.ratioPosition=s,this.Fc(e,t)||e.tempoAutomations.push(t)}}Fc(t,e){for(const s of t.tempoAutomations)if(e.ratioPosition===s.ratioPosition&&e.value===s.value)return!0;return!1}Ac(t){const e=new q;switch(t.getAttribute("type")){case"start":e.pedalType=C.Down;break;case"stop":e.pedalType=C.Up;break;case"continue":e.pedalType=C.Hold;break;default:return null}return e}Cc(t){for(const e of t.childElements()){const t=e.localName.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return i[t]}}return null}Jo(t){for(const e of t.childElements())if("duration"===e.localName)this.Uo+=this.Wc(Number.parseFloat(e.innerText))}Xo(t){for(const e of t.childElements())if("duration"===e.localName){if(this.zo){let t=this.Uo;t-=this.Wc(Number.parseFloat(e.innerText)),t<0&&(t=0),this.Uo=t}}}ec(t,e){for(;t.staves.length<=e;){const e=new ye;t.addStaff(e),this.ue.masterBars.length>0&&this.ar(e,this.ue.masterBars[this.ue.masterBars.length-1])}return t.staves[e]}ar(t,e){const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<=e.index;){const e=new K;t.addBar(e),e.previousBar&&(e.clef=e.previousBar.clef,e.clefOttava=e.previousBar.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType),null!=this.sc&&(e.keySignature=this.sc[0],e.keySignatureType=this.sc[1]);for(let t=0;t<s;t++){const t=new tt;e.addVoice(t)}}return t.bars[e.index]}Oc(t,e){let s=!1;for(;t.voices.length<=e;)t.addVoice(new tt),s=!0;if(s)for(const s of t.staff.bars)for(;s.voices.length<=e;)s.addVoice(new tt);return t.voices[e]}Vh(t,e,s){let i=null,n=l.None,r=0,a=null,h=!1,o=0,u=0,d=-1,f=null,p=0,b=-1,m=-1,g=null,w=null,y=!1,k=null;const S="no"!==t.getAttribute("print-object","yes"),B=()=>{if(null!==i)return;h&&!this.zo&&(z.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),h=!1),h&&!w&&(z.warning("MusicXML","Cannot mix <chord /> and <rest />"),h=!1);const t=this.ec(s,o);if(h)return i=this.zo,void i.addNote(w);const B=this.ar(t,e),_=this.Oc(B,u),x=0===_.beats.length?0:_.beats[_.beats.length-1].displayEnd;let T=this.Uo-x;if(T>0){if(this.zo&&this.zo.beamingMode===gt.ForceMergeWithNext&&this.zo.voice.bar.staff.index!==o&&_.beats.length>0&&_.beats[_.beats.length-1].beamingMode===gt.ForceMergeWithNext){const t=_.beats[_.beats.length-1].duration;for(;T>0;){const e=this.Rc(T,t);if(null===e)break;this.Ic(e,_),T-=e.playbackDuration}}if(T>0){const t=new Yt;t.dynamics=this.ko,t.isEmpty=!0,t.duration=c.TwoHundredFiftySixth,t.overrideDisplayDuration=T,t.updateDurations(),this.Ic(t,_)}}else T<0&&z.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==f&&(d=R.toTicks(f),p>0&&(d=R.applyDot(d,2===p)));const M=new Yt;i=M,null===a?M.beamingMode=this.Pc(t).isExplicitlyBeamed?gt.ForceSplitToNext:gt.Auto:(M.beamingMode=a,this.Pc(t).isExplicitlyBeamed=!0),M.isEmpty=!1,M.dynamics=this.ko,this.Nc&&(M.slashed=!0);const v=this.dc;if(this.dc=null,null!==v)for(const t of v)M.automations.push(t);const N=this.bc;this.bc=null,null!==N&&(M.chordId=N.uniqueId,_.bar.staff.hasChord(N.uniqueId)||_.bar.staff.addChord(M.chordId,N));const P=this.mc;null!==P&&(M.crescendo=P);const E=this.yc;if(null!==E&&(M.ottava=E),M.isLetRing=this.gc,M.isPalmMute=this.wc,this.kc&&(M.text=this.kc,this.kc=null),null!==w&&M.addNote(w),this.Ic(M,_),null!==w){w.isVisible=S;const t=this.mo.get(s.index);null!==k?w.percussionArticulation=t.getOrCreateArticulation(k,w):y||(w.percussionArticulation=t.getOrCreateArticulation("",w))}n!==l.None?(M.graceType=n,this.Gc(M,r,null,!1)):(M.tupletNumerator=b,M.tupletDenominator=m,M.dots=p,M.preferredBeamDirection=g,this.Gc(M,d,f,!0)),this.Uo=M.displayEnd,this.zo=M};for(const e of t.childElements())switch(e.localName){case"grace":const t=Number.parseFloat(e.getAttribute("make-time","-1"));t>=0?(r=this.Wc(t),n=l.BeforeBeat):n=l.OnBeat,"yes"===e.getAttribute("slash")&&(n=l.BeforeBeat);break;case"chord":h=!0;break;case"cue":return;case"pitch":w=this.$c(e),y=!0;break;case"unpitched":w=this.Vc(e,s);break;case"rest":w=null,null===f&&(f=c.Whole);break;case"duration":d=this.mi(e);break;case"instrument":k=e.getAttribute("id","");break;case"voice":u=Number.parseInt(e.innerText,10),Number.isNaN(u)?(z.warning("MusicXML","Voices need to be specified as numbers"),u=0):u-=1;break;case"type":f=this.fc(e);break;case"dot":p++;break;case"accidental":null===w?z.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.Hc(e,w);break;case"time-modification":for(const t of e.childElements())switch(t.localName){case"actual-notes":b=Number.parseInt(t.innerText,10);break;case"normal-notes":m=Number.parseInt(t.innerText,10)}break;case"stem":g=this.Uc(e);break;case"notehead":null===w?z.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.fh(e,w,f??c.Quarter,g??this.zc(w));break;case"staff":o=Number.parseInt(e.innerText,10)-1;break;case"beam":if("1"===e.getAttribute("number","1"))switch(e.innerText){case"begin":case"continue":a=gt.ForceMergeWithNext;break;case"end":a=gt.ForceSplitToNext}break;case"notations":B(),this.jc(e,w,i);break;case"lyric":B(),this.yr(e,i,s);break;case"play":this.Xc(e,w)}if(y){const t=this.ec(s,o),e=this.Pc(t).transpose;if(0!==e){const t=12*w.octave+w.tone+e;w.octave=t/12|0,w.tone=t-12*w.octave}}B()}Xc(t,e){for(const s of t.childElements())if("mute"===s.localName)e&&"palm"===s.innerText&&(e.isPalmMute=!0)}static Jc=71;zc(t){return t.calculateRealValue(!1,!1)<mi.Jc?Ct.Down:Ct.Up}fh(t,e,s,i){"yes"===t.getAttribute("parentheses","no")&&(e.isGhost=!0);const n=t.getAttribute("filled","");let r;switch("yes"===n?r=!0:"no"===n&&(r=!1),e.style=new jt,t.innerText){case"arrow down":e.style.noteHeadCenterOnStem=!0,this.qc(e,s,r,rt.NoteheadTriangleDownDoubleWhole,rt.NoteheadTriangleDownWhole,rt.NoteheadTriangleDownHalf,rt.NoteheadTriangleDownBlack);break;case"arrow up":e.style.noteHeadCenterOnStem=!0,this.qc(e,s,r,rt.NoteheadTriangleUpDoubleWhole,rt.NoteheadTriangleUpWhole,rt.NoteheadTriangleUpHalf,rt.NoteheadTriangleUpBlack);break;case"back slashed":this.qc(e,s,r,rt.NoteheadSlashedDoubleWhole2,rt.NoteheadSlashedWhole2,rt.NoteheadSlashedHalf2,rt.NoteheadSlashedBlack2);break;case"circle dot":e.style.noteHead=rt.NoteheadRoundWhiteWithDot;break;case"circle-x":this.qc(e,s,r,rt.NoteheadCircleXDoubleWhole,rt.NoteheadCircleXWhole,rt.NoteheadCircleXHalf,rt.NoteheadCircleX);break;case"circled":this.qc(e,s,r,rt.NoteheadCircledDoubleWhole,rt.NoteheadCircledWhole,rt.NoteheadCircledHalf,rt.NoteheadCircledBlack);break;case"cluster":this.qc(e,s,r,rt.NoteheadClusterDoubleWhole3rd,rt.NoteheadClusterWhole3rd,rt.NoteheadClusterHalf3rd,rt.NoteheadClusterQuarter3rd);break;case"cross":this.qc(e,s,r,rt.NoteheadPlusDoubleWhole,rt.NoteheadPlusWhole,rt.NoteheadPlusHalf,rt.NoteheadPlusBlack);break;case"diamond":this.qc(e,s,r,rt.NoteheadDiamondDoubleWhole,rt.NoteheadDiamondWhole,rt.NoteheadDiamondHalf,rt.NoteheadDiamondBlack);break;case"do":this.qc(e,s,r,rt.NoteShapeTriangleUpWhite,rt.NoteShapeTriangleUpWhite,rt.NoteShapeTriangleUpWhite,rt.NoteShapeTriangleUpBlack);break;case"fa":i===Ct.Up?this.qc(e,s,r,rt.NoteShapeTriangleRightWhite,rt.NoteShapeTriangleRightWhite,rt.NoteShapeTriangleRightWhite,rt.NoteShapeTriangleRightBlack):this.qc(e,s,r,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftBlack);break;case"fa up":this.qc(e,s,r,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftWhite,rt.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.qc(e,s,r,rt.NoteheadTriangleDownDoubleWhole,rt.NoteheadTriangleDownWhole,rt.NoteheadTriangleDownHalf,rt.NoteheadTriangleDownBlack);break;case"la":case"square":this.qc(e,s,r,rt.NoteShapeSquareWhite,rt.NoteShapeSquareWhite,rt.NoteShapeSquareWhite,rt.NoteShapeSquareBlack);break;case"left triangle":this.qc(e,s,r,rt.NoteheadTriangleRightWhite,rt.NoteheadTriangleRightWhite,rt.NoteheadTriangleRightWhite,rt.NoteheadTriangleRightBlack);break;case"mi":this.qc(e,s,r,rt.NoteShapeDiamondWhite,rt.NoteShapeDiamondWhite,rt.NoteShapeDiamondWhite,rt.NoteShapeDiamondBlack);break;case"none":e.style.noteHead=rt.NoteheadNull;break;case"normal":this.qc(e,s,r,rt.NoteheadDoubleWhole,rt.NoteheadWhole,rt.NoteheadHalf,rt.NoteheadBlack);break;case"re":this.qc(e,s,r,rt.NoteShapeMoonWhite,rt.NoteShapeMoonWhite,rt.NoteShapeMoonWhite,rt.NoteShapeMoonBlack);break;case"rectangle":this.qc(e,s,r,rt.NoteheadSquareWhite,rt.NoteheadSquareWhite,rt.NoteheadSquareWhite,rt.NoteheadSquareBlack);break;case"slash":this.qc(e,s,r,rt.NoteheadSlashWhiteWhole,rt.NoteheadSlashWhiteWhole,rt.NoteheadSlashWhiteHalf,rt.NoteheadSlashHorizontalEnds);break;case"slashed":this.qc(e,s,r,rt.NoteheadSlashedDoubleWhole1,rt.NoteheadSlashedWhole1,rt.NoteheadSlashedHalf1,rt.NoteheadSlashedBlack1);break;case"so":this.qc(e,s,r,rt.NoteShapeRoundWhite,rt.NoteShapeRoundWhite,rt.NoteShapeRoundWhite,rt.NoteShapeRoundBlack);break;case"ti":this.qc(e,s,r,rt.NoteShapeTriangleRoundWhite,rt.NoteShapeTriangleRoundWhite,rt.NoteShapeTriangleRoundWhite,rt.NoteShapeTriangleRoundBlack);break;case"triangle":this.qc(e,s,r,rt.NoteheadTriangleUpDoubleWhole,rt.NoteheadTriangleUpWhole,rt.NoteheadTriangleUpHalf,rt.NoteheadTriangleUpBlack);break;case"x":this.qc(e,s,r,rt.NoteheadXDoubleWhole,rt.NoteheadXWhole,rt.NoteheadXHalf,rt.NoteheadXBlack)}}Rc(t,e){let s=R.toTicks(e);for(;s>t;){if(e===c.TwoHundredFiftySixth)return null;e*=2,s=R.toTicks(e)}const i=new Yt;return i.dynamics=this.ko,i.isEmpty=!1,i.duration=e,i.overrideDisplayDuration=s,i.updateDurations(),i}Ic(t,e){if(e.beats.length>0){const s=e.beats[e.beats.length-1];s.nextBeat=t,t.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==l.None;)i=i.index>0?i.previousBeat:null;null!==i&&(t.displayStart=i.displayEnd)}e.addBeat(t)}Wc(t){return t*R.QuarterTime/this.yo}fc(t){switch(t.innerText){case"1024th":case"512th":case"256th":return c.TwoHundredFiftySixth;case"128th":return c.OneHundredTwentyEighth;case"64th":return c.SixtyFourth;case"32nd":return c.ThirtySecond;case"16th":return c.Sixteenth;case"eighth":return c.Eighth;case"quarter":return c.Quarter;case"half":return c.Half;case"whole":return c.Whole;case"breve":return c.DoubleWhole;case"long":return c.QuadrupleWhole}return null}static Yc=[c.TwoHundredFiftySixth,c.OneHundredTwentyEighth,c.SixtyFourth,c.ThirtySecond,c.Sixteenth,c.Eighth,c.Quarter,c.Half,c.Whole,c.DoubleWhole,c.QuadrupleWhole];static Kc=mi.Yc.map(t=>R.toTicks(t));Gc(t,e,s,i){if(!s)for(let t=0;t<mi.Yc.length;t++){if(!(e>=mi.Kc[t]))break;s=mi.Yc[t]}t.duration=s??c.Sixteenth,i&&(t.overrideDisplayDuration=e),t.updateDurations()}yr(t,e,s){const i=this.mo.get(s.index).getLyricLine(t.getAttribute("number",""));for(null===e.lyrics&&(e.lyrics=[]);e.lyrics.length<=i;)e.lyrics.push("");for(const s of t.childElements())switch(s.localName){case"text":e.lyrics[i]?e.lyrics[i]+=` ${s.innerText}`:e.lyrics[i]=s.innerText;break;case"elision":e.lyrics[i]+=s.innerText}}jc(t,e,s){for(const i of t.childElements())switch(i.localName){case"tied":e&&this.Qc(i,e,s.voice.bar.staff);break;case"slur":e&&this.Pr(i,e);break;case"glissando":e&&this.Zc(i,e);break;case"slide":e&&this.tl(i,e);break;case"ornaments":e&&this.el(i,e);break;case"technical":this.sl(i,e,s);break;case"articulations":e&&this.oh(i,e);break;case"dynamics":const t=this.Cc(i);null!==t&&(s.dynamics=t,this.ko=t);break;case"fermata":this.Ah(i,s);break;case"arpeggiate":this.il(i,s)}}Pc(t){if(!this.wo.has(t)){const e=new fi;return this.wo.set(t,e),e}return this.wo.get(t)}Zc(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Pc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=g.Shift}}}Pr(t,e){const s=t.getAttribute("number","1"),i=this.Pc(e.beat.voice.bar.staff);switch(t.getAttribute("type")){case"start":i.slurStarts.set(s,e);break;case"stop":if(i.slurStarts.has(s)){e.isSlurDestination=!0;const t=i.slurStarts.get(s);t.slurDestination=e,e.slurOrigin=t,i.slurStarts.delete(s)}}}il(t,e){switch(t.getAttribute("direction","down")){case"down":e.brushType=h.ArpeggioDown;break;case"up":e.brushType=h.ArpeggioUp}}Ah(t,e){let s;switch(t.innerText){case"normal":default:s=Nt.Medium;break;case"angled":s=Nt.Short;break;case"square":s=Nt.Long}e.fermata=new be,e.fermata.type=s}oh(t,e){for(const s of t.childElements())switch(s.localName){case"accent":e.accentuated=u.Normal;break;case"strong-accent":e.accentuated=u.Heavy;break;case"staccato":e.isStaccato=!0;break;case"tenuto":e.accentuated=u.Tenuto}}sl(t,e,s){const i=[];for(const n of t.childElements())switch(n.localName){case"up-bow":s.pickStroke=ht.Up;break;case"down-bow":s.pickStroke=ht.Down;break;case"harmonic":break;case"fingering":e&&(e.leftHandFinger=this.nl(n));break;case"pluck":e&&(e.rightHandFinger=this.nl(n));break;case"fret":e&&(e.fret=Number.parseInt(n.innerText,10));break;case"string":e&&(e.string=s.voice.bar.staff.tuning.length-Number.parseInt(n.innerText,10)+1);break;case"hammer-on":case"pull-off":e&&(e.isHammerPullOrigin=!0);break;case"bend":i.push(n);break;case"tap":s.tap=!0;break;case"smear":e&&(e.vibrato=w.Slight);break;case"golpe":switch(n.getAttribute("placement","above")){case"above":s.golpe=dt.Finger;break;case"below":s.golpe=dt.Thumb}}e&&i.length>0&&this.rl(i,e)}rl(t,e){const s=$.MaxPosition/t.length;let i=0,n=0,r=!0;for(const a of t){const t=a.findChildElement("bend-alter");if(t){const h=Math.round(2*Math.abs(Number.parseFloat(t.innerText)));a.findChildElement("pre-bend")?r?(i+=h,e.addBendPoint(new $(n,i)),n+=s,e.addBendPoint(new $(n,i)),r=!1):n+=s:a.findChildElement("release")?(r&&(i+=h),e.addBendPoint(new $(n,i)),n+=s,i-=h,e.addBendPoint(new $(n,i)),r=!1):(e.addBendPoint(new $(n,i)),i+=h,n+=s,e.addBendPoint(new $(n,i)),r=!1)}}}nl(t){switch(t.innerText){case"0":return d.NoOrDead;case"1":case"p":case"t":return d.Thumb;case"2":case"i":return d.IndexFinger;case"3":case"m":return d.MiddleFinger;case"4":case"a":return d.AnnularFinger;case"5":case"c":return d.LittleFinger}return d.Unknown}al=-1;el(t,e){let s=-1;for(const i of t.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),e.isStringed?e.trillValue=e.stringTuning+s:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+s);break;case"turn":e.ornament=ct.Turn;break;case"inverted-turn":e.ornament=ct.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this.al=s):this.al>0?"stop"===i.getAttribute("type")?this.al=-1:e.isStringed?e.trillValue=e.stringTuning+this.al:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+this.al):e.vibrato=w.Slight;break;case"mordent":e.ornament=ct.LowerMordent;break;case"inverted-mordent":e.ornament=ct.UpperMordent;break;case"tremolo":switch(i.innerText){case"1":e.beat.tremoloSpeed=c.Eighth;break;case"2":e.beat.tremoloSpeed=c.Sixteenth;break;case"3":e.beat.tremoloSpeed=c.ThirtySecond}}}tl(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Pc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=g.Shift}}}Qc(t,e,s){const i=t.getAttribute("type"),n=t.getAttribute("number",""),r=this.Pc(s);if("start"===i){if(n){if(r.tieStartIds.has(n)){const t=r.tieStartIds.get(n);r.tieStarts.delete(t)}r.tieStartIds.set(n,e)}r.tieStarts.add(e)}else if("stop"===i&&!e.isTieDestination){let t=null;if(n){if(!r.tieStartIds.has(n))return;t=r.tieStartIds.get(n),r.tieStartIds.delete(n),r.tieStarts.delete(e)}else{const s=this.hl(e);for(const e of r.tieStarts)if(this.hl(e)===s){t=e,r.tieStarts.delete(t);break}}if(!t)return;e.isTieDestination=!0,e.tieOrigin=t}}Uc(t){switch(t.innerText){case"down":return Ct.Down;case"up":return Ct.Up;default:return null}}Hc(t,e){switch(t.innerText){case"sharp":e.accidentalMode=p.ForceSharp;break;case"natural":e.accidentalMode=p.ForceNatural;break;case"flat":e.accidentalMode=p.ForceFlat;break;case"double-sharp":e.accidentalMode=p.ForceDoubleSharp;break;case"flat-flat":e.accidentalMode=p.ForceDoubleFlat}}hl(t){return 12*t.octave+t.tone}mi(t){return this.Wc(Number.parseFloat(t.innerText))}Vc(t,e){let s="",i=0;for(const e of t.childElements())switch(e.localName){case"display-step":s=e.innerText;break;case"display-octave":i=Number.parseInt(e.innerText,10)+1}const n=new Xt;if(""===s)n.octave=0,n.tone=0;else{const t=12*i+(Vt.getToneForText(s)?.noteValue??0);n.octave=t/12|0,n.tone=t-12*n.octave}return n}$c(t){let e="",s=0,i=0;for(const n of t.childElements())switch(n.localName){case"step":e=n.innerText;break;case"alter":s=Number.parseFloat(n.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(n.innerText,10)+1}s|=0;const n=12*i+(Vt.getToneForText(e)?.noteValue??0)+s,r=new Xt;return r.octave=n/12|0,r.tone=n-12*r.octave,r}qc(t,e,s,i,n,r,a){if(void 0===s)switch(e){case c.QuadrupleWhole:case c.DoubleWhole:t.style.noteHead=i;break;case c.Whole:t.style.noteHead=n;break;case c.Half:t.style.noteHead=r;break;default:t.style.noteHead=a}else if(!0===s)t.style.noteHead=a;else switch(e){case c.QuadrupleWhole:case c.DoubleWhole:t.style.noteHead=i;break;case c.Whole:t.style.noteHead=n;break;case c.Half:default:t.style.noteHead=r}}}class gi{si;ol=0;cl=0;count=0;constructor(t){this.si=new Float32Array(t)}clear(){this.cl=0,this.ol=0,this.count=0,this.si=new Float32Array(this.si.length)}write(t,e,s){let i=0;s>this.si.length-this.count&&(s=this.si.length-this.count);const n=Math.min(this.si.length-this.ol,s);return this.si.set(t.subarray(e,e+n),this.ol),this.ol+=n,this.ol%=this.si.length,i+=n,i<s&&(this.si.set(t.subarray(e+i,e+i+s-i),this.ol),this.ol+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const n=Math.min(this.si.length-this.cl,s);return t.set(this.si.subarray(this.cl,this.cl+n),e),i+=n,this.cl+=n,this.cl%=this.si.length,i<s&&(t.set(this.si.subarray(this.cl,this.cl+s-i),e+i),this.cl+=s-i,i=s),this.count-=i,i}}class wi{static CmdOutputPrefix="alphaSynth.output.";static CmdOutputAddSamples=`${wi.CmdOutputPrefix}addSamples`;static CmdOutputPlay=`${wi.CmdOutputPrefix}play`;static CmdOutputPause=`${wi.CmdOutputPrefix}pause`;static CmdOutputResetSamples=`${wi.CmdOutputPrefix}resetSamples`;static CmdOutputStop=`${wi.CmdOutputPrefix}stop`;static CmdOutputSampleRequest=`${wi.CmdOutputPrefix}sampleRequest`;static CmdOutputSamplesPlayed=`${wi.CmdOutputPrefix}samplesPlayed`;static preferredSampleRate=0;ll;get sampleRate(){return wi.preferredSampleRate}open(){z.debug("AlphaSynth","Initializing synth worker"),this.ll=tu.globalThis,this.ll.addEventListener("message",this.ul.bind(this)),this.ready.trigger()}destroy(){this.ll.postMessage({cmd:"alphaSynth.output.destroy"})}ul(t){const e=t.data;switch(e.cmd){case wi.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case wi.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples)}}ready=new xe;samplesPlayed=new Te;sampleRequest=new xe;addSamples(t){this.ll.postMessage({cmd:"alphaSynth.output.addSamples",samples:tu.prepareForPostMessage(t)})}play(){this.ll.postMessage({cmd:"alphaSynth.output.play"})}pause(){this.ll.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this.ll.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class yi{device;constructor(t){this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}isDefault=!1}class ki{static dl=[];static findKnownDevice(t){return ki.dl.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in tu.globalThis)return new AudioContext;if("webkitAudioContext"in tu.globalThis)return new webkitAudioContext;throw new W(s.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in ki.createAudioContext()||(z.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await ki.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(t){z.warning("WebAudio","Output device permission rejected",t)}const t=await navigator.mediaDevices.enumerateDevices();let e="",s="";const i=new Map;for(const n of t)"audiooutput"===n.kind&&(i.set(n.groupId,new yi(n)),"default"!==n.deviceId&&""!==n.deviceId||(e=n.groupId,s=n.deviceId));const n=Array.from(i.values());let r=n.find(t=>t.deviceId===s);return r||(r=n.find(t=>t.device.groupId===e)),!r&&n.length>0&&(r=n[0]),r&&(r.isDefault=!0),ki.dl=n,n}catch(t){return z.error("WebAudio","Failed to enumerate output devices",t),[]}}}class Si{static BufferSize=4096;static PreferredSampleRate=44100;context=null;buffer=null;source=null;fl;get sampleRate(){return this.context?this.context.sampleRate:Si.PreferredSampleRate}activate(t){this.context||(this.context=ki.createAudioContext()),"suspended"!==this.context.state&&"interrupted"!==this.context.state||(z.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{z.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),t&&t()},t=>{z.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${t}`)}))}pl(){const t=navigator.userAgent;if(-1!==t.indexOf("iPhone")||-1!==t.indexOf("iPad")){const t=ki.createAudioContext(),e=t.createBuffer(1,1,Si.PreferredSampleRate),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect(0),t.close()}}open(t){this.pl(),this.context=ki.createAudioContext();"suspended"===this.context.state&&this.bl()}bl(){this.fl=(()=>{this.activate(()=>{this.ml()})}).bind(this),document.body.addEventListener("touchend",this.fl,!1),document.body.addEventListener("click",this.fl,!1)}ml(){const t=this.fl;t&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))}play(){const t=this.context;this.activate(),this.buffer=t.createBuffer(2,Si.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this.ml()}ready=new xe;samplesPlayed=new Te;sampleRequest=new xe;onSamplesPlayed(t){this.samplesPlayed.trigger(t)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return ki.enumerateOutputDevices()}async setOutputDevice(t){await ki.checkSinkIdSupport()&&(t?await this.context.setSinkId(t.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await ki.checkSinkIdSupport())return null;const t=this.context.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=ki.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(z.warning("WebAudio","Could not find output device in device list",t,s),null)}}class Bi{static gl=!1;static init(){Bi.gl||(Bi.gl=!0,registerProcessor("alphatab",class t extends AudioWorkletProcessor{static BufferSize=4096;wl=new Float32Array(0);yl;kl=0;Sl=0;Bl=!1;constructor(e){super(e),z.debug("WebAudio","creating processor"),this.kl=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this.yl=new gi(t.BufferSize*this.kl),this.port.onmessage=this.ul.bind(this)}ul(t){const e=t.data;switch(e.cmd){case wi.CmdOutputAddSamples:const t=e.samples;this.yl.write(t,0,t.length),this.Sl--;break;case wi.CmdOutputResetSamples:this.yl.clear();break;case wi.CmdOutputStop:this.Bl=!0}}process(t,e,s){if(1!==e.length&&2!==e[0].length)return!1;const i=e[0][0],n=e[0][1];if(!i||!n)return!0;const r=i.length+n.length;let a=this.wl;a.length!==r&&(a=new Float32Array(r),this.wl=a);const h=this.yl.read(a,0,Math.min(a.length,this.yl.count));let o=0;const c=Math.min(i.length,h);for(let t=0;t<c;t++)i[t]=a[o++],n[t]=a[o++];if(h<i.length)for(let t=h;t<i.length;t++)i[t]=0,n[t]=0;return this.port.postMessage({cmd:wi.CmdOutputSamplesPlayed,samples:h/It.AudioChannels}),this._l(),this.yl.count>0||!this.Bl}_l(){const e=this.kl/2|0,s=e*t.BufferSize;if(this.yl.count+this.Sl*t.BufferSize<s){for(let t=0;t<e;t++)this.port.postMessage({cmd:wi.CmdOutputSampleRequest});this.Sl+=e}}}))}}class _i extends Si{xl=null;Tl=0;Ml;constructor(t){super(),this.Ml=t}open(t){super.open(t),this.Tl=t,this.onReady()}play(){super.play();const t=this.context;tu.createAudioWorklet(t,this.Ml).then(()=>{this.xl=new AudioWorkletNode(t,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this.Tl}}),this.xl.port.onmessage=this.ul.bind(this),this.source.connect(this.xl),this.source.start(0),this.xl.connect(t.destination)},t=>{z.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}ul(t){const e=t.data;switch(e.cmd){case wi.CmdOutputSamplesPlayed:this.onSamplesPlayed(e.samples);break;case wi.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this.xl&&(this.xl.port.postMessage({cmd:wi.CmdOutputStop}),this.xl.port.onmessage=null,this.xl.disconnect()),this.xl=null}addSamples(t){this.xl?.port.postMessage({cmd:wi.CmdOutputAddSamples,samples:tu.prepareForPostMessage(t)})}resetSamples(){this.xl?.port.postMessage({cmd:wi.CmdOutputResetSamples})}}!function(t){t[t.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",t[t.MultiTrack=1]="MultiTrack"}(ts||(ts={}));class xi{events=[];addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0;){if(!(this.events[e-1].tick>t.tick))break;e--}this.events.splice(e,0,t)}}writeTo(t){const e=Re.empty();let s=0;for(const t of this.events){const i=t.tick-s;Ti.writeVariableInt(e,i),t.writeTo(e),s=t.tick}const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const n=e.toArray();ae.writeInt32BE(t,n.length),t.write(n,0,n.length)}}class Ti{format=ts.SingleTrackMultiChannel;division=R.QuarterTime;get events(){if(1===this.tracks.length)return this.tracks[0].events;const t=[];for(const t of this.tracks)this.events.push(...t.events);return t.sort((t,e)=>t.tick-e.tick),t}tracks=[];vl(t){for(;this.tracks.length<t;)this.tracks.push(new xi)}addEvent(t){this.format===ts.SingleTrackMultiChannel?(this.vl(1),this.tracks[0].addEvent(t)):(this.vl(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=Re.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),ae.writeInt32BE(t,6),ae.writeInt16BE(t,this.format),ae.writeInt16BE(t,this.tracks.length),ae.writeInt16BE(t,this.division);for(const e of this.tracks)e.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do{s[i++]=127&e,e>>=7}while(e>0);for(;i>0;)i--,i>0?t.writeByte(128|s[i]):t.writeByte(s[i])}}!function(t){t[t.TimeSignature=88]="TimeSignature",t[t.NoteOn=128]="NoteOn",t[t.NoteOff=144]="NoteOff",t[t.ControlChange=176]="ControlChange",t[t.ProgramChange=192]="ProgramChange",t[t.TempoChange=81]="TempoChange",t[t.PitchBend=224]="PitchBend",t[t.PerNotePitchBend=96]="PerNotePitchBend",t[t.EndOfTrack=47]="EndOfTrack",t[t.AlphaTabRest=241]="AlphaTabRest",t[t.AlphaTabMetronome=242]="AlphaTabMetronome",t[t.SystemExclusive=240]="SystemExclusive",t[t.SystemExclusive2=247]="SystemExclusive2",t[t.Meta=255]="Meta"}(es||(es={}));class Mi{track;tick;type;constructor(t,e,s){this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class vi extends Mi{numerator;denominatorIndex;midiClocksPerMetronomeClick;thirtySecondNodesInQuarter;constructor(t,e,s,i,n,r){super(t,e,es.TimeSignature),this.track=t,this.tick=e,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=n,this.thirtySecondNodesInQuarter=r}writeTo(t){t.writeByte(255),t.writeByte(88),Ti.writeVariableInt(t,4),t.writeByte(255&this.numerator),t.writeByte(255&this.denominatorIndex),t.writeByte(255&this.midiClocksPerMetronomeClick),t.writeByte(255&this.thirtySecondNodesInQuarter)}}class Ni extends Mi{static AlphaTabManufacturerId=125;static MetronomeEventId=0;static RestEventId=1;writeTo(t){t.writeByte(240);const e=Re.withCapacity(16);e.writeByte(Ni.AlphaTabManufacturerId),this.writeEventData(e),e.writeByte(247),Ti.writeVariableInt(t,e.length),e.copyTo(t)}}class Pi extends Ni{metronomeNumerator;metronomeDurationInTicks;metronomeDurationInMilliseconds;isMetronome=!0;constructor(t,e,s,i,n){super(t,e,es.AlphaTabMetronome),this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=n,this.metronomeDurationInTicks=i}writeEventData(t){t.writeByte(Ni.MetronomeEventId),t.writeByte(this.metronomeNumerator),ae.writeInt32LE(t,this.metronomeDurationInTicks),ae.writeInt32LE(t,this.metronomeDurationInMilliseconds)}}class Ei extends Ni{channel;constructor(t,e,s){super(t,e,es.AlphaTabRest),this.channel=s}writeEventData(t){t.writeByte(Ni.RestEventId),t.writeByte(this.channel)}}class Fi extends Mi{channel;noteKey;noteVelocity;constructor(t,e,s,i,n,r){super(t,e,s),this.channel=i,this.noteKey=n,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Ci extends Fi{constructor(t,e,s,i,n){super(t,e,es.NoteOn,s,i,n)}writeTo(t){t.writeByte(15&this.channel|144),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Ai extends Fi{constructor(t,e,s,i,n){super(t,e,es.NoteOff,s,i,n)}writeTo(t){t.writeByte(15&this.channel|128),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Di extends Mi{channel;controller;value;constructor(t,e,s,i,n){super(t,e,es.ControlChange),this.channel=s,this.controller=i,this.value=n}writeTo(t){t.writeByte(15&this.channel|176),t.writeByte(255&this.controller),t.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class Li extends Mi{channel;program;constructor(t,e,s,i){super(t,e,es.ProgramChange),this.channel=s,this.program=i}writeTo(t){t.writeByte(15&this.channel|192),t.writeByte(255&this.program)}get data1(){return this.program}}class Wi extends Mi{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(t){this.beatsPerMinute=6e7/t}beatsPerMinute=0;constructor(t,e){super(0,t,es.TempoChange),this.microSecondsPerQuarterNote=e}writeTo(t){t.writeByte(255),t.writeByte(81),t.writeByte(3),t.writeByte(this.microSecondsPerQuarterNote>>16&255),t.writeByte(this.microSecondsPerQuarterNote>>8&255),t.writeByte(255&this.microSecondsPerQuarterNote)}}class Oi extends Mi{channel;value;constructor(t,e,s,i){super(t,e,es.PitchBend),this.channel=s,this.value=i}writeTo(t){t.writeByte(15&this.channel|224),t.writeByte(127&this.value),t.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class Ri extends Mi{channel;noteKey;value;constructor(t,e,s,i,n){super(t,e,es.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=n}writeTo(t){throw new W(s.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Ii extends Mi{constructor(t,e){super(t,e,es.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class Gi{eventIndex;event;isMetronome;time=0;constructor(t,e){this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===es.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,n){const r=new Pi(0,e,s,i,n);return new Gi(t,r)}}class $i{masterBarIndex=0;masterBarOccurence=0;synthBpm=0;synthTime=0;synthTick=0;syncTime=0;syncBpm=0;updateSyncBpm(t,e){const s=(t-this.synthTime)/(e-this.syncTime)*this.synthBpm;this.syncBpm=s}}class Vi{bpm;ticks;time;constructor(t,e,s){this.bpm=t,this.ticks=e,this.time=s}}class Hi{tempoChanges=[];tempoChangeIndex=0;syncPoints=[];firstProgramEventPerChannel=new Map;firstTimeSignatureNumerator=0;firstTimeSignatureDenominator=0;synthData=[];division=R.QuarterTime;eventIndex=0;currentTime=0;syncPointIndex=0;playbackRange=null;playbackRangeStartTime=0;playbackRangeEndTime=0;endTick=0;endTime=0;currentTempo=0;syncPointTempo=0}class Ui{Nl;Pl;El;Fl=null;Cl=null;get isPlayingMain(){return this.Pl===this.El}get isPlayingOneTimeMidi(){return this.Pl===this.Fl}get isPlayingCountIn(){return this.Pl===this.Cl}constructor(t){this.Nl=t,this.El=new Hi,this.Pl=this.El}get mainPlaybackRange(){return this.El.playbackRange}set mainPlaybackRange(t){this.El.playbackRange=t,t&&(this.El.playbackRangeStartTime=this.Al(this.El,t.startTick,1),this.El.playbackRangeEndTime=this.Al(this.El,t.endTick,1))}isLooping=!1;get currentTime(){return this.Pl.currentTime/this.playbackSpeed}get currentEndTick(){return this.Pl.endTick}get currentEndTime(){return this.Pl.endTime/this.playbackSpeed}get currentTempo(){return this.Pl.currentTempo}get modifiedTempo(){return this.Pl.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this.Pl.syncPointTempo}get currentSyncPoints(){return this.Pl.syncPoints}playbackSpeed=1;mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this.El.playbackRangeStartTime?t=this.El.playbackRangeStartTime:t>this.El.playbackRangeEndTime&&(t=this.El.playbackRangeEndTime)),t>this.El.currentTime)this.Dl(t-this.El.currentTime);else if(t<this.El.currentTime){if(this.El.currentTime=0,this.El.eventIndex=0,this.El.syncPointIndex=0,this.El.tempoChangeIndex=0,this.El.currentTempo=this.El.tempoChanges[0].bpm,this.El.syncPointTempo=this.El.syncPoints.length>0?this.El.syncPoints[0].syncBpm:this.El.currentTempo,this.isPlayingMain){const t=this.Nl.metronomeVolume;this.Nl.noteOffAll(!0),this.Nl.resetSoft(),this.Nl.setupMetronomeChannel(t)}this.Dl(t)}}Dl(t){if(t<=0)return;const e=Date.now(),s=this.El.currentTime+t;if(this.isPlayingMain)for(;this.El.currentTime<s;)this.Ll(s-this.El.currentTime)&&this.Nl.synthesizeSilent(It.MicroBufferSize);this.El.currentTime=s;const i=Date.now()-e;z.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this.Fl=this.createStateFromFile(t),this.Pl=this.Fl}instrumentPrograms=new Set;percussionKeys=new Set;loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this.El=this.createStateFromFile(t),this.Pl=this.El}createStateFromFile(t){const e=new Hi;this.percussionKeys.add(It.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,n=0,r=0,a=0,h=0,o=0,c=0,l=0;for(const u of t.events){const d=new Gi(e.synthData.length,u);e.synthData.push(d);const f=u.tick-l;if(i+=f,n+=f*(6e4/(s*t.division)),d.time=n,l=u.tick,a>0)for(;o<i;){const t=Gi.newMetronomeEvent(e.synthData.length,o,Math.floor(o/a)%r,a,h);e.synthData.push(t),t.time=c,o+=a,c+=h}if(u.type===es.TempoChange){s=u.beatsPerMinute,e.tempoChanges.push(new Vi(s,i,n)),h=a*(6e4/(s*t.division))}else if(u.type===es.TimeSignature){const i=u,n=Math.pow(2,i.denominatorIndex);r=i.numerator,a=e.division*(4/n)|0,h=a*(6e4/(s*t.division)),0===e.firstTimeSignatureDenominator&&(e.firstTimeSignatureNumerator=i.numerator,e.firstTimeSignatureDenominator=n)}else if(u.type===es.ProgramChange){const t=u,s=t.channel;e.firstProgramEventPerChannel.has(s)||e.firstProgramEventPerChannel.set(s,d);s===It.PercussionChannel||this.instrumentPrograms.add(t.program)}else if(u.type===es.NoteOn){const t=u;t.channel===It.PercussionChannel&&this.percussionKeys.add(t.noteKey)}}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),e.endTime=n,e.endTick=i,e}fillMidiEventQueue(){return this.Ll(-1)}fillMidiEventQueueToEndTime(t){for(;this.El.currentTime<t;)this.Ll(t-this.El.currentTime)&&this.Nl.synthesizeSilent(It.MicroBufferSize);let e=!1;for(this.Pl.currentTime=t;this.Pl.eventIndex<this.Pl.synthData.length&&this.Pl.synthData[this.Pl.eventIndex].time<this.Pl.currentTime;){const t=this.Pl.synthData[this.Pl.eventIndex];this.Nl.dispatchEvent(t),this.Pl.eventIndex++,e=!0}return e}Ll(t){let e=It.MicroBufferSize/this.Nl.outSampleRate*1e3*this.playbackSpeed,s=this.Wl;t>0&&(t<e&&(e=t),s=Math.min(this.Wl,this.Pl.currentTime+t));let i=!1;for(this.Pl.currentTime+=e;this.Pl.eventIndex<this.Pl.synthData.length&&this.Pl.synthData[this.Pl.eventIndex].time<this.Pl.currentTime&&this.Pl.currentTime<s;)this.Nl.dispatchEvent(this.Pl.synthData[this.Pl.eventIndex]),this.Pl.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this.Al(this.El,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this.El;if(t.sort((t,e)=>t.synthTick-e.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,n=0,r=0;for(let a=0;a<t.length;a++){const h=t[a];let o,c,l,u=0;if(0===a)o=s,c=0,l=0;else{const e=t[a-1];o=e.syncBpm,c=e.syncTime,l=e.synthTick}for(;r<e.tempoChanges.length&&e.tempoChanges[r].ticks<=h.synthTick;){if(u=e.tempoChanges[r].ticks-i,u>0){i+=u,n+=u*(6e4/(s*e.division));const t=(i-l)*((h.syncTime-c)/(h.synthTick-l))+c,r=new $i;r.synthTick=i,r.synthBpm=s,r.synthTime=n,r.syncTime=t,r.syncBpm=o}s=e.tempoChanges[r].bpm,r++}u=h.synthTick-i,i+=u,n+=u*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this.Pl;if(0===e.tempoChanges.length)return 0;t*=this.playbackSpeed,this.Ol(e,t);const s=e.tempoChanges[e.tempoChangeIndex],i=(t-s.time)/(6e4/(s.bpm*e.division))|0;return s.ticks+i+1}currentUpdateCurrentTempo(t){this.Ol(this.El,t*this.playbackSpeed)}Ol(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,0===t.syncPoints.length&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this.Rl(this.El,t)}Rl(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this.El,i=s.syncPoints;if(t<0||0===i.length)return t;this.Rl(this.El,t);const n=Math.min(s.syncPointIndex,i.length-1),r=i[n],a=t-r.syncTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.syncTime-r.syncTime);h=(t.synthTime-r.synthTime)*e}else{const t=a/(e-r.syncTime);h=(s.endTime-r.synthTime)*t}return(r.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this.El,i=s.syncPoints;if(t<0||0===i.length)return t;t*=this.playbackSpeed;let n=Math.min(s.syncPointIndex,i.length-1);for(t<i[n].synthTime&&(n=0);n+1<i.length&&i[n+1].synthTime<=t;)n++;const r=i[n],a=t-r.synthTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.synthTime-r.synthTime),s=t.syncTime-r.syncTime;h=r.syncTime+s*e}else{const t=a/(s.endTime-r.synthTime),i=e-r.syncTime;h=r.syncTime+i*t}return h}Al(t,e,s){let i=0,n=120,r=0;for(const s of t.tempoChanges){if(e<s.ticks)break;i=s.time,n=s.bpm,r=s.ticks}return i+=(e-=r)*(6e4/(n*t.division)),i/s}get Wl(){return this.isPlayingMain&&this.mainPlaybackRange?this.Pl.playbackRangeEndTime:this.Pl.endTime}get isFinished(){return this.Pl.currentTime>=this.Wl}stop(){this.isPlayingMain&&this.mainPlaybackRange?this.Pl.currentTime=this.mainPlaybackRange.startTick:this.Pl.currentTime=0,this.Pl.eventIndex=0}resetOneTimeMidi(){this.Fl=null,this.Pl=this.El}resetCountIn(){this.Cl=null,this.Pl=this.El}startCountIn(){this.generateCountInMidi(),this.Pl=this.Cl,this.stop(),this.Nl.noteOffAll(!0)}generateCountInMidi(){const t=new Hi;t.division=this.El.division;let e=120,s=4,i=4;0===this.El.eventIndex?(e=this.El.tempoChanges[0].bpm,s=this.El.firstTimeSignatureNumerator,i=this.El.firstTimeSignatureDenominator):(e=this.Nl.currentTempo,s=this.Nl.timeSignatureNumerator,i=this.Nl.timeSignatureDenominator),t.tempoChanges.push(new Vi(e,0,0));const n=t.division*(4/i)|0,r=n*(6e4/(e*this.El.division));let a=0,h=0;for(let e=0;e<s;e++){const s=Gi.newMetronomeEvent(t.synthData.length,a,e,n,r);t.synthData.push(s),s.time=h,a+=n,h+=r}t.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),t.endTime=h,t.endTick=a,t.currentTempo=e,t.syncPointTempo=e,this.Cl=t}}!function(t){t[t.Paused=0]="Paused",t[t.Playing=1]="Playing"}(ss||(ss={}));class zi{state;stopped;constructor(t,e){this.state=t,this.stopped=e}}class ji{currentTime;endTime;currentTick;endTick;isSeek;originalTempo=0;modifiedTempo=0;constructor(t,e,s,i,n,r,a){this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=n,this.originalTempo=r,this.modifiedTempo=a}}class Xi{static HeaderSize=8;id="";size=0;static load(t,e,s){if(t&&Xi.HeaderSize>t.size)return!1;if(s.position+Xi.HeaderSize>=s.length)return!1;if(e.id=ae.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)return!1;if(e.size=ae.readUInt32LE(s),t&&Xi.HeaderSize+e.size>t.size)return!1;t&&(t.size-=Xi.HeaderSize+e.size);const i="RIFF"===e.id,n="LIST"===e.id;return(!i||!t)&&(!i&&!n||(e.id=ae.read8BitStringLength(s,4),!(e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)&&(e.size-=4,!0)))}}class Ji{packetData;isBeginningOfStream;isEndOfStream;granulePosition;constructor(t,e,s,i){this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}!function(t){t[t.ContinuesPacket=1]="ContinuesPacket",t[t.BeginningOfStream=2]="BeginningOfStream",t[t.EndOfStream=4]="EndOfStream"}(is||(is={}));class qi{an;constructor(t){this.an=t}read(){const t=[];for(;this.Il(t););return t}Il(t){return!!this.Gl()&&this.$l(t)}Gl(){for(let t=0;t<65536;t++){if(1399285583===ae.readInt32LE(this.an))return!0;this.an.position-=3}return!1}$l(t){const e=this.an.readByte();if(-1===e||0!==e)return!1;const i=this.an.readByte(),n=ae.readInt64LE(this.an);this.an.skip(4),this.an.skip(4),this.an.skip(4);const r=this.an.readByte();if(-1===r)return!1;const a=[];let h=0;for(let t=0;t<r;t++){const t=this.an.readByte();h===a.length&&a.push(0),a[h]+=t,t<255&&h++}for(let e=0;e<a.length;e++){const r=new Uint8Array(a[e]);if(this.an.read(r,0,r.length)!==r.length)return!1;if(0!==(i&is.ContinuesPacket)){if(0===t.length)throw new W(s.Format,"OGG: Continuation page without any previous packets");t[t.length-1].addData(r)}else{const s=new Ji(r,0!==(i&is.BeginningOfStream)&&0===e,0!==(i&is.EndOfStream)&&e===a.length-1,n);t.push(s)}}return!0}}class Yi{audioChannels=0;audioSampleRate=0;samples=new Float32Array(0);bitrateMaximum=0;bitrateNominal=0;bitrateMinimum=0;blocksize0=0;blocksize1=0}class Ki{value=0;bitsRead=0}class Qi{static jh=8;qh;Vl=0n;Hl=0n;Ul=0n;constructor(t){this.qh=t}readByte(){return this.readBits(Qi.jh)}readBit(){return 1===this.readBits(1)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){if(0===t)return 0;const e=this.tryPeekBits(t);return this.skipBits(t),e.value}tryPeekBits(t){if(t<0||t>32)throw new W(s.General,"IO: Cannot read more than 32 bits in one go");if(0===t)return new Ki;const e=new Ki;for(;this.Hl<t;){const t=BigInt(this.qh.readByte());if(-1n===t)return e.bitsRead=Number(this.Hl),e.value=Number(this.Vl),this.Vl=0n,this.Hl=0n,e;this.Vl=(0xffn&t)<<this.Hl|this.Vl,this.Hl+=8n,this.Hl>32&&(this.Ul=t>>40n-this.Hl&0xffn)}let i=this.Vl;return t<64&&(i&=(1n<<BigInt(t))-1n),e.value=Number(i),e.bitsRead=t,e}skipBits(t){let e=BigInt(t);if(0===t);else if(this.Hl>e){if(this.Vl=t>31?0n:this.Vl>>e,this.Hl>32){const s=this.Hl-32n;this.Vl=this.Vl|this.Ul<<this.Hl-e-s,s>t&&(this.Ul=this.Ul>>e&0xffn)}this.Hl-=e}else if(this.Hl===e)this.Vl=0n,this.Hl=0n;else{for(e-=this.Hl,this.Hl=0n,this.Vl=0n;e>8;){if(-1===this.qh.readByte()){e=0n;break}e-=8n}if(e>0){const t=BigInt(this.qh.readByte());-1n===t||(this.Vl=t>>e,this.Hl=8n-e)}}}}class Zi{codebooks=[];timeDomainTransforms=[];floors=[];residues=[];mappings=[];modes=[]}class tn{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e);return Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),n=(e&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(n)-788)}}class en{zl;constructor(t){this.zl=t}get(t){return this.zl[t]}}class sn{static instance=new sn;get(t){return t}}class nn{ji;jl=0;Xl=null;Jl=null;ql=0;Yl;dimensions=0;entries=0;mapType=0;constructor(t,e){if(5653314!==t.readBits(24))throw new W(s.Format,"Vorbis: Book header had invalid signature!");this.dimensions=t.readBits(16),this.entries=t.readBits(24),this.ji=new Int32Array(this.entries),this.Kl(t,e),this.Ql(t)}get(t,e){return this.Yl[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this.ql);if(0===e.bitsRead)return-1;let s=this.Jl[e.value];if(null!=s)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this.jl),null!==this.Xl)for(let i=0;i<this.Xl.length;i++){s=this.Xl[i];const n=e.value&s.mask;if(s.bits===n)return t.skipBits(s.length),s.value}return-1}Kl(t,e){let i,n,r=0;if(t.readBit()){let e=t.readBits(5)+1;for(let s=0;s<this.entries;){let i=t.readBits(tn.ilog(this.entries-s));for(;--i>=0;)this.ji[s++]=e;++e}r=0,i=!1,n=e}else{n=-1,i=t.readBit();for(let e=0;e<this.entries;e++)!i||t.readBit()?(this.ji[e]=t.readBits(5)+1,++r):this.ji[e]=-1,this.ji[e]>n&&(n=this.ji[e])}if(this.jl=n,n>-1){let t,n=null;i&&r>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this.ji.subarray(0,this.entries),0),i=!1),t=i?r:0;let a=null,h=null;if(i?0!==t&&(n=new Int32Array(t),h=new Int32Array(t),a=new Int32Array(t)):h=new Int32Array(this.entries),!this.Zl(i,h,n,this.ji,this.entries,a))throw new W(s.Format,"Vorbis: Failed to compute codewords");const o=null==a?sn.instance:new en(a);e.generateTable(o,n??this.ji,h),this.Jl=e.prefixTree,this.ql=e.tableBits,this.Xl=e.overflowList}}Zl(t,e,s,i,n,r){const a=new Uint32Array(32);let h=0,o=0;for(h=0;h<n&&!(i[h]>0);++h);if(h===n)return!0;this.tu(t,e,s,0,h,o++,i[h],r);for(let t=1;t<=i[h];++t)a[t]=1<<32-t;for(let c=h+1;c<n;++c){let n=i[c];if(n<=0)continue;for(;n>0&&0===a[n];)--n;if(0===n)return!1;const h=a[n];if(a[n]=0,this.tu(t,e,s,tn.bitReverse(h),c,o++,i[c],r),n!==i[c])for(let t=i[c];t>n;--t)a[t]=h+(1<<32-t)}return!0}tu(t,e,s,i,n,r,a,h){t?(e[r]=i,s[r]=a,h[r]=n):e[n]=i}Ql(t){if(this.mapType=t.readBits(4),0===this.mapType)return;const e=tn.convertFromVorbisFloat32(t.readBits(32)),s=tn.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,n=t.readBit();let r=this.entries*this.dimensions;const a=new Float32Array(r);1===this.mapType&&(r=this.eu());const h=new Uint32Array(r);for(let e=0;e<r;e++)h[e]=t.readBits(i);if(1===this.mapType)for(let t=0;t<this.entries;t++){let i=0,o=1;for(let c=0;c<this.dimensions;c++){const l=h[t/o%r|0]*s+e+i;a[t*this.dimensions+c]=l,n&&(i=l),o*=r}}else for(let t=0;t<this.entries;t++){let i=0,r=t*this.dimensions;for(let o=0;o<this.dimensions;o++){const c=h[r]*s+e+i;a[t*this.dimensions+o]=c,n&&(i=c),++r}}this.Yl=a}eu(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class rn{value=0;length=0;bits=0;mask=0}class an{static maxTableBits=10;tableBits=0;prefixTree=[];overflowList=null;generateTable(t,e,s){const i=new Array(e.length);let n=0;for(let r=0;r<i.length;r++){const a=new rn;a.value=t.get(r),a.length=e[r]<=0?99999:e[r],a.bits=s[r],a.mask=(1<<e[r])-1,i[r]=a,e[r]>0&&n<e[r]&&(n=e[r])}i.sort((t,e)=>{const s=t.length-e.length;return 0===s?t.bits-e.bits:s});const r=n>an.maxTableBits?an.maxTableBits:n,a=[];let h=null;for(let t=0;t<i.length&&i[t].length<99999;t++){const e=i[t].length;if(e>r)for(h=[];t<i.length&&i[t].length<99999;t++)h.push(i[t]);else{const s=1<<r-e,n=i[t];for(let t=0;t<s;t++){const s=t<<e|n.bits;for(;a.length<=s;)a.push(null);a[s]=n}}}for(;a.length<1<<r;)a.push(null);this.tableBits=r,this.prefixTree=a,this.overflowList=h}}class hn{constructor(t){t.readBits(16)}}class on{coeff;amp=0;get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1;constructor(t){this.coeff=t}}class cn{su;iu;nu;ru;au;hu;ou;cu;lu;uu;constructor(t,e,i,n){if(this.su=t.readBits(8),this.iu=t.readBits(16),this.nu=t.readBits(16),this.ru=t.readBits(6),this.au=t.readBits(8),this.ou=new Array(t.readBits(4)+1),this.su<1||this.iu<1||this.nu<1||0===this.ou.length)throw new W(s.Format,"Vorbis: Invalid Floor0 Data");this.hu=(1<<this.ru)-1;for(let e=0;e<this.ou.length;e++){const i=t.readBits(8);if(i<0||i>=n.length)throw new W(s.Format,"Vorbis: Invalid Floor0 Data");const r=n[i];if(0===r.mapType||r.dimensions<1)throw new W(s.Format,"Vorbis: Invalid Floor0 Data");this.ou[e]=r}this.cu=tn.ilog(this.ou.length),this.uu=new Map([[e,this.du(e/2)],[i,this.du(i/2)]]),this.lu=new Map([[e,this.fu(e/2)],[i,this.fu(i/2)]])}du(t){const e=this.nu/cn.pu(this.iu/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this.nu-1,Math.floor(cn.pu(this.iu/2/t*i)*e));return s[t]=-1,s}static pu(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(1.85e-8*t*t)+1e-4*t}fu(t){const e=Math.PI/this.nu,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new on(new Float32Array(this.su+1));if(i.amp=t.readBits(this.ru),i.amp>0){i.amp=i.amp/this.hu*this.au;const e=t.readBits(this.cu);if(e>=this.ou.length)return i.amp=0,i;const s=this.ou[e];for(let e=0;e<this.su;){const n=s.decodeScalar(t);if(-1===n)return i.amp=0,i;for(let t=0;e<this.su&&t<s.dimensions;t++,e++)i.coeff[e]=s.get(n,t)}let n=0;for(let t=0;t<this.su;){for(let e=0;t<this.su&&e<s.dimensions;t++,e++)i.coeff[t]+=n;n=i.coeff[t-1]}}return i}apply(t,e,s){const i=t,n=e/2;if(i.amp>0){const t=this.uu.get(e),r=this.lu.get(e);let a=0;for(a=0;a<this.su;a++)i.coeff[a]=2*Math.cos(i.coeff[a]);for(a=0;a<n;){let e=0;const n=t[a];let h=.5,o=.5;const c=r[n];for(e=1;e<this.su;e+=2)o*=c-i.coeff[e-1],h*=c-i.coeff[e];for(e===this.su?(o*=c-i.coeff[e-1],h*=h*(4-c*c),o*=o):(h*=h*(2-c),o*=o*(2+c)),o=i.amp/Math.sqrt(h+o)-this.au,o=Math.exp(.11512925*o),s[a]*=o;t[++a]===n;)s[a]*=o}}else s.fill(0,0,n)}}class ln{posts=new Int32Array(64);postCount=0;get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1}class un{static bu=[256,128,86,64];static mu=[8,7,7,6];gu;wu;yu;ku;Su;Bu;_u;xu;Tu;Mu;vu;Nu;Pu;Eu;constructor(t,e){let i=-1;this.gu=new Int32Array(t.readBits(5));for(let e=0;e<this.gu.length;e++)this.gu[e]=t.readBits(4),this.gu[e]>i&&(i=this.gu[e]);++i,this.wu=new Int32Array(i),this.yu=new Int32Array(i),this.Nu=new Array(i),this.Su=new Int32Array(i),this.Pu=new Array(i),this.Eu=new Array(i);for(let s=0;s<i;s++){this.wu[s]=t.readBits(3)+1,this.yu[s]=t.readBits(2),this.yu[s]>0&&(this.Su[s]=t.readBits(8),this.Nu[s]=e[this.Su[s]]),this.Pu[s]=new Array(1<<this.yu[s]),this.Eu[s]=new Int32Array(this.Pu[s].length);for(let i=0;i<this.Pu[s].length;i++){const n=t.readBits(8)-1;n>=0&&(this.Pu[s][i]=e[n]),this.Eu[s][i]=n}}this.Tu=t.readBits(2),this.Mu=un.bu[this.Tu],this.vu=un.mu[this.Tu],++this.Tu;const n=t.readBits(4),r=[];r.push(0),r.push(1<<n);for(let e=0;e<this.gu.length;e++){const s=this.gu[e];for(let e=0;e<this.wu[s];e++)r.push(t.readBits(n))}this.ku=new Int32Array(r),this._u=new Int32Array(r.length),this.Bu=new Int32Array(r.length),this.xu=new Int32Array(r.length),this.xu[0]=0,this.xu[1]=1;for(let t=2;t<this._u.length;t++){this._u[t]=0,this.Bu[t]=1,this.xu[t]=t;for(let e=2;e<t;e++){const s=this.ku[e];s<this.ku[t]?s>this.ku[this._u[t]]&&(this._u[t]=e):s<this.ku[this.Bu[t]]&&(this.Bu[t]=e)}}for(let t=0;t<this.xu.length-1;t++)for(let e=t+1;e<this.xu.length;e++){if(this.ku[t]===this.ku[e])throw new W(s.Format,"Vorbis: Invalid Floor1 Data");if(this.ku[this.xu[t]]>this.ku[this.xu[e]]){const s=this.xu[t];this.xu[t]=this.xu[e],this.xu[e]=s}}}unpack(t,e,s){const i=new ln;if(t.readBit()){let e=2;i.posts[0]=t.readBits(this.vu),i.posts[1]=t.readBits(this.vu);for(let s=0;s<this.gu.length;s++){const n=this.gu[s],r=this.wu[n],a=this.yu[n],h=(1<<a)-1;let o=0;if(a>0&&(o=this.Nu[n].decodeScalar(t),-1===o)){e=0;break}for(let c=0;c<r;c++){const r=this.Pu[n][o&h];if(o>>=a,null!=r&&(i.posts[e]=r.decodeScalar(t),-1===i.posts[e])){e=0,s=this.gu.length;break}++e}}i.postCount=e}return i}apply(t,e,s){const i=t,n=e/2;if(i.postCount>0){const t=this.Fu(i);let e=0,r=i.posts[0]*this.Tu;for(let a=1;a<i.postCount;a++){const h=this.xu[a];if(t[h]){const t=this.ku[h],a=i.posts[h]*this.Tu;e<n&&this.Cu(e,r,Math.min(t,n),a,s),e=t,r=a}if(e>=n)break}e<n&&this.Cu(e,r,n,r,s)}else s.fill(0,0,n)}Fu(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const n=this._u[i],r=this.Bu[i],a=this.Au(this.ku[n],s[n],this.ku[r],s[r],this.ku[i]),h=t.posts[i],o=this.Mu-a,c=a;let l;l=o<c?2*o:2*c,0!==h?(e[n]=!0,e[r]=!0,e[i]=!0,s[i]=h>=l?o>c?h-c+a:a-h+o-1:h%2==1?a-(h+1)/2:a+h/2):(e[i]=!1,s[i]=a)}for(let e=0;e<t.postCount;e++)t.posts[e]=s[e];return e}Au(t,e,s,i,n){const r=i-e,a=s-t,h=Math.abs(r)*(n-t)/a|0;return r<0?e-h:e+h}Cu(t,e,s,i,n){const r=i-e,a=s-t;let h=Math.abs(r);const o=1-2*(r>>31&1),c=r/a|0;let l=t,u=e,d=-a;for(n[t]*=un.Du[e],h-=Math.abs(c)*a;++l<s;)u+=c,d+=h,d>=0&&(d-=a,u+=o),n[l]*=un.Du[u]}static Du=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1])}class dn{floor;constructor(t,e,i,n){const r=t.readBits(16);switch(r){case 0:this.floor=new cn(t,e,i,n);break;case 1:this.floor=new un(t,n);break;default:throw new W(s.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class fn{Lu;Wu;Ou;Ru;Iu;Gu;ou;$u;Vu;Hu;constructor(t,e,i){this.Wu=t.readBits(24),this.Ou=t.readBits(24),this.Ru=t.readBits(24)+1,this.Iu=t.readBits(6)+1,this.$u=i[t.readBits(8)],this.Vu=new Int32Array(this.Iu);let n=0;for(let e=0;e<this.Iu;e++){const s=t.readBits(3);t.readBit()?this.Vu[e]=t.readBits(5)<<3|s:this.Vu[e]=s,n+=fn.Uu(this.Vu[e])}const r=new Int32Array(n);for(let e=0;e<n;e++)if(r[e]=t.readBits(8),0===i[r[e]].mapType)throw new W(s.Format,"Vorbis: Invalid Residue 0");const a=this.$u.entries;let h=this.$u.dimensions,o=1;for(;h>0;){if(o*=this.Iu,o>a)throw new W(s.Format,"Vorbis: Invalid Residue 0");--h}this.ou=new Array(this.Iu),n=0;let c,l=0;for(let t=0;t<this.Iu;t++)if(c=tn.ilog(this.Vu[t]),this.ou[t]=new Array(c),c>0){l=Math.max(l,c);for(let e=0;e<c;e++)(this.Vu[t]&1<<e)>0&&(this.ou[t][e]=i[r[n++]])}this.Gu=l,this.Hu=new Array(o);for(let t=0;t<o;t++){let e=t,s=o/this.Iu|0;this.Hu[t]=new Int32Array(this.$u.dimensions);for(let i=0;i<this.$u.dimensions;i++){const n=e/s|0;e-=n*s,s=s/this.Iu|0,this.Hu[t][i]=n}}this.Lu=e}static Uu(t){let e=0;for(;0!==t;)e+=1&t,t>>=1;return e}decode(t,e,s,i){const n=(this.Ou<s/2?this.Ou:s/2)-this.Wu;if(n>0&&-1!==e.indexOf(!1)){const e=n/this.Ru,s=(e+this.$u.dimensions-1)/this.$u.dimensions|0,r=[];for(let t=0;t<this.Lu;t++)r.push(new Array(s));for(let s=0;s<this.Gu;s++)for(let n=0,a=0;n<e;a++){if(0===s)for(let i=0;i<this.Lu;i++){const h=this.$u.decodeScalar(t);if(!(h>=0&&h<this.Hu.length)){n=e,s=this.Gu;break}r[i][a]=this.Hu[h]}for(let h=0;n<e&&h<this.$u.dimensions;h++,n++){const o=this.Wu+n*this.Ru;for(let c=0;c<this.Lu;c++){const l=r[c][a][h];if(this.Vu[l]&1<<s){const r=this.ou[l][s];if(r&&this.writeVectors(r,t,i,c,o,this.Ru)){n=e,s=this.Gu;break}}}}}}}writeVectors(t,e,s,i,n,r){const a=s[i],h=r/t.dimensions,o=new Int32Array(h);for(let s=0;s<h;s++)if(o[s]=t.decodeScalar(e),-1===o[s])return!0;for(let e=0;e<t.dimensions;e++)for(let s=0;s<h;s++,n++)a[n]+=t.get(o[s],e);return!1}}class pn extends fn{writeVectors(t,e,s,i,n,r){const a=s[i];for(let s=0;s<r;){const i=t.decodeScalar(e);if(-1===i)return!0;for(let e=0;e<t.dimensions;s++,e++)a[n+s]+=t.get(i,e)}return!1}}class bn extends fn{zu;constructor(t,e,s){super(t,1,s),this.zu=e}decode(t,e,s,i){super.decode(t,e,s*this.zu,i)}writeVectors(t,e,s,i,n,r){let a=0;n/=this.zu;for(let i=0;i<r;){const r=t.decodeScalar(e);if(-1===r)return!0;for(let e=0;e<t.dimensions;e++,i++)s[a][n]+=t.get(r,e),++a===this.zu&&(a=0,n++)}return!1}}class mn{residue;constructor(t,e,i){const n=t.readBits(16);switch(n){case 0:this.residue=new fn(t,e,i);break;case 1:this.residue=new pn(t,e,i);break;case 2:this.residue=new bn(t,e,i);break;default:throw new W(s.Format,`Vorbis: Invalid Residue type: ${n}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class gn{ju;Xu;Ju;qu;Yu;Ku;Qu;constructor(t,e,i,n,r){if(0!==t.readBits(16))throw new W(s.Format,"Vorbis: Invalid mapping type!");let a=1;t.readBit()&&(a+=t.readBits(4));let h=0;t.readBit()&&(h=t.readBits(8)+1);const o=tn.ilog(e-1);this.Xu=new Int32Array(h),this.Ju=new Int32Array(h);for(let i=0;i<h;i++){const n=t.readBits(o),r=t.readBits(o);if(n===r||n>e-1||r>e-1)throw new W(s.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this.Xu[i]=r,this.Ju[i]=n}if(0!==t.readBits(2))throw new W(s.Format,"Vorbis: Reserved bits not 0 in mapping header.");const c=new Int32Array(e);if(a>1)for(let i=0;i<e;i++)if(c[i]=t.readBits(4),c[i]>a)throw new W(s.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this.qu=new Array(a),this.Yu=new Array(a);for(let e=0;e<a;e++){t.skipBits(8);const r=t.readBits(8);if(r>=i.length)throw new W(s.Format,"Vorbis: Invalid floor number in mapping header!");const a=t.readBits(8);if(a>=n.length)throw new W(s.Format,"Vorbis: Invalid residue number in mapping header!");this.qu[e]=i[r],this.Yu[e]=n[a]}this.Ku=new Array(e),this.Qu=new Array(e);for(let t=0;t<e;t++)this.Ku[t]=this.qu[c[t]],this.Qu[t]=this.Yu[c[t]];this.ju=r}decodePacket(t,e,s){const i=e>>1,n=new Array(this.Ku.length),r=new Array(this.Ku.length);r.fill(!1);for(let a=0;a<this.Ku.length;a++)n[a]=this.Ku[a].unpack(t,e,a),r[a]=!n[a].executeChannel,s[a].fill(0,0,i);for(let t=0;t<this.Xu.length;t++)(n[this.Xu[t]].executeChannel||n[this.Ju[t]].executeChannel)&&(n[this.Xu[t]].forceEnergy=!0,n[this.Ju[t]].forceEnergy=!0);for(let i=0;i<this.qu.length;i++){for(let t=0;t<this.Ku.length;t++)this.qu[i]===this.Ku[t]&&this.Yu[i]===this.Qu[t]||(n[t].forceNoEnergy=!0);this.Yu[i].decode(t,r,e,s)}for(let t=this.Xu.length-1;t>=0;t--)if(n[this.Xu[t]].executeChannel||n[this.Ju[t]].executeChannel){const e=s[this.Ju[t]],n=s[this.Xu[t]];for(let t=0;t<i;t++){let s,i;const r=e[t],a=n[t];r>0?a>0?(s=r,i=r-a):(i=r,s=r+a):a>0?(s=r,i=r+a):(i=r,s=r-a),e[t]=s,n[t]=i}}for(let t=0;t<this.Ku.length;t++)n[t].executeChannel?(this.Ku[t].apply(n[t],e,s[t]),this.ju.reverse(s[t],e)):s[t].fill(0,i,2*i)}}class wn{packetStartIndex=0;packetTotalLength=0;packetValidLength=0}class yn{overlapInfo=new wn;windowIndex=0}class kn{samplePosition=null;constructor(t=null){this.samplePosition=t}}class Sn{static Zu=1.57079632695;Lu;td;ed;sd;nd;rd=null;constructor(t,e,i,n,r){if(this.Lu=e,this.td=t.readBit(),0!==t.readBits(32))throw new W(s.Format,"Vorbis: Mode header had invalid window or transform type!");const a=t.readBits(8);if(a>=r.length)throw new W(s.Format,"Vorbis: Mode header had invalid mapping index!");this.sd=r[a],this.td?(this.ed=n,this.nd=[Sn.ad(i,n,i),Sn.ad(n,n,i),Sn.ad(i,n,n),Sn.ad(n,n,n)],this.rd=[Sn.hd(i,n,i),Sn.hd(n,n,i),Sn.hd(i,n,n),Sn.hd(n,n,n)]):(this.ed=i,this.nd=[Sn.ad(i,i,i)])}decode(t,e){const s=this.od(t);this.sd.decodePacket(t,this.ed,e);const i=this.nd[s.windowIndex];for(let t=0;t<this.ed;t++)for(let s=0;s<this.Lu;s++)e[s][t]*=i[t];return s.overlapInfo}od(t){const e=new yn;if(this.td){const s=t.readBit(),i=t.readBit();e.windowIndex=(s?1:0)+(i?2:0);const n=this.rd[e.windowIndex];e.overlapInfo.packetStartIndex=n.packetStartIndex,e.overlapInfo.packetValidLength=n.packetValidLength,e.overlapInfo.packetTotalLength=n.packetTotalLength}else e.windowIndex=0,e.overlapInfo.packetStartIndex=0,e.overlapInfo.packetValidLength=this.ed/2,e.overlapInfo.packetTotalLength=this.ed;return e}static ad(t,e,s){const i=new Float32Array(e),n=t/2,r=s/2,a=e/4-n/2,h=e-e/4-r/2;for(let t=0;t<n;t++){let e=Math.sin((t+.5)/n*Sn.Zu);e*=e,i[a+t]=Math.sin(e*Sn.Zu)}for(let t=a+n;t<h;t++)i[t]=1;for(let t=0;t<r;t++){let e=Math.sin((r-t-.5)/r*Sn.Zu);e*=e,i[h+t]=Math.sin(e*Sn.Zu)}return i}static hd(t,e,s){const i=s/4,n=e/4-t/4,r=e/4*3+i,a=r-2*i,h=new wn;return h.packetStartIndex=n,h.packetValidLength=a,h.packetTotalLength=r,h}}class Bn{static ld=3.141592653589793;ud;dd;fd;pd;bd;md;gd;wd;yd;constructor(t){this.ud=t,this.dd=t>>1,this.fd=this.dd>>1,this.pd=this.fd>>1,this.bd=tn.ilog(t)-1,this.md=new Float32Array(this.dd),this.gd=new Float32Array(this.dd),this.wd=new Float32Array(this.fd);let e=0,s=0;for(;e<this.fd;++e,s+=2)this.md[s]=Math.cos(4*e*Bn.ld/t),this.md[s+1]=-Math.sin(4*e*Bn.ld/t),this.gd[s]=.5*Math.cos((s+1)*Bn.ld/t/2),this.gd[s+1]=.5*Math.sin((s+1)*Bn.ld/t/2);for(e=0,s=0;e<this.pd;++e,s+=2)this.wd[s]=Math.cos(2*(s+1)*Bn.ld/t),this.wd[s+1]=-Math.sin(2*(s+1)*Bn.ld/t);this.yd=new Uint16Array(this.pd);for(let t=0;t<this.pd;++t)this.yd[t]=re.int32ToUint16(tn.bitReverse(t,this.bd-3)<<2)}calcReverse(t){let e,s;const i=new Float32Array(this.dd);{let e=this.dd-2,s=0,n=0;const r=this.dd;for(;n!==r;)i[e+1]=t[n]*this.md[s]-t[n+2]*this.md[s+1],i[e]=t[n]*this.md[s+1]+t[n+2]*this.md[s],e-=2,s+=2,n+=4;for(n=this.dd-3;e>=0;)i[e+1]=-t[n+2]*this.md[s]- -t[n]*this.md[s+1],i[e]=-t[n+2]*this.md[s+1]+-t[n]*this.md[s],e-=2,s+=2,n-=4}e=t,s=i;{let t=this.dd-8,i=this.fd,n=0,r=this.fd,a=0;for(;t>=0;){let h,o;o=s[i+1]-s[n+1],h=s[i]-s[n],e[r+1]=s[i+1]+s[n+1],e[r]=s[i]+s[n],e[a+1]=o*this.md[t+4]-h*this.md[t+5],e[a]=h*this.md[t+4]+o*this.md[t+5],o=s[i+3]-s[n+3],h=s[i+2]-s[n+2],e[r+3]=s[i+3]+s[n+3],e[r+2]=s[i+2]+s[n+2],e[a+3]=o*this.md[t]-h*this.md[t+1],e[a+2]=h*this.md[t]+o*this.md[t+1],t-=8,r+=4,a+=4,i+=4,n+=4}}this.kd(this.ud>>4,e,this.dd-1-0*this.fd,-this.pd),this.kd(this.ud>>4,e,this.dd-1-1*this.fd,-this.pd),this.Sd(this.ud>>5,e,this.dd-1-0*this.pd,-(this.ud>>4),16),this.Sd(this.ud>>5,e,this.dd-1-1*this.pd,-(this.ud>>4),16),this.Sd(this.ud>>5,e,this.dd-1-2*this.pd,-(this.ud>>4),16),this.Sd(this.ud>>5,e,this.dd-1-3*this.pd,-(this.ud>>4),16);let n=2;for(;n<this.bd-3>>1;++n){const t=this.ud>>n+2,s=t>>1,i=1<<n+1;for(let r=0;r<i;++r)this.Sd(this.ud>>n+4,e,this.dd-1-t*r,-s,1<<n+3)}for(;n<this.bd-6;++n){const t=this.ud>>n+2,s=1<<n+3,i=t>>1,r=this.ud>>n+6,a=1<<n+1;let h=this.dd-1,o=0;for(let n=r;n>0;--n)this.Bd(a,e,h,-i,o,s,t),o+=4*s,h-=8}this._d(this.ud>>5,e,this.dd-1,this.ud);{let t=0,i=this.fd-4,n=this.dd-4;for(;i>=0;){let r;r=this.yd[t],s[n+3]=e[r],s[n+2]=e[r+1],s[i+3]=e[r+2],s[i+2]=e[r+3],r=this.yd[t+1],s[n+1]=e[r],s[n]=e[r+1],s[i+1]=e[r+2],s[i]=e[r+3],i-=4,n-=4,t+=2}}{let t=0,e=0,i=this.dd-4;for(;e<i;){let n,r,a,h,o,c;n=s[e]-s[i+2],r=s[e+1]+s[i+3],a=this.wd[t+1]*n+this.wd[t]*r,h=this.wd[t+1]*r-this.wd[t]*n,o=s[e]+s[i+2],c=s[e+1]-s[i+3],s[e]=o+a,s[e+1]=c+h,s[i+2]=o-a,s[i+3]=h-c,n=s[e+2]-s[i],r=s[e+3]+s[i+1],a=this.wd[t+3]*n+this.wd[t+2]*r,h=this.wd[t+3]*r-this.wd[t+2]*n,o=s[e+2]+s[i],c=s[e+3]-s[i+1],s[e+2]=o+a,s[e+3]=c+h,s[i]=o-a,s[i+1]=h-c,t+=4,e+=4,i-=4}}{let e=this.dd-8,s=this.dd-8,n=0,r=this.dd-4,a=this.dd,h=this.ud-4;for(;s>=0;){let o,c,l,u;u=i[s+6]*this.gd[e+7]-i[s+7]*this.gd[e+6],l=-i[s+6]*this.gd[e+6]-i[s+7]*this.gd[e+7],t[n]=u,t[r+3]=-u,t[a]=l,t[h+3]=l,c=i[s+4]*this.gd[e+5]-i[s+5]*this.gd[e+4],o=-i[s+4]*this.gd[e+4]-i[s+5]*this.gd[e+5],t[n+1]=c,t[r+2]=-c,t[a+1]=o,t[h+2]=o,u=i[s+2]*this.gd[e+3]-i[s+3]*this.gd[e+2],l=-i[s+2]*this.gd[e+2]-i[s+3]*this.gd[e+3],t[n+2]=u,t[r+1]=-u,t[a+2]=l,t[h+1]=l,c=i[s]*this.gd[e+1]-i[s+1]*this.gd[e],o=-i[s]*this.gd[e]-i[s+1]*this.gd[e+1],t[n+3]=c,t[r]=-c,t[a+3]=o,t[h]=o,e-=8,s-=8,n+=4,a+=4,r-=4,h-=4}}}Sd(t,e,s,i,n){let r,a,h=s,o=h+i,c=0;for(let s=t>>2;s>0;--s)r=e[h]-e[o],a=e[h-1]-e[o-1],e[h]+=e[o],e[h-1]+=e[o-1],e[o]=r*this.md[c]-a*this.md[c+1],e[o-1]=a*this.md[c]+r*this.md[c+1],c+=n,r=e[h-2]-e[o-2],a=e[h-3]-e[o-3],e[h-2]+=e[o-2],e[h-3]+=e[o-3],e[o-2]=r*this.md[c]-a*this.md[c+1],e[o-3]=a*this.md[c]+r*this.md[c+1],c+=n,r=e[h-4]-e[o-4],a=e[h-5]-e[o-5],e[h-4]+=e[o-4],e[h-5]+=e[o-5],e[o-4]=r*this.md[c]-a*this.md[c+1],e[o-5]=a*this.md[c]+r*this.md[c+1],c+=n,r=e[h-6]-e[o-6],a=e[h-7]-e[o-7],e[h-6]+=e[o-6],e[h-7]+=e[o-7],e[o-6]=r*this.md[c]-a*this.md[c+1],e[o-7]=a*this.md[c]+r*this.md[c+1],c+=n,h-=8,o-=8}kd(t,e,s,i){let n=s,r=n+i,a=0;for(let s=t>>2;s>0;--s){let t,s;t=e[n]-e[r],s=e[n-1]-e[r-1],e[n]+=e[r],e[n-1]+=e[r-1],e[r]=t*this.md[a]-s*this.md[a+1],e[r-1]=s*this.md[a]+t*this.md[a+1],a+=8,t=e[n-2]-e[r-2],s=e[n-3]-e[r-3],e[n-2]+=e[r-2],e[n-3]+=e[r-3],e[r-2]=t*this.md[a]-s*this.md[a+1],e[r-3]=s*this.md[a]+t*this.md[a+1],a+=8,t=e[n-4]-e[r-4],s=e[n-5]-e[r-5],e[n-4]+=e[r-4],e[n-5]+=e[r-5],e[r-4]=t*this.md[a]-s*this.md[a+1],e[r-5]=s*this.md[a]+t*this.md[a+1],a+=8,t=e[n-6]-e[r-6],s=e[n-7]-e[r-7],e[n-6]+=e[r-6],e[n-7]+=e[r-7],e[r-6]=t*this.md[a]-s*this.md[a+1],e[r-7]=s*this.md[a]+t*this.md[a+1],a+=8,n-=8,r-=8}}Bd(t,e,s,i,n,r,a){const h=this.md[n],o=this.md[n+1],c=this.md[n+r],l=this.md[n+r+1],u=this.md[n+2*r],d=this.md[n+2*r+1],f=this.md[n+3*r],p=this.md[n+3*r+1];let b,m,g=s,w=g+i;for(let s=t;s>0;--s)b=e[g]-e[w],m=e[g-1]-e[w-1],e[g]+=e[w],e[g-1]+=e[w-1],e[w]=b*h-m*o,e[w-1]=m*h+b*o,b=e[g-2]-e[w-2],m=e[g-3]-e[w-3],e[g-2]+=e[w-2],e[g-3]+=e[w-3],e[w-2]=b*c-m*l,e[w-3]=m*c+b*l,b=e[g-4]-e[w-4],m=e[g-5]-e[w-5],e[g-4]+=e[w-4],e[g-5]+=e[w-5],e[w-4]=b*u-m*d,e[w-5]=m*u+b*d,b=e[g-6]-e[w-6],m=e[g-7]-e[w-7],e[g-6]+=e[w-6],e[g-7]+=e[w-7],e[w-6]=b*f-m*p,e[w-7]=m*f+b*p,g-=a,w-=a}_d(t,e,s,i){const n=i>>3,r=this.md[n];let a=s;const h=a-16*t;for(;a>h;){let t,s;t=e[a]-e[a-8],s=e[a-1]-e[a-9],e[a]+=e[a-8],e[a-1]+=e[a-9],e[a-8]=t,e[a-9]=s,t=e[a-2]-e[a-10],s=e[a-3]-e[a-11],e[a-2]+=e[a-10],e[a-3]+=e[a-11],e[a-10]=(t+s)*r,e[a-11]=(s-t)*r,t=e[a-12]-e[a-4],s=e[a-5]-e[a-13],e[a-4]+=e[a-12],e[a-5]+=e[a-13],e[a-12]=s,e[a-13]=t,t=e[a-14]-e[a-6],s=e[a-7]-e[a-15],e[a-6]+=e[a-14],e[a-7]+=e[a-15],e[a-14]=(t+s)*r,e[a-15]=(t-s)*r,this.xd(e,a),this.xd(e,a-8),a-=16}}xd(t,e){const s=t[e]-t[e-4],i=t[e]+t[e-4],n=t[e-2]+t[e-6],r=t[e-2]-t[e-6];t[e]=i+n,t[e-2]=i-n;const a=t[e-3]-t[e-7];t[e-4]=s+a,t[e-6]=s-a;const h=t[e-1]-t[e-5],o=t[e-1]+t[e-5],c=t[e-3]+t[e-7];t[e-1]=o+c,t[e-3]=o-c,t[e-5]=h-r,t[e-7]=h+r}}class _n{Td=new Map;reverse(t,e){let s;this.Td.has(e)?s=this.Td.get(e):(s=new Bn(e),this.Td.set(e,s)),s.calcReverse(t)}}class xn{Md;vd;Nd;Pd=0;Ed;Fd;Cd;Ad;Dd;Ld;Wd;Od;Rd;constructor(t,e,s){this.Md=t,this.vd=e,this.Nd=s,this.Ld=0,this.Fd=null,this.Cd=0,this.Ad=0,this.Dd=0,this.Ed=null,this.Od=!1,this.Wd=!1,this.Rd=tn.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this.Nd[this.Nd.length-1].granulePosition*this.Md.audioChannels);const e=new Float32Array(.2*this.Md.audioSampleRate*this.Md.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),0!==s;){if(i+s>=t.length){const s=new Float32Array(t.length+e.length);s.set(t,0),t=s}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(0===s)return 0;let i=e;const n=e+s;for(;i<n;){if(this.Cd===this.Ad){if(this.Od){this.Ed=null,this.Fd=null;break}const t=this.Id((i-e)/this.Md.audioChannels);null===t&&(this.Ad=this.Dd),null===t||null===t.samplePosition||this.Wd||(this.Wd=!0,this.Ld=t.samplePosition-(this.Ad-this.Cd)-(i-e)/this.Md.audioChannels)}const s=Math.min((n-i)/this.Md.audioChannels,this.Ad-this.Cd);s>0&&(i+=this.Gd(t,i,s))}return s=i-e,this.Ld+=s/this.Md.audioChannels,s}Gd(t,e,s){let i=e;for(;s>0;this.Cd++,s--)for(let e=0;e<this.Md.audioChannels;e++)t[i++]=this.Fd[e][this.Cd];return i-e}Id(t){const e=this.$d();if(this.Od=this.Od||e.isEndOfStream,null==e.curPacket)return null;if(null!==e.samplePosition&&e.isEndOfStream){const s=this.Ld+t+e.validLen-e.startIndex,i=e.samplePosition-s;i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this.Ad>0?(xn.Vd(this.Fd,e.curPacket,this.Cd,this.Dd,e.startIndex,this.Md.audioChannels),this.Cd=e.startIndex):null==this.Fd&&(this.Cd=e.validLen),this.Ed=this.Fd,this.Ad=e.validLen,this.Dd=e.totalLen,this.Fd=e.curPacket,new kn(e.samplePosition)}static Vd(t,e,s,i,n,r){for(;s<i;s++,n++)for(let i=0;i<r;i++)e[i][n]+=t[i][s]}$d(){const t=new Tn;let e=null;if(this.Pd>=this.Nd.length)t.isEndOfStream=!0;else{e=this.Nd[this.Pd++];const s=new Qi(Re.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this.vd.modes[s.readBits(this.Rd)];if(null==this.Ed){this.Ed=new Array(this.Md.audioChannels);for(let t=0;t<this.Md.audioChannels;t++)this.Ed[t]=new Float32Array(this.Md.blocksize1)}const n=i.decode(s,this.Ed);return t.startIndex=n.packetStartIndex,t.validLen=n.packetValidLength,t.totalLen=n.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this.Ed,t}}return t}}class Tn{curPacket=null;startIndex=0;validLen=0;totalLen=0;isEndOfStream=!1;samplePosition=null}!function(t){t[t.IdentificationHeader=1]="IdentificationHeader",t[t.Comment=3]="Comment",t[t.SetupHeader=5]="SetupHeader"}(ns||(ns={}));class Mn{static vorbisHeaderMarker=new Uint8Array(["v".charCodeAt(0),"o".charCodeAt(0),"r".charCodeAt(0),"b".charCodeAt(0),"i".charCodeAt(0),"s".charCodeAt(0)]);Nd;Pd;constructor(t){this.Pd=-1,this.Nd=t}read(){let t;for(;;){if(t=this.Hd(),null==t)return null;if(t.isBeginningOfStream){const e=this.Ud(t);if(null!=e)return e}}}Hd(){return this.Pd++,this.Pd<this.Nd.length?this.Nd[this.Pd]:null}Ud(t){const e=new Yi;if(!this.zd(e,t))return null;if(!this.jd(this.Hd()))return null;const s=new Zi;if(!this.Xd(e,s,this.Hd()))return null;const i=[];let n;for(;n=this.Hd(),null!=n&&(i.push(n),!n.isEndOfStream););const r=new xn(e,s,i);return e.samples=r.decode(),e}Jd(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let t=0;t<Mn.vorbisHeaderMarker.length;t++)if(s[1+t]!==Mn.vorbisHeaderMarker[t])return!1;return!0}qd(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let t=0;t<Mn.vorbisHeaderMarker.length;t++)if(s[1+t]!==Mn.vorbisHeaderMarker[t])return!1;return!0}zd(t,e){const s=Re.fromBuffer(e.packetData);if(!this.Jd(ns.IdentificationHeader,s))return!1;if(0!==ae.readUInt32LE(s))return!1;if(t.audioChannels=s.readByte(),t.audioSampleRate=ae.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0)return!1;t.bitrateMaximum=ae.readInt32LE(s),t.bitrateNominal=ae.readInt32LE(s),t.bitrateMinimum=ae.readInt32LE(s);const i=s.readByte();if(t.blocksize0=1<<(15&i),t.blocksize1=1<<(i>>4),t.blocksize0>t.blocksize1||!Mn.Yd(t.blocksize0)||!Mn.Yd(t.blocksize0))return!1;return 0!==s.readByte()}static Yd(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}jd(t){if(null==t)return!1;const e=Re.fromBuffer(t.packetData);if(!this.Jd(ns.Comment,e))return!1;const s=ae.readUInt32LE(e);e.skip(s);const i=ae.readUInt32LE(e);for(let t=0;t<i;t++){const t=ae.readUInt32LE(e);e.skip(t)}return 0!==e.readByte()}Xd(t,e,s){if(null==s)return!1;const i=new Qi(Re.fromBuffer(s.packetData)),n=new _n,r=new an;if(!this.qd(ns.SetupHeader,i))return!1;let a=i.readByte()+1;for(let t=0;t<a;t++)e.codebooks.push(new nn(i,r));a=i.readBits(6)+1;for(let t=0;t<a;t++)e.timeDomainTransforms.push(new hn(i));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.floors.push(new dn(i,t.blocksize0,t.blocksize1,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.residues.push(new mn(i,t.audioChannels,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.mappings.push(new gn(i,t.audioChannels,e.floors,e.residues,n));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.modes.push(new Sn(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}}class vn{streams=[];constructor(t){const e=new qi(t).read(),s=new Mn(e);for(;;){const t=s.read();if(null==t)break;this.streams.push(t)}}}class Nn{phdrs=[];pbags=[];pmods=[];pgens=[];insts=[];ibags=[];imods=[];igens=[];sHdrs=[];sampleData=new Uint8Array(0);Kd=new Map;decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this.Kd.has(i)){let n;const r=this.sampleData.slice(t,e);if(s){n=new vn(Re.fromBuffer(r)).streams[0].samples}else{const t=new DataView(r.buffer,r.byteOffset,r.length);n=new Float32Array(r.length/2);for(let e=0;e<n.length;e++)n[e]=t.getInt16(2*e,!0)/32767}return this.Kd.set(i,n),n}return this.Kd.get(i)}load(t){const e=new Xi,s=new Xi;if(!Xi.load(null,e,t)||"sfbk"!==e.id)throw new fe("Soundfont is not a valid Soundfont2 file");for(;Xi.load(e,s,t);){const e=new Xi;if("pdta"===s.id)for(;Xi.load(s,e,t);)switch(e.id){case"phdr":for(let s=0,i=e.size/Ln.SizeInFile|0;s<i;s++)this.phdrs.push(new Ln(t));break;case"pbag":for(let s=0,i=e.size/An.SizeInFile|0;s<i;s++)this.pbags.push(new An(t));break;case"pmod":for(let s=0,i=e.size/Wn.SizeInFile|0;s<i;s++)this.pmods.push(new Wn(t));break;case"pgen":for(let s=0,i=e.size/Dn.SizeInFile|0;s<i;s++)this.pgens.push(new Dn(t));break;case"inst":for(let s=0,i=e.size/Cn.SizeInFile|0;s<i;s++)this.insts.push(new Cn(t));break;case"ibag":for(let s=0,i=e.size/Pn.SizeInFile|0;s<i;s++)this.ibags.push(new Pn(t));break;case"imod":for(let s=0,i=e.size/En.SizeInFile|0;s<i;s++)this.imods.push(new En(t));break;case"igen":for(let s=0,i=e.size/Fn.SizeInFile|0;s<i;s++)this.igens.push(new Fn(t));break;case"shdr":for(let s=0,i=e.size/On.SizeInFile|0;s<i;s++)this.sHdrs.push(new On(t));break;default:t.position+=e.size}else if("sdta"===s.id)for(;Xi.load(s,e,t);)if("smpl"===e.id)this.sampleData=new Uint8Array(e.size),t.read(this.sampleData,0,e.size);else t.position+=e.size;else t.position+=s.size}}}class Pn{static SizeInFile=4;instGenNdx;instModNdx;constructor(t){this.instGenNdx=ae.readUInt16LE(t),this.instModNdx=ae.readUInt16LE(t)}}class En{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=ae.readUInt16LE(t),this.modDestOper=ae.readUInt16LE(t),this.modAmount=ae.readInt16LE(t),this.modAmtSrcOper=ae.readUInt16LE(t),this.modTransOper=ae.readUInt16LE(t)}}class Fn{static SizeInFile=4;genOper;genAmount;constructor(t){this.genOper=ae.readUInt16LE(t),this.genAmount=new Rn(t)}}class Cn{static SizeInFile=22;instName;instBagNdx;constructor(t){this.instName=ae.read8BitStringLength(t,20),this.instBagNdx=ae.readUInt16LE(t)}}class An{static SizeInFile=4;genNdx;modNdx;constructor(t){this.genNdx=ae.readUInt16LE(t),this.modNdx=ae.readUInt16LE(t)}}class Dn{static SizeInFile=4;static GenInstrument=41;static GenKeyRange=43;static GenVelRange=44;static GenSampleId=53;genOper;genAmount;constructor(t){this.genOper=ae.readUInt16LE(t),this.genAmount=new Rn(t)}}class Ln{static SizeInFile=38;presetName;preset;bank;presetBagNdx;library;genre;morphology;constructor(t){this.presetName=ae.read8BitStringLength(t,20),this.preset=ae.readUInt16LE(t),this.bank=ae.readUInt16LE(t),this.presetBagNdx=ae.readUInt16LE(t),this.library=ae.readUInt32LE(t),this.genre=ae.readUInt32LE(t),this.morphology=ae.readUInt32LE(t)}}class Wn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=ae.readUInt16LE(t),this.modDestOper=ae.readUInt16LE(t),this.modAmount=ae.readUInt16LE(t),this.modAmtSrcOper=ae.readUInt16LE(t),this.modTransOper=ae.readUInt16LE(t)}}class On{static SizeInFile=46;sampleName;start;end;startLoop;endLoop;sampleRate;originalPitch;pitchCorrection;sampleLink;sampleType;constructor(t){this.sampleName=ae.read8BitStringLength(t,20),this.start=ae.readUInt32LE(t),this.end=ae.readUInt32LE(t),this.startLoop=ae.readUInt32LE(t),this.endLoop=ae.readUInt32LE(t),this.sampleRate=ae.readUInt32LE(t),this.originalPitch=t.readByte(),this.pitchCorrection=ae.readSInt8(t),this.sampleLink=ae.readUInt16LE(t),this.sampleType=ae.readUInt16LE(t)}}class Rn{wordAmount;get shortAmount(){return re.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(t){this.wordAmount=ae.readUInt16LE(t)}}class In{presetIndex=0;bank=0;pitchWheel=0;perNotePitchWheel=new Map;midiPan=0;midiVolume=0;midiExpression=0;midiRpn=0;midiData=0;panOffset=0;gainDb=0;pitchRange=0;tuning=0;mixVolume=0;mute=!1;solo=!1}class Gn{activeChannel=0;channelList=[];setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}!function(t){t[t.None=0]="None",t[t.Continuous=1]="Continuous",t[t.Sustain=2]="Sustain"}(rs||(rs={})),function(t){t[t.StereoInterleaved=0]="StereoInterleaved",t[t.StereoUnweaved=1]="StereoUnweaved",t[t.Mono=2]="Mono"}(as||(as={}));class $n{name="";presetNumber=0;bank=0;regions=null}class Vn{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,.05*t):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class Hn{delay=0;attack=0;hold=0;decay=0;sustain=0;release=0;keynumToHold=0;keynumToDecay=0;constructor(t){t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:Vn.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Vn.timecents2Secs(this.attack),this.release=this.release<-11950?0:Vn.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Vn.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Vn.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=t?Vn.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(t){t[t.StartAddrsOffset=0]="StartAddrsOffset",t[t.EndAddrsOffset=1]="EndAddrsOffset",t[t.StartloopAddrsOffset=2]="StartloopAddrsOffset",t[t.EndloopAddrsOffset=3]="EndloopAddrsOffset",t[t.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",t[t.ModLfoToPitch=5]="ModLfoToPitch",t[t.VibLfoToPitch=6]="VibLfoToPitch",t[t.ModEnvToPitch=7]="ModEnvToPitch",t[t.InitialFilterFc=8]="InitialFilterFc",t[t.InitialFilterQ=9]="InitialFilterQ",t[t.ModLfoToFilterFc=10]="ModLfoToFilterFc",t[t.ModEnvToFilterFc=11]="ModEnvToFilterFc",t[t.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",t[t.ModLfoToVolume=13]="ModLfoToVolume",t[t.Unused1=14]="Unused1",t[t.ChorusEffectsSend=15]="ChorusEffectsSend",t[t.ReverbEffectsSend=16]="ReverbEffectsSend",t[t.Pan=17]="Pan",t[t.Unused2=18]="Unused2",t[t.Unused3=19]="Unused3",t[t.Unused4=20]="Unused4",t[t.DelayModLFO=21]="DelayModLFO",t[t.FreqModLFO=22]="FreqModLFO",t[t.DelayVibLFO=23]="DelayVibLFO",t[t.FreqVibLFO=24]="FreqVibLFO",t[t.DelayModEnv=25]="DelayModEnv",t[t.AttackModEnv=26]="AttackModEnv",t[t.HoldModEnv=27]="HoldModEnv",t[t.DecayModEnv=28]="DecayModEnv",t[t.SustainModEnv=29]="SustainModEnv",t[t.ReleaseModEnv=30]="ReleaseModEnv",t[t.KeynumToModEnvHold=31]="KeynumToModEnvHold",t[t.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",t[t.DelayVolEnv=33]="DelayVolEnv",t[t.AttackVolEnv=34]="AttackVolEnv",t[t.HoldVolEnv=35]="HoldVolEnv",t[t.DecayVolEnv=36]="DecayVolEnv",t[t.SustainVolEnv=37]="SustainVolEnv",t[t.ReleaseVolEnv=38]="ReleaseVolEnv",t[t.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",t[t.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",t[t.Instrument=41]="Instrument",t[t.Reserved1=42]="Reserved1",t[t.KeyRange=43]="KeyRange",t[t.VelRange=44]="VelRange",t[t.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",t[t.Keynum=46]="Keynum",t[t.Velocity=47]="Velocity",t[t.InitialAttenuation=48]="InitialAttenuation",t[t.Reserved2=49]="Reserved2",t[t.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",t[t.CoarseTune=51]="CoarseTune",t[t.FineTune=52]="FineTune",t[t.SampleID=53]="SampleID",t[t.SampleModes=54]="SampleModes",t[t.Reserved3=55]="Reserved3",t[t.ScaleTuning=56]="ScaleTuning",t[t.ExclusiveClass=57]="ExclusiveClass",t[t.OverridingRootKey=58]="OverridingRootKey",t[t.Unused5=59]="Unused5",t[t.EndOper=60]="EndOper"}(hs||(hs={}));class Un{static Qd=new Float32Array(0);loopMode=rs.None;samples=Un.Qd;sampleRate=0;loKey=0;hiKey=0;loVel=0;hiVel=0;group=0;offset=0;end=0;loopStart=0;loopEnd=0;transpose=0;tune=0;pitchKeyCenter=0;pitchKeyTrack=0;attenuation=0;pan=0;ampEnv=new Hn;modEnv=new Hn;initialFilterQ=0;initialFilterFc=0;modEnvToPitch=0;modEnvToFilterFc=0;modLfoToFilterFc=0;modLfoToVolume=0;delayModLFO=0;freqModLFO=0;modLfoToPitch=0;delayVibLFO=0;freqVibLFO=0;vibLfoToPitch=0;constructor(t){t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new Hn(t.ampEnv),this.modEnv=new Hn(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=rs.None,this.samples=Un.Qd,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,t||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case hs.StartAddrsOffset:this.offset+=re.int16ToUint32(e.shortAmount);break;case hs.EndAddrsOffset:this.end+=re.int16ToUint32(e.shortAmount);break;case hs.StartloopAddrsOffset:this.loopStart+=re.int16ToUint32(e.shortAmount);break;case hs.EndloopAddrsOffset:this.loopEnd+=re.int16ToUint32(e.shortAmount);break;case hs.StartAddrsCoarseOffset:this.offset+=32768*re.int16ToUint32(e.shortAmount);break;case hs.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case hs.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case hs.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case hs.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case hs.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case hs.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case hs.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case hs.EndAddrsCoarseOffset:this.end+=32768*re.int16ToUint32(e.shortAmount);break;case hs.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case hs.Pan:this.pan=e.shortAmount/1e3;break;case hs.DelayModLFO:this.delayModLFO=e.shortAmount;break;case hs.FreqModLFO:this.freqModLFO=e.shortAmount;break;case hs.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case hs.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case hs.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case hs.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case hs.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case hs.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case hs.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case hs.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case hs.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case hs.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case hs.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case hs.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case hs.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case hs.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case hs.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case hs.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case hs.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case hs.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case hs.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case hs.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case hs.StartloopAddrsCoarseOffset:this.loopStart+=32768*re.int16ToUint32(e.shortAmount);break;case hs.InitialAttenuation:this.attenuation+=.1*e.shortAmount;break;case hs.EndloopAddrsCoarseOffset:this.loopEnd+=32768*re.int16ToUint32(e.shortAmount);break;case hs.CoarseTune:this.transpose+=e.shortAmount;break;case hs.FineTune:this.tune+=e.shortAmount;break;case hs.SampleModes:this.loopMode=3&~e.wordAmount?1==(3&e.wordAmount)?rs.Continuous:rs.None:rs.Sustain;break;case hs.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case hs.ExclusiveClass:this.group=e.wordAmount;break;case hs.OverridingRootKey:this.pitchKeyCenter=e.shortAmount}}}!function(t){t[t.None=0]="None",t[t.Delay=1]="Delay",t[t.Attack=2]="Attack",t[t.Hold=3]="Hold",t[t.Decay=4]="Decay",t[t.Sustain=5]="Sustain",t[t.Release=6]="Release",t[t.Done=7]="Done"}(os||(os={}));class zn{static Zd=.01;level=0;slope=0;samplesUntilNextSegment=0;segment=os.None;midiVelocity=0;parameters=null;segmentIsExponential=!1;isAmpEnv=!1;nextSegment(t,e){if(this.parameters)for(;;)switch(t){case os.None:if(this.samplesUntilNextSegment=this.parameters.delay*e|0,this.samplesUntilNextSegment>0)return this.segment=os.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);t=os.Delay;break;case os.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*e|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*e|0),this.segment=os.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);t=os.Attack;break;case os.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*e|0,this.samplesUntilNextSegment>0)return this.segment=os.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);t=os.Hold;break;case os.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*e|0,this.samplesUntilNextSegment>0){if(this.segment=os.Decay,this.level=1,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/t|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*e|0,this.segmentIsExponential=!1;return}t=os.Decay;break;case os.Decay:return this.segment=os.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case os.Sustain:if(this.segment=os.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?zn.Zd:this.parameters.release)*e|0,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=os.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(t,e,s,i,n){this.parameters=new Hn(t),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-e),this.parameters.hold=this.parameters.hold<-1e4?0:Vn.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-e),this.parameters.decay=this.parameters.decay<-1e4?0:Vn.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(os.None,n)}process(t,e){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,t):this.level+=this.slope*t),this.samplesUntilNextSegment-=t,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,e)}}class jn{samplesUntil=0;level=0;delta=0;setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*Vn.cents2Hertz(e)/s,this.level=0}process(t){this.samplesUntil>t?this.samplesUntil-=t:(this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class Xn{qInv=0;a0=0;a1=0;b1=0;b2=0;z1=0;z2=0;active=!1;constructor(t){t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}class Jn{static renderEffectSampleBlock=It.MicroBufferSize;playingPreset=0;playingKey=0;playingChannel=0;region=null;pitchInputTimecents=0;pitchOutputFactor=0;sourceSamplePosition=0;noteGainDb=0;panFactorLeft=0;panFactorRight=0;playIndex=0;loopStart=0;loopEnd=0;ampEnv=new zn;modEnv=new zn;lowPass=new Xn;modLfo=new jn;vibLfo=new jn;mixVolume=0;mute=!1;updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192);const i=8192===s?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning;this.calcPitchRatio(i,e)}calcPitchRatio(t,e){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==t&&(i+=t),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Vn.timecents2Secs(100*this.region.pitchKeyCenter)*e)}end(t){this.region&&(this.ampEnv.nextSegment(os.Sustain,t),this.modEnv.nextSegment(os.Sustain,t),this.region.loopMode===rs.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(os.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(os.Sustain,t)}render(t,e,s,i,n){if(!this.region)return;const r=this.region,a=r.samples;let h=0,o=t.outputMode===as.StereoUnweaved?i:-1;const c=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,l=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),u=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,d=this.loopStart<this.loopEnd,f=this.loopStart,p=this.loopEnd,b=r.end,m=p+1;let g=this.sourceSamplePosition;const w=new Xn(this.lowPass),y=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc;let k=0,S=0,B=0,_=0;const x=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch;let T=0,M=0,v=0,N=0;const P=0!==r.modLfoToVolume;let E=0,F=0;for(y?(k=t.outSampleRate,S=r.initialFilterFc,B=r.modLfoToFilterFc,_=r.modEnvToFilterFc):(k=0,S=0,B=0,_=0),x?(T=0,M=r.modLfoToPitch,v=r.vibLfoToPitch,N=r.modEnvToPitch):(T=Vn.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,M=0,v=0,N=0),P?F=.1*r.modLfoToVolume:(E=Vn.decibelsToGain(this.noteGainDb),F=0);i>0;){let r,C,A=0,D=i>Jn.renderEffectSampleBlock?Jn.renderEffectSampleBlock:i;if(i-=D,y){const t=S+this.modLfo.level*B+this.modEnv.level*_;w.active=t<=13500,w.active&&w.setup(Vn.cents2Hertz(t)/k)}switch(x&&(T=Vn.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*M+this.vibLfo.level*v+this.modEnv.level*N))*this.pitchOutputFactor),P&&(E=Vn.decibelsToGain(this.noteGainDb+this.modLfo.level*F)),r=E*this.ampEnv.level,n?r=0:r*=this.mixVolume,this.ampEnv.process(D,t.outSampleRate),c&&this.modEnv.process(D,t.outSampleRate),l&&this.modLfo.process(D),u&&this.vibLfo.process(D),t.outputMode){case as.StereoInterleaved:for(C=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*C,h++,e[s+h]+=r*A,h++,g+=T,g>=m&&d&&(g-=p-f+1)}break;case as.StereoUnweaved:for(C=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*C,h++,e[s+o]+=r*A,o++,g+=T,g>=m&&d&&(g-=p-f+1)}break;case as.Mono:for(;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let o=a[t]*(1-n)+a[i]*n;w.active&&(o=w.process(o)),e[s+h]=o*r,h++,g+=T,g>=m&&d&&(g-=p-f+1)}}if(g>=b||this.ampEnv.segment===os.Done)return void this.kill()}this.sourceSamplePosition=g,(w.active||y)&&(this.lowPass=w)}kill(){this.playingPreset=-1}}class qn{value;next;constructor(t){this.value=t}}class Yn{tf;ef;get isEmpty(){return void 0===this.tf}clear(){this.tf=void 0,this.ef=void 0}enqueue(t){const e=new qn(t);this.ef?(this.ef.next=e,this.ef=e):(this.tf=e,this.ef=e)}enqueueFront(t){const e=new qn(t);e.next=this.tf,this.tf?this.tf=e:(this.tf=e,this.ef=e)}peek(){const t=this.tf;if(t)return t.value}dequeue(){const t=this.tf;if(!t)return;const e=t.next;return this.tf=e,e||(this.ef=void 0),t.value}}!function(t){t[t.BankSelectCoarse=0]="BankSelectCoarse",t[t.ModulationCoarse=1]="ModulationCoarse",t[t.DataEntryCoarse=6]="DataEntryCoarse",t[t.VolumeCoarse=7]="VolumeCoarse",t[t.PanCoarse=10]="PanCoarse",t[t.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",t[t.BankSelectFine=32]="BankSelectFine",t[t.ModulationFine=33]="ModulationFine",t[t.DataEntryFine=38]="DataEntryFine",t[t.VolumeFine=39]="VolumeFine",t[t.PanFine=42]="PanFine",t[t.ExpressionControllerFine=43]="ExpressionControllerFine",t[t.HoldPedal=64]="HoldPedal",t[t.LegatoPedal=68]="LegatoPedal",t[t.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",t[t.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",t[t.RegisteredParameterFine=100]="RegisteredParameterFine",t[t.RegisteredParameterCourse=101]="RegisteredParameterCourse",t[t.AllSoundOff=120]="AllSoundOff",t[t.ResetControllers=121]="ResetControllers",t[t.AllNotesOff=123]="AllNotesOff"}(cs||(cs={}));class Kn{sf=new Yn;if=new Map;nf=new Map;rf=!1;af=new Map;hf=new Map;currentTempo=0;timeSignatureNumerator=0;timeSignatureDenominator=0;constructor(t){this.outSampleRate=t}synthesize(t,e,s){return this.cf(t,e,s)}synthesizeSilent(t){this.cf(null,0,t)}channelGetMixVolume(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this.lf(t);for(const s of this.uf)s.playingChannel===t&&-1!==s.playingPreset&&(s.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this.if.set(t,!0):this.if.delete(t)}channelSetSolo(t,e){e?this.nf.set(t,!0):this.nf.delete(t),this.rf=this.nf.size>0}resetChannelStates(){this.if=new Map,this.nf=new Map,this.hf=new Map,this.applyTranspositionPitches(new Map),this.rf=!1}setChannelTranspositionPitch(t,e){let s=0;this.hf.has(t)&&(s=this.hf.get(t)),0===e?this.hf.delete(t):this.hf.set(t,e);for(const i of this.uf)if(i.playingChannel===t&&9!==i.playingChannel){let t=0;t-=s,t+=e,i.playingKey+=t,this.Lu&&i.updatePitchRatio(this.Lu.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this.af;for(const s of this.uf)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this.Lu&&s.updatePitchRatio(this.Lu.channelList[s.playingChannel],this.outSampleRate)}this.af=t}dispatchEvent(t){this.sf.enqueue(t)}cf(t,e,s){const i=this.rf,n=[];for(;!this.sf.isEmpty;){const t=this.sf.dequeue();t.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(It.MetronomeChannel,It.MetronomeKey),this.channelNoteOn(It.MetronomeChannel,It.MetronomeKey,95/127)):t.event&&this.processMidiMessage(t.event),n.push(t)}for(const n of this.uf)if(-1!==n.playingPreset){const r=n.playingChannel,a=this.if.has(r)||i&&r!==It.MetronomeChannel&&!this.nf.has(r);t?n.render(this,t,e,s,a):n.kill()}return n}processMidiMessage(t){switch(t.type){case es.TimeSignature:const e=t;this.timeSignatureNumerator=e.numerator,this.timeSignatureDenominator=Math.pow(2,e.denominatorIndex);break;case es.NoteOn:const s=t;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case es.NoteOff:const i=t;this.channelNoteOff(i.channel,i.noteKey);break;case es.ControlChange:const n=t;this.channelMidiControl(n.channel,n.controller,n.value);break;case es.ProgramChange:const r=t;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case es.TempoChange:const a=t;this.currentTempo=a.beatsPerMinute;break;case es.PitchBend:const h=t;this.channelSetPitchWheel(h.channel,h.value);break;case es.PerNotePitchBend:const o=t;let c=o.value;c=c*It.MaxPitchWheel/It.MaxPitchWheel20,this.channelSetPerNotePitchWheel(o.channel,o.noteKey,c)}}get metronomeVolume(){return this.channelGetMixVolume(It.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(It.MetronomeChannel,t),t>0&&(this.channelSetVolume(It.MetronomeChannel,1),this.channelSetPresetNumber(It.MetronomeChannel,0,!0))}get masterVolume(){return Vn.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=Vn.gainToDecibels(t),s=e-this.globalGainDb;if(0!==s){for(const t of this.uf)-1!==t.playingPreset&&(t.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this.uf)-1!==t.playingPreset&&(t.ampEnv.segment<os.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);if(this.Lu)for(const t of this.Lu.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}presets=null;uf=[];Lu=null;df=0;get presetCount(){return this.presets?.length??0}outputMode=as.StereoInterleaved;outSampleRate=0;globalGainDb=0;reset(){for(const t of this.uf)-1!==t.playingPreset&&(t.ampEnv.segment<os.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);this.Lu=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=127*s|0;if(t<0||t>=this.presets.length)return;if(s<=0)return void this.noteOff(t,e);const n=this.df++;for(const r of this.presets[t].regions){if(e<r.loKey||e>r.hiKey||i<r.loVel||i>r.hiVel)continue;let a=null;if(0!==r.group)for(const e of this.uf)e.playingPreset===t&&e.region.group===r.group?e.endQuick(this.outSampleRate):-1!==e.playingPreset||a||(a=e);else for(const t of this.uf)-1===t.playingPreset&&(a=t);if(!a){for(let t=0;t<4;t++){const t=new Jn;t.playingPreset=-1,this.uf.push(t)}a=this.uf[this.uf.length-4]}a.region=r,a.playingPreset=t,a.playingKey=e,a.playIndex=n,a.noteGainDb=this.globalGainDb-r.attenuation-Vn.gainToDecibels(1/s),this.Lu?this.Lu.setupVoice(this,a):(a.calcPitchRatio(0,this.outSampleRate),a.panFactorLeft=Math.sqrt(.5-r.pan),a.panFactorRight=Math.sqrt(.5+r.pan)),a.sourceSamplePosition=r.offset;const h=r.loopMode!==rs.None&&r.loopStart<r.loopEnd;a.loopStart=h?r.loopStart:0,a.loopEnd=h?r.loopEnd:0,a.ampEnv.setup(r.ampEnv,e,i,!0,this.outSampleRate),a.modEnv.setup(r.modEnv,e,i,!1,this.outSampleRate);const o=r.initialFilterQ/10;a.lowPass.qInv=1/Math.pow(10,o/20),a.lowPass.z1=0,a.lowPass.z2=0,a.lowPass.active=r.initialFilterFc<=13500,a.lowPass.active&&a.lowPass.setup(Vn.cents2Hertz(r.initialFilterFc)/this.outSampleRate),a.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),a.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const n=this.ff(t,e);return-1!==n&&(this.noteOn(n,s,i),!0)}noteOff(t,e){let s=null,i=null;const n=[];for(const r of this.uf)r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=os.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,n.push(r)):r.playIndex===s.playIndex&&(i=r,n.push(r)));if(s)for(const r of n)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=os.Release)||r.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this.ff(t,e);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this.uf)-1!==e.playingPreset&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<os.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this.uf)-1!==e.playingPreset&&t++;return t}lf(t){if(this.Lu&&t<this.Lu.channelList.length)return this.Lu.channelList[t];this.Lu||(this.Lu=new Gn);for(let e=this.Lu.channelList.length;e<=t;e++){const t=new In;t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0,t.mixVolume=1,this.Lu.channelList.push(t)}return this.Lu.channelList[t]}ff(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this.ff(t,e))}channelNoteOn(t,e,s){!this.Lu||t>this.Lu.channelList.length||(this.af.has(t)&&(e+=this.af.get(t)),this.hf.has(t)&&(e+=this.hf.get(t)),this.Lu.activeChannel=t,this.noteOn(this.Lu.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this.af.has(t)&&(e+=this.af.get(t)),this.hf.has(t)&&(e+=this.hf.get(t));const s=[];let i=null,n=null;for(const r of this.uf)-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=os.Release||(!i||r.playIndex<i.playIndex?(i=r,n=r,s.push(r)):r.playIndex===i.playIndex&&(n=r,s.push(r)));if(this.lf(t).perNotePitchWheel.delete(e),i)for(const r of s)r!==i&&r!==n&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=os.Release)||r.end(this.outSampleRate)}channelNoteOffAll(t){this.lf(t).perNotePitchWheel.clear();for(const e of this.uf)-1!==e.playingPreset&&e.playingChannel===t&&e.ampEnv.segment<os.Release&&e.end(this.outSampleRate)}channelSoundsOffAll(t){this.lf(t).perNotePitchWheel.clear();for(const e of this.uf)-1!==e.playingPreset&&e.playingChannel===t&&(e.ampEnv.segment<os.Release||0===e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this.lf(t).presetIndex=re.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this.lf(t);let n=0;return s?(n=this.ff(128|32767&i.bank,e),-1===n&&(n=this.ff(128,e)),-1===n&&(n=this.ff(128,0)),-1===n&&(n=this.ff(2047&i.bank,e))):n=this.ff(2047&i.bank,e),i.presetIndex=n,-1!==n}channelSetBank(t,e){this.lf(t).bank=re.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this.lf(t),n=this.ff(e,s);return-1!==n&&(i.presetIndex=re.int32ToUint16(n),i.bank=re.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this.uf)if(s.playingChannel===t&&-1!==s.playingPreset){const t=s.region.pan+e-.5;t<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):t>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-t),s.panFactorRight=Math.sqrt(.5+t))}this.lf(t).panOffset=e-.5}channelSetVolume(t,e){const s=this.lf(t),i=Vn.gainToDecibels(e),n=i-s.gainDb;if(0!==n){for(const e of this.uf)e.playingChannel===t&&-1!==e.playingPreset&&(e.noteGainDb+=n);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this.lf(t);s.pitchWheel!==e&&(s.pitchWheel=re.int32ToUint16(e),this.pf(t,s))}channelSetPerNotePitchWheel(t,e,s){this.af.has(t)&&(e+=this.af.get(t)),this.hf.has(t)&&(e+=this.hf.get(t));const i=this.lf(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this.pf(t,i,e))}pf(t,e,s=-1){for(const i of this.uf)i.playingChannel!==t||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this.lf(t);s.pitchRange!==e&&(s.pitchRange=e,8192!==s.pitchWheel&&this.pf(t,s))}channelSetTuning(t,e){const s=this.lf(t);s.tuning!==e&&(s.tuning=e,this.pf(t,s))}channelMidiControl(t,e,s){const i=this.lf(t);switch(e){case cs.DataEntryFine:return i.midiData=re.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case cs.VolumeCoarse:return i.midiVolume=re.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case cs.VolumeFine:return i.midiVolume=re.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case cs.ExpressionControllerCoarse:return i.midiExpression=re.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case cs.ExpressionControllerFine:return i.midiExpression=re.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case cs.PanCoarse:return i.midiPan=re.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(t,i.midiPan/16383);case cs.PanFine:return i.midiPan=re.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(t,i.midiPan/16383);case cs.DataEntryCoarse:return i.midiData=re.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&e===cs.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case cs.BankSelectCoarse:return void(i.bank=re.int32ToUint16(32768|s));case cs.BankSelectFine:return void(i.bank=re.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case cs.RegisteredParameterCourse:return void(i.midiRpn=re.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case cs.RegisteredParameterFine:return void(i.midiRpn=re.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case cs.NonRegisteredParameterFine:case cs.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case cs.AllSoundOff:return void this.channelSoundsOffAll(t);case cs.AllNotesOff:return void this.channelNoteOffAll(t);case cs.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),void this.channelSetPitchRange(t,2)}}channelGetPresetIndex(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].presetIndex:0}channelGetPresetBank(t){return this.Lu&&t<this.Lu.channelList.length?32767&this.Lu.channelList[t].bank:0}channelGetPan(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this.Lu&&t<this.Lu.channelList.length?Vn.decibelsToGain(this.Lu.channelList[t].gainDb):1}channelGetPitchWheel(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].pitchRange:2}channelGetTuning(t){return this.Lu&&t<this.Lu.channelList.length?this.Lu.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const n=[];for(let i=0;i<t.phdrs.length-1;i++){const r=t.phdrs[i];let a=0;const h=new $n;n.push(h),h.name=r.presetName,h.bank=r.bank,h.presetNumber=r.preset;let o=0;for(let e=r.presetBagNdx;e<t.phdrs[i+1].presetBagNdx;e++){let s=0,i=127,n=0,r=127;for(let a=t.pbags[e].genNdx;a<t.pbags[e+1].genNdx;a++){const e=t.pgens[a];if(e.genOper===Dn.GenKeyRange){s=e.genAmount.lowByteAmount,i=e.genAmount.highByteAmount;continue}if(e.genOper===Dn.GenVelRange){n=e.genAmount.lowByteAmount,r=e.genAmount.highByteAmount;continue}if(e.genOper!==Dn.GenInstrument)continue;if(e.genAmount.wordAmount>=t.insts.length)continue;for(let a=t.insts[e.genAmount.wordAmount].instBagNdx;a<t.insts[e.genAmount.wordAmount+1].instBagNdx;a++){let e=0,h=127,c=0,l=127;for(let u=t.ibags[a].instGenNdx;u<t.ibags[a+1].instGenNdx;u++){const a=t.igens[u];a.genOper!==Dn.GenKeyRange?a.genOper!==Dn.GenVelRange?53===a.genOper&&h>=s&&e<=i&&l>=n&&c<=r&&o++:(c=a.genAmount.lowByteAmount,l=a.genAmount.highByteAmount):(e=a.genAmount.lowByteAmount,h=a.genAmount.highByteAmount)}}}}h.regions=new Array(o);let c=new Un;c.clear(!0);for(let n=r.presetBagNdx;n<t.phdrs[i+1].presetBagNdx;n++){const i=t.pbags[n],o=new Un(c);let l=!1;for(let c=i.genNdx;c<t.pbags[n+1].genNdx;c++){const i=t.pgens[c];if(i.genOper===Dn.GenInstrument){const n=i.genAmount.wordAmount;if(n>=t.insts.length)continue;let c=new Un;c.clear(!1);const u=t.insts[n];for(let i=u.instBagNdx;i<t.insts[n+1].instBagNdx;i++){const n=t.ibags[i],l=new Un(c);let d=!1;for(let c=n.instGenNdx;c<t.ibags[i+1].instGenNdx;c++){const i=t.igens[c];if(i.genOper===Dn.GenSampleId){if(l.hiKey<o.loKey||l.loKey>o.hiKey)continue;if(l.hiVel<o.loVel||l.loVel>o.hiVel)continue;o.loKey>l.loKey&&(l.loKey=o.loKey),o.hiKey<l.hiKey&&(l.hiKey=o.hiKey),o.loVel>l.loVel&&(l.loVel=o.loVel),o.hiVel<l.hiVel&&(l.hiVel=o.hiVel),l.offset+=o.offset,l.end+=o.end,l.loopStart+=o.loopStart,l.loopEnd+=o.loopEnd,l.transpose+=o.transpose,l.tune+=o.tune,l.pitchKeyTrack+=o.pitchKeyTrack,l.attenuation+=o.attenuation,l.pan+=o.pan,l.ampEnv.delay+=o.ampEnv.delay,l.ampEnv.attack+=o.ampEnv.attack,l.ampEnv.hold+=o.ampEnv.hold,l.ampEnv.decay+=o.ampEnv.decay,l.ampEnv.sustain+=o.ampEnv.sustain,l.ampEnv.release+=o.ampEnv.release,l.modEnv.delay+=o.modEnv.delay,l.modEnv.attack+=o.modEnv.attack,l.modEnv.hold+=o.modEnv.hold,l.modEnv.decay+=o.modEnv.decay,l.modEnv.sustain+=o.modEnv.sustain,l.modEnv.release+=o.modEnv.release,l.initialFilterQ+=o.initialFilterQ,l.initialFilterFc+=o.initialFilterFc,l.modEnvToPitch+=o.modEnvToPitch,l.modEnvToFilterFc+=o.modEnvToFilterFc,l.delayModLFO+=o.delayModLFO,l.freqModLFO+=o.freqModLFO,l.modLfoToPitch+=o.modLfoToPitch,l.modLfoToFilterFc+=o.modLfoToFilterFc,l.modLfoToVolume+=o.modLfoToVolume,l.delayVibLFO+=o.delayVibLFO,l.freqVibLFO+=o.freqVibLFO,l.vibLfoToPitch+=o.vibLfoToPitch,l.ampEnv.envToSecs(!0),l.modEnv.envToSecs(!1),l.delayModLFO=l.delayModLFO<-11950?0:Vn.timecents2Secs(l.delayModLFO),l.delayVibLFO=l.delayVibLFO<-11950?0:Vn.timecents2Secs(l.delayVibLFO),l.pan<-.5?l.pan=-.5:l.pan>.5&&(l.pan=.5),(l.initialFilterQ<1500||l.initialFilterQ>13500)&&(l.initialFilterQ=0);const n=t.sHdrs[i.genAmount.wordAmount];l.offset+=n.start,l.end+=n.end,l.loopStart+=n.startLoop,l.loopEnd+=n.endLoop,n.endLoop>0&&(l.loopEnd-=1),-1===l.pitchKeyCenter&&(l.pitchKeyCenter=n.originalPitch),l.tune+=n.pitchCorrection,l.sampleRate=n.sampleRate;const c=r.bank===It.PercussionBank;if(c&&Kn.bf(s,l.loKey,l.hiKey)||!c&&e.has(r.preset))if(1&n.sampleType){z.debug("AlphaSynth",`Loading of used sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`);!!(16&n.sampleType)?l.samples=t.decodeSamples(n.start,n.end,!0):(l.samples=t.decodeSamples(2*l.offset,2*l.end,!1),l.loopStart>0&&(l.loopStart-=l.offset),l.loopEnd>0&&(l.loopEnd-=l.offset)),l.offset=0,l.end=l.samples.length-1}else z.warning("AlphaSynth",`Skipping load of unsupported sample ${n.sampleName} for preset ${r.presetName}, sample type ${n.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);else z.debug("AlphaSynth",`Skipping load of unused sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);h.regions[a]=new Un(l),a++,d=!0}else l.operator(i.genOper,i.genAmount)}n!==t.ibags[u.instBagNdx]||d||(c=new Un(l))}l=!0}else o.operator(i.genOper,i.genAmount)}i!==t.pbags[r.presetBagNdx]||l||(c=o)}}if(i&&this.presets)for(const t of n)this.presets.push(t);else this.presets=n}static bf(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t)for(const t of s.regions)if(t.samples.length>0)return!0;return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===It.PercussionBank)for(const e of s.regions)if(e.loKey>=t&&e.hiKey<=t&&e.samples.length>0)return!0;return!1}}class Qn{events;constructor(t){this.events=t}}class Zn{playbackRange;constructor(t){this.playbackRange=t}}class tr{soundFonts;sampleRate=44100;useSyncPoints=!1;masterVolume=1;metronomeVolume=0;playbackRange;trackVolume=new Map;trackTranspositionPitches=new Map}class er{samples;currentTime=0;endTime=0;currentTick=0;endTick=0}class sr{sequencer;synthesizer;isSoundFontLoaded=!1;mf=!1;gf=0;wf=0;yf=0;kf=0;playedEventsQueue=new Yn;midiEventsPlayedFilterSet=new Set;Sf=0;Bf=!1;Hi;_f;Ld=new ji(0,0,0,0,!1,120,120);get output(){return this.Hi}isReady=!1;get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this.mf}state=ss.Paused;get logLevel(){return z.logLevel}set logLevel(t){z.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,It.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this.yf}set metronomeVolume(t){t=Math.max(t,It.MinVolume),this.yf=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this.kf}set countInVolume(t){t=Math.max(t,It.MinVolume),this.kf=t}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(t){this.midiEventsPlayedFilterSet=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=Vt.clamp(t,It.MinPlaybackSpeed,It.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this._f}get currentPosition(){return this.Ld}get tickPosition(){return this.gf}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this.wf}set timePosition(t){z.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this.Sf=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new Zn(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){z.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(t,e,s){z.debug("AlphaSynth","Initializing player"),this.state=ss.Paused,this.ready=new xe(()=>this.isReady),this.readyForPlayback=new xe(()=>this.isReadyForPlayback),this.midiLoaded=new Te(()=>this._f?this._f:null),this.stateChanged=new Te(()=>new zi(this.state,!1)),this.positionChanged=new Te(()=>this.Ld),this.playbackRangeChanged=new Te(()=>this.playbackRange?new Zn(this.playbackRange):null),z.debug("AlphaSynth","Creating output"),this.Hi=t,z.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new Ui(this.synthesizer),z.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.xf()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.Tf.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===ss.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(It.MicroBufferSize*It.MicroBufferCount*It.AudioChannels),e=0;for(let s=0;s<It.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const s=this.synthesizer.synthesize(t,e,It.MicroBufferSize);e+=It.MicroBufferSize*It.AudioChannels;for(const t of s)this.midiEventsPlayedFilterSet.has(t.event.type)&&this.playedEventsQueue.enqueue(t);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this.Sf+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return!(this.state!==ss.Paused||!this.mf)&&(this.output.activate(),this.Mf(),this.kf>0&&(z.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this.kf),this.updateTimePosition(0,!0)),this.output.play(),!0)}Mf(){this.sequencer.isPlayingOneTimeMidi&&(z.debug("AlphaSynth","Cancelling one time midi"),this.vf()),z.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this.Bf=!1,this.state=ss.Playing,this.stateChanged.trigger(new zi(this.state,!1))}pause(){this.state!==ss.Paused&&this.mf&&(z.debug("AlphaSynth","Pausing playback"),this.state=ss.Paused,this.stateChanged.trigger(new zi(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===ss.Paused&&this.mf?this.play():this.pause()}stop(){this.mf&&(z.debug("AlphaSynth","Stopping playback"),this.state=ss.Paused,this.output.pause(),this.Sf=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new zi(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this.vf():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this.Sf=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this.Nf=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}Nf=[];loadSoundFont(t,e){this.pause();const s=Re.fromBuffer(t);try{z.debug("AlphaSynth","Loading soundfont from bytes");const t=new Nn;t.load(s),e||(this.Nf=[]),this.Nf.push(t),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),z.debug("AlphaSynth","soundFont successfully loaded"),this.xf()}catch(t){z.error("AlphaSynth",`Could not load soundfont from bytes ${t}`),this.soundFontLoadFailed.trigger(t)}}xf(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this.Nf)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{z.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this.mf=!0,this._f=new ji(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._f),z.debug("AlphaSynth","Midi successfully loaded"),this.xf(),this.tickPosition=0}catch(t){z.error("AlphaSynth",`Could not load midi from model ${t}`),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,It.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}Tf(t){if(0===t)return;const e=t/this.synthesizer.outSampleRate*1e3;this.Sf-=t*It.AudioChannels,this.updateTimePosition(this.wf+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this.gf>=e&&(this.Sf<=0?(this.Sf=0,this.sequencer.isPlayingCountIn?(z.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.Mf(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(z.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=ss.Paused,this.vf()):this.isLooping?(z.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this.Bf=!1):this.synthesizer.activeVoiceCount>0?this.Bf||(z.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this.Bf=!0):(this.Bf=!1,z.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this.Bf||(z.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this.Bf=!0))}vf(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}Pf(t){let e=this.wf,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,n=this.sequencer.currentEndTick;return e>i&&(e=i,s=n),new ji(e,i,s,n,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this.wf=t;const s=this.Pf(e);this.gf=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(z.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this.Ld=s,this.positionChanged.trigger(s)),e)this.playedEventsQueue.clear();else{const t=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const e=this.playedEventsQueue.dequeue();t.push(e.event)}t.length>0&&(t.reverse(),this.midiEventsPlayed.trigger(new Qn(t)))}}ready;readyForPlayback=new xe;finished=new xe;soundFontLoaded=new xe;soundFontLoadFailed=new Te;midiLoaded;midiLoadFailed=new Te;stateChanged;positionChanged;midiEventsPlayed=new Te;playbackRangeChanged;hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class ir extends sr{constructor(t,e){super(t,new Kn(t.sampleRate),e)}exportAudio(t,e,s,i){const n=new nr(t);n.loadMidiFile(e),t.useSyncPoints&&n.updateSyncPoints(s),n.applyTranspositionPitches(i);for(const[e,s]of t.trackTranspositionPitches)n.setChannelTranspositionPitch(e,s);for(const[e,s]of t.trackVolume)n.channelSetMixVolume(e,s);if(t.soundFonts)for(const e of t.soundFonts)n.loadSoundFont(e);else n.loadPresets(this.synthesizer.presets);return t.playbackRange&&n.limitExport(t.playbackRange),n.setup(),n}}class nr{Ef;Ff;constructor(t){this.Ef=new Kn(t.sampleRate),this.Ff=new Ui(this.Ef),this.Ef.masterVolume=Math.max(t.masterVolume,It.MinVolume),this.Ef.metronomeVolume=Math.max(t.metronomeVolume,It.MinVolume)}loadSoundFont(t){const e=Re.fromBuffer(t),s=new Nn;s.load(e);const i=this.Ff.instrumentPrograms,n=this.Ff.percussionKeys;this.Ef.loadPresets(s,i,n,!0)}loadPresets(t){this.Ef.presets=t}limitExport(t){this.Ff.mainPlaybackRange=t,this.Ff.mainSeek(this.Ff.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this.Ef.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this.Ef.applyTranspositionPitches(t)}loadMidiFile(t){this.Ff.loadMidi(t)}updateSyncPoints(t){this.Ff.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,It.MinVolume),this.Ef.channelSetMixVolume(t,e)}Cf=0;Af=0;setup(){this.Ef.setupMetronomeChannel(this.Ef.metronomeVolume);const t=this.Ff.currentSyncPoints,e=this.Ff.currentEndTime;if(0===t.length)this.Af=e;else{const e=t[t.length-1];let s=e.syncTime;const i=this.Ff.currentEndTick-e.synthTick;i>0&&(s+=R.ticksToMillis(i,e.syncBpm)),this.Af=s}}render(t){if(this.Ff.isFinished)return;const e=1e3*It.MicroBufferSize/this.Ef.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(It.MicroBufferSize*s*It.AudioChannels);const n=this.Ff.currentSyncPoints;let r=0,a=this.Cf;for(let t=0;t<s;t++){if(n.length>0){this.Ff.currentUpdateSyncPoints(a),this.Ff.currentUpdateCurrentTempo(this.Ff.currentTime);const t=this.Ff.syncPointTempo/this.Ff.currentTempo;this.Ff.playbackSpeed!==t&&(this.Ff.playbackSpeed=t)}if(this.Ff.fillMidiEventQueue(),this.Ef.synthesize(i,r,It.MicroBufferSize),r+=It.MicroBufferSize*It.AudioChannels,a+=e,this.Ff.isFinished)break}r<i.length&&(i=i.subarray(0,r));const h=new er;return h.currentTime=this.Cf,h.endTime=this.Af,h.currentTick=this.Ff.currentTimePositionToTickPosition(this.Ff.currentTime),h.endTick=this.Ff.currentEndTick,this.Cf+=t,h.samples=i,this.Ff.isFinished&&this.Ef.noteOffAll(!0),h}}class rr{static parseEnum(t,e){switch(typeof t){case"string":const s=Number.parseInt(t,10);return Number.isNaN(s)?e[Object.keys(e).find(e=>e.toLowerCase()===t.toLowerCase())]:s;case"number":return t;case"undefined":case"object":return}throw new W(s.Format,`Could not parse enum value '${t}'`)}static parseEnumExact(t,e){if(t in e)return e[t]}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if("object"==typeof t)for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):"object"==typeof t?t[e]:null}}class ar{startPos;endPos;text;constructor(t,e,s){this.text=t,this.startPos=e,this.endPos=s}}class hr{style="normal";variant="normal";weight="normal";stretch="normal";lineHeight="normal";size="1rem";families=[];parseOnlyFamilies=!1;Df;Lf=-1;zi="";Wf=null;constructor(t){this.zi=t,this.Df=this.Of(t)}Of(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&" "!==t.charAt(i);)i++;i>s&&e.push(new ar(t.substring(s,i),s,i)),s=i+1}return e}parse(){if(this.Rf(),1===this.Df.length)switch(this.Wf?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.If(),this.Gf()),this.$f()}static parseFamilies(t){const e=new hr(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}$f(){if(!this.Wf){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this.zi.substr(this.Wf.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(" "===s||","===s)e++;else if('"'===s||"'"===s){const i=this.Vf(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const s=this.Vf(t,e+1,",");this.families.push(t.substring(e,s).trim()),e=s+1}}}Vf(t,e,s){let i=!1;for(;e<t.length;){const n=t.charAt(e);if(!i&&n===s)return e;i=!i&&"\\"===n,e+=1}return t.length}Gf(){if(!this.Wf)throw new Error("Missing font size");const t=this.Wf.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this.Wf}' specified`);if(this.Hf(),t.length>=2)if("/"===t[1]){if(!this.Wf)throw new Error("Missing line-height after font size");this.lineHeight=this.Wf.text,this.Hf()}else this.size=t[0],this.lineHeight=t[1];else{if(!(t.length>=1))throw new Error("Missing font size");if(this.size=t[0],this.Wf&&0===this.Wf.text.indexOf("/"))if("/"===this.Wf.text){if(this.Hf(),!this.Wf)throw new Error("Missing line-height after font size");this.lineHeight=this.Wf.text,this.Hf()}else this.lineHeight=this.Wf.text.substr(1),this.Hf()}}Hf(){this.Lf++,this.Lf<this.Df.length?this.Wf=this.Df[this.Lf]:this.Wf=null}If(){let t=!1,e=!1,s=!1,i=3;const n=[];for(;;){if(!this.Wf)return;const r=this.Wf.text;switch(r){case"normal":case"inherit":n.push(r),i--,this.Hf();break;case"italic":case"oblique":this.style=r,t=!0,i--,this.Hf();break;case"small-caps":this.variant=r,e=!0,i--,this.Hf();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this.Hf();break;default:return}if(0===i)break}for(;n.length>0;){const i=n.pop();s?e?t||(this.style=i):this.variant=i:this.weight=i}}Rf(){this.Lf=-1,this.Hf()}static quoteFont(t){if(-1===t.indexOf(" "))return t;return`"${t.replaceAll('"','\\"')}"`}}!function(t){t[t.Plain=0]="Plain",t[t.Italic=1]="Italic"}(ls||(ls={})),function(t){t[t.Regular=0]="Regular",t[t.Bold=1]="Bold"}(us||(us={}));class or{Uf;zf=0;jf;Xf;Jf;_i;Rf(){this.zf=0,this.Uf=this.toCssString()}get family(){return this.jf[0]}set family(t){this.families=hr.parseFamilies(t)}get families(){return this.jf}set families(t){this.jf=t,this.Rf()}get size(){return this._i}set size(t){this._i=t,this.Rf()}get style(){return this.Xf}set style(t){this.Xf=t,this.Rf()}get weight(){return this.Jf}set weight(t){this.Jf=t,this.Rf()}get isBold(){return this.weight===us.Bold}get isItalic(){return this.style===ls.Italic}constructor(t,e,s=ls.Plain,i=us.Regular){this.jf=hr.parseFamilies(t),this._i=e,this.Xf=s,this.Jf=i,this.Uf=this.toCssString()}withSize(t){return or.withFamilyList(this.jf,t,this.Xf,this.Jf)}static withFamilyList(t,e,s=ls.Plain,i=us.Regular){const n=new or("",e,s,i);return n.families=t,n}toCssString(t=1){if(!(this.Uf&&Math.abs(t-this.zf)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(t=>hr.quoteFont(t)).join(", "),this.Uf=e,this.zf=t}return this.Uf}static fromJson(t){if(t instanceof or)return t;switch(typeof t){case"undefined":default:return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),n=rr.parseEnum(e.get("style"),ls),r=rr.parseEnum(e.get("weight"),us);return or.withFamilyList(s,i,n,r)}case"string":{const e=new hr(t);e.parse();const s=e.families,i=e.size.toLowerCase();let n=0;switch(i){case"xx-small":n=7;break;case"x-small":n=10;break;case"small":case"smaller":n=13;break;case"medium":n=16;break;case"large":case"larger":n=18;break;case"x-large":n=24;break;case"xx-large":n=32;break;default:try{n=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{n=12}}let r=ls.Plain;"italic"===e.style&&(r=ls.Italic);let a=us.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:a=us.Bold}return or.withFamilyList(s,n,r,a)}}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}class cr{static clone(t){const e=new ur;return e.musicFontSize=t.musicFontSize,e.oneStaffSpace=t.oneStaffSpace,e.tabLineSpacing=t.tabLineSpacing,e.arrowShaftThickness=t.arrowShaftThickness,e.barlineSeparation=t.barlineSeparation,e.beamSpacing=t.beamSpacing,e.beamThickness=t.beamThickness,e.bracketThickness=t.bracketThickness,e.dashedBarlineDashLength=t.dashedBarlineDashLength,e.dashedBarlineGapLength=t.dashedBarlineGapLength,e.dashedBarlineThickness=t.dashedBarlineThickness,e.hairpinThickness=t.hairpinThickness,e.legerLineThickness=t.legerLineThickness,e.legerLineExtension=t.legerLineExtension,e.octaveLineThickness=t.octaveLineThickness,e.pedalLineThickness=t.pedalLineThickness,e.repeatBarlineDotSeparation=t.repeatBarlineDotSeparation,e.repeatEndingLineThickness=t.repeatEndingLineThickness,e.slurMidpointThickness=t.slurMidpointThickness,e.staffLineThickness=t.staffLineThickness,e.stemThickness=t.stemThickness,e.thickBarlineThickness=t.thickBarlineThickness,e.thinBarlineThickness=t.thinBarlineThickness,e.thinThickBarlineSeparation=t.thinThickBarlineSeparation,e.tieMidpointThickness=t.tieMidpointThickness,e.tupletBracketThickness=t.tupletBracketThickness,e.stemUp=new Map(t.stemUp),e.stemDown=new Map(t.stemDown),e.repeatOffsetX=new Map(t.repeatOffsetX),e.standardStemLength=t.standardStemLength,e.stemFlagOffsets=new Map(t.stemFlagOffsets),e.glyphTop=new Map(t.glyphTop),e.glyphBottom=new Map(t.glyphBottom),e.glyphWidths=new Map(t.glyphWidths),e.glyphHeights=new Map(t.glyphHeights),e.numberedBarRendererBarSize=t.numberedBarRendererBarSize,e.numberedBarRendererBarSpacing=t.numberedBarRendererBarSpacing,e.numberedDashGlyphPadding=t.numberedDashGlyphPadding,e.numberedDashGlyphWidth=t.numberedDashGlyphWidth,e.lineRangedGlyphDashGap=t.lineRangedGlyphDashGap,e.lineRangedGlyphDashSize=t.lineRangedGlyphDashSize,e.preNoteEffectPadding=t.preNoteEffectPadding,e.postNoteEffectPadding=t.postNoteEffectPadding,e.onNoteEffectPadding=t.onNoteEffectPadding,e.stringNumberCirclePadding=t.stringNumberCirclePadding,e.rowContainerPadding=t.rowContainerPadding,e.rowContainerGap=t.rowContainerGap,e.alternateEndingsPadding=t.alternateEndingsPadding,e.sustainPedalLinePadding=t.sustainPedalLinePadding,e.tieHeight=t.tieHeight,e.beatTimerPadding=t.beatTimerPadding,e.bendNoteHeadElementPadding=t.bendNoteHeadElementPadding,e.ghostParenthesisWidth=t.ghostParenthesisWidth,e.ghostParenthesisPadding=t.ghostParenthesisPadding,e.brokenBeamWidth=t.brokenBeamWidth,e.tabWhammyTextPadding=t.tabWhammyTextPadding,e.tabWhammyPerHalfHeight=t.tabWhammyPerHalfHeight,e.tabWhammyDashSize=t.tabWhammyDashSize,e.songBookWhammyDipHeight=t.songBookWhammyDipHeight,e.deadSlappedLineWidth=t.deadSlappedLineWidth,e.leftHandTabTieWidth=t.leftHandTabTieWidth,e.tabBendDashSize=t.tabBendDashSize,e.tabBendPerValueHeight=t.tabBendPerValueHeight,e.tabBendLabelPadding=t.tabBendLabelPadding,e.simpleSlideWidth=t.simpleSlideWidth,e.simpleSlideHeight=t.simpleSlideHeight,e.chordDiagramPaddingX=t.chordDiagramPaddingX,e.chordDiagramPaddingY=t.chordDiagramPaddingY,e.chordDiagramStringSpacing=t.chordDiagramStringSpacing,e.chordDiagramFretSpacing=t.chordDiagramFretSpacing,e.chordDiagramNutHeight=t.chordDiagramNutHeight,e.chordDiagramFretHeight=t.chordDiagramFretHeight,e.chordDiagramLineWidth=t.chordDiagramLineWidth,e.tripletFeelBracketPadding=t.tripletFeelBracketPadding,e.accidentalPadding=t.accidentalPadding,e.preBeatGlyphSpacing=t.preBeatGlyphSpacing,e.tempoNoteScale=t.tempoNoteScale,e.tuningGlyphCircleNumberScale=t.tuningGlyphCircleNumberScale,e.tuningGlyphStringColumnScale=t.tuningGlyphStringColumnScale,e.tuningGlyphStringRowPadding=t.tuningGlyphStringRowPadding,e.directionsScale=t.directionsScale,e}}class lr{topY=0;bottomY=0;x=0}class ur{static qf;static get bravuraDefaults(){let t=ur.qf;return t||(t=new ur,t.fillFromSmufl(ur.bravuraMetadata),ur.qf=t),cr.clone(t)}musicFontSize=0;oneStaffSpace=0;tabLineSpacing=0;arrowShaftThickness=0;barlineSeparation=0;beamSpacing=0;beamThickness=0;bracketThickness=0;dashedBarlineDashLength=0;dashedBarlineGapLength=0;dashedBarlineThickness=0;hairpinThickness=0;legerLineThickness=0;legerLineExtension=0;octaveLineThickness=0;pedalLineThickness=0;repeatBarlineDotSeparation=0;repeatEndingLineThickness=0;slurMidpointThickness=0;staffLineThickness=0;stemThickness=0;thickBarlineThickness=0;thinBarlineThickness=0;thinThickBarlineSeparation=0;tieMidpointThickness=0;tupletBracketThickness=0;stemUp=new Map;stemDown=new Map;repeatOffsetX=new Map;standardStemLength=0;stemFlagOffsets=new Map;glyphTop=new Map;glyphBottom=new Map;glyphWidths=new Map;glyphHeights=new Map;hasSymbol(t){return this.glyphWidths.get(t)>0&&this.glyphHeights.get(t)>0}fillFromSmufl(t,e=36){this.musicFontSize=e,this.oneStaffSpace=e/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof t.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(c.QuadrupleWhole,0),this.stemFlagOffsets.set(c.DoubleWhole,0),this.stemFlagOffsets.set(c.Whole,0),this.stemFlagOffsets.set(c.Half,0),this.stemFlagOffsets.set(c.Quarter,0),this.stemFlagOffsets.set(c.Eighth,0),this.stemFlagOffsets.set(c.Sixteenth,0),this.stemFlagOffsets.set(c.ThirtySecond,0),this.stemFlagOffsets.set(c.SixtyFourth,0),this.stemFlagOffsets.set(c.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(c.TwoHundredFiftySixth,0);for(const[e,s]of Object.entries(t.glyphsWithAnchors)){const t=ur.Yf(e);if(t){if(s.stemDownNW){const e=new lr;e.x=s.stemDownNW[0]*this.oneStaffSpace,e.topY=s.stemDownNW[1]*this.oneStaffSpace,s.stemDownSW?e.bottomY=s.stemDownSW[1]*this.oneStaffSpace:e.bottomY=0,this.stemDown.set(t,e)}if(s.stemUpSE){const e=new lr,i=s.stemUpSE[0]*this.oneStaffSpace;e.bottomY=s.stemUpSE[1]*this.oneStaffSpace,s.stemUpNW?(e.x=s.stemUpNW[0]*this.oneStaffSpace,e.topY=s.stemUpNW[1]*this.oneStaffSpace):(e.x=i-this.stemThickness,e.topY=0),this.stemUp.set(t,e)}if(s.repeatOffset&&this.repeatOffsetX.set(t,s.repeatOffset[0]*this.oneStaffSpace),s.stemUpNW){const e=s.stemUpNW[1]*this.oneStaffSpace;switch(t){case rt.Flag8thUp:this.stemFlagOffsets.set(c.Eighth,e);break;case rt.Flag16thUp:this.stemFlagOffsets.set(c.Sixteenth,e);break;case rt.Flag32ndUp:this.stemFlagOffsets.set(c.ThirtySecond,e);break;case rt.Flag64thUp:this.stemFlagOffsets.set(c.SixtyFourth,e);break;case rt.Flag128thUp:this.stemFlagOffsets.set(c.OneHundredTwentyEighth,e);break;case rt.Flag256thUp:this.stemFlagOffsets.set(c.TwoHundredFiftySixth,e)}}}}const i=new Set,n=t.glyphBBoxes;if(n)for(const[t,e]of Object.entries(n)){const s=ur.Yf(t);s&&(i.add(s),this.glyphTop.set(s,e.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(s,e.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(s,(e.bBoxNE[0]-e.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(s,(e.bBoxNE[1]-e.bBoxSW[1])*this.oneStaffSpace))}const r=new Set([rt.None,rt.Space,rt.NoteheadNull]);for(const t of Vt.getAllMusicFontSymbols())i.has(t)||(r.has(t)||z.warning("SmuFL",`The provided SmuFL font is missing the glyph ${rt[t]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(t,0),this.glyphBottom.set(t,0),this.glyphWidths.set(t,0),this.glyphHeights.set(t,0));this.numberedBarRendererBarSize=2*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]);static Yf(t){const e=ur.smuflNameToGlyphNameMapping.has(t)?ur.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return rr.parseEnumExact(e,rt)}numberedBarRendererBarSize=0;numberedBarRendererBarSpacing=0;numberedDashGlyphPadding=0;numberedDashGlyphWidth=0;lineRangedGlyphDashGap=0;lineRangedGlyphDashSize=0;preNoteEffectPadding=0;postNoteEffectPadding=0;onNoteEffectPadding=0;stringNumberCirclePadding=0;rowContainerPadding=0;rowContainerGap=0;alternateEndingsPadding=0;sustainPedalLinePadding=0;tieHeight=0;beatTimerPadding=0;bendNoteHeadElementPadding=0;ghostParenthesisWidth=0;ghostParenthesisPadding=0;brokenBeamWidth=0;tabWhammyTextPadding=0;tabWhammyPerHalfHeight=0;tabWhammyDashSize=0;songBookWhammyDipHeight=0;deadSlappedLineWidth=0;leftHandTabTieWidth=0;tabBendDashSize=0;tabBendPerValueHeight=0;tabBendLabelPadding=0;simpleSlideWidth=0;simpleSlideHeight=0;chordDiagramPaddingX=0;chordDiagramPaddingY=0;chordDiagramStringSpacing=0;chordDiagramFretSpacing=0;chordDiagramNutHeight=0;chordDiagramFretHeight=0;chordDiagramLineWidth=0;tripletFeelBracketPadding=0;accidentalPadding=0;preBeatGlyphSpacing=0;tempoNoteScale=.7;tuningGlyphCircleNumberScale=.7;tuningGlyphStringColumnScale=1.5;tuningGlyphStringRowPadding=0;directionsScale=.6;static bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}}}class dr{static Kf="Arial, sans-serif";static Qf="Georgia, serif";smuflFontFamilyName;engravingSettings=ur.bravuraDefaults;copyrightFont=new or(dr.Kf,12,ls.Plain,us.Bold);titleFont=new or(dr.Qf,32,ls.Plain);subTitleFont=new or(dr.Qf,20,ls.Plain);wordsFont=new or(dr.Qf,15,ls.Plain);effectFont=new or(dr.Qf,12,ls.Italic);timerFont=new or(dr.Qf,12,ls.Plain);directionsFont=new or(dr.Qf,14,ls.Plain);fretboardNumberFont=new or(dr.Kf,11,ls.Plain);numberedNotationFont=new or(dr.Kf,16,ls.Plain);numberedNotationGraceFont=new or(dr.Kf,14,ls.Plain);tablatureFont=new or(dr.Kf,14,ls.Plain);graceFont=new or(dr.Kf,12,ls.Plain);staffLineColor=new pe(165,165,165,255);barSeparatorColor=new pe(34,34,17,255);barNumberFont=new or(dr.Kf,11,ls.Plain);barNumberColor=new pe(200,0,0,255);fingeringFont=new or(dr.Qf,14,ls.Plain);inlineFingeringFont=new or(dr.Qf,12,ls.Plain);markerFont=new or(dr.Qf,14,ls.Plain,us.Bold);mainGlyphColor=new pe(0,0,0,255);secondaryGlyphColor=new pe(0,0,0,100);scoreInfoColor=new pe(0,0,0,255);getFontForElement(t){switch(t){case it.Title:return this.titleFont;case it.SubTitle:case it.Artist:case it.Album:return this.subTitleFont;case it.Words:case it.Music:case it.WordsAndMusic:case it.Transcriber:return this.wordsFont;case it.Copyright:case it.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}!function(t){t[t.Default=0]="Default",t[t.ScoreTab=1]="ScoreTab",t[t.Score=2]="Score",t[t.Tab=3]="Tab",t[t.TabMixed=4]="TabMixed"}(ds||(ds={})),function(t){t[t.Automatic=0]="Automatic",t[t.UseModelLayout=1]="UseModelLayout"}(fs||(fs={}));class fr{scale=1;stretchForce=1;layoutMode=Ft.Page;staveProfile=ds.Default;barsPerRow=-1;startBar=1;barCount=-1;barCountPerPartial=10;justifyLastSystem=!1;resources=new dr;padding=[35,35];firstSystemPaddingTop=5;systemPaddingTop=10;systemPaddingBottom=10;lastSystemPaddingBottom=0;systemLabelPaddingLeft=0;systemLabelPaddingRight=3;accoladeBarPaddingRight=3;notationStaffPaddingTop=5;notationStaffPaddingBottom=5;effectStaffPaddingTop=0;effectStaffPaddingBottom=0;firstStaffPaddingLeft=6;staffPaddingLeft=2;effectBandPaddingBottom=2;systemsLayoutMode=fs.Automatic}class pr{encoding="utf-8";mergePartGroupsInMusicXml=!1;beatTextAsLyrics=!1}!function(t){t[t.Off=0]="Off",t[t.Continuous=1]="Continuous",t[t.OffScreen=2]="OffScreen"}(ps||(ps={}));class br{noteWideLength=240;noteWideAmplitude=1;noteSlightLength=360;noteSlightAmplitude=.5;beatWideLength=480;beatWideAmplitude=2;beatSlightLength=480;beatSlightAmplitude=2}class mr{simpleSlidePitchOffset=6;simpleSlideDurationRatio=.25;shiftSlideDurationRatio=.5}!function(t){t[t.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",t[t.WebAudioScriptProcessor=1]="WebAudioScriptProcessor"}(bs||(bs={})),function(t){t[t.Disabled=0]="Disabled",t[t.EnabledAutomatic=1]="EnabledAutomatic",t[t.EnabledSynthesizer=2]="EnabledSynthesizer",t[t.EnabledBackingTrack=3]="EnabledBackingTrack",t[t.EnabledExternalMedia=4]="EnabledExternalMedia"}(ms||(ms={}));class gr{soundFont=null;scrollElement="html,body";outputMode=bs.WebAudioAudioWorklets;enablePlayer=!1;playerMode=ms.Disabled;enableCursor=!0;enableAnimatedBeatCursor=!0;enableElementHighlighting=!0;enableUserInteraction=!0;scrollOffsetX=0;scrollOffsetY=0;scrollMode=ps.Continuous;scrollSpeed=300;nativeBrowserSmoothScroll=!0;songBookBendDuration=75;songBookDipDuration=150;vibrato=new br;slide=new mr;playTripletFeel=!0;bufferTimeInMilliseconds=500}class wr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>wr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),null!==t.smuflFontSources){const s=new Map;e.set("smuflfontsources",s);for(const[e,i]of t.smuflFontSources)s.set(e.toString(),i)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(t,e,s){switch(e){case"scriptfile":return t.scriptFile=s,!0;case"fontdirectory":return t.fontDirectory=s,!0;case"smuflfontsources":return t.smuflFontSources=new Map,rr.forEach(s,(e,s)=>{t.smuflFontSources.set(rr.parseEnum(s,uh),e)}),!0;case"file":return t.file=s,!0;case"tex":return t.tex=s,!0;case"tracks":return t.tracks=s,!0;case"enablelazyloading":return t.enableLazyLoading=s,!0;case"engine":return t.engine=s,!0;case"loglevel":return t.logLevel=rr.parseEnum(s,_),!0;case"useworkers":return t.useWorkers=s,!0;case"includenotebounds":return t.includeNoteBounds=s,!0}return!1}}class yr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>yr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("topy",t.topY),e.set("bottomy",t.bottomY),e.set("x",t.x),e}static setProperty(t,e,s){switch(e){case"topy":return t.topY=s,!0;case"bottomy":return t.bottomY=s,!0;case"x":return t.x=s,!0}return!1}}class kr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>kr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("musicfontsize",t.musicFontSize),e.set("onestaffspace",t.oneStaffSpace),e.set("tablinespacing",t.tabLineSpacing),e.set("arrowshaftthickness",t.arrowShaftThickness),e.set("barlineseparation",t.barlineSeparation),e.set("beamspacing",t.beamSpacing),e.set("beamthickness",t.beamThickness),e.set("bracketthickness",t.bracketThickness),e.set("dashedbarlinedashlength",t.dashedBarlineDashLength),e.set("dashedbarlinegaplength",t.dashedBarlineGapLength),e.set("dashedbarlinethickness",t.dashedBarlineThickness),e.set("hairpinthickness",t.hairpinThickness),e.set("legerlinethickness",t.legerLineThickness),e.set("legerlineextension",t.legerLineExtension),e.set("octavelinethickness",t.octaveLineThickness),e.set("pedallinethickness",t.pedalLineThickness),e.set("repeatbarlinedotseparation",t.repeatBarlineDotSeparation),e.set("repeatendinglinethickness",t.repeatEndingLineThickness),e.set("slurmidpointthickness",t.slurMidpointThickness),e.set("stafflinethickness",t.staffLineThickness),e.set("stemthickness",t.stemThickness),e.set("thickbarlinethickness",t.thickBarlineThickness),e.set("thinbarlinethickness",t.thinBarlineThickness),e.set("thinthickbarlineseparation",t.thinThickBarlineSeparation),e.set("tiemidpointthickness",t.tieMidpointThickness),e.set("tupletbracketthickness",t.tupletBracketThickness);{const s=new Map;e.set("stemup",s);for(const[e,i]of t.stemUp)s.set(e.toString(),yr.toJson(i))}{const s=new Map;e.set("stemdown",s);for(const[e,i]of t.stemDown)s.set(e.toString(),yr.toJson(i))}{const s=new Map;e.set("repeatoffsetx",s);for(const[e,i]of t.repeatOffsetX)s.set(e.toString(),i)}e.set("standardstemlength",t.standardStemLength);{const s=new Map;e.set("stemflagoffsets",s);for(const[e,i]of t.stemFlagOffsets)s.set(e.toString(),i)}{const s=new Map;e.set("glyphtop",s);for(const[e,i]of t.glyphTop)s.set(e.toString(),i)}{const s=new Map;e.set("glyphbottom",s);for(const[e,i]of t.glyphBottom)s.set(e.toString(),i)}{const s=new Map;e.set("glyphwidths",s);for(const[e,i]of t.glyphWidths)s.set(e.toString(),i)}{const s=new Map;e.set("glyphheights",s);for(const[e,i]of t.glyphHeights)s.set(e.toString(),i)}return e.set("numberedbarrendererbarsize",t.numberedBarRendererBarSize),e.set("numberedbarrendererbarspacing",t.numberedBarRendererBarSpacing),e.set("numbereddashglyphpadding",t.numberedDashGlyphPadding),e.set("numbereddashglyphwidth",t.numberedDashGlyphWidth),e.set("linerangedglyphdashgap",t.lineRangedGlyphDashGap),e.set("linerangedglyphdashsize",t.lineRangedGlyphDashSize),e.set("prenoteeffectpadding",t.preNoteEffectPadding),e.set("postnoteeffectpadding",t.postNoteEffectPadding),e.set("onnoteeffectpadding",t.onNoteEffectPadding),e.set("stringnumbercirclepadding",t.stringNumberCirclePadding),e.set("rowcontainerpadding",t.rowContainerPadding),e.set("rowcontainergap",t.rowContainerGap),e.set("alternateendingspadding",t.alternateEndingsPadding),e.set("sustainpedallinepadding",t.sustainPedalLinePadding),e.set("tieheight",t.tieHeight),e.set("beattimerpadding",t.beatTimerPadding),e.set("bendnoteheadelementpadding",t.bendNoteHeadElementPadding),e.set("ghostparenthesiswidth",t.ghostParenthesisWidth),e.set("ghostparenthesispadding",t.ghostParenthesisPadding),e.set("brokenbeamwidth",t.brokenBeamWidth),e.set("tabwhammytextpadding",t.tabWhammyTextPadding),e.set("tabwhammyperhalfheight",t.tabWhammyPerHalfHeight),e.set("tabwhammydashsize",t.tabWhammyDashSize),e.set("songbookwhammydipheight",t.songBookWhammyDipHeight),e.set("deadslappedlinewidth",t.deadSlappedLineWidth),e.set("lefthandtabtiewidth",t.leftHandTabTieWidth),e.set("tabbenddashsize",t.tabBendDashSize),e.set("tabbendpervalueheight",t.tabBendPerValueHeight),e.set("tabbendlabelpadding",t.tabBendLabelPadding),e.set("simpleslidewidth",t.simpleSlideWidth),e.set("simpleslideheight",t.simpleSlideHeight),e.set("chorddiagrampaddingx",t.chordDiagramPaddingX),e.set("chorddiagrampaddingy",t.chordDiagramPaddingY),e.set("chorddiagramstringspacing",t.chordDiagramStringSpacing),e.set("chorddiagramfretspacing",t.chordDiagramFretSpacing),e.set("chorddiagramnutheight",t.chordDiagramNutHeight),e.set("chorddiagramfretheight",t.chordDiagramFretHeight),e.set("chorddiagramlinewidth",t.chordDiagramLineWidth),e.set("tripletfeelbracketpadding",t.tripletFeelBracketPadding),e.set("accidentalpadding",t.accidentalPadding),e.set("prebeatglyphspacing",t.preBeatGlyphSpacing),e.set("temponotescale",t.tempoNoteScale),e.set("tuningglyphcirclenumberscale",t.tuningGlyphCircleNumberScale),e.set("tuningglyphstringcolumnscale",t.tuningGlyphStringColumnScale),e.set("tuningglyphstringrowpadding",t.tuningGlyphStringRowPadding),e.set("directionsscale",t.directionsScale),e}static setProperty(t,e,s){switch(e){case"musicfontsize":return t.musicFontSize=s,!0;case"onestaffspace":return t.oneStaffSpace=s,!0;case"tablinespacing":return t.tabLineSpacing=s,!0;case"arrowshaftthickness":return t.arrowShaftThickness=s,!0;case"barlineseparation":return t.barlineSeparation=s,!0;case"beamspacing":return t.beamSpacing=s,!0;case"beamthickness":return t.beamThickness=s,!0;case"bracketthickness":return t.bracketThickness=s,!0;case"dashedbarlinedashlength":return t.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return t.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return t.dashedBarlineThickness=s,!0;case"hairpinthickness":return t.hairpinThickness=s,!0;case"legerlinethickness":return t.legerLineThickness=s,!0;case"legerlineextension":return t.legerLineExtension=s,!0;case"octavelinethickness":return t.octaveLineThickness=s,!0;case"pedallinethickness":return t.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return t.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return t.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return t.slurMidpointThickness=s,!0;case"stafflinethickness":return t.staffLineThickness=s,!0;case"stemthickness":return t.stemThickness=s,!0;case"thickbarlinethickness":return t.thickBarlineThickness=s,!0;case"thinbarlinethickness":return t.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return t.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return t.tieMidpointThickness=s,!0;case"tupletbracketthickness":return t.tupletBracketThickness=s,!0;case"stemup":return t.stemUp=new Map,rr.forEach(s,(e,s)=>{const i=new lr;yr.fromJson(i,e),t.stemUp.set(rr.parseEnum(s,rt),i)}),!0;case"stemdown":return t.stemDown=new Map,rr.forEach(s,(e,s)=>{const i=new lr;yr.fromJson(i,e),t.stemDown.set(rr.parseEnum(s,rt),i)}),!0;case"repeatoffsetx":return t.repeatOffsetX=new Map,rr.forEach(s,(e,s)=>{t.repeatOffsetX.set(rr.parseEnum(s,rt),e)}),!0;case"standardstemlength":return t.standardStemLength=s,!0;case"stemflagoffsets":return t.stemFlagOffsets=new Map,rr.forEach(s,(e,s)=>{t.stemFlagOffsets.set(rr.parseEnum(s,c),e)}),!0;case"glyphtop":return t.glyphTop=new Map,rr.forEach(s,(e,s)=>{t.glyphTop.set(rr.parseEnum(s,rt),e)}),!0;case"glyphbottom":return t.glyphBottom=new Map,rr.forEach(s,(e,s)=>{t.glyphBottom.set(rr.parseEnum(s,rt),e)}),!0;case"glyphwidths":return t.glyphWidths=new Map,rr.forEach(s,(e,s)=>{t.glyphWidths.set(rr.parseEnum(s,rt),e)}),!0;case"glyphheights":return t.glyphHeights=new Map,rr.forEach(s,(e,s)=>{t.glyphHeights.set(rr.parseEnum(s,rt),e)}),!0;case"numberedbarrendererbarsize":return t.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return t.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return t.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return t.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return t.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return t.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return t.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return t.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return t.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return t.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return t.rowContainerPadding=s,!0;case"rowcontainergap":return t.rowContainerGap=s,!0;case"alternateendingspadding":return t.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return t.sustainPedalLinePadding=s,!0;case"tieheight":return t.tieHeight=s,!0;case"beattimerpadding":return t.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return t.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return t.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return t.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return t.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return t.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return t.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return t.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return t.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return t.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return t.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return t.tabBendDashSize=s,!0;case"tabbendpervalueheight":return t.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return t.tabBendLabelPadding=s,!0;case"simpleslidewidth":return t.simpleSlideWidth=s,!0;case"simpleslideheight":return t.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return t.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return t.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return t.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return t.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return t.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return t.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return t.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return t.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return t.accidentalPadding=s,!0;case"prebeatglyphspacing":return t.preBeatGlyphSpacing=s,!0;case"temponotescale":return t.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return t.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return t.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return t.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return t.directionsScale=s,!0}return!1}}class Sr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Sr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("smuflfontfamilyname",t.smuflFontFamilyName),e.set("engravingsettings",kr.toJson(t.engravingSettings)),e.set("copyrightfont",or.toJson(t.copyrightFont)),e.set("titlefont",or.toJson(t.titleFont)),e.set("subtitlefont",or.toJson(t.subTitleFont)),e.set("wordsfont",or.toJson(t.wordsFont)),e.set("effectfont",or.toJson(t.effectFont)),e.set("timerfont",or.toJson(t.timerFont)),e.set("directionsfont",or.toJson(t.directionsFont)),e.set("fretboardnumberfont",or.toJson(t.fretboardNumberFont)),e.set("numberednotationfont",or.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",or.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",or.toJson(t.tablatureFont)),e.set("gracefont",or.toJson(t.graceFont)),e.set("stafflinecolor",pe.toJson(t.staffLineColor)),e.set("barseparatorcolor",pe.toJson(t.barSeparatorColor)),e.set("barnumberfont",or.toJson(t.barNumberFont)),e.set("barnumbercolor",pe.toJson(t.barNumberColor)),e.set("fingeringfont",or.toJson(t.fingeringFont)),e.set("inlinefingeringfont",or.toJson(t.inlineFingeringFont)),e.set("markerfont",or.toJson(t.markerFont)),e.set("mainglyphcolor",pe.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",pe.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",pe.toJson(t.scoreInfoColor)),e}static setProperty(t,e,s){switch(e){case"smuflfontfamilyname":return t.smuflFontFamilyName=s,!0;case"copyrightfont":return t.copyrightFont=or.fromJson(s),!0;case"titlefont":return t.titleFont=or.fromJson(s),!0;case"subtitlefont":return t.subTitleFont=or.fromJson(s),!0;case"wordsfont":return t.wordsFont=or.fromJson(s),!0;case"effectfont":return t.effectFont=or.fromJson(s),!0;case"timerfont":return t.timerFont=or.fromJson(s),!0;case"directionsfont":return t.directionsFont=or.fromJson(s),!0;case"fretboardnumberfont":return t.fretboardNumberFont=or.fromJson(s),!0;case"numberednotationfont":return t.numberedNotationFont=or.fromJson(s),!0;case"numberednotationgracefont":return t.numberedNotationGraceFont=or.fromJson(s),!0;case"tablaturefont":return t.tablatureFont=or.fromJson(s),!0;case"gracefont":return t.graceFont=or.fromJson(s),!0;case"stafflinecolor":return t.staffLineColor=pe.fromJson(s),!0;case"barseparatorcolor":return t.barSeparatorColor=pe.fromJson(s),!0;case"barnumberfont":return t.barNumberFont=or.fromJson(s),!0;case"barnumbercolor":return t.barNumberColor=pe.fromJson(s),!0;case"fingeringfont":return t.fingeringFont=or.fromJson(s),!0;case"inlinefingeringfont":return t.inlineFingeringFont=or.fromJson(s),!0;case"markerfont":return t.markerFont=or.fromJson(s),!0;case"mainglyphcolor":return t.mainGlyphColor=pe.fromJson(s),!0;case"secondaryglyphcolor":return t.secondaryGlyphColor=pe.fromJson(s),!0;case"scoreinfocolor":return t.scoreInfoColor=pe.fromJson(s),!0}return["engravingsettings"].indexOf(e)>=0&&(kr.fromJson(t.engravingSettings,s),!0)}}class Br{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Br.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",Sr.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("effectbandpaddingbottom",t.effectBandPaddingBottom),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(t,e,s){switch(e){case"scale":return t.scale=s,!0;case"stretchforce":return t.stretchForce=s,!0;case"layoutmode":return t.layoutMode=rr.parseEnum(s,Ft),!0;case"staveprofile":return t.staveProfile=rr.parseEnum(s,ds),!0;case"barsperrow":return t.barsPerRow=s,!0;case"startbar":return t.startBar=s,!0;case"barcount":return t.barCount=s,!0;case"barcountperpartial":return t.barCountPerPartial=s,!0;case"justifylastsystem":return t.justifyLastSystem=s,!0;case"padding":return t.padding=s,!0;case"firstsystempaddingtop":return t.firstSystemPaddingTop=s,!0;case"systempaddingtop":return t.systemPaddingTop=s,!0;case"systempaddingbottom":return t.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return t.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return t.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return t.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return t.accoladeBarPaddingRight=s,!0;case"notationstaffpaddingtop":return t.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return t.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return t.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return t.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return t.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return t.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return t.effectBandPaddingBottom=s,!0;case"systemslayoutmode":return t.systemsLayoutMode=rr.parseEnum(s,fs),!0}if(["resources"].indexOf(e)>=0)return Sr.fromJson(t.resources,s),!0;for(const i of["resources"])if(0===e.indexOf(i)&&Sr.setProperty(t.resources,e.substring(i.length),s))return!0;return!1}}class _r{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>_r.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[e,i]of t.elements)s.set(e.toString(),i)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(t,e,s){switch(e){case"notationmode":return t.notationMode=rr.parseEnum(s,S),!0;case"fingeringmode":return t.fingeringMode=rr.parseEnum(s,k),!0;case"elements":return t.elements=new Map,rr.forEach(s,(e,s)=>{t.elements.set(rr.parseEnum(s,B),e)}),!0;case"rhythmmode":return t.rhythmMode=rr.parseEnum(s,y),!0;case"rhythmheight":return t.rhythmHeight=s,!0;case"transpositionpitches":return t.transpositionPitches=s,!0;case"displaytranspositionpitches":return t.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return t.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return t.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return t.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return t.slurHeight=s,!0}return!1}}class xr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>xr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class Tr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Tr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class Mr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Mr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}class vr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>vr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",Tr.toJson(t.vibrato)),e.set("slide",Mr.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(t,e,s){switch(e){case"soundfont":return t.soundFont=s,!0;case"scrollelement":return t.scrollElement=s,!0;case"outputmode":return t.outputMode=rr.parseEnum(s,bs),!0;case"enableplayer":return t.enablePlayer=s,!0;case"playermode":return t.playerMode=rr.parseEnum(s,ms),!0;case"enablecursor":return t.enableCursor=s,!0;case"enableanimatedbeatcursor":return t.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return t.enableElementHighlighting=s,!0;case"enableuserinteraction":return t.enableUserInteraction=s,!0;case"scrolloffsetx":return t.scrollOffsetX=s,!0;case"scrolloffsety":return t.scrollOffsetY=s,!0;case"scrollmode":return t.scrollMode=rr.parseEnum(s,ps),!0;case"scrollspeed":return t.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return t.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return t.songBookBendDuration=s,!0;case"songbookdipduration":return t.songBookDipDuration=s,!0;case"playtripletfeel":return t.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return t.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(e)>=0)return Tr.fromJson(t.vibrato,s),!0;for(const i of["vibrato"])if(0===e.indexOf(i)&&Tr.setProperty(t.vibrato,e.substring(i.length),s))return!0;if(["slide"].indexOf(e)>=0)return Mr.fromJson(t.slide,s),!0;for(const i of["slide"])if(0===e.indexOf(i)&&Mr.setProperty(t.slide,e.substring(i.length),s))return!0;return!1}}class Nr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Nr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("indent",t.indent),e.set("comments",t.comments),e}static setProperty(t,e,s){switch(e){case"indent":return t.indent=s,!0;case"comments":return t.comments=s,!0}return!1}}class Pr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Pr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",wr.toJson(t.core)),e.set("display",Br.toJson(t.display)),e.set("notation",_r.toJson(t.notation)),e.set("importer",xr.toJson(t.importer)),e.set("player",vr.toJson(t.player)),e.set("exporter",Nr.toJson(t.exporter)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return wr.fromJson(t.core,s),!0;for(const i of["core",""])if(0===e.indexOf(i)&&wr.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return Br.fromJson(t.display,s),!0;for(const i of["display",""])if(0===e.indexOf(i)&&Br.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return _r.fromJson(t.notation,s),!0;for(const i of["notation"])if(0===e.indexOf(i)&&_r.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return xr.fromJson(t.importer,s),!0;for(const i of["importer"])if(0===e.indexOf(i)&&xr.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return vr.fromJson(t.player,s),!0;for(const i of["player"])if(0===e.indexOf(i)&&vr.setProperty(t.player,e.substring(i.length),s))return!0;if(["exporter"].indexOf(e)>=0)return Nr.fromJson(t.exporter,s),!0;for(const i of["exporter"])if(0===e.indexOf(i)&&Nr.setProperty(t.exporter,e.substring(i.length),s))return!0;return!1}}class Er{indent=2;comments=!1}class Fr{core=new eu;display=new fr;notation=new V;importer=new pr;player=new gr;exporter=new Er;setSongBookModeSettings(){this.notation.notationMode=S.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=k.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(B.ParenthesisOnTiedBends,!1),this.notation.elements.set(B.TabNotesOnTiedBends,!1),this.notation.elements.set(B.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new Fr;return t.setSongBookModeSettings(),t}fillFromJson(t){Pr.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===ms.Disabled&&this.player.enablePlayer&&(this.player.playerMode=ms.EnabledAutomatic)}}class Cr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Cr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class Ar{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class Dr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Dr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",Ar.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e.set("isvisible",t.isVisible),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=rr.parseEnum(s,n),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new I,Ar.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0;case"isvisible":return t.isVisible=s,!0}return!1}}class Lr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Lr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=rr.parseEnum(s,Nt),!0;case"length":return t.length=s,!0}return!1}}class Wr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Wr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",Cr.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(t=>Dr.toJson(t))),void 0!==t.syncPoints&&e.set("syncpoints",t.syncPoints?.map(t=>Dr.toJson(t))),null!==t.fermata){const s=new Map;e.set("fermata",s);for(const[e,i]of t.fermata)s.set(e.toString(),Lr.toJson(i))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),null!==t.directions){const s=[];e.set("directions",s);for(const e of t.directions)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=rr.parseEnum(s,nt),!0;case"section":return s?(t.section=new ge,Cr.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const e of s){const s=new G;Dr.fromJson(s,e),t.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const e of s){const s=new G;Dr.fromJson(s,e),t.addSyncPoint(s)}}return!0;case"fermata":return t.fermata=new Map,rr.forEach(s,(e,s)=>{const i=new be;Lr.fromJson(i,e),t.addFermata(Number.parseInt(s),i)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const e of s)t.addDirection(rr.parseEnum(e,Ke));return!0}return!1}}class Or{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Or.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class Rr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Rr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=rr.parseEnum(s,rt),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,lt),pe.fromJson(e))}),!0}return!1}}class Ir{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Ir.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),null!==t.bendPoints&&e.set("bendpoints",t.bendPoints?.map(t=>Or.toJson(t))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",Rr.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=rr.parseEnum(s,u),!0;case"bendtype":return t.bendType=rr.parseEnum(s,a),!0;case"bendstyle":return t.bendStyle=rr.parseEnum(s,r),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const e of s){const s=new $;Or.fromJson(s,e),t.addBendPoint(s)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=rr.parseEnum(s,f),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=rr.parseEnum(s,m),!0;case"slideouttype":return t.slideOutType=rr.parseEnum(s,g),!0;case"vibrato":return t.vibrato=rr.parseEnum(s,w),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=rr.parseEnum(s,d),!0;case"righthandfinger":return t.rightHandFinger=rr.parseEnum(s,d),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=rr.parseEnum(s,c),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=rr.parseEnum(s,p),!0;case"dynamics":return t.dynamics=rr.parseEnum(s,i),!0;case"ornament":return t.ornament=rr.parseEnum(s,ct),!0;case"style":return s?(t.style=new jt,Rr.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class Gr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Gr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,wt),pe.fromJson(e))}),!0)}}class $r{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>$r.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(t=>Ir.toJson(t))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(t=>Dr.toJson(t))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),null!==t.whammyBarPoints&&e.set("whammybarpoints",t.whammyBarPoints?.map(t=>Or.toJson(t))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),e.set("tremolospeed",t.tremoloSpeed),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",Gr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const e of s){const s=new Xt;Ir.fromJson(s,e),t.addNote(s)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=rr.parseEnum(s,r),!0;case"ottava":return t.ottava=rr.parseEnum(s,b),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=rr.parseEnum(s,c),!0;case"automations":t.automations=[];for(const e of s){const s=new G;Dr.fromJson(s,e),t.automations.push(s)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=rr.parseEnum(s,ft),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=rr.parseEnum(s,h),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=rr.parseEnum(s,ut),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const e of s){const s=new $;Or.fromJson(s,e),t.addWhammyBarPoint(s)}}return!0;case"vibrato":return t.vibrato=rr.parseEnum(s,w),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=rr.parseEnum(s,l),!0;case"pickstroke":return t.pickStroke=rr.parseEnum(s,ht),!0;case"tremolospeed":return t.tremoloSpeed=rr.parseEnum(s,c)??null,!0;case"crescendo":return t.crescendo=rr.parseEnum(s,o),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=rr.parseEnum(s,dt),!0;case"dynamics":return t.dynamics=rr.parseEnum(s,i),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=rr.parseEnum(s,Ct)??null,!0;case"beamingmode":return t.beamingMode=rr.parseEnum(s,gt),!0;case"wahpedal":return t.wahPedal=rr.parseEnum(s,pt),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=rr.parseEnum(s,bt),!0;case"rasgueado":return t.rasgueado=rr.parseEnum(s,mt),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new qt,Gr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Vr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Vr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,L),pe.fromJson(e))}),!0)}}class Hr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Hr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(t=>$r.toJson(t))),t.style&&e.set("style",Vr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const e of s){const s=new Yt;$r.fromJson(s,e),t.addBeat(s)}return!0;case"style":return s?(t.style=new Z,Vr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Ur{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Ur.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=rr.parseEnum(s,C),!0}return!1}}class zr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>zr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,A),pe.fromJson(e))}),!0)}}class jr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>jr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(t=>Hr.toJson(t))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(t=>Ur.toJson(t))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),t.style&&e.set("style",zr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=rr.parseEnum(s,N),!0;case"clefottava":return t.clefOttava=rr.parseEnum(s,b),!0;case"voices":t.voices=[];for(const e of s){const s=new tt;Hr.fromJson(s,e),t.addVoice(s)}return!0;case"similemark":return t.simileMark=rr.parseEnum(s,P),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const e of s){const s=new q;Ur.fromJson(s,e),t.sustainPedals.push(s)}return!0;case"barlineleft":return t.barLineLeft=rr.parseEnum(s,D),!0;case"barlineright":return t.barLineRight=rr.parseEnum(s,D),!0;case"keysignature":return t.keySignature=rr.parseEnum(s,E),!0;case"keysignaturetype":return t.keySignatureType=rr.parseEnum(s,F),!0;case"style":return s?(t.style=new Y,zr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Xr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Xr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class Jr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Jr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class qr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>qr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(t=>jr.toJson(t))),null!==t.chords){const s=new Map;e.set("chords",s);for(const[e,i]of t.chords)s.set(e.toString(),Xr.toJson(i))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",Jr.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const e of s){const s=new K;jr.fromJson(s,e),t.addBar(s)}return!0;case"chords":return t.chords=new Map,rr.forEach(s,(e,s)=>{const i=new de;Xr.fromJson(i,e),t.addChord(s,i)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return Jr.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class Yr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Yr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("bank",t.bank),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"bank":return t.bank=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class Kr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Kr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=rr.parseEnum(s,rt),!0;case"noteheadhalf":return t.noteHeadHalf=rr.parseEnum(s,rt),!0;case"noteheadwhole":return t.noteHeadWhole=rr.parseEnum(s,rt),!0;case"techniquesymbol":return t.techniqueSymbol=rr.parseEnum(s,rt),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=rr.parseEnum(s,ot),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class Qr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Qr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,Et),pe.fromJson(e))}),!0)}}class Zr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Zr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(t=>qr.toJson(t))),e.set("playbackinfo",Yr.toJson(t.playbackInfo)),e.set("color",pe.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),void 0!==t.lineBreaks){const s=[];e.set("linebreaks",s);for(const e of t.lineBreaks)s.push(e)}return e.set("percussionarticulations",t.percussionArticulations.map(t=>Kr.toJson(t))),t.style&&e.set("style",Qr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const e of s){const s=new ye;qr.fromJson(s,e),t.addStaff(s)}return!0;case"playbackinfo":return Yr.fromJson(t.playbackInfo,s),!0;case"color":return t.color=pe.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const e of s)t.addLineBreaks(e);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const e of s){const s=new Ht;Kr.fromJson(s,e),t.percussionArticulations.push(s)}return!0;case"style":return s?(t.style=new Se,Qr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class ta{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ta.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),null!==t.perTrackDisplayTuning){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[e,i]of t.perTrackDisplayTuning)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),null!==t.perTrackChordDiagramsOnTop){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[e,i]of t.perTrackChordDiagramsOnTop)s.set(e.toString(),i)}if(e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),null!==t.perTrackMultiBarRest){const s=[];e.set("pertrackmultibarrest",s);for(const e of t.perTrackMultiBarRest)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=rr.parseEnum(s,x),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,rr.forEach(s,(e,s)=>{t.perTrackDisplayTuning.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,rr.forEach(s,(e,s)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(s),e)}),!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=rr.parseEnum(s,T),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=rr.parseEnum(s,T),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=rr.parseEnum(s,M),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=rr.parseEnum(s,M),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=rr.parseEnum(s,v),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=rr.parseEnum(s,v),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0}return!1}}class ea{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ea.setProperty(t,s,e))}static toJson(t){if(!t)return null;return new Map}static setProperty(t,e,s){return!1}}class sa{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>sa.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=rr.parseEnum(s,et),!0}return!1}}class ia{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ia.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[e,i]of t.headerAndFooter)s.set(e.toString(),sa.toJson(i))}{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),pe.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,rr.forEach(s,(e,s)=>{const i=new Lt;sa.fromJson(i,e),t.headerAndFooter.set(rr.parseEnum(s,it),i)}),!0;case"colors":return t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,it),pe.fromJson(e))}),!0}return!1}}class na{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>na.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("masterbars",t.masterBars.map(t=>Wr.toJson(t))),e.set("tracks",t.tracks.map(t=>Zr.toJson(t))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",ta.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",ea.toJson(t.backingTrack)),t.style&&e.set("style",ia.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"masterbars":t.masterBars=[];for(const e of s){const s=new Rt;Wr.fromJson(s,e),t.addMasterBar(s)}return!0;case"tracks":t.tracks=[];for(const e of s){const s=new Be;Zr.fromJson(s,e),t.addTrack(s)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return ta.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new qs,ea.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new Wt,ia.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class ra{static Zf(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const t={};for(const[s,i]of e)t[s]=i;return t}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=ra.scoreToJsObject(t);return JSON.stringify(e,ra.Zf)}static jsonToScore(t,e){return ra.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return na.toJson(t)}static jsObjectToScore(t,e){const s=new Ot;return na.fromJson(s,t),s.finish(e??new Fr),s}static settingsToJson(t){const e=ra.settingsToJsObject(t);return JSON.stringify(e,ra.Zf)}static jsonToSettings(t){return ra.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return Pr.toJson(t)}static jsObjectToSettings(t){const e=new Fr;return Pr.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new Ti;return rr.forEach(t,(t,s)=>{switch(s){case"division":e.division=t;break;case"tracks":for(const s of t){const t=ra.tp(s);e.tracks.push(t)}}}),e}static tp(t){const e=new xi;return rr.forEach(t,(t,s)=>{if("events"===s)for(const s of t){const t=ra.jsObjectToMidiEvent(s);e.events.push(t)}}),e}static jsObjectToMidiEvent(t){const e=rr.getValue(t,"track"),i=rr.getValue(t,"tick"),n=rr.getValue(t,"type");switch(n){case es.TimeSignature:return new vi(e,i,rr.getValue(t,"numerator"),rr.getValue(t,"denominatorIndex"),rr.getValue(t,"midiClocksPerMetronomeClick"),rr.getValue(t,"thirdySecondNodesInQuarter"));case es.AlphaTabRest:return new Ei(e,i,rr.getValue(t,"channel"));case es.AlphaTabMetronome:return new Pi(e,i,rr.getValue(t,"metronomeNumerator"),rr.getValue(t,"metronomeDurationInTicks"),rr.getValue(t,"metronomeDurationInMilliseconds"));case es.NoteOn:return new Ci(e,i,rr.getValue(t,"channel"),rr.getValue(t,"noteKey"),rr.getValue(t,"noteVelocity"));case es.NoteOff:return new Ai(e,i,rr.getValue(t,"channel"),rr.getValue(t,"noteKey"),rr.getValue(t,"noteVelocity"));case es.ControlChange:return new Di(e,i,rr.getValue(t,"channel"),rr.getValue(t,"controller"),rr.getValue(t,"value"));case es.ProgramChange:return new Li(e,i,rr.getValue(t,"channel"),rr.getValue(t,"program"));case es.TempoChange:const s=new Wi(i,0);return s.beatsPerMinute=rr.getValue(t,"beatsPerMinute"),s;case es.PitchBend:return new Oi(e,i,rr.getValue(t,"channel"),rr.getValue(t,"value"));case es.PerNotePitchBend:return new Ri(e,i,rr.getValue(t,"channel"),rr.getValue(t,"noteKey"),rr.getValue(t,"value"));case es.EndOfTrack:return new Ii(e,i)}throw new W(s.Format,`Unknown Midi Event type: ${n}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division);const s=[];for(const e of t.tracks)s.push(ra.ep(e));return e.set("tracks",s),e}static ep(t){const e=new Map,s=[];for(const e of t.events)s.push(ra.midiEventToJsObject(e));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case es.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case es.AlphaTabRest:e.set("channel",t.channel);break;case es.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case es.NoteOn:case es.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case es.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case es.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case es.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case es.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case es.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value);case es.EndOfTrack:}return e}}class aa{sp;ip;np=new Map;constructor(t,e){this.ip=t,this.ip.addEventListener("message",this.handleMessage.bind(this)),this.sp=new ir(new wi,e),this.sp.positionChanged.on(this.onPositionChanged.bind(this)),this.sp.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.sp.finished.on(this.onFinished.bind(this)),this.sp.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.sp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.sp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.sp.midiLoaded.on(this.onMidiLoaded.bind(this)),this.sp.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this.sp.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this.sp.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.sp.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.ip.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=tu.globalThis;t.addEventListener("message",e=>{const s=e.data;if("alphaSynth.initialize"===s.cmd)wi.preferredSampleRate=s.sampleRate,z.logLevel=s.logLevel,tu.globalThis.alphaSynthWebWorker=new aa(t,s.bufferTimeInMilliseconds)})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":z.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this.sp.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this.sp.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this.sp.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this.sp.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this.sp.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this.sp.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this.sp.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this.sp.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this.sp.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this.sp.play();break;case"alphaSynth.pause":this.sp.pause();break;case"alphaSynth.playPause":this.sp.playPause();break;case"alphaSynth.stop":this.sp.stop();break;case"alphaSynth.playOneTimeMidiFile":this.sp.playOneTimeMidiFile(ra.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this.sp.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this.sp.resetSoundFonts();break;case"alphaSynth.loadMidi":this.sp.loadMidiFile(ra.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this.sp.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this.sp.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this.sp.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this.sp.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this.sp.resetChannelStates();break;case"alphaSynth.destroy":this.sp.destroy(),this.ip.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this.sp.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.rp(t)}rp(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const t=this.sp.exportAudio(e.options,ra.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this.np.set(e.exporterId,t),this.ip.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this.np.has(e.exporterId)){const t=this.np.get(e.exporterId).render(e.milliseconds);this.ip.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:t})}else this.ip.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this.np.delete(e.exporterId)}}catch(t){this.ip.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:t})}}onPositionChanged(t){this.ip.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this.ip.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this.ip.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this.ip.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this.ip.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.ap(tu.prepareForPostMessage(t))})}ap(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this.ip.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this.ip.postMessage({cmd:"alphaSynth.midiLoaded",error:this.ap(tu.prepareForPostMessage(t))})}onReadyForPlayback(){this.ip.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this.ip.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(ra.midiEventToJsObject)})}onPlaybackRangeChanged(t){this.ip.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}!function(t){t[t.Browser=0]="Browser",t[t.NodeJs=1]="NodeJs",t[t.BrowserModule=2]="BrowserModule"}(gs||(gs={}));class ha{characterWidths;characterHeights;constructor(t,e){this.characterWidths=t,this.characterHeights=e}}class oa{static fontSizeLookupTables=new Map;static ControlChars=32;static generateFontLookup(t){if(!oa.fontSizeLookupTables.has(t))if(tu.isRunningInWorker||tu.webPlatform===gs.NodeJs){const e=new ha(new Uint8Array([8]),new Uint8Array([10]));oa.fontSizeLookupTables.set(t,e)}else{const e=document.createElement("canvas").getContext("2d"),s=11;e.font=`${s}px ${t}`;const i=[],n=[];for(let t=oa.ControlChars;t<255;t++){const s=String.fromCharCode(t),r=e.measureText(s);i.push(r.width);const a=r.actualBoundingBoxDescent+r.actualBoundingBoxAscent;n.push(a)}const r=new ha(new Uint8Array(i),new Uint8Array(n));oa.fontSizeLookupTables.set(t,r)}}static measureString(t,e,s,i,n){let r;let a=e[0];for(let t=0;t<e.length;t++)if(oa.fontSizeLookupTables.has(e[t])){a=e[t];break}oa.fontSizeLookupTables.has(a)||oa.generateFontLookup(a),r=oa.fontSizeLookupTables.get(a);let h=1;i===ls.Italic&&(h*=1.1),n===us.Bold&&(h*=1.1);let o=0,c=0;for(let e=0;e<t.length;e++){const i=Math.min(r.characterWidths.length-1,t.charCodeAt(e)-oa.ControlChars);i>=0&&(o+=r.characterWidths[i]*s/11,c=Math.max(c,r.characterHeights[i]*s/11))}return h*=1.07,new At(o*h,c)}}class ca{hp;ip;constructor(t){this.ip=t,this.ip.addEventListener("message",this.ul.bind(this),!1)}static init(){tu.globalThis.alphaTabWebWorker=new ca(tu.globalThis)}ul(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const t=ra.jsObjectToSettings(e.settings);z.logLevel=t.core.logLevel,this.hp=new Ae(t),this.hp.partialRenderFinished.on(t=>{this.ip.postMessage({cmd:"alphaTab.partialRenderFinished",result:t})}),this.hp.partialLayoutFinished.on(t=>{this.ip.postMessage({cmd:"alphaTab.partialLayoutFinished",result:t})}),this.hp.renderFinished.on(t=>{this.ip.postMessage({cmd:"alphaTab.renderFinished",result:t})}),this.hp.postRenderFinished.on(()=>{this.ip.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this.hp.boundsLookup?.toJson()??null})}),this.hp.preRender.on(t=>{this.ip.postMessage({cmd:"alphaTab.preRender",resize:t})}),this.hp.error.on(this.op.bind(this));break;case"alphaTab.invalidate":this.hp.render();break;case"alphaTab.resizeRender":this.hp.resizeRender();break;case"alphaTab.renderResult":this.hp.renderResult(e.resultId);break;case"alphaTab.setWidth":this.hp.width=e.width;break;case"alphaTab.renderScore":this.cp(e.fontSizes);const s=null==e.score?null:ra.jsObjectToScore(e.score,this.hp.settings);this.lp(s,e.trackIndexes);break;case"alphaTab.updateSettings":this.dp(e.settings)}}cp(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t)for(const[e,s]of t)oa.fontSizeLookupTables.set(e,s)}dp(t){Pr.fromJson(this.hp.settings,t)}lp(t,e){try{this.hp.renderScore(t,e)}catch(t){this.op(t)}}op(t){z.error("Worker","An unexpected error occurred in worker",t),this.ip.postMessage({cmd:"alphaTab.error",error:t})}}class la{fp;pp;bp=null;mp;gp=new pe(0,0,0,255);wp=new or("Arial",10,ls.Plain);yp;kp=0;settings;constructor(){this.fp=document.createElement("canvas"),this.fp.width=10,this.fp.height=10,this.fp.style.width="10px",this.fp.style.height="10px",this.pp=this.fp.getContext("2d"),this.pp.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this.yp=new or(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,ls.Plain,us.Regular);const s=this.settings.display.scale;this.bp=document.createElement("canvas"),this.bp.width=t*tu.highDpiFactor|0,this.bp.height=e*tu.highDpiFactor|0,this.bp.style.width=`${t}px`,this.bp.style.height=`${e}px`,this.mp=this.bp.getContext("2d"),this.mp.textBaseline="hanging",this.mp.scale(tu.highDpiFactor*s,tu.highDpiFactor*s),this.mp.lineWidth=this.kp}endRender(){const t=this.bp;return this.bp=null,t}get color(){return this.gp}set color(t){this.gp.rgba!==t.rgba&&(this.gp=t,this.mp.strokeStyle=t.rgba,this.mp.fillStyle=t.rgba)}get lineWidth(){return this.kp}set lineWidth(t){this.kp=t,this.mp&&(this.mp.lineWidth=t)}fillRect(t,e,s,i){s>0&&this.mp.fillRect(t,e,s,i)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.mp.strokeRect(t+n,e+n,s,i)}beginPath(){this.mp.beginPath()}closePath(){this.mp.closePath()}moveTo(t,e){this.mp.moveTo(t,e)}lineTo(t,e){this.mp.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this.mp.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,n,r){this.mp.bezierCurveTo(t,e,s,i,n,r)}fillCircle(t,e,s){this.mp.beginPath(),this.mp.arc(t,e,s,0,2*Math.PI,!0),this.fill()}strokeCircle(t,e,s){this.mp.beginPath(),this.mp.arc(t,e,s,0,2*Math.PI,!0),this.stroke()}fill(){this.mp.fill(),this.mp.beginPath()}stroke(){this.mp.stroke(),this.mp.beginPath()}get font(){return this.wp}set font(t){this.wp=t,this.mp&&(this.mp.font=t.toCssString(1)),this.pp.font=t.toCssString(1)}get textAlign(){switch(this.mp.textAlign){case"left":default:return et.Left;case"center":return et.Center;case"right":return et.Right}}set textAlign(t){switch(t){case et.Left:this.mp.textAlign="left";break;case et.Center:this.mp.textAlign="center";break;case et.Right:this.mp.textAlign="right"}}get textBaseline(){switch(this.mp.textBaseline){case"hanging":default:return st.Top;case"middle":return st.Middle;case"bottom":return st.Bottom;case"alphabetic":return st.Alphabetic}}set textBaseline(t){switch(t){case st.Top:this.mp.textBaseline="hanging";break;case st.Middle:this.mp.textBaseline="middle";break;case st.Bottom:this.mp.textBaseline="bottom";break;case st.Alphabetic:this.mp.textBaseline="alphabetic"}}beginGroup(t){}endGroup(){}fillText(t,e,s){this.mp.fillText(t,e,s)}measureText(t){const e=this.pp.measureText(t);return new At(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,n=!1){i!==rt.None&&this.Sp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n=!1){let r="";for(const t of i)t!==rt.None&&(r+=String.fromCharCode(t));this.Sp(t,e,s,r,n)}Sp(t,e,s,i,n){const r=this.mp.textAlign,a=this.mp.textBaseline,h=this.mp.font;this.mp.font=this.yp.toCssString(s),this.mp.textBaseline="alphabetic",this.mp.textAlign=n?"center":"left",this.mp.fillText(i,t,e),this.mp.textBaseline=a,this.mp.font=h,this.mp.textAlign=r}beginRotate(t,e,s){this.mp.save(),this.mp.translate(t,e),this.mp.rotate(s*Math.PI/180)}endRotate(){this.mp.restore()}}class ua{Bp;_p;constructor(t,e=!1){this.Bp=t,this._p=e}addTimeSignature(t,e,s){let i=0,n=s;for(;n>>=1,n>0;)i++;this.Bp.addEvent(new vi(0,t,e,i,48,8))}addRest(t,e,s){this._p||this.Bp.addEvent(new Ei(t,e,s))}addNote(t,e,s,i,n,r){this.Bp.addEvent(new Ci(t,e,r,ua.xp(i),ua.xp(n))),this.Bp.addEvent(new Ai(t,e+s,r,ua.xp(i),ua.xp(n)))}static xp(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,n){this.Bp.addEvent(new Di(t,e,s,i,ua.xp(n)))}addProgramChange(t,e,s,i){this.Bp.addEvent(new Li(t,e,s,i))}addTempo(t,e){const s=new Wi(t,0);s.beatsPerMinute=e,this.Bp.addEvent(s)}addBend(t,e,s,i){i=i>=It.MaxPitchWheel?It.MaxPitchWheel:Math.floor(i),this.Bp.addEvent(new Oi(t,e,s,i))}addNoteBend(t,e,s,i,n){this._p?this.addBend(t,e,s,n):(n=n*It.MaxPitchWheel20/It.MaxPitchWheel,this.Bp.addEvent(new Ri(t,e,s,i,n)))}finishTrack(t,e){this.Bp.format!==ts.MultiTrack&&0!==t||this.Bp.addEvent(new Ii(t,e))}}class da{group;opening;iterations;closingIndex=0;constructor(t,e){this.group=t,this.opening=e,t.closings=t.closings.sort((t,e)=>t.index-e.index),this.iterations=t.closings.map(t=>0)}}!function(t){t[t.PlayingNormally=0]="PlayingNormally",t[t.DirectionJumped=1]="DirectionJumped",t[t.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",t[t.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",t[t.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"}(ws||(ws={}));class fa{ue;Tp=[];Mp=new Set;vp=0;oi=ws.PlayingNormally;shouldPlay=!0;index=0;currentTick=0;get finished(){return this.index>=this.ue.masterBars.length}constructor(t){this.ue=t}processCurrent(){const t=this.ue.masterBars[this.index];if(this.oi===ws.PlayingNormally){let e=t.alternateEndings;if(0===e&&(e=this.vp),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this.Mp.has(t.repeatGroup)){const s=new da(t.repeatGroup,t);this.Tp.push(s),this.Mp.add(t.repeatGroup),this.vp=0,e=t.alternateEndings}if(0===this.Tp.length||0===e)this.shouldPlay=!0;else{const t=this.Tp[this.Tp.length-1],s=t.iterations[t.closingIndex];this.vp=e,this.shouldPlay=!!(e&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this.Np()||this.Pp()}Ep(){this.Mp.clear(),this.vp=0,this.Tp=[]}Fp(t,e,s){return!!t.has(e)&&(this.index=0,this.oi=s,this.Ep(),!0)}Cp(t,e,s,i){if(t.has(e)){const t=this.Ap(i,this.index,!0);return-1!==t&&(this.index=t,this.oi=s,this.Ep(),!0)}return!1}Dp(t,e,s){if(t.has(e)){const t=this.Ap(s,this.index,!1);return-1===t?(this.index++,!0):(this.index=t,this.oi=ws.PlayingNormally,!0)}return!1}Np(){const t=this.ue.masterBars[this.index],e=null!==t.directions&&t.directions.size>0;if(this.oi===ws.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this.oi){case ws.PlayingNormally:return!!(this.Fp(t.directions,Ke.JumpDaCapo,ws.DirectionJumped)||this.Fp(t.directions,Ke.JumpDaCapoAlCoda,ws.DirectionJumpedAlCoda)||this.Fp(t.directions,Ke.JumpDaCapoAlDoubleCoda,ws.DirectionJumpedAlDoubleCoda)||this.Fp(t.directions,Ke.JumpDaCapoAlFine,ws.DirectionJumpedAlFine))||(!!(this.Cp(t.directions,Ke.JumpDalSegno,ws.DirectionJumped,Ke.TargetSegno)||this.Cp(t.directions,Ke.JumpDalSegnoAlCoda,ws.DirectionJumpedAlCoda,Ke.TargetSegno)||this.Cp(t.directions,Ke.JumpDalSegnoAlDoubleCoda,ws.DirectionJumpedAlDoubleCoda,Ke.TargetSegno)||this.Cp(t.directions,Ke.JumpDalSegnoAlFine,ws.DirectionJumpedAlFine,Ke.TargetSegno))||!!(this.Cp(t.directions,Ke.JumpDalSegnoSegno,ws.DirectionJumped,Ke.TargetSegnoSegno)||this.Cp(t.directions,Ke.JumpDalSegnoSegnoAlCoda,ws.DirectionJumpedAlCoda,Ke.TargetSegnoSegno)||this.Cp(t.directions,Ke.JumpDalSegnoSegnoAlDoubleCoda,ws.DirectionJumpedAlDoubleCoda,Ke.TargetSegnoSegno)||this.Cp(t.directions,Ke.JumpDalSegnoSegnoAlFine,ws.DirectionJumpedAlFine,Ke.TargetSegnoSegno)));case ws.DirectionJumped:return this.index++,!0;case ws.DirectionJumpedAlCoda:return this.Dp(t.directions,Ke.JumpDaCoda,Ke.TargetCoda)||this.index++,!0;case ws.DirectionJumpedAlDoubleCoda:return this.Dp(t.directions,Ke.JumpDaDoubleCoda,Ke.TargetDoubleCoda)||this.index++,!0;case ws.DirectionJumpedAlFine:return t.directions.has(Ke.TargetFine)?(this.index=this.ue.masterBars.length,!0):(this.index++,!0)}return!0}Ap(t,e,s){let i;return s?(i=this.Lp(t,e),-1===i&&(i=this.Wp(t,e)),i):(i=this.Wp(t,e),-1===i&&(i=this.Lp(t,e)),i)}Wp(t,e){let s=e;for(;s<this.ue.masterBars.length;){const e=this.ue.masterBars[s].directions;if(e&&e.has(t))return s;s++}return-1}Lp(t,e){let s=e;for(;s>=0;){const e=this.ue.masterBars[s].directions;if(e&&e.has(t))return s;s--}return-1}Pp(){const t=this.ue.masterBars[this.index].repeatCount-1;if(this.Tp.length>0&&t>0){const e=this.Tp[this.Tp.length-1];if(e.iterations[e.closingIndex]<t){this.index=e.opening.index,e.iterations[e.closingIndex]++;for(let t=0;t<e.closingIndex;t++)e.iterations[t]=0;e.closingIndex=0,this.vp=0}else e.closingIndex<e.group.closings.length-1?(e.closingIndex++,this.index++):(this.Tp.pop(),this.Mp.delete(e.group),this.index++)}else this.index++}}class pa{beat;playbackStart;constructor(t,e){this.beat=t,this.playbackStart=e}}class ba{Op=new Map;start;end;highlightedBeats=[];nextBeat=null;previousBeat=null;get duration(){return this.end-this.start}constructor(t,e){this.start=t,this.end=e}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this.Op.has(t.id)||(this.Op.set(t.id,!0),this.highlightedBeats.push(new pa(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}}class ma{tick;tempo;constructor(t,e){this.tick=t,this.tempo=e}}class ga{start=0;end=0;get tempo(){return this.tempoChanges[0].tempo}tempoChanges=[];masterBar;firstBeat=null;lastBeat=null;Rp(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}Ip(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}nextMasterBar=null;previousMasterBar=null;addBeat(t,e,i,n){const r=i+n;if(null==this.firstBeat){const s=new ba(i,r);s.highlightBeat(t,e),this.Rp(this.firstBeat,s)}else if(i>=this.lastBeat.end){const s=new ba(this.lastBeat.end,r);s.highlightBeat(t,e),this.Rp(this.lastBeat,s)}else{let n=null;if(i<this.firstBeat.start)n=this.firstBeat;else{let t=this.firstBeat;for(;null!=t;){if(i>=t.start&&i<t.end){n=t;break}t=t.nextBeat}if(null===n)throw new W(s.General,"Error on building lookup, unknown variant")}if(i<n.start)if(r===n.start){const s=new ba(i,n.start);s.highlightBeat(t,e),this.Ip(this.firstBeat,s)}else if(r<n.end){const s=new ba(i,n.start);s.highlightBeat(t,e),this.Ip(n,s);const a=new ba(n.start,r);for(const t of n.highlightedBeats)a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(t,e),this.Ip(n,a),n.start=r}else if(r===n.end){const s=new ba(i,n.start);s.highlightBeat(t,e),n.highlightBeat(t,e),this.Ip(n,s)}else{const s=new ba(i,n.start);s.highlightBeat(t,e),n.highlightBeat(t,e),this.Ip(n,s),this.addBeat(t,e,n.end,r-n.end)}else if(i>n.start)if(r===n.end){const s=new ba(n.start,i);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);n.start=i,n.highlightBeat(t,e),this.Ip(n,s)}else if(r<n.end){const s=new ba(n.start,i);this.Ip(n,s);const a=new ba(i,r);this.Ip(n,a);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart),a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(t,e),n.start=r}else{const s=new ba(n.start,i);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);n.start=i,n.highlightBeat(t,e),this.Ip(n,s),this.addBeat(t,e,n.end,r-n.end)}else if(r===n.end)n.highlightBeat(t,e);else if(r<n.end){const s=new ba(n.start,r);for(const t of n.highlightedBeats)s.highlightBeat(t.beat,t.playbackStart);s.highlightBeat(t,e),n.start=r,this.Ip(n,s)}else n.highlightBeat(t,e),this.addBeat(t,e,n.end,r-n.end)}}}!function(t){t[t.Unknown=0]="Unknown",t[t.ToNextBext=1]="ToNextBext",t[t.ToEndOfBar=2]="ToEndOfBar"}(ys||(ys={}));class wa{beat;masterBar;beatLookup;nextBeat=null;tickDuration=0;duration=0;cursorMode=ys.Unknown;get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(t){this.masterBar=t}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=R.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const n of this.masterBar.tempoChanges)if(n.tick<e)s=n.tempo;else{if(n.tick>i)break;t+=R.ticksToMillis(n.tick-e,s),s=n.tempo,e=n.tick}i>e&&(t+=R.ticksToMillis(i-e,s)),this.duration=t}}}class ya{Gp=null;masterBarLookup=new Map;masterBars=[];multiBarRestInfo=null;findBeat(t,e,s=null){let i=null;return s&&(i=this.$p(t,s,e)),i||(i=this.Vp(t,s,e,!1)),i}$p(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end){const s=e.nextBeat;return this.Hp(s,t),s}return null}zp(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this.jp(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ys.ToNextBext,t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ys.ToEndOfBar)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=ys.ToEndOfBar)):(t.tickDuration=i.end-t.start,t.cursorMode=ys.ToEndOfBar):(z.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=ys.ToEndOfBar),t.calculateDuration()}Hp(t,e){this.Xp(t)?this.zp(t,e):this.Jp(t,e)}Jp(t,e){t.nextBeat=this.qp(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),null==t.nextBeat&&(t.nextBeat=this.Vp(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ys.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=ys.ToEndOfBar,t.calculateDuration()),t.nextBeat&&t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ys.ToEndOfBar)}Xp(t){return this.Yp(t.masterBar.masterBar.index,t.beat)}Yp(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}Vp(t,e,s,i){let n=null;return null!=e&&(e.masterBar.start<=s&&e.masterBar.end>s?n=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(n=e.masterBar.nextMasterBar)),n||(n=this.Kp(s)),n?this.jp(t,n,s,i):null}jp(t,e,s,i){let n=e;for(;n;){if(n.firstBeat){const e=this.qp(n,n.firstBeat,s,t,i);if(e)return e}n=n.nextMasterBar}return null}qp(t,e,s,i,n){if(!e)return null;let r=null,a=null;const h=s-t.start;for(;null!=e&&null==a;){if((e.start<=h||n&&h<0)&&h<e.end){if(r=e,a=e.getVisibleBeatAtStart(i),!a)if(n){let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStart(i),a){r=e,t=s;break}e=e.nextBeat}a&&r||(s=s.nextMasterBar,e=s?.firstBeat??null)}}else{let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStart(i),a){r=e,t=s;break}e=e.previousBeat}a&&r||(s=s.previousMasterBar,e=s?.firstBeat??null)}}}else if(e.end>h)break;e=e?.nextBeat??null}if(null==a)return null;return this.Qp(t,r,a,n,i)}Qp(t,e,s,i,n){const r=new wa(t);if(r.beat=s,r.beatLookup=e,r.tickDuration=e.end-e.start,i){if(this.Xp(r)){const s=this.multiBarRestInfo.get(t.masterBar.index);let i=t;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-e.start:r.tickDuration=i.end-e.start:z.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.Hp(r,n);return r.calculateDuration(),r}Kp(t){const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const n=(i+s)/2|0,r=e[n];if(t>=r.start&&t<r.end)return r;t<r.start?i=n-1:s=n+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new ga;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this.Gp&&(t.previousMasterBar=this.Gp,this.Gp.nextMasterBar=t),this.Gp=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this.Gp;if(i)if(e<0&&i.previousMasterBar){const n=i.previousMasterBar.end-i.previousMasterBar.start,r=n+e,a=r+s;if(i.previousMasterBar.addBeat(t,r,r,s),a>n){const n=s+e;i.addBeat(t,e,0,n)}}else i.addBeat(t,e,e,s)}}class ka{noteOnly=0;untilTieOrSlideEnd=0;letRingEnd=0}class Sa{firstBeatDuration=0;secondBeatStartOffset=0;secondBeatDuration=0}class Ba{durations=[];brushInfos=[]}class _a{synthTick=0;synthTime=0;currentTempo=0;automationToSyncPoint=new Map;syncPoints;createNewSyncPoints=!1}class xa{static Zp=30;static tb=80;ue;Ml;hi;eb=new Map;sb=0;ib=new Set;tickLookup=new ya;applyTranspositionPitches=!0;syncPoints=[];transpositionPitches=new Map;constructor(t,e,s){this.ue=t,this.Ml=e||new Fr,this.hi=s}generate(){this.transpositionPitches.clear(),this.ib.clear(),this.sb=0;for(const t of this.ue.tracks)this.nb(t);z.debug("Midi","Begin midi generation"),this.syncPoints=[],xa.rb(this.ue,this.syncPoints,!1,(t,e,s,i,n)=>{this.ab(t,e,s,i,n)},(t,e,s)=>{for(const i of this.ue.tracks)for(const n of i.staves)t<n.bars.length&&this.hb(n.bars[t],e,s)},t=>{for(const e of this.ue.tracks)this.hi.finishTrack(e.index,t)}),z.debug("Midi","Midi generation done")}nb(t){this.ob(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this.ob(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}cb(t,e,s,i){this.eb.has(s)&&this.eb.get(s)===i||(this.hi.addProgramChange(t.index,e,s,i),this.eb.set(s,i))}lb(t,e,s,i){const n=ue.bankToLsbMsb(i);this.hi.addControlChange(t.index,e,s,cs.BankSelectCoarse,n[1]),this.hi.addControlChange(t.index,e,s,cs.BankSelectFine,n[0])}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const t=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,t),s.set(i.playbackInfo.secondaryChannel,t)}return s}ob(t,e,s){const i=t.index<this.Ml.notation.transpositionPitches.length?this.Ml.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(e,i);const n=xa.ub(s.volume),r=xa.ub(s.balance);this.hi.addControlChange(t.index,0,e,cs.VolumeCoarse,n),this.hi.addControlChange(t.index,0,e,cs.PanCoarse,r),this.hi.addControlChange(t.index,0,e,cs.ExpressionControllerCoarse,127),this.hi.addControlChange(t.index,0,e,cs.RegisteredParameterFine,0),this.hi.addControlChange(t.index,0,e,cs.RegisteredParameterCourse,0),this.hi.addControlChange(t.index,0,e,cs.DataEntryFine,0),this.hi.addControlChange(t.index,0,e,cs.DataEntryCoarse,xa.fb),this.lb(t,0,e,s.bank),this.cb(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return xa.rb(t,s,e,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}),s}static buildModifiedTempoLookup(t){return xa.rb(t,[],!1,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}).automationToSyncPoint}static rb(t,e,s,i,n,r){const a=new fa(t),h=new _a;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let o=null;const c=new Map;for(;!a.finished;){const e=a.index,s=t.masterBars[e],r=a.currentTick;if(a.processCurrent(),a.shouldPlay){let t=c.has(e)?c.get(e):-1;t++,c.set(e,t),i(s,o,r,h.currentTempo,t);n(e,r,s.tempoAutomations.length>0?s.tempoAutomations[0].value:h.currentTempo),h.synthTick=r,xa.pb(s,t,h)}a.moveNext(),o=s}if(e.length>0){const t=e[e.length-1],s=a.currentTick-t.synthTick;if(s>0){const i=new $i;i.masterBarIndex=o.index,i.masterBarOccurence=c.get(o.index)-1,i.synthTick=a.currentTick,i.synthBpm=h.currentTempo,h.createNewSyncPoints?(i.syncBpm=t.synthBpm,i.synthBpm=t.synthBpm):1===e.length?i.syncBpm=t.synthBpm:i.syncBpm=e[e.length-2].syncBpm,i.synthTime=t.synthTime+R.ticksToMillis(s,t.synthBpm),i.syncTime=t.syncTime+R.ticksToMillis(s,i.syncBpm),h.createNewSyncPoints||t.updateSyncBpm(i.synthTime,i.syncTime),e.push(i)}}return r(a.currentTick),h}static pb(t,e,s){const i=t.calculateDuration(),n=t.syncPoints,r=s.synthTick;s.createNewSyncPoints?xa.bb(t,e,s):n?xa.mb(t,e,s):xa.gb(t,s);const a=r+i,h=a-s.synthTick;h>0&&(s.synthTime+=R.ticksToMillis(h,s.currentTempo),s.synthTick=a)}static bb(t,e,s){const i=s.synthTick;if(0===t.index&&0===e){s.currentTempo=t.score.tempo;const n=new $i;n.masterBarIndex=t.index,n.masterBarOccurence=e,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const n=t.calculateDuration();for(const r of t.tempoAutomations){const a=i+r.ratioPosition*n,h=a-s.synthTick;if(h>0&&(s.synthTick=a,s.synthTime+=R.ticksToMillis(h,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;const i=new $i;i.masterBarIndex=t.index,i.masterBarOccurence=e,i.synthTick=a,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static mb(t,e,s){const i=s.synthTick,n=t.calculateDuration();let r,a=0;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const o=i+h.ratioPosition*n;for(;a<t.tempoAutomations.length&&t.tempoAutomations[a].ratioPosition<=h.ratioPosition;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=R.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=R.ticksToMillis(r,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const c=new $i;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=o,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=h.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(h,c)}for(;a<t.tempoAutomations.length;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=R.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}}static gb(t,e){const s=e.synthTick,i=t.calculateDuration();for(const n of t.tempoAutomations){const t=s+n.ratioPosition*i,r=t-e.synthTick;r>0&&(e.synthTick=t,e.synthTime+=R.ticksToMillis(r,e.currentTempo)),e.currentTempo=n.value}}static ub(t){const e=Math.max(-32768,Math.min(32767,8*t-1));return Math.max(e,-1)+1}ab(t,e,s,i,n){e&&e.timeSignatureDenominator===t.timeSignatureDenominator&&e.timeSignatureNumerator===t.timeSignatureNumerator||this.hi.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const r=t.calculateDuration(),a=new ga;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&a.tempoChanges.push(new ma(s,i));for(const e of t.tempoAutomations){const t=s+r*e.ratioPosition;this.hi.addTempo(t,e.value),a.tempoChanges.push(new ma(t,e.value))}}else e?a.tempoChanges.push(new ma(s,i)):(this.hi.addTempo(s,t.score.tempo),a.tempoChanges.push(new ma(s,t.score.tempo)));a.masterBar=t,a.start=s,a.end=a.start+r,this.tickLookup.addMasterBar(a)}hb(t,e,s){const i=this.wb(t),n=this.sb;for(const r of i.voices)this.sb=n,this.yb(r,e,t,s);const r=i.masterBar,a=r.calculateDuration(),h=r.tempoAutomations.slice();if(0===h.length)this.sb=n+R.ticksToMillis(a,s);else{this.sb=n;let t=e,i=s;const r=e+a;for(const e of h){const s=a*e.ratioPosition-t;s>0&&(this.sb+=R.ticksToMillis(s,i)),i=e.value,t+=s}const o=r-t;o>0&&(this.sb+=R.ticksToMillis(o,i))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,a)}wb(t){switch(t.simileMark){case P.Simple:t.previousBar&&(t=this.wb(t.previousBar));break;case P.FirstOfDouble:case P.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this.wb(t.previousBar.previousBar))}return t}yb(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||0!==t.index))return;const n=s.masterBar.tempoAutomations.slice();let r=i;const a=s.masterBar.calculateDuration();for(const i of t.beats){const t=i.playbackStart/a;for(;n.length>0&&n[0].ratioPosition<=t;)r=n.shift().value;this.kb(i,e,s,r)}}Sb=null;kb(t,e,s,i){let n=t.playbackStart,r=t.playbackDuration;const a=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?r=a:t.voice.bar.masterBar.tripletFeel!==nt.NoTripletFeel&&this.Ml.player.playTripletFeel&&(this.Sb?(n-=this.Sb.secondBeatStartOffset,r=this.Sb.secondBeatDuration,this.Sb=null):(this.Sb=xa._b(n,r,t),this.Sb&&(r=this.Sb.firstBeatDuration))),t.showTimer&&!this.ib.has(t.id)&&(t.timer=this.sb,this.ib.add(t.id)),this.sb+=R.ticksToMillis(r,i),s===t.voice.bar&&this.tickLookup.addBeat(t,n,r);const h=t.voice.bar.staff.track;for(const s of t.automations)this.xb(t,s,e);if(t.isRest)this.hi.addRest(h.index,e+n,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this.Tb(t,e+n);else{const s=this.Mb(t),a=this.Nb(t,r);for(const h of t.notes)this.Pb(h,e+n,r,i,s,a)}if(t.fade!==ft.None&&this.Fb(t,e+n,r),t.vibrato!==w.None){let s=240,i=3;switch(t.vibrato){case w.Slight:s=this.Ml.player.vibrato.beatSlightLength,i=this.Ml.player.vibrato.beatSlightAmplitude;break;case w.Wide:s=this.Ml.player.vibrato.beatWideLength,i=this.Ml.player.vibrato.beatWideAmplitude}this.Lb(e+n,t.playbackDuration,s,0,i,(e,s)=>{this.hi.addBend(t.voice.bar.staff.track.index,e,h.playbackInfo.secondaryChannel,s)})}}static _b(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case nt.Triplet8th:case nt.Dotted8th:case nt.Scottish8th:i=c.Eighth;break;case nt.Triplet16th:case nt.Dotted16th:case nt.Scottish16th:i=c.Sixteenth;break;default:return null}const n=R.toTicks(i);if(e!==n)return null;if(t%n!==0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==n)return null;const r=new Sa;switch(s.voice.bar.masterBar.tripletFeel){case nt.Triplet8th:r.firstBeatDuration=R.applyTuplet(R.toTicks(c.Quarter),3,2),r.secondBeatDuration=R.applyTuplet(R.toTicks(c.Eighth),3,2);break;case nt.Dotted8th:r.firstBeatDuration=R.applyDot(R.toTicks(c.Eighth),!1),r.secondBeatDuration=R.toTicks(c.Sixteenth);break;case nt.Scottish8th:r.firstBeatDuration=R.toTicks(c.Sixteenth),r.secondBeatDuration=R.applyDot(R.toTicks(c.Eighth),!1);break;case nt.Triplet16th:r.firstBeatDuration=R.applyTuplet(R.toTicks(c.Eighth),3,2),r.secondBeatDuration=R.applyTuplet(R.toTicks(c.Sixteenth),3,2);break;case nt.Dotted16th:r.firstBeatDuration=R.applyDot(R.toTicks(c.Sixteenth),!1),r.secondBeatDuration=R.toTicks(c.ThirtySecond);break;case nt.Scottish16th:r.firstBeatDuration=R.toTicks(c.ThirtySecond),r.secondBeatDuration=R.applyDot(R.toTicks(c.Sixteenth),!1)}return r.secondBeatStartOffset=e-r.firstBeatDuration,r}Tb(t,e){const s=R.toTicks(c.SixtyFourth),n=t.voice.bar.staff;if(n.tuning.length>0)for(const t of n.tuning)this.hi.addNote(n.track.index,e,s,t,R.dynamicToVelocity(i.F),n.track.playbackInfo.primaryChannel)}Wb(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==w.None}Ob(t,e){if(this.Wb(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this.Wb(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this.Wb(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}Pb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let o=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const e=Ut.getArticulation(t);e&&(o=e.outputMidiNumber)}const c=null==r&&t.isStringed&&t.string<=n.length?n[t.string-1]:0,l=e+c,u=this.Rb(t,s,i);u.untilTieOrSlideEnd-=c,u.noteOnly-=c,u.letRingEnd-=c;const d=xa.Ib(t),f=this.Ob(a,t);let p=0;const b=Math.max(u.untilTieOrSlideEnd,u.letRingEnd);p=t.hasBend?xa.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?xa.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===g.Legato?-1:xa.getPitchWheel(0),p>=0&&this.hi.addNoteBend(a.index,l,f,o,p),t.beat.hasRasgueado?this.$b(a,t,l,o,d,f,r):t.ornament===ct.None?!t.isTrill||h.isPercussion?t.beat.isTremolo?this.Vb(t,l,u,o,d,f):(t.hasBend?this.Hb(t,l,u,o,f,i):t.beat.hasWhammyBar&&0===t.index?this.Ub(t.beat,l,u,f,i):t.slideInType!==m.None||t.slideOutType!==g.None?this.zb(t,l,u,o,f,i):(t.vibrato!==w.None||t.isTieDestination&&t.tieOrigin.vibrato!==w.None)&&this.jb(t,l,u,o,f),t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===g.Legato||this.hi.addNote(a.index,l,b,o,d,f)):this.Xb(t,l,u,o,d,f):this.Jb(a,t,l,b,o,d,f)}static qb=[2,2,2,1,1,2,2,2,2,2,1,1];static ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];Jb(t,e,s,i,n,r,a){let h,o;const l=n%12,u=1/3;switch(e.ornament){case ct.Turn:h=[n+xa.qb[l],n,n+xa.ornamentKeysDown[l]],o=[R.toTicks(c.Sixteenth)*u,R.toTicks(c.Sixteenth)*u,R.toTicks(c.Sixteenth)*u];break;case ct.InvertedTurn:h=[n+xa.ornamentKeysDown[l],n,n+xa.qb[l]],o=[R.toTicks(c.Sixteenth)*u,R.toTicks(c.Sixteenth)*u,R.toTicks(c.Sixteenth)*u];break;case ct.UpperMordent:h=[n,n+xa.qb[l]],o=[R.toTicks(c.ThirtySecond),R.toTicks(c.ThirtySecond)];break;case ct.LowerMordent:h=[n,n+xa.ornamentKeysDown[l]],o=[R.toTicks(c.ThirtySecond),R.toTicks(c.ThirtySecond)];break;default:return}let d=1;i<R.QuarterTime&&(d=i/R.QuarterTime),r-=R.VelocityIncrement;let f=0;for(let e=0;e<h.length;e++){const i=o[e]*d;this.hi.addNote(t.index,s,i,h[e],r,a),s+=i,f+=i}const p=i-f;this.hi.addNote(t.index,s,p,n,r,a)}Rb(t,e,s){const i=new ka;if(i.noteOnly=e,i.untilTieOrSlideEnd=e,i.letRingEnd=e,t.isDead)return i.noteOnly=this.Yb(xa.Zp,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isPalmMute)return i.noteOnly=this.Yb(xa.tb,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isStaccato)return i.noteOnly=e/2|0,i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isTieOrigin){const n=t.tieDestination;if(n)if(t.isTieDestination){const t=this.Rb(n,n.beat.playbackDuration,s);i.untilTieOrSlideEnd=e+t.untilTieOrSlideEnd}else{const e=t.beat.absolutePlaybackStart,r=this.Rb(n,n.beat.playbackDuration,s),a=n.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;i.untilTieOrSlideEnd=a-e}}else if(t.slideOutType===g.Legato){const e=t.slideTarget;if(e){const n=t.beat.absolutePlaybackStart,r=this.Rb(e,e.beat.playbackDuration,s),a=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;i.untilTieOrSlideEnd=a-n}}if(t.isLetRing&&this.Ml.notation.notationMode===S.GuitarPro){let s=t.beat,n=0;const r=t.beat.voice.bar.masterBar.calculateDuration();for(;s.nextBeat;){const e=s.nextBeat;if(e.isRest)break;if(t.isStringed&&e.hasNoteOnString(t.string))break;if(s=s.nextBeat,n=s.absolutePlaybackStart-t.beat.absolutePlaybackStart+s.playbackDuration,n>r){n=r;break}}s===t.beat?i.letRingEnd=e:i.letRingEnd=n}else i.letRingEnd=i.untilTieOrSlideEnd;return i}Yb(t,e,s){const i=s*t/$.MaxPosition|0;return Math.min(i,e)}static Ib(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case u.Normal:e++;break;case u.Heavy:e+=2}return R.dynamicToVelocity(t.dynamics,e)}Fb(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case ft.FadeIn:this.Kb(i,e,s,0,xa.ub(i.playbackInfo.volume));break;case ft.FadeOut:this.Kb(i,e,s,xa.ub(i.playbackInfo.volume),0);break;case ft.VolumeSwell:const t=s/2|0;this.Kb(i,e,t,0,xa.ub(i.playbackInfo.volume)),this.Kb(i,e+t,t,xa.ub(i.playbackInfo.volume),0)}}Kb(t,e,s,i,n){const r=(n-i)/(s=.8*s|0),a=s/120+1|0,h=e+s;for(let s=0;s<a;s++){const o=s===a-1,c=o?h:e+120*s,l=o?n:Math.round(i+(c-e)*r);this.hi.addControlChange(t.index,c,t.playbackInfo.primaryChannel,cs.VolumeCoarse,l),this.hi.addControlChange(t.index,c,t.playbackInfo.secondaryChannel,cs.VolumeCoarse,l)}}jb(t,e,s,i,n){let r=0,a=0;switch(t.vibrato!==w.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:w.Slight){case w.Slight:r=this.Ml.player.vibrato.noteSlightLength,a=this.Ml.player.vibrato.noteSlightAmplitude;break;case w.Wide:r=this.Ml.player.vibrato.noteWideLength,a=this.Ml.player.vibrato.noteWideAmplitude;break;default:return}const h=t.beat.voice.bar.staff.track;let o=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const e=t.tieOrigin.bendPoints;o=e[e.length-1].value}this.Lb(e,s.noteOnly,r,o,a,(t,e)=>{this.hi.addNoteBend(h.index,t,n,i,e)})}vibratoResolution=16;Lb(t,e,s,i,n,r){const a=this.vibratoResolution,h=s/2|0,o=t+e;for(;t<o;){let e=0;const c=t+s<o?s:o-t;for(;e<c;){const s=i+n*Math.sin(e*Math.PI/h);r(t+e|0,xa.getPitchWheel(s)),e+=a}t+=s}r(0|o,xa.getPitchWheel(i))}static fb=16;static Qb=It.DefaultPitchWheel/xa.fb;static Zb=6;static tm=150;static getPitchWheel(t){return It.DefaultPitchWheel+t/2*xa.Qb}zb(t,e,s,i,n,r){const a=t.slideOutType===g.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],o=t.beat.voice.bar.staff.track,c=this.Ml.player.slide.simpleSlidePitchOffset,l=Math.floor($.MaxPosition*this.Ml.player.slide.simpleSlideDurationRatio),u=Math.floor($.MaxPosition*this.Ml.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case m.IntoFromAbove:h.push(new $(0,c)),h.push(new $(l,0));break;case m.IntoFromBelow:h.push(new $(0,-c)),h.push(new $(l,0))}switch(t.slideOutType){case g.Legato:case g.Shift:h.push(new $(u,0));const e=2*(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0));h.push(new $($.MaxPosition,e));break;case g.OutDown:h.push(new $($.MaxPosition-l,0)),h.push(new $($.MaxPosition,-c));break;case g.OutUp:h.push(new $($.MaxPosition-l,0)),h.push(new $($.MaxPosition,c))}this.sm(e,a,h,r,(t,e)=>{this.hi.addNoteBend(o.index,t,n,i,e)})}Hb(t,e,s,i,n,h){const o=t.bendPoints,c=t.beat.voice.bar.staff.track,u=(t,e)=>{this.hi.addNoteBend(c.index,t,n,i,e)};let d,f=null;if(t.isTieOrigin&&this.Ml.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&e.tieDestination.vibrato===w.None;)e=e.tieDestination;d=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this.Rb(e,e.beat.playbackDuration,h).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==l.None){switch(t.tieDestination.bendType){case a.Bend:case a.BendRelease:case a.PrebendBend:f=t.tieDestination.bendPoints[1].value;break;case a.Prebend:case a.PrebendRelease:f=t.tieDestination.bendPoints[0].value}d=Math.max(s.noteOnly,R.millisToTicks(this.Ml.player.songBookBendDuration,h))}else d=s.noteOnly;o[0].value>0&&!t.isContinuedBend&&e>0&&e--;const p=Math.min(d,R.millisToTicks(this.Ml.player.songBookBendDuration,h));let b=[];switch(t.bendType){case a.Custom:b=o;break;case a.Bend:case a.Release:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new $(0,t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),b.push(new $($.MaxPosition,f));break;case r.Fast:return(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void(t.beat.graceType===l.BendGrace?this.im(e,d,!0,[t.bendPoints[0].value,f],p,h,u):this.im(e,d,!1,[t.bendPoints[0].value,f],p,h,u))}break;case a.BendRelease:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new $(0,t.bendPoints[0].value)),b.push(new $($.MaxPosition/2|0,t.bendPoints[1].value)),b.push(new $($.MaxPosition,t.bendPoints[2].value));break;case r.Fast:return void this.im(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],p,h,u)}break;case a.Hold:case a.Prebend:b=o;break;case a.PrebendBend:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new $(0,t.bendPoints[0].value)),b.push(new $($.MaxPosition,t.bendPoints[1].value));break;case r.Fast:return u(e,0|xa.getPitchWheel(t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void this.im(e,d,!1,[t.bendPoints[0].value,f],p,h,u)}break;case a.PrebendRelease:switch(t.bendStyle){case r.Default:b=o;break;case r.Gradual:b.push(new $(0,t.bendPoints[0].value)),b.push(new $($.MaxPosition,t.bendPoints[1].value));break;case r.Fast:return u(e,0|xa.getPitchWheel(t.bendPoints[0].value)),void this.im(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value],p,h,u)}}this.sm(e,d,b,h,u)}im(t,e,s,i,n,r,a){const h=s?t:t+e-n,o=n/(i.length-1);for(let t=0;t<i.length-1;t++){const e=xa.getPitchWheel(i[t]),s=xa.getPitchWheel(i[t+1]),n=h+o*t;this.nm(n,o,e,s,r,a)}}Ub(t,e,s,i,n){const a=t.whammyBarPoints,h=t.voice.bar.staff.track,o=s.noteOnly;a[0].value>0&&!t.isContinuedWhammy&&e--;const c=(t,e)=>{this.hi.addBend(h.index,t,i,e)};let l=[];switch(t.whammyBarType){case ut.Custom:l=a;break;case ut.Dive:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new $(0,a[0].value)),l.push(new $($.MaxPosition,a[1].value));break;case r.Fast:const t=Math.min(o,R.millisToTicks(this.Ml.player.songBookBendDuration,n));return void this.im(e,o,!1,[a[0].value,a[1].value],t,n,c)}break;case ut.Dip:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new $(0,a[0].value)),l.push(new $($.MaxPosition/2|0,a[1].value)),l.push(new $($.MaxPosition,a[2].value));break;case r.Fast:const t=Math.min(o,R.millisToTicks(this.Ml.player.songBookDipDuration,n));return void this.im(e,o,!0,[a[0].value,a[1].value,a[2].value],t,n,c)}break;case ut.Hold:case ut.Predive:l=a;break;case ut.PrediveDive:switch(t.whammyStyle){case r.Default:l=a;break;case r.Gradual:l.push(new $(0,a[0].value)),l.push(new $($.MaxPosition/2|0,a[0].value)),l.push(new $($.MaxPosition,a[1].value));break;case r.Fast:const t=xa.getPitchWheel(a[0].value);this.hi.addBend(h.index,e,i,0|t);const s=Math.min(o,R.millisToTicks(this.Ml.player.songBookBendDuration,n));return void this.im(e,o,!1,[a[0].value,a[1].value],s,n,c)}}this.sm(e,o,l,n,c)}sm(t,e,s,i,n){const r=e/$.MaxPosition;for(let e=0;e<s.length-1;e++){const a=s[e],h=s[e+1],o=xa.getPitchWheel(a.value),c=xa.getPitchWheel(h.value),l=r*(h.offset-a.offset),u=t+r*a.offset;this.nm(u,l,o,c,i,n)}}nm(t,e,s,i,n,r){const a=R.ticksToMillis(e,n),h=Math.abs(i-s)/xa.Qb,o=Math.max(xa.Zb*h,a/xa.tm),c=e/o,l=(i-s)/o,u=t+e;for(let e=0;e<o;e++)r(0|t,Math.round(s)),s+=l,t+=c;r(0|u,i)}$b(t,e,s,i,n,r,a){let h=s;for(let s=0;s<a.durations.length;s++){const o=a.brushInfos[s],c=e.isStringed&&e.string<=o.length?o[e.string-1]:0,l=a.durations[s];this.hi.addNote(t.index,h+c,l-c,i,n,r),h+=l}}Xb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let o=R.toTicks(t.trillSpeed),c=!0,l=e;const u=e+s.untilTieOrSlideEnd;for(;l+10<u;)l+o>=u&&(o=u-l),this.hi.addNote(a.index,l,o,c?h:i,n,r),c=!c,l+=o}Vb(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track;let h=R.toTicks(t.beat.tremoloSpeed),o=e;const c=e+s.untilTieOrSlideEnd;for(;o+10<c;)o+h>=c&&(h=c-o),this.hi.addNote(a.index,o,h,i,n,r),o+=h}static rm=new Map([[mt.Ii,[h.BrushDown,h.BrushUp]],[mt.Mi,[h.BrushDown,h.BrushDown]],[mt.MiiTriplet,[h.BrushDown,h.BrushDown,h.BrushUp]],[mt.MiiAnapaest,[h.BrushDown,h.BrushDown,h.BrushUp]],[mt.PmpTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.PmpAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.PeiTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.PeiAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.PaiTriplet,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.PaiAnapaest,[h.BrushUp,h.BrushDown,h.BrushDown]],[mt.AmiTriplet,[h.BrushDown,h.BrushDown,h.BrushDown]],[mt.AmiAnapaest,[h.BrushDown,h.BrushDown,h.BrushDown]],[mt.Ppp,[h.None,h.BrushDown,h.BrushUp]],[mt.Amii,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[mt.Amip,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[mt.Eami,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown]],[mt.Eamii,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]],[mt.Peami,[h.BrushDown,h.BrushDown,h.BrushDown,h.BrushDown,h.BrushUp]]]);static am=new Map([[mt.Ii,[R.toTicks(c.Eighth),R.toTicks(c.Eighth)]],[mt.Mi,[R.toTicks(c.Eighth),R.toTicks(c.Eighth)]],[mt.MiiTriplet,[R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3]],[mt.MiiAnapaest,[R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth),R.toTicks(c.Eighth)]],[mt.PmpTriplet,[R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3]],[mt.PmpAnapaest,[R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Eighth)/3]],[mt.PeiTriplet,[R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3]],[mt.PeiAnapaest,[R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth),R.toTicks(c.Eighth)]],[mt.PaiTriplet,[R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3]],[mt.PaiAnapaest,[R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth),R.toTicks(c.Eighth)]],[mt.AmiTriplet,[R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3,R.toTicks(c.Eighth)/3]],[mt.AmiAnapaest,[R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Eighth)/3]],[mt.Ppp,[R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Eighth)/3]],[mt.Amii,[R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Eighth)]],[mt.Amip,[R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Sixteenth)/3,R.toTicks(c.Eighth)]],[mt.Eami,[R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth),R.toTicks(c.Sixteenth)]],[mt.Eamii,[R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5]],[mt.Peami,[R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5,R.toTicks(c.Sixteenth)/5]]]);Nb(t,e){if(!t.hasRasgueado)return null;const s=new Ba,i=xa.am.get(t.rasgueado).reduce((t,e)=>t+e,0);s.durations=xa.am.get(t.rasgueado).map(t=>e*t/i),s.brushInfos=new Array(s.durations.length);const n=R.toTicks(c.Sixteenth);let r=0,a=0;for(const e of t.notes)e.isTieDestination||(r|=1<<e.string-1,a++);const o=xa.rm.get(t.rasgueado);for(let e=0;e<s.durations.length;e++){const i=s.durations[e]*n/R.QuarterTime,c=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[e]=c;const l=o[e];l!==h.None&&this.hm(t,c,l===h.ArpeggioDown||l===h.BrushDown,r,a,i)}return s}Mb(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const e of t.notes)e.isTieDestination||(s|=1<<e.string-1,i++);this.hm(t,e,t.brushType===h.ArpeggioDown||t.brushType===h.BrushDown,s,i,t.brushDuration)}return e}hm(t,e,s,i,n,r){if(t.notes.length>0){let a=0;const h=r/(n-1)|0;for(let n=0;n<t.voice.bar.staff.tuning.length;n++){const t=s?n:e.length-1-n;i&1<<t&&(e[t]=a,a+=h)}}return e}xb(t,e,s){switch(e.type){case n.Instrument:this.cb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&e.value),this.cb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&e.value);break;case n.Bank:this.lb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,e.value),this.lb(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,e.value);break;case n.Balance:const i=xa.ub(e.value);this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,cs.PanCoarse,i),this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,cs.PanCoarse,i);break;case n.Volume:const r=xa.ub(e.value);this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,cs.VolumeCoarse,r),this.hi.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,cs.VolumeCoarse,r)}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(-1===e||-1===s);){for(const i of t.automations)switch(i.type){case n.Instrument:s=i.value;break;case n.Tempo:e=i.value}i=i.previousBeat}const r=t.voice.bar.staff.track,a=t.voice.bar.masterBar;-1===e&&(e=a.score.tempo);const h=t.playbackStart/a.calculateDuration();for(const t of a.tempoAutomations){if(!(t.ratioPosition<=h))break;e=t.value}-1===s&&(s=r.playbackInfo.program);const o=r.playbackInfo.volume;this.nb(r),this.hi.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this.hi.addTempo(0,e);const c=xa.ub(o);return this.hi.addControlChange(0,0,r.playbackInfo.primaryChannel,cs.VolumeCoarse,c),this.hi.addControlChange(0,0,r.playbackInfo.secondaryChannel,cs.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this.kb(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this.Pb(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}}class Ta{oldWidth=0;newWidth=0;settings=null}class Ma{x;y;width=0;height=0;renderer;constructor(t,e){this.x=t,this.y=e}getBoundingBoxTop(){return this.y}doLayout(){}paint(t,e,s){}}class va extends Ma{beat=null;nextGlyph=null;previousGlyph=null;constructor(t=0,e=0){super(t,e)}}class Na extends va{glyphScale=0;symbol;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const t=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-t}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class Pa extends va{glyphScale=0;symbols;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let t=0;for(let e=0;e<this.symbols.length;e++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[e]);(0===e||s<t)&&(t=s)}return this.y-this.offsetY-t}doLayout(){this.width=0,this.height=0;for(let t=0;t<this.symbols.length;t++){const e=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[t])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[t])*this.glyphScale;(0===t||e>this.width)&&(this.width=e),(0===t||s>this.height)&&(this.height=s)}}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class Ea extends Na{static GraceScale=.75;centerOnStem=!1;constructor(t,e,s,i){super(t,e,i?Ea.GraceScale:1,Ea.getSymbol(s))}paint(t,e,s){this.centerOnStem&&(this.center=!0),super.paint(t,e,s)}static getSymbol(t){switch(t){case c.QuadrupleWhole:return rt.NoteheadDoubleWholeSquare;case c.DoubleWhole:return rt.NoteheadDoubleWhole;case c.Whole:return rt.NoteheadWhole;case c.Half:return rt.NoteheadHalf;default:return rt.NoteheadBlack}}}class Fa extends Na{constructor(t,e,s,i,n){super(t,e,n?Ea.GraceScale:1,Fa.getSymbol(s,i,n))}static getSymbol(t,e,s){if(s&&(t=c.Eighth),e===Ct.Up)switch(t){case c.Eighth:return rt.Flag8thUp;case c.Sixteenth:return rt.Flag16thUp;case c.ThirtySecond:return rt.Flag32ndUp;case c.SixtyFourth:return rt.Flag64thUp;case c.OneHundredTwentyEighth:return rt.Flag128thUp;case c.TwoHundredFiftySixth:return rt.Flag256thUp;default:return rt.Flag8thUp}switch(t){case c.Eighth:return rt.Flag8thDown;case c.Sixteenth:return rt.Flag16thDown;case c.ThirtySecond:return rt.Flag32ndDown;case c.SixtyFourth:return rt.Flag64thDown;case c.OneHundredTwentyEighth:case c.TwoHundredFiftySixth:return rt.Flag128thDown;default:return rt.Flag8thDown}}}class Ca extends Ma{voiceContainer;beat;preNotes;onNotes;ties=[];minWidth=0;get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(t,e){super(0,0),this.beat=t,this.ties=[],this.voiceContainer=e}addTie(t){t.renderer=this.renderer,this.ties.push(t)}drawBeamHelperAsFlags(t){return t.hasFlag(!1,void 0)}registerLayoutingInfo(t){const e=this.preNotes.computedWidth+this.onNotes.centerX;let s=this.onNotes.computedWidth-this.onNotes.centerX;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(this.beat.graceType!==l.None||i&&this.drawBeamHelperAsFlags(i))&&(s+=this.renderer.smuflMetrics.glyphWidths.get(rt.Flag8thUp)*Ea.GraceScale);for(const t of this.ties)s+=t.width;t.addBeatSpring(this.beat,e,s)}applyLayoutingInfo(t){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.onNotes.updateBeamingHelper();let t=this.beat.notes.length-1;for(;t>=0;)this.createTies(this.beat.notes[t--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&1===this.onNotes.beamingHelper.beats.length&&this.beat.duration>=c.Eighth){const t=Fa.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,this.beat.graceType!==l.None);this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(t)}let t=0;for(const e of this.ties)e.width>t&&(t=e.width);this.minWidth+=t,this.width=this.minWidth}scaleToWidth(t){this.onNotes.updateBeamingHelper(),this.width=t}createTies(t){}static getGroupId(t){return`b${t.id}`}paint(t,e,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;s.beginGroup(Ca.getGroupId(this.beat)),this.preNotes.paint(t+this.x,e+this.y,s),this.onNotes.paint(t+this.x,e+this.y,s);const i=t-this.voiceContainer.x-this.renderer.x,n=e-this.voiceContainer.y-this.renderer.y;for(let t=0,e=this.ties.length;t<e;t++){const e=this.ties[t];e.renderer=this.renderer,e.paint(i,n,s)}s.endGroup()}buildBoundingsLookup(t,e,s,i){const n=new ve;if(n.beat=this.beat,this.beat.isEmpty)n.visualBounds=new Ne,n.visualBounds.x=e+this.x,n.visualBounds.y=t.visualBounds.y,n.visualBounds.w=this.width,n.visualBounds.h=t.visualBounds.h,n.realBounds=new Ne,n.realBounds.x=e+this.x,n.realBounds.y=t.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=t.realBounds.h,n.onNotesX=e+this.x+this.onNotes.centerX;else{n.visualBounds=new Ne,n.visualBounds.x=e+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?n.visualBounds.x=e+this.x:n.visualBounds.x=e+this.x+this.onNotes.x:n.visualBounds.x=e+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?e+this.x+this.width:e+this.x+this.preNotes.x+this.preNotes.width:e+this.x+this.onNotes.x+this.onNotes.width,n.visualBounds.w=s-n.visualBounds.x;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(i&&this.drawBeamHelperAsFlags(i)||this.beat.graceType!==l.None)&&(n.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(rt.Flag8thUp)*(this.beat.graceType!==l.None?Ea.GraceScale:1)),n.visualBounds.y=t.visualBounds.y,n.visualBounds.h=t.visualBounds.h,n.realBounds=new Ne,n.realBounds.x=e+this.x,n.realBounds.y=t.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=t.realBounds.h,n.onNotesX=e+this.x+this.onNotes.x+this.onNotes.centerX}t.addBeat(n),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(n,e+this.x,s+this.y)}}class Aa{om;lm;Ml;um=0;ue=null;dm=null;get instance(){return this.om}set instance(t){this.om=t;const e=this.lm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.preRender.on(t=>this.preRender.trigger(t))),e.push(t.renderFinished.on(t=>this.renderFinished.trigger(t))),e.push(t.partialRenderFinished.on(t=>this.partialRenderFinished.trigger(t))),e.push(t.partialLayoutFinished.on(t=>this.partialLayoutFinished.trigger(t))),e.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),e.push(t.error.on(t=>this.error.trigger(t))),this.lm=e,this.Ml&&t.updateSettings(this.Ml),t.width=this.um,null!==this.ue&&t.renderScore(this.ue,this.dm)}else this.lm=void 0}get boundsLookup(){return this.om?this.om.boundsLookup:null}get width(){return this.om?this.om.width:0}set width(t){this.um=t,this.om&&(this.om.width=t)}render(){this.om?.render()}resizeRender(){this.om?.resizeRender()}renderScore(t,e){this.ue=t,this.dm=e,this.om?.renderScore(t,e)}renderResult(t){this.om?.renderResult(t)}updateSettings(t){this.Ml=t,this.om?.updateSettings(t)}destroy(){this.om?.destroy(),this.om=void 0}preRender=new Te;renderFinished=new Te;partialRenderFinished=new Te;partialLayoutFinished=new Te;postRenderFinished=new xe;error=new Te}class Da{activeBeats;constructor(t){this.activeBeats=t}}class La{fm=1;yf=0;kf=0;pm=1;bm=!1;gm=[];om;lm;constructor(){this.ready=new xe(()=>this.isReady),this.readyForPlayback=new xe(()=>this.isReadyForPlayback),this.midiLoaded=new Te(()=>this.om?.loadedMidiInfo??null),this.stateChanged=new Te(()=>new zi(this.state,!1)),this.positionChanged=new Te(()=>this.currentPosition),this.playbackRangeChanged=new Te(()=>{const t=this.playbackRange;return t?new Zn(t):null})}get instance(){return this.om}set instance(t){this.om=t;const e=this.lm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.ready.on(()=>this.ready.trigger())),e.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),e.push(t.finished.on(()=>this.finished.trigger())),e.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),e.push(t.soundFontLoadFailed.on(t=>this.soundFontLoadFailed.trigger(t))),e.push(t.midiLoaded.on(t=>{this.midiLoaded.trigger(t)})),e.push(t.midiLoadFailed.on(t=>this.midiLoadFailed.trigger(t))),e.push(t.stateChanged.on(t=>this.stateChanged.trigger(t))),e.push(t.positionChanged.on(t=>{this.positionChanged.trigger(t)})),e.push(t.midiEventsPlayed.on(t=>this.midiEventsPlayed.trigger(t))),e.push(t.playbackRangeChanged.on(t=>this.playbackRangeChanged.trigger(t))),this.lm=e,this.isReady?(t.masterVolume=this.fm,t.metronomeVolume=this.yf,t.countInVolume=this.kf,t.playbackSpeed=this.pm,t.isLooping=this.bm,t.midiEventsPlayedFilter=this.gm,this.ready.trigger()):e.push(t.ready.on(()=>{t.masterVolume=this.fm,t.metronomeVolume=this.yf,t.countInVolume=this.kf,t.playbackSpeed=this.pm,t.isLooping=this.bm,t.midiEventsPlayedFilter=this.gm}))}else this.lm=void 0}get output(){return this.om.output}get isReady(){return!!this.om&&this.om.isReady}get isReadyForPlayback(){return!!this.om&&this.om.isReadyForPlayback}get state(){return this.om?this.om.state:ss.Paused}get logLevel(){return z.logLevel}set logLevel(t){z.logLevel=t,this.om&&(this.om.logLevel=t)}get masterVolume(){return this.fm}set masterVolume(t){t=Math.max(t,It.MinVolume),this.fm=t,this.om&&(this.om.masterVolume=t)}get metronomeVolume(){return this.yf}set metronomeVolume(t){t=Math.max(t,It.MinVolume),this.yf=t,this.om&&(this.om.metronomeVolume=t)}get playbackSpeed(){return this.pm}set playbackSpeed(t){this.pm=t,this.om&&(this.om.playbackSpeed=t)}get loadedMidiInfo(){return this.om?this.om.loadedMidiInfo:void 0}get currentPosition(){return this.om?this.om.currentPosition:new ji(0,0,0,0,!1,120,120)}get tickPosition(){return this.om?this.om.tickPosition:0}set tickPosition(t){this.om&&(this.om.tickPosition=t)}get timePosition(){return this.om?this.om.timePosition:0}set timePosition(t){this.om&&(this.om.timePosition=t)}get playbackRange(){return this.om?this.om.playbackRange:null}set playbackRange(t){this.om&&(this.om.playbackRange=t)}get isLooping(){return this.bm}set isLooping(t){this.bm=t,this.om&&(this.om.isLooping=t)}get countInVolume(){return this.kf}set countInVolume(t){this.kf=t,this.om&&(this.om.countInVolume=t)}get midiEventsPlayedFilter(){return this.gm}set midiEventsPlayedFilter(t){this.gm=t,this.om&&(this.om.midiEventsPlayedFilter=t)}destroy(){this.om&&(this.om.destroy(),this.om=void 0)}play(){return!!this.om&&this.om.play()}pause(){this.om&&this.om.pause()}playPause(){this.om&&this.om.playPause()}stop(){this.om&&this.om.stop()}playOneTimeMidiFile(t){this.om&&this.om.playOneTimeMidiFile(t)}loadSoundFont(t,e){this.om&&this.om.loadSoundFont(t,e)}resetSoundFonts(){this.om&&this.om.resetSoundFonts()}loadMidiFile(t){this.om&&this.om.loadMidiFile(t)}loadBackingTrack(t){this.om&&this.om.loadBackingTrack(t)}updateSyncPoints(t){this.om&&this.om.updateSyncPoints(t)}applyTranspositionPitches(t){this.om&&this.om.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.om&&this.om.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.om&&this.om.setChannelMute(t,e)}resetChannelStates(){this.om&&this.om.resetChannelStates()}setChannelSolo(t,e){this.om&&this.om.setChannelSolo(t,e)}setChannelVolume(t,e){this.om&&this.om.setChannelVolume(t,e)}ready;readyForPlayback;finished=new xe;soundFontLoaded=new xe;soundFontLoadFailed=new Te;midiLoaded;midiLoadFailed=new Te;stateChanged;positionChanged;midiEventsPlayed=new Te;playbackRangeChanged}class Wa{sf=new Yn;masterVolume=1;metronomeVolume=0;outSampleRate=44100;currentTempo=120;timeSignatureNumerator=4;timeSignatureDenominator=4;activeVoiceCount=0;output;noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}wm(t){}dispatchEvent(t){this.sf.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this.sf.isEmpty;){const e=this.sf.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this.wm(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class Oa extends sr{ym;constructor(t,e){super(t,new Wa,e),this.synthesizer.output=t,this.ym=t,t.timeUpdate.on(e=>{const s=this.sequencer.mainTimePositionFromBackingTrack(e,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(t){super.updateMasterVolume(t),this.ym.masterVolume=t}updatePlaybackSpeed(t){super.updatePlaybackSpeed(t),this.ym.playbackRate=t}onSampleRequest(){}loadMidiFile(t){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(t)}updateTimePosition(t,e){super.updateTimePosition(t,e),e&&this.ym.seekTo(this.sequencer.mainTimePositionToBackingTrack(t,this.ym.backingTrackDuration))}loadBackingTrack(t){const e=t.backingTrack;e&&(this.ym.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(t){this.sequencer.mainUpdateSyncPoints(t),this.tickPosition=this.tickPosition}}class Ra{sampleRate=44100;km=0;hi;get handler(){return this.hi}set handler(t){t&&0!==this.km&&(t.seekTo(this.km),this.km=0),this.hi=t}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this.km=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(t){}resetSamples(){}activate(){}ready=new xe;samplesPlayed=new Te;timeUpdate=new Te;sampleRequest=new xe;async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class Ia extends Oa{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new Ra,t)}}class Ga{startTick=0;endTick=0}class $a{beat;bounds=null;constructor(t){this.beat=t}}class Va{Sm=0;dm=null;Bm=null;_m=!1;ue=null;xm=[];Tm=ms.Disabled;sp;hp;get actualPlayerMode(){return this.Tm}uiFacade;container;get renderer(){return this.hp}get score(){return this.ue}settings;get tracks(){return this.xm}canvasElement;constructor(t,e){this.uiFacade=t,this.container=t.rootContainer,this.activeBeatsChanged=new Te(()=>this.sp.state===ss.Playing&&this.Mm?new Da(this.Mm.beatLookup.highlightedBeats.map(t=>t.beat)):null),this.playedBeatChanged=new Te(()=>this.sp.state===ss.Playing&&this.Mm?this.Mm.beat:null),this.scoreLoaded=new Te(()=>this.ue?this.ue:null),this.midiLoaded=new Te(()=>this.sp.loadedMidiInfo??null),t.initialize(this,e),z.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),tu.printEnvironmentInfo(!1),this.canvasElement=t.createCanvasElement(),this.container.appendChild(this.canvasElement),this.hp=new Aa,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&tu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.hp.instance=this.uiFacade.createWorkerRenderer():this.hp.instance=new Ae(this.settings),this.container.resize.on(tu.throttle(()=>{this._m||this.container.width!==this.hp.width&&this.triggerResize()},t.resizeThrottle));const s=new Ta;s.oldWidth=this.hp.width,s.newWidth=0|this.container.width,s.settings=this.settings,this.vm(s),this.hp.preRender.on(this.Nm.bind(this)),this.hp.renderFinished.on(t=>{this.gs(t)}),this.hp.postRenderFinished.on(()=>{const t=Date.now()-this.Sm;z.debug("rendering",`Rendering completed in ${t}ms`),this.Pm()}),this.hp.preRender.on(t=>{this.Sm=Date.now()}),this.hp.partialLayoutFinished.on(t=>this.Em(t,!1)),this.hp.partialRenderFinished.on(this.Fm.bind(this)),this.hp.renderFinished.on(t=>{this.Em(t,!0)}),this.hp.error.on(this.onError.bind(this)),this.Cm(),this.settings.player.playerMode!==ms.Disabled&&this.Am(),this.Dm(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}Cm(){const t=new La;this.sp=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this.Lm(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this.Wm.bind(this)),t.soundFontLoadFailed.on(t=>{this.onError(t)}),t.midiLoaded.on(this.Om.bind(this)),t.midiLoadFailed.on(t=>{this.onError(t)}),t.stateChanged.on(this.Rm.bind(this)),t.positionChanged.on(this.Im.bind(this)),t.midiEventsPlayed.on(this.Gm.bind(this)),t.playbackRangeChanged.on(this.$m.bind(this)),t.finished.on(this.Vm.bind(this))}destroy(){this._m=!0,this.sp.destroy(),this.uiFacade.destroy(),this.hp.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&Vt.applyPitchOffsets(this.settings,t),this.Hm(),this.hp.updateSettings(this.settings),this.Am(),this.Um()}Hm(){const t=this.hp;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&tu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof Ae&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof Ae||(t.destroy(),t.instance=new Ae(this.settings))}load(t,e){try{return this.uiFacade.load(t,t=>{this.renderScore(t,e)},t=>{this.onError(t)})}catch(t){return this.onError(t),!1}}renderScore(t,e){const s=[];if(e)if(0===e.length)t.tracks.length>0&&s.push(t.tracks[0]);else if(1===e.length&&-1===e[0])for(const e of t.tracks)s.push(e);else for(const i of e)i>=0&&i<=t.tracks.length&&s.push(t.tracks[i]);else t.tracks.length>0&&s.push(t.tracks[0]);this.zm(t,s)}renderTracks(t){if(t.length>0){const e=t[0].score;for(const i of t)if(i.score!==e)return void this.onError(new W(s.General,"All rendered tracks must belong to the same score."));this.zm(e,t)}}zm(t,e){if(Vt.applyPitchOffsets(this.settings,t),t!==this.score){this.ue=t,this.xm=e,this.jm=null,this.dm=[];for(const t of e)this.dm.push(t.index);this.Bm=new Set(this.dm),this.Xm(t),this.loadMidiForScore(),this.render()}else{this.xm=e;const s=Vt.computeFirstDisplayedBarIndex(t,this.settings),i=Vt.computeLastDisplayedBarIndex(t,this.settings,s);this.jm&&(this.jm.multiBarRestInfo=Vt.buildMultiBarRestInfo(this.tracks,s,i)),this.dm=[];for(const t of e)this.dm.push(t.index);this.Bm=new Set(this.dm),this.render()}}triggerResize(){if(this.container.isVisible){const t=new Ta;t.oldWidth=this.hp.width,t.newWidth=this.container.width,t.settings=this.settings,this.vm(t),this.hp.updateSettings(this.settings),this.hp.width=this.container.width,this.hp.resizeRender()}else z.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{z.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}Em(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this.Jm&&(this.Jm.width=t.totalWidth,this.Jm.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}Fm(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new $e;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(t){this.onError(t)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this.sp.resetSoundFonts()}render(){this.uiFacade.canRender?(this.hp.width=this.container.width,this.hp.renderScore(this.score,this.dm)):this.uiFacade.canRenderChanged.on(()=>this.render())}jm=null;get tickCache(){return this.jm}get boundsLookup(){return this.hp.boundsLookup}get player(){return this.sp.instance?this.sp:null}get isReadyForPlayback(){return this.sp.isReadyForPlayback}get playerState(){return this.sp.state}get masterVolume(){return this.sp.masterVolume}set masterVolume(t){this.sp.masterVolume=t}get metronomeVolume(){return this.sp.metronomeVolume}set metronomeVolume(t){this.sp.metronomeVolume=t}get countInVolume(){return this.sp.countInVolume}set countInVolume(t){this.sp.countInVolume=t}get midiEventsPlayedFilter(){return this.sp.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this.sp.midiEventsPlayedFilter=t}get tickPosition(){return this.sp.tickPosition}set tickPosition(t){this.sp.tickPosition=t}get timePosition(){return this.sp.timePosition}set timePosition(t){this.sp.timePosition=t}get endTick(){return this.sp.currentPosition.endTick}get endTime(){return this.sp.currentPosition.endTime}get playbackRange(){return this.sp.playbackRange}set playbackRange(t){this.sp.playbackRange=t,this.qm(t)}get playbackSpeed(){return this.sp.playbackSpeed}set playbackSpeed(t){this.sp.playbackSpeed=t}get isLooping(){return this.sp.isLooping}set isLooping(t){this.sp.isLooping=t}Ym(){this.sp.destroy(),this.Km=0,this.Qm()}Am(){let t=this.settings.player.playerMode;if(t===ms.EnabledAutomatic){const e=this.score;if(!e)return!1;t=e?.backingTrack?.rawAudioFile?ms.EnabledBackingTrack:ms.EnabledSynthesizer}let e=null;if(t===this.Tm)return this.Zm(),!1;switch(this.Ym(),this.Zm(),t){case ms.Disabled:e=null;break;case ms.EnabledSynthesizer:e=this.uiFacade.createWorkerPlayer();break;case ms.EnabledBackingTrack:e=this.uiFacade.createBackingTrackPlayer();break;case ms.EnabledExternalMedia:e=new Ia(this.settings.player.bufferTimeInMilliseconds)}return this.Tm=t,!!e&&(this.sp.instance=e,!1)}loadMidiForScore(){if(!this.score)return;const t=this.score;z.debug("AlphaTab","Generating Midi");const e=new Ti,s=new ua(e),i=new xa(t,this.settings,s),n=Vt.computeFirstDisplayedBarIndex(t,this.settings),r=Vt.computeLastDisplayedBarIndex(t,this.settings,n);i.tickLookup.multiBarRestInfo=Vt.buildMultiBarRestInfo(this.tracks,n,r),i.applyTranspositionPitches=!1,i.generate(),this.jm=i.tickLookup,this.tg(e);const a=this.sp;a.loadMidiFile(e),a.loadBackingTrack(t),a.updateSyncPoints(i.syncPoints),a.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const t=this.score;this.sp.updateSyncPoints(xa.generateSyncPoints(t))}changeTrackVolume(t,e){for(const s of t)this.sp.setChannelVolume(s.playbackInfo.primaryChannel,e),this.sp.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this.sp.setChannelSolo(s.playbackInfo.primaryChannel,e),this.sp.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this.sp.setChannelMute(s.playbackInfo.primaryChannel,e),this.sp.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this.sp.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this.sp.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this.sp.play()}pause(){this.sp.pause()}playPause(){this.sp.playPause()}stop(){this.sp.stop()}playBeat(t){const e=new Ti,s=new ua(e);new xa(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this.sp.playOneTimeMidiFile(e)}playNote(t){const e=new Ti,s=new ua(e);new xa(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this.sp.playOneTimeMidiFile(e)}Jm=null;eg=null;sg=null;ig=null;Km=0;Mm=null;ng=null;rg=!0;ag=ss.Paused;hg=null;og=0;Qm(){this.Jm&&(this.uiFacade.destroyCursors(),this.Jm=null,this.eg=null,this.sg=null,this.ig=null)}Zm(){const t=this.cg;if(t&&!this.Jm){const t=this.uiFacade.createCursors();t&&(this.Jm=t.cursorWrapper,this.eg=t.barCursor,this.sg=t.beatCursor,this.ig=t.selectionWrapper,this.rg=!0),null!==this.Mm&&this.lg(this.Mm,!1,this.Km>10,1,!0)}else!t&&this.Jm&&this.Qm()}ug(t,e,s,i=!1,n=!1){this.Km=t;const r=this.jm;if(r){const a=this.Bm;if(null!=a&&a.size>0){const h=r.findBeat(a,t,this.Mm);h&&this.lg(h,e,i,s,n||this.playerState===ss.Paused)}}}lg(t,e,s,i,n=!1){const r=t.beat,a=t.nextBeat?.beat??null,h=t.duration,o=t.beatLookup.highlightedBeats;if(!r)return;const c=this.hp.boundsLookup;if(!c)return;const l=this.Mm,u=this.hg,d=this.ag;if(!n&&r===l?.beat&&c===u&&d===this.sp.state&&l?.start===t.start)return;const f=c.findBeat(r);f&&(this.Mm=t,this.hg=c,this.ag=this.sp.state,this.uiFacade.beginInvoke(()=>{this.dg(r,a,h,e,o,c,f,s,t.cursorMode,i)}))}scrollToCursor(){const t=this.ng;t&&this.fg(t.barBounds.masterBarBounds)}fg(t){const e=this.uiFacade.getScrollContainer(),s=tu.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,i=this.settings.player.scrollMode;if(s){const s=t.realBounds.y+this.settings.player.scrollOffsetY;if(s!==this.og)switch(this.og=s,i){case ps.Continuous:const i=this.uiFacade.getOffset(e,this.container);this.uiFacade.scrollToY(e,i.y+s,this.settings.player.scrollSpeed);break;case ps.OffScreen:const n=e.scrollTop+this.uiFacade.getOffset(null,e).h;if(t.visualBounds.y+t.visualBounds.h>=n||t.visualBounds.y<e.scrollTop){const s=t.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(e,s,this.settings.player.scrollSpeed)}}}else{const s=t.visualBounds.x;if(s!==this.og)switch(this.og=s,i){case ps.Continuous:const s=t.realBounds.x+this.settings.player.scrollOffsetX;this.og=t.visualBounds.x,this.uiFacade.scrollToX(e,s,this.settings.player.scrollSpeed);break;case ps.OffScreen:const i=e.scrollLeft+this.uiFacade.getOffset(null,e).w;if(t.visualBounds.x+t.visualBounds.w>=i||t.visualBounds.x<e.scrollLeft){const s=t.realBounds.x+this.settings.player.scrollOffsetX;this.og=t.visualBounds.x,this.uiFacade.scrollToX(e,s,this.settings.player.scrollSpeed)}}}}dg(t,e,s,i,n,r,a,h,o,c){const l=this.eg,u=this.sg,d=a.barBounds.masterBarBounds,f=d.visualBounds,p=this.ng;this.ng=a,l&&l.setBounds(f.x,f.y,f.w,f.h);const b=this.sp.state===ss.Playing&&!i;let m=d.visualBounds.x+d.visualBounds.w;if(e&&o===ys.ToNextBext){const t=r.findBeat(e);t&&t.barBounds.masterBarBounds.staffSystemBounds===d.staffSystemBounds&&(m=t.onNotesX)}let g=a.onNotesX;if(u){if(this.settings.player.enableAnimatedBeatCursor){const t=m-a.onNotesX,e=this.Km-this.Mm.start,i=this.Mm.tickDuration>0?e/this.Mm.tickDuration:0;if(g=a.onNotesX+t*i,s-=s*i,b){(!p||this.rg||f.y!==p.barBounds.masterBarBounds.visualBounds.y||g<p.onNotesX||d.index>p.barBounds.masterBarBounds.index+1)&&(u.transitionToX(0,g),u.setBounds(g,f.y,1,f.h)),this.uiFacade.beginInvoke(()=>{const t=o===ys.ToNextBext?2:1,e=g+(m-g)*t;u.transitionToX(s/c*t,e)})}else u.transitionToX(0,g),u.setBounds(g,f.y,1,f.h)}else u.transitionToX(0,g),u.setBounds(g,f.y,1,f.h);this.rg=!1}else this.rg=!0;this.uiFacade.removeHighlights();let w=!1;if(b){if(this.settings.player.enableElementHighlighting)for(const e of n){const s=Ca.getGroupId(e.beat);this.uiFacade.highlightElements(s,t.voice.bar.index)}h=!i,w=!0}h&&!this.pg&&this.settings.player.scrollMode!==ps.Off&&this.fg(d),w&&(this.bg(t),this.mg(new Da(n.map(t=>t.beat))))}playedBeatChanged;bg(t){this._m||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}activeBeatsChanged;mg(t){this._m||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}pg=!1;gg=!1;wg=null;yg=null;beatMouseDown=new Te;beatMouseMove=new Te;beatMouseUp=new Te;noteMouseDown=new Te;noteMouseMove=new Te;noteMouseUp=new Te;get cg(){return this.settings.player.playerMode!==ms.Disabled&&this.settings.player.enableCursor}kg(t,e){this._m||(this.cg&&this.settings.player.enableUserInteraction&&(this.wg=new $a(e),this.yg=null),this.pg=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}Sg(t,e){this._m||(this.gg=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}Bg(t,e){this._m||(this.settings.player.enableUserInteraction&&(this.yg&&this.yg.beat===e||(this.yg=new $a(e),this._g(this.wg,this.yg))),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}xg(t,e){this._m||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}Tg(t,e){if(!this._m){if(this.cg&&this.settings.player.enableUserInteraction){if(this.yg){const t=this.jm?.getBeatStart(this.wg.beat)??this.wg.beat.absolutePlaybackStart;if((this.jm?.getBeatStart(this.yg.beat)??this.yg.beat.absolutePlaybackStart)<t){const t=this.wg;this.wg=this.yg,this.yg=t}}if(this.wg&&this.jm){const t=this.jm,e=t.getMasterBarStart(this.wg.beat.voice.bar.masterBar);if(this.Mm=null,this.sp.state===ss.Paused&&this.ug(this.jm.getBeatStart(this.wg.beat),!1,1),this.tickPosition=e+this.wg.beat.playbackStart,this.yg&&this.wg.beat!==this.yg.beat){const s=t.getMasterBarStart(this.yg.beat.voice.bar.masterBar),i=new Ga;i.startTick=e+this.wg.beat.playbackStart,i.endTick=s+this.yg.beat.playbackStart+this.yg.beat.playbackDuration-50,this.playbackRange=i}else this.wg=null,this.playbackRange=null,this._g(this.wg,this.yg)}}this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this.pg=!1}}Mg(t,e){this._m||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this.gg=!1)}qm(t){if(this.jm)if(t){const e=this.jm.findBeat(this.Bm,t.startTick),s=this.jm.findBeat(this.Bm,t.endTick);if(e&&s){const t=new $a(e.beat),i=new $a(s.beat);this._g(t,i)}}else this._g(null,null)}Dm(){this.canvasElement.mouseDown.on(t=>{if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.hp.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.kg(t,i),this.settings.core.includeNoteBounds)){const n=this.hp.boundsLookup?.getNoteAtPos(i,e,s);n&&this.Sg(t,n)}}),this.canvasElement.mouseMove.on(t=>{if(!this.pg)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.hp.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.Bg(t,i),this.gg)){const n=this.hp.boundsLookup?.getNoteAtPos(i,e,s);n&&this.xg(t,n)}}),this.canvasElement.mouseUp.on(t=>{if(!this.pg)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.hp.boundsLookup?.getBeatAtPos(e,s)??null;if(this.Tg(t,i),this.gg)if(i){const n=this.hp.boundsLookup?.getNoteAtPos(i,e,s)??null;this.Mg(t,n)}else this.Mg(t,null)}),this.hp.postRenderFinished.on(()=>{this.wg&&this.cg&&this.settings.player.enableUserInteraction&&this._g(this.wg,this.yg)})}_g(t,e){const s=this.hp.boundsLookup;if(!s)return;const i=this.ig;if(!i)return;if(i.clear(),!t||!e||t.beat===e.beat)return;t.bounds||(t.bounds=s.findBeat(t.beat)),e.bounds||(e.bounds=s.findBeat(e.beat));const n=this.jm?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart;if((this.jm?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart)<n){const s=t;t=e,e=s}const r=t.bounds.realBounds.x;let a=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(a=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const n=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,h=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,o=this.uiFacade.createSelectionElement();o.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(o);const c=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,l=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let t=c;t<l;t++){const e=s.staffSystems[t],r=this.uiFacade.createSelectionElement();r.setBounds(n,e.visualBounds.y,h-n,e.visualBounds.h),i.appendChild(r)}const u=this.uiFacade.createSelectionElement();u.setBounds(n,e.bounds.barBounds.masterBarBounds.visualBounds.y,a-n,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(u)}else{const e=this.uiFacade.createSelectionElement();e.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,a-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(e)}}scoreLoaded;Xm(t){this._m||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this.Am()||this.loadMidiForScore())}resize=new Te;vm(t){this._m||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}renderStarted=new Te;Nm(t){this._m||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}renderFinished=new Te;gs(t){this._m||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}postRenderFinished=new xe;Pm(){this._m||(this.Mm=null,this.ug(this.Km,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}error=new Te;onError(t){this._m||(z.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this.sp.readyForPlayback}Lm(){this._m||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this.sp.finished}Vm(){this._m||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this.sp.soundFontLoaded}Wm(){this._m||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}midiLoad=new Te;tg(t){this._m||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}midiLoaded;Om(t){this._m||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this.sp.stateChanged}Rm(t){if(!this._m){if(!t.stopped&&t.state===ss.Paused){const t=this.Mm,e=this.jm;t&&e&&(this.sp.tickPosition=e.getBeatStart(t.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this.sp.positionChanged}Im(t){this._m||(this.Km=t.currentTick,this.uiFacade.beginInvoke(()=>{const e=t.modifiedTempo/t.originalTempo;this.ug(t.currentTick,!1,e,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t))}get midiEventsPlayed(){return this.sp.midiEventsPlayed}Gm(t){this._m||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this.sp.playbackRangeChanged}$m(t){this._m||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}settingsUpdated=new xe;Um(){this._m||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this.sp.output.enumerateOutputDevices()}async setOutputDevice(t){await this.sp.output.setOutputDevice(t)}async getOutputDevice(){return await this.sp.output.getOutputDevice()}async exportAudio(t){if(!this.score)throw new W(s.General,"No song loaded");let e;if(this.Tm===ms.EnabledSynthesizer)e=this.uiFacade.createWorkerAudioExporter(this.sp.instance);else e=this.uiFacade.createWorkerAudioExporter(null);const i=this.score,n=new Ti,r=new ua(n),a=new xa(i,this.settings,r);a.applyTranspositionPitches=!1,a.generate();const h=new tr;h.soundFonts=t.soundFonts,h.sampleRate=t.sampleRate,h.useSyncPoints=t.useSyncPoints,h.masterVolume=t.masterVolume,h.metronomeVolume=t.metronomeVolume,h.playbackRange=t.playbackRange;for(const[e,s]of t.trackVolume)if(e<this.score.tracks.length){const t=this.score.tracks[e];h.trackVolume.set(t.playbackInfo.primaryChannel,s),h.trackVolume.set(t.playbackInfo.secondaryChannel,s)}for(const[e,s]of t.trackTranspositionPitches)if(e<this.score.tracks.length){const t=this.score.tracks[e];h.trackTranspositionPitches.set(t.playbackInfo.primaryChannel,s),h.trackTranspositionPitches.set(t.playbackInfo.secondaryChannel,s)}return await e.initialize(h,n,a.syncPoints,a.transpositionPitches),e}}class Ha extends W{xhr;constructor(t,e){super(s.General,t),this.xhr=e}}class Ua{static loadAlphaTex(t,e){const s=new $e;return s.logErrors=!0,s.initFromString(t,e??new Fr),s.readScore()}static loadScoreAsync(t,e,s,i){const n=new XMLHttpRequest;n.open("GET",t,!0,null,null),n.responseType="arraybuffer",n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){const t=n.response;if(200===n.status||0===n.status&&t)try{const t=n.response,s=new Uint8Array(t),r=Ua.loadScoreFromBytes(s,i);e(r)}catch(t){s(t)}else 0===n.status?s(new Ha("You are offline!!\n Please Check Your Network.",n)):404===n.status?s(new Ha("Requested URL not found.",n)):500===n.status?s(new Ha("Internel Server Error.",n)):"parsererror"===n.statusText?s(new Ha("Error.\nParsing JSON Request failed.",n)):"timeout"===n.statusText?s(new Ha("Request Time out.",n)):s(new Ha(`Unknow Error: ${n.responseText}`,n))}},n.send()}static loadScoreFromBytes(t,e){e||(e=new Fr);const s=tu.buildImporters();z.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const n=Re.fromBuffer(t);for(const t of s){n.reset();try{z.debug("ScoreLoader",`Importing using importer ${t.name}`),t.init(n,e),i=t.readScore(),z.debug("ScoreLoader",`Score imported using ${t.name}`);break}catch(e){if(!(e instanceof Oe))throw z.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;z.debug("ScoreLoader",`${t.name} does not support the file`)}}if(i)return i;throw new Oe("No compatible importer found for file")}}class za{mouseEvent;get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(t){const e=t.element,s=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(t){const e=t.element,s=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(t){this.mouseEvent=t}}class ja{static vg=new H(()=>new ResizeObserver(t=>{for(const e of t){const t=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(t)}}));Ng=0;get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){this.element.style.height=t>=0?`${t}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}element;constructor(t){this.element=t,this.mouseDown={on:t=>{const e=e=>{t(new za(e))};return this.element.addEventListener("mousedown",e,!0),()=>{this.element.removeEventListener("mousedown",e,!0)}},off:t=>{}},this.mouseUp={on:t=>{const e=e=>{t(new za(e))};return this.element.addEventListener("mouseup",e,!0),()=>{this.element.removeEventListener("mouseup",e,!0)}},off:t=>{}},this.mouseMove={on:t=>{const e=e=>{t(new za(e))};return this.element.addEventListener("mousemove",e,!0),()=>{this.element.removeEventListener("mousemove",e,!0)}},off:t=>{}};const e=this;this.resize={on:function(t){return 0===e.Ng&&ja.vg.value.observe(e.element),e.element.addEventListener("resize",t,!0),e.Ng++,()=>this.off(t)},off:t=>{this.element.removeEventListener("resize",t,!0),this.Ng--,this.Ng<=0&&(this.Ng=0,ja.vg.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}lastBounds=new Ne;setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}resize;mouseDown;mouseMove;mouseUp;appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerHTML=""}}class Xa{Pg;jf;Eg=!1;isFontLoaded=!1;fontLoaded=new Te;constructor(t){this.Pg=t,this.jf=t}checkForFontAvailability(){if(tu.isRunningInWorker)return void(this.isFontLoaded=!1);if(this.Eg)return;this.Eg=!0;let t=0;const e=window.setInterval(()=>{z.warning("Rendering",`Could not load font '${this.jf[0]}' within ${5*(t+1)} seconds`,null),this.jf.length>1?(this.jf.shift(),t=0):t++},5e3);z.debug("Font",`Start checking for font availablility: ${this.jf.join(", ")}`);const s=t=>{this.jf.length>1?(z.debug("Font",`[${this.jf[0]}] Loading Failed, switching to ${this.jf[1]}`,t),this.jf.shift(),window.setTimeout(()=>{n()},0)):(z.error("Font",`[${this.Pg.join(",")}] Loading Failed, rendering cannot start`,t),window.clearInterval(e))},i=t=>{z.debug("Font",`[${t}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(e),this.fontLoaded.trigger(this.jf[0])},n=async()=>{for(const t of this.jf)if(await this.Fg(t,!1))return void i(t);try{await document.fonts.load(`1em ${this.jf[0]}`)}catch(t){s(t)}return z.debug("Font",`[${this.jf[0]}] Font API signaled loaded`),await this.Fg(this.jf[0],!0)?i(this.jf[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{n()})}Fg(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){z.debug("Font",`Font ${t} not available, creating test element to trigger load`);const e=document.createElement("div");e.style.font=i,e.style.opacity="0",e.style.position="absolute",e.style.top="0",e.style.left="0",e.innerText=`Trigger ${t} load`,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class Ja extends Si{Cg=null;yl;kl=0;Sl=0;open(t){super.open(t),this.kl=Math.floor(t*this.sampleRate/1e3/Si.BufferSize),this.yl=new gi(Si.BufferSize*this.kl),this.onReady()}play(){super.play();const t=this.context;this.Cg=t.createScriptProcessor(4096,0,2),this.Cg.onaudioprocess=this.Ag.bind(this),this.yl.clear(),this._l(),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.Cg,0,0),this.source.start(0),this.Cg.connect(t.destination,0,0)}pause(){super.pause(),this.Cg&&this.Cg.disconnect(0),this.Cg=null}addSamples(t){this.yl.write(t,0,t.length),this.Sl--}resetSamples(){this.yl.clear()}_l(){const t=this.kl/2|0,e=t*Si.BufferSize;if(this.yl.count+this.Sl*Si.BufferSize<e){for(let e=0;e<t;e++)this.onSampleRequest();this.Sl+=t}}wl=new Float32Array(0);Ag(t){const e=t.outputBuffer.getChannelData(0),s=t.outputBuffer.getChannelData(1),i=e.length+s.length;let n=this.wl;n.length!==i&&(n=new Float32Array(i),this.wl=n);const r=this.yl.read(n,0,Math.min(n.length,this.yl.count));let a=0;const h=Math.min(e.length,r);for(let t=0;t<h;t++)e[t]=n[a++],s[t]=n[a++];if(r<e.length)for(let t=r;t<e.length;t++)e[t]=0,s[t]=0;this.onSamplesPlayed(r/It.AudioChannels),this._l()}}class qa{Ef;Hi;Dg=!1;Lg=!1;Wg=!1;oi=ss.Paused;fm=0;yf=0;kf=0;pm=0;bm=!1;Og=null;gm=[];_f;Ld=new ji(0,0,0,0,!1,120,120);get output(){return this.Hi}get isReady(){return this.Lg&&this.Wg}get isReadyForPlayback(){return this.Dg}get state(){return this.oi}get logLevel(){return z.logLevel}get worker(){return this.Ef}set logLevel(t){z.logLevel=t,this.Ef.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this.fm}set masterVolume(t){t=Math.max(t,It.MinVolume),this.fm=t,this.Ef.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this.yf}set metronomeVolume(t){t=Math.max(t,It.MinVolume),this.yf=t,this.Ef.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this.kf}set countInVolume(t){t=Math.max(t,It.MinVolume),this.kf=t,this.Ef.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this.gm}set midiEventsPlayedFilter(t){this.gm=t,this.Ef.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:tu.prepareForPostMessage(t)})}get playbackSpeed(){return this.pm}set playbackSpeed(t){t=Vt.clamp(t,It.MinPlaybackSpeed,It.MaxPlaybackSpeed),this.pm=t,this.Ef.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this.Ld}get tickPosition(){return this.Ld.currentTick}set tickPosition(t){t<0&&(t=0),this.Ld=new ji(this.Ld.currentTime,this.Ld.endTime,t,this.Ld.endTick,!0,this.Ld.originalTempo,this.Ld.modifiedTempo),this.Ef.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this.Ld.currentTime}set timePosition(t){t<0&&(t=0),this.Ld=new ji(t,this.Ld.endTime,this.Ld.currentTick,this.Ld.endTick,!0,this.Ld.originalTempo,this.Ld.modifiedTempo),this.Ef.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this.bm}set isLooping(t){this.bm=t,this.Ef.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this.Og}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this.Og=t,this.Ef.postMessage({cmd:"alphaSynth.setPlaybackRange",value:tu.prepareForPostMessage(t)})}constructor(t,e){this.Dg=!1,this.Lg=!1,this.Wg=!1,this.oi=ss.Paused,this.fm=0,this.yf=0,this.pm=0,this.bm=!1,this.Og=null,this.Hi=t,this.Hi.ready.on(this.Rg.bind(this)),this.Hi.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this.Hi.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this.Hi.open(e.player.bufferTimeInMilliseconds);try{this.Ef=tu.createWebWorker(e)}catch(t){z.error("AlphaSynth",`Failed to create WebWorker: ${t}`)}this.Ef.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this.Ef.postMessage({cmd:"alphaSynth.initialize",sampleRate:this.Hi.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this.Ef.postMessage({cmd:"alphaSynth.destroy"})}play(){return this.Hi.activate(),this.Ef.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this.Ef.postMessage({cmd:"alphaSynth.pause"})}playPause(){this.Hi.activate(),this.Ef.postMessage({cmd:"alphaSynth.playPause"})}stop(){this.Ef.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this.Ef.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:ra.midiFileToJsObject(tu.prepareForPostMessage(t))})}loadSoundFont(t,e){this.Ef.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:tu.prepareForPostMessage(t),append:e})}resetSoundFonts(){this.Ef.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this.Ef.postMessage({cmd:"alphaSynth.loadMidi",midi:ra.midiFileToJsObject(tu.prepareForPostMessage(t))})}applyTranspositionPitches(t){this.Ef.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(tu.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this.Ef.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this.Ef.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this.Ef.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this.Ef.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,It.MinVolume),this.Ef.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this.Lg=!0,this.Ig();break;case"alphaSynth.destroyed":this.Ef.terminate();break;case"alphaSynth.readyForPlayback":this.Dg=!0,this.xf();break;case"alphaSynth.positionChanged":this.Ld=new ji(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this.Ld);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Qn(e.events.map(ra.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this.oi=e.state,this.stateChanged.trigger(new zi(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this.Og=e.playbackRange,this.playbackRangeChanged.trigger(new Zn(this.Og));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this.xf(),this._f=new ji(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this._f);break;case"alphaSynth.midiLoadFailed":this.xf(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this.Hi.addSamples(e.samples);break;case"alphaSynth.output.play":this.Hi.play();break;case"alphaSynth.output.pause":this.Hi.pause();break;case"alphaSynth.output.destroy":this.Hi.destroy();break;case"alphaSynth.output.resetSamples":this.Hi.resetSamples()}}Ig(){this.isReady&&this.ready.trigger()}xf(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}ready=new xe;readyForPlayback=new xe;finished=new xe;soundFontLoaded=new xe;soundFontLoadFailed=new Te;midiLoaded=new Te;midiLoadFailed=new Te;stateChanged=new Te;positionChanged=new Te;midiEventsPlayed=new Te;playbackRangeChanged=new Te;onOutputSampleRequest(){this.Ef.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this.Ef.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}Rg(){this.Wg=!0,this.Ig()}loadBackingTrack(t){}updateSyncPoints(t){}}class Ya{Gg;ll;um=0;boundsLookup=null;constructor(t,e){this.Gg=t;try{this.ll=tu.createWebWorker(e)}catch(t){return void z.error("Rendering",`Failed to create WebWorker: ${t}`)}this.ll.postMessage({cmd:"alphaTab.initialize",settings:this.$g(e)}),this.ll.addEventListener("message",this.Vg.bind(this))}destroy(){this.ll.terminate()}updateSettings(t){this.ll.postMessage({cmd:"alphaTab.updateSettings",settings:this.$g(t)})}$g(t){const e=ra.settingsToJsObject(tu.prepareForPostMessage(t));return e.delete("player"),e}render(){this.ll.postMessage({cmd:"alphaTab.render"})}resizeRender(){this.ll.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this.ll.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this.um}set width(t){this.um=t,this.ll.postMessage({cmd:"alphaTab.setWidth",width:t})}Vg(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=Ce.fromJson(e.boundsLookup,this.Gg.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error)}}renderScore(t,e){const s=null==t?null:ra.scoreToJsObject(tu.prepareForPostMessage(t));this.ll.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:tu.prepareForPostMessage(e),fontSizes:oa.fontSizeLookupTables})}preRender=new Te;partialRenderFinished=new Te;partialLayoutFinished=new Te;renderFinished=new Te;postRenderFinished=new xe;error=new Te}class Ka{cursorWrapper;barCursor;beatCursor;selectionWrapper;constructor(t,e,s,i){this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}class Qa extends ja{Hg;Ug;constructor(t,e,s){super(t),this.Hg=e,this.Ug=s}get width(){return this.element.offsetWidth/this.Hg}set width(t){this.element.style.width=t*this.Hg+"px"}get height(){return this.element.offsetHeight/this.Ug}set height(t){this.element.style.height=t>=0?t*this.Ug+"px":"100%"}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this.Hg,Number.isNaN(i)?i=this.lastBounds.h:i/=this.Ug,this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}}class Za{sampleRate=44100;audioElement;zg=0;get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?1e3*t:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this.jg()}),e.addEventListener("timeupdate",()=>{this.jg()}),this.audioElement=e,this.ready.trigger()}jg(){const t=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(t)}play(){this.audioElement.play(),this.zg=window.setInterval(()=>{this.jg()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this.zg)}addSamples(t){}resetSamples(){}activate(){}ready=new xe;samplesPlayed=new Te;timeUpdate=new Te;sampleRequest=new xe;async enumerateOutputDevices(){return ki.enumerateOutputDevices()}async setOutputDevice(t){await ki.checkSinkIdSupport()&&(t?await this.audioElement.setSinkId(t.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await ki.checkSinkIdSupport())return null;const t=this.audioElement.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=ki.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(z.warning("WebAudio","Could not find output device in device list",t,s),null)}}class th{static Xg=1;ll;Jg;qg;Yg;Kg=null;constructor(t,e){this.qg=th.Xg++,this.ll=t,this.Yg=e}async initialize(t,e,s,i){const n=this.handleWorkerMessage.bind(this);this.ll.worker.addEventListener("message",n,!1),this.Jg=()=>{this.ll.worker.removeEventListener("message",n,!1)},this.Kg=Promise.withResolvers(),this.ll.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this.qg,options:tu.prepareForPostMessage(t),midi:ra.midiFileToJsObject(tu.prepareForPostMessage(e)),syncPoints:tu.prepareForPostMessage(s),transpositionPitches:tu.prepareForPostMessage(i)}),await this.Kg.promise}handleWorkerMessage(t){const e=t.data;if(e.exporterId!==this.qg)return;switch(e.cmd){case"alphaSynth.exporter.initialized":this.Kg?.resolve(null),this.Kg=null;break;case"alphaSynth.exporter.error":this.Kg?.reject(e.error),this.Kg=null;break;case"alphaSynth.exporter.rendered":this.Kg?.resolve(e.chunk),this.Kg=null;break;case"alphaSynth.destroyed":this.Kg?.reject(new W(s.General,"Worker was destroyed")),this.Kg=null}}async render(t){if(this.Kg)throw new W(s.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this.Kg=Promise.withResolvers(),this.ll.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this.qg,milliseconds:t}),await this.Kg.promise}destroy(){this.ll.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this.qg}),this.Jg(),this.Yg&&this.ll.destroy()}[Symbol.dispose](){this.destroy()}}!function(t){t[t.LayoutDone=0]="LayoutDone",t[t.RenderRequested=1]="RenderRequested",t[t.RenderDone=2]="RenderDone",t[t.Detached=3]="Detached"}(ks||(ks={}));class eh{Qg=new Map;Gg;Zg=null;tw=null;ew=0;sw=null;iw;nw=new Map;rw=new Map;aw;rootContainerBecameVisible=new xe;canRenderChanged=new xe;get resizeThrottle(){return 10}rootContainer;areWorkersSupported;get canRender(){return this.hw()}hw(){let t=!1;for(const e of this.Qg.values())e.isFontLoaded||(t=!0);return!t&&(z.debug("Font",`All fonts loaded: ${this.Qg.size}`),!0)}ow(t){oa.generateFontLookup(t),this.hw()&&this.canRenderChanged.trigger()}constructor(t){if(tu.webPlatform!==gs.Browser&&tu.webPlatform!==gs.BrowserModule)throw new W(s.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");t.classList.add("alphaTab"),this.rootContainer=new ja(t),this.areWorkersSupported="Worker"in window,this.iw=new IntersectionObserver(this.cw.bind(this),{threshold:[0,.01,1]}),this.iw.observe(t)}cw(t){for(const e of t){const t=e.target;if(t===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this.iw.unobserve(this.rootContainer.element));else if("layoutResultId"in t&&this.Gg.settings.core.enableLazyLoading){const s=t;e.isIntersecting?s.renderedResultId!==s.layoutResultId?this.rw.has(s.layoutResultId)?s.resultState!==ks.RenderRequested&&(s.resultState=ks.RenderRequested,this.Gg.renderer.renderResult(s.layoutResultId)):t.replaceChildren():s.resultState===ks.Detached&&(t.replaceChildren(...s.renderedResult),s.resultState=ks.RenderDone):s.resultState===ks.RenderDone&&(s.resultState=ks.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new Ya(this.Gg,this.Gg.settings)}initialize(t,e){let s;this.Gg=t,s=e instanceof Fr?e:ra.jsObjectToSettings(e);const i=this.lw();Pr.fromJson(s,i),s.notation.notationMode===S.SongBook&&s.setSongBookModeSettings(),t.settings=s,this.uw(s),this.sw=this.parseTracks(s.core.tracks),this.Zg="";const n=t.container;s.core.tex&&(this.Zg=n.element.innerHTML,n.element.innerHTML=""),this.dw(s),this.tw=s.core.file}uw(t){this.fw(t.display.resources.copyrightFont),this.fw(t.display.resources.effectFont),this.fw(t.display.resources.graceFont),this.fw(t.display.resources.markerFont),this.fw(t.display.resources.tablatureFont),this.fw(t.display.resources.titleFont),this.fw(t.display.resources.wordsFont),this.fw(t.display.resources.barNumberFont),this.fw(t.display.resources.fretboardNumberFont),this.fw(t.display.resources.subTitleFont)}fw(t){if(!this.Qg.has(t.families.join(", "))){const e=new Xa(t.families);this.Qg.set(t.families.join(", "),e),e.fontLoaded.on(this.ow.bind(this)),e.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";const t=this.aw;t.usages--,t.usages<=0&&(t.element.remove(),eh.pw.delete(t.hash))}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this.aw.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new ja(t)}triggerEvent(t,e,s=null,i){const n=t.element;e=`alphaTab.${e}`;const r=document.createEvent("CustomEvent"),a=i?i.mouseEvent:null;if(r.initCustomEvent(e,!1,!1,s),a&&(r.originalEvent=a),n.dispatchEvent(r),window&&"jQuery"in window){const t=window.jQuery,i=[];i.push(s),a&&i.push(a),t(n).trigger(e,i)}}load(t,e,s){if(t instanceof Ot)return e(t),!0;if(t instanceof ArrayBuffer){const s=new Uint8Array(t);return e(Ua.loadScoreFromBytes(s,this.Gg.settings)),!0}return t instanceof Uint8Array?(e(Ua.loadScoreFromBytes(t,this.Gg.settings)),!0):"string"==typeof t&&(Ua.loadScoreAsync(t,e,s,this.Gg.settings),!0)}loadSoundFont(t,e){return!!this.Gg.player&&(t instanceof ArrayBuffer?(this.Gg.player.loadSoundFont(new Uint8Array(t),e),!0):t instanceof Uint8Array?(this.Gg.player.loadSoundFont(t,e),!0):"string"==typeof t&&(this.Gg.loadSoundFontFromUrl(t,e),!0))}initialRender(){this.Gg.renderer.preRender.on(t=>{this.ew=0,this.rw.clear(),this.nw.clear()});const t=()=>{this.Gg.renderer.width=0|this.rootContainer.width,this.Gg.renderer.updateSettings(this.Gg.settings),this.Zg?(this.Gg.tex(this.Zg,this.sw??void 0),this.sw=null):this.tw&&Ua.loadScoreAsync(this.tw,t=>{this.Gg.renderScore(t,this.sw??void 0),this.sw=null},t=>{this.Gg.onError(t)},this.Gg.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}dw(t){const e=this.Gg.container.element.ownerDocument;eh.createSharedStyleElement(e);const s=t.core.smuflFontSources??eu.buildDefaultSmuflFontSources(t.core.fontDirectory),i=eh.bw(s.values()),n=eh.pw;if(n.has(i)){const t=n.get(i);return t.usages++,t.checker.fontLoaded.on(this.ow.bind(this)),void(this.aw=t)}const r=0===n.size?"":String(n.size),a=`alphaTab${r}`,h=`\n            @font-face {\n                font-display: block;\n                font-family: '${a}';\n                src: ${Array.from(s.entries()).map(t=>`url(${JSON.stringify(t[1])}) format('${eh.mw(t[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${r} .at {\n                font-family: '${a}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,o=e.createElement("style");o.id=`alphaTabStyle${r}`,o.innerHTML=h,e.getElementsByTagName("head").item(0).appendChild(o);const c=new Xa([a]);c.fontLoaded.on(this.ow.bind(this)),this.Qg.set(a,c),c.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=a;const l={hash:i,element:o,fontSuffix:r,usages:1,checker:c};n.set(i,l),this.aw=l}static mw(t){switch(t){case uh.EmbeddedOpenType:return"embedded-opentype";case uh.Woff:return"woff";case uh.Woff2:return"woff2";case uh.OpenType:return"opentype";case uh.TrueType:return"truetype";case uh.Svg:return"svg"}}static pw=new Map;static bw(t,e=0){let s=3735928559^e,i=1103547991^e;for(const e of t)for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);s=Math.imul(s^n,2654435761),i=Math.imul(i^n,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");if(!e){e=document.createElement("style"),e.id="alphaTabStyleShared";const t="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";e.innerHTML=t,document.getElementsByTagName("head").item(0).appendChild(e)}}parseTracks(t){if(!t)return[];const e=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch{t=[0]}if("number"==typeof t)e.push(t);else if("length"in t){const s=t.length,i=t;for(let t=0;t<s;t++){const s=i[t];let n=0;n="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(n>=0||-1===n)&&e.push(n)}}else"index"in t&&e.push(t.index);return e}lw(){const t=new Map,e=this.Gg.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{const t=i;i=JSON.parse(t)}catch{""===i&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),n=i.nodeName;if(n.startsWith("data-")){const e=n.substr(5).split("-");let s=e[0];for(let t=1;t<e.length;t++)s+=e[t].substr(0,1).toUpperCase()+e[t].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}t.set(s,r)}}return t}beginUpdateRenderResults(t){if(!this.rw.has(t.id))return;const e=this.rw.get(t.id),s=t.renderResult;"string"==typeof s?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=ks.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this.Gg.canvasElement.element;if(t){let s;this.ew<e.childElementCount?s=e.childNodes.item(this.ew):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=ks.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,this.rw.set(t.id,s);for(let e=t.firstMasterBarIndex;e<=t.lastMasterBarIndex;e++)e>=0&&this.nw.set(e,s);this.Gg.settings.core.enableLazyLoading&&(this.iw.unobserve(s),this.iw.observe(s)),this.ew++}else for(;e.childElementCount>this.ew;)this.Gg.settings.core.enableLazyLoading&&this.iw.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let t=null;const e="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this.Gg.settings.player.outputMode===bs.WebAudioAudioWorklets?(z.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new qa(new _i(this.Gg.settings),this.Gg.settings)):e&&(z.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),t=new qa(new Ja,this.Gg.settings)),t?t.ready.on(()=>{this.Gg.settings.player.soundFont&&this.Gg.loadSoundFontFromUrl(this.Gg.settings.player.soundFont,!1)}):z.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}createWorkerAudioExporter(t){const e=null===t||!(t instanceof qa);return e&&(t=this.createWorkerPlayer()),new th(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}gw=[];highlightElements(t,e){const s=this.nw.get(e);if(s){const e=s.getElementsByClassName(t);for(let t=0;t<e.length;t++)e.item(t).classList.add("at-highlight"),this.gw.push(e.item(t))}}removeHighlights(){const t=this.gw;if(t){for(const e of t)e.classList.remove("at-highlight");this.gw=[]}}destroyCursors(){const t=this.Gg.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this.Gg.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),n=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");const a=n.element;return a.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),a.style.position="absolute",a.style.transition="all 0s linear",a.style.left="0",a.style.top="0",a.style.willChange="transform",n.width=3,n.height=1,n.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(r),e.appendChild(a),new Ka(new ja(e),i,n,new ja(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let n=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const e=t.element,s=e.nodeName.toLowerCase();if("html"!==s&&"body"!==s){const s=this.getOffset(null,t);n=n+e.scrollTop-s.y,r=r+e.scrollLeft-s.x}}const a=new Ne;return a.x=r,a.y=n,a.w=i.width,a.h=i.height,a}ww=null;getScrollContainer(){if(this.ww)return this.ww;let t="string"==typeof this.Gg.settings.player.scrollElement?document.querySelector(this.Gg.settings.player.scrollElement):this.Gg.settings.player.scrollElement;const e=t.nodeName.toLowerCase();if("html"===e||"body"===e)if("scrollingElement"in document)t=document.scrollingElement;else{t=-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement}return this.ww=new ja(t),this.ww}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new Qa(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this.yw(t.element,e,s)}scrollToX(t,e,s){this.kw(t.element,e,s)}yw(t,e,s){if(this.Gg.settings.player.nativeBrowserSmoothScroll)t.scrollTo({top:e,behavior:"smooth"});else{const i=t.scrollTop,n=e-i;let r=0;const a=e=>{0===r&&(r=e);const h=e-r,o=Math.min(h/s,1);t.scrollTop=i+n*o|0,h<s&&window.requestAnimationFrame(a)};window.requestAnimationFrame(a)}}kw(t,e,s){if(this.Gg.settings.player.nativeBrowserSmoothScroll)t.scrollTo({left:e,behavior:"smooth"});else{const i=t.scrollLeft,n=e-i;let r=0;const a=e=>{0===r&&(r=e);const h=e-r,o=Math.min(h/s,1);t.scrollLeft=i+n*o|0,h<s&&window.requestAnimationFrame(a)};window.requestAnimationFrame(a)}}createBackingTrackPlayer(){return new Oa(new Za,this.Gg.settings.player.bufferTimeInMilliseconds)}}class sh{loaded;total;constructor(t,e){this.loaded=t,this.total=e}}class ih extends Va{constructor(t,e){super(new eh(t),e)}tex(t,e){const s=this.uiFacade;super.tex(t,s.parseTracks(e))}print(t,e=null){const s=window.open("","","width=0,height=0"),i=s.document.createElement("div");t?i.style.width=t:this.settings.display.layoutMode===Ft.Horizontal?i.style.width="297mm":i.style.width="210mm",s.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const n=this.score;n&&(n.artist&&n.title?s.document.title=`${n.title} - ${n.artist}`:n.title&&(s.document.title=`${n.title}`)),s.document.body.appendChild(i);const r=void 0!==window.screenLeft?window.screenLeft:window.left,a=void 0!==window.screenTop?window.screenTop:window.top,h="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,o="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,c=i.offsetWidth+50,l=window.innerHeight,u=(h/2|0)-(c/2|0)+r,d=(o/2|0)-(l/2|0)+a;s.resizeTo(c,l),s.moveTo(u,d),s.focus();const f=ra.jsObjectToSettings(ra.settingsToJsObject(this.settings));f.core.enableLazyLoading=!1,f.core.useWorkers=!0,f.core.file=null,f.core.tracks=null,f.player.enableCursor=!1,f.player.playerMode=ms.Disabled,f.player.enableElementHighlighting=!1,f.player.enableUserInteraction=!1,f.player.soundFont=null,f.display.scale=.8,f.display.stretchForce=.8,Pr.fromJson(f,e);const p=new ih(i,f);s.onunload=()=>{p.destroy()},p.renderer.postRenderFinished.on(()=>{s.print()}),p.renderTracks(this.tracks)}downloadMidi(t=ts.SingleTrackMultiChannel){if(!this.score)return;const e=new Ti;e.format=t;const s=new ua(e,!0);new xa(this.score,this.settings,s).generate();const i=e.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=n;const a=new Blob([i],{type:"audio/midi"}),h=URL.createObjectURL(a);r.href=h,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(t,e){const s=this.Sw(this.uiFacade.parseTracks(t));super.changeTrackMute(s,e)}changeTrackSolo(t,e){const s=this.Sw(this.uiFacade.parseTracks(t));super.changeTrackSolo(s,e)}changeTrackVolume(t,e){const s=this.Sw(this.uiFacade.parseTracks(t));super.changeTrackVolume(s,e)}Sw(t){if(!this.score)return[];const e=[];if(1===t.length&&-1===t[0])for(const t of this.score.tracks)e.push(t);else for(const s of t)s>=0&&s<this.score.tracks.length&&e.push(this.score.tracks[s]);return e}soundFontLoad=new Te;loadSoundFontFromUrl(t,e){const s=this.player;if(!s)return;z.debug("AlphaSynth",`Start loading Soundfont from url ${t}`);const i=new XMLHttpRequest;i.open("GET",t,!0,null,null),i.responseType="arraybuffer",i.onload=t=>{const s=new Uint8Array(i.response);this.loadSoundFont(s,e)},i.onerror=t=>{z.error("AlphaSynth",`Loading failed: ${t.message}`),s.soundFontLoadFailed.trigger(new Ha(t.message,i))},i.onprogress=t=>{z.debug("AlphaSynth",`Soundfont downloading: ${t.loaded}/${t.total} bytes`);const e=new sh(t.loaded,t.total);this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)},i.send()}}class nh{exec(t,e,s){if("string"!=typeof e&&(s=[e],e="init"),95===e.charCodeAt(0)||"exec"===e)return null;const i=new jQuery(t),n=i.data("alphaTab");if("destroy"===e&&!n)return null;if("init"!==e&&!n)throw new Error("alphaTab not initialized");const r=this[e];if(r){const t=[i,n].concat(s);return r.apply(this,t)}return z.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new ih(t[0],s),t.data("alphaTab",e);for(const i of this.Bw)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return"number"==typeof s&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return"number"==typeof s&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return"number"==typeof s&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return"number"==typeof s&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return"number"==typeof s&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return"number"==typeof s&&(e.timePosition=s),e.timePosition}loop(t,e,s){return"boolean"==typeof s&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}Bw=[];_w(t){this.Bw.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}var rh,ah,hh,oh,ch,lh,uh,dh="function"==typeof SuppressedError?SuppressedError:function(t,e,s){var i=new Error(s);return i.name="SuppressedError",i.error=t,i.suppressed=e,i};class fh{static xw;static Tw=null;static enable(t,e){fh.xw=e,fh.initializeMusicFont(fh.xw.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){fh.Tw=new fh.xw.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,e){const s=fh.xw.AlphaSkiaTypeface.register(t.buffer);return e||(e=or.withFamilyList([s.familyName],12,s.isItalic?ls.Italic:ls.Plain,s.weight>400?us.Bold:us.Regular)),e}bp;gp=new pe(0,0,0,0);kp=0;Mw=null;Nw=1;Pw=new Map;wp=new or("Arial",10,ls.Plain);Ew=null;settings;get font(){return this.wp}set font(t){if(this.wp===t)return;this.wp=t;const e=this.Fw(t);if(this.Pw.has(e))this.Mw=this.Pw.get(e);else{const s=new fh.xw.AlphaSkiaTextStyle(t.families,t.weight===us.Bold?700:400,t.isItalic);this.Pw.set(e,s),this.Mw=s}}Fw(t){return[...t.families,t.weight.toString(),t.isItalic?"italic":"upright"].join("_")}constructor(){this.bp=new fh.xw.AlphaSkiaCanvas,this.color=new pe(0,0,0,255)}destroy(){this.bp[Symbol.dispose]();for(const t of this.Pw.values())t[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,e){this.Nw=this.settings.display.scale,this.bp.beginRender(t,e,tu.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==fh.Tw.familyNames[0]?this.Pw.has(s)?this.Ew=this.Pw.get(s):(this.Ew=new fh.xw.AlphaSkiaTextStyle([s],fh.Tw.weight,fh.Tw.isItalic),this.Pw.set(s,this.Ew)):this.Ew=fh.Tw}endRender(){return this.bp.endRender()}get color(){return this.gp}set color(t){this.gp.rgba!==t.rgba&&(this.gp=t,this.bp.color=fh.xw.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this.kp}set lineWidth(t){this.kp=t,this.bp.lineWidth=t}fillRect(t,e,s,i){s>0&&this.bp.fillRect(t*this.Nw,e*this.Nw,s*this.Nw,i*this.Nw)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.bp.strokeRect(t*this.Nw+n,e*this.Nw+n,s*this.Nw,i*this.Nw)}beginPath(){this.bp.beginPath()}closePath(){this.bp.closePath()}moveTo(t,e){this.bp.moveTo(t*this.Nw,e*this.Nw)}lineTo(t,e){this.bp.lineTo(t*this.Nw,e*this.Nw)}quadraticCurveTo(t,e,s,i){this.bp.quadraticCurveTo(t*this.Nw,e*this.Nw,s*this.Nw,i*this.Nw)}bezierCurveTo(t,e,s,i,n,r){this.bp.bezierCurveTo(t*this.Nw,e*this.Nw,s*this.Nw,i*this.Nw,n*this.Nw,r*this.Nw)}fillCircle(t,e,s){this.bp.fillCircle(t*this.Nw,e*this.Nw,s*this.Nw)}strokeCircle(t,e,s){this.bp.strokeCircle(t*this.Nw,e*this.Nw,s*this.Nw)}fill(){this.bp.fill()}stroke(){this.bp.stroke()}textAlign=et.Left;textBaseline=st.Top;beginGroup(t){}endGroup(){}fillText(t,e,s){if(0===t.length)return;let i=fh.xw.AlphaSkiaTextAlign.Left;switch(this.textAlign){case et.Left:i=fh.xw.AlphaSkiaTextAlign.Left;break;case et.Center:i=fh.xw.AlphaSkiaTextAlign.Center;break;case et.Right:i=fh.xw.AlphaSkiaTextAlign.Right}let n=fh.xw.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case st.Top:n=fh.xw.AlphaSkiaTextBaseline.Top;break;case st.Middle:n=fh.xw.AlphaSkiaTextBaseline.Middle;break;case st.Bottom:n=fh.xw.AlphaSkiaTextBaseline.Bottom;break;case st.Alphabetic:n=fh.xw.AlphaSkiaTextBaseline.Alphabetic}this.bp.fillText(t,this.Mw,this.wp.size*this.Nw,e*this.Nw,s*this.Nw,i,n)}measureText(t){const e={stack:[],error:void 0,hasError:!1};try{const s=function(t,e,s){if(null!=e){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object expected.");var i,n;if(s){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=e[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose],s&&(n=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");n&&(i=function(){try{n.call(this)}catch(t){return Promise.reject(t)}}),t.stack.push({value:e,dispose:i,async:s})}else s&&t.stack.push({async:!0});return e}(e,this.bp.measureText(t,this.Mw,this.wp.size,fh.xw.AlphaSkiaTextAlign.Left,fh.xw.AlphaSkiaTextBaseline.Alphabetic),!1),[i,n]=this.Cw(s,t);return new At(i,n)}catch(t){e.error=t,e.hasError=!0}finally{!function(t){function e(e){t.error=t.hasError?new dh(e,t.error,"An error was suppressed during disposal."):e,t.hasError=!0}var s,i=0;(function n(){for(;s=t.stack.pop();)try{if(!s.async&&1===i)return i=0,t.stack.push(s),Promise.resolve().then(n);if(s.dispose){var r=s.dispose.call(s.value);if(s.async)return i|=2,Promise.resolve(r).then(n,function(t){return e(t),n()})}else i|=1}catch(t){e(t)}if(1===i)return t.hasError?Promise.reject(t.error):Promise.resolve();if(t.hasError)throw t.error})()}(e)}}Cw(t,e){let s=t.width;if(e.length>0&&s<1)for(let e=0;e<5&&(s=t.width,!(s>1));e++);return[s,t.actualBoundingBoxAscent+t.actualBoundingBoxDescent]}fillMusicFontSymbol(t,e,s,i,n){i!==rt.None&&this.Sp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==rt.None&&(r+=String.fromCharCode(t));this.Sp(t,e,s,r,n)}Sp(t,e,s,i,n){this.bp.fillText(i,this.Ew,this.settings.display.resources.engravingSettings.musicFontSize*this.Nw*s,t*this.Nw,e*this.Nw,n?fh.xw.AlphaSkiaTextAlign.Center:fh.xw.AlphaSkiaTextAlign.Left,fh.xw.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(t,e,s){this.bp.beginRotate(t*this.Nw,e*this.Nw,s)}endRotate(){this.bp.endRotate()}}class ph{buffer="";Aw="";Dw=!0;scale=1;color=new pe(255,255,255,255);lineWidth=1;font=new or("Arial",10,ls.Plain);textAlign=et.Left;textBaseline=st.Top;settings;destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|t}px" height="${0|e}px" class="at-surface-svg">\n`,this.Aw="",this.Dw=!0,this.textBaseline=st.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale}" y="${e*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(t,e,s,i){const n=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${t*this.scale+n}" y="${e*this.scale+n}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this.Aw+=" z"}moveTo(t,e){this.Aw+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this.Dw=!1,this.Aw+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this.Dw=!1,this.Aw+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,n,r){this.Dw=!1,this.Aw+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${n*this.scale},${r*this.scale}`}fillCircle(t,e,s){this.Dw=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Aw+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this.Dw=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Aw+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this.Dw||(this.buffer+=`<path d="${this.Aw}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this.Aw="",this.Dw=!0}stroke(){if(!this.Dw){let t=`<path d="${this.Aw}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this.Aw="",this.Dw=!0}fillText(t,e,s){if(""===t)return;let i=`<text x="${e*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==et.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${ph.Lw(t)}</text>`,this.buffer+=i}static Lw(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case et.Left:return"start";case et.Center:return"middle";case et.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case st.Top:return"dominant-baseline: hanging";case st.Bottom:return"dominant-baseline: ideographic";case st.Alphabetic:return"";case st.Middle:return"dominant-baseline: middle";default:return""}}measureText(t){return t?oa.measureString(t,this.font.families,this.font.size,this.font.style,this.font.weight):new At(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class bh extends ph{fillMusicFontSymbol(t,e,s,i,n){i!==rt.None&&this.Sp(t,e,s,`&#${i};`,n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==rt.None&&(r+=`&#${t};`);this.Sp(t,e,s,r,n)}Sp(t,e,s,i,n){t*=this.scale,e*=this.scale,this.buffer+=`<g transform="translate(${t} ${e})" class="at" ><text`;const r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),n&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(et.Center)}"`),this.buffer+=`>${i}</text></g>`}}class mh{isInsideBracket=!0;isRelevantForBoundsLookup=!0;hideOnMultiTrack=!1;hideOnPercussionTrack=!1;canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}!function(t){t[t.PreNotes=0]="PreNotes",t[t.OnNotes=1]="OnNotes",t[t.MiddleNotes=2]="MiddleNotes",t[t.Stem=3]="Stem",t[t.PostNotes=4]="PostNotes",t[t.EndBeat=5]="EndBeat"}(rh||(rh={}));class gh extends Ma{glyphs=null;get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let t=0;const e=this.glyphs;if(e)for(const s of e){const e=s.getBoundingBoxTop();e<t&&(t=e)}return t}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let t=0,e=0;for(let s=0,i=this.glyphs.length;s<i;s++){const i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),t=Math.max(t,i.width),e=Math.max(e,i.y+i.height)}this.width=t,this.height=e}addGlyph(t){this.glyphs||(this.glyphs=[]),this.renderer&&(t.renderer=this.renderer),this.glyphs.push(t)}paint(t,e,s){const i=this.glyphs;if(i&&0!==i.length)for(const n of i)n.paint(t+this.x,e+this.y,s)}}class wh extends gh{gap=0;constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(t){t.x=this.width,t.renderer=this.renderer,t.doLayout(),this.width=t.x+t.width+this.gap,super.addGlyph(t)}}class yh{static score(t,e,s,i=!1){if(!s.style&&!i)return;const n=yh.Ww(t.settings.display.resources,e);return new kh(t,e,s.style,n)}static scoreColor(t,e,s){const i=yh.Ww(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Ww(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let n=t.settings.display.resources.mainGlyphColor;switch(e){case A.StandardNotationRepeats:case A.GuitarTabsRepeats:case A.SlashRepeats:case A.NumberedRepeats:case A.StandardNotationClef:case A.GuitarTabsClef:case A.StandardNotationKeySignature:case A.NumberedKeySignature:case A.StandardNotationTimeSignature:case A.GuitarTabsTimeSignature:case A.SlashTimeSignature:case A.NumberedTimeSignature:break;case A.StandardNotationBarLines:case A.GuitarTabsBarLines:case A.SlashBarLines:case A.NumberedBarLines:n=t.settings.display.resources.barSeparatorColor;break;case A.StandardNotationBarNumber:case A.SlashBarNumber:case A.NumberedBarNumber:case A.GuitarTabsBarNumber:n=t.settings.display.resources.barNumberColor;break;case A.StandardNotationStaffLine:case A.GuitarTabsStaffLine:case A.SlashStaffLine:case A.NumberedStaffLine:n=t.settings.display.resources.staffLineColor}return new kh(t,e,s.style,n)}static voice(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new kh(t,e,s.style,n)}static trackColor(t,e,s){const i=yh.Ow(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Ow(t,e){let s=t.mainGlyphColor;switch(e){case Et.TrackName:case Et.SystemSeparator:case Et.StringTuning:break;case Et.BracesAndBrackets:s=t.barSeparatorColor}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const n=yh.Ow(t.settings.display.resources,e);return new kh(t,e,s.style,n)}static beatColor(t,e,s){const i=yh.Rw(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Rw(t,e,s){return 0===s.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const n=yh.Rw(t.settings.display.resources,e,s);return new kh(t,e,s.style,n)}static noteColor(t,e,s){const i=yh.Iw(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static Iw(t,e,s){return 0===s.beat.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.beat.voice.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new kh(t,e,s.style,n)}}class kh{bp;Gw;constructor(t,e,s,i){this.bp=t,s&&s.colors.has(e)?(this.Gw=t.color,t.color=s.colors.get(e)??i):s||(this.Gw=t.color,t.color=i)}[Symbol.dispose](){this.Gw&&(this.bp.color=this.Gw)}}class Sh extends gh{static KeySizeBeat="Beat";beatGlyphs;voice;tupletGroups;constructor(t,e,s){super(t,e),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(t){const e=this.renderer.layoutingInfo.spaceToForce(t);this.$w(e)}$w(t){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(t);const e=this.renderer.layoutingInfo.buildOnTimePositions(t),s=this.beatGlyphs;for(let t=0,i=s.length;t<i;t++){const n=s[t];if(n.beat.graceType===l.None)n.x=e.get(n.beat.absoluteDisplayStart)-n.onTimeX;else{const i=n.beat.graceGroup.beats[0].absoluteDisplayStart,r=n.beat.graceGroup.id;if(n.beat.graceGroup.isComplete&&e.has(i)){n.x=e.get(i)-n.onTimeX;const t=this.renderer.layoutingInfo.allGraceRods.get(r),s=n.beat.graceGroup.beats[n.beat.graceGroup.beats.length-1].nextBeat,a=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;n.x-=a,n.x-=t[n.beat.graceIndex].postSpringWidth,n.x+=t[n.beat.graceIndex].graceBeatWidth;const h=t[n.beat.graceGroup.beats.length-1];n.x-=h.graceBeatWidth}else{const e=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=e[n.beat.graceIndex].postSpringWidth-e[n.beat.graceIndex].preSpringWidth;t>0?0===n.beat.graceIndex?n.x=s[t-1].x+s[t-1].width:n.x=s[t-1].x+e[n.beat.graceIndex-1].postSpringWidth-e[n.beat.graceIndex-1].preSpringWidth-i:n.x=-i}}if(t>0){const e=n.x-s[t-1].x;s[t-1].scaleToWidth(e)}if(t===i-1){const t=this.width-s[s.length-1].x;n.scaleToWidth(t)}}}registerLayoutingInfo(t){const e=this.beatGlyphs;for(const s of e)s.registerLayoutingInfo(t)}applyLayoutingInfo(t){const e=this.beatGlyphs;for(const s of e)s.applyLayoutingInfo(t);this.$w(Math.max(this.renderer.settings.display.stretchForce,t.minStretchForce))}addGlyph(t){const e=t;t.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,t.renderer=this.renderer,t.doLayout(),this.beatGlyphs.push(e),this.width=t.x+t.width,e.beat.hasTuplet&&e.beat.tupletGroup.beats[0].id===e.beat.id&&this.tupletGroups.push(e.beat.tupletGroup)}doLayout(){}paint(t,e,s){const i=yh.voice(s,L.Glyphs,this.voice,!0);try{for(let i=0,n=this.beatGlyphs.length;i<n;i++)this.beatGlyphs[i].paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class Bh{staffId="";up=0;down=0}class _h{startBeat=null;startX=0;startY=0;endBeat=null;endX=0;endY=0;calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class xh{Vw;Hw=new Map;hp;Uw=null;zw=null;voice=null;beats=[];shortestDuration=c.QuadrupleWhole;tremoloDuration;hasTuplet=!1;slashBeats=[];lowestNoteInHelper=null;jw=-1;highestNoteInHelper=null;Xw=-1;invertBeamDirection=!1;preferredBeamDirection=null;graceType=l.None;minRestLine=null;beatOfMinRestLine=null;maxRestLine=null;beatOfMaxRestLine=null;get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(t,e){return t&&this.Jw(e)||!t&&1===this.beats.length&&this.Jw(e)}Jw(t){return t.duration>c.Whole}hasFlag(t,e){return t&&this.qw(e)||!t&&1===this.beats.length&&this.qw(this.beats[0])}qw(t){return!t.deadSlapped&&!t.isRest&&(t.duration>c.Quarter||t.graceType!==l.None)}constructor(t,e){this.Vw=t,this.hp=e,this.beats=[]}getBeatLineX(t,e){return e=e??this.direction,this.hasBeatLineX(t)?e===Ct.Up?this.Hw.get(t.index).up:this.Hw.get(t.index).down:0}hasBeatLineX(t){return this.Hw.has(t.index)}registerBeatLineX(t,e,s,i){const n=this.Yw(e);n.staffId=t,n.up=s,n.down=i;for(const t of this.drawingInfos.values())t.startBeat===e?t.startX=this.getBeatLineX(e):t.endBeat===e&&(t.endX=this.getBeatLineX(e))}Yw(t){return this.Hw.has(t.index)||this.Hw.set(t.index,new Bh),this.Hw.get(t.index)}direction=Ct.Up;finish(){this.direction=this.Kw(),this.hp.completeBeamingHelper(this)}Kw(){if(!this.voice)return Ct.Up;if(null!==this.preferredBeamDirection)return this.preferredBeamDirection;if(this.voice.index>0)return this.Qw(Ct.Down);if(this.voice.bar.isMultiVoice)return this.Qw(Ct.Up);if(this.beats[0].graceType!==l.None)return this.Qw(Ct.Up);if(this.highestNoteInHelper&&this.lowestNoteInHelper){const t=(this.hp.getNoteY(this.highestNoteInHelper,hh.Center)+this.hp.getNoteY(this.lowestNoteInHelper,hh.Center))/2;return this.Qw(this.hp.middleYPosition<t?Ct.Up:Ct.Down)}return this.Qw(Ct.Up)}static computeLineHeightsForRest(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:return[2,2];case c.Whole:return[0,1];case c.Half:return[1,0];case c.Quarter:return[3,3];case c.Eighth:return[2,2];case c.Sixteenth:return[2,4];case c.ThirtySecond:return[4,4];case c.SixtyFourth:return[4,6];case c.OneHundredTwentyEighth:return[6,6];case c.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(t,e){if(this.zw&&t.index>=this.zw.index||this.Uw&&t.index<=this.Uw.index)return;let s=e,i=e;const n=xh.computeLineHeightsForRest(t.duration);s-=n[0],i+=n[1];const r=this.minRestLine,a=this.maxRestLine;(null===r||r>s)&&(this.minRestLine=s,this.beatOfMinRestLine=t),(null===a||a<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=t)}Qw(t){return this.invertBeamDirection?t===Ct.Down?Ct.Up:Ct.Down:t}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case gt.Auto:case gt.ForceSplitOnSecondaryToNext:e=xh.Zw(this.beats[this.beats.length-1],t);break;case gt.ForceSplitToNext:e=!1;break;case gt.ForceMergeWithNext:e=!0}return e&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<t.tremoloSpeed)&&(this.tremoloDuration=t.tremoloSpeed),t.graceType!==l.None&&(this.graceType=t.graceType),t.isRest?0===this.beats.length&&this.beats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this.ty(t.minNote),this.ty(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration),this.Uw||(this.Uw=t),this.zw=t),t.slashed&&this.slashBeats.push(t)),e}ty(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-di.getPercussionLine(this.voice.bar,di.getNoteValue(t)),s=e):(e=di.getNoteValue(t),s=e,t.harmonicType!==f.None&&t.harmonicType!==f.Natural&&(s=t.realValue-this.Vw.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this.jw)&&(this.lowestNoteInHelper=t,this.jw=e),(!this.highestNoteInHelper||s>this.Xw)&&(this.highestNoteInHelper=t,this.Xw=s)}static Zw(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===l.BendGrace||e.graceType===l.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==l.None&&e.graceType!==l.None)return!0;const s=t.voice.bar;if(s!==e.voice.bar)return!1;const i=t.playbackStart,n=e.playbackStart;if(!xh.ey(t.duration)||!xh.ey(e.duration))return i===n;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;let r=R.QuarterTime;if(8===s.masterBar.timeSignatureDenominator)s.masterBar.timeSignatureNumerator%3==0&&(r+=R.QuarterTime/2|0);return((r+i)/r|0)===((r+n)/r|0)}static ey(t){switch(t){case c.Whole:case c.Half:case c.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return Vt.getIndex(t.duration)-2-s>0&&Vt.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(t,e){return!this.Hw.has(e.index)||(this.Hw.get(e.index).staffId===t||!this.Hw.get(e.index).staffId)}drawingInfos=new Map}class Th{topY=0;bottomY=0;constructor(t,e){this.topY=t,this.bottomY=e}}class Mh{beat;topY=-1e3;bottomY=-1e3;slots=[];constructor(t){this.beat=t}addSlot(t,e){if(this.slots.push(new Th(t,e)),-1e3===this.topY)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class vh{reservedLayoutAreasByDisplayTime=new Map;restDurationsByDisplayTime=new Map;getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===t?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return-1e3===t?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new Mh(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=xh.computeLineHeightsForRest(t.duration).map(t=>t*s),n=e-i[0],r=e+i[1];let a=n;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let o=!1;for(const t of h.slots)if(n>=t.topY&&n<=t.bottomY||r>=t.topY&&r<=t.bottomY){o=!0;break}if(o){a=1===t.voice.index?h.topY-i[1]-i[0]:h.bottomY;const e=a+i[0]+i[1],r=2*s,o=Math.ceil(Math.abs(a-n)/r);return h.addSlot(a,e),a<n?o*-r:o*r}}return 0}}class Nh{hp;beamHelpers=[];beamHelperLookup=[];collisionHelper;preferredBeamDirection=null;constructor(t){this.hp=t,this.collisionHelper=new vh}initialize(){const t=this.hp,e=this.hp.bar;let s=null,i=null;for(let n=0,r=e.voices.length;n<r;n++){const r=e.voices[n];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let n=0,a=r.beats.length;n<a;n++){const a=r.beats[n];let h;a.graceType!==l.None?h=i:(h=s,i=null),h&&h.checkBeat(a)||(h&&h.finish(),h=new xh(e.staff,t),h.preferredBeamDirection=this.preferredBeamDirection,h.checkBeat(a),a.graceType!==l.None?i=h:s=h,this.beamHelpers[r.index].push(h)),this.beamHelperLookup[r.index].set(a.index,h)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(t){return this.beamHelperLookup[t.voice.index].get(t.index)}}class Ph extends va{static sy=5;iy;ny=0;hy=0;oy=0;constructor(t,e,s){super(t,e),this.iy=s}doLayout(){super.doLayout();const t=this.renderer.resources;this.ny=1.5*t.effectFont.size,this.hy=1.5*t.effectFont.size,this.iy.firstFret>1?this.oy=this.renderer.smuflMetrics.chordDiagramFretSpacing:this.oy=0,this.height=this.ny+this.hy+Ph.sy*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width=this.oy+(this.iy.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingX}paint(t,e,s){t+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this.oy,e+=this.y;const i=this.renderer.smuflMetrics.chordDiagramStringSpacing,n=this.renderer.smuflMetrics.chordDiagramFretSpacing,r=this.renderer.resources,a=r.engravingSettings.chordDiagramLineWidth,h=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this.oy+a,o=r.engravingSettings.glyphHeights.get(rt.FretboardFilledCircle),c=r.engravingSettings.glyphTop.get(rt.FretboardFilledCircle),l=r.engravingSettings.glyphHeights.get(rt.FretboardX)/2,u=r.engravingSettings.glyphHeights.get(rt.FretboardO)/2,d=s.textAlign,f=s.textBaseline;s.font=r.effectFont,s.textAlign=et.Center,s.textBaseline=st.Top,this.iy.showName&&s.fillText(this.iy.name,t+h/2,e+r.effectFont.size/2),e+=this.ny,s.font=r.fretboardNumberFont,s.textBaseline=st.Middle;for(let n=0;n<this.iy.strings.length;n++){const r=t+n*i,a=e+this.hy/2;let h=this.iy.strings[this.iy.strings.length-n-1];h<0?Dt.fillMusicFontSymbolSafe(s,r,a+l,1,rt.FretboardX,!0):0===h?Dt.fillMusicFontSymbolSafe(s,r,a+u,1,rt.FretboardO,!0):(h-=this.iy.firstFret-1,s.fillText(h.toString(),r,a))}e+=this.hy;for(let r=0;r<this.iy.strings.length;r++){const h=t+r*i;s.fillRect(h,e,a,n*Ph.sy+1)}this.iy.firstFret>1?(s.textAlign=et.Left,s.fillText(this.iy.firstFret.toString(),t-this.oy,e+n/2),s.fillRect(t,e,h,a)):s.fillRect(t,e-this.renderer.smuflMetrics.chordDiagramNutHeight/2,h,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let i=0;i<=Ph.sy;i++){const r=e+i*n;s.fillRect(t,r,h,this.renderer.smuflMetrics.chordDiagramFretHeight)}const p=new Map;for(const t of this.iy.barreFrets){const e=[-1,-1];p.set(t-this.iy.firstFret,e)}for(let r=0;r<this.iy.strings.length;r++){let h=this.iy.strings[r];if(h>0){if(h-=this.iy.firstFret,p.has(h)){const t=p.get(h);(-1===t[0]||r<t[0])&&(t[0]=r),(-1===t[1]||r>t[1])&&(t[1]=r)}const l=e+h*n+n/2+.5,u=t+(this.iy.strings.length-r-1)*i+a/2;Dt.fillMusicFontSymbolSafe(s,u,l+c-o/2,1,rt.FretboardFilledCircle,!0)}}for(const[r,a]of p){const h=e+r*n+n/2+.5,c=t+(this.iy.strings.length-a[1]-1)*i,l=t+(this.iy.strings.length-a[0]-1)*i;s.fillRect(c,h-o/2,l-c,o)}s.textAlign=d,s.textBaseline=f}}class Eh extends gh{ly=0;uy;constructor(t,e,s=et.Center){super(t,e),this.glyphs=[],this.uy=s}doLayout(){const t=this.renderer.smuflMetrics.rowContainerGap,e=this.ly-t;let s=0;switch(this.uy){case et.Left:s=0;break;case et.Center:s=(this.width-e)/2;break;case et.Right:s=this.width-e}for(const e of this.glyphs)e.x=s,s+=e.width+t}addGlyphToRow(t){this.glyphs.push(t),this.ly+=t.width+this.renderer.smuflMetrics.rowContainerGap,t.height>this.height&&(this.height=t.height)}}class Fh extends gh{py=[];uy;constructor(t,e,s=et.Center){super(t,e),this.height=0,this.glyphs=[],this.uy=s}doLayout(){let t=0,e=0;const s=this.renderer.smuflMetrics.rowContainerGap;this.py=[];let i=new Eh(t,e,this.uy);i.renderer=this.renderer,i.width=this.width;for(const n of this.glyphs){const r=t+n.width+s;r<this.width?(i.addGlyphToRow(n),t=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this.py.push(i),e+=i.height+s),t=0,i=new Eh(t,e,this.uy),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(n),t+=Math.ceil(n.width+s))}i.isEmpty||(i.doLayout(),this.py.push(i),e+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=e}paint(t,e,s){for(const i of this.py)i.paint(t+this.x,e+this.y,s)}}class Ch extends Fh{addChord(t){if(t.strings.length>0){const e=new Ph(0,0,t);e.renderer=this.renderer,e.doLayout(),this.glyphs.push(e)}}paint(t,e,s){if(this.glyphs.length>0){const i=yh.score(s,it.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Ah extends va{by;my=null;font;textAlign;textBaseline;colorOverride;constructor(t,e,s,i,n=et.Left,r=null,a){super(t,e),this.by=s.split("\n"),this.font=i,this.textAlign=n,this.textBaseline=r,this.colorOverride=a}doLayout(){super.doLayout(),this.my=[];const t=this.renderer.scoreRenderer.canvas;for(const e of this.by){t.font=this.font;const s=t.measureText(e),i=s.height;this.my.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const n=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let a=e+this.y;for(let e=0;e<this.by.length;e++)s.fillText(this.by[e],t+this.x,a),a+=this.my[e];s.textAlign=n,s.textBaseline=r,s.color=i}}class Dh{v;gy=new Map;staffTrackGroup;system;barRenderers=[];x=0;y=0;height=0;index=0;staffIndex=0;isFirstInSystem=!1;trackIndex=0;modelStaff;get staffId(){return this.v.staffId}staveTop=0;topSpacing=0;bottomSpacing=0;staveBottom=0;get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(t,e,s){this.v=s,this.trackIndex=t,this.modelStaff=e}getSharedLayoutData(t,e){return this.gy.has(t)?this.gy.get(t):e}setSharedLayoutData(t,e){this.gy.set(t,e)}get isInsideBracket(){return this.v.isInsideBracket}get isRelevantForBoundsLookup(){return this.v.isRelevantForBoundsLookup}registerStaffTop(t){this.staveTop=t}registerStaffBottom(t){this.staveBottom=t}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t)}addBar(t,e,s){const i=this.v.create(this.system.layout.renderer,t);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),i.registerLayoutingInfo();const n=i.barDisplayWidth;n>0&&this.system.layout.systemsLayoutMode===ah.FromModelWithWidths&&(i.width=n),this.barRenderers.push(i),t&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,t);for(const t of this.barRenderers)t.applyLayoutingInfo();return t}scaleToWidth(t){this.gy=new Map;const e=this.topOverflow;let s=0;switch(this.system.layout.systemsLayoutMode){case ah.Automatic:const i=(t-this.system.computedWidth)/this.barRenderers.length;for(const t of this.barRenderers){t.x=s,t.y=this.topSpacing+e;const n=t.computedWidth+i;t.scaleToWidth(n),s+=t.width}break;case ah.FromModelWithScale:t-=this.system.accoladeWidth;const n=this.system.totalBarDisplayScale;for(const i of this.barRenderers){i.x=s,i.y=this.topSpacing+e;const r=i.barDisplayScale*t/n;i.scaleToWidth(r),s+=i.width}break;case ah.FromModelWithWidths:for(const t of this.barRenderers){t.x=s,t.y=this.topSpacing+e;const i=t.barDisplayWidth;i>0?t.scaleToWidth(i):t.scaleToWidth(t.computedWidth),s+=t.width}}}get topOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const s=this.barRenderers[e];s.topOverflow>t&&(t=s.topOverflow)}return t}get bottomOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const s=this.barRenderers[e];s.bottomOverflow>t&&(t=s.bottomOverflow)}return t}calculateHeightForAccolade(){this.topSpacing=this.v.getStaffPaddingTop(this),this.bottomSpacing=this.v.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this.v.getStaffPaddingTop(this),this.bottomSpacing=this.v.getStaffPaddingBottom(this),this.height=0;let t=!1,e=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+e,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(t=!0);if(t){e=this.topOverflow;for(let t=0;t<this.barRenderers.length;t++)this.barRenderers[t].y=this.topSpacing+e;for(let t=0;t<this.barRenderers.length;t++)this.barRenderers[t].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+e+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(t,e,s,i,n){if(0!==this.height&&0!==n)for(let r=i,a=Math.min(i+n,this.barRenderers.length);r<a;r++)this.barRenderers[r].paint(t+this.x,e+this.y,s)}}class Lh{timePosition=0;longestDuration=0;smallestDuration=0;force=0;springConstant=0;get springWidth(){return this.preSpringWidth+this.postSpringWidth}preBeatWidth=0;graceBeatWidth=0;postSpringWidth=0;get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}allDurations=new Set}class Wh{static wy=30;static yy=7;ky=[];Sy=-1;By=0;_y=new Map;xy=0;Ty=Wh.wy;version=0;preBeatSize=0;postBeatSize=0;minStretchForce=0;totalSpringConstant=0;My(t){this.minStretchForce<t&&(this.minStretchForce=t)}getPreBeatSize(t){if(t.graceType!==l.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].preBeatWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).preBeatWidth:0}getPostBeatSize(t){if(t.graceType!==l.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].postSpringWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).postSpringWidth:0}incompleteGraceRods=new Map;allGraceRods=new Map;springs=new Map;addSpring(t,e,s,i,n){let r;if(this.version++,this.springs.has(t))r=this.springs.get(t),r.postSpringWidth<n&&(r.postSpringWidth=n),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),e<r.smallestDuration&&(r.smallestDuration=e),e>r.longestDuration&&(r.longestDuration=e),r.allDurations.add(e);else{if(r=new Lh,r.timePosition=t,r.allDurations.add(e),this.ky.length>0){const t=this.ky[this.ky.length-1];for(const e of t.allDurations)t.timePosition;e<this.Ty&&(this.Ty=e)}r.longestDuration=e,r.postSpringWidth=n,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(t,r);const a=this.ky;let h=a.length-1;for(;h>0&&a[h].timePosition>t;)h--;this.ky.splice(h+1,0,r)}return(-1===this.Sy||this.Sy>t)&&(this.Sy=t),r}addBeatSpring(t,e,s){const i=t.absoluteDisplayStart;if(t.graceType!==l.None){const n=t.graceGroup.id;this.allGraceRods.has(n)||this.allGraceRods.set(n,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(n)||this.incompleteGraceRods.set(n,new Array(t.graceGroup.beats.length));const r=this.allGraceRods.get(n)[t.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<e&&(r.preBeatWidth=e);else{const r=new Lh;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=e,t.graceGroup.isComplete||(this.incompleteGraceRods.get(n)[t.graceIndex]=r),this.allGraceRods.get(n)[t.graceIndex]=r}}else{let n=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const e of this.allGraceRods.get(t.graceGroup.id))n+=e.springWidth;this.addSpring(i,t.displayDuration,n,e,s)}}finish(){for(const[t,e]of this.allGraceRods){let t=0;for(const s of e)t+=s.preBeatWidth,s.graceBeatWidth=t,t+=s.postSpringWidth}this.xy=0;for(const t of this.incompleteGraceRods.values())for(const e of t)this.xy+=e.preBeatWidth+e.postSpringWidth;this.vy(),this.version++}vy(){let t=0;const e=this.ky;if(0===e.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<e.length;s++){const i=e[s];let n=0;if(s===e.length-1)n=i.longestDuration;else{const t=e[s+1];n=Math.abs(t.timePosition-i.timePosition)}i.springConstant=this.Ny(i,n),t+=1/i.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let t=0;t<e.length;t++){const s=e[t];let i=0;if(t===e.length-1)i=s.postSpringWidth;else{const n=e[t+1];i=s.postSpringWidth+n.preSpringWidth}0===t&&(i+=s.preSpringWidth);const n=i*s.springConstant;this.My(n)}}height=0;paint(t,e,s){}Ny(t,e){e<=0&&(e=R.toTicks(c.TwoHundredFiftySixth)),0===t.smallestDuration&&(t.smallestDuration=e);const s=t.smallestDuration,i=this.Ty,n=Wh.yy;return s/e*(1/((1+.85*Math.log2(e/i))*n))}spaceToForce(t){return-1!==this.totalSpringConstant?(this.ky.length>0&&(t-=this.ky[0].preSpringWidth),t-=this.xy,Math.max(t,0)*this.totalSpringConstant):-1}calculateVoiceWidth(t){let e=0;return-1!==this.totalSpringConstant&&(e=this.Py(t,this.totalSpringConstant)),this.ky.length>0&&(e+=this.ky[0].preSpringWidth),e+=this.xy,e}Py(t,e){return t/e}buildOnTimePositions(t){if(-1===this.totalSpringConstant)return new Map;if(Vt.isAlmostEqualTo(this.By,t)&&this._y)return this._y;this.By=t;const e=new Map;this._y=e;const s=this.ky;if(0===s.length)return e;let i=s[0].preSpringWidth;for(let n=0;n<s.length;n++)e.set(s[n].timePosition,i),i+=this.Py(t,s[n].springConstant);return e}}class Oh{width=0;isLinkedToPrevious=!1;canWrap=!0;masterBar;additionalMultiBarRestIndexes=null;get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}renderers=[];layoutingInfo}class Rh{track;staffSystem;staves=[];stavesRelevantForBoundsLookup=[];firstStaffInBracket=null;lastStaffInBracket=null;bracket=null;constructor(t,e){this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t),t.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(t)}}class Ih{firstStaffInBracket=null;lastStaffInBracket=null;drawAsBrace=!1;braceScale=1;width=0;index=0;finalizeBracket(t){if(this.firstStaffInBracket===this.lastStaffInBracket)return void(this.width=0);const e=t.glyphHeights.get(rt.Brace),s=t.glyphWidths.get(rt.Brace);if(this.drawAsBrace?this.width=s:this.width=t.bracketThickness,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;const i=this.firstStaffInBracket.contentTop,n=(this.lastStaffInBracket.contentBottom-i)/e;this.braceScale=n,this.width=s*this.braceScale}}class Gh extends Ih{track;constructor(t){super(),this.track=t,this.drawAsBrace=Gh.isTrackDrawAsBrace(t)}includesStaff(t){return t.modelStaff.track===this.track}static isTrackDrawAsBrace(t){return t.staves.filter(t=>t.showStandardNotation).length>1}}class $h extends Gh{includesStaff(t){return t.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}class Vh{Ey=[];Fy=null;Cy=null;Ay=!1;Un=[];Dy=!1;x=0;y=0;index=0;accoladeWidth=0;isFull=!1;width=0;computedWidth=0;totalBarDisplayScale=0;isLast=!1;masterBarsRenderers=[];staves=[];layout;topPadding;bottomPadding;constructor(t){this.layout=t,this.topPadding=t.renderer.settings.display.systemPaddingTop,this.bottomPadding=t.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(t,e){if(0===t.length)return null;this.masterBarsRenderers.push(e),e.layoutingInfo.preBeatSize=0;let s=0;for(let t=0,i=this.staves.length;t<i;t++){const i=this.staves[t];for(let t=0,n=i.staves.length;t<n;t++){const n=i.staves[t],r=e.renderers[s++];n.addBarRenderer(r)}}return this.Ly(t),this.Wy(),e}addBars(t,e,s){const i=new Oh;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Wh,i.masterBar=t[0].score.masterBars[e],this.masterBarsRenderers.push(i);const n=i.layoutingInfo;for(const t of this.staves)for(const r of t.staves){const a=t.track.staves[r.modelStaff.index].bars[e],h=null==s?null:s.map(e=>t.track.staves[r.modelStaff.index].bars[e]);r.addBar(a,n,h);const o=r.barRenderers[r.barRenderers.length-1];i.renderers.push(o),o.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),o.canWrap||(i.canWrap=!1)}return this.Ly(t),n.finish(),i.width=this.Wy(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){const t=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let e=0,s=0;for(let t=0,i=this.Ey.length;t<i;t++){const i=this.Ey[t].revertLastBar(),n=i.computedWidth;n>e&&(e=n);const r=i.barDisplayScale;r>s&&(s=r)}return this.width-=e,this.computedWidth-=e,this.totalBarDisplayScale-=s,t}return null}Wy(){let t=0,e=0;for(let s=0,i=this.Ey.length;s<i;s++){const i=this.Ey[s],n=i.barRenderers[i.barRenderers.length-1];n.applyLayoutingInfo(),n.computedWidth>t&&(t=n.computedWidth);const r=n.barDisplayScale;r>e&&(e=r)}return this.width+=t,this.computedWidth+=t,this.totalBarDisplayScale+=e,t}Ly(t){const e=this.layout.renderer.settings;if(!this.Ay){this.Ay=!0,this.accoladeWidth=0;const s=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(B.TrackNames)){const i=1===this.layout.renderer.tracks.length?s.singleTrackTrackNamePolicy:s.multiTrackTrackNamePolicy,n=0===this.index?s.firstSystemTrackNameMode:s.otherSystemsTrackNameMode,r=0===this.index?s.firstSystemTrackNameOrientation:s.otherSystemsTrackNameOrientation;let a=!1;switch(i){case T.Hidden:break;case T.FirstSystem:a=0===this.index;break;case T.AllSystems:a=!0}let h=!1;if(a){const s=this.layout.renderer.canvas,i=e.display.resources.effectFont;s.font=i;for(const e of t){let t="";switch(n){case M.FullName:t=e.name;break;case M.ShortName:t=e.shortName}if(t.length>0){h=!0;const e=s.measureText(t);switch(r){case v.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,e.width));break;case v.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,e.height))}}}h&&(this.accoladeWidth+=e.display.systemLabelPaddingLeft,this.accoladeWidth+=e.display.systemLabelPaddingRight)}}let i=0;for(const t of this.Ey)t.y=i,t.calculateHeightForAccolade(),i+=t.height;let n=0;for(const t of this.Un)t.finalizeBracket(e.display.resources.engravingSettings),n=Math.max(n,t.width);this.accoladeWidth+=n,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}Oy(t){for(let e=0,s=this.staves.length;e<s;e++){const s=this.staves[e];if(s.track===t)return s}return null}addStaff(t,e){let s=this.Oy(t);if(s||(s=new Rh(this,t),this.staves.push(s)),e.staffTrackGroup=s,e.system=this,e.index=this.Ey.length,this.Ey.push(e),s.addStaff(e),e.isInsideBracket){this.Fy||(this.Fy=e,e.isFirstInSystem=!0),s.firstStaffInBracket||(s.firstStaffInBracket=e),this.Cy=e,s.lastStaffInBracket=e;let i=this.Un.find(t=>t.includesStaff(e));if(!i)switch(t.score.stylesheet.bracketExtendMode){case x.NoBrackets:break;case x.GroupStaves:i=new Gh(t),i.index=this.Un.length,this.Un.push(i);break;case x.GroupSimilarInstruments:i=new $h(t),i.index=this.Un.length,this.Un.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=e),i.lastStaffInBracket=e,s.bracket=i)}}get height(){return 0===this.Ey.length?0:Math.ceil(this.Ey[this.Ey.length-1].y+this.Ey[this.Ey.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(t){for(let e=0,s=this.Ey.length;e<s;e++)this.Ey[e].scaleToWidth(t);this.width=t}paint(t,e,s){if(this.paintPartial(t+this.x,e+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this.Dy){const i=yh.track(s,Et.SystemSeparator,this.Ey[0].modelStaff.track);try{const i=this.layout.renderer.settings.display.resources.engravingSettings,n=Math.min(0,i.glyphBottom.get(rt.SystemDivider)??0);Dt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height+n,1,rt.SystemDivider,!1),Dt.fillMusicFontSymbolSafe(s,t+this.x+this.width-i.glyphWidths.get(rt.SystemDivider),e+this.y+this.height+n,1,rt.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(t,e,s,i,n){for(let r=0,a=this.Ey.length;r<a;r++)this.Ey[r].paint(t,e,s,i,n);const r=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===i){s.color=r.barSeparatorColor;const i=this.layout.renderer.settings,n=this.layout.renderer.settings.notation.isNotationElementVisible(B.TrackNames);if(s.font=r.effectFont,n){const n=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?n.singleTrackTrackNamePolicy:n.multiTrackTrackNamePolicy,a=0===this.index?n.firstSystemTrackNameMode:n.otherSystemsTrackNameMode,h=0===this.index?n.firstSystemTrackNameOrientation:n.otherSystemsTrackNameOrientation;let o=!1;switch(r){case T.Hidden:break;case T.FirstSystem:o=0===this.index;break;case T.AllSystems:o=!0}if(o){const n=s.textBaseline,r=s.textAlign;for(const n of this.staves)if(n.firstStaffInBracket&&n.lastStaffInBracket){const r=e+n.firstStaffInBracket.contentTop,o=e+n.lastStaffInBracket.contentBottom;let c="";switch(a){case M.FullName:c=n.track.name;break;case M.ShortName:c=n.track.shortName}const l=yh.track(s,Et.TrackName,n.track);try{if(c.length>0){const e=t+n.firstStaffInBracket.x-i.display.accoladeBarPaddingRight-(n.bracket?.width??0)-i.display.systemLabelPaddingRight;switch(h){case v.Horizontal:s.textBaseline=st.Middle,s.textAlign=et.Right,s.fillText(c,e,(r+o)/2);break;case v.Vertical:s.textBaseline=st.Bottom,s.textAlign=et.Center;const t=.1;s.beginRotate(e,(r+o)/2,-90-t),s.fillText(c,0,0),s.endRotate()}}}finally{l?.[Symbol.dispose]?.()}}s.textBaseline=n,s.textAlign=r}}if(this.Ey.length>0){let i=null;for(const n of this.Ey)if(n.isInsideBracket){if(null!==i){const a=i.contentBottom,h=n.contentTop,o=t+i.x,c=i.barRenderers[0],l=yh.bar(s,c.staffLineBarSubElement,c.bar);try{const t=Math.ceil(h-a);s.fillRect(o,e+a,r.engravingSettings.thinBarlineThickness,t)}finally{l?.[Symbol.dispose]?.()}}i=n}}for(const n of this.Un)if(n.firstStaffInBracket&&n.lastStaffInBracket){const r=t+n.firstStaffInBracket.x,a=n.width,h=i.display.accoladeBarPaddingRight;let o=e+n.firstStaffInBracket.contentTop,c=e+n.lastStaffInBracket.contentBottom;if(n.drawAsBrace)Dt.fillMusicFontSymbolSafe(s,r-h-a,c,n.braceScale,rt.Brace);else if(n.firstStaffInBracket!==n.lastStaffInBracket){const t=a/2;o-=t,c+=2*t,s.fillRect(r-h-a,o,a,Math.ceil(c-o));const e=r-h-a;Dt.fillMusicFontSymbolSafe(s,e,o,1,rt.BracketTop),Dt.fillMusicFontSymbolSafe(s,e,Math.floor(c),1,rt.BracketBottom)}}}}finalizeSystem(){const t=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=t.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=t.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const e=t.display.resources.engravingSettings.glyphHeights.get(rt.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,e),this.Dy=!0}let e=0;for(const t of this.Ey)t.x=this.accoladeWidth,t.y=e,t.finalizeStaff(),e+=t.height;for(const e of this.Un)e.finalizeBracket(t.display.resources.engravingSettings)}buildBoundingsLookup(t,e){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this.Fy,i=this.Cy;if(!s||!i)return;e+=this.topPadding;const n=this.Ey[this.Ey.length-1],r=e+this.y+s.y,a=e+this.y+i.y+i.height,h=e+this.y+this.Ey[0].y,o=e+this.y+n.y+n.height,c=e+this.y+s.y+s.topSpacing+s.topOverflow+(s.barRenderers.length>0?s.barRenderers[0].topPadding:0),l=a-r,u=e+this.y+n.y+n.height-n.bottomSpacing-n.bottomOverflow-(n.barRenderers.length>0?n.barRenderers[0].bottomPadding:0)-c,d=o-h,f=this.x+s.x,p=new Fe;p.visualBounds=new Ne,p.visualBounds.x=t+this.x,p.visualBounds.y=e+this.y,p.visualBounds.w=this.width,p.visualBounds.h=this.height-this.topPadding-this.bottomPadding,p.realBounds=new Ne,p.realBounds.x=t+this.x,p.realBounds.y=e+this.y,p.realBounds.w=this.width,p.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(p);const b=new Map;for(let t=0;t<this.staves.length;t++)for(const s of this.staves[t].stavesRelevantForBoundsLookup)for(const t of s.barRenderers){let i;b.has(t.bar.masterBar.index)?i=b.get(t.bar.masterBar.index):(i=new Pe,i.index=t.bar.masterBar.index,i.isFirstOfLine=t.isFirstOfLine,i.realBounds=new Ne,i.realBounds.x=f+t.x,i.realBounds.y=h,i.realBounds.w=t.width,i.realBounds.h=d,i.visualBounds=new Ne,i.visualBounds.x=f+t.x,i.visualBounds.y=r,i.visualBounds.w=t.width,i.visualBounds.h=l,i.lineAlignedBounds=new Ne,i.lineAlignedBounds.x=f+t.x,i.lineAlignedBounds.y=c,i.lineAlignedBounds.w=t.width,i.lineAlignedBounds.h=u,this.layout.renderer.boundsLookup.addMasterBar(i),b.set(i.index,i)),t.buildBoundingsLookup(i,f,e+this.y+s.y)}}getBarX(t){if(!this.Fy||0===this.layout.renderer.tracks.length)return 0;const e=this.layout.renderer.tracks[0].staves[0].bars[t];return this.layout.getRendererForBar(this.Fy.staffId,e).x}}class Hh extends Fh{constructor(t,e){super(t,e,et.Left)}}class Uh extends gh{Ry;Iy;colorOverride;constructor(t,e,s,i){super(t,e),this.Ry=s,this.Iy=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.Gy(this.Ry);for(const t of this.glyphs)t.renderer=this.renderer,t.doLayout()}}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(t,e,s),s.color=i}Gy(t){const e=this.renderer.resources;if(this.height=0,this.Iy.length>0){const t=new Ah(0,this.height,this.Iy,e.effectFont,et.Left);t.renderer=this.renderer,t.doLayout(),this.height+=t.height,this.addGlyph(t)}if(t.name.length>0){const s=new Ah(0,this.height,t.name,e.effectFont,et.Left);s.renderer=this.renderer,s.doLayout(),this.height+=s.height,this.addGlyph(s)}const s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(rt.GuitarString0)*s;this.renderer.scoreRenderer.canvas.font=e.effectFont;const n=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*e.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this.Iy).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(t.name).width,2*n)),!t.isStandard){const r=0|Math.ceil(t.tunings.length/2);let a=0;const h=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let o=h;for(let c=0,l=t.tunings.length;c<l;c++){const l=rt.GuitarString0+(c+1);this.addGlyph(new Na(a,o+i,s,l));const u=` = ${we.getTextForTuning(t.tunings[c],!1)}`;this.addGlyph(new Ah(a+i,o+i/2,u,e.effectFont,et.Left,st.Middle)),o+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const d=o;this.height<d&&(this.height=d),c===r-1&&(o=h,a+=n)}}}}class zh{args;renderCallback;constructor(t,e){this.args=t,this.renderCallback=e}}!function(t){t[t.Automatic=0]="Automatic",t[t.FromModelWithScale=1]="FromModelWithScale",t[t.FromModelWithWidths=2]="FromModelWithWidths"}(ah||(ah={}));class jh{$y=new Map;pagePadding=null;renderer;width=0;height=0;multiBarRestInfo=null;get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}headerGlyphs=new Map;footerGlyphs=new Map;chordDiagrams=null;tuningGlyph=null;systemsLayoutMode=ah.Automatic;constructor(t){this.renderer=t}resize(){this.Vy.clear(),this.doResize()}layoutAndRender(){this.Vy.clear();const t=this.renderer.score;this.firstBarIndex=Vt.computeFirstDisplayedBarIndex(t,this.renderer.settings),this.lastBarIndex=Vt.computeLastDisplayedBarIndex(t,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=Vt.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(t=>t/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.Hy(),this.doLayoutAndRender()}Vy=new Map;registerPartial(t,e){if(0===t.height)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this.Vy.set(t.id,new zh(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this.Uy(t,e))}Uy(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this.Vy.has(t)){const e=this.Vy.get(t);this.Uy(e.args,e.renderCallback)}}static headerElements=new H(()=>new Map([[it.Title,B.ScoreTitle],[it.SubTitle,B.ScoreSubTitle],[it.Artist,B.ScoreArtist],[it.Album,B.ScoreAlbum],[it.Words,B.ScoreWords],[it.Music,B.ScoreMusic],[it.WordsAndMusic,B.ScoreWordsAndMusic],[it.Transcriber,void 0]]));static footerElements=new H(()=>new Map([[it.Copyright,B.ScoreCopyright],[it.CopyrightSecondLine,void 0]]));zy(t,e,s,i){switch(s){case it.WordsAndMusic:if(e.words!==e.music)return;break;case it.Words:case it.Music:if(e.words===e.music)return;break;case it.CopyrightSecondLine:if(!this.footerGlyphs.has(it.Copyright))return}const n=t.display.resources,r=t.notation,a=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):Wt.defaultHeaderAndFooter.get(s);let h=void 0===a.isVisible||a.isVisible;if(void 0!==i&&(h=r.isNotationElementVisible(i)),!h)return;const o=a.buildText(e);return o?new Ah(0,0,o,n.getFontForElement(s),a.textAlign,void 0,yh.scoreColor(n,s,e)):void 0}Hy(){z.debug("ScoreLayout","Creating score info glyphs");const t=this.renderer.settings,e=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const s=new Qh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[i,n]of jh.headerElements.value){const r=this.zy(t,e,i,n);r&&(r.renderer=s,r.doLayout(),this.headerGlyphs.set(i,r))}for(const[i,n]of jh.footerElements.value){const r=this.zy(t,e,i,n);r&&(r.renderer=s,r.doLayout(),this.footerGlyphs.set(i,r))}const i=t.notation,n=t.display.resources;if(i.isNotationElementVisible(B.GuitarTuning)){const t=[];for(const s of this.renderer.tracks)for(const i of s.staves){let n=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(e.stylesheet.perTrackDisplayTuning&&e.stylesheet.perTrackDisplayTuning.has(s.index)&&!1===e.stylesheet.perTrackDisplayTuning.get(s.index)&&(n=!1),n){t.push(i);break}}if(t.length>0&&e.stylesheet.globalDisplayTuning){this.tuningGlyph=new Hh(0,0),this.tuningGlyph.renderer=s;for(const e of t)if(e.stringTuning.tunings.length>0){const i=t.length>1?e.track.name:"",r=new Uh(0,0,e.stringTuning,i);r.colorOverride=yh.trackColor(n,Et.StringTuning,e.track),r.renderer=s,r.doLayout(),this.tuningGlyph.addGlyph(r)}}else this.tuningGlyph=null}if(i.isNotationElementVisible(B.ChordDiagrams)){this.chordDiagrams=new Ch(0,0),this.chordDiagrams.renderer=s;const t=new Set;for(const s of this.renderer.tracks){if(e.stylesheet.globalDisplayChordDiagramsOnTop&&(null==e.stylesheet.perTrackChordDiagramsOnTop||!e.stylesheet.perTrackChordDiagramsOnTop.has(s.index)||e.stylesheet.perTrackChordDiagramsOnTop.get(s.index)))for(const e of s.staves){const s=e.chords;if(s)for(const[,e]of s)t.has(e.uniqueId)||e.showDiagram&&(t.add(e.uniqueId),this.chordDiagrams.addChord(e))}}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}firstBarIndex=0;lastBarIndex=0;createEmptyStaffSystem(){const t=new Vh(this);for(let e=0;e<this.renderer.tracks.length;e++){const s=this.renderer.tracks[e];for(let i=0;i<s.staves.length;i++){const n=s.staves[i],r=tu.staveProfiles.get(this.renderer.settings.display.staveProfile);for(const i of r)i.canCreate(s,n)&&t.addStaff(s,new Dh(e,n,i))}}return t}registerBarRenderer(t,e){if(this.$y.has(t)||this.$y.set(t,new Map),this.$y.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this.$y.get(t).set(s.id,e)}unregisterBarRenderer(t,e){if(this.$y.has(t)){const s=this.$y.get(t);if(s.delete(e.bar.id),e.additionalMultiRestBars)for(const t of e.additionalMultiRestBars)s.delete(t.id)}}getRendererForBar(t,e){const s=e.id;return this.$y.has(t)&&this.$y.get(t).has(s)?this.$y.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new _e;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,n=[];let r=0;for(const[t,e]of jh.footerElements.value)if(this.footerGlyphs.has(t)){const e=this.footerGlyphs.get(t);e.y=s,this.alignScoreInfoGlyph(e),s+=e.height,n.push(e),r=Math.max(r,Math.round(e.x+e.width))}return s=Math.round(s),n.length>0&&(e.width=r,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,t=>{t.color=i.scoreInfoColor,t.textAlign=et.Left,t.textBaseline=st.Top;for(const e of n)e.paint(0,0,t)})),t+s}alignScoreInfoGlyph(t){if(tu.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case et.Left:t.x=this.pagePadding[0];break;case et.Center:t.x=this.scaledWidth/2;break;case et.Right:t.x=this.scaledWidth-this.pagePadding[2]}else t.x=this.firstBarX,t.textAlign=et.Left}layoutAndRenderAnnotation(t){const e=this.renderer.settings.display.resources,s=or.withFamilyList(e.copyrightFont.families,12,ls.Plain,us.Bold),i=new Qh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),n=new Ah(0,0,"rendered by alphaTab",s,et.Center,void 0,e.mainGlyphColor);n.renderer=i,n.doLayout(),this.alignScoreInfoGlyph(n);const r=new _e;return r.width=n.x+n.width,r.x=0,r.height=12,r.y=t,r.totalWidth=this.scaledWidth,r.totalHeight=t+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,t=>{t.color=e.mainGlyphColor,t.font=s,t.textAlign=et.Left,t.textBaseline=st.Top,n.paint(0,0,t)}),t+12}}class Xh extends gh{jy=[];Xy=[];container;computedWidth=0;constructor(){super(0,0)}doLayout(){let t=0;if(this.glyphs)for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.x=t,s.renderer=this.renderer,s.doLayout(),t+=s.width}this.width=t,this.computedWidth=t}noteLoop(t){for(let e=this.container.beat.notes.length-1;e>=0;e--)t(this.container.beat.notes[e])}addEffect(t){super.addGlyph(t),this.jy.push(t)}addNormal(t){super.addGlyph(t),this.Xy.push(t)}get effectElement(){}paint(t,e,s){this.Jy(t,e,s),this.qy(t,e,s)}qy(t,e,s){for(const i of this.Xy)i.paint(t+this.x,e+this.y,s)}Jy(t,e,s){const i=this.effectElement?yh.beat(s,this.effectElement,this.container.beat):void 0;try{for(const i of this.jy)i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class Jh extends Xh{beamingHelper;centerX=0;updateBeamingHelper(){}buildBoundingsLookup(t,e,s){}getNoteX(t,e){return 0}getNoteY(t,e){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}}class qh extends Ma{Nw=0;Yy;Ky=[];constructor(t,e,s,i,n=1){super(t,e),this.Ky=qh.getSymbols(s),this.Nw=n,this.Yy=i}static getSymbols(t){const e=[];for(;t>0;){const s=t%10;e.unshift(qh.getSymbol(s)),t=t/10|0}return e}static getSymbol(t){switch(t){case 0:return rt.TimeSig0;case 1:return rt.TimeSig1;case 2:return rt.TimeSig2;case 3:return rt.TimeSig3;case 4:return rt.TimeSig4;case 5:return rt.TimeSig5;case 6:return rt.TimeSig6;case 7:return rt.TimeSig7;case 8:return rt.TimeSig8;case 9:return rt.TimeSig9;default:return rt.None}}doLayout(){let t=0;for(const e of this.Ky)t+=this.renderer.smuflMetrics.glyphWidths.get(e);this.width=t}paint(t,e,s){switch(this.Yy){case st.Top:e+=this.renderer.smuflMetrics.glyphBottom.get(this.Ky[0]);break;case st.Bottom:e+=this.renderer.smuflMetrics.glyphTop.get(this.Ky[0])}s.fillMusicFontSymbols(t+this.x,e+this.y,this.Nw,this.Ky)}}class Yh extends Ma{static Qy=[rt.RestHBarLeft,rt.RestHBarMiddle,rt.RestHBarMiddle,rt.RestHBarMiddle,rt.RestHBarRight];Zy=[];constructor(){super(0,0)}doLayout(){this.width=Yh.Qy.reduce((t,e)=>t+this.renderer.smuflMetrics.glyphWidths.get(e),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));const t=this.renderer.additionalMultiRestBars.length+1;this.Zy=qh.getSymbols(t)}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.renderer.height/2,1,Yh.Qy);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(t+this.x+this.width/2,e+this.y+i|0,1,this.Zy,!0)}}class Kh extends Ca{constructor(t){super(Kh.tk(t),t),this.preNotes=new Xh,this.onNotes=new Jh}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new Yh),super.doLayout()}static tk(t){if(t.voice.beats.length>1)return t.voice.beats[0];const e=new Yt;return e.voice=t.voice,e}}!function(t){t[t.TopWithStem=0]="TopWithStem",t[t.Top=1]="Top",t[t.Center=2]="Center",t[t.Bottom=3]="Bottom",t[t.BottomWithStem=4]="BottomWithStem",t[t.StemUp=5]="StemUp",t[t.StemDown=6]="StemDown"}(hh||(hh={})),function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(oh||(oh={}));class Qh{ek=new wh;sk=new Map;ik=new wh;nk=[];get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}scoreRenderer;staff;layoutingInfo;bar;additionalMultiRestBars=null;get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}x=0;y=0;width=0;computedWidth=0;height=0;index=0;topOverflow=0;bottomOverflow=0;helpers;isLinkedToPrevious=!1;canWrap=!0;get showMultiBarRest(){return!1}constructor(t,e){this.scoreRenderer=t,this.bar=e,e&&(this.helpers=new Nh(this))}registerTies(t){this.nk.push(...t)}get middleYPosition(){return 0}registerOverflowTop(t){return(t=Math.ceil(t))>this.topOverflow&&(this.topOverflow=t,!0)}registerOverflowBottom(t){return(t=Math.ceil(t))>this.bottomOverflow&&(this.bottomOverflow=t,!0)}scaleToWidth(t){const e=t-this.ek.width-this.ik.width;for(const t of this.sk.values())t.scaleToWidth(e);this.ik.x=this.ek.x+this.ek.width+e,this.width=t}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}wasFirstOfLine=!1;get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){const t=this.layoutingInfo,e=this.ek.width;t.preBeatSize<e&&(t.preBeatSize=e);for(const e of this.sk.values())e.registerLayoutingInfo(t),e.x,e.width;const s=this.ik.width;t.postBeatSize<s&&(t.postBeatSize=s)}rk=0;applyLayoutingInfo(){if(this.rk>=this.layoutingInfo.version)return!1;this.rk=this.layoutingInfo.version,this.ek.width=this.layoutingInfo.preBeatSize;let t=this.ek.x+this.ek.width;for(const e of this.sk.values()){e.x=this.ek.x+this.ek.width,e.applyLayoutingInfo(this.layoutingInfo);const s=e.x+e.width;t<s&&(t=s)}this.ik.x=Math.floor(t),this.ik.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this.ik.x+this.ik.width),this.computedWidth=this.width;const e=this.barDisplayWidth;return e>0&&this.scoreRenderer.layout.systemsLayoutMode===ah.FromModelWithWidths&&(this.width=e,this.computedWidth=e),!0}isFinalized=!1;finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const i of this.nk)if(i.doLayout(),i.height>0){const n=i.y+i.height-s;n>0&&this.registerOverflowBottom(n)&&(t=!0);const r=i.y-e;r<0&&this.registerOverflowTop(-1*r)&&(t=!0)}return t}topPadding=0;bottomPadding=0;doLayout(){if(!this.bar)return;this.helpers.initialize(),this.nk=[],this.ek=new wh,this.ek.renderer=this,this.sk.clear(),this.ik=new wh,this.ik.renderer=this;for(let t=0;t<this.bar.voices.length;t++){const e=this.bar.voices[t];if(this.hasVoiceContainer(e)){const s=new Sh(0,0,e);s.renderer=this,this.sk.set(this.bar.voices[t].index,s)}}if(this.bar.simileMark===P.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){const t=new Kh(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(t)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width;const t=this.height,e=this.ek.glyphs;if(e)for(const s of e){const e=s.getBoundingBoxTop();e<0&&this.registerOverflowTop(-1*e);const i=e+s.height;i>t&&this.registerOverflowBottom(i-t)}const s=this.ik.glyphs;if(s)for(const e of s){const s=e.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=s+e.height;i>t&&this.registerOverflowBottom(i-t)}}hasVoiceContainer(t){return!(!this.additionalMultiRestBars&&0!==t.index)||!t.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);const t=this.sk,e=this.beatGlyphsStart;let s=e;for(const i of t.values()){i.x=e,i.doLayout();const t=i.x+i.width;s<t&&(s=t)}this.ik.x=Math.floor(s),this.width=Math.ceil(this.ik.x+this.ik.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(t){t.renderer=this,this.ek.addGlyph(t)}addBeatGlyph(t){t.renderer=this,t.preNotes.renderer=this,t.onNotes.renderer=this,t.onNotes.beamingHelper=this.helpers.beamHelperLookup[t.beat.voice.index].get(t.beat.index),this.getVoiceContainer(t.beat.voice).addGlyph(t)}getVoiceContainer(t){return this.sk.has(t.index)?this.sk.get(t.index):void 0}getBeatContainer(t){return this.getVoiceContainer(t.voice)?.beatGlyphs?.[t.index]}getPreNotesGlyphForBeat(t){return this.getBeatContainer(t)?.preNotes}getOnNotesGlyphForBeat(t){return this.getBeatContainer(t)?.onNotes}paint(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this.ek.paint(t+this.x,e+this.y,s);for(const i of this.sk.values())i.paint(t+this.x,e+this.y,s);s.color=this.resources.mainGlyphColor,this.ik.paint(t+this.x,e+this.y,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this.ek.x+this.ek.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new Me;i.bar=this.bar,i.visualBounds=new Ne,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new Ne,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i);for(const[t,n]of this.sk){const r=this.bar.isEmpty&&0===t;if(!n.voice.isEmpty||r)for(let t=0,a=n.beatGlyphs.length;t<a;t++){n.beatGlyphs[t].buildBoundingsLookup(i,e+this.x+n.x,s+this.y+n.y,r)}}}addPostBeatGlyph(t){this.ik.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const t of this.bar.voices)this.hasVoiceContainer(t)&&this.createVoiceGlyphs(t)}createVoiceGlyphs(t){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this.ek.x+this.ek.width}get postBeatGlyphsStart(){return this.ik.x}getBeatX(t,e=rh.PreNotes){const s=this.getBeatContainer(t);if(s)switch(e){case rh.PreNotes:return s.voiceContainer.x+s.x;case rh.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case rh.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case rh.Stem:const e=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(t):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+e;case rh.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case rh.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],rh.OnNotes);return e+(this.postBeatGlyphsStart-e)*t}getNoteX(t,e){const s=this.getBeatContainer(t.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(t,e):0}getNoteY(t,e){const s=this.getOnNotesGlyphForBeat(t.beat);return s?s.getNoteY(t,e):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this.ek=new wh,this.ek.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){const i=yh.voice(s,L.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case P.Simple:s.beginGroup(Ca.getGroupId(this.bar.voices[0].beats[0])),Dt.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+this.height/2,1,rt.Repeat1Bar,!0),s.endGroup();break;case P.SecondOfDouble:s.beginGroup(Ca.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Ca.getGroupId(this.bar.previousBar.voices[0].beats[0])),Dt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height/2,1,rt.Repeat2Bars,!0),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(t){}getBeatDirection(t){return this.helpers.getBeamingHelperForBeat(t).direction}}!function(t){t[t.SinglePreBeat=0]="SinglePreBeat",t[t.SingleOnBeat=1]="SingleOnBeat",t[t.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",t[t.GroupedOnBeat=3]="GroupedOnBeat",t[t.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",t[t.FullBar=5]="FullBar"}(ch||(ch={}));class Zh extends Ma{ak=[];jy=[];isEmpty=!0;previousBand=null;isLinkedToPrevious=!1;firstBeat=null;lastBeat=null;height=0;originalHeight=0;voice;info;slot=null;constructor(t,e){super(0,0),this.voice=t,this.info=e}doLayout(){super.doLayout();for(let t=0;t<this.renderer.bar.voices.length;t++)this.jy.push(new Map),this.ak.push([])}createGlyph(t){if(t.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,t)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!t.isBefore(this.firstBeat)||(this.firstBeat=t),!this.lastBeat||t.isAfter(this.lastBeat))switch(this.lastBeat=t,this.info.sizingMode){case ch.SingleOnBeatToEnd:case ch.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const e=this.hk(this.info.sizingMode,t);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}hk(t,e){let s;switch(t){case ch.FullBar:case ch.SinglePreBeat:case ch.SingleOnBeat:case ch.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,e),s.renderer=this.renderer,s.beat=e,s.doLayout(),this.jy[e.voice.index].set(e.index,s),this.ak[e.voice.index].push(s),s;case ch.GroupedOnBeat:case ch.GroupedOnBeatToEnd:const i=t===ch.GroupedOnBeat?ch.SingleOnBeat:ch.SingleOnBeatToEnd;if(e.index>0||this.renderer.index>0){const t=e.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,t)){let s=null;if(e.index>0&&this.jy[e.voice.index].has(t.index))s=this.jy[e.voice.index].get(t.index);else if(this.renderer.index>0){const e=this.renderer.previousRenderer.getBand(t.voice,this.info.effectId);if(e){const i=e.jy[t.voice.index];i.has(t.index)&&(s=i.get(t.index))}}const n=this.hk(i,e);return s&&this.info.canExpand(t,e)&&(s.nextGlyph=n,n.previousGlyph=s,this.isLinkedToPrevious=!0),n}return this.hk(i,e)}return this.hk(i,e);default:return this.hk(ch.SingleOnBeat,e)}}paint(t,e,s){super.paint(t,e,s);for(let i=0,n=this.ak.length;i<n;i++){const n=this.ak[i];for(let i=0,r=n.length;i<r;i++){const r=n[i],a=yh.beat(s,wt.Effects,r.beat,!1);try{r.paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let t=0;t<this.jy.length;t++)for(const e of this.jy[t].keys())this.ck(this.info.sizingMode,this.renderer.bar.voices[t].beats[e])}ck(t,e){const s=this.jy[e.voice.index].get(e.index),i=this.renderer.getBeatContainer(e);switch(t){case ch.SinglePreBeat:const t=this.renderer.layoutingInfo.getPreBeatSize(e);s.x=this.renderer.beatGlyphsStart+i.x-t;break;case ch.SingleOnBeat:case ch.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x;break;case ch.SingleOnBeatToEnd:case ch.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{const t=this.renderer.layoutingInfo.getPostBeatSize(e);s.width=t}break;case ch.FullBar:s.width=this.renderer.width}}}class to{uniqueEffectId=null;y=0;height=0;firstBeat=null;lastBeat=null}class eo{bands;shared;constructor(){this.bands=[],this.shared=new to}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),this.shared.firstBeat&&!t.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=t.firstBeat),this.shared.lastBeat&&!t.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return(!this.shared.uniqueEffectId&&t.info.canShareBand||t.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(t.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class so{lk;slots;constructor(){this.slots=[],this.lk=new Map}getOrCreateSlot(t){if(this.lk.has(t.info.effectId)){const e=this.lk.get(t.info.effectId);if(e.canBeUsed(t))return e}for(const e of this.slots)if(e.canBeUsed(t))return e;const e=new eo;return this.slots.push(e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this.lk.set(t.info.effectId,e)}}class io extends Qh{uk;dk=[];fk=new Map;sizingInfo=null;constructor(t,e,s){super(t,e),this.uk=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.pk(),super.updateSizes()}finalizeRenderer(){let t=super.finalizeRenderer();return this.pk()&&(t=!0),t}pk(){if(!this.sizingInfo)return!1;let t=0;for(const e of this.sizingInfo.slots){e.shared.y=t;for(const s of e.bands)s.y=t,s.height=e.shared.height;t+=e.shared.height+this.settings.display.effectBandPaddingBottom}return t=Math.ceil(t),t!==this.height&&(this.height=t,!0)}applyLayoutingInfo(){const t=!super.applyLayoutingInfo();if(this.index>0){const t=this.previousRenderer;this.sizingInfo=t.sizingInfo}else this.sizingInfo=new so;for(const t of this.dk)t.resetHeight(),t.alignGlyphs(),t.isEmpty||this.sizingInfo.register(t);return this.pk(),t}scaleToWidth(t){super.scaleToWidth(t);for(const t of this.dk)t.alignGlyphs()}createBeatGlyphs(){this.dk=[],this.fk=new Map;for(const t of this.bar.voices)if(this.hasVoiceContainer(t))for(const e of this.uk){const s=new Zh(t,e);s.renderer=this,s.doLayout(),this.dk.push(s),this.fk.set(`${t.index}.${e.effectId}`,s)}super.createBeatGlyphs();for(const t of this.dk)t.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){for(const e of t.beats){const s=new Ca(e,this.getVoiceContainer(t));s.preNotes=new Xh,s.onNotes=new Jh,this.addBeatGlyph(s);for(const t of this.dk)t.createGlyph(e)}}paint(t,e,s){this.paintBackground(t,e,s);for(const i of this.dk)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(t+this.x,e+this.y,s)}getBand(t,e){const s=`${t.index}.${e}`;return this.fk.has(s)?this.fk.get(s):null}}class no extends mh{infos;bk;get staffId(){return this.bk}shouldShow;getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(t,e,s=null){super(),this.infos=e,this.bk=t,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(t,e){const s=this.shouldShow;return super.canCreate(t,e)&&(!s||s(t,e))}create(t,e){return new io(t,e,this.infos.filter(e=>t.settings.notation.isNotationElementVisible(e.notationElement)))}}class ro extends va{mk;gk="";wk;yk;Sn;constructor(t,e,s,i,n,r){super(t,e),this.mk=Vt.getAlternateEndingsList(s),this.wk=i,this.yk=n,this.Sn=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let t="";for(let e=0,s=this.mk.length;e<s;e++)t+=this.mk[e]+1,t+=". ";this.gk=t}paint(t,e,s){let i=this.yk?this.width-s.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===D.LightHeavy&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),t=(0|t)+s.lineWidth/2,e=(0|e)+s.lineWidth/2,this.Sn&&(t+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this.wk?(s.moveTo(t+this.x,e+this.y+this.height),s.lineTo(t+this.x,e+this.y)):s.moveTo(t+this.x,e+this.y),s.lineTo(t+this.x+i,e+this.y),this.yk&&s.lineTo(t+this.x+i,e+this.y+this.height),s.stroke(),this.wk){const i=s.textBaseline;s.textBaseline=st.Top;const n=this.renderer.resources;s.font=n.wordsFont,s.fillText(this.gk,t+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,e+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=i}}}class ao{get effectId(){return this.notationElement.toString()}}class ho extends ao{get notationElement(){return B.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ch.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&0!==e.voice.bar.masterBar.alternateEndings}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let n=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(t=>t.index>=s.index)||(n=!1);const r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new ro(0,0,s.alternateEndings,i,n,r)}canExpand(t,e){return!0}}class oo extends va{endPosition;forceGroupedRendering=!1;endOnBarLine=!1;constructor(t){super(),this.endPosition=t}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(t,e,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(t,e,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const n=i.renderer,r=i.beat,a=this.endPosition,h=t-this.renderer.x,o=this.calculateEndX(n,r,h,a);this.paintGrouped(t,e,o,s)}calculateEndX(t,e,s,i){return e?s+t.x+t.getBeatX(e,i):s+t.x+this.x+this.width}paintNonGrouped(t,e,s){const i=t-this.renderer.x,n=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(t,e,n,s)}}class co extends oo{kk;Sk;Bk=0;constructor(t,e=!0){super(rh.OnNotes),this.kk=t,this.Sk=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=rh.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;const t=this.renderer.scoreRenderer.canvas.measureText(this.kk);this.height=t.height,this.Bk=t.width}paintNonGrouped(t,e,s){const i=this.renderer.resources;s.font=i.effectFont;const n=s.textBaseline;s.textBaseline=st.Middle,s.fillText(this.kk,t+this.x-this.Bk/2,e+this.y+this.height/2),s.textBaseline=n}paintGrouped(t,e,s,i){this.paintNonGrouped(t,e,i);const n=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,a=this.renderer.smuflMetrics.pedalLineThickness,h=t+this.x+this.Bk/2+n/2,o=e+this.y+this.height/2-a/2;if(this.Sk){if(s>h){let t=h;for(;t<s;){const e=Math.min(t+r,s);i.fillRect(t,o,e-t,a),t+=r+n}i.fillRect(s,o-r/2+a/2,a,r)}}else i.fillRect(h,o,s-h,a),i.fillRect(s-a,o,a,r/2)}}class lo extends ao{get notationElement(){return B.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){let s="";switch(e.barreShape){case bt.None:case bt.Full:break;case bt.Half:s+="1/2"}return s+=`B ${lo.toRoman(e.barreFret)}`,new co(s,!1)}static _k=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);static toRoman(t){let e="";if(t>0)for(const[s,i]of lo._k){const n=Math.floor(t/i);t-=n*i,e+=s.repeat(n)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}}class uo extends va{u;xk="";Tk=0;Mk=0;constructor(t){super(0,0),this.u=t}doLayout(){const t=this.u/6e4|0,e=(this.u-6e4*t)/1e3|0;this.xk=`${t}:${e.toString().padStart(2,"0")}`;const s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.timerFont;const i=s.measureText(this.xk);this.Mk=s.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this.Tk=i.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this.Mk+2*this.renderer.smuflMetrics.beatTimerPadding}paint(t,e,s){const i=this.Tk/2|0;s.strokeRect(t+this.x-i,e+this.y+this.renderer.smuflMetrics.beatTimerPadding,this.Tk,this.Mk);const n=s.font,r=s.textBaseline,a=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=st.Middle,s.textAlign=et.Center,s.fillText(this.xk,t+this.x,e+this.y+this.height/2),s.font=n,s.textBaseline=r,s.textAlign=a}}class fo extends ao{get notationElement(){return B.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new uo(e.timer??0)}canExpand(t,e){return!0}}class po extends ao{get notationElement(){return B.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.index&&0===e.voice.bar.index&&0!==e.voice.bar.staff.capo}createNewGlyph(t,e){return new Ah(0,0,`Capo. fret ${e.voice.bar.staff.capo}`,t.resources.effectFont,et.Left)}canExpand(t,e){return!1}}class bo extends ao{get notationElement(){return B.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(t,e){return new Ah(0,0,e.chord.name,t.resources.effectFont,et.Center)}canExpand(t,e){return!1}}class mo extends oo{Cn;constructor(t,e,s){super(rh.EndBeat),this.Cn=o.None,this.Cn=s,this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.DynamicCrescendoHairpin)}paintGrouped(t,e,s,i){const n=t+this.x,r=this.height,a=this.renderer.smuflMetrics.glyphWidths.get(rt.NoteheadBlack)/2;i.beginPath(),this.Cn===o.Crescendo?(s-=a,i.moveTo(s,e+this.y),i.lineTo(n,e+this.y+r/2),i.lineTo(s,e+this.y+r)):(s-=a,i.moveTo(n,e+this.y),i.lineTo(s,e+this.y+r/2),i.lineTo(n,e+this.y+r));const h=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=h}}class go extends ao{get notationElement(){return B.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==o.None}createNewGlyph(t,e){return new mo(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class wo extends Ma{Ky;Nw=1;constructor(t){super(0,0),this.Ky=t}doLayout(){this.height=0;const t=this.renderer.smuflMetrics.directionsScale;this.Nw=t;for(const e of this.Ky){const s=this.renderer.smuflMetrics.glyphHeights.get(e)*t;s>this.height&&(this.height=s)}}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.height,this.Nw,this.Ky,!0)}}class yo extends Ma{xk;constructor(t){super(0,0),this.xk=t}doLayout(){const t=this.renderer.scoreRenderer.canvas;t.font=this.renderer.resources.directionsFont,this.height=t.measureText(this.xk).height}paint(t,e,s){const i=s.font,n=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=st.Middle,s.textAlign=et.Right,s.fillText(this.xk,t+this.x,e+this.y+this.height/2),s.font=i,s.textBaseline=n,s.textAlign=r}}class ko extends va{vk;Nk=[];Pk=[];constructor(t,e,s){super(t,e),this.vk=s}doLayout(){const t=this.vk;t.has(Ke.TargetSegnoSegno)&&this.Nk.push(new wo([rt.Segno,rt.Segno])),t.has(Ke.TargetSegno)&&this.Nk.push(new wo([rt.Segno])),t.has(Ke.TargetDoubleCoda)&&this.Nk.push(new wo([rt.Coda,rt.Coda])),t.has(Ke.TargetCoda)&&this.Nk.push(new wo([rt.Coda])),t.has(Ke.TargetFine)&&this.Pk.push(new yo("Fine")),t.has(Ke.JumpDaDoubleCoda)&&this.Pk.push(new yo("To Double Coda")),t.has(Ke.JumpDaCoda)&&this.Pk.push(new yo("To Coda")),t.has(Ke.JumpDalSegnoSegno)&&this.Pk.push(new yo("D.S.S.")),t.has(Ke.JumpDalSegnoSegnoAlCoda)&&this.Pk.push(new yo("D.S.S. al Coda")),t.has(Ke.JumpDalSegnoSegnoAlDoubleCoda)&&this.Pk.push(new yo("D.S.S. al Double Coda")),t.has(Ke.JumpDalSegnoSegnoAlFine)&&this.Pk.push(new yo("D.S.S. al Fine")),t.has(Ke.JumpDalSegno)&&this.Pk.push(new yo("D.S.")),t.has(Ke.JumpDalSegnoAlCoda)&&this.Pk.push(new yo("D.S. al Coda")),t.has(Ke.JumpDalSegnoAlDoubleCoda)&&this.Pk.push(new yo("D.S. al Double Coda")),t.has(Ke.JumpDalSegnoAlFine)&&this.Pk.push(new yo("D.S. al Fine")),t.has(Ke.JumpDaCapo)&&this.Pk.push(new yo("D.C.")),t.has(Ke.JumpDaCapoAlCoda)&&this.Pk.push(new yo("D.C. al Coda")),t.has(Ke.JumpDaCapoAlDoubleCoda)&&this.Pk.push(new yo("D.C. al Double Coda")),t.has(Ke.JumpDaCapoAlFine)&&this.Pk.push(new yo("D.C. al Fine"));const e=this.Ek(this.Nk),s=this.Ek(this.Pk);this.height=Math.max(e,s)}Ek(t){let e=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of t)i.y=e,i.renderer=this.renderer,i.doLayout(),e+=i.height+s;return e}paint(t,e,s){for(const i of this.Nk)i.paint(t+this.x,e+this.y,s);for(const i of this.Pk)i.paint(t+this.x+this.width,e+this.y,s)}}class So extends ao{get notationElement(){return B.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ch.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&null!==e.voice.bar.masterBar.directions&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new ko(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}class Bo extends Na{constructor(t,e,s){super(t,e,1,Bo.Fk(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.DynamicForte);const t=this.renderer.smuflMetrics.glyphTop.get(rt.DynamicForte);this.offsetY=t}static Fk(t){switch(t){case i.PPP:return rt.DynamicPPP;case i.PP:return rt.DynamicPP;case i.P:return rt.DynamicPiano;case i.MP:return rt.DynamicMP;case i.MF:return rt.DynamicMF;case i.F:return rt.DynamicForte;case i.FF:return rt.DynamicFF;case i.FFF:return rt.DynamicFFF;case i.PPPP:return rt.DynamicPPPP;case i.PPPPP:case i.PPPPPP:return rt.DynamicPPPPP;case i.FFFF:return rt.DynamicFFFF;case i.FFFFF:return rt.DynamicFFFFF;case i.FFFFFF:return rt.DynamicFFFFFF;case i.SF:return rt.DynamicSforzando1;case i.SFP:return rt.DynamicSforzandoPiano;case i.SFPP:return rt.DynamicSforzandoPianissimo;case i.FP:return rt.DynamicFortePiano;case i.RF:return rt.DynamicRinforzando1;case i.RFZ:return rt.DynamicRinforzando2;case i.SFZ:return rt.DynamicSforzato;case i.SFFZ:return rt.DynamicSforzatoFF;case i.FZ:return rt.DynamicForzando;case i.N:return rt.DynamicNiente;case i.PF:return rt.DynamicPF;case i.SFZP:return rt.DynamicSforzatoPiano;default:return rt.None}}}class _o extends ao{get notationElement(){return B.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return this.Ck(e)}Ck(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this.Ak(t);let s=0===t.voice.index&&!e||t.dynamics!==e?.dynamics;if(s&&t.voice.index>0)for(const e of t.voice.bar.voices)if(e.index<t.voice.index){const i=e.getBeatAtPlaybackStart(t.playbackStart);i&&t.dynamics===i.dynamics&&this.Ck(i)&&(s=!1)}return s}Ak(t){let e=t.previousBeat;for(;null!=e;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new Bo(0,0,e.dynamics)}canExpand(t,e){return!0}}class xo extends Na{constructor(t){super(0,0,1,xo.Fk(t)),this.center=!0}static Fk(t){switch(t){case ft.FadeIn:return rt.GuitarFadeIn;case ft.FadeOut:return rt.GuitarFadeOut;case ft.VolumeSwell:return rt.GuitarVolumeSwell}return rt.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class To extends ao{get notationElement(){return B.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==ft.None}createNewGlyph(t,e){return new xo(e.fade)}canExpand(t,e){return!0}}class Mo extends Na{constructor(t,e,s){super(t,e,1,Mo.Fk(s))}static Fk(t){switch(t){case Nt.Short:return rt.FermataShortAbove;case Nt.Medium:return rt.FermataAbove;case Nt.Long:return rt.FermataLongAbove;default:return rt.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class vo extends ao{get notationElement(){return B.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.voice.index&&!!e.fermata}createNewGlyph(t,e){return new Mo(0,0,e.fermata.type)}canExpand(t,e){return!0}}class No{line=0;symbols;color;constructor(t,e){this.line=t,this.symbols=e}}class Po extends gh{uk=new Map;constructor(){super(0,0)}get isEmpty(){return 0===this.uk.size}addFingers(t){const e=this.renderer.settings;if(e.notation.fingeringMode!==k.ScoreDefault&&e.notation.fingeringMode!==k.ScoreForcePiano)return;const s=Po.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.leftHandFinger,!0);s!==rt.None&&this.Dk(t,s);const i=Po.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.rightHandFinger,!1);i!==rt.None&&this.Dk(t,i)}static fingerToMusicFontSymbol(t,e,s,i){if(t.notation.fingeringMode===k.ScoreForcePiano||t.notation.fingeringMode===k.SingleNoteEffectBandForcePiano||ue.isPiano(e.voice.bar.staff.track.playbackInfo.program))switch(s){case d.Unknown:case d.NoOrDead:return rt.None;case d.Thumb:return rt.Fingering1;case d.IndexFinger:return rt.Fingering2;case d.MiddleFinger:return rt.Fingering3;case d.AnnularFinger:return rt.Fingering4;case d.LittleFinger:return rt.Fingering5;default:return rt.None}if(i)switch(s){case d.Unknown:return rt.None;case d.NoOrDead:return rt.Fingering0;case d.Thumb:return rt.FingeringTLower;case d.IndexFinger:return rt.Fingering1;case d.MiddleFinger:return rt.Fingering2;case d.AnnularFinger:return rt.Fingering3;case d.LittleFinger:return rt.Fingering4;default:return rt.None}switch(s){case d.Unknown:case d.NoOrDead:return rt.None;case d.Thumb:return rt.FingeringPLower;case d.IndexFinger:return rt.FingeringILower;case d.MiddleFinger:return rt.FingeringMLower;case d.AnnularFinger:return rt.FingeringALower;case d.LittleFinger:return rt.FingeringCLower;default:return rt.None}}Dk(t,e){const s=this.renderer,i=s.getNoteLine(t);if(this.uk.has(i)){this.uk.get(i).symbols.push(e)}else{const n=new No(i,[e]);n.color=yh.noteColor(s.resources,lt.StandardNotationEffects,t),this.uk.set(i,n)}}doLayout(){const t=this.renderer;for(const[e,s]of this.uk){const e=new Pa(0,0,1,s.symbols);e.colorOverride=s.color,e.renderer=t,e.y=t.getScoreY(s.line),e.doLayout(),e.offsetY=e.height/2,this.addGlyph(e),this.width=Math.max(this.width,e.width)}for(const t of this.glyphs){const e=t;e.x=this.width/2,e.center=!0}}}class Eo extends ao{get notationElement(){return B.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return!(0!==e.voice.index||e.isRest||t.notation.fingeringMode!==k.SingleNoteEffectBand&&t.notation.fingeringMode!==k.SingleNoteEffectBandForcePiano)&&(1===e.notes.length&&e.notes[0].isFingering)}createNewGlyph(t,e){let s=d.Unknown,i=!1;const n=e.notes[0];n.leftHandFinger!==d.Unknown?(s=n.leftHandFinger,i=!0):n.rightHandFinger!==d.Unknown&&(s=n.rightHandFinger);const r=Po.fingerToMusicFontSymbol(t.settings,e,s,i),a=new Na(0,0,1,r);return a.center=!0,a.renderer=t,a.doLayout(),a.offsetY=t.smuflMetrics.glyphTop.get(a.symbol),a}canExpand(t,e){return!0}}class Fo extends ao{get notationElement(){return B.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(t,e){return new Ah(0,0,"Free time",t.resources.effectFont,et.Left)}canExpand(t,e){return!0}}class Co extends Na{constructor(t,e,s=!1){super(t,e,Ea.GraceScale,rt.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class Ao extends ao{Lk;Wk;constructor(t,e){super(),this.Lk=t,this.Wk=e}get notationElement(){return B.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){const s=this.Wk;return e.golpe===this.Lk&&(!s||s(t,e))}createNewGlyph(t,e){return new Co(0,0,!0)}canExpand(t,e){return!1}}class Do extends ao{lastCreateInfo=null;shouldCreateGlyph(t,e){this.lastCreateInfo=[];for(let t=0,s=e.notes.length;t<s;t++){const s=e.notes[t];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(t,e){return!0}}class Lo extends Do{Ok;ge=null;Rk;get effectId(){return this.Rk}get notationElement(){return B.EffectHarmonics}constructor(t){switch(super(),this.Ok=t,t){case f.None:this.Rk="harmonics-none";break;case f.Natural:this.Rk="harmonics-natural";break;case f.Artificial:this.Rk="harmonics-artificial";break;case f.Pinch:this.Rk="harmonics-pinch";break;case f.Tap:this.Rk="harmonics-tap";break;case f.Semi:this.Rk="harmonics-semi";break;case f.Feedback:this.Rk="harmonics-feedback";break;default:this.Rk=""}}shouldCreateGlyphForNote(t){return!(!t.isHarmonic||t.harmonicType!==this.Ok)&&(t.beat!==this.ge&&(this.ge=t.beat),!0)}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){return new co(Lo.harmonicToString(this.Ok))}static harmonicToString(t){switch(t){case f.Natural:return"N.H.";case f.Artificial:return"A.H.";case f.Pinch:return"P.H.";case f.Tap:return"T.H.";case f.Semi:return"S.H.";case f.Feedback:return"Fdbk."}return""}}class Wo extends Na{constructor(){super(0,0,1,rt.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class Oo extends Do{get notationElement(){return B.EffectTap}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new Wo}}class Ro extends ao{get notationElement(){return B.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){return new co("LetRing")}canExpand(t,e){return!0}}class Io extends va{by;font;textAlign;constructor(t,e,s,i,n=et.Center){super(t,e),this.by=s,this.font=i,this.textAlign=n}doLayout(){super.doLayout(),this.height=this.font.size*this.by.length}paint(t,e,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this.by.length;i++)this.by[i]&&s.fillText(this.by[i],t+this.x,e+this.y+i*this.font.size);s.textAlign=i}}class Go extends ao{get notationElement(){return B.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(t,e){return new Io(0,0,e.lyrics,t.resources.effectFont,et.Center)}canExpand(t,e){return!0}}class $o extends ao{get notationElement(){return B.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ch.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(t,e){return new Ah(0,0,e.voice.bar.masterBar.section.marker?`[${e.voice.bar.masterBar.section.marker}] ${e.voice.bar.masterBar.section.text}`:e.voice.bar.masterBar.section.text,t.resources.markerFont,et.Left)}canExpand(t,e){return!0}}class Vo extends Na{constructor(t){super(0,0,1,Vo.Fk(t)),this.center=!0}static Fk(t){switch(t){case ct.InvertedTurn:return rt.OrnamentTurnInverted;case ct.Turn:return rt.OrnamentTurn;case ct.UpperMordent:return rt.OrnamentShortTrill;case ct.LowerMordent:return rt.OrnamentMordent}return rt.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(rt.OrnamentMordent)}}class Ho extends ao{get notationElement(){return B.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(t=>t.ornament!==ct.None)}createNewGlyph(t,e){return new Vo(e.notes.find(t=>t.ornament!==ct.None).ornament)}canExpand(t,e){return!1}}class Uo extends oo{Ik;Gk;constructor(t,e){super(rh.PostNotes),this.Ik=t,this.Gk=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.QuindicesimaAlta)}paintNonGrouped(t,e,s){this.$k(t,e,s)}$k(t,e,s){let i=0;switch(this.Ik){case b.S:i=this.renderer.smuflMetrics.glyphWidths.get(rt.QuindicesimaAlta),Dt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,rt.QuindicesimaAlta,!1);break;case b._:i=this.renderer.smuflMetrics.glyphWidths.get(rt.OttavaAlta),Dt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,rt.OttavaAlta,!1);break;case b.T:i=this.renderer.smuflMetrics.glyphWidths.get(rt.OttavaBassaVb),Dt.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,rt.OttavaBassaVb,!1);break;case b.M:i=1*(this.renderer.smuflMetrics.glyphWidths.get(rt.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(rt.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(rt.OctaveBaselineB)),Dt.fillMusicFontSymbolsSafe(s,t+this.x-i/2,e+this.y+this.height,1,[rt.Quindicesima,rt.OctaveBaselineM,rt.OctaveBaselineB],!1)}return i/2}paintGrouped(t,e,s,i){const n=this.$k(t,e,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,a=t+this.x+n+r;let h=e+this.y;const o=.5*this.height;h+=this.Gk?0:this.height;const c=this.renderer.smuflMetrics.lineRangedGlyphDashSize,l=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>a){let t=a;for(;t<s;)i.beginPath(),i.moveTo(t,0|h),i.lineTo(Math.min(t+c,s),0|h),t+=c+r,i.stroke();i.beginPath(),this.Gk?(i.moveTo(s,h),i.lineTo(s,h+o)):(i.moveTo(s,h),i.lineTo(s,h-o)),i.stroke()}i.lineWidth=l}}class zo extends ao{Gk;get effectId(){return"ottavia-"+(this.Gk?"above":"below")}get notationElement(){return B.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.GroupedOnBeat}constructor(t){super(),this.Gk=t}shouldCreateGlyph(t,e){switch(e.ottava){case b.S:case b._:return this.Gk;case b.T:case b.M:return!this.Gk}return!1}createNewGlyph(t,e){return new Uo(e.ottava,this.Gk)}canExpand(t,e){return t.ottava===e.ottava}}class jo extends Do{get notationElement(){return B.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){return new co("P.M.")}}class Xo extends Do{get notationElement(){return B.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===g.PickSlideDown||t.slideOutType===g.PickSlideUp}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){return new co("P.S.")}}class Jo extends Na{constructor(t,e,s){super(t,e,Ea.GraceScale,Jo.Fk(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static Fk(t){switch(t){case ht.Up:return rt.StringsUpBow;case ht.Down:return rt.StringsDownBow;default:return rt.None}}}class qo extends ao{get notationElement(){return B.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==ht.None}createNewGlyph(t,e){return new Jo(0,0,e.pickStroke)}canExpand(t,e){return!0}}class Yo extends ao{get notationElement(){return B.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return ch.GroupedOnBeat}createNewGlyph(t,e){return new co("rasg.")}canExpand(t,e){return!0}}class Ko extends oo{Lk;Vk=rt.None;Hk=0;Uk=0;zk;constructor(t,e,s,i=!1){super(rh.EndBeat),this.Lk=s,this.x=t,this.y=e,this.zk=i}doLayout(){switch(super.doLayout(),this.Lk){case w.Slight:this.Vk=this.slightVibratoGlyph;break;case w.Wide:this.Vk=this.wideVibratoGlyph}this.Hk=this.renderer.smuflMetrics.repeatOffsetX.get(this.Vk),this.Uk=this.renderer.smuflMetrics.glyphTop.get(this.Vk),this.height=this.renderer.smuflMetrics.glyphHeights.get(this.Vk)}paintGrouped(t,e,s,i){let n=(s-(t+this.x))/this.Hk;this.zk||(n=Math.floor(n)),n<1&&(n=1);const r=[];for(let t=0;t<n;t++)r.push(this.Vk);i.fillMusicFontSymbols(t+this.x,e+this.y+this.Uk,1,r,!1)}}class Qo extends Ko{get slightVibratoGlyph(){return rt.GuitarVibratoStroke}get wideVibratoGlyph(){return rt.GuitarWideVibratoStroke}}class Zo extends Ko{get slightVibratoGlyph(){return rt.WiggleSawtoothNarrow}get wideVibratoGlyph(){return rt.WiggleSawtooth}}class tc extends ao{get notationElement(){return B.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===w.Slight}createNewGlyph(t,e){return new Zo(0,0,w.Slight)}canExpand(t,e){return!0}}class ec extends Do{jk;get notationElement(){return B.EffectSlightNoteVibrato}shouldCreateGlyphForNote(t){let e=t.vibrato===w.Slight||t.isTieDestination&&t.tieOrigin.vibrato===w.Slight;return this.jk&&e&&t.isTieDestination&&t.tieOrigin.hasBend&&(e=!1),e}get sizingMode(){return ch.GroupedOnBeatToEnd}createNewGlyph(t,e){return new Qo(0,0,w.Slight)}constructor(t){super(),this.jk=t}}class sc extends va{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.KeyboardPedalPed)}paint(t,e,s){const i=this.renderer,n=e+this.y,r=this.height,a=i.bar.sustainPedals,h=this.renderer.smuflMetrics.glyphWidths.get(rt.KeyboardPedalPed),o=this.renderer.smuflMetrics.glyphWidths.get(rt.KeyboardPedalUp);let c=0;for(;c<a.length;){let e=a[c];for(;null!=e;){const i=t+this.renderer.getRatioPositionX(e.ratioPosition);let l=0;if(e.pedalType===C.Down?(Dt.fillMusicFontSymbolSafe(s,i,n+r,1,rt.KeyboardPedalPed,!0),l=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding):e.pedalType===C.Up&&(Dt.fillMusicFontSymbolSafe(s,i,n+r,1,rt.KeyboardPedalUp,!0),l=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding),e.nextPedalMarker)if(e.nextPedalMarker.bar===e.bar){let a=t+this.renderer.getRatioPositionX(e.nextPedalMarker.ratioPosition);switch(e.nextPedalMarker.pedalType){case C.Down:a-=h/2;break;case C.Hold:break;case C.Up:a-=o/2}const c=i+l;a>c&&s.fillRect(c,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-c,this.renderer.smuflMetrics.pedalLineThickness)}else{const e=t+this.x+this.width,a=i+l;s.fillRect(a,n+r-this.renderer.smuflMetrics.pedalLineThickness,e-a,this.renderer.smuflMetrics.pedalLineThickness)}if(0===c&&e.previousPedalMarker){const e=t+this.x,a=i-l;s.fillRect(e,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-e,this.renderer.smuflMetrics.pedalLineThickness)}c++,null!=e.nextPedalMarker&&e.nextPedalMarker.bar!==e.bar?(e=null,c=a.length):e=e.nextPedalMarker}}}}class ic extends ao{get notationElement(){return B.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new sc}canExpand(t,e){return!0}}class nc extends ao{get notationElement(){return B.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(t,e){const s=t.resources;return e.slap?new Ah(0,0,"S",s.effectFont,et.Center):e.pop?new Ah(0,0,"P",s.effectFont,et.Center):new Ah(0,0,"T",s.effectFont,et.Center)}canExpand(t,e){return!0}}class rc extends va{Xk;constructor(t){super(0,0),this.Xk=t}doLayout(){super.doLayout();const t=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.MetNoteQuarterUp)*t.engravingSettings.tempoNoteScale}paint(t,e,s){for(const i of this.Xk){let n=t+this.renderer.getRatioPositionX(i.ratioPosition);const r=this.renderer.resources;s.font=r.markerFont;const a=e+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(rt.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,h=s.textBaseline;if(s.textBaseline=st.Alphabetic,i.text){const t=`${i.text} `,e=s.measureText(t);s.fillText(t,n,a),n+=e.width}else n-=r.engravingSettings.glyphWidths.get(rt.MetNoteQuarterUp)/2;Dt.fillMusicFontSymbolSafe(s,n,a,r.engravingSettings.tempoNoteScale,rt.MetNoteQuarterUp),n+=this.renderer.smuflMetrics.glyphWidths.get(rt.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,n,a),s.textBaseline=h,n+=s.measureText(` = ${i.value.toString()}`).width}}}class ac extends ao{get notationElement(){return B.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ch.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.tempoAutomations.some(t=>t.isVisible)}createNewGlyph(t,e){return new rc(e.voice.bar.masterBar.tempoAutomations.filter(t=>t.isVisible))}canExpand(t,e){return!0}}class hc extends ao{get notationElement(){return B.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(t,e){return new Ah(0,0,e.text,t.resources.effectFont,et.Left)}canExpand(t,e){return!0}}class oc extends oo{constructor(t,e){super(rh.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.OrnamentTrill)}paintGrouped(t,e,s,i){const n=this.renderer.smuflMetrics.glyphWidths.get(rt.OrnamentTrill),r=t+this.x+n,a=this.renderer.smuflMetrics.repeatOffsetX.get(rt.WiggleTrill),h=Math.ceil((s-r)/a),o=[rt.OrnamentTrill];for(let t=0;t<h;t++)o.push(rt.WiggleTrill);i.fillMusicFontSymbols(t+this.x-n/2,e+this.y+this.height,1,o,!1)}}class cc extends Do{get notationElement(){return B.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return ch.GroupedOnBeatToEnd}createNewGlyph(t,e){return new oc(0,0)}}!function(t){t[t.EighthEighth=0]="EighthEighth",t[t.SixteenthSixteenth=1]="SixteenthSixteenth",t[t.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",t[t.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",t[t.EighthDottedSixteenth=4]="EighthDottedSixteenth",t[t.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",t[t.SixteenthEighthDotted=6]="SixteenthEighthDotted",t[t.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"}(lh||(lh={}));class lc extends va{Jk;qk=0;Yk=0;constructor(t){super(0,0),this.Jk=t}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.MetNoteQuarterUp)*t,this.qk=this.renderer.smuflMetrics.glyphHeights.get(rt.Tuplet3)*t,this.Yk=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this.qk}paint(t,e,s){t+=this.x,e+=this.y;let i=lh.EighthEighth,n=lh.EighthEighth;switch(this.Jk){case nt.NoTripletFeel:i=lh.EighthEighth,n=lh.EighthEighth;break;case nt.Triplet8th:i=lh.EighthEighth,n=lh.QuarterTripletEighthTriplet;break;case nt.Triplet16th:i=lh.SixteenthSixteenth,n=lh.EighthSixteenthTriplet;break;case nt.Dotted8th:i=lh.EighthEighth,n=lh.EighthDottedSixteenth;break;case nt.Dotted16th:i=lh.SixteenthSixteenth,n=lh.SixteenthDottedThirtySecond;break;case nt.Scottish8th:i=lh.EighthEighth,n=lh.SixteenthEighthDotted;break;case nt.Scottish16th:i=lh.SixteenthSixteenth,n=lh.ThirtySecondSixteenthDotted}const r=this.renderer.smuflMetrics.tempoNoteScale,a=e+this.renderer.smuflMetrics.glyphTop.get(rt.MetNoteQuarterUp)*r,h=e+this.height,o=s.textBaseline;s.textBaseline=st.Bottom,s.font=this.renderer.resources.effectFont,s.fillText("(",t,h),t+=s.measureText("( ").width,t=this.Kk(t,a+this.qk,s,i),s.fillText(" = ",t,h),t+=s.measureText(" = ").width,t=this.Kk(t,a+this.qk,s,n),s.fillText(" )",t,h),s.textBaseline=o}Kk(t,e,s,i){const n=this.renderer.smuflMetrics.tempoNoteScale;let r=[],a=[];const h=[];let o=rt.None;switch(i){case lh.EighthEighth:h.push(et.Center),r=[rt.MetNoteQuarterUp],a=[rt.MetNoteQuarterUp];break;case lh.SixteenthSixteenth:h.push(et.Center),h.push(et.Center),r=[rt.MetNoteQuarterUp],a=[rt.MetNoteQuarterUp];break;case lh.QuarterTripletEighthTriplet:r=[rt.MetNoteQuarterUp],a=[rt.MetNote8thUp],o=rt.Tuplet3;break;case lh.EighthSixteenthTriplet:h.push(et.Center),h.push(et.Right),r=[rt.MetNoteQuarterUp],a=[rt.MetNoteQuarterUp],o=rt.Tuplet3;break;case lh.EighthDottedSixteenth:h.push(et.Center),h.push(et.Right),r=[rt.MetNoteQuarterUp,rt.Space,rt.MetAugmentationDot],a=[rt.MetNoteQuarterUp];break;case lh.SixteenthDottedThirtySecond:h.push(et.Center),h.push(et.Center),h.push(et.Right),r=[rt.MetNoteQuarterUp,rt.Space,rt.MetAugmentationDot],a=[rt.MetNoteQuarterUp];break;case lh.SixteenthEighthDotted:h.push(et.Center),h.push(et.Left),r=[rt.MetNoteQuarterUp],a=[rt.MetNoteQuarterUp,rt.Space,rt.MetAugmentationDot];break;case lh.ThirtySecondSixteenthDotted:h.push(et.Center),h.push(et.Center),h.push(et.Left),r=[rt.MetNoteQuarterUp],a=[rt.MetNoteQuarterUp,rt.Space,rt.MetAugmentationDot]}const c=this.renderer.smuflMetrics.glyphWidths.get(rt.MetNoteQuarterUp)*n,l=t+c-this.renderer.smuflMetrics.stemThickness*n,u=l+2*c+this.renderer.smuflMetrics.stemThickness*n,d=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,f=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,p=this.renderer.smuflMetrics.brokenBeamWidth*n;let b=e-this.renderer.smuflMetrics.glyphHeights.get(rt.MetNoteQuarterUp)*n+d;if(o!==rt.None){const e=(t+u)/2,i=b-this.qk-this.Yk,r=this.renderer.smuflMetrics.glyphTop.get(o)*n,a=this.renderer.smuflMetrics.glyphWidths.get(o)*n;Dt.fillMusicFontSymbolSafe(s,e,i+r,n,o,!0);const h=e-a/2-this.Yk,c=e+a/2+this.Yk,l=this.qk/2,d=s.lineWidth;s.beginPath(),s.moveTo(t,i+l+l),s.lineTo(t,i+l),s.lineTo(h,i+l),s.moveTo(c,i+l),s.lineTo(u,i+l),s.lineTo(u,i+l+l),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*n,s.stroke(),s.lineWidth=d}s.fillMusicFontSymbols(t,e,n,r,!1),t+=c,t+=c,s.fillMusicFontSymbols(t,e,n,a,!1),t+=c,a[a.length-1]!==rt.MetAugmentationDot&&a[0]!==rt.MetNote8thUp||(t+=c);for(const t of h){switch(t){case et.Left:s.fillRect(l,b,p,d);break;case et.Center:s.fillRect(l,b,u-l,d);break;case et.Right:s.fillRect(u-p,b,p,d)}b+=d+f}return t}}class uc extends ao{get notationElement(){return B.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ch.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.index&&(0===e.voice.bar.masterBar.index&&e.voice.bar.masterBar.tripletFeel!==nt.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new lc(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class dc extends Na{constructor(t){super(0,0,1,dc.Fk(t)),this.center=!0}static Fk(t){switch(t){case pt.Open:return rt.GuitarOpenPedal;case pt.Closed:return rt.GuitarClosePedal}return rt.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class fc extends ao{get notationElement(){return B.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==pt.None}createNewGlyph(t,e){return new dc(e.wahPedal)}canExpand(t,e){return!1}}class pc extends ao{get notationElement(){return B.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ch.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new co("w/bar")}canExpand(t,e){return!0}}class bc extends ao{get notationElement(){return B.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ch.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===w.Wide}createNewGlyph(t,e){return new Zo(0,0,w.Wide)}canExpand(t,e){return!0}}class mc extends Do{get notationElement(){return B.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===w.Wide||t.isTieDestination&&t.tieOrigin.vibrato===w.Wide}get sizingMode(){return ch.GroupedOnBeatToEnd}createNewGlyph(t,e){return new Qo(0,0,w.Wide)}}class gc{x=0;width=0;masterBars=[]}class wc extends jh{Qk=null;get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let t=this.pagePadding[0];return this.Qk&&(t+=this.Qk.accoladeWidth),t}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case fs.Automatic:this.systemsLayoutMode=ah.Automatic;break;case fs.UseModelLayout:this.systemsLayoutMode=ah.FromModelWithWidths}const t=this.renderer.score;let e=this.renderer.settings.display.startBar;e--,e=Math.min(t.masterBars.length-1,Math.max(0,e));let s=e,i=this.renderer.settings.display.barCount;i<=0&&(i=t.masterBars.length),i=e+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),this.Qk=this.createEmptyStaffSystem(),this.Qk.isLast=!0,this.Qk.x=this.pagePadding[0],this.Qk.y=this.pagePadding[1];const n=this.renderer.settings.display.barCountPerPartial,r=[];let a=new gc,h=0;for(;s<=i;){const e=this.multiBarRestInfo,i=null!==e&&e.has(s)?e.get(s):null,o=this.Qk.addBars(this.renderer.tracks,s,i);if(0===a.masterBars.length&&o.isLinkedToPrevious&&r.length>0){const e=r[r.length-1];e.masterBars.push(t.masterBars[s]),e.width+=o.width,h+=o.width,a.x+=h}else a.masterBars.push(t.masterBars[s]),a.width+=o.width,a.masterBars.length>=n&&(0===r.length&&(a.width+=this.Qk.accoladeWidth+this.pagePadding[0]),h+=a.width,r.push(a),z.debug(this.name,`Finished partial from bar ${a.masterBars[0].index} to ${a.masterBars[a.masterBars.length-1].index}`,null),a=new gc,a.x=h);s++}a.masterBars.length>0&&(0===r.length&&(a.width+=this.Qk.accoladeWidth+this.pagePadding[0]),r.push(a),z.debug(this.name,`Finished partial from bar ${a.masterBars[0].index} to ${a.masterBars[a.masterBars.length-1].index}`,null)),this.Zk(),this.height=Math.floor(this.Qk.y+this.Qk.height),this.width=this.Qk.x+this.Qk.width+this.pagePadding[2],s=0;let o=0;for(let t=0;t<r.length;t++){const e=r[t],i=new _e;i.x=o,i.y=0,i.totalWidth=this.width,i.totalHeight=this.height,i.width=e.width,i.height=this.height,i.firstMasterBarIndex=e.masterBars[0].index,i.lastMasterBarIndex=e.masterBars[e.masterBars.length-1].index,o+=e.width;const n=s,a=t;this.Qk.buildBoundingsLookup(0,0),this.registerPartial(i,t=>{let s=this.Qk.getBarX(e.masterBars[0].index)+this.Qk.accoladeWidth;0===a&&(s-=this.Qk.x+this.Qk.accoladeWidth),t.color=this.renderer.settings.display.resources.mainGlyphColor,t.textAlign=et.Left,z.debug(this.name,`Rendering partial from bar ${e.masterBars[0].index} to ${e.masterBars[e.masterBars.length-1].index}`,null),this.Qk.paintPartial(-s,this.Qk.y,t,n,e.masterBars.length)}),s+=e.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}Zk(){this.Qk.scaleToWidth(this.Qk.width),this.Qk.finalizeSystem()}}class yc extends jh{tS=[];eS=[];sS=[];get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case fs.Automatic:this.systemsLayoutMode=ah.Automatic;break;case fs.UseModelLayout:this.systemsLayoutMode=ah.FromModelWithScale}let t=this.pagePadding[1];this.width=this.renderer.width,this.eS=[],t=this.iS(t,-1),t=this.nS(t,-1),t=this.rS(t,-1),t=this.aS(t),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let t=this.pagePadding[0];return this.tS.length>0&&(t+=this.tS[0].accoladeWidth),t}doResize(){let t=this.pagePadding[1];this.width=this.renderer.width;const e=this.height;t=this.iS(t,e),t=this.nS(t,e),t=this.rS(t,e),t=this.hS(t,e),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}nS(t,e=-1){if(!this.tuningGlyph)return t;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),n=new _e;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+n.height:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=et.Center,this.tuningGlyph.paint(0,0,t)}),t+i}rS(t,e=-1){if(!this.chordDiagrams)return t;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),n=new _e;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+i:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=et.Center,this.chordDiagrams.paint(0,0,t)}),t+i}iS(t,e=-1){z.debug(this.name,"Layouting score info");const s=new _e;s.x=0,s.y=t;let i=0;const n=this.renderer.settings.display.resources,r=[];for(const[t,e]of jh.headerElements.value)if(this.headerGlyphs.has(t)){const e=this.headerGlyphs.get(t);e.y=i,this.alignScoreInfoGlyph(e);let s=e.font.size;if(t===it.Words&&this.headerGlyphs.has(it.Music)){this.headerGlyphs.get(it.Music).textAlign!==e.textAlign&&(s=0)}i+=s,r.push(e)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=e<0?t+s.height:e,this.registerPartial(s,t=>{t.color=n.scoreInfoColor,t.textAlign=et.Center;for(const e of r)e.paint(0,0,t)})),t+i}hS(t,e){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===ah.FromModelWithScale)for(let s=0;s<this.tS.length;s++){const i=this.tS[s];this.oS(i),t+=this.cS(i,e)}else{this.tS=[];let s=0;const i=this.lS;let n=this.createEmptyStaffSystem();for(n.index=this.tS.length,n.x=this.pagePadding[0],n.y=t;s<this.eS.length;){let r=this.eS[s];if(n.width+r.width<=i||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,r),s++;else{for(;r&&!r.canWrap&&n.masterBarsRenderers.length>1;)r=n.revertLastBar(),s--;n.isFull=!0,n.isLast=this.lastBarIndex===n.lastBarIndex,this.tS.push(n),this.oS(n),t+=this.cS(n,e),n=this.createEmptyStaffSystem(),n.index=this.tS.length,n.x=this.pagePadding[0],n.y=t}}n.isLast=this.lastBarIndex===n.lastBarIndex,this.oS(n),t+=this.cS(n,e)}return t}aS(t){let e=this.firstBarIndex;const s=this.lastBarIndex;for(this.tS=[];e<=s;){const i=this.uS(e,s);this.tS.push(i),i.x=this.pagePadding[0],i.y=t,e=i.lastBarIndex+1,this.oS(i),z.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),t+=this.cS(i,t)}return t}cS(t,e){const s=Math.floor(t.height),i=new _e;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=et.Left,t.paint(0,-i.y/this.renderer.settings.display.scale,e)}),s}oS(t){t.isFull||t.width>this.lS||this.renderer.settings.display.justifyLastSystem?t.scaleToWidth(this.lS):t.scaleToWidth(t.width),t.finalizeSystem()}dS(t){let e=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===ah.FromModelWithScale){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),e=t<i.length?i[t]:s}return e}uS(t,e){const s=this.createEmptyStaffSystem();s.index=this.tS.length;const i=this.dS(s.index),n=this.lS,r=e+1;let a=t;for(;a<r;){if(this.sS.length>0)for(const t of this.sS)s.addMasterBarRenderers(this.renderer.tracks,t),a=t.lastMasterBarIndex;else{const t=this.multiBarRestInfo,e=null!==t&&t.has(a)?t.get(a):null,i=s.addBars(this.renderer.tracks,a,e);this.eS.push(i),a=i.lastMasterBarIndex}this.sS=[];let t=!1;if((-1===i&&s.width>=n&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(t=!0),t){let t=s.revertLastBar();if(t)for(this.sS.push(t);t&&!t.canWrap&&s.masterBarsRenderers.length>1;)t=s.revertLastBar(),t&&this.sS.push(t);return s.isFull=!0,s.isLast=!1,this.sS.reverse(),s}let e=!1,r=!0;for(const t of this.renderer.tracks)t.lineBreaks&&t.lineBreaks.has(a+1)?e=!0:r=!1;if(e&&r)return s.isFull=!0,s.isLast=!1,s;s.x=0,a++}return s.isLast=e===s.lastBarIndex,s}get lS(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class kc extends Ma{constructor(t,e,s){super(t,e),this.width=s}}class Sc extends Ma{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}}class Bc extends Sc{fS;constructor(t,e,s){super(t,e),this.fS=s}doLayout(){this.width=this.fS?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(t,e,s){s.fillRect(t+this.x,e+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}}class _c extends Sc{paint(t,e,s){const i=this.renderer.smuflMetrics.thinBarlineThickness/2,n=this.renderer.getLineHeight(1);let r=e+this.y+.5*n+i;const a=e+this.y+this.height;for(;r<a;)s.fillCircle(t+this.x,r,i),r+=n}}class xc extends Sc{paint(t,e,s){const i=this.renderer.smuflMetrics.dashedBarlineDashLength,n=t+this.x-this.width/2,r=Math.ceil(this.height/2/i),a=e+this.y+this.height,h=this.renderer.smuflMetrics.dashedBarlineGapLength,o=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),r<1)s.moveTo(n,e+this.y),s.lineTo(n,a);else{let t=e+this.y;for(;t<a;){s.moveTo(n,t);const e=Math.min(a-t,i);s.lineTo(n,t+e),t+=i+h}}s.stroke(),s.lineWidth=o}}class Tc extends Sc{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(t,e,s){s.fillRect(t+this.x,e+this.y,this.width,this.height)}}class Mc extends Sc{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.RepeatDot)}paint(t,e,s){const i=this.renderer,n=i.heightLineCount%2==0?1:.5,r=e+this.y+this.height/2,a=i.getLineHeight(n),h=i.smuflMetrics.glyphTop.get(rt.RepeatDot)-i.smuflMetrics.glyphHeights.get(rt.RepeatDot)/2;Dt.fillMusicFontSymbolSafe(s,t+this.x,r+h-a,1,rt.RepeatDot),Dt.fillMusicFontSymbolSafe(s,t+this.x,r+h+a,1,rt.RepeatDot)}}class vc extends Sc{paint(t,e,s){const i=this.renderer;if(i.drawnLineCount-1<=2)return;const n=i.smuflMetrics.staffLineThickness/2,r=(i.drawnLineCount-1)/2,a=i.getLineY(r-1)-n,h=i.getLineY(r+1)+n;s.fillRect(t+this.x,e+a,i.smuflMetrics.thinBarlineThickness,h-a)}}class Nc extends Sc{paint(t,e,s){const i=this.renderer.getLineHeight(1),n=-i/2+1;s.fillRect(t+this.x,e+this.y+n,1,i)}}class Pc extends wh{pS;constructor(t){super(),this.pS=t}doLayout(){const t=this.renderer.bar,e=t.masterBar,s=this.pS?t.getActualBarLineRight():t.getActualBarLineLeft(0===this.renderer.index),i=this.pS&&e.isRepeatEnd||!this.pS&&e.isRepeatStart;let n=D.Automatic;if(!this.pS){const t=this.renderer.previousRenderer;if(t&&t.staff===this.renderer.staff&&(n=t.bar.getActualBarLineRight(),s===n))return}switch(this.pS&&e.isRepeatEnd&&(this.addGlyph(new Mc(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case D.Dashed:this.addGlyph(new xc(0,0));break;case D.Dotted:this.addGlyph(new _c(0,0));break;case D.Heavy:n!==D.LightHeavy&&n!==D.HeavyHeavy&&this.addGlyph(new Tc(0,0));break;case D.HeavyHeavy:n!==D.LightHeavy&&n!==D.Heavy&&this.addGlyph(new Tc(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Tc(0,0));break;case D.HeavyLight:n!==D.LightHeavy&&n!==D.Heavy&&n!==D.HeavyHeavy&&this.addGlyph(new Tc(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Bc(0,0,i));break;case D.LightHeavy:n!==D.HeavyLight&&n!==D.Regular&&n!==D.LightLight&&this.addGlyph(new Bc(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Tc(0,0));break;case D.LightLight:n!==D.HeavyLight&&n!==D.Regular&&this.addGlyph(new Bc(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Bc(0,0,i));break;case D.None:break;case D.Regular:n!==D.HeavyLight&&n!==D.LightLight&&this.addGlyph(new Bc(0,0,i));break;case D.Short:this.addGlyph(new vc(0,0));break;case D.Tick:this.addGlyph(new Nc(0,0))}this.pS||e.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new Mc(0,0)));const r=this.renderer,a=r.smuflMetrics.staffLineThickness,h=this.y+r.topPadding-a,o=this.y+this.renderer.height-this.renderer.bottomPadding-h;for(const t of this.glyphs)t.y=h,t.height=o}paint(t,e,s){const i=this.renderer,n=yh.bar(s,i.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class Ec extends Ma{bS=0;constructor(t,e,s){super(t,e),this.bS=0,this.bS=s}doLayout(){this.width=0}paint(t,e,s){const i=yh.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const i=this.renderer.resources,n=s.textAlign;s.font=i.barNumberFont,s.textAlign=et.Right;const r=`x${this.bS}`,a=s.measureText(r).width/1.5;s.fillText(r,t+this.x-a,e+this.y),s.textAlign=n}finally{i?.[Symbol.dispose]?.()}}}class Fc extends Ma{mS;constructor(t,e,s){super(t,e),this.mS=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this.mS).width}paint(t,e,s){if(!this.renderer.staff.isFirstInSystem)return;const i=yh.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=st.Top,s.font=i.barNumberFont,s.fillText(this.mS,t+this.x,e+this.y),s.textBaseline=n}finally{i?.[Symbol.dispose]?.()}}}class Cc extends Qh{firstLineY=0;gS=!1;tupletSize=0;get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const t=this.lineOffset*(this.heightLineCount-1),e=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(t-e)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(rt.Tuplet0),super.doLayout()}getLineY(t){return this.firstLineY+this.getLineHeight(t)}getLineHeight(t){return this.lineOffset*t}paintBackground(t,e,s){super.paintBackground(t,e,s),this.paintStaffLines(t,e,s),this.paintSimileMark(t,e,s)}paintStaffLines(t,e,s){const i=yh.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const i=[];for(let t=0,e=this.drawnLineCount;t<e;t++)i.push([]);this.additionalMultiRestBars||this.collectSpaces(i);for(const t of i)t.sort((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0);const n=this.width,r=this.smuflMetrics.staffLineThickness/2;for(let a=0;a<this.drawnLineCount;a++){const h=this.getLineY(a)-r;let o=0;for(const n of i[a])s.fillRect(t+this.x+o,e+this.y+h,n[0]-o,this.smuflMetrics.staffLineThickness),o=n[0]+n[1];s.fillRect(t+this.x+o,e+this.y+h,n-o,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(t){}createStartSpacing(){if(this.gS)return;const t=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new kc(0,0,t)),this.gS=!0}paintTuplets(t,e,s,i,n=!1){for(const r of this.bar.voices)if(this.hasVoiceContainer(r)){const a=this.getVoiceContainer(r);for(const r of a.tupletGroups)this.wS(t+this.beatGlyphsStart,e,s,r,i,n)}}getTupletBeamDirection(t){return this.getBeamDirection(t)}wS(t,e,s,i,n,r){const a=this.resources,h=s.textAlign,o=s.textBaseline;let c;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=et.Center,s.textBaseline=st.Middle;const l=i.beats[0].tupletNumerator,u=i.beats[0].tupletDenominator;if(2===l&&3===u)c=[rt.Tuplet2];else if(3===l&&2===u)c=[rt.Tuplet3];else if(4===l&&6===u)c=[rt.Tuplet4];else if(5===l&&4===u)c=[rt.Tuplet5];else if(6===l&&4===u)c=[rt.Tuplet6];else if(7===l&&4===u)c=[rt.Tuplet7];else if(9===l&&8===u)c=[rt.Tuplet9];else if(10===l&&8===u)c=[rt.Tuplet1,rt.Tuplet0];else if(11===l&&8===u)c=[rt.Tuplet1,rt.Tuplet1];else if(12===l&&8===u)c=[rt.Tuplet1,rt.Tuplet2];else if(13===l&&8===u)c=[rt.Tuplet1,rt.Tuplet3];else{c=[];const t=rt.Tuplet0;l>10?(c.push(t+Math.floor(l/10)),c.push(t+(l-10))):c.push(t+l),c.push(rt.TupletColon),u>10?(c.push(t+Math.floor(u/10)),c.push(t+(u-10))):c.push(t+u)}const d=this.tupletOffset,f=this.tupletSize,p=yh.beat(s,n,i.beats[0]);try{const n=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){const n=i.beats[0],h=i.beats[i.beats.length-1];let o=null,l=null;for(let t=0;t<i.beats.length;t++)if(!i.beats[t].isRest){o=i.beats[t];break}for(let t=i.beats.length-1;t>=0;t--)if(!i.beats[t].isRest){l=i.beats[t];break}let u=!1;o||(o=n,u=!0),l||(l=h);const p=this.getBeatX(n,rh.OnNotes)-this.beatGlyphsStart,b=this.getBeatX(h,rh.PostNotes)-this.beatGlyphsStart,m=this.helpers.beamHelperLookup[i.voice.index].get(o.index),g=this.helpers.beamHelperLookup[i.voice.index].get(l.index),w=this.getTupletBeamDirection(m);let y=this.calculateBeamYWithDirection(m,p,w),k=this.calculateBeamYWithDirection(g,b,w);u&&(y=Math.max(y,k),k=y);const S=d+.5*f;w===Ct.Down?(y+=S,k+=S):(y-=S,k-=S);const B=c.reduce((t,e)=>t+a.engravingSettings.glyphWidths.get(e),0),_=.5*a.engravingSettings.oneStaffSpace,x=(p+b)/2,T=x-B/2-_,M=x+B/2+_,v=(k-y)/(b-p),N=y-v*p,P=v*T+N,E=v*x+N,F=v*M+N,C=w===Ct.Down?y-.5*f:y+.5*f,A=w===Ct.Down?k-.5*f:k+.5*f,D=s.lineWidth%2==0?0:.5;t+=D,e+=D,T>p&&(s.beginPath(),s.moveTo(t+this.x+p,e+this.y+C),r?s.quadraticCurveTo(t+this.x+(T+p)/2,e+this.y+P,t+this.x+T,e+this.y+P):(s.lineTo(t+this.x+p,e+this.y+y),s.lineTo(t+this.x+T,e+this.y+P)),s.moveTo(t+this.x+M,e+this.y+F),r?s.quadraticCurveTo(t+this.x+(b+M)/2,e+this.y+F,t+this.x+b,e+this.y+A):(s.lineTo(t+this.x+b,e+this.y+k),s.lineTo(t+this.x+b,e+this.y+A)),s.stroke()),s.fillMusicFontSymbols(t+this.x+x,e+this.y+E+.5*f,1,c,!0)}else for(const n of i.beats){const r=this.helpers.beamHelperLookup[i.voice.index].get(n.index);if(!r)continue;const a=this.getTupletBeamDirection(r),h=r.getBeatLineX(n);let o=this.calculateBeamYWithDirection(r,h,a);a===Ct.Down?o+=d+f:o-=d+f,s.fillMusicFontSymbols(t+this.x+h,e+this.y+o,1,c,!0)}s.textAlign=h,s.textBaseline=o,s.lineWidth=n}finally{p?.[Symbol.dispose]?.()}}paintBeams(t,e,s,i,n){for(const r of this.helpers.beamHelpers)for(const a of r)this.yS(t+this.beatGlyphsStart,e,s,a,i,n)}drawBeamHelperAsFlags(t){return 1===t.beats.length}yS(t,e,s,i,n,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isRestBeamHelper||(this.drawBeamHelperAsFlags(i)?this.paintFlag(t,e,s,i,n):this.paintBar(t,e,s,i,r))}shouldPaintFlag(t,e){return t.graceType!==l.BendGrace&&(!t.deadSlapped&&(!!e.hasBeatLineX(t)&&((t.graceType===l.None||this.settings.notation.notationMode!==S.SongBook)&&(t.duration!==c.Whole&&t.duration!==c.DoubleWhole&&t.duration!==c.QuadrupleWhole))))}paintFlag(t,e,s,i,n){for(const r of i.beats){if(!this.shouldPaintFlag(r,i))continue;const a=r.graceType!==l.None,h=i.getBeatLineX(r),o=this.getBeamDirection(i),c=e+this.y+this.getFlagTopY(r,o),u=e+this.y+this.getFlagBottomY(r,o);let d=0;if(d=o===Ct.Down?u:c,!i.hasLine(!0,r))continue;this.paintBeamingStem(r,e+this.y,t+this.x+h,c,u,s);const f=yh.beat(s,n,r);try{let e=0;if(i.hasFlag(!0,r)){const i=new Fa(t+this.x+h,d,r.duration,o,a);i.renderer=this,i.doLayout(),i.paint(0,0,s),e=i.width/2}r.graceType===l.BeforeBeat&&(o===Ct.Down?Dt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+u-this.smuflMetrics.glyphHeights.get(rt.GraceNoteSlashStemDown))/2,Ea.GraceScale,rt.GraceNoteSlashStemDown,!0):Dt.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+u+this.smuflMetrics.glyphHeights.get(rt.GraceNoteSlashStemUp))/2,Ea.GraceScale,rt.GraceNoteSlashStemUp,!0))}finally{f?.[Symbol.dispose]?.()}}}getFlagStemSize(t,e=!1){let s=0;switch(t){case c.QuadrupleWhole:case c.Half:case c.Quarter:case c.Eighth:case c.Sixteenth:case c.ThirtySecond:case c.SixtyFourth:case c.OneHundredTwentyEighth:case c.TwoHundredFiftySixth:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(t);break;default:s=e?this.smuflMetrics.standardStemLength:0}return s}recreatePreBeatGlyphs(){this.gS=!1,super.recreatePreBeatGlyphs()}calculateBeamY(t,e){return this.calculateBeamYWithDirection(t,e,this.getBeamDirection(t))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new Pc(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new Fc(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();const t=this.lastBar;this.addPostBeatGlyph(new Pc(!0)),t.masterBar.isRepeatEnd&&t.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Ec(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(t,e,s,i,n){const r=this.getBeamDirection(i),a=i.graceType!==l.None?Ea.GraceScale:1;let h=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*a,o=this.smuflMetrics.beamThickness*a;r===Ct.Down&&(h=-h,o=-o);for(let c=0,l=i.beats.length;c<l;c++){const l=i.beats[c];if(!i.hasBeatLineX(l)||l.deadSlapped)continue;const u=i.getBeatLineX(l),d=e+this.y+this.getBarLineStart(l,r),f=e+this.y+this.calculateBeamY(i,u)|0;d<f?this.paintBeamingStem(l,e+this.y,t+this.x+u,d,f,s):this.paintBeamingStem(l,e+this.y,t+this.x+u,f,d,s);const p=yh.beat(s,n,l);try{const n=this.smuflMetrics.brokenBeamWidth*a,r=Vt.getIndex(l.duration)-2,d=e+this.y;for(let e=0;e<r;e++){let a=0,f=0,p=0,b=0;const m=d+e*h;if(c<i.beats.length-1){const h=xh.isFullBarJoin(l,i.beats[c+1],e);if(e===r-1&&h&&l.beamingMode===gt.ForceSplitOnSecondaryToNext)a=u,f=a+n,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Cc.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o),f=i.getBeatLineX(i.beats[c+1]),a=f-n,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Cc.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o);else{if(h)a=u,f=i.getBeatLineX(i.beats[c+1]);else{if(0!==c&&xh.isFullBarJoin(i.beats[c-1],l,e))continue;a=u,f=a+n}p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),0===e&&(p|=0,b|=0),Cc.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o)}}else c>0&&!xh.isFullBarJoin(l,i.beats[c-1],e)&&(a=u-n,f=u,f=u,p=m+this.calculateBeamY(i,a),b=m+this.calculateBeamY(i,f),Cc.paintSingleBar(s,t+this.x+a,p,t+this.x+f,b,o))}}finally{p?.[Symbol.dispose]?.()}}if(i.graceType===l.BeforeBeat){const n=i.getBeatLineX(i.beats[0]),a=this.smuflMetrics.glyphWidths.get(rt.Flag8thUp)*Ea.GraceScale;let c=e+this.y+this.calculateBeamY(i,n)|0;c+=o+h,r===Ct.Down?Dt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Ea.GraceScale,rt.GraceNoteSlashStemDown,!0):Dt.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Ea.GraceScale,rt.GraceNoteSlashStemUp,!0)}}static paintSingleBar(t,e,s,i,n,r){t.beginPath(),t.moveTo(e,s),t.lineTo(i,n),t.lineTo(i,n+r),t.lineTo(e,s+r),t.closePath(),t.fill()}}class Ac extends Ma{startBeat;endBeat;yOffset=0;forEnd;startNoteRenderer=null;endNoteRenderer=null;tieDirection=Ct.Up;constructor(t,e,s){super(0,0),this.startBeat=t,this.endBeat=e,this.forEnd=s}kS=0;SS=0;BS=0;_S=0;xS=0;TS=!1;doLayout(){if(this.width=0,!this.endBeat)return void(this.TS=!1);const t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=t;const e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=e,this.kS=0,this.BS=0,this.SS=0,this._S=0,this.height=0,this.TS=!1,this.tieDirection=t?this.getBeamDirection(this.startBeat,t):this.getBeamDirection(this.endBeat,e),!this.forEnd&&t?(t!==e?(this.kS=t.x+this.getStartX(),this.SS=t.y+this.getStartY()+this.yOffset,e&&t.staff===e.staff?(this.BS=e.x+this.getEndX(),this._S=e.y+this.getEndY()+this.yOffset):(this.BS=t.x+t.width,this._S=this.SS)):(this.kS=t.x+this.getStartX(),this.BS=e.x+this.getEndX(),this.SS=t.y+this.getStartY()+this.yOffset,this._S=e.y+this.getEndY()+this.yOffset),this.TS=!0):t&&t.staff===e.staff||(this.kS=e.x,this.BS=e.x+this.getEndX(),this.SS=e.y+this.getEndY()+this.yOffset,this._S=this.SS,this.TS=!0),this.TS)if(this.y=Math.min(this.SS,this._S),this.shouldDrawBendSlur())this.xS=0;else{this.xS=this.getTieHeight(this.kS,this.SS,this.BS,this._S);const t=Ac.calculateActualTieHeight(1,this.kS,this.SS,this.BS,this._S,this.tieDirection===Ct.Down,this.xS,this.renderer.smuflMetrics.tieMidpointThickness);if(this.height=t.h,this.tieDirection===Ct.Up){const e=this.y-t.y;e>0&&(this.y-=e)}}}paint(t,e,s){this.TS&&(this.shouldDrawBendSlur()?Ac.drawBendSlur(s,t+this.kS,e+this.SS,t+this.BS,e+this._S,this.tieDirection===Ct.Down,1,this.renderer.smuflMetrics.tieHeight):Ac.paintTie(s,1,t+this.kS,e+this.SS,t+this.BS,e+this._S,this.tieDirection===Ct.Down,this.xS,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(t,e,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(t,e){return Ct.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(t,e,s,i,n,r,a,h){const o=Ac.MS(t,e,s,i,n,r,a,h);e=o[0],s=o[1];const c=o[2],l=o[3];i=o[6],n=o[7];const u=(e-c)/(e-2*c+i),d=Ac.vS(e,s,c,l,i,n,u),f=d.length>0?Math.min(e,i,d[0]):Math.min(e,i),p=d.length>0?Math.max(e,i,d[0]):Math.max(e,i),b=(s-l)/(s-2*l+n),m=Ac.vS(e,s,c,l,i,n,b),g=m.length>0?Math.min(s,n,m[1]):Math.min(s,n),w=m.length>0?Math.max(s,n,m[1]):Math.max(s,n),y=new Ne;return y.x=f,y.y=g,y.w=p-f,y.h=w-g,y}static vS(t,e,s,i,n,r,a){if(a<=0||1<=a)return[];const h=t+(s-t)*a,o=e+(i-e)*a;return[h+(s+(n-s)*a-h)*a,o+(i+(r-i)*a-o)*a]}static MS(t,e,s,i,n,r,a,h){if(e===i&&s===n)return[];if(i<e){let t=e;e=i,i=t,t=s,s=n,n=t}a*=t,h*=t,r&&(a*=-1,h*=-1),t>=1&&(h*=1.2);const o=n-s,c=i-e,l=Math.sqrt(c*c+o*o);let u=e+.25*l,d=s-a,f=e+.75*l,p=s-a,b=e+.75*l,m=s-a-h,g=e+.25*l,w=s-a-h;const y=Math.atan2(o,c);return[u,d]=Ac.NS(u,d,e,s,y),[f,p]=Ac.NS(f,p,e,s,y),[b,m]=Ac.NS(b,m,e,s,y),[g,w]=Ac.NS(g,w,e,s,y),[e,s,u,d,f,p,i,n,b,m,g,w,e,s]}static NS(t,e,s,i,n){const r=t-s,a=e-i;return[s+(r*Math.cos(n)-a*Math.sin(n)),i+(r*Math.sin(n)+a*Math.cos(n))]}static paintTie(t,e,s,i,n,r,a,h,o){const c=Ac.MS(e,s,i,n,r,a,h,o);t.beginPath(),t.moveTo(c[0],c[1]),t.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]),t.bezierCurveTo(c[8],c[9],c[10],c[11],c[12],c[13]),t.closePath(),t.fill()}static drawBendSlur(t,e,s,i,n,r,a,h,o){let c=n-s,l=i-e;const u=Math.sqrt(c*c+l*l);r?c*=-1:l*=-1,c/=u,l/=u;let d=h*a;i-e<20&&(d/=2);const f=(i+e)/2+d*c,p=(n+s)/2+d*l;if(t.beginPath(),t.moveTo(e,s),t.lineTo(f,p),t.lineTo(i,n),t.stroke(),o){const e=t.measureText(o).width,s=r?0:-t.font.size;t.fillText(o,f-e/2,p+s)}}}class Dc extends Ac{startNote;endNote;constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}get PS(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return Ct.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,hh.Top)}getEndY(){return this.getStartY()}getStartX(){return this.PS?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,oh.Center)}getEndX(){return this.PS?this.endNoteRenderer.getNoteX(this.endNote,oh.Left):this.endNoteRenderer.getNoteX(this.endNote,oh.Center)}}class Lc extends Ac{startNote;endNote;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}get PS(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.PS?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return this.PS?Ct.Up:Lc.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?Ct.Up:Ct.Down}getStartY(){return this.PS?this.startNoteRenderer.getNoteY(this.startNote,hh.Center):this.tieDirection===Ct.Up?this.startNoteRenderer.getNoteY(this.startNote,hh.Top):this.startNoteRenderer.getNoteY(this.startNote,hh.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.PS?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,oh.Center)}getEndX(){return this.PS?this.endNoteRenderer.getNoteX(this.endNote,oh.Left):this.endNoteRenderer.getNoteX(this.endNote,oh.Center)}}class Wc extends Lc{ES;FS;constructor(t,e,s,i=!1){super(t,e,i),this.ES=Ct.Up,this.FS=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.FS!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;switch(this.ES){case Ct.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case Ct.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),n=this.getBeamDirection(this.startBeat,i),r=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${n}`,a=this.renderer;a.staff.getSharedLayoutData(r,!1)||(a.staff.setSharedLayoutData(r,!0),super.paint(t,e,s))}}class Oc extends Ca{CS=[];createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible){const e=new Dc(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination){const e=new Dc(t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new Dc(t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.CS)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new Wc(t,t.effectSlurDestination,!1,!1);this.CS.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.CS)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new Wc(t.effectSlurOrigin,t,!1,!0);this.CS.push(e),this.addTie(e)}}}}}class Rc extends Ma{AS;ge;mS;constructor(t,e,s,i,n){super(t,e),this.AS=i,this.mS=s,this.ge=n}paint(t,e,s){const i=this.ge.isRest?yh.beat(s,wt.NumberedRests,this.ge):this.ge.notes.length>0?yh.note(s,lt.NumberedNumber,this.ge.notes[0]):void 0;try{const i=this.renderer.resources;s.font=this.AS?i.numberedNotationGraceFont:i.numberedNotationFont,s.textBaseline=st.Middle,s.textAlign=et.Left,s.fillText(this.mS.toString(),t+this.x,e+this.y)}finally{i?.[Symbol.dispose]?.()}}doLayout(){const t=this.renderer.resources,e=this.AS?t.numberedNotationGraceFont:t.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=e;const i=s.measureText(`${this.mS}`);this.height=i.height,this.width=i.width}}class Ic{x=0;y=-3e3;width=0}class Gc extends gh{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((t,e)=>t.y<e.y?-1:t.y>e.y?1:0);const t=[];t.push(new Ic);for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.renderer=this.renderer,s.doLayout();let i=0;for(;t[i].y>s.y;)i++,i===t.length&&t.push(new Ic);s.x=i,t[i].y=s.y+s.height,t[i].width<s.width&&(t[i].width=s.width)}this.width=0;const e=this.renderer.smuflMetrics.accidentalPadding;for(const s of t)this.width+=s.width+e,s.x=this.width;for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e],i=t[s.x];s.x=this.width-i.x}}}class $c extends Na{constructor(t,e,s,i){super(t,e,i,$c.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case at.Natural:return rt.AccidentalNatural;case at.Sharp:return rt.AccidentalSharp;case at.Flat:return rt.AccidentalFlat;case at.NaturalQuarterNoteUp:return rt.AccidentalQuarterToneSharpNaturalArrowUp;case at.SharpQuarterNoteUp:return rt.AccidentalThreeQuarterTonesSharpArrowUp;case at.FlatQuarterNoteUp:return rt.AccidentalQuarterToneFlatArrowUp;case at.DoubleSharp:return rt.AccidentalDoubleSharp;case at.DoubleFlat:return rt.AccidentalDoubleFlat}return rt.None}}class Vc extends Na{constructor(t,e){super(t,e,1,rt.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class Hc extends Ma{ge;constructor(t,e,s){super(t,e),this.ge=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(t,e,s){const i=yh.beat(s,wt.NumberedDuration,this.ge);try{const i=this.renderer.smuflMetrics.numberedDashGlyphPadding;s.fillRect(t+this.x,Math.ceil(e+this.y-this.height),this.width-i,this.height)}finally{i?.[Symbol.dispose]?.()}}}class Uc extends Ma{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.NoteheadSlashWhiteHalf)}paint(t,e,s){const i=this.renderer,n=i.getLineHeight(i.heightLineCount-1),r=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-n/2,a=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(t+this.x,e+r),s.lineTo(t+this.x+this.width,e+r+n),s.moveTo(t+this.x,e+r+n),s.lineTo(t+this.x+this.width,e+r),s.stroke(),s.lineWidth=a}}class zc extends Xh{isNaturalizeAccidental=!1;accidental=at.None;get effectElement(){return wt.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const t=new Gc;if(t.renderer=this.renderer,this.container.beat.notes.length>0){const e=this.container.beat.notes[0],s=e?e.accidentalMode:p.Default,i=di.getNoteValue(e);let n=Vt.computeAccidental(this.renderer.bar.keySignature,s,i,e.hasQuarterToneOffset);if(n===at.Natural){n=this.renderer.bar.keySignature+7<7?at.Sharp:at.Flat,this.isNaturalizeAccidental=!0}if(n!==at.None){this.accidental=n;const s=this.renderer,i=yh.noteColor(s.resources,lt.NumberedAccidentals,e),r=new $c(0,s.getLineY(0),n,e.beat.graceType!==l.None?Ea.GraceScale*Ea.GraceScale:Ea.GraceScale);r.colorOverride=i,r.renderer=this.renderer,t.addGlyph(r),this.addNormal(t),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}class jc extends Jh{noteHeads=null;deadSlapped=null;octaveDots=0;get effectElement(){return wt.NumberedEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case oh.Left:break;case oh.Center:t+=s.width/2;break;case oh.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new Ee;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Ne,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(){return this.DS(hh.Center)}getHighestNoteY(){return this.DS(hh.Center)}getNoteY(t,e){return this.DS(e)}DS(t){let e=null;if(this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e){let s=this.y+e.y;switch(t){case hh.Top:case hh.TopWithStem:s-=e.height/2;break;case hh.Center:break;case hh.Bottom:case hh.BottomWithStem:s+=e.height/2;case hh.StemUp:case hh.StemDown:}return s}return 0}updateBeamingHelper(){if(this.beamingHelper){let t=null;this.noteHeads?t=this.noteHeads:this.deadSlapped&&(t=this.deadSlapped),t&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+t.x,this.container.x+this.x+t.x+t.width)}}static majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61];static minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];doLayout(){const t=this.renderer;t.shortestDuration<this.container.beat.duration&&(t.shortestDuration=this.container.beat.duration);const e=t.getLineY(t.getNoteLine());if(!this.container.beat.isEmpty){let s="0";if(this.container.beat.notes.length>0){const e=this.renderer.bar.keySignatureType,i=this.renderer.bar.keySignature,n=i+7,r=(e===F.Minor?jc.minorKeySignatureOneValues:jc.majorKeySignatureOneValues)[n],a=this.container.beat.notes[0];if(a.isDead)s="X";else{const e=a.displayValue-r,h=e<0?(e%12+12)%12:e%12;let o=e<0?(Math.abs(e)+12)/12|0:e/12|0;e<0&&(o*=-1),this.octaveDots=o,t.registerOctave(o);let c=(Vt.keySignatureIsSharp(i)||Vt.keySignatureIsNatural(i)?di.flatNoteSteps:di.sharpNoteSteps)[h]+1;Vt.accidentalNotes[h]&&!this.container.preNotes.isNaturalizeAccidental&&(n<7?c++:c--),s=c.toString()}}if(this.container.beat.deadSlapped){const t=new Uc;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else{const t=this.container.beat.graceType!==l.None,i=new Rc(0,e,s,t,this.container.beat);this.noteHeads=i,this.addNormal(i)}if(this.container.beat.dots>0&&this.container.beat.duration>=c.Quarter)for(let e=0;e<this.container.beat.dots;e++){const e=new Vc(0,t.getLineY(0));e.renderer=this.renderer,this.addEffect(e)}let i=0;switch(this.container.beat.duration){case c.QuadrupleWhole:i=16;break;case c.DoubleWhole:i=8;break;case c.Whole:i=4;break;case c.Half:i=2}let n=i;for(let t=0;t<this.container.beat.dots;t++)n=n/2|0,i+=n;for(let e=0;e<i-1;e++){const e=new Hc(0,t.getLineY(0),this.container.beat);e.renderer=this.renderer,this.addNormal(e)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class Xc extends Ma{LS;colorOverride;constructor(t){super(0,0),this.LS=t}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this.LS?Ac.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y+this.height,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):Ac.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class Jc extends gh{WS=0;OS=0;RS;IS;barSubElement=A.StandardNotationTimeSignature;constructor(t,e,s,i,n,r){super(t,e),this.WS=s,this.OS=i,this.RS=n,this.IS=r}paint(t,e,s){const i=yh.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this.RS&&2===this.WS&&2===this.OS){const t=new Na(0,0,this.commonScale,rt.TimeSigCutCommon);this.addGlyph(t),super.doLayout()}else if(this.RS&&4===this.WS&&4===this.OS){const t=new Na(0,0,this.commonScale,rt.TimeSigCommon);this.addGlyph(t),super.doLayout()}else{const t=new qh(0,0,this.WS,st.Top,this.numberScale),e=new qh(0,0,this.OS,st.Bottom,this.numberScale);this.addGlyph(t),this.addGlyph(e),super.doLayout();const s=this.width;t.x=(s-t.width)/2,e.x=(s-e.width)/2,this.width=Math.max(t.x+t.width,e.x+e.width)}if(this.IS){const t=2*this.renderer.smuflMetrics.oneStaffSpace,e=new Xc(!0);e.renderer=this.renderer,e.y=-t,e.height=2*t,e.doLayout();for(const t of this.glyphs)t.x+=e.width;this.width+=e.width,this.addGlyph(e);const s=new Xc(!1);s.renderer=this.renderer,s.x=this.width,s.y=-t,s.height=2*t,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class qc extends Jc{get commonScale(){return 1}get numberScale(){return 1}}class Yc extends Ma{GS;$S;xk="";VS=at.None;HS=0;constructor(t,e,s,i){super(t,e),this.GS=s,this.$S=i}doLayout(){super.doLayout();const t="1 = ";let e="",s=at.None;switch(this.$S){case F.Major:switch(this.GS){case E.Cb:e="  C",s=at.Flat;break;case E.Gb:e="  G",s=at.Flat;break;case E.Db:e="  D",s=at.Flat;break;case E.Ab:e="  A",s=at.Flat;break;case E.Eb:e="  E",s=at.Flat;break;case E.Bb:e="  B",s=at.Flat;break;case E.F:e="F";break;case E.C:e="C",s=at.None;break;case E.G:e="G",s=at.None;break;case E.D:e="D",s=at.None;break;case E.A:e="A",s=at.None;break;case E.E:e="E",s=at.None;break;case E.B:e="B",s=at.None;break;case E.FSharp:e="  F",s=at.Sharp;break;case E.CSharp:e="  C",s=at.Sharp}break;case F.Minor:switch(this.GS){case E.Cb:e="  a",s=at.Flat;break;case E.Gb:e="  e",s=at.Flat;break;case E.Db:e="  b",s=at.Flat;break;case E.Ab:e="f",s=at.None;break;case E.Eb:e="c",s=at.None;break;case E.Bb:e="g",s=at.None;break;case E.F:e="d";break;case E.C:e="a",s=at.None;break;case E.G:e="e",s=at.None;break;case E.D:e="b",s=at.None;break;case E.A:e="  f",s=at.Sharp;break;case E.E:e="  c",s=at.Sharp;break;case E.B:e="  g",s=at.Sharp;break;case E.FSharp:e="  d",s=at.Sharp;break;case E.CSharp:e="  a",s=at.Sharp}}this.xk=t+e,this.VS=s;const i=this.renderer.scoreRenderer.canvas,n=this.renderer.resources;i.font=n.numberedNotationFont,this.HS=i.measureText(t).width,this.width=i.measureText(t+e).width}paint(t,e,s){const i=yh.bar(s,A.NumberedKeySignature,this.renderer.bar);try{const i=this.renderer.resources;s.font=i.numberedNotationFont,s.textBaseline=st.Middle,s.fillText(this.xk,t+this.x,e+this.y),this.VS!==at.None&&Dt.fillMusicFontSymbolSafe(s,t+this.x+this.HS,e+this.y,1,$c.getMusicSymbol(this.VS),!1)}finally{i?.[Symbol.dispose]?.()}}}class Kc extends Cc{static StaffId="numbered";simpleWhammyOverflow=0;US;shortestDuration=c.QuadrupleWhole;lowestOctave=null;highestOctave=null;get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(rt.AugmentationDot)}registerOctave(t){null===this.lowestOctave?(this.lowestOctave=t,this.highestOctave=t):(t<this.lowestOctave&&(this.lowestOctave=t),t>this.highestOctave&&(this.highestOctave=t))}get repeatsBarSubElement(){return A.NumberedRepeats}get barNumberBarSubElement(){return A.NumberedBarNumber}get barLineBarSubElement(){return A.NumberedBarLines}get staffLineBarSubElement(){return A.NumberedStaffLine}constructor(t,e){super(t,e),this.US=!e.staff.showSlash&&!e.staff.showTablature&&!e.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,wt.NumberedDuration,wt.NumberedDuration),this.paintTuplets(t,e,s,wt.NumberedTuplet,!0)}doLayout(){super.doLayout();let t=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)){if(this.getVoiceContainer(e).tupletGroups.length>0){t=!0;break}}if(t&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){const t=Vt.getIndex(this.shortestDuration)-2,e=this.dotSpacing;if(t>0){const s=(t-1)*this.smuflMetrics.numberedBarRendererBarSpacing+this.smuflMetrics.numberedBarRendererBarSize;let i=0;const n=this.lowestOctave;null!==n&&(i=Math.abs(n)*e+this.smuflMetrics.glyphHeights.get(rt.AugmentationDot)),this.registerOverflowBottom(s+i)}const s=this.highestOctave;if(null!==s){const t=Math.abs(s)*e+this.smuflMetrics.glyphHeights.get(rt.AugmentationDot);this.registerOverflowTop(t)}}}paintFlag(t,e,s,i,n){this.paintBar(t,e,s,i,n)}paintBar(t,e,s,i,n){if(0===i.beats.length)return;const r=this.resources;for(let a=0,h=i.beats.length;a<h;a++){const h=i.beats[a],o=yh.beat(s,n,h);try{const n=this.smuflMetrics.numberedBarRendererBarSpacing,o=this.smuflMetrics.numberedBarRendererBarSize,c=Vt.getIndex(h.duration)-2,l=e+this.y,u=this.getBeatX(h,rh.PreNotes)-this.beatGlyphsStart,d=this.calculateBeamY(i,u);for(let e=0;e<c;e++){let r=0,c=0,f=0;const p=l+e*n;a===i.beats.length-1?(r=u,c=this.getBeatX(h,rh.PostNotes)-this.beatGlyphsStart):(r=u,c=this.getBeatX(i.beats[a+1],rh.PreNotes)-this.beatGlyphsStart),f=p+d,s.fillRect(t+this.x+r,f,c-r,o)}const f=this.getBeatContainer(h).onNotes;let p=f instanceof jc?f.octaveDots:0;const b=this.dotSpacing;let m=0,g=0;p>0?(m=l+this.getLineY(0)-r.numberedNotationFont.size,g=-1*b):p<0&&(m=l+d+c*(n+o),g=b);const w=this.getBeatX(h,rh.MiddleNotes)-this.beatGlyphsStart;p=Math.abs(p);for(let e=0;e<p;e++)Dt.fillMusicFontSymbolSafe(s,t+this.x+w,m,1,rt.AugmentationDot,!0),m+=g}finally{o?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+1.5*this.resources.numberedNotationFont.size}getFlagTopY(t,e){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(t,e){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(t){return Ct.Down}getTupletBeamDirection(t){return Ct.Up}getNoteY(t,e){let s=super.getNoteY(t,e);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(t,e,s){const i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size}getBarLineStart(t,e){const s=this.smuflMetrics.glyphHeights.get(rt.NoteheadBlack);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this.US)&&this.addPreBeatGlyph(new Pc(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new Fc(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){this.bar.previousBar&&this.bar.keySignature===this.bar.previousBar.keySignature||(this.createStartSpacing(),this.zS()),this.US&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.jS())}zS(){this.addPreBeatGlyph(new Yc(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}jS(){this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new qc(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=A.NumberedTimeSignature,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this.US&&super.createPostBeatGlyphs()}createVoiceGlyphs(t){for(const e of t.beats){const s=new Oc(e,this.getVoiceContainer(t));s.preNotes=0===t.index?new zc:new Xh,s.onNotes=0===t.index?new jc:new Jh,this.addBeatGlyph(s)}}paintBeamingStem(t,e,s,i,n,r){}}class Qc extends mh{get staffId(){return Kc.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Kc(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class Zc extends Na{XS;JS;constructor(t,e,s,i){super(t,e,1,Zc.Fk(s,i)),this.XS=s,this.JS=i}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.GClef),this.offsetX=this.width/2}static Fk(t,e){switch(t){case N.Neutral:return rt.UnpitchedPercussionClef1;case N.C3:case N.C4:return e===b.T?rt.CClef8vb:rt.CClef;case N.F4:switch(e){case b.S:return rt.FClef15ma;case b._:return rt.FClef8va;case b.T:return rt.FClef8vb;case b.M:return rt.FClef15mb;default:return rt.FClef}case N.G2:switch(e){case b.S:return rt.GClef15ma;case b._:return rt.GClef8va;case b.T:return rt.GClef8vb;case b.M:return rt.GClef15mb;default:return rt.GClef}default:return rt.None}}paint(t,e,s){const i=yh.bar(s,A.StandardNotationClef,this.renderer.bar);try{switch(super.paint(t,e,s),this.XS){case N.C3:case N.C4:if(this.JS===b.T)return;break;case N.F4:case N.G2:return}let i,n=!1;switch(this.JS){case b.S:i=rt.Clef15,n=!0;break;case b._:i=rt.Clef8,n=!0;break;case b.T:i=rt.Clef8;break;case b.M:i=rt.Clef15;break;default:return}const r=this.width/2,a=n?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(i);Dt.fillMusicFontSymbolSafe(s,t+this.x+r,e+this.y-a,1,i,!0)}finally{i?.[Symbol.dispose]?.()}}}class tl extends va{xe;constructor(t,e,s){super(t,e),this.xe=s}static Fk(t,e){switch(t){case u.None:return rt.None;case u.Normal:return e?rt.ArticAccentAbove:rt.ArticAccentBelow;case u.Heavy:return e?rt.ArticMarcatoAbove:rt.ArticMarcatoBelow;case u.Tenuto:return e?rt.ArticTenutoAbove:rt.ArticTenutoBelow;default:return rt.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.ArticAccentAbove)}paint(t,e,s){const i=this.renderer.getBeatDirection(this.xe.beat),n=tl.Fk(this.xe.accentuated,i===Ct.Down),r=i===Ct.Up?e+this.y:e+this.y+this.height;Dt.fillMusicFontSymbolSafe(s,t+this.x,r,1,n,!0)}}class el extends Na{constructor(t,e,s){super(t,e,s?Ea.GraceScale:1,rt.NoteheadXOrnate)}}class sl extends Na{constructor(t,e,s,i){super(t,e,i?Ea.GraceScale:1,sl.Fk(s))}static Fk(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:case c.Whole:case c.Half:return rt.NoteheadDiamondWhiteWide;default:return rt.NoteheadDiamondBlackWide}}}class il{line=0;isGhost;color;constructor(t,e,s){this.line=t,this.isGhost=e,this.color=s}}class nl extends Ma{LS;uk=[];qS=[];isEmpty=!0;constructor(t){super(0,0),this.LS=t}addParenthesis(t){const e=this.renderer,s=e.getNoteLine(t),i=t.isGhost||this.YS(t)&&e.settings.notation.isNotationElementVisible(B.ParenthesisOnTiedBends),n=yh.noteColor(e.resources,lt.Effects,t);this.KS(new il(s,i,n))}addParenthesisOnLine(t,e){const s=new il(t,e,void 0);this.KS(s)}KS(t){this.uk.push(t),t.isGhost&&(this.isEmpty=!1)}YS(t){return!!t.isTieDestination&&(!!t.tieOrigin.hasBend||this.YS(t.tieOrigin))}doLayout(){const t=this.renderer;this.uk.sort((t,e)=>t.line-e.line);let e=null;const s=t.getScoreHeight(1);for(let i=0,n=this.uk.length;i<n;i++){let n;if(this.uk[i].isGhost)if(e){const n=t.getScoreY(this.uk[i].line)+s;e.height=n-e.y}else n=new Xc(this.LS),n.colorOverride=this.uk[i].color,n.renderer=this.renderer,n.y=t.getScoreY(this.uk[i].line)-s,n.height=2*s,n.doLayout(),this.qS.push(n),e=n;else e=null}this.width=this.qS.length>0?this.qS[0].width:0}paint(t,e,s){super.paint(t,e,s);for(const i of this.qS)i.paint(t+this.x,e+this.y,s)}}class rl{glyph;steps=0;constructor(t,e){this.glyph=t,this.steps=e}}class al extends Ma{uk=[];minNote=null;maxNote=null;upLineX=0;downLineX=0;noteStartX=0;constructor(){super(0,0)}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(t,e){const s=new rl(t,e);this.uk.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this.uk.sort((t,e)=>e.steps-t.steps);let t=0,e=0,s=!0,i=0,n=!1;const r=this.direction,a=this.renderer.smuflMetrics,h=this.scale,o=new Map;for(let r=0,c=this.uk.length;r<c;r++){const c=this.uk[r].glyph;if(c.renderer=this.renderer,c.doLayout(),r>0&&Math.abs(i-this.uk[r].steps)<=1?s?(s=!1,o.set(r,!1)):(n=!0,s=!0,o.set(r,!0)):(s=!1,o.set(r,!1)),a.stemUp.has(c.symbol)){const e=a.stemUp.get(c.symbol).x*h;e>t&&(t=e)}else{const e=a.glyphWidths.get(c.symbol)*h;e>t&&(t=e)}if(a.stemDown.has(c.symbol)){const s=a.stemDown.get(c.symbol).x*h;if(s>e){const i=s-e;e=s,t+=i}}i=this.uk[r].steps}const c=n||r===Ct.Up?t:e;let l=0;for(let t=0,s=this.uk.length;t<s;t++){const s=this.uk[t].glyph;o.get(t)?s.x=c:(s.x=e,a.stemDown.has(s.symbol)&&(s.x-=a.stemDown.get(s.symbol).x*h)),s.x+=this.noteStartX,l=Math.max(l,s.x+s.width),s instanceof Ea&&s.centerOnStem&&(s.x=c)}n?(this.upLineX=c,this.downLineX=c):(this.upLineX=t,this.downLineX=e),this.width=l}paint(t,e,s){t+=this.x,e+=this.y,this.QS(t,e,s);const i=this.uk;for(const n of i)n.glyph.renderer=this.renderer,n.glyph.paint(t,e,s)}QS(t,e,s){if(!this.minNote)return;const i=this.renderer,n=yh.bar(s,A.StandardNotationStaffLine,i.bar,!0);try{const n=this.scale,r=this.renderer.smuflMetrics.legerLineExtension*n,a=this.width-this.noteStartX+2*r,h=i.getLineHeight(1),o=i.getLineY(-1),c=i.getLineY(i.drawnLineCount),l=i.getLineY(this.minNote.steps/2),u=i.getLineY(this.maxNote.steps/2),d=this.renderer.smuflMetrics.legerLineThickness*n/2;let f=o;for(;f>=l;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f-=h;for(f=c;f<=u;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f+=h}finally{n?.[Symbol.dispose]?.()}}}class hl extends Na{constructor(t,e,s){super(t,e,1,hl.Fk(s))}static Fk(t){switch(t){case c.ThirtySecond:return rt.Tremolo3;case c.Sixteenth:return rt.Tremolo2;case c.Eighth:return rt.Tremolo1;default:return rt.None}}}class ol extends al{ZS=new Map;tB=[];eB=null;sB=null;aboveBeatEffects=new Map;belowBeatEffects=new Map;beat;beamingHelper;get direction(){return this.beamingHelper.direction}get scale(){return this.beat.graceType!==l.None?Ea.GraceScale:1}getNoteX(t,e){if(this.ZS.has(t.id)){const s=this.ZS.get(t.id);let i=this.x+s.x;switch(e){case oh.Left:break;case oh.Center:i+=s.width/2;break;case oh.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this.ZS.has(t.id)){const s=this.ZS.get(t.id);return this.DS(s,e)}return 0}DS(t,e){let s=this.y+t.y;const i=this.beat.graceType!==l.None?Ea.GraceScale:1;switch(e){case hh.TopWithStem:s-=(this.renderer.smuflMetrics.stemUp.has(t.symbol)?this.renderer.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*i,s-=this.renderer.smuflMetrics.standardStemLength*i;const e=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(e,s);case hh.Top:s-=t.height/2;break;case hh.Center:break;case hh.Bottom:s+=t.height/2;break;case hh.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*i,s+=this.renderer.smuflMetrics.standardStemLength*i;const n=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(n,s);case hh.StemUp:s-=(this.renderer.smuflMetrics.stemUp.has(t.symbol)?this.renderer.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*i;break;case hh.StemDown:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*i}return s}addMainNoteGlyph(t,e,s){super.add(t,s),this.ZS.set(e.id,t),this.tB.push(e)}addEffectNoteGlyph(t,e){super.add(t,e)}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.upLineX,t+this.x+this.downLineX)}doLayout(){super.doLayout();const t=this.renderer;this.beat.deadSlapped&&(this.eB=new Uc,this.eB.renderer=this.renderer,this.eB.doLayout(),this.width=this.eB.width);let e=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=t.getScoreY(0),e=t.getScoreY(t.heightLineCount)):this.direction===Ct.Up?(s=this.DS(this.maxNote.glyph,hh.Bottom)+i,e=this.DS(this.minNote.glyph,hh.TopWithStem)-i):(s=this.DS(this.maxNote.glyph,hh.BottomWithStem)+i,e=this.DS(this.minNote.glyph,hh.Top)-i);let n=null,r=null;for(const t of this.aboveBeatEffects.values())t.renderer=this.renderer,t.doLayout(),e-=t.height,t.y=e,(null===n||n>e)&&(n=e),(null===r||r<e)&&(r=e),e-=i;for(const t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout(),t.y=s,(null===n||n>s)&&(n=s),(null===r||r<s)&&(r=s),s+=t.height+i;if(null!==n&&t.registerBeatEffectOverflows(n,r??0),this.beat.isTremolo&&!this.beat.deadSlapped){const t=this.direction;let e=0;if(t===Ct.Up){e=(this.DS(this.minNote.glyph,hh.TopWithStem)+this.DS(this.minNote.glyph,hh.StemUp))/2}else{e=(this.DS(this.maxNote.glyph,hh.StemDown)+this.DS(this.maxNote.glyph,hh.BottomWithStem))/2}let s=t===Ct.Up?this.upLineX:this.downLineX;const i=this.beat.tremoloSpeed;this.beat.duration<c.Half&&(s=this.width/2),this.sB=new hl(s,e,i),this.sB.renderer=this.renderer,this.sB.doLayout()}}buildBoundingsLookup(t,e,s){for(const i of this.tB)if(this.ZS.has(i.id)){const n=this.ZS.get(i.id),r=new Ee;r.note=i,r.noteHeadBounds=new Ne,r.noteHeadBounds.x=e+this.x+n.x,r.noteHeadBounds.y=s+this.y+n.y-n.height/2,r.noteHeadBounds.w=n.width,r.noteHeadBounds.h=n.height,t.addNote(r)}}paint(t,e,s){this.Jy(t,e,s),super.paint(t,e,s)}Jy(t,e,s){const i=yh.beat(s,wt.StandardNotationEffects,this.beat);try{for(const i of this.aboveBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);for(const i of this.belowBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);this.sB&&this.sB.paint(t,e,s),this.eB&&this.eB.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class cl extends Na{beamingHelper;constructor(t,e,s){super(t,e,1,cl.getSymbol(s))}static getSymbol(t){switch(t){case c.QuadrupleWhole:return rt.RestLonga;case c.DoubleWhole:return rt.RestDoubleWhole;case c.Whole:return rt.RestWhole;case c.Half:return rt.RestHalf;case c.Quarter:return rt.RestQuarter;case c.Eighth:return rt.Rest8th;case c.Sixteenth:return rt.Rest16th;case c.ThirtySecond:return rt.Rest32nd;case c.SixtyFourth:return rt.Rest64th;case c.OneHundredTwentyEighth:return rt.Rest128th;case c.TwoHundredFiftySixth:return rt.Rest256th;default:return rt.None}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){this.internalPaint(t,e,s,wt.StandardNotationRests)}internalPaint(t,e,s,i){const n=yh.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class ll extends al{ge;iB=!1;nB=new Map;rB=new Gc;aB=null;hB=null;isEmpty=!0;get scale(){return Ea.GraceScale}get direction(){return Ct.Up}noteHeadOffset=0;constructor(t,e=!1){super(),this.ge=t,this.iB=e,e&&(this.aB=new nl(!0),this.hB=new nl(!1))}containsNoteValue(t){return this.nB.has(t)}getNoteValueY(t){return this.nB.has(t)?this.y+this.nB.get(t).y:0}addGlyph(t,e,s){const i=this.renderer,n=new Ea(0,0,c.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this.ge,t,e,!0),a=i.accidentalHelper.getNoteLineForValue(t,!1);if(n.y=i.getScoreY(a),this.iB&&(this.aB.renderer=this.renderer,this.hB.renderer=this.renderer,this.aB.addParenthesisOnLine(a,!0),this.hB.addParenthesisOnLine(a,!0)),r!==at.None){const t=new $c(0,n.y,r,Ea.GraceScale);t.renderer=this.renderer,this.rB.renderer=this.renderer,this.rB.addGlyph(t)}this.nB.set(t,n),this.add(n,a),this.isEmpty=!1}doLayout(){let t=0;this.iB&&(this.aB.x=t,this.aB.renderer=this.renderer,this.aB.doLayout(),t+=this.aB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.rB.isEmpty||(t+=this.rB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.rB.x=t,this.rB.renderer=this.renderer,this.rB.doLayout(),t+=this.rB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=t,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this.iB&&(this.hB.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.hB.renderer=this.renderer,this.hB.doLayout(),this.width+=this.hB.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(t,e,s){this.rB.isEmpty||this.rB.paint(t+this.x,e+this.y,s),this.iB&&(this.aB.paint(t+this.x,e+this.y,s),this.hB.paint(t+this.x,e+this.y,s)),super.paint(t,e,s)}}class ul extends Ma{bendNoteHeads=[];drawBendSlur(t,e,s,i,n,r,a,h){Ac.drawBendSlur(t,e,s,i,n,r,a,this.renderer.smuflMetrics.tieHeight,h)}doLayout(){super.doLayout(),this.width=0;for(const t of this.bendNoteHeads)t.doLayout(),this.width+=t.width}getTieDirection(t,e){return e.getBeatDirection(t)===Ct.Up?Ct.Down:Ct.Up}}class dl extends ul{ge;oB=null;constructor(t){super(0,0),this.ge=t}doLayout(){const t=this.renderer.settings.notation.notationMode;switch(this.ge.whammyBarType){case ut.None:case ut.Custom:case ut.Hold:return;case ut.Dive:case ut.PrediveDive:{const t=new ll(this.ge,!1);this.oB=t,t.renderer=this.renderer;const e=this.ge.whammyBarPoints[this.ge.whammyBarPoints.length-1];for(const s of this.ge.notes)s.isTieOrigin||t.addGlyph(this.cB(s,e),e.value%2!=0,void 0);t.doLayout(),this.bendNoteHeads.push(t)}break;case ut.Dip:if(t===S.SongBook){const t=this.renderer.resources;this.renderer.simpleWhammyOverflow=t.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{const t=new ll(this.ge,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===S.GuitarPro){const e=this.ge.whammyBarPoints[1];for(const s of this.ge.notes)t.addGlyph(this.cB(s,this.ge.whammyBarPoints[1]),e.value%2!=0,void 0)}t.doLayout(),this.bendNoteHeads.push(t);const e=new ll(this.ge,!1);if(e.renderer=this.renderer,this.oB=e,this.renderer.settings.notation.notationMode===S.GuitarPro){const t=this.ge.whammyBarPoints[this.ge.whammyBarPoints.length-1];for(const s of this.ge.notes)e.addGlyph(this.cB(s,t),t.value%2!=0,void 0)}e.doLayout(),this.bendNoteHeads.push(e)}case ut.Predive:}super.doLayout()}paint(t,e,s){const i=this.ge;switch(i.whammyBarType){case ut.None:case ut.Custom:return}const n=this.renderer.settings.notation.notationMode,a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,i.voice.bar),h=yh.beat(s,wt.StandardNotationEffects,i);try{const h=t+a.x+a.getBeatX(i,rh.MiddleNotes),o=this.getTieDirection(i,a);let c=1===this.ge.notes.length?o:Ct.Up;const l=s.textAlign,u=this.renderer.smuflMetrics.glyphHeights.get(rt.NoteheadBlack);for(let l=0;l<i.notes.length;l++){const d=i.notes[l],f=yh.note(s,lt.StandardNotationEffects,d);try{let f=e+a.y;l>0&&l>=(this.ge.notes.length/2|0)&&(c=Ct.Down),c===Ct.Down?f+=a.getNoteY(d,hh.Bottom):f+=a.getNoteY(d,hh.Top);let p=t+a.x;i.isLastOfVoice?p+=a.postBeatGlyphsStart:p+=a.getBeatX(i,rh.EndBeat),this.oB&&(p-=this.oB.upLineX);const b=i.whammyStyle===r.Gradual&&0===l?"grad.":"";let m=null;d.isTieOrigin&&(m=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,d.tieDestination.beat.voice.bar),m&&m.staff===a.staff?p=t+m.x+m.getBeatX(d.tieDestination.beat,rh.MiddleNotes):m=null);let g=u*Ea.GraceScale*.5;c===Ct.Up&&(g=-g);const w=i.whammyBarPoints.length>0?this.cB(d,i.whammyBarPoints[i.whammyBarPoints.length-1]):0;let y=0,k=!1;switch(this.bendNoteHeads.length>0&&this.bendNoteHeads[0].containsNoteValue(w)?(y=this.bendNoteHeads[0].getNoteValueY(w)+g,k=!0):m&&(d.isTieOrigin&&d.tieDestination.beat.hasWhammyBar||d.beat.isContinuedWhammy)?(y=e+m.y+m.getNoteY(d.tieDestination,hh.Top),k=!0,c===Ct.Down&&(y+=u)):d.isTieOrigin&&(y=m?e+m.y+m.getNoteY(d.tieDestination,hh.Top):f,c===Ct.Down&&(y+=u)),i.whammyBarType){case ut.Hold:d.isTieOrigin&&Ac.paintTie(s,1,h,f,p,y,o===Ct.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case ut.Dive:if(0===l){this.bendNoteHeads[0].x=p-this.bendNoteHeads[0].noteHeadOffset;const t=this.bendNoteHeads[0].y;this.bendNoteHeads[0].y=e+a.y,this.bendNoteHeads[0].paint(0,0,s),this.bendNoteHeads[0].containsNoteValue(w)&&(y-=t,y+=this.bendNoteHeads[0].y)}k?this.drawBendSlur(s,h,f,p,y,c===Ct.Down,1,b):d.isTieOrigin&&Ac.paintTie(s,1,h,f,p,y,o===Ct.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case ut.Dip:if(n===S.SongBook){if(0===l){const i=t+a.x+a.getBeatX(this.ge,rh.OnNotes),n=t+a.x+a.getBeatX(this.ge,rh.PostNotes),r=(i+n)/2,h=((this.ge.whammyBarPoints[1].value-this.ge.whammyBarPoints[0].value)/4|0).toString();s.font=this.renderer.resources.tablatureFont,s.fillText(h,r,e+this.y);const o=e+this.y+s.font.size,c=o+this.renderer.smuflMetrics.songBookWhammyDipHeight;this.ge.whammyBarPoints[1].value>this.ge.whammyBarPoints[0].value?(s.moveTo(i,c),s.lineTo(r,o),s.lineTo(n,c)):(s.moveTo(i,o),s.lineTo(r,c),s.lineTo(n,o)),s.stroke()}d.isTieOrigin&&Ac.paintTie(s,1,h,f,p,y,o===Ct.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)}else{const t=(h+p)/2;this.bendNoteHeads[0].x=t-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=e+a.y,this.bendNoteHeads[0].paint(0,0,s);const n=this.cB(d,i.whammyBarPoints[1]),r=this.bendNoteHeads[0].getNoteValueY(n)+g;this.drawBendSlur(s,h,f,t,r,c===Ct.Down,1,b),this.bendNoteHeads[1].x=p-this.bendNoteHeads[1].noteHeadOffset,this.bendNoteHeads[1].y=e+a.y,this.bendNoteHeads[1].paint(0,0,s),y=this.bendNoteHeads[1].getNoteValueY(w)+g,this.drawBendSlur(s,t,r,p,y,c===Ct.Down,1,b)}break;case ut.PrediveDive:case ut.Predive:let r=t+a.x+a.getBeatX(d.beat,rh.PreNotes);r+=a.getPreNotesGlyphForBeat(d.beat).prebendNoteHeadOffset;const u=e+a.y+a.getScoreY(a.accidentalHelper.getNoteLineForValue(d.displayValue-(d.beat.whammyBarPoints[0].value/2|0),!1))+g;this.drawBendSlur(s,r,u,h,f,c===Ct.Down,1,b),this.bendNoteHeads.length>0&&(this.bendNoteHeads[0].x=p-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=e+a.y,this.bendNoteHeads[0].paint(0,0,s),this.drawBendSlur(s,h,f,p,y,c===Ct.Down,1,b))}}finally{f?.[Symbol.dispose]?.()}}s.textAlign=l}finally{h?.[Symbol.dispose]?.()}}cB(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class fl extends Na{AS;lB;constructor(t,e,s,i,n){super(t,e,n?Ea.GraceScale:1,s.getSymbol(i)),this.AS=n,this.lB=s}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const n=this.AS?1:0;Dt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.symbol,!1),this.lB.techniqueSymbol!==rt.None&&this.lB.techniqueSymbolPlacement===ot.Inside&&Dt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.lB.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(rt.NoteheadBlack)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(rt.NoteheadBlack))}}class pl extends Na{constructor(t,e){super(t,e,Ea.GraceScale,rt.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class bl extends Na{constructor(t,e){super(t,e,.5,rt.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class ml extends va{uB=new Set;addString(t){this.uB.add(t)}doLayout(){const t=this.renderer.smuflMetrics.glyphWidths.get(rt.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(t+this.renderer.smuflMetrics.stringNumberCirclePadding)*this.uB.size,this.width=t}paint(t,e,s){const i=this.renderer.bar.staff.tuning.length;let n=0;const r=this.renderer.smuflMetrics.glyphWidths.get(rt.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const a of this.uB){const h=i-a,o=rt.GuitarString1+h;Dt.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+r+n,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,o,!0),n+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class gl extends Na{beatEffects=new Map;beamingHelper;noteHeadElement=lt.SlashNoteHead;effectElement=wt.SlashEffects;Vk;constructor(t,e,s,i,n){super(t,e,i?Ea.GraceScale:1,gl.getSymbol(s)),this.Vk=gl.getSymbol(s),this.beat=n}paint(t,e,s){const i=0===this.beat.notes.length?void 0:yh.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(t,e,s),this.Jy(t,e,s)}finally{i?.[Symbol.dispose]?.()}}Jy(t,e,s){const i=yh.beat(s,this.effectElement,this.beat);try{for(const i of this.beatEffects.values())i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.onNoteEffectPadding;let e=this.renderer.smuflMetrics.glyphHeights.get(this.Vk);for(const s of this.beatEffects.values())s.y+=e,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),e+=s.height+t}static getSymbol(t){switch(t){case c.QuadrupleWhole:case c.DoubleWhole:case c.Whole:return rt.NoteheadSlashWhiteWhole;case c.Half:return rt.NoteheadSlashWhiteHalf;default:return rt.NoteheadSlashHorizontalEnds}}updateBeamingHelper(t){if(this.beamingHelper){const e=this.Vk,s=this.renderer.smuflMetrics.stemUp.has(e)?this.renderer.smuflMetrics.stemUp.get(e).x:0,i=this.renderer.smuflMetrics.stemDown.has(e)?this.renderer.smuflMetrics.stemDown.get(e).x:0;this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+s,t+this.x+i)}}}class wl extends Jh{dB=-1e3;fB=!1;noteHeads=null;restGlyph=null;get effectElement(){return wt.StandardNotationEffects}getNoteX(t,e){return this.noteHeads?this.noteHeads.getNoteX(t,e):0}buildBoundingsLookup(t,e,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(t,e+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(t,e){return this.noteHeads?this.noteHeads.getNoteY(t,e):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this.dB)){this.dB=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this.dB;const t=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;t.has(this.container.beat.playbackStart)&&t.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&t.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this.fB=!0)}}paint(t,e,s){this.fB||super.paint(t,e,s)}doLayout(){const t=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let e=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===c.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(e-=2);const s=new cl(0,t.getScoreY(e),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const e=xh.computeLineHeightsForRest(this.container.beat.duration),i=s.y-t.getScoreHeight(e[0]),n=s.y+t.getScoreHeight(e[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,i,n)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,e),this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){const t=new gh(0,0);t.renderer=this.renderer,this.pB(e,t),this.addEffect(t)}}else{const e=new ol;this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;const s=new nl(!1);s.renderer=this.renderer;for(const t of this.container.beat.notes)!t.isVisible||t.beat.slashed&&0!==t.index||(this.bB(t),s.addParenthesis(t));if(this.addNormal(e),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const t=new dl(this.container.beat);t.renderer=this.renderer,t.doLayout(),this.container.ties.push(t)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){const e=new gh(0,0);e.renderer=this.renderer;for(const s of this.container.beat.notes){this.pB(t.getNoteLine(s),e).colorOverride=yh.noteColor(t.resources,lt.StandardNotationEffects,s)}this.addEffect(e)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}pB(t,e){const s=this.renderer,i=new Vc(0,s.getScoreY(t));return e.addGlyph(i),i}mB(t){const e=this.container.beat.graceType!==l.None,s=t.style;if(void 0!==s?.noteHead){const i=new Ea(0,0,t.beat.duration,e);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(t.beat.voice.bar.staff.isPercussion){const s=Ut.getArticulation(t);if(s)return new fl(0,0,s,t.beat.duration,e);z.warning("Rendering",`No articulation found for percussion instrument ${t.percussionArticulation}`)}return t.beat.slashed?new gl(0,0,t.beat.duration,e,t.beat):t.isDead?new el(0,0,e):t.beat.graceType===l.BendGrace?new Ea(0,0,c.Quarter,!0):t.harmonicType===f.Natural?new sl(0,0,t.beat.duration,e):new Ea(0,0,t.beat.duration,e)}bB(t){if(t.beat.graceType===l.BendGrace&&!t.hasBend)return;const e=this.renderer,s=this.mB(t);let i;if(s.colorOverride=yh.noteColor(e.resources,lt.StandardNotationNoteHead,t),i=t.beat.slashed?e.heightLineCount-1:e.getNoteLine(t),s.y=e.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,t,i),!t.beat.slashed&&t.harmonicType!==f.None&&t.harmonicType!==f.Natural){const n=t.displayValue+t.harmonicPitch,r=new sl(0,0,t.beat.duration,this.container.beat.graceType!==l.None);r.colorOverride=s.colorOverride,i=e.accidentalHelper.getNoteLineForValue(n,!1),r.y=e.getScoreY(i),this.noteHeads.addEffectNoteGlyph(r,i)}const n=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,a=this.beamingHelper.direction===Ct.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!n.has("Staccato")&&a.set("Staccato",new pl(0,0)),t.accentuated!==u.Normal||n.has("Accent")||a.set("Accent",new tl(0,0,t)),t.accentuated!==u.Heavy||n.has("HAccent")||a.set("HAccent",new tl(0,0,t)),t.accentuated!==u.Tenuto||n.has("Tenuto")||a.set("Tenuto",new tl(0,0,t)),t.showStringNumber&&t.isStringed){let e;r.has("StringNumber")?e=r.get("StringNumber"):(e=new ml(0,0),r.set("StringNumber",e)),e.addString(t.string)}if(t.isPercussion){const e=Ut.getArticulation(t);if(e&&e.techniqueSymbolPlacement!==ot.Inside){let t;switch(e.techniqueSymbolPlacement){case ot.Above:t=this.noteHeads.aboveBeatEffects;break;case ot.Below:t=this.noteHeads.belowBeatEffects;break;case ot.Outside:t=a;break;default:return}switch(e.techniqueSymbol){case rt.PictEdgeOfCymbal:t.set("PictEdgeOfCymbal",new bl(0,0));break;case rt.ArticStaccatoAbove:t.set("ArticStaccatoAbove",new pl(0,0));break;case rt.StringsUpBow:t.set("StringsUpBow",new Jo(0,0,ht.Up));break;case rt.StringsDownBow:t.set("StringsDownBow",new Jo(0,0,ht.Down));break;case rt.GuitarGolpe:t.set("GuitarGolpe",new Co(0,0,!0))}}}}}class yl extends Ma{ge;gB;constructor(t){super(0,0),this.ge=t}doLayout(){if(this.ge.brushType===h.ArpeggioUp||this.ge.brushType===h.ArpeggioDown){const t=new Qo(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.gB=t,this.width=t.height}else this.width=0}paint(t,e,s){if(this.ge.brushType===h.ArpeggioUp||this.ge.brushType===h.ArpeggioDown){const i=this.renderer,n=i.lineOffset,r=e+this.y+(i.getNoteY(this.ge.maxNote,hh.Bottom)-n),a=e+this.y+i.getNoteY(this.ge.minNote,hh.Top)+n,o=t+this.x+this.width/2,c=this.renderer.smuflMetrics.glyphWidths.get(rt.ArrowheadBlackDown),l=this.gB;if(this.ge.brushType===h.ArpeggioUp){const e=r+c,i=a-c;l.width=Math.abs(i-e),s.beginRotate(t+this.x,i,-90),l.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(o,a),s.lineTo(o+c/2,a-c),s.lineTo(o-c/2,a-c),s.closePath(),s.fill()}else if(this.ge.brushType===h.ArpeggioDown){const e=r+c,i=a;l.width=Math.abs(i-e),s.beginRotate(t+this.x,e,90),l.paint(0,-l.height,s),s.endRotate(),s.beginPath(),s.moveTo(o,r),s.lineTo(o+c/2,r+c),s.lineTo(o-c/2,r+c),s.closePath(),s.fill()}}}}class kl extends Xh{wB=null;get prebendNoteHeadOffset(){return this.wB?this.wB.x+this.wB.noteHeadOffset:0}get effectElement(){return wt.StandardNotationEffects}accidentals=null;doLayout(){if(!this.container.beat.isRest){const t=new Gc;t.renderer=this.renderer;const e=new Po;e.renderer=this.renderer;const s=new nl(!0);s.renderer=this.renderer;const i=new ll(this.container.beat,!0);this.wB=i,i.renderer=this.renderer;let n=!1;for(const r of this.container.beat.notes){const h=yh.noteColor(this.renderer.resources,lt.StandardNotationEffects,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case a.PrebendBend:case a.Prebend:case a.PrebendRelease:i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,h)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case ut.PrediveDive:case ut.Predive:this.wB.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,h)}switch(this.yB(r,t),s.addParenthesis(r),e.addFingers(r),r.slideInType){case m.IntoFromBelow:case m.IntoFromAbove:n=!0}}}n&&this.addNormal(new kc(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==l.None?Ea.GraceScale:1))),i.isEmpty||(this.addEffect(i),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1)))),this.container.beat.brushType!==h.None&&(this.addEffect(new yl(this.container.beat)),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1)))),e.isEmpty||(this.isEmpty||this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1))),this.addEffect(e),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1)))),s.isEmpty||this.addEffect(s),t.isEmpty||(this.accidentals=t,this.isEmpty||this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1))),this.addNormal(t),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==l.None?Ea.GraceScale:1))))}super.doLayout()}yB(t,e){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(t),n=s.getNoteLine(t);const r=this.container.beat.graceType!==l.None,a=yh.noteColor(s.resources,lt.StandardNotationAccidentals,t),h=r?Ea.GraceScale:1;if(i!==at.None){const t=new $c(0,s.getScoreY(n),i,h);t.colorOverride=a,t.renderer=this.renderer,e.addGlyph(t)}if(t.harmonicType!==f.None&&t.harmonicType!==f.Natural){const o=t.displayValue+t.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(t.beat,o,r,!1),n=s.accidentalHelper.getNoteLineForValue(o,!1);const c=new $c(0,s.getScoreY(n),i,h);c.colorOverride=a,c.renderer=this.renderer,e.addGlyph(c)}}}class Sl extends ul{ge;tB=[];kB=null;SB=null;constructor(t){super(0,0),this.ge=t}addBends(t){if(this.tB.push(t),t.isTieOrigin)return;const e=yh.noteColor(this.renderer.resources,lt.StandardNotationEffects,t);switch(t.bendType){case a.Bend:case a.PrebendRelease:case a.PrebendBend:{let s=this.kB;s||(s=new ll(t.beat,!1),s.renderer=this.renderer,this.kB=s,this.bendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.cB(t,i),i.value%2!=0,e)}break;case a.Release:if(!t.isTieOrigin){let s=this.kB;s||(s=new ll(t.beat,!1),s.renderer=this.renderer,this.kB=s,this.bendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.cB(t,i),i.value%2!=0,e)}break;case a.BendRelease:{let s=this.SB;s||(s=new ll(t.beat,!1),this.SB=s,s.renderer=this.renderer,this.bendNoteHeads.push(s));const i=t.bendPoints[1];s.addGlyph(this.cB(t,t.bendPoints[1]),i.value%2!=0,e);let n=this.kB;n||(n=new ll(t.beat,!1),n.renderer=this.renderer,this.kB=n,this.bendNoteHeads.push(n));const r=t.bendPoints[t.bendPoints.length-1];n.addGlyph(this.cB(t,r),r.value%2!=0,e)}}}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.ge.voice.bar),n=t+i.x+i.getBeatX(this.ge,rh.MiddleNotes);let h=t+i.x;this.ge.isLastOfVoice?h+=i.postBeatGlyphsStart:h+=i.getBeatX(this.ge.nextBeat,rh.PreNotes),this.kB&&(h-=this.kB.upLineX);const o=(n+h)/2;this.SB&&(this.SB.x=o-this.SB.noteHeadOffset,this.SB.y=e+i.y,this.SB.paint(0,0,s)),this.kB&&(this.kB.x=h-this.kB.noteHeadOffset,this.kB.y=e+i.y,this.kB.paint(0,0,s)),this.tB.sort((t,e)=>e.displayValue-t.displayValue);const c=this.ge.graceType===l.BendGrace?this.ge.nextBeat:this.ge;let u=1===this.tB.length?this.getTieDirection(c,i):Ct.Up;const d=this.renderer.smuflMetrics.glyphHeights.get(rt.NoteheadBlack);for(let c=0;c<this.tB.length;c++){const l=this.tB[c],f=yh.note(s,lt.StandardNotationEffects,l);try{c>0&&c>=(this.tB.length/2|0)&&(u=Ct.Down);let f=e+i.y+i.getNoteY(l,hh.Top),p=d*Ea.GraceScale*.5;u===Ct.Down&&(f+=d);const b=l.bendStyle===r.Gradual?"grad.":"";if(l.isTieOrigin){const r=l.tieDestination,h=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(h&&h.staff===i.staff){const i=t+h.x+h.getBeatX(r.beat,rh.MiddleNotes);let o=e+h.y+h.getNoteY(r,hh.Top);u===Ct.Down&&(o+=d),l.bendType===a.Hold||l.bendType===a.Prebend?Ac.paintTie(s,1,n,f,i,o,u===Ct.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,i,o,u===Ct.Down,1,b)}else{const r=t+i.x+i.width,h=l.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(l.beat,h,!1,!0);const o=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(h,!1));l.bendType===a.Hold||l.bendType===a.Prebend?Ac.paintTie(s,1,n,f,r,o,u===Ct.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,n,f,r,o,u===Ct.Down,1,b)}switch(l.bendType){case a.Prebend:case a.PrebendBend:case a.PrebendRelease:let r=t+i.x+i.getBeatX(l.beat,rh.PreNotes);r+=i.getPreNotesGlyphForBeat(l.beat).prebendNoteHeadOffset;const h=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,r,h,n,f,u===Ct.Down,1)}}else{u===Ct.Up&&(p=-p);let r=0,c=0;switch(l.bendType){case a.Bend:r=this.cB(l,l.bendPoints[l.bendPoints.length-1]),c=this.kB.getNoteValueY(r)+p,this.drawBendSlur(s,n,f,h,c,u===Ct.Down,1,b);break;case a.BendRelease:const d=this.cB(l,l.bendPoints[1]),m=this.SB.getNoteValueY(d)+p;this.drawBendSlur(s,n,f,o,m,u===Ct.Down,1,b),r=this.cB(l,l.bendPoints[l.bendPoints.length-1]),c=this.kB.getNoteValueY(r)+p,this.drawBendSlur(s,o,m,h,c,u===Ct.Down,1,b);break;case a.Release:this.bendNoteHeads.length>0&&(r=this.cB(l,l.bendPoints[l.bendPoints.length-1]),c=this.bendNoteHeads[0].getNoteValueY(r)+p,this.drawBendSlur(s,n,f,h,c,u===Ct.Down,1,b));break;case a.Prebend:case a.PrebendBend:case a.PrebendRelease:let g=t+i.x+i.getBeatX(l.beat,rh.PreNotes);g+=i.getPreNotesGlyphForBeat(l.beat).prebendNoteHeadOffset;const w=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(s,g,w,n,f,u===Ct.Down,1),this.bendNoteHeads.length>0&&(r=this.cB(l,l.bendPoints[l.bendPoints.length-1]),c=this.bendNoteHeads[0].getNoteValueY(r)+p,this.drawBendSlur(s,n,f,h,c,u===Ct.Down,1,b))}}}finally{f?.[Symbol.dispose]?.()}}}cB(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class Bl extends Ac{constructor(t,e,s=!1){super(t,e,s)}doLayout(){super.doLayout()}getBeamDirection(t,e){return t.isRest?Ct.Up:e.getBeatDirection(t)===Ct.Up?Ct.Down:Ct.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===Ct.Up?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,hh.Top):this.startNoteRenderer.getNoteY(this.startBeat.minNote,hh.Bottom)}getEndY(){const t=this.endNoteRenderer;if(this.endBeat.isRest)return this.tieDirection===Ct.Up?t.getScoreY(9):t.getScoreY(0);const e=this.startNoteRenderer.getBeatDirection(this.startBeat),s=t.getBeatDirection(this.endBeat);return e!==s&&this.startBeat.graceType===l.None?s===this.tieDirection?this.tieDirection===Ct.Up?t.getNoteY(this.endBeat.maxNote,hh.TopWithStem):t.getNoteY(this.endBeat.minNote,hh.BottomWithStem):this.tieDirection===Ct.Up?t.getNoteY(this.endBeat.maxNote,hh.BottomWithStem):t.getNoteY(this.endBeat.minNote,hh.TopWithStem):this.tieDirection===Ct.Up?t.getNoteY(this.endBeat.maxNote,hh.Top):t.getNoteY(this.endBeat.minNote,hh.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,rh.MiddleNotes)}getEndX(){const t=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>c.Whole&&t===this.tieDirection?rh.Stem:rh.MiddleNotes)}}class _l extends Ma{BB;_B;xB;TB;constructor(t,e,s,i){super(0,0),this.BB=e,this._B=t,this.xB=s,this.TB=i}doLayout(){this.width=0}paint(t,e,s){this.MB(t,e,s),this.vB(t,e,s)}MB(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth;let r=t+i.x+i.getNoteX(this.xB,oh.Left)-i.smuflMetrics.preNoteEffectPadding;const a=e+i.y+i.getNoteY(this.xB,hh.Center);let h=r-n,o=e+i.y;switch(this._B){case m.IntoFromBelow:o+=i.getNoteY(this.xB,hh.Bottom);break;case m.IntoFromAbove:o+=i.getNoteY(this.xB,hh.Top);break;default:return}const c=this.NB(i,this.xB.beat);h-=c,r-=c,this.PB(s,!1,h,r,o,a)}NB(t,e){const s=t.getPreNotesGlyphForBeat(e);return s&&s.accidentals?s.accidentals.width:0}vB(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding;let a=0,h=0,o=0,c=0,l=!1;switch(this.BB){case g.Shift:case g.Legato:if(a=t+i.x+i.getBeatX(this.xB.beat,rh.PostNotes)+r,h=e+i.y+i.getNoteY(this.xB,hh.Center),this.xB.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.xB.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.xB.slideTarget.beat,rh.PreNotes)-r,c=e+s.y+s.getNoteY(this.xB.slideTarget,hh.Center)):(o=t+i.x+i.width,c=this.xB.slideTarget.realValue>this.xB.realValue?e+i.y+i.getNoteY(this.xB,hh.Top):e+i.y+i.getNoteY(this.xB,hh.Bottom))}else o=t+i.x+this.TB.x,c=h;break;case g.OutUp:a=t+i.x+i.getNoteX(this.xB,oh.Right)+r,h=e+i.y+i.getNoteY(this.xB,hh.Center),o=a+n,c=e+i.y+i.getNoteY(this.xB,hh.Top);break;case g.OutDown:a=t+i.x+i.getNoteX(this.xB,oh.Right)+r,h=e+i.y+i.getNoteY(this.xB,hh.Center),o=a+n,c=e+i.y+i.getNoteY(this.xB,hh.Bottom);break;case g.PickSlideUp:a=t+i.x+i.getNoteX(this.xB,oh.Right)+2*r,h=e+i.y+i.getNoteY(this.xB,hh.Center),c=e+i.y+i.getNoteY(this.xB,hh.Top),o=t+i.x+i.width,this.xB.beat.nextBeat&&this.xB.beat.nextBeat.voice===this.xB.beat.voice&&(o=t+i.x+i.getBeatX(this.xB.beat.nextBeat,rh.PreNotes)),l=!0;break;case g.PickSlideDown:a=t+i.x+i.getNoteX(this.xB,oh.Right)+2*r,h=e+i.y+i.getNoteY(this.xB,hh.Center),c=e+i.y+i.getNoteY(this.xB,hh.Bottom),o=t+i.x+i.width,this.xB.beat.nextBeat&&this.xB.beat.nextBeat.voice===this.xB.beat.voice&&(o=t+i.x+i.getBeatX(this.xB.beat.nextBeat,rh.PreNotes)),l=!0;break;default:return}this.PB(s,l,a,o,h,c)}PB(t,e,s,i,n,r){if(e){const e=new Qo(0,0,w.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class xl extends Bl{xB;EB;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.xB=t,this.EB=e}getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){return this.FB()?this.tieDirection===Ct.Up?this.startNoteRenderer.getNoteY(this.xB,hh.Top):this.startNoteRenderer.getNoteY(this.xB,hh.Bottom):this.startNoteRenderer.getNoteY(this.xB,hh.Center)}getEndY(){return this.CB()?this.AB()?this.tieDirection===Ct.Up?this.endNoteRenderer.getNoteY(this.EB,hh.TopWithStem):this.endNoteRenderer.getNoteY(this.EB,hh.BottomWithStem):this.tieDirection===Ct.Up?this.endNoteRenderer.getNoteY(this.EB,hh.Top):this.endNoteRenderer.getNoteY(this.EB,hh.Bottom):this.endNoteRenderer.getNoteY(this.EB,hh.Center)}FB(){return this.xB===this.xB.beat.maxNote&&this.tieDirection===Ct.Up||this.xB===this.xB.beat.minNote&&this.tieDirection===Ct.Down}CB(){return this.xB.beat.graceType===l.None&&(this.EB===this.EB.beat.maxNote&&this.tieDirection===Ct.Up||this.EB===this.EB.beat.minNote&&this.tieDirection===Ct.Down)}AB(){const t=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==t.getBeatDirection(this.endBeat)&&this.startBeat.graceType===l.None}getStartX(){return this.FB()?this.startNoteRenderer.getBeatX(this.xB.beat,rh.MiddleNotes):this.startNoteRenderer.getNoteX(this.xB,oh.Right)}getEndX(){return this.CB()?this.AB()?this.endNoteRenderer.getBeatX(this.EB.beat,rh.Stem):this.endNoteRenderer.getNoteX(this.EB,oh.Center):this.endNoteRenderer.getBeatX(this.EB.beat,rh.PreNotes)}}class Tl extends Ac{startNote;endNote;constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return e.getBeatDirection(t)===Ct.Up?Ct.Down:Ct.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===Ct.Up?this.startNoteRenderer.getNoteY(this.startNote,hh.Top):this.startNoteRenderer.getNoteY(this.startNote,hh.Bottom)}getEndY(){const t=this.endNoteRenderer;return this.endBeat.isRest?this.tieDirection===Ct.Up?t.getScoreY(9):t.getScoreY(0):this.tieDirection===Ct.Up?t.getNoteY(this.endNote,hh.Top):t.getNoteY(this.endNote,hh.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,rh.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,rh.PreNotes)}}class Ml extends Ca{DB=null;LB=null;WB=null;doLayout(){this.LB=null,this.WB=null,super.doLayout(),this.DB&&(this.DB.renderer=this.renderer,this.DB.doLayout(),this.updateWidth())}createTies(t){if(t.isVisible){if(t.isTieOrigin&&!t.hasBend&&!t.beat.hasWhammyBar&&t.beat.graceType!==l.BendGrace&&t.tieDestination&&t.tieDestination.isVisible){const e=new Tl(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&!t.tieOrigin.hasBend&&!t.beat.hasWhammyBar){const e=new Tl(t.tieOrigin,t,!0);this.addTie(e)}if(t.slideInType!==m.None||t.slideOutType!==g.None){const e=new _l(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.isSlurOrigin&&t.slurDestination&&t.slurDestination.isVisible){const e=new xl(t,t.slurDestination,!1);this.addTie(e)}if(t.isSlurDestination){const e=new xl(t.slurOrigin,t,!0);this.addTie(e)}if(!this.LB&&t.isEffectSlurOrigin&&t.effectSlurDestination){const e=new xl(t,t.effectSlurDestination,!1);this.LB=e,this.addTie(e)}if(!this.WB&&t.beat.isEffectSlurDestination&&t.beat.effectSlurOrigin){const e=this.onNotes.beamingHelper.direction,s=e===Ct.Up?t.beat.effectSlurOrigin.minNote:t.beat.effectSlurOrigin.maxNote,i=e===Ct.Up?t.beat.minNote:t.beat.maxNote,n=new xl(s,i,!0);this.WB=n,this.addTie(n)}if(t.hasBend){if(!this.DB){const e=new Sl(t.beat);this.DB=e,e.renderer=this.renderer,this.addTie(e)}this.DB.addBends(t)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let t=this.beat.nextBeat;for(;t.nextBeat&&t.nextBeat.isLegatoDestination;)t=t.nextBeat;this.addTie(new Bl(this.beat,t,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let t=this.beat.previousBeat;for(;t.previousBeat&&t.previousBeat.isLegatoOrigin;)t=t.previousBeat;this.addTie(new Bl(t,this.beat,!0))}}}}class vl extends wh{paint(t,e,s){const i=yh.bar(s,A.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class Nl extends Cc{static StaffId="score";static OB=[-1,2,-2,1,4,0,3];static RB=[3,0,4,1,5,2,6];simpleWhammyOverflow=0;beatEffectsMinY=null;beatEffectsMaxY=null;accidentalHelper;constructor(t,e){super(t,e),this.accidentalHelper=new di(this)}get repeatsBarSubElement(){return A.StandardNotationRepeats}get barNumberBarSubElement(){return A.StandardNotationBarNumber}get barLineBarSubElement(){return A.StandardNotationBarLines}get staffLineBarSubElement(){return A.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(t,e){const s=this.beatEffectsMinY;(null==s||t<s)&&(this.beatEffectsMinY=t);const i=this.beatEffectsMaxY;(null==i||e>i)&&(this.beatEffectsMaxY=e)}getScoreY(t){return super.getLineY(t/2)}getScoreHeight(t){return super.getLineHeight(t/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.simpleWhammyOverflow,i=this.beatEffectsMinY;if(null!==i){const e=t-i;e>0&&this.registerOverflowTop(e)}const n=this.beatEffectsMaxY;if(null!==n){const t=n-e;t>0&&this.registerOverflowBottom(t)}this.registerOverflowTop(s);const r=this.getScoreHeight(1);let a=0,h=0;for(const t of this.helpers.beamHelpers)for(const e of t)if(e.isRestBeamHelper){if(e.minRestLine){const t=this.getScoreY(e.maxRestLine)-r;t<a&&(a=t)}if(e.maxRestLine){const t=this.getScoreY(e.maxRestLine)+r;t<a&&(a=t)}}else if(1===e.beats.length)if(e.beats[0].duration>=c.Half)if(e.direction===Ct.Up){let t=this.getFlagTopY(e.beats[0],e.direction);e.hasTuplet&&(t-=this.tupletSize+this.tupletOffset),t<a&&(a=t);const s=this.getFlagBottomY(e.beats[0],e.direction)+r;s>h&&(h=s)}else{let t=this.getFlagBottomY(e.beats[0],e.direction);e.hasTuplet&&(t+=this.tupletSize+this.tupletOffset),t>h&&(h=t);const s=this.getFlagTopY(e.beats[0],e.direction)-r;s<a&&(a=s)}else{const t=this.getBeatContainer(e.beats[0]);if(t){let s=t.onNotes.getHighestNoteY()-r,i=t.onNotes.getLowestNoteY()+r;e.direction===Ct.Up?e.hasTuplet&&(s-=this.tupletSize+this.tupletOffset):e.hasTuplet&&(i+=this.tupletSize+this.tupletOffset),i>h&&(h=i),s<a&&(a=s)}}else{this.IB(e,e.direction);const t=e.drawingInfos.get(e.direction);if(e.direction===Ct.Up){let s=Math.min(t.startY,t.endY);e.hasTuplet&&(s-=this.tupletSize+this.tupletOffset),s<a&&(a=s);const i=this.getBarLineStart(e.beatOfLowestNote,e.direction)+r;i>h&&(h=i)}else{let s=Math.max(t.startY,t.endY);e.hasTuplet&&(s+=this.tupletSize+this.tupletOffset),s>h&&(h=s);const i=this.getBarLineStart(e.beatOfHighestNote,e.direction)-r;i<a&&(a=i)}}a<t&&this.registerOverflowTop(Math.abs(a)+s),h>e&&this.registerOverflowBottom(Math.abs(h)-e)}}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,wt.StandardNotationFlags,wt.StandardNotationBeams),this.paintTuplets(t,e,s,wt.StandardNotationTuplet)}GB(){const t=(this.heightLineCount-1)/2;return this.getLineY(t)}getFlagTopY(t,e){if(t.slashed){let s=this.GB();const i=gl.getSymbol(t.duration),n=t.graceType!==l.None?Ea.GraceScale:1;return e===Ct.Down?s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*n:0:(s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*n:0,s-=this.smuflMetrics.standardStemLength+n),s}const s=this.accidentalHelper.getMinLineNote(t);if(s)return this.getBeatContainer(t).onNotes.getNoteY(s,e===Ct.Up?hh.TopWithStem:hh.StemDown);let i=this.getScoreY(this.accidentalHelper.getMinLine(t));if(e===Ct.Up){const e=t.graceType!==l.None?Ea.GraceScale:1;i-=this.smuflMetrics.standardStemLength*e}return i}getFlagBottomY(t,e){if(t.slashed){let s=this.GB();const i=gl.getSymbol(t.duration),n=t.graceType!==l.None?Ea.GraceScale:1;return e===Ct.Down?(s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*n:0,s+=this.smuflMetrics.standardStemLength+n):s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*n:0,s}const s=this.accidentalHelper.getMaxLineNote(t);if(s)return this.getBeatContainer(t).onNotes.getNoteY(s,e===Ct.Up?hh.StemUp:hh.BottomWithStem);let i=this.getScoreY(this.accidentalHelper.getMaxLine(t));if(e===Ct.Down){const e=t.graceType!==l.None?Ea.GraceScale:1;i+=this.smuflMetrics.standardStemLength*e}return i}getBeamDirection(t){return t.direction}centerStaffStemY(t){return this.bar.staff.standardNotationLineCount===ye.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):t.direction===Ct.Up?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}getStemBottomY(t){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(t,e){if(t.beat.slashed){const t=(this.heightLineCount-1)/2;return this.getLineY(t)}let s=super.getNoteY(t,e);if(Number.isNaN(s)){const i=di.computeLineWithoutAccidentals(this.bar,t);s=this.getScoreY(i);const n=t.beat.graceType===l.None?1:Ea.GraceScale,r=this.smuflMetrics.standardStemLength*n,a=this.smuflMetrics.glyphHeights.get(Ea.getSymbol(t.beat.duration))*n;switch(e){case hh.TopWithStem:s-=r;break;case hh.Top:s-=a/2;break;case hh.Center:break;case hh.Bottom:s+=a/2;break;case hh.BottomWithStem:s+=r;case hh.StemUp:case hh.StemDown:}}return s}applyLayoutingInfo(){const t=super.applyLayoutingInfo();if(t&&this.bar.isMultiVoice){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<t&&this.registerOverflowTop(Math.abs(s[0])),s[1]>e&&this.registerOverflowBottom(Math.abs(s[1])-e)}return t}calculateBeamYWithDirection(t,e,s){return 0===t.beats.length?s===Ct.Up?this.getFlagTopY(t.beats[0],s):this.getFlagBottomY(t.beats[0],s):(this.IB(t,s),t.drawingInfos.get(s).calcY(e))}IB(t,e){if(!t.drawingInfos.has(e)){const s=t.graceType!==l.None?Ea.GraceScale:1,i=Vt.getIndex(t.shortestDuration)-2;let n=this.smuflMetrics.standardStemLength*s;if(t.tremoloDuration){const e=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*s;t.shortestDuration>c.Eighth?t.tremoloDuration===c.Eighth?n+=e:n+=1.5*e:t.tremoloDuration===c.ThirtySecond&&(n+=1.5*e)}const r=new _h;t.drawingInfos.set(e,r);const a=t.beats[0],h=t.beats[t.beats.length-1],o=t.isRestBeamHelper;r.startBeat=a,r.startX=t.getBeatLineX(a),r.startY=o?e===Ct.Up?this.getScoreY(t.minRestLine):this.getScoreY(t.maxRestLine):e===Ct.Up?this.getFlagTopY(a,e):this.getFlagBottomY(a,e),r.endBeat=h,r.endX=t.getBeatLineX(h),r.endY=o?e===Ct.Up?this.getScoreY(t.minRestLine):this.getScoreY(t.maxRestLine):e===Ct.Up?this.getFlagTopY(h,e):this.getFlagBottomY(h,e);const u=this.smuflMetrics.oneStaffSpace;if(e===Ct.Down&&r.startY>r.endY&&r.startY-r.endY>u&&(r.endY=r.startY-u),e===Ct.Down&&r.endY>r.startY&&r.endY-r.startY>u&&(r.startY=r.endY-u),e===Ct.Up&&r.startY<r.endY&&r.endY-r.startY>u&&(r.endY=r.startY+u),e===Ct.Up&&r.endY<r.startY&&r.startY-r.endY>u&&(r.startY=r.endY+u),t.beats.length>1){if(e===Ct.Up){const e=this.getScoreY(this.accidentalHelper.getMinLine(t.beatOfHighestNote))-n,s=r.calcY(t.getBeatLineX(t.beatOfHighestNote))-e;s>0&&(r.startY-=s,r.endY-=s)}else{const e=this.getScoreY(this.accidentalHelper.getMaxLine(t.beatOfLowestNote))+n-r.calcY(t.getBeatLineX(t.beatOfLowestNote));e>0&&(r.startY+=e,r.endY+=e)}if(null!==t.minRestLine||null!==t.maxRestLine){const s=t.graceType!==l.None?Ea.GraceScale:1;let n=i*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*s;if(n+=this.smuflMetrics.beamSpacing,e===Ct.Up&&null!==t.minRestLine){const e=this.getScoreY(t.minRestLine)-n,s=r.calcY(t.getBeatLineX(t.beatOfMinRestLine))-e;s>0&&(r.startY-=s,r.endY-=s)}else if(e===Ct.Down&&null!==t.maxRestLine){const e=this.getScoreY(t.maxRestLine)+n-r.calcY(t.getBeatLineX(t.beatOfMaxRestLine));e>0&&(r.startY+=e,r.endY+=e)}}if(t.slashBeats.length>0)for(const e of t.slashBeats){const s=r.calcY(t.getBeatLineX(e)),i=(t.direction===Ct.Up?this.getFlagTopY(e,t.direction):this.getFlagBottomY(e,t.direction))-s;i>0&&(r.startY+=i,r.endY+=i)}}if(i>2&&!o){const t=this.smuflMetrics.beamSpacing*s,n=this.smuflMetrics.beamThickness*s,a=i*n+(i-1)*t;if(e===Ct.Up){const e=r.startY+2*n+t-a,s=r.startY-e;s>0&&(r.startY-=s,r.endY-=s)}else{const e=r.startY-2*n+t+a-r.startY;e>0&&(r.startY+=e,r.endY+=e)}}}}getBarLineStart(t,e){if(t.slashed)return e===Ct.Down?this.getFlagTopY(t,e):this.getFlagBottomY(t,e);if(e===Ct.Up){const e=this.accidentalHelper.getMaxLineNote(t);return e?this.getBeatContainer(t).onNotes.getNoteY(e,hh.StemUp):this.getScoreY(this.accidentalHelper.getMaxLine(t))}const s=this.accidentalHelper.getMinLineNote(t);return s?this.getBeatContainer(t).onNotes.getNoteY(s,hh.StemDown):this.getScoreY(this.accidentalHelper.getMinLine(t))}createLinePreBeatGlyphs(){let t=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case N.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case N.F4:e=2;break;case N.C3:e=4;break;case N.C4:e=2;break;case N.G2:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new Zc(0,this.getScoreY(e),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.preBeatGlyphSpacing)),t=!0}(t||0===this.index&&this.bar.keySignature!==E.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.zS()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.jS())}zS(){let t=0;const e=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case N.Neutral:t=0;break;case N.G2:t=1;break;case N.F4:t=3;break;case N.C3:t=2;break;case N.C4:t=0}const i=new vl;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const n=new Map,r=[];if(Vt.keySignatureIsSharp(e))for(let s=0;s<Math.abs(e);s++){const e=Nl.OB[s]+t;r.push(new $c(0,this.getScoreY(e),at.Sharp,1)),n.set(e,!0)}else for(let s=0;s<Math.abs(e);s++){const e=Nl.RB[s]+t;r.push(new $c(0,this.getScoreY(e),at.Flat,1)),n.set(e,!0)}if(this.bar.keySignature===E.C){const e=Math.abs(s),r=Vt.keySignatureIsSharp(s)?Nl.OB:Nl.RB;for(let s=0;s<e;s++){const e=r[s]+t;n.has(e)||i.addGlyph(new $c(0,this.getScoreY(r[s]+t),at.Natural,1))}}for(const t of r)i.addGlyph(t);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.preBeatGlyphSpacing))}jS(){const t=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new qc(0,this.getScoreY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(t){for(const e of t.beats){const s=new Ml(e,this.getVoiceContainer(t));s.preNotes=new kl,s.onNotes=new wl,this.addBeatGlyph(s)}}getNoteLine(t){return this.accidentalHelper.getNoteLine(t)}completeBeamingHelper(t){if(this.bar.isMultiVoice&&t.highestNoteInHelper&&t.lowestNoteInHelper){let e=0,s=0,i=0;t.hasTuplet&&(i+=2*this.resources.effectFont.size),t.direction===Ct.Up?(e=this.getNoteY(t.highestNoteInHelper,hh.TopWithStem)-i,s=this.getNoteY(t.lowestNoteInHelper,hh.Bottom)):(e=this.getNoteY(t.highestNoteInHelper,hh.Top),s=this.getNoteY(t.lowestNoteInHelper,hh.BottomWithStem)+i);for(const i of t.beats)this.helpers.collisionHelper.reserveBeatSlot(i,e,s)}}paintBeamingStem(t,e,s,i,n,r){const a=yh.beat(r,wt.StandardNotationStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}}class Pl extends mh{get staffId(){return Nl.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Nl(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class El extends Ac{startNote;endNote;constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}get PS(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.PS?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return Ct.Down}static getBeamDirectionForNote(t){return Ct.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,hh.Center)}getEndY(){return this.getStartY()}getStartX(){return this.PS?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,oh.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,oh.Left)}}class Fl extends Ca{$B=null;createTies(t){if(t.isVisible){if(!this.$B&&t.isTieOrigin&&t.tieDestination.isVisible){const e=new El(t,t.tieDestination,!1);this.$B=e,this.addTie(e)}if(!this.$B&&t.isTieDestination){const e=new El(t.tieOrigin,t,!0);this.$B=e,this.addTie(e)}}}}class Cl extends cl{updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){super.internalPaint(t,e,s,wt.SlashRests)}}class Al extends Jh{noteHeads=null;deadSlapped=null;restGlyph=null;get effectElement(){return wt.SlashEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case oh.Left:break;case oh.Center:t+=s.width/2;break;case oh.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new Ee;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Ne,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(t,e){let s=null,i=rt.None;if(this.noteHeads?(s=this.noteHeads,i=gl.getSymbol(t.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let t=this.y+s.y;switch(e){case hh.Top:case hh.TopWithStem:t-=s.height/2;break;case hh.Center:break;case hh.Bottom:case hh.BottomWithStem:t+=s.height/2;break;case hh.StemUp:t-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case hh.StemDown:t-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0}return t}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){const t=this.renderer,e=t.getNoteLine(),s=t.getLineY(e);if(this.container.beat.deadSlapped){const t=new Uc;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const t=new Cl(0,s,this.container.beat.duration);this.restGlyph=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper,this.addNormal(t),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const t=this.container.beat.graceType!==l.None,e=new gl(0,s,this.container.beat.duration,t,this.container.beat);this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new Vc(0,t.getLineY(t.getNoteLine())-t.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class Dl extends Cc{static StaffId="slash";simpleWhammyOverflow=0;VB;constructor(t,e){super(t,e),this.VB=!e.staff.showTablature&&!e.staff.showStandardNotation,this.helpers.preferredBeamDirection=Ct.Up}get repeatsBarSubElement(){return A.SlashRepeats}get barNumberBarSubElement(){return A.SlashBarNumber}get barLineBarSubElement(){return A.SlashBarLines}get staffLineBarSubElement(){return A.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,wt.SlashFlags,wt.SlashBeams),this.paintTuplets(t,e,s,wt.SlashTuplet)}doLayout(){super.doLayout();let t=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)){if(this.getVoiceContainer(e).tupletGroups.length>0){t=!0;break}}t&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(t,e){const s=this.smuflMetrics.glyphHeights.get(rt.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return e===Ct.Up&&(i-=this.getFlagStemSize(t.duration,!0)),i}getFlagBottomY(t,e){const s=this.smuflMetrics.glyphHeights.get(rt.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return e===Ct.Down&&(i+=this.getFlagStemSize(t.duration,!0)),i}getBeamDirection(t){return Ct.Up}getNoteY(t,e){let s=super.getNoteY(t,e);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(t,e,s){return this.getLineY(0)-this.getFlagStemSize(t.shortestDuration)}getBarLineStart(t,e){const s=this.smuflMetrics.glyphHeights.get(rt.NoteheadSlashWhiteHalf);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this.VB&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.jS())}jS(){this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new qc(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=A.SlashTimeSignature,this.addPreBeatGlyph(e)}createVoiceGlyphs(t){for(const e of t.beats){const s=new Fl(e,this.getVoiceContainer(t));s.preNotes=new Xh,s.onNotes=0===t.index?new Al:new Jh,this.addBeatGlyph(s)}}paintBeamingStem(t,e,s,i,n,r){const a=yh.beat(r,wt.SlashStem,t);try{const t=r.lineWidth;r.lineWidth=this.smuflMetrics.stemThickness,r.beginPath(),r.moveTo(s,i),r.lineTo(s,n),r.stroke(),r.lineWidth=t}finally{a?.[Symbol.dispose]?.()}}}class Ll extends mh{get staffId(){return Dl.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Dl(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class Wl extends ${lineValue=0;constructor(t=0,e=0){super(t,e),this.lineValue=e}}class Ol extends Ma{tB=[];HB=new Map;UB=-1;zB=-1;jB=-1;XB=-1;JB=-1;qB=-1;YB=-1;constructor(){super(0,0)}addBends(t){this.tB.push(t);const e=this.KB(t);this.HB.set(t.id,e),(-1===this.YB||this.YB<t.maxBendPoint.value)&&(this.YB=t.maxBendPoint.value);let s=0;switch(t.bendType){case a.Bend:s=e[1].value,t.isTieOrigin?(-1===this.XB||s<this.XB)&&(this.XB=s):(-1===this.jB||s<this.jB)&&(this.jB=s);break;case a.Release:s=e[1].value,t.isTieOrigin?(-1===this.qB||s<this.qB)&&(this.qB=s):s>0&&(-1===this.JB||s<this.JB)&&(this.JB=s);break;case a.BendRelease:s=e[1].value,(-1===this.zB||s<this.zB)&&(this.zB=s),s=e[2].value,t.isTieOrigin?(-1===this.qB||s<this.qB)&&(this.qB=s):s>0&&(-1===this.JB||s<this.JB)&&(this.JB=s);break;case a.Prebend:s=e[0].value,(-1===this.UB||s<this.UB)&&(this.UB=s);break;case a.PrebendBend:s=e[0].value,(-1===this.UB||s<this.UB)&&(this.UB=s),s=e[1].value,t.isTieOrigin?(-1===this.XB||s<this.XB)&&(this.XB=s):(-1===this.jB||s<this.jB)&&(this.jB=s);break;case a.PrebendRelease:s=e[0].value,(-1===this.UB||s<this.UB)&&(this.UB=s),s=e[1].value,t.isTieOrigin?(-1===this.qB||s<this.qB)&&(this.qB=s):s>0&&(-1===this.JB||s<this.JB)&&(this.JB=s)}}doLayout(){super.doLayout();const t=this.YB*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(t);let e=0;for(const t of this.tB){const s=this.HB.get(t.id);switch(t.bendType){case a.Bend:s[1].lineValue=t.isTieOrigin?this.XB:this.jB;break;case a.Release:e=t.isTieOrigin?this.qB:this.JB,e>=0&&(s[1].lineValue=e);break;case a.BendRelease:s[1].lineValue=this.zB,e=t.isTieOrigin?this.qB:this.JB,e>=0&&(s[2].lineValue=e);break;case a.Prebend:s[0].lineValue=this.UB;break;case a.PrebendBend:s[0].lineValue=this.UB,s[1].lineValue=t.isTieOrigin?this.XB:this.jB;break;case a.PrebendRelease:s[0].lineValue=this.UB,e=t.isTieOrigin?this.qB:this.JB,e>=0&&(s[1].lineValue=e)}}this.width=0,this.tB.sort((t,e)=>t.isStringed?t.string-e.string:t.realValue-e.realValue)}KB(t){const e=[];switch(t.bendType){case a.Custom:for(const s of t.bendPoints)e.push(new Wl(s.offset,s.value));break;case a.BendRelease:e.push(new Wl(0,t.bendPoints[0].value)),e.push(new Wl($.MaxPosition/2|0,t.bendPoints[1].value)),e.push(new Wl($.MaxPosition,t.bendPoints[3].value));break;case a.Bend:case a.Hold:case a.Prebend:case a.PrebendBend:case a.PrebendRelease:case a.Release:e.push(new Wl(0,t.bendPoints[0].value)),e.push(new Wl($.MaxPosition,t.bendPoints[1].value))}return e}paint(t,e,s){const i=s.color;this.tB.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const n of this.tB){const h=this.HB.get(n.id),o=this.renderer;let c=n,l=!1,u=null,d=!1;const f=n.bendStyle===r.Gradual?"grad.":"";let p=null;for(;c.isTieOrigin;){const t=c.tieDestination;if(u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,t.beat.voice.bar),!u||o.staff!==u.staff)break;if(c=t,l=!0,c.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||c.vibrato!==w.None){d=!0;break}}p=c.beat,u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,p.voice.bar),p.isLastOfVoice&&!c.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(p=null);let b=0,m=0;const g=e+o.y,y=this.renderer.smuflMetrics.glyphWidths.get(rt.ArrowheadBlackDown);b=t+o.x,h[0].value>0||n.isContinuedBend?b+=o.getBeatX(n.beat,rh.MiddleNotes):b+=o.getNoteX(n,oh.Right),m=!p||p.isLastOfVoice&&!d?t+u.x+u.postBeatGlyphsStart:d||!p.nextBeat?t+u.x+u.getBeatX(p,rh.MiddleNotes):n.bendType===a.Hold?t+u.x+u.getBeatX(p.nextBeat,rh.OnNotes):t+u.x+u.getBeatX(p.nextBeat,rh.PreNotes),l||(m-=y);const k=(m-b)/$.MaxPosition;s.beginPath();for(let t=0,e=h.length-1;t<e;t++){const e=h[t];let i=h[t+1];0!==t||0===e.value||n.isTieDestination||this.QB(n,new Wl(0,0),e,b,g,k,f,s),n.bendType!==a.Prebend?(0===t&&(b+=this.renderer.smuflMetrics.postNoteEffectPadding),this.QB(n,e,i,b,g,k,f,s)):n.isTieOrigin&&n.tieDestination.hasBend&&(i=new Wl($.MaxPosition,e.value),i.lineValue=e.lineValue,this.QB(n,e,i,b,g,k,f,s))}if(c.vibrato!==w.None){const i=m-t+y-u.x,n=g-e-this.renderer.smuflMetrics.tabBendPerValueHeight*h[h.length-1].lineValue,r=new Qo(i,n,c.vibrato);r.beat=c.beat,r.renderer=u,r.doLayout(),r.paint(t+u.x,e,s)}s.color=i}}QB(t,e,s,i,n,r,a,h){const o=this.renderer,c=this.renderer.resources,l=o.lineOffset/2,u=i+r*e.offset,d=this.renderer.smuflMetrics.tabBendPerValueHeight;let f=n-d*e.lineValue;0===e.value?s.offset===e.offset?f+=o.getNoteY(t.beat.maxStringNote,hh.Top)-l/2:f+=o.getNoteY(t,hh.Center):f+=l;const p=i+r*s.offset;let b=n-d*s.lineValue;0===s.lineValue?b+=o.getNoteY(t,hh.Center):b+=l;let m=0;const g=this.renderer.smuflMetrics.glyphWidths.get(rt.ArrowheadBlackDown);s.value>e.value?(b+g>f&&(b=f-g),h.beginPath(),h.moveTo(p,b),h.lineTo(p-.5*g,b+g),h.lineTo(p+.5*g,b+g),h.closePath(),h.fill(),m=g):s.value!==e.value&&(b<f&&(b=f+g),h.beginPath(),h.moveTo(p,b),h.lineTo(p-.5*g,b-g),h.lineTo(p+.5*g,b-g),h.closePath(),h.fill(),m=-g);const w=h.lineWidth;if(h.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,h.beginPath(),e.value===s.value){if(e.lineValue>0){let t=p;const e=this.renderer.smuflMetrics.tabBendDashSize,s=u+e;if((t-u)/(2*e)<1)h.moveTo(t,f),h.lineTo(u,f);else for(;t>s;)h.moveTo(t,f),h.lineTo(t-e,f),t-=2*e;h.stroke()}}else p>u?(h.moveTo(u,f),h.bezierCurveTo((u+p)/2,f,p,f,p,b+m),h.stroke()):(h.moveTo(u,f),h.lineTo(p,b),h.stroke());if(a&&e.offset<s.offset){h.font=c.graceFont;const t=h.measureText(a);let e=0,s=0;if(f>b){const i=Math.abs(f-b);e=i>t.height?f-i/2:f,s=(u+p-t.width)/2}else e=f,s=p-t.width;h.fillText(a,s,e)}if(0!==s.value&&e.value!==s.value){let t=s.value;const i=s.value>e.value;t=Math.abs(t);let r="";if(4===t)r="full",t-=4;else if(t>=4||t<=-4){const e=t/4|0;r+=e,t-=4*e}if(t>0&&(r+=Ol.getFractionSign(t)),""!==r){b=n-d*s.value;let t=b;i||(t=f+1*Math.abs(b-f)/3),h.font=c.tablatureFont;const e=h.measureText(r),a=t-e.height/1.5,o=p-e.width/2;h.fillText(r,o,a-c.engravingSettings.tabBendLabelPadding)}}h.lineWidth=w}static getFractionSign(t){switch(t){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${t}/ 4`}}}class Rl extends Ma{_B;BB;xB;TB;constructor(t,e,s,i){super(0,0),this._B=t,this.BB=e,this.xB=s,this.TB=i}doLayout(){this.width=0}paint(t,e,s){this.MB(t,e,s),this.ZB(t,e,s)}MB(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0;const l=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._B){case m.IntoFromBelow:o=t+i.x+i.getNoteX(this.xB,oh.Left)-l,c=e+i.y+i.getNoteY(this.xB,hh.Center)-r,a=o-n,h=e+i.y+i.getNoteY(this.xB,hh.Center)+r;break;case m.IntoFromAbove:o=t+i.x+i.getNoteX(this.xB,oh.Left)-l,c=e+i.y+i.getNoteY(this.xB,hh.Center)+r,a=o-n,h=e+i.y+i.getNoteY(this.xB,hh.Center)-r;break;default:return}this.PB(s,!1,a,o,h,c)}ZB(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0,l=!1;const u=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this.BB){case g.Shift:case g.Legato:if(a=t+i.x+i.getBeatX(this.xB.beat,rh.PostNotes)+u,h=e+i.y+i.getNoteY(this.xB,hh.Center),this.xB.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.xB.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.xB.slideTarget.beat,rh.OnNotes)-u,c=e+s.y+s.getNoteY(this.xB.slideTarget,hh.Center)):(o=t+i.x+i.width,c=h),this.xB.slideTarget.fret>this.xB.fret?(h+=r,c-=r):(h-=r,c+=r)}else o=t+i.x+this.TB.x,c=h;break;case g.OutUp:a=t+i.x+i.getNoteX(this.xB,oh.Right)+u,h=e+i.y+i.getNoteY(this.xB,hh.Center)+r,o=a+n,c=e+i.y+i.getNoteY(this.xB,hh.Center)-r;break;case g.OutDown:a=t+i.x+i.getNoteX(this.xB,oh.Right)+u,h=e+i.y+i.getNoteY(this.xB,hh.Center)-r,o=a+n,c=e+i.y+i.getNoteY(this.xB,hh.Center)+r;break;case g.PickSlideDown:a=t+i.x+i.getNoteX(this.xB,oh.Right)+2*u,h=e+i.y+i.getNoteY(this.xB,hh.Center),o=t+i.x+i.width,c=h+3*r,this.xB.beat.nextBeat&&this.xB.beat.nextBeat.voice===this.xB.beat.voice&&(o=t+i.x+i.getBeatX(this.xB.beat.nextBeat,rh.PreNotes)),l=!0;break;case g.PickSlideUp:a=t+i.x+i.getNoteX(this.xB,oh.Right)+2*u,h=e+i.y+i.getNoteY(this.xB,hh.Center),o=t+i.x+i.width,c=h-3*r,this.xB.beat.nextBeat&&this.xB.beat.nextBeat.voice===this.xB.beat.voice&&(o=t+i.x+i.getBeatX(this.xB.beat.nextBeat,rh.PreNotes)),l=!0;break;default:return}this.PB(s,l,a,o,h,c)}PB(t,e,s,i,n,r){if(e){const e=new Qo(0,0,w.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class Il extends Lc{ES;FS;constructor(t,e,s,i=!1){super(t,e,i),this.ES=Lc.getBeamDirectionForNote(t),this.FS=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.FS!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;if(this.ES!==Lc.getBeamDirectionForNote(t))return!1;switch(this.ES){case Ct.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case Ct.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),n=this.getBeamDirection(this.startBeat,i),r=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${n}`,a=this.renderer;a.staff.getSharedLayoutData(r,!1)||(a.staff.setSharedLayoutData(r,!0),super.paint(t,e,s))}}class Gl extends Ca{DB=null;CS=[];drawBeamHelperAsFlags(t){return t.hasFlag(this.renderer.drawBeamHelperAsFlags(t),this.beat)}doLayout(){this.CS=[],super.doLayout(),this.DB&&(this.DB.renderer=this.renderer,this.DB.doLayout(),this.updateWidth())}createTies(t){if(!t.isVisible)return;const e=this.renderer;if(t.isTieOrigin&&e.showTiedNotes&&t.tieDestination.isVisible){const e=new Lc(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&e.showTiedNotes){const e=new Lc(t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new Lc(t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.CS)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new Il(t,t.effectSlurDestination,!1,!1);this.CS.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.CS)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new Il(t.effectSlurOrigin,t,!1,!0);this.CS.push(e),this.addTie(e)}}if(t.slideInType!==m.None||t.slideOutType!==g.None){const e=new Rl(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.hasBend){if(!this.DB){const t=new Ol;this.DB=t,t.renderer=this.renderer,this.addTie(t)}this.DB.addBends(t)}}}class $l extends Ma{xe;t_=null;e_=null;s_=0;isEmpty=!1;noteStringWidth=0;constructor(t,e,s){super(t,e),this.xe=s}doLayout(){const t=this.xe;let e=t.fret-t.beat.voice.bar.staff.transpositionPitch;if(t.harmonicType===f.Natural&&0!==t.harmonicValue&&(e=t.harmonicValue-t.beat.voice.bar.staff.transpositionPitch),t.isTieDestination)0===t.beat.index&&this.renderer.settings.notation.notationMode===S.GuitarPro||(t.bendType===a.Bend||t.bendType===a.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(B.TabNotesOnTiedBends)?this.t_=`(${(t.tieOrigin.fret-t.beat.voice.bar.staff.transpositionPitch).toString()})`:this.t_="";else if(this.t_=t.isDead?"x":e.toString(),t.isGhost)this.t_=`(${this.t_})`;else if(t.harmonicType===f.Natural){const t=this.t_.indexOf(String.fromCharCode(46));t>=0&&(this.t_=this.t_.substr(0,t+2)),this.t_=`<${this.t_}>`}if(t.isTrill)this.e_=`(${(t.trillFret-t.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(Vt.isAlmostEqualTo(t.harmonicValue,0))this.e_="";else switch(t.harmonicType){case f.Artificial:case f.Pinch:case f.Tap:case f.Semi:case f.Feedback:let s=(e+t.harmonicValue).toString();const i=s.indexOf(String.fromCharCode(46));i>=0&&(s=s.substr(0,i+2)),this.e_=`<${s}>`;break;default:this.e_=""}if(this.isEmpty=!this.t_,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const t=!!this.e_;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this.t_+(t?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,t&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this.s_=3+this.renderer.scoreRenderer.canvas.measureText(this.e_).width,this.width+=this.s_)}}paint(t,e,s){if(this.isEmpty)return;const i=this.noteStringWidth+this.s_,n=t+this.x+(this.width-i)/2;this.paintTrill(n,e,s);const r=yh.note(s,lt.GuitarTabFretNumber,this.xe);try{s.fillText(this.t_,n,e+this.y)}finally{r?.[Symbol.dispose]?.()}}paintTrill(t,e,s){const i=yh.note(s,lt.GuitarTabFretNumber,this.xe);try{const i=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this.e_,t+this.noteStringWidth,e+this.y),this.renderer.scoreRenderer.canvas.font=i}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(t,e,s){const i=new Ee;i.note=this.xe,i.noteHeadBounds=new Ne,i.noteHeadBounds.x=e+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}class Vl extends Ma{tB=[];eB=null;AS;beat;beamingHelper;maxStringNote=null;minStringNote=null;beatEffects=new Map;notesPerString=new Map;noteStringWidth=0;constructor(t,e,s){super(t,e),this.AS=s}buildBoundingsLookup(t,e,s){for(const i of this.tB)i.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteX(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.x+s.x;switch(e){case oh.Left:break;case oh.Center:i+=s.noteStringWidth/2;break;case oh.Right:i+=s.width}return i}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,hh.Center):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,hh.Center):0}getNoteY(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.y+s.y;switch(e){case hh.Top:case hh.TopWithStem:i-=s.height/2;break;case hh.Center:break;case hh.Bottom:case hh.BottomWithStem:i+=s.height/2;case hh.StemUp:case hh.StemDown:}return i}return 0}doLayout(){let t=0;if(this.beat.deadSlapped)this.eB=new Uc,this.eB.renderer=this.renderer,this.eB.doLayout(),t=this.eB.width,this.noteStringWidth=t;else{let e=0;for(let s=0,i=this.tB.length;s<i;s++){const i=this.tB[s];i.renderer=this.renderer,i.doLayout(),i.width>t&&(t=i.width),i.noteStringWidth>e&&(e=i.noteStringWidth)}this.noteStringWidth=e;const s=this.renderer.resources.tablatureFont.size;let i=this.getNoteY(this.minStringNote,hh.Center)+s/2;const n=this.renderer.smuflMetrics.onNoteEffectPadding;for(const t of this.beatEffects.values())t.y+=i,t.x+=this.width/2,t.renderer=this.renderer,i+=t.height+n,t.doLayout()}this.width=t}addNoteGlyph(t,e){this.tB.push(t),this.notesPerString.set(e.string,t),(!this.minStringNote||e.string<this.minStringNote.string)&&(this.minStringNote=e),(!this.maxStringNote||e.string>this.maxStringNote.string)&&(this.maxStringNote=e)}paint(t,e,s){if(t+=this.x,e+=this.y,this.beat.deadSlapped)this.eB?.paint(t,e,s);else{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=st.Middle,s.font=this.AS?i.graceFont:i.tablatureFont;const r=this.tB,a=this.width;for(const i of r)i.renderer=this.renderer,i.width=a,i.paint(t,e,s);s.textBaseline=n;const h=yh.beat(s,wt.GuitarTabEffects,this.beat);try{for(const i of this.beatEffects.values())i.paint(t,e,s)}finally{h?.[Symbol.dispose]?.()}}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}}class Hl extends Na{i_;beamingHelper;constructor(t,e,s,i){super(t,e,1,cl.getSymbol(i)),this.i_=s}doLayout(){super.doLayout()}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){if(this.i_){const i=yh.beat(s,wt.GuitarTabRests,this.beat);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Ul extends Ma{static n_="tab.whammy.topoffset";static r_="tab.whammy.bottomffset";ge;HB;a_=!1;constructor(t){super(0,0),this.ge=t,this.HB=this.KB(t)}KB(t){if(t.whammyBarType===ut.Custom)return t.whammyBarPoints;const e=[];switch(t.whammyBarType){case ut.Dive:case ut.Hold:case ut.PrediveDive:case ut.Predive:e.push(new $(0,t.whammyBarPoints[0].value)),e.push(new $($.MaxPosition,t.whammyBarPoints[1].value));break;case ut.Dip:e.push(new $(0,t.whammyBarPoints[0].value)),e.push(new $($.MaxPosition/2|0,t.whammyBarPoints[1].value)),e.push(new $($.MaxPosition,t.whammyBarPoints[t.whammyBarPoints.length-1].value))}return e}doLayout(){super.doLayout(),this.a_=this.renderer.settings.notation.notationMode===S.SongBook&&this.ge.whammyBarType===ut.Dip;let t=null,e=null,s=this.ge;for(;s&&s.hasWhammyBar;)(!t||t.value>s.minWhammyPoint.value)&&(t=s.minWhammyPoint),(!e||e.value<s.maxWhammyPoint.value)&&(e=s.maxWhammyPoint),s=s.nextBeat;let i=e.value>0?Math.abs(this.h_(e.value)):0;(i>0||0!==this.ge.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys))&&(i+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding);const n=t.value<0?Math.abs(this.h_(t.value)):0,r=this.renderer.staff.getSharedLayoutData(Ul.n_,-1);let a=r;i>r&&(this.renderer.staff.setSharedLayoutData(Ul.n_,i),a=i);const h=this.renderer.staff.getSharedLayoutData(Ul.r_,-1);let o=h;n>h&&(this.renderer.staff.setSharedLayoutData(Ul.r_,n),o=h),this.height=i+n,this.renderer.registerOverflowTop(a+o)}h_(t){if(0===t)return 0;let e=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(t)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return t<0&&(e=-e),e}paint(t,e,s){const i=yh.beat(s,wt.StandardNotationEffects,this.ge);try{const i=this.renderer;let n=this.ge.nextBeat,a=null,h=rh.PreNotes;n&&(a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),a&&a.staff===i.staff&&(a===i||n.hasWhammyBar)?h=!n.hasWhammyBar||i.settings.notation.notationMode===S.SongBook&&n.whammyBarType===ut.Dip?rh.PreNotes:rh.MiddleNotes:(n=null,a=null));let o=0,c=0;this.a_?(o=t+i.x+i.getBeatX(this.ge,rh.OnNotes),c=t+i.x+i.getBeatX(this.ge,rh.PostNotes)):(o=t+i.x+i.getBeatX(this.ge,rh.MiddleNotes),c=a?t+a.x+a.getBeatX(n,h):t+i.x+i.postBeatGlyphsStart);const l=s.textAlign,u=s.textBaseline;if(s.textAlign=et.Center,s.textBaseline=st.Alphabetic,this.HB.length>=2){const t=(c-o)/$.MaxPosition;s.beginPath();const i=e+this.renderer.staff.getSharedLayoutData(Ul.n_,0);let n=this.ge.whammyStyle===r.Gradual?"grad.":"";for(let e=0,r=this.HB.length-1;e<r;e++){const r=this.HB[e],a=this.HB[e+1];let h=0===e;0!==e||0===r.value||this.ge.isContinuedWhammy||(this.o_(!1,new $(0,0),r,o,i,t,s),h=!1),this.o_(h,r,a,o,i,t,s,n),n=""}s.stroke()}s.textAlign=l,s.textBaseline=u}finally{i?.[Symbol.dispose]?.()}}o_(t,e,s,i,n,r,a,h){const o=i+r*e.offset,c=i+r*s.offset,l=n-this.h_(e.value),u=n-this.h_(s.value);if(e.offset===s.offset){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(u-l)/(2*t)<1)a.moveTo(o,l),a.lineTo(c,u);else{const e=Math.max(l,u);let s=Math.min(l,u);for(;e>s;)a.moveTo(o,s),a.lineTo(o,s+t),s+=2*t}a.stroke()}else if(e.value===s.value){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(c-o)/(2*t)<1)a.moveTo(o,l),a.lineTo(c,u);else{let e=Math.max(o,c);const s=Math.min(o,c);for(;e>s;)a.moveTo(e,l),a.lineTo(e-t,l),e-=2*t}a.stroke()}else a.moveTo(o,l),a.lineTo(c,u);const d=this.renderer.smuflMetrics.tabWhammyTextPadding;!t||this.ge.isContinuedWhammy||this.a_||(this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys)&&a.fillText("0",o,l-d),h&&a.fillText(h,o,l-d));let f=Math.abs(s.value);if((0!==f||this.renderer.settings.notation.isNotationElementVisible(B.ZerosOnDiveWhammys)&&!this.a_)&&e.value!==s.value){let t="";if(s.value<0&&(t+="-"),f>=4){const e=f/4|0;t+=e,f-=4*e}else 0===f&&(t+="0");f>0&&(t+=Ol.getFractionSign(f));let i=0;i=this.a_||e.offset===s.offset?Math.min(l,u):u;const n=c;a.fillText(t,n,i-d)}}}class zl extends Jh{slash=null;noteNumbers=null;restGlyph=null;get effectElement(){return wt.GuitarTabEffects}getNoteX(t,e){return this.noteNumbers?this.noteNumbers.getNoteX(t,e):0}getNoteY(t,e){return this.noteNumbers?this.noteNumbers.getNoteY(t,e):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(t,e,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(t,e+this.x,s+this.y)}doLayout(){const t=this.renderer,e=[];if(this.container.beat.isRest){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getTabY(e),i=new Hl(0,s,t.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.container.beat.dots>0&&t.showRests)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new Vc(0,s))}else{const s=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==l.None;let i;if(this.container.beat.slashed&&!this.container.beat.notes.some(t=>t.isTieDestination)){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),n=t.getLineY(e),r=new gl(0,n,this.container.beat.duration,s,this.container.beat);r.noteHeadElement=lt.GuitarTabFretNumber,r.effectElement=wt.GuitarTabEffects,this.slash=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addNormal(r),i=r.beatEffects}else{const t=new Vl(0,0,s);this.noteNumbers=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;for(const t of this.container.beat.notes)t.isVisible&&this.bB(t);this.addNormal(t),i=t.beatEffects}if(this.container.beat.hasWhammyBar){const t=new Ul(this.container.beat);t.renderer=this.renderer,t.doLayout(),this.container.ties.push(t)}if(this.container.beat.isTremolo&&!i.has("tremolo")){const t=this.container.beat.tremoloSpeed,s=new hl(0,0,t);s.offsetY=this.renderer.smuflMetrics.glyphTop.get(s.symbol),i.set("tremolo",s),e.push(s)}if(this.container.beat.dots>0&&t.rhythmMode!==y.Hidden)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new Vc(0,t.lineOffset*t.bar.staff.tuning.length+t.settings.notation.rhythmHeight))}if(this.isEmpty)return;let s=0;for(let t=0,e=this.glyphs.length;t<e;t++){const e=this.glyphs[t];e.x=s,e.renderer=this.renderer,e.doLayout(),s+=e.width}this.width=s,this.computedWidth=s,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(const t of e)t.x=this.centerX}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}bB(t){const e=this.renderer,s=new $l(0,0,t),i=t.beat.voice.bar.staff.tuning.length-t.string;s.y=e.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,t);const n=s.y-s.height/2,r=n+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,n,r)}}class jl extends Ma{ge;gB;constructor(t){super(0,0),this.ge=t}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.ArrowheadBlackDown),this.ge.brushType===h.ArpeggioUp){const t=new Qo(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.gB=t}else if(this.ge.brushType===h.ArpeggioDown){const t=new Qo(0,0,w.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.gB=t}}paint(t,e,s){const i=this.renderer,n=e+this.x+i.getNoteY(this.ge.maxStringNote,hh.Top),r=e+this.y+i.getNoteY(this.ge.minStringNote,hh.Bottom),a=t+this.x+this.width/2,o=this.renderer.smuflMetrics.glyphWidths.get(rt.ArrowheadBlackDown);if(this.ge.brushType!==h.None){if(this.ge.brushType===h.BrushUp||this.ge.brushType===h.BrushDown)s.beginPath(),s.moveTo(a,n),s.lineTo(a,r),s.stroke();else if(this.ge.brushType===h.ArpeggioUp){const e=this.gB,i=n,a=r-o;e.width=Math.abs(a-i),s.beginRotate(t+this.x,a,-90),e.paint(0,(this.width-e.height)/2,s),s.endRotate()}else if(this.ge.brushType===h.ArpeggioDown){const e=this.gB,i=n+o,a=r;e.width=Math.abs(a-i),s.beginRotate(t+this.x,i,90),e.paint(0,-(this.width-e.height/2),s),s.endRotate()}this.ge.brushType===h.BrushUp||this.ge.brushType===h.ArpeggioUp?(s.beginPath(),s.moveTo(a,r),s.lineTo(a+o/2,r-o),s.lineTo(a-o/2,r-o),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(a,n),s.lineTo(a+o/2,n+o),s.lineTo(a-o/2,n+o),s.closePath(),s.fill())}}}class Xl extends Xh{doLayout(){this.container.beat.brushType===h.None||this.container.beat.isRest||(this.addEffect(new jl(this.container.beat)),this.addNormal(new kc(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return wt.GuitarTabEffects}}class Jl extends Na{constructor(t,e){super(t,e,1,rt.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?rt.FourStringTabClef:rt.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(rt.GClef),this.offsetX=this.width/2}}class ql extends Jc{doLayout(){this.barSubElement=A.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Ea.GraceScale:1}}class Yl extends Cc{static StaffId="tab";c_=!1;showTimeSignature=!1;showRests=!1;showTiedNotes=!1;l_=!1;get showMultiBarRest(){return this.l_}get repeatsBarSubElement(){return A.GuitarTabsRepeats}get barNumberBarSubElement(){return A.GuitarTabsBarNumber}get barLineBarSubElement(){return A.GuitarTabsBarLines}get staffLineBarSubElement(){return A.GuitarTabsStaffLine}constructor(t,e){super(t,e),e.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this.l_=!0)}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let t=this.settings.notation.rhythmMode;return t===y.Automatic&&(t=this.bar.staff.showStandardNotation?y.Hidden:y.ShowWithBars),t}getTabY(t){return super.getLineY(t)}getTabHeight(t){return super.getLineHeight(t)}collectSpaces(t){const e=this.smuflMetrics.staffLineThickness;for(const s of this.bar.voices)if(this.hasVoiceContainer(s)){const i=this.getVoiceContainer(s);for(const s of i.beatGlyphs){const n=s.onNotes,r=n.noteNumbers;if(r)for(const[a,h]of r.notesPerString)h.isEmpty||t[this.bar.staff.tuning.length-a].push(new Float32Array([i.x+s.x+n.x+r.x-e,r.width+2*e]))}}}adjustSizes(){if(this.rhythmMode!==y.Hidden){let t=c.Whole;for(const e of this.helpers.beamHelpers)for(const s of e)s.tremoloDuration&&(!t||t<s.tremoloDuration)&&(t=s.tremoloDuration);switch(t){case c.Eighth:this.height+=this.smuflMetrics.glyphHeights.get(rt.Tremolo1);break;case c.Sixteenth:this.height+=this.smuflMetrics.glyphHeights.get(rt.Tremolo2);break;case c.ThirtySecond:this.height+=this.smuflMetrics.glyphHeights.get(rt.Tremolo3)}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),this.rhythmMode!==y.Hidden){this.c_=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)){if(this.getVoiceContainer(t).tupletGroups.length>0){this.c_=!0;break}}this.c_&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){const t=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new Jl(0,this.getTabY(t)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.jS())}jS(){this.addPreBeatGlyph(new kc(0,0,this.smuflMetrics.oneStaffSpace));const t=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new ql(0,this.getTabY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(t){if(this.additionalMultiRestBars){const e=new Kh(this.getVoiceContainer(t));this.addBeatGlyph(e)}else for(const e of t.beats){const s=new Gl(e,this.getVoiceContainer(t));s.preNotes=new Xl,s.onNotes=new zl,this.addBeatGlyph(s)}}paint(t,e,s){super.paint(t,e,s),this.rhythmMode!==y.Hidden&&(this.paintBeams(t,e,s,wt.GuitarTabFlags,wt.GuitarTabBeams),this.paintTuplets(t,e,s,wt.GuitarTabTuplet))}drawBeamHelperAsFlags(t){return super.drawBeamHelperAsFlags(t)||this.rhythmMode===y.ShowWithBeams}getFlagTopY(t,e){const s=this.getOnNotesGlyphForBeat(t);return s.noteNumbers&&t.duration!==c.Half?s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,hh.Bottom)+this.smuflMetrics.staffLineThickness:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(t,e){return this.getFlagAndBarPos()}getFlagStemSize(t,e=!1){return 0}getBarLineStart(t,e){return this.getFlagTopY(t,e)}getBeamDirection(t){return Ct.Down}getFlagAndBarPos(){return this.height-(this.c_?this.tupletSize/2:0)}calculateBeamYWithDirection(t,e,s){return this.getFlagAndBarPos()}shouldPaintFlag(t,e){return!!super.shouldPaintFlag(t,e)&&(t.graceType===l.None&&this.drawBeamHelperAsFlags(e))}paintBeamingStem(t,e,s,i,n,r){if(n<i){const t=n;n=i,i=t}const a=yh.beat(r,wt.GuitarTabStem,t);try{let a=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(t.displayStart)&&(a=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(t.displayStart).slots.slice(),a.sort((t,e)=>t.topY-e.topY));let h=n;for(;h>i;){let t=i;if(!(a.length>0&&a[a.length-1].bottomY>t)){r.fillRect(s,t,this.smuflMetrics.stemThickness,h-t);break}{const i=a.pop();t=e+i.bottomY,r.fillRect(s,t,this.smuflMetrics.stemThickness,h-t),h=e+i.topY}}}finally{a?.[Symbol.dispose]?.()}}}class Kl extends mh{showTimeSignature=null;showRests=null;showTiedNotes=null;get staffId(){return Yl.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){const s=new Yl(t,e);return null!==this.showRests&&(s.showRests=this.showRests),null!==this.showTimeSignature&&(s.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(s.showTiedNotes=this.showTiedNotes),s}}class Ql{vertical;createLayout;constructor(t,e){this.vertical=t,this.createLayout=e}}class Zl{supportsWorkers;createCanvas;constructor(t,e){this.supportsWorkers=t,this.createCanvas=e}}class tu{static u_="before-slash-always";static d_="before-score-always";static f_="before-score-hideable";static p_="before-numbered-always";static b_="before-tab-always";static m_="before-tab-hideable";static g_="before-end-always";static highDpiFactor=1;static w_=void 0;static get globalThis(){if(void 0===tu.w_){try{tu.w_=globalThis}catch{}void 0===tu.w_&&(tu.w_=self),void 0===tu.w_&&(tu.w_=global),void 0===tu.w_&&(tu.w_=window),void 0===tu.w_&&(tu.w_=Function("return this")())}return tu.w_}static webPlatform=tu.y_();static isWebPackBundled=tu.k_();static isViteBundled=tu.S_();static scriptFile=tu.B_();static fontDirectory=tu.__();static get isRunningInWorker(){return"WorkerGlobalScope"in tu.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in tu.globalThis}static createWebWorker;static createAudioWorklet;static throttle(t,e){let s=0;return()=>{tu.globalThis.clearTimeout(s),s=tu.globalThis.setTimeout(t,e)}}static B_(){if(!tu.isRunningInWorker&&tu.globalThis.ALPHATAB_ROOT){let t=tu.globalThis.ALPHATAB_ROOT;return t=tu.ensureFullUrl(t),t=tu.x_(t),t}try{const t=import.meta.url;if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in tu.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let e="";const s=tu.globalThis.location;if(e+=s.protocol?.toString(),e+="//"?.toString(),s.hostname&&(e+=s.hostname?.toString()),s.port&&(e+=":"?.toString(),e+=s.port?.toString()),!t.startsWith("/")){const t=s.pathname.split("/").slice(0,-1).join("/");t.length>0&&(t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString())}return t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString(),e}return t}static x_(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static __(){if(!tu.isRunningInWorker&&tu.globalThis.ALPHATAB_FONT)return tu.ensureFullUrl(tu.globalThis.ALPHATAB_FONT);const t=tu.scriptFile;if(t){const e=t.lastIndexOf(String.fromCharCode(47));if(e>=0)return`${t.substr(0,e)}/font/`}return null}static T_(){if(!tu.isRunningInWorker&&tu.globalThis&&"jQuery"in tu.globalThis){const t=tu.globalThis.jQuery,e=new nh;t.fn.alphaTab=function(t){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?e.exec(this[0],t,s):this.each((i,n)=>{e.exec(n,t,s)})},t.alphaTab={restore:nh.restore},t.fn.alphaTab.fn=e}}static renderEngines=tu.M_();static layoutEngines=tu.v_();static staveProfiles=tu.N_();static getRenderEngineFactory(t){return t&&tu.renderEngines.has(t)?tu.renderEngines.get(t):tu.renderEngines.get("default")}static getLayoutEngineFactory(t){return t&&tu.layoutEngines.has(t)?tu.layoutEngines.get(t):tu.layoutEngines.get(Ft.Page)}static buildImporters(){return[new zs,new li,new ri,new mi,new Us,new $e]}static M_(){const t=new Map;return t.set("svg",new Zl(!0,()=>new bh)),t.set("default",t.get("svg")),t.set("skia",new Zl(!1,()=>new fh)),tu.P_(t),t}static enableAlphaSkia(t,e){fh.enable(t,e)}static registerAlphaSkiaCustomFont(t){return fh.registerFont(t)}static P_(t){t.set("html5",new Zl(!1,()=>new la))}static E_(){return[new no(tu.u_,[new ac,new uc,new $o,new So,new ho,new Fo,new hc,new fo,new bo]),new Ll,new no(tu.d_,[new vo,new lo,new Ho,new Yo,new fc]),new no(tu.f_,[new pc,new cc,new zo(!0),new bc,new tc,new mc,new ec(!1),new Oo,new Ao(dt.Finger)],(t,e)=>e.showStandardNotation),new Pl,new no(tu.p_,[new go,new zo(!1),new _o,new Ao(dt.Thumb,(t,e)=>e.voice.bar.staff.showStandardNotation),new ic]),new Qc,new no(tu.b_,[new Go]),new no(tu.m_,[new cc,new bc,new tc,new mc,new ec(!0),new nc,new To,new Lo(f.Natural),new Lo(f.Artificial),new Lo(f.Pinch),new Lo(f.Tap),new Lo(f.Semi),new Lo(f.Feedback),new Ro,new po,new Eo,new jo,new qo,new Xo,new Oo,new Ao(dt.Finger,(t,e)=>!e.voice.bar.staff.showStandardNotation)],(t,e)=>e.showTablature),new Kl,new no(tu.g_,[new Ao(dt.Thumb,(t,e)=>!e.voice.bar.staff.showStandardNotation)])]}static N_(){const t=new Map,e=tu.E_();t.set(ds.Default,e),t.set(ds.ScoreTab,e);const s=new Set([tu.u_,tu.d_,tu.p_,tu.b_,Nl.StaffId,tu.g_]);t.set(ds.Score,e.filter(t=>s.has(t.staffId)));const i=new Set([tu.u_,tu.d_,tu.p_,tu.b_,Yl.StaffId,tu.g_]);return t.set(ds.Tab,tu.E_().filter(t=>{if(t instanceof Kl){const e=t;e.showTimeSignature=!0,e.showRests=!0,e.showTiedNotes=!0}return i.has(t.staffId)})),t.set(ds.TabMixed,tu.E_().filter(t=>{if(t instanceof Kl){const e=t;e.showTimeSignature=!1,e.showRests=!1,e.showTiedNotes=!1}return i.has(t.staffId)})),t}static v_(){const t=new Map;return t.set(Ft.Page,new Ql(!0,t=>new yc(t))),t.set(Ft.Horizontal,new Ql(!1,t=>new wc(t))),t}static initializeMain(t,e){tu.isRunningInWorker||tu.isRunningInAudioWorklet||(tu.webPlatform!==gs.Browser&&tu.webPlatform!==gs.BrowserModule||(tu.T_(),tu.highDpiFactor=window.devicePixelRatio),tu.createWebWorker=t,tu.createAudioWorklet=e)}static get alphaTabWorker(){return tu.globalThis.Worker}static get alphaTabUrl(){return tu.globalThis.URL}static initializeWorker(){if(!tu.isRunningInWorker)throw new W(s.General,"Not running in worker, cannot run worker initialization");ca.init(),aa.init(),tu.createWebWorker=t=>{throw new W(s.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!tu.isRunningInAudioWorklet)throw new W(s.General,"Not running in audio worklet, cannot run worklet initialization");Bi.init()}static k_(){try{if("function"==typeof __webpack_require__)return!0}catch{}return!1}static S_(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static y_(){if(!(void 0!==tu.globalThis.Window&&tu.globalThis instanceof tu.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return gs.NodeJs}catch{}try{const t=import.meta.url;if(t&&"string"==typeof t&&!t.startsWith("file://"))return gs.BrowserModule}catch{}return gs.Browser}static printEnvironmentInfo(t=!0){const e=t?t=>{z.log.debug("VersionInfo",t)}:t=>{z.debug("VersionInfo",t)};O.print(e),e(`High DPI: ${tu.highDpiFactor}`),tu.F_(e)}static F_(t){t(`Platform: ${gs[tu.webPlatform]}`),t(`WebPack: ${tu.isWebPackBundled}`),t(`Vite: ${tu.isViteBundled}`),tu.webPlatform!==gs.NodeJs&&(t(`Browser: ${navigator.userAgent}`),t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){const e=t.C_;if(e)return tu.prepareForPostMessage(e)}return t}static quoteJsonString(t){return JSON.stringify(t)}}!function(t){t[t.EmbeddedOpenType=0]="EmbeddedOpenType",t[t.Woff=1]="Woff",t[t.Woff2=2]="Woff2",t[t.OpenType=3]="OpenType",t[t.TrueType=4]="TrueType",t[t.Svg=5]="Svg"}(uh||(uh={}));class eu{scriptFile=null;fontDirectory=null;smuflFontSources=null;static buildDefaultSmuflFontSources(t){const e=new Map,s=t??"";return e.set(uh.Woff2,`${s}Bravura.woff2`),e.set(uh.Woff,`${s}Bravura.woff`),e.set(uh.OpenType,`${s}Bravura.otf`),e}file=null;tex=!1;tracks=null;enableLazyLoading=!0;engine="default";logLevel=_.Info;useWorkers=!0;includeNoteBounds=!1;constructor(){this.scriptFile=tu.scriptFile,this.fontDirectory=tu.fontDirectory}}const su=Object.freeze(Object.defineProperty({__proto__:null,get AlphaTexAccidentalMode(){return Bt},AlphaTexDiagnosticBag:ne,get AlphaTexDiagnosticCode(){return St},get AlphaTexDiagnosticsSeverity(){return kt},AlphaTexLexer:he,get AlphaTexNodeType(){return yt},get AlphaTexParseMode(){return Tt},AlphaTexParser:oe,get AlphaTexStaffNoteKind(){return _t},get ArgumentListParseTypesMode(){return xt}},Symbol.toStringTag,{value:"Module"})),iu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexErrorWithDiagnostics:Ie,AlphaTexImporter:$e,ScoreImporter:We,ScoreLoader:Ua,UnsupportedFormatError:Oe,alphaTex:su},Symbol.toStringTag,{value:"Module"})),nu=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:Re,IOHelper:ae},Symbol.toStringTag,{value:"Module"}));class ru{data;settings;init(t,e){this.data=t,this.settings=e}export(t,e=null){const s=Re.withCapacity(1024);return this.init(s,e??new Fr),this.writeScore(t),s.toArray()}}class au{tex="";isStartOfLine=!0;indentString="";currentIndent=0;indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}A_(){if(this.isStartOfLine&&this.indentString.length>0)for(let t=0;t<this.currentIndent;t++)this.tex+=this.indentString;this.isStartOfLine=!1}write(t){this.A_(),this.tex+=t,this.isStartOfLine=!1}writeString(t){this.A_(),this.tex+=tu.quoteJsonString(t)}writeLine(t){this.A_(),void 0!==t&&(this.tex+=t),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class hu{D_;L_=!1;get tex(){return this.D_.tex}constructor(t){const e=new au;this.L_=t.exporter.comments,e.indentString=t.exporter.indent>0?" ".repeat(t.exporter.indent):"",this.D_=e}writeScoreNode(t){this.W_(t.leadingComments);for(const e of t.bars)this.O_(e);this.W_(t.trailingComments)}O_(t){this.W_(t.leadingComments),this.R_(t.metaData),this.D_.indent();for(const e of t.beats)this.I_(e);this.D_.outdent(),this.W_(t.trailingComments),this.G_(t.pipe,!0)}I_(t){this.W_(t.leadingComments),t.durationChange&&this.V_(t.durationChange),t.rest?this.H_(t.rest):t.notes&&this.U_(t.notes),this.G_(t.durationDot,!1),this.H_(t.durationValue),this.G_(t.beatMultiplier,!1),this.H_(t.beatMultiplierValue),t.beatEffects&&this.z_(t.beatEffects,!1),this.W_(t.trailingComments),this.D_.writeLine()}U_(t){this.W_(t.leadingComments),this.G_(t.openParenthesis,!1);let e=!0;for(const s of t.notes)e||this.D_.write(" "),this.j_(s),e=!1;this.G_(t.closeParenthesis,!1),this.W_(t.trailingComments)}j_(t){this.W_(t.leadingComments),this.H_(t.noteValue),this.G_(t.noteStringDot,!1),this.H_(t.noteString),t.noteEffects&&this.z_(t.noteEffects,!1),this.W_(t.trailingComments)}V_(t){this.W_(t.leadingComments),this.G_(t.colon,!1),this.H_(t.value),t.properties&&(this.D_.write(" "),this.z_(t.properties,!1)),this.W_(t.trailingComments),this.D_.write(" ")}R_(t){for(const e of t)this.X_(e)}J_=0;q_=0;Y_=0;X_(t){switch(t.tag.tag.text){case"track":this.J_>0&&this.D_.outdent();break;case"staff":this.q_>0&&this.D_.outdent();break;case"voice":this.Y_>0&&this.D_.outdent()}this.W_(t.leadingComments),this.G_(t.tag.prefix,!1),this.H_(t.tag.tag);let e=!0;switch(t.propertiesBeforeArguments?(t.properties&&(this.D_.write(" "),this.z_(t.properties,!1)),t.arguments&&(this.D_.write(" "),this.K_(t.arguments))):(t.arguments&&(this.D_.write(" "),this.K_(t.arguments)),t.properties&&(this.D_.write(" "),this.z_(t.properties,!0),e=!1)),t.trailingComments&&(this.D_.write(" "),this.W_(t.trailingComments)),t.tag.tag.text){case"track":this.J_++,this.q_=0,this.Y_=0,this.D_.indent();break;case"staff":this.q_++,this.Y_=0,this.D_.indent();break;case"voice":this.Y_++,this.D_.indent()}e&&this.D_.writeLine()}z_(t,e){this.W_(t.leadingComments),this.G_(t.openBrace,e),e&&this.D_.indent();let s=!0;for(const i of t.properties)s||e||this.D_.write(" "),this.Q_(i),s=!1,e&&this.D_.writeLine();e&&this.D_.outdent(),this.G_(t.closeBrace,e),this.W_(t.trailingComments)}Q_(t){this.W_(t.leadingComments),this.H_(t.property),t.arguments&&(this.D_.write(" "),this.K_(t.arguments)),this.W_(t.trailingComments)}K_(t){this.W_(t.leadingComments),this.G_(t.openParenthesis,!1);let e=!0;for(const s of t.arguments)e||this.D_.write(" "),this.H_(s),e=!1;this.G_(t.closeParenthesis,!1),this.W_(t.trailingComments)}H_(t){if(t){switch(this.W_(t.leadingComments),t.nodeType){case yt.Ident:this.D_.write(t.text);break;case yt.Arguments:this.K_(t);break;case yt.Number:this.D_.write(t.value.toString());break;case yt.String:this.D_.writeString(t.text)}this.W_(t.trailingComments)}}G_(t,e){if(t){switch(this.W_(t.leadingComments),t.nodeType){case yt.Dot:this.D_.write(".");break;case yt.Backslash:this.D_.write("\\");break;case yt.DoubleBackslash:this.D_.write("\\\\");break;case yt.Pipe:this.D_.write("|");break;case yt.LBrace:this.D_.write("{");break;case yt.RBrace:this.D_.write("}");break;case yt.LParen:this.D_.write("(");break;case yt.RParen:this.D_.write(")");break;case yt.Colon:this.D_.write(":");break;case yt.Asterisk:this.D_.write("*")}this.W_(t.trailingComments),e&&this.D_.writeLine()}}W_(t){if(this.L_&&t)for(const e of t){let t=e.text;t.startsWith(" ")||(t=` ${t}`),e.multiLine?(t.endsWith(" ")||(t+=" "),this.D_.write(`/*${t}*/`)):this.D_.writeLine(`//${t}`)}}}var ou;!function(t){t[t.SteelGuitar=1]="SteelGuitar",t[t.AcousticGuitar=2]="AcousticGuitar",t[t.TwelveStringGuitar=3]="TwelveStringGuitar",t[t.ElectricGuitar=4]="ElectricGuitar",t[t.Bass=5]="Bass",t[t.ClassicalGuitar=23]="ClassicalGuitar",t[t.UprightBass=6]="UprightBass",t[t.Ukulele=7]="Ukulele",t[t.Banjo=8]="Banjo",t[t.Mandolin=9]="Mandolin",t[t.Piano=10]="Piano",t[t.Synth=12]="Synth",t[t.Strings=11]="Strings",t[t.Brass=13]="Brass",t[t.Reed=14]="Reed",t[t.Woodwind=15]="Woodwind",t[t.Vocal=16]="Vocal",t[t.PitchedIdiophone=17]="PitchedIdiophone",t[t.Fx=21]="Fx",t[t.PercussionKit=18]="PercussionKit",t[t.Idiophone=19]="Idiophone",t[t.Membraphone=20]="Membraphone"}(ou||(ou={}));class cu{icon=ou.Piano;instrumentSetName;instrumentSetType;constructor(t,e,s=null){if(this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const t=e.split(" ");t[0]=t[0].substr(0,1).toLowerCase()+t[0].substr(1),this.instrumentSetType=t.join("")}}}class lu{static ha=44100;Z_=new Map;static tx=new Map([[0,new cu(ou.Piano,"Acoustic Piano")],[1,new cu(ou.Piano,"Acoustic Piano")],[2,new cu(ou.Piano,"Electric Piano")],[3,new cu(ou.Piano,"Acoustic Piano")],[4,new cu(ou.Piano,"Electric Piano")],[5,new cu(ou.Piano,"Electric Piano")],[6,new cu(ou.Piano,"Harpsichord")],[7,new cu(ou.Piano,"Harpsichord")],[8,new cu(ou.PitchedIdiophone,"Celesta")],[9,new cu(ou.PitchedIdiophone,"Vibraphone")],[10,new cu(ou.PitchedIdiophone,"Vibraphone")],[11,new cu(ou.PitchedIdiophone,"Vibraphone")],[12,new cu(ou.PitchedIdiophone,"Xylophone")],[13,new cu(ou.PitchedIdiophone,"Xylophone")],[14,new cu(ou.PitchedIdiophone,"Vibraphone")],[15,new cu(ou.Banjo,"Banjo")],[16,new cu(ou.Piano,"Electric Organ")],[17,new cu(ou.Piano,"Electric Organ")],[18,new cu(ou.Piano,"Electric Organ")],[19,new cu(ou.Piano,"Electric Organ")],[20,new cu(ou.Piano,"Electric Organ")],[21,new cu(ou.Piano,"Electric Organ")],[22,new cu(ou.Woodwind,"Recorder")],[23,new cu(ou.Piano,"Electric Organ")],[24,new cu(ou.ClassicalGuitar,"Nylon Guitar")],[25,new cu(ou.SteelGuitar,"Steel Guitar")],[26,new cu(ou.SteelGuitar,"Electric Guitar")],[27,new cu(ou.ElectricGuitar,"Electric Guitar")],[28,new cu(ou.ElectricGuitar,"Electric Guitar")],[29,new cu(ou.ElectricGuitar,"Electric Guitar")],[30,new cu(ou.SteelGuitar,"Electric Guitar")],[31,new cu(ou.SteelGuitar,"Electric Guitar")],[32,new cu(ou.Bass,"Acoustic Bass")],[33,new cu(ou.Bass,"Electric Bass")],[34,new cu(ou.Bass,"Electric Bass")],[35,new cu(ou.Bass,"Acoustic Bass")],[36,new cu(ou.Bass,"Electric Bass")],[37,new cu(ou.Bass,"Electric Bass")],[38,new cu(ou.Synth,"Synth Bass")],[39,new cu(ou.Synth,"Synth Bass")],[40,new cu(ou.Strings,"Violin")],[41,new cu(ou.Strings,"Viola")],[42,new cu(ou.Strings,"Cello")],[43,new cu(ou.Strings,"Contrabass")],[44,new cu(ou.Strings,"Violin")],[45,new cu(ou.Strings,"Violin")],[46,new cu(ou.Piano,"Harp")],[47,new cu(ou.Membraphone,"Timpani")],[48,new cu(ou.Strings,"Violin")],[49,new cu(ou.Strings,"Violin")],[50,new cu(ou.Strings,"Violin")],[51,new cu(ou.Strings,"Violin")],[52,new cu(ou.Vocal,"Voice")],[53,new cu(ou.Vocal,"Voice")],[54,new cu(ou.Vocal,"Voice")],[55,new cu(ou.Synth,"Pad Synthesizer")],[56,new cu(ou.Brass,"Trumpet")],[57,new cu(ou.Brass,"Trombone")],[58,new cu(ou.Brass,"Tuba")],[59,new cu(ou.Brass,"Trumpet")],[60,new cu(ou.Brass,"French Horn")],[61,new cu(ou.Brass,"Trumpet")],[62,new cu(ou.Brass,"Trumpet")],[63,new cu(ou.Brass,"Trumpet")],[64,new cu(ou.Reed,"Saxophone")],[65,new cu(ou.Reed,"Saxophone")],[66,new cu(ou.Reed,"Saxophone")],[67,new cu(ou.Reed,"Saxophone")],[68,new cu(ou.Reed,"Oboe")],[69,new cu(ou.Reed,"English Horn")],[70,new cu(ou.Reed,"Bassoon")],[71,new cu(ou.Reed,"Clarinet")],[72,new cu(ou.Reed,"Piccolo")],[73,new cu(ou.Woodwind,"Flute")],[74,new cu(ou.Woodwind,"Recorder")],[75,new cu(ou.Woodwind,"Flute")],[76,new cu(ou.Woodwind,"Recorder")],[77,new cu(ou.Woodwind,"Flute")],[78,new cu(ou.Woodwind,"Recorder")],[79,new cu(ou.Woodwind,"Flute")],[80,new cu(ou.Synth,"Lead Synthesizer")],[81,new cu(ou.Synth,"Lead Synthesizer")],[82,new cu(ou.Synth,"Lead Synthesizer")],[83,new cu(ou.Synth,"Lead Synthesizer")],[84,new cu(ou.Synth,"Lead Synthesizer")],[85,new cu(ou.Synth,"Lead Synthesizer")],[86,new cu(ou.Synth,"Lead Synthesizer")],[87,new cu(ou.Synth,"Lead Synthesizer")],[88,new cu(ou.Synth,"Pad Synthesizer")],[89,new cu(ou.Synth,"Pad Synthesizer")],[90,new cu(ou.Synth,"Pad Synthesizer")],[91,new cu(ou.Synth,"Pad Synthesizer")],[92,new cu(ou.Synth,"Pad Synthesizer")],[93,new cu(ou.Synth,"Pad Synthesizer")],[94,new cu(ou.Synth,"Pad Synthesizer")],[95,new cu(ou.Synth,"Pad Synthesizer")],[96,new cu(ou.Fx,"Pad Synthesizer")],[97,new cu(ou.Fx,"Pad Synthesizer")],[98,new cu(ou.Fx,"Pad Synthesizer")],[99,new cu(ou.Fx,"Pad Synthesizer")],[100,new cu(ou.Fx,"Lead Synthesizer")],[101,new cu(ou.Fx,"Lead Synthesizer")],[102,new cu(ou.Fx,"Lead Synthesizer")],[103,new cu(ou.Fx,"Trumpet")],[104,new cu(ou.ElectricGuitar,"Banjo")],[105,new cu(ou.Banjo,"Banjo")],[106,new cu(ou.Ukulele,"Ukulele")],[107,new cu(ou.Banjo,"Banjo")],[108,new cu(ou.PitchedIdiophone,"Xylophone")],[109,new cu(ou.Reed,"Bassoon")],[110,new cu(ou.Strings,"Violin")],[111,new cu(ou.Woodwind,"Flute")],[112,new cu(ou.PitchedIdiophone,"Xylophone")],[113,new cu(ou.Idiophone,"Celesta")],[114,new cu(ou.PitchedIdiophone,"Vibraphone")],[115,new cu(ou.Idiophone,"Xylophone")],[116,new cu(ou.Membraphone,"Xylophone")],[117,new cu(ou.Membraphone,"Xylophone")],[118,new cu(ou.Membraphone,"Xylophone")],[119,new cu(ou.Idiophone,"Celesta")],[120,new cu(ou.Fx,"Steel Guitar")],[121,new cu(ou.Fx,"Recorder")],[122,new cu(ou.Fx,"Recorder")],[123,new cu(ou.Fx,"Recorder")],[124,new cu(ou.Fx,"Recorder")],[125,new cu(ou.Fx,"Recorder")],[126,new cu(ou.Fx,"Recorder")],[127,new cu(ou.Fx,"Timpani")]]);static sx=new cu(ou.PercussionKit,"Drums","drumKit");writeXml(t){const e=new Ps;return this.Z_=new Map,this.ix(e,t),e.toFormattedString("",!0)}ix(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const n=s.addElement("Encoding");n.addElement("EncodingDescription").innerText="GP8";const r=new Ts;r.nodeType=Je.Comment,r.value=`Written by alphaTab ${O.version} (${O.commit})`,n.addChild(r),this.nx(s,e),this.hx(s,e),this.ox(s,e),this.lx(s,e),this.ux(s,e),this.bx(s,e),this.mx(s,e);const a=s.addElement("Bars"),h=s.addElement("Voices"),o=s.addElement("Beats"),c=s.addElement("Notes"),l=s.addElement("Rhythms");for(const t of e.tracks)for(const e of t.staves)for(const t of e.bars){this.gx(a,t);for(const e of t.voices){this.wx(h,e);for(const t of e.beats){this.yx(o,t,l);for(const e of t.notes)this.kx(c,e)}}}}mx(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("Assets").addElement("Asset");s.attributes.set("id",this.oa),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}oa;Sx;backingTrackAssetFileName;ox(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("BackingTrack");this.oa="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";const n=void 0!==this.Sx?this.Sx:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}kx(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this.Bx(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case u.Normal:i|=8;break;case u.Heavy:i|=4;break;case u.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const t=s.addElement("Tie");t.attributes.set("origin",e.isTieOrigin?"true":"false"),t.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case w.Slight:s.addElement("Vibrato").innerText="Slight";break;case w.Wide:s.addElement("Vibrato").innerText="Wide"}if(e.isFingering){switch(e.leftHandFinger){case d.Thumb:s.addElement("LeftFingering").innerText="P";break;case d.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case d.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case d.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case d.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(e.rightHandFinger){case d.Thumb:s.addElement("RightFingering").innerText="P";break;case d.IndexFinger:s.addElement("RightFingering").innerText="I";break;case d.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case d.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case d.LittleFinger:s.addElement("RightFingering").innerText="C"}}e.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=e.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",e.ornament!==ct.None&&(s.addElement("Ornament").innerText=ct[e.ornament])}Bx(t,e){const s=t.addElement("Properties");if(this._x(s,e),this.xx(s,e),e.isStringed&&(this.Tx(s,"String","String",(e.string-1).toString()),this.Tx(s,"Fret","Fret",e.fret.toString()),this.Tx(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this.Tx(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this.Tx(s,"Octave","Number",e.octave.toString()),this.Tx(s,"Tone","Step",e.tone.toString()),this.Tx(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this.Tx(s,"Tapped","Enable",null),e.harmonicType!==f.None){switch(e.harmonicType){case f.Natural:this.Tx(s,"HarmonicType","HType","Natural");break;case f.Artificial:this.Tx(s,"HarmonicType","HType","Artificial");break;case f.Pinch:this.Tx(s,"HarmonicType","HType","Pinch");break;case f.Tap:this.Tx(s,"HarmonicType","HType","Tap");break;case f.Semi:this.Tx(s,"HarmonicType","HType","Semi");break;case f.Feedback:this.Tx(s,"HarmonicType","HType","Feedback")}0!==e.harmonicValue&&this.Tx(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this.Tx(s,"Muted","Enable",null),e.isPalmMute&&this.Tx(s,"PalmMuted","Enable",null),e.hasBend&&this.Mx(s,e),e.isHammerPullOrigin&&this.Tx(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this.Tx(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this.Tx(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case m.IntoFromAbove:i|=32;break;case m.IntoFromBelow:i|=16}switch(e.slideOutType){case g.Shift:i|=1;break;case g.Legato:i|=2;break;case g.OutDown:i|=4;break;case g.OutUp:i|=8;break;case g.PickSlideDown:i|=64;break;case g.PickSlideUp:i|=128}i>0&&this.Tx(s,"Slide","Flags",i.toString())}xx(t,e){e.isPercussion?this.vx(t,"ConcertPitch","C","-1",""):this.Nx(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode,e.beat.voice.bar.keySignature)}_x(t,e){e.isPercussion?this.vx(t,"ConcertPitch","C","-1",""):this.Nx(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode,e.beat.voice.bar.keySignature)}static Px=["C","C","D","D","E","F","F","G","G","A","A","B"];Nx(t,e,s,i,n){let r=0,a=0,h="",o="";const c=()=>{switch(r=s%12,a=s/12|0,h=lu.Px[r],Vt.computeAccidental(n,p.Default,s,!1)){case at.None:case at.Natural:o="";break;case at.Sharp:o="#";break;case at.Flat:o="b";break;case at.DoubleSharp:o="x";break;case at.DoubleFlat:o="bb"}};switch(c(),i){case p.Default:break;case p.ForceNone:case p.ForceNatural:o="";break;case p.ForceSharp:o="#";break;case p.ForceDoubleSharp:"#"===o&&(s-=2,c()),o="x";break;case p.ForceFlat:"#"===o&&(s+=1,c()),o="b";break;case p.ForceDoubleFlat:"#"===o&&(s+=2,c()),o="bb"}this.vx(t,e,h,a.toString(),o)}vx(t,e,s,i,n){const r=t.addElement("Property");r.attributes.set("name",e);const a=r.addElement("Pitch");a.addElement("Step").innerText=s,a.addElement("Accidental").innerText=n,a.addElement("Octave").innerText=i}Mx(t,e){e.hasBend&&e.bendPoints.length<=4&&this.Ex(t,e.bendPoints)}Ex(t,e){this.Tx(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let n,r;switch(e.length){case 4:n=e[1],r=e[2];break;case 3:n=e[1],r=e[1];break;default:n=new $((s.offset+i.offset)/2,(s.value+i.value)/2),r=n}this.Tx(t,"BendDestinationOffset","Float",this.Gh(i.offset).toString()),this.Tx(t,"BendDestinationValue","Float",this.Ih(i.value).toString()),this.Tx(t,"BendMiddleOffset1","Float",this.Gh(n.offset).toString()),this.Tx(t,"BendMiddleOffset2","Float",this.Gh(r.offset).toString()),this.Tx(t,"BendMiddleValue","Float",this.Ih(n.value).toString()),this.Tx(t,"BendOriginOffset","Float",this.Gh(s.offset).toString()),this.Tx(t,"BendOriginValue","Float",this.Ih(s.value).toString())}Ih(t){return 25*t}Gh(t){return t/$.MaxPosition*100}yx(t,e,s){const n=t.addElement("Beat");if(n.attributes.set("id",e.id.toString()),n.addElement("Dynamic").innerText=i[e.dynamics],e.fade!==ft.None&&(n.addElement("Fadding").innerText=ft[e.fade]),e.isTremolo)switch(e.tremoloSpeed){case c.Eighth:n.addElement("Tremolo").innerText="1/2";break;case c.Sixteenth:n.addElement("Tremolo").innerText="1/4";break;case c.ThirtySecond:n.addElement("Tremolo").innerText="1/8"}switch(e.hasChord&&n.addElement("Chord").setCData(e.chordId),e.crescendo!==o.None&&(n.addElement("Hairpin").innerText=o[e.crescendo]),e.brushType){case h.ArpeggioUp:n.addElement("Arpeggio").innerText="Up";break;case h.ArpeggioDown:n.addElement("Arpeggio").innerText="Down"}switch(e.text&&n.addElement("FreeText").setCData(e.text),e.graceType){case l.OnBeat:case l.BeforeBeat:n.addElement("GraceNotes").innerText=l[e.graceType]}if(e.ottava!==b.Regular&&(n.addElement("Ottavia").innerText=b[e.ottava].substr(1)),e.hasWhammyBar&&this.Cx(n,e),e.isLegatoOrigin||e.isLegatoDestination){const t=n.addElement("Legato");t.attributes.set("origin",e.isLegatoOrigin?"true":"false"),t.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this.Ax(n,e,s),null!==e.preferredBeamDirection)switch(e.preferredBeamDirection){case Ct.Up:n.addElement("TransposedPitchStemOrientation").innerText="Upward",n.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case Ct.Down:n.addElement("TransposedPitchStemOrientation").innerText="Downward",n.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}n.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&n.addElement("Slashed"),e.deadSlapped&&n.addElement("DeadSlapped"),e.notes.length>0&&(n.addElement("Notes").innerText=e.notes.map(t=>t.id).join(" ")),e.golpe!==dt.None&&(n.addElement("Golpe").innerText=dt[e.golpe]),e.wahPedal!==pt.None&&(n.addElement("Wah").innerText=pt[e.wahPedal]),e.showTimer&&(n.addElement("Timer").innerText=(e.timer??0).toString()),this.Dx(n,e),this.Lx(n,e),e.lyrics&&e.lyrics.length>0&&this.Wx(n,e.lyrics)}Wx(t,e){const s=t.addElement("Lyrics");for(const t of e){s.addElement("Line").setCData(t)}}Lx(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this.Ox(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case gt.ForceSplitToNext:this.Ox(s,"1124204546","Int","2");break;case gt.ForceMergeWithNext:this.Ox(s,"1124204546","Int","1");break;case gt.ForceSplitOnSecondaryToNext:this.Ox(s,"1124204552","Int","1")}}Dx(t,e){const s=t.addElement("Properties");switch(e.brushType){case h.BrushUp:this.Tx(s,"Brush","Direction","Up");break;case h.BrushDown:this.Tx(s,"Brush","Direction","Down")}switch(e.pickStroke){case ht.Up:this.Tx(s,"PickStroke","Direction","Up");break;case ht.Down:this.Tx(s,"PickStroke","Direction","Down")}switch(e.slap&&this.Tx(s,"Slapped","Enable",null),e.pop&&this.Tx(s,"Popped","Enable",null),e.vibrato){case w.Wide:this.Tx(s,"VibratoWTremBar","Strength","Wide");break;case w.Slight:this.Tx(s,"VibratoWTremBar","Strength","Slight")}if(e.isBarre)switch(this.Tx(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case bt.Full:this.Tx(s,"BarreString","String","0");break;case bt.Half:this.Tx(s,"BarreString","String","1")}if(e.rasgueado!==mt.None){let t="";switch(e.rasgueado){case mt.Ii:t="ii_1";break;case mt.Mi:t="mi_1";break;case mt.MiiTriplet:t="mii_1";break;case mt.MiiAnapaest:t="mii_2";break;case mt.PmpTriplet:t="pmp_1";break;case mt.PmpAnapaest:t="pmp_2";break;case mt.PeiTriplet:t="pei_1";break;case mt.PeiAnapaest:t="pei_2";break;case mt.PaiTriplet:t="pai_1";break;case mt.PaiAnapaest:t="pai_2";break;case mt.AmiTriplet:t="ami_1";break;case mt.AmiAnapaest:t="ami_2";break;case mt.Ppp:t="ppp_1";break;case mt.Amii:t="amii_1";break;case mt.Amip:t="amip_1";break;case mt.Eami:t="eami_1";break;case mt.Eamii:t="eamii_1";break;case mt.Peami:t="peami_1"}this.Tx(s,"Rasgueado","Rasgueado",t)}}Ax(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let n;if(this.Z_.has(i))n=this.Z_.get(i);else{n=this.Z_.size.toString(),this.Z_.set(i,n);const t=s.addElement("Rhythm");if(t.attributes.set("id",n),e.hasTuplet){const s=t.addElement("PrimaryTuplet");s.attributes.set("num",e.tupletNumerator.toString()),s.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&t.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let r="Quarter";switch(e.duration){case c.QuadrupleWhole:r="Long";break;case c.DoubleWhole:r="DoubleWhole";break;case c.Whole:r="Whole";break;case c.Half:r="Half";break;case c.Quarter:r="Quarter";break;case c.Eighth:r="Eighth";break;case c.Sixteenth:r="16th";break;case c.ThirtySecond:r="32nd";break;case c.SixtyFourth:r="64th";break;case c.OneHundredTwentyEighth:r="128th";break;case c.TwoHundredFiftySixth:r="256th"}t.addElement("NoteValue").innerText=r}t.addElement("Rhythm").attributes.set("ref",n)}Cx(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this.Rx(t,e.whammyBarPoints)}Rx(t,e){const s=t.addElement("Whammy"),i=e[0],n=e[e.length-1];let r,a;switch(e.length){case 4:r=e[1],a=e[2];break;case 3:r=e[1],a=e[1];break;default:r=new $((i.offset+n.offset)/2,(i.value+n.value)/2),a=r}s.attributes.set("destinationOffset",this.Gh(n.offset).toString()),s.attributes.set("destinationValue",this.Ih(n.value).toString()),s.attributes.set("middleOffset1",this.Gh(r.offset).toString()),s.attributes.set("middleOffset2",this.Gh(a.offset).toString()),s.attributes.set("middleValue",this.Ih(r.value).toString()),s.attributes.set("originOffset",this.Gh(i.offset).toString()),s.attributes.set("originValue",this.Ih(i.value).toString())}nx(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}hx(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(t=>t.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===e.masterBars[0].tempoAutomations.length){const t=i.addElement("Automation");t.addElement("Type").innerText="Tempo",t.addElement("Linear").innerText="false",t.addElement("Bar").innerText="0",t.addElement("Position").innerText="0",t.addElement("Visible").innerText="true",t.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(t.addElement("Text").innerText=e.tempoLabel)}const n=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(t=>0===t.ratioPosition&&0===t.syncPointValue.barOccurence):void 0,r=n?n.syncPointValue.millisecondOffset:0;this.Sx=r/1e3*lu.ha*-1|0;const a=new H(()=>xa.buildModifiedTempoLookup(e));for(const t of e.masterBars){for(const e of t.tempoAutomations){const s=i.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=e.isLinear?"true":"false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText=e.isVisible?"true":"false",s.addElement("Value").innerText=`${e.value} 2`,e.text&&(s.addElement("Text").innerText=e.text)}if(t.syncPoints)for(const s of t.syncPoints){const n=i.addElement("Automation");n.addElement("Type").innerText="SyncPoint",n.addElement("Linear").innerText="false",n.addElement("Bar").innerText=t.index.toString(),n.addElement("Position").innerText=s.ratioPosition.toString(),n.addElement("Visible").innerText=s.isVisible?"true":"false";const h=n.addElement("Value");h.addElement("BarIndex").innerText=t.index.toString(),h.addElement("BarOccurrence").innerText=s.syncPointValue.barOccurence.toString(),h.addElement("ModifiedTempo").innerText=a.value.get(s).syncBpm.toString(),h.addElement("OriginalTempo").innerText=e.tempo.toString();let o=(s.syncPointValue.millisecondOffset-r)/1e3*lu.ha;o=Math.floor(o+.5),h.addElement("FrameOffset").innerText=o.toString()}}}lx(t,e){t.addElement("AudioTracks")}ux(t,e){const s=t.addElement("Tracks");for(const t of e.tracks)this.Ix(s,t)}Ix(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=ue.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=lu.Gx(e.playbackInfo).toString(),this.$x(s,e),this.Vx(s,e),this.Hx(s,e),s.addElement("ForcedSound").innerText="-1",this.Ux(s,e),e.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":e.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this.zx(s,e),this.jx(s,e),this.Xx(s,e)}static Gx(t){return 9===t.primaryChannel?lu.sx.icon:lu.tx.has(t.program)?lu.tx.get(t.program).icon:ou.SteelGuitar}Jx(t,e,s,i,n,r,a,h,o=0){const c=t.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(n);const l=c.addElement("MIDI"),u=ue.bankToLsbMsb(h);l.addElement("LSB").innerText=u[0].toString(),l.addElement("MSB").innerText=u[1].toString(),l.addElement("Program").innerText=a.toString();const d=e.addElement("Automation");d.addElement("Type").innerText="Sound",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=r.toString(),d.addElement("Position").innerText=o.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").setCData(`${i};${s};${n}`)}Xx(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const t=`Track_${e.index}_Initial`,r=`Midi/${e.playbackInfo.program}`,a="Factory";let h=!1,o=e.playbackInfo.bank;for(const c of e.staves)for(const l of c.bars)for(const c of l.voices)for(const u of c.beats){const c=u.getAutomation(n.Instrument),d=0===l.index&&0===u.index,f=u.getAutomation(n.Bank);if(f&&(o=f.value),c){const n=d?t:`ProgramChange_${u.id}`,f=d?r:`Midi/${c.value}`,p=d?a:"User";d||h||(this.Jx(s,i,t,r,a,e.staves[0].bars[0].index,e.playbackInfo.program,e.playbackInfo.bank),h=!0),this.Jx(s,i,n,f,p,l.index,c.value,o,c.ratioPosition),d&&(h=!0)}}}for(const t of e.staves)for(const e of t.bars)for(const t of e.sustainPedals)if(t.pedalType!==C.Hold){const s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=e.index.toString(),s.addElement("Position").innerText=t.ratioPosition.toString(),s.addElement("Visible").innerText="true",t.pedalType){case C.Down:s.addElement("Value").innerText="0 1";break;case C.Up:s.addElement("Value").innerText="0 3"}}}Ux(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}Hx(t,e){const s=t.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56");s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}jx(t,e){const s=t.addElement("Staves");for(const t of e.staves)this.qx(s,t)}qx(t,e){const s=t.addElement("Staff").addElement("Properties");if(this.Tx(s,"CapoFret","Fret",e.capo.toString()),this.Tx(s,"FretCount","Fret","24"),e.tuning.length>0){const t=s.addElement("Property");switch(t.attributes.set("name","Tuning"),t.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),t.addElement("Label").setCData(e.tuningName),t.addElement("LabelVisible").innerText=e.tuningName?"true":"false",t.addElement("Flat"),e.tuning.length){case 3:t.addElement("Instrument").innerText="Shamisen";break;case 4:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":42===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Cello":43===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Contrabass":40===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Violin":41===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Viola":t.addElement("Instrument").innerText="Bass";break;case 5:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":t.addElement("Instrument").innerText="Bass";break;case 6:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;case 7:e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;default:t.addElement("Instrument").innerText="Guitar"}}this.Tx(s,"PartialCapoFret","Fret","0"),this.Tx(s,"PartialCapoStringFlags","Bitset",e.tuning.map(t=>"0").join("")),this.Tx(s,"TuningFlat","Enable",null),this.Yx(s,e,"DiagramCollection"),this.Yx(s,e,"DiagramWorkingSet")}Yx(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const n=i.addElement("Items"),r=e.chords;if(r)for(const[t,e]of r){const s=n.addElement("Item");s.attributes.set("id",t),s.attributes.set("name",e.name);const i=s.addElement("Diagram");i.attributes.set("stringCount",e.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(e.firstFret-1).toString()),i.attributes.set("barStates",e.strings.map(t=>"1").join(" "));const r=[],a=new Map;for(let t=0;t<e.strings.length;t++){const s=e.strings[t];if(-1!==s){const n=i.addElement("Fret"),h=e.strings.length-1-t;n.attributes.set("string",h.toString()),n.attributes.set("fret",(s-e.firstFret+1).toString()),a.has(s)||(a.set(s,[]),r.push(s)),a.get(s).push(h)}}r.sort();const h=i.addElement("Fingering");if(e.barreFrets.length>0){const t=[d.LittleFinger,d.AnnularFinger,d.MiddleFinger,d.IndexFinger];for(const s of r){const i=a.get(s);if(i.length>1&&e.barreFrets.indexOf(s)>=0){const n=t.length>0?t.pop():d.IndexFinger;for(const t of i){const i=h.addElement("Position");switch(n){case d.LittleFinger:i.attributes.set("finger","Pinky");break;case d.AnnularFinger:i.attributes.set("finger","Ring");break;case d.MiddleFinger:i.attributes.set("finger","Middle");break;case d.IndexFinger:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-e.firstFret+1).toString()),i.attributes.set("string",t.toString())}}}}const o=i.addElement("Property");o.attributes.set("name","ShowName"),o.attributes.set("type","bool"),o.attributes.set("value",e.showName?"true":"false");const c=i.addElement("Property");c.attributes.set("name","ShowDiagram"),c.attributes.set("type","bool"),c.attributes.set("value",e.showDiagram?"true":"false");const l=i.addElement("Property");l.attributes.set("name","ShowFingering"),l.attributes.set("type","bool"),l.attributes.set("value",e.showFingering?"true":"false");const u=i.addElement("Chord"),f=u.addElement("KeyNote");f.attributes.set("step","C"),f.attributes.set("accidental","Natural");const p=u.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");const b=u.addElement("Degree");b.attributes.set("interval","Third"),b.attributes.set("alteration","Major"),b.attributes.set("omitted","false");const m=u.addElement("Degree");m.attributes.set("interval","Fifth"),m.attributes.set("alteration","Perfect"),m.attributes.set("omitted","false")}}Tx(t,e,s,i){const n=t.addElement("Property");n.attributes.set("name",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}Ox(t,e,s,i){const n=t.addElement("XProperty");n.attributes.set("id",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}zx(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const t of e.staves[0].bars)for(const e of t.voices)if(!e.isEmpty)for(const s of e.beats)if(s.lyrics)for(let e=0;e<s.lyrics.length;e++){for(;e>=i.length;){const e=new me;e.startBar=t.index,e.text="[Empty]",i.push(e)}const n=i[e];n.text="[Empty]"===n.text?s.lyrics[e]:`${n.text} ${s.lyrics[e].split(" ").join("+")}`}for(let t=0;t<i.length;t++){const e=s.addElement("Line");e.addElement("Text").setCData(i[t].text),e.addElement("Offset").innerText=i[t].startBar.toString()}}Vx(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),n=e.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=n.toString(),s.addElement("Octave").innerText=i.toString()}$x(t,e){const s=t.addElement("InstrumentSet"),i=e.staves[0];if(s.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),e.percussionArticulations.length>0||i.isPercussion){const t=e.percussionArticulations.length>0?e.percussionArticulations:Array.from(Ut.instrumentArticulations.values());s.addElement("Name").innerText=lu.sx.instrumentSetName,s.addElement("Type").innerText=lu.sx.instrumentSetType;let i="",n=new Ts;const r=new Map,a=s.addElement("Elements");for(const e of t){{const t=a.addElement("Element");let s=e.elementType;if(r.has(s)){const t=r.get(s);s+=` ${t}`,r.set(s,t+1)}else r.set(s,1);i=s,t.addElement("Name").innerText=s,t.addElement("Type").innerText=e.elementType,n=t.addElement("Articulations")}const t=n.addElement("Articulation");switch(t.addElement("Name").innerText=`${i} ${n.childNodes.length}`,t.addElement("StaffLine").innerText=e.staffLine.toString(),t.addElement("Noteheads").innerText=[this.Kx(e.noteHeadDefault),this.Kx(e.noteHeadHalf),this.Kx(e.noteHeadWhole)].join(" "),e.techniqueSymbolPlacement){case ot.Below:t.addElement("TechniquePlacement").innerText="below";break;case ot.Outside:t.addElement("TechniquePlacement").innerText="outside";break;case ot.Inside:t.addElement("TechniquePlacement").innerText="inside";break;case ot.Above:t.addElement("TechniquePlacement").innerText="above"}t.addElement("TechniqueSymbol").innerText=this.Kx(e.techniqueSymbol),t.addElement("InputMidiNumbers").innerText="",t.addElement("OutputMidiNumber").innerText=e.outputMidiNumber.toString()}}else{const t=lu.tx.has(e.playbackInfo.program)?lu.tx.get(e.playbackInfo.program):lu.tx.get(0);s.addElement("Name").innerText=t.instrumentSetName,s.addElement("Type").innerText=t.instrumentSetType;const i=s.addElement("Elements").addElement("Element");i.addElement("Pitched").innerText="Pitched",i.addElement("Type").innerText="pitched",i.addElement("SoundbankName").innerText="";const n=i.addElement("Articulations").addElement("Articulation");n.addElement("Name").innerText="",n.addElement("StaffLine").innerText="0",n.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",n.addElement("TechniquePlacement").innerText="outside",n.addElement("TechniqueSymbol").innerText="",n.addElement("InputMidiNumbers").innerText="",n.addElement("OutputRSESound").innerText="",n.addElement("OutputMidiNumber").innerText="0"}}Kx(t){if(t===rt.None)return"";const e=rt[t];return e.substring(0,1).toLowerCase()+e.substring(1)}bx(t,e){const s=t.addElement("MasterBars");for(const t of e.masterBars)this.Qx(s,t)}Qx(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");let n=e.score.tracks[0].staves[0].bars[e.index].keySignature;const r=e.score.tracks[0].staves[0].bars[e.index].keySignatureType,a=Vt.flooredDivision(e.score.tracks[0].staves[0].displayTranspositionPitch,12);n=Vt.transposeKey(n,-a),i.addElement("AccidentalCount").innerText=n.toString(),i.addElement("Mode").innerText=F[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.isFreeTime&&s.addElement("FreeTime");const h=[];for(const t of e.score.tracks)for(const s of t.staves)h.push(s.bars[e.index].id.toString());if(s.addElement("Bars").innerText=h.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const t=s.addElement("Section");t.addElement("Letter").setCData(e.section.marker),t.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const t=s.addElement("Repeat");t.attributes.set("start",e.isRepeatStart?"true":"false"),t.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&t.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let t=e.alternateEndings;const i=[];let n=0;for(;t>0;)1==(t>>n&1)&&(i.push(n+1),t&=~(1<<n)),n++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(e.tripletFeel!==nt.NoTripletFeel&&(s.addElement("TripletFeel").innerText=nt[e.tripletFeel]),e.directions&&e.directions.size>0){const t=s.addElement("Directions");for(const s of e.directions)switch(s){case Ke.TargetFine:t.addElement("Target").innerText="Fine";break;case Ke.TargetSegno:t.addElement("Target").innerText="Segno";break;case Ke.TargetSegnoSegno:t.addElement("Target").innerText="SegnoSegno";break;case Ke.TargetCoda:t.addElement("Target").innerText="Coda";break;case Ke.TargetDoubleCoda:t.addElement("Target").innerText="DoubleCoda";break;case Ke.JumpDaCapo:t.addElement("Jump").innerText="DaCapo";break;case Ke.JumpDaCapoAlCoda:t.addElement("Jump").innerText="DaCapoAlCoda";break;case Ke.JumpDaCapoAlDoubleCoda:t.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case Ke.JumpDaCapoAlFine:t.addElement("Jump").innerText="DaCapoAlFine";break;case Ke.JumpDalSegno:t.addElement("Jump").innerText="DaSegno";break;case Ke.JumpDalSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoAlCoda";break;case Ke.JumpDalSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case Ke.JumpDalSegnoAlFine:t.addElement("Jump").innerText="DaSegnoAlFine";break;case Ke.JumpDalSegnoSegno:t.addElement("Jump").innerText="DaSegnoSegno";break;case Ke.JumpDalSegnoSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case Ke.JumpDalSegnoSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case Ke.JumpDalSegnoSegnoAlFine:t.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case Ke.JumpDaCoda:t.addElement("Jump").innerText="DaCoda";break;case Ke.JumpDaDoubleCoda:t.addElement("Jump").innerText="DaDoubleCoda"}}this.Zx(s,e)}Zx(t,e){const s=e.fermata?.size??0;if(0!==s&&s>0){const s=t.addElement("Fermatas");for(const[t,i]of e.fermata)this.tT(s,t,i)}}tT(t,e,s){let i=-1,n=1;if(e>0)for(;n<10&&(i=e/R.QuarterTime*n,i!==Math.floor(i));)i=-1,n++;else i=0,n=1;if(-1===i)return;const r=t.addElement("Fermata");r.addElement("Type").innerText=Nt[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${n}`}gx(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(t=>t.isEmpty?"-1":t.id.toString()).join(" "),s.addElement("Clef").innerText=N[e.clef],e.clefOttava!==b.Regular&&(s.addElement("Ottavia").innerText=b[e.clefOttava].substr(1)),e.simileMark!==P.None&&(s.addElement("SimileMark").innerText=P[e.simileMark])}wx(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(t=>t.id).join(" ")}}class uu{static eT=uu.sT();static sT(){const t=new Uint32Array(256);for(let e=0;e<t.length;e++){let s=e;for(let t=0;t<8;t++)s=1&~s?s>>>1:s>>>1^3988292384;t[e]=s}return t}static iT=4294967295;nT=uu.iT;get value(){return~this.nT}constructor(){this.reset()}update(t,e,s){for(let i=0;i<s;i++)this.nT=uu.eT[255&(this.nT^t[e+i])]^this.nT>>>8}reset(){this.nT=uu.iT}}class du{static maxWbits=15;static wsize=1<<du.maxWbits;static wmask=du.wsize-1;static minMatch=3;static maxMatch=258;static defaultMemLevel=8;static pendingBufSize=1<<du.defaultMemLevel+8;static hashBits=du.defaultMemLevel+7;static hashSize=1<<du.hashBits;static hashShift=(du.hashBits+du.minMatch-1)/du.minMatch;static hashMask=du.hashSize-1;static minLookahead=du.maxMatch+du.minMatch+1;static maxDist=du.wsize-du.minLookahead}class fu{static rT=16;static aT=17;static hT=18;freqs;length=null;minNumCodes;numCodes=0;oT=null;cT;lT;Oi;constructor(t,e,s,i){this.Oi=t,this.minNumCodes=s,this.lT=i,this.freqs=new Int16Array(e),this.cT=new Int32Array(i)}reset(){for(let t=0;t<this.freqs.length;t++)this.freqs[t]=0;this.oT=null,this.length=null}buildTree(){const t=this.freqs.length,e=new Int32Array(t);let s=0,i=0;for(let n=0;n<t;n++){const t=this.freqs[n];if(0!==t){let r=s++;for(;r>0;){const s=Math.floor((r-1)/2);if(!(this.freqs[e[s]]>t))break;e[r]=e[s],r=s}e[r]=n,i=n}}for(;s<2;){const t=i<2?++i:0;e[s++]=t}this.numCodes=Math.max(i+1,this.minNumCodes);const n=s,r=new Int32Array(4*s-2),a=new Int32Array(2*s-1);let h=n;for(let t=0;t<s;t++){const s=e[t];r[2*t]=s,r[2*t+1]=-1,a[t]=this.freqs[s]<<8,e[t]=t}do{const t=e[0];let i=e[--s],n=0,o=1;for(;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*o+1;let c=a[i];for(;o=n,n>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i;const l=e[0];i=h++,r[2*i]=t,r[2*i+1]=l;const u=Math.min(255&a[t],255&a[l]);for(c=a[t]+a[l]-u+1,a[i]=c,n=0,o=1;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*n+1;for(;o=n,o>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i}while(s>1);this.uT(r)}uT(t){this.length=new Uint8Array(this.freqs.length);const e=Math.floor(t.length/2),s=Math.floor((e+1)/2);let i=0;for(let t=0;t<this.lT;t++)this.cT[t]=0;const n=new Int32Array(e);n[e-1]=0;for(let s=e-1;s>=0;s--)if(-1!==t[2*s+1]){let e=n[s]+1;e>this.lT&&(e=this.lT,i++),n[t[2*s]]=e,n[t[2*s+1]]=e}else{const e=n[s];this.cT[e-1]++,this.length[t[2*s]]=n[s]}if(0===i)return;let r=this.lT-1;do{for(;0===this.cT[--r];);do{this.cT[r]--,this.cT[++r]++,i-=1<<this.lT-1-r}while(i>0&&r<this.lT-1)}while(i>0);this.cT[this.lT-1]+=i,this.cT[this.lT-2]-=i;let a=2*s;for(let e=this.lT;0!==e;e--){let s=this.cT[e-1];for(;s>0;){const i=2*t[a++];-1===t[i+1]&&(this.length[t[i]]=e,s--)}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.freqs[a]++,i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););i<s?t.freqs[n]+=i:0!==n?t.freqs[fu.rT]++:i<=10?t.freqs[fu.aT]++:t.freqs[fu.hT]++}}setStaticCodes(t,e){this.oT=t,this.length=e}buildCodes(){const t=new Int32Array(this.lT);let e=0;this.oT=new Int16Array(this.freqs.length);for(let s=0;s<this.lT;s++)t[s]=e,e+=this.cT[s]<<15-s;for(let e=0;e<this.numCodes;e++){const s=this.length[e];s>0&&(this.oT[e]=pu.bitReverse(t[s-1]),t[s-1]+=1<<16-s)}}writeTree(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.writeSymbol(a),i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););if(i<s)for(;i-- >0;)t.writeSymbol(n);else 0!==n?(t.writeSymbol(fu.rT),this.Oi.pending.writeBits(i-3,2)):i<=10?(t.writeSymbol(fu.aT),this.Oi.pending.writeBits(i-3,3)):(t.writeSymbol(fu.hT),this.Oi.pending.writeBits(i-11,7))}}writeSymbol(t){this.Oi.pending.writeBits(65535&this.oT[t],this.length[t])}}class pu{static dT=1<<du.defaultMemLevel+6;static fT=286;static storedBlock=0;static staticTrees=1;static dynTrees=2;static pT=30;static bT=new Int16Array(pu.fT);static mT=new Uint8Array(pu.fT);static gT=new Int16Array(pu.pT);static wT=new Uint8Array(pu.pT);static staticInit(){let t=0;for(;t<144;)pu.bT[t]=pu.bitReverse(48+t<<8),pu.mT[t++]=8;for(;t<256;)pu.bT[t]=pu.bitReverse(256+t<<7),pu.mT[t++]=9;for(;t<280;)pu.bT[t]=pu.bitReverse(-256+t<<9),pu.mT[t++]=7;for(;t<pu.fT;)pu.bT[t]=pu.bitReverse(-88+t<<8),pu.mT[t++]=8;for(t=0;t<pu.pT;t++)pu.gT[t]=pu.bitReverse(t<<11),pu.wT[t]=5}static yT=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static kT=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]);static bitReverse(t){return pu.kT[15&t]<<12|pu.kT[t>>4&15]<<8|pu.kT[t>>8&15]<<4|pu.kT[t>>12]}static ST=19;static BT=256;pending;_T;xT;TT;MT;vT;NT=0;PT=0;constructor(t){this.pending=t,this._T=new fu(this,pu.fT,257,15),this.xT=new fu(this,pu.pT,1,15),this.TT=new fu(this,pu.ST,4,7),this.MT=new Int16Array(pu.dT),this.vT=new Uint8Array(pu.dT)}isFull(){return this.NT>=pu.dT}reset(){this.NT=0,this.PT=0,this._T.reset(),this.xT.reset(),this.TT.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((pu.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this._T.freqs[pu.BT]++,this._T.buildTree(),this.xT.buildTree(),this._T.calcBLFreq(this.TT),this.xT.calcBLFreq(this.TT),this.TT.buildTree();let n=4;for(let t=18;t>n;t--)this.TT.length[pu.yT[t]]>0&&(n=t+1);let r=14+3*n+this.TT.getEncodedLength()+this._T.getEncodedLength()+this.xT.getEncodedLength()+this.PT,a=this.PT;for(let t=0;t<pu.fT;t++)a+=this._T.freqs[t]*pu.mT[t];for(let t=0;t<pu.pT;t++)a+=this.xT.freqs[t]*pu.wT[t];r>=a&&(r=a),e>=0&&s+4<r>>3?this.flushStoredBlock(t,e,s,i):r===a?(this.pending.writeBits((pu.staticTrees<<1)+(i?1:0),3),this._T.setStaticCodes(pu.bT,pu.mT),this.xT.setStaticCodes(pu.gT,pu.wT),this.compressBlock(),this.reset()):(this.pending.writeBits((pu.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(n),this.compressBlock(),this.reset())}sendAllTrees(t){this.TT.buildCodes(),this._T.buildCodes(),this.xT.buildCodes(),this.pending.writeBits(this._T.numCodes-257,5),this.pending.writeBits(this.xT.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this.TT.length[pu.yT[e]],3);this._T.writeTree(this.TT),this.xT.writeTree(this.TT)}compressBlock(){for(let t=0;t<this.NT;t++){const e=255&this.vT[t];let s=this.MT[t];if(0!==s--){const t=pu.ET(e);this._T.writeSymbol(t);let i=Math.floor((t-261)/4);i>0&&i<=5&&this.pending.writeBits(e&(1<<i)-1,i);const n=pu.FT(s);this.xT.writeSymbol(n),i=Math.floor(n/2)-1,i>0&&this.pending.writeBits(s&(1<<i)-1,i)}else this._T.writeSymbol(e)}this._T.writeSymbol(pu.BT)}tallyDist(t,e){this.MT[this.NT]=t,this.vT[this.NT++]=e-3;const s=pu.ET(e-3);this._T.freqs[s]++,s>=265&&s<285&&(this.PT+=Math.floor((s-261)/4));const i=pu.FT(t-1);return this.xT.freqs[i]++,i>=4&&(this.PT+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this.MT[this.NT]=0,this.vT[this.NT++]=t,this._T.freqs[t]++,this.isFull()}static ET(t){if(255===t)return 285;let e=257;for(;t>=8;)e+=4,t>>=1;return e+t}static FT(t){let e=0;for(;t>=4;)e+=2,t>>=1;return e+t}}pu.staticInit();class bu{static CT=4096;AT;DT=128;LT=128;WT=8;OT=0;RT;Xi;tf;IT;GT=0;$T=null;VT=0;HT=0;UT=!1;zT=0;jT=0;XT;Oi;inputCrc;constructor(t){this.XT=t,this.Oi=new pu(t),this.inputCrc=new uu,this.Xi=new Uint8Array(2*du.wsize),this.tf=new Int16Array(du.hashSize),this.IT=new Int16Array(du.wsize),this.AT=1,this.RT=1}reset(){this.Oi.reset(),this.inputCrc.reset(),this.AT=1,this.RT=1,this.GT=0,this.UT=!1,this.jT=du.minMatch-1;for(let t=0;t<du.hashSize;t++)this.tf[t]=0;for(let t=0;t<du.wsize;t++)this.IT[t]=0}JT(){this.OT=this.Xi[this.RT]<<du.hashShift^this.Xi[this.RT+1]}needsInput(){return this.HT===this.VT}setInput(t,e,s){const i=e+s;this.$T=t,this.VT=e,this.HT=i}deflate(t,e){let s;do{this.fillWindow();const i=t&&this.VT===this.HT;s=this.qT(i,e)}while(this.XT.isFlushed&&s);return s}qT(t,e){if(this.GT<du.minLookahead&&!t)return!1;for(;this.GT>=du.minLookahead||t;){if(0===this.GT)return this.UT&&this.Oi.tallyLit(255&this.Xi[this.RT-1]),this.UT=!1,this.Oi.flushBlock(this.Xi,this.AT,this.RT-this.AT,e),this.AT=this.RT,!1;this.RT>=2*du.wsize-du.minLookahead&&this.YT();const t=this.zT;let s=this.jT;if(this.GT>=du.minMatch){const t=this.KT();0!==t&&this.RT-t<=du.maxDist&&this.QT(t)&&this.jT===du.minMatch&&this.RT-this.zT>bu.CT&&(this.jT=du.minMatch-1)}if(s>=du.minMatch&&this.jT<=s){this.Oi.tallyDist(this.RT-1-t,s),s-=2;do{this.RT++,this.GT--,this.GT>=du.minMatch&&this.KT()}while(--s>0);this.RT++,this.GT--,this.UT=!1,this.jT=du.minMatch-1}else this.UT&&this.Oi.tallyLit(255&this.Xi[this.RT-1]),this.UT=!0,this.RT++,this.GT--;if(this.Oi.isFull()){let t=this.RT-this.AT;this.UT&&t--;const s=e&&0===this.GT&&!this.UT;return this.Oi.flushBlock(this.Xi,this.AT,t,s),this.AT+=t,!s}}return!0}QT(t){let e,s=this.RT;const i=s+Math.min(du.maxMatch,this.GT)-1,n=Math.max(s-du.maxDist,0),r=this.Xi,a=this.IT;let h=this.DT;const o=Math.min(this.LT,this.GT);if(this.jT=Math.max(this.jT,du.minMatch-1),s+this.jT>i)return!1;let c=r[s+this.jT-1],l=r[s+this.jT];this.jT>=this.WT&&(h>>=2);do{if(e=t,s=this.RT,r[e+this.jT]===l&&r[e+this.jT-1]===c&&r[e]===r[s]&&r[++e]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++e])break;break;case 2:if(r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 3:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 4:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 5:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 6:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 7:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break}if(r[s]===r[e])do{if(s===i){++s,++e;break}}while(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]);if(s-this.RT>this.jT){if(this.zT=t,this.jT=s-this.RT,this.jT>=o)break;c=r[s-1],l=r[s]}t=65535&a[t&du.wmask]}}while(t>n&&0!==--h);return this.jT>=du.minMatch}KT(){const t=(this.OT<<du.hashShift^this.Xi[this.RT+(du.minMatch-1)])&du.hashMask,e=this.tf[t];return this.IT[this.RT&du.wmask]=e,this.tf[t]=this.RT,this.OT=t,65535&e}fillWindow(){if(this.RT>=du.wsize+du.maxDist&&this.YT(),this.GT<du.minLookahead&&this.VT<this.HT){let t=2*du.wsize-this.GT-this.RT;t>this.HT-this.VT&&(t=this.HT-this.VT),this.Xi.set(this.$T.subarray(this.VT,this.VT+t),this.RT+this.GT),this.inputCrc.update(this.$T,this.VT,t),this.VT+=t,this.GT+=t}this.GT>=du.minMatch&&this.JT()}YT(){this.Xi.set(this.Xi.subarray(du.wsize,du.wsize+du.wsize),0),this.zT-=du.wsize,this.RT-=du.wsize,this.AT-=du.wsize;for(let t=0;t<du.hashSize;++t){const e=65535&this.tf[t];this.tf[t]=e>=du.wsize?e-du.wsize:0}for(let t=0;t<du.wsize;t++){const e=65535&this.IT[t];this.IT[t]=e>=du.wsize?e-du.wsize:0}}}class mu{si;ZT=0;Ou=0;Li=0;bitCount=0;get isFlushed(){return 0===this.Ou}constructor(t){this.si=new Uint8Array(t)}reset(){this.ZT=0,this.Ou=0,this.bitCount=0}writeShortMSB(t){this.si[this.Ou++]=t>>8&255,this.si[this.Ou++]=255&t}writeShort(t){this.si[this.Ou++]=t,this.si[this.Ou++]=t>>8}writeBlock(t,e,s){this.si.set(t.subarray(e,e+s),this.Ou),this.Ou+=s}flush(t,e,s){return this.bitCount>=8&&(this.si[this.Ou++]=255&this.Li,this.Li>>=8,this.bitCount-=8),s>this.Ou-this.ZT?(s=this.Ou-this.ZT,t.set(this.si.subarray(this.ZT,this.ZT+s),e),this.ZT=0,this.Ou=0):(t.set(this.si.subarray(this.ZT,this.ZT+s),e),this.ZT+=s),s}writeBits(t,e){this.Li|=t<<this.bitCount,this.bitCount+=e,this.bitCount>=16&&(this.si[this.Ou++]=255&this.Li,this.si[this.Ou++]=this.Li>>8&255,this.Li>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this.si[this.Ou++]=255&this.Li,this.bitCount>8&&(this.si[this.Ou++]=this.Li>>8&255)),this.Li=0,this.bitCount=0}}class gu{static tM=4;static isFinishing=8;static eM=16;static sM=20;static iM=28;static nM=30;oi=0;XT;rM;get inputCrc(){return this.rM.inputCrc.value}constructor(){this.XT=new mu(du.pendingBufSize),this.rM=new bu(this.XT),this.reset()}get isNeedingInput(){return this.rM.needsInput()}get isFinished(){return this.oi===gu.nM&&this.XT.isFlushed}reset(){this.oi=gu.eM,this.XT.reset(),this.rM.reset()}setInput(t,e,s){this.rM.setInput(t,e,s)}deflate(t,e,s){const i=s;for(;;){const n=this.XT.flush(t,e,s);if(e+=n,0===(s-=n)||this.oi===gu.nM)break;if(!this.rM.deflate(0!==(this.oi&gu.tM),0!==(this.oi&gu.isFinishing)))switch(this.oi){case gu.eM:return i-s;case gu.sM:let t=8+(7&-this.XT.bitCount);for(;t>0;)this.XT.writeBits(2,10),t-=10;this.oi=gu.eM;break;case gu.iM:this.XT.alignToByte(),this.oi=gu.nM}}return i-s}finish(){this.oi|=gu.tM|gu.isFinishing}}class wu{entry;localHeaderOffset;compressedSize;crc32;compressionMode;constructor(t,e,s,i,n){this.entry=t,this.crc32=e,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=n}}class yu{zl;aM=[];hM=new gu;constructor(t){this.zl=t}writeEntry(t){const e=_s.CompressionMethodDeflate,s=Re.empty(),i=this.oM(s,t.data,e),n=s.toArray(),r=new wu(t,i,this.zl.bytesWritten,e,s.length);this.aM.push(r),ae.writeInt32LE(this.zl,_s.LocalFileHeaderSignature),ae.writeUInt16LE(this.zl,10),ae.writeUInt16LE(this.zl,2048),ae.writeUInt16LE(this.zl,e),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt32LE(this.zl,i),ae.writeInt32LE(this.zl,n.length),ae.writeInt32LE(this.zl,t.data.length),ae.writeInt16LE(this.zl,t.fullName.length),ae.writeInt16LE(this.zl,0);const a=ae.stringToBytes(t.fullName);this.zl.write(a,0,a.length),this.zl.write(n,0,n.length)}oM(t,e,s){if(s!==_s.CompressionMethodDeflate){const s=new uu;return s.update(e,0,e.length),t.write(e,0,e.length),s.value}const i=new Uint8Array(512);for(this.hM.reset(),this.hM.setInput(e,0,e.length);!this.hM.isNeedingInput;){const e=this.hM.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}for(this.hM.finish();!this.hM.isFinished;){const e=this.hM.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}return this.hM.inputCrc}end(){const t=this.zl.bytesWritten;for(const t of this.aM)this.cM(t);const e=this.zl.bytesWritten;this.lM(t,e)}lM(t,e){ae.writeInt32LE(this.zl,_s.EndOfCentralDirSignature),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,this.aM.length),ae.writeInt16LE(this.zl,this.aM.length),ae.writeInt32LE(this.zl,e-t),ae.writeInt32LE(this.zl,t),ae.writeInt16LE(this.zl,0)}cM(t){ae.writeInt32LE(this.zl,_s.CentralFileHeaderSignature),ae.writeUInt16LE(this.zl,10),ae.writeUInt16LE(this.zl,10),ae.writeUInt16LE(this.zl,2048),ae.writeUInt16LE(this.zl,t.compressionMode),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt32LE(this.zl,t.crc32),ae.writeInt32LE(this.zl,t.compressedSize),ae.writeInt32LE(this.zl,t.entry.data.length),ae.writeInt16LE(this.zl,t.entry.fullName.length),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt16LE(this.zl,0),ae.writeInt32LE(this.zl,0),ae.writeInt32LE(this.zl,t.localHeaderOffset);const e=ae.stringToBytes(t.entry.fullName);this.zl.write(e,0,e.length)}}const ku=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:class extends ru{hi=Le.instance;get name(){return"alphaTex"}exportToString(t,e=null){return this.settings=e??new Fr,this.scoreToAlphaTexString(t)}writeScore(t){const e=ae.stringToBytes(this.scoreToAlphaTexString(t));this.data.write(e,0,e.length)}scoreToAlphaTexString(t){const e=new hu(this.settings);return e.writeScoreNode(this.ue(t)),e.tex}ue(t){const e={nodeType:yt.Score,bars:[]};for(const s of t.tracks)this.uM(e,s);return 0===e.bars.length?e.bars.push({nodeType:yt.Bar,metaData:this.hi.buildScoreMetaDataNodes(t),beats:[]}):e.bars[0].metaData=this.hi.buildScoreMetaDataNodes(t).concat(e.bars[0].metaData),e.bars.push({nodeType:yt.Bar,metaData:this.hi.buildSyncPointNodes(t),beats:[]}),e}uM(t,e){for(const s of e.staves)this.Vw(t,s)}Vw(t,e){const s=Math.max(...e.filledVoices)+1;if(0===e.bars.length){const s={nodeType:yt.Bar,metaData:this.hi.buildBarMetaDataNodes(e,void 0,0,!1),beats:[],pipe:void 0};t.bars.push(s)}else for(let i=0;i<s;i++)this.dM(t,i,e,s>1)}dM(t,e,s,i){for(const n of s.bars)this.fe(t,n,e,i)}fe(t,e,s,i){const n={nodeType:yt.Bar,metaData:this.hi.buildBarMetaDataNodes(e.staff,e,s,i),beats:[],pipe:void 0};if(e.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{const t=e.voices[s];if(t.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{for(const e of t.beats)n.beats.push(this.ge(e));n.beats.length>0&&(n.beats[0].leadingComments??=[],n.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} contents`}))}}e.index<e.staff.bars.length-1&&(n.pipe={nodeType:yt.Pipe}),t.bars.push(n)}ge(t){const e={nodeType:yt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return t.isRest?e.rest={nodeType:yt.Ident,text:"r"}:e.notes=this.tB(t.notes),e.durationDot={nodeType:yt.Dot},e.durationValue={nodeType:yt.Number,value:t.duration},e.beatEffects=this.gi(t),e}gi(t){const e=this.hi.buildBeatEffects(t);return e.length>0?{nodeType:yt.Props,openBrace:{nodeType:yt.LBrace},properties:e,closeBrace:{nodeType:yt.RBrace}}:void 0}tB(t){const e={nodeType:yt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===t.length||t.length>1)&&(e.openParenthesis={nodeType:yt.LParen},e.closeParenthesis={nodeType:yt.RParen});for(const s of t)e.notes.push(this.xe(s));return e}xe(t){const e={nodeType:yt.Note,noteValue:{nodeType:yt.Ident,text:""}};if(t.isPercussion)e.noteValue={nodeType:yt.String,text:Ut.getArticulationName(t)};else if(t.isPiano)e.noteValue={nodeType:yt.Ident,text:we.getTextForTuning(t.realValueWithoutHarmonic,!0)};else{if(!t.isStringed)throw new Error("What kind of note");{e.noteValue={nodeType:yt.Number,value:t.fret},e.noteStringDot={nodeType:yt.Dot};const s=t.beat.voice.bar.staff.tuning.length-t.string+1;e.noteString={nodeType:yt.Number,value:s}}}return e.noteEffects=this.wi(t),e}wi(t){const e=this.hi.buildNoteEffects(t);return e.length>0?{nodeType:yt.Props,openBrace:{nodeType:yt.LBrace},properties:e,closeBrace:{nodeType:yt.RBrace}}:void 0}},Gp7Exporter:class extends ru{get name(){return"Guitar Pro 7-8"}writeScore(t){z.debug(this.name,"Writing data entries");const e=new lu,s=e.writeXml(t),i=Js.writeForScore(t),n=ei.writeForScore(t),r=ni.writeForScore(t);z.debug(this.name,"Writing ZIP entries");const a=new yu(this.data);a.writeEntry(new _s("VERSION",ae.stringToBytes("7.0"))),a.writeEntry(new _s("Content/",new Uint8Array(0))),a.writeEntry(new _s("Content/BinaryStylesheet",i)),a.writeEntry(new _s("Content/PartConfiguration",n)),a.writeEntry(new _s("Content/LayoutConfiguration",r)),a.writeEntry(new _s("Content/score.gpif",ae.stringToBytes(s))),e.backingTrackAssetFileName&&a.writeEntry(new _s(e.backingTrackAssetFileName,t.backingTrack.rawAudioFile)),a.end()}},ScoreExporter:ru},Symbol.toStringTag,{value:"Module"}));class Su extends Mi{constructor(){super(0,0,es.EndOfTrack)}writeTo(t){throw new W(s.General,"Deprecated event, serialization not supported")}}var Bu,_u,xu;!function(t){t[t.SequenceNumber=0]="SequenceNumber",t[t.TextEvent=1]="TextEvent",t[t.CopyrightNotice=2]="CopyrightNotice",t[t.SequenceOrTrackName=3]="SequenceOrTrackName",t[t.InstrumentName=4]="InstrumentName",t[t.LyricText=5]="LyricText",t[t.MarkerText=6]="MarkerText",t[t.CuePoint=7]="CuePoint",t[t.PatchName=8]="PatchName",t[t.PortName=9]="PortName",t[t.MidiChannel=32]="MidiChannel",t[t.MidiPort=33]="MidiPort",t[t.EndOfTrack=47]="EndOfTrack",t[t.Tempo=81]="Tempo",t[t.SmpteOffset=84]="SmpteOffset",t[t.TimeSignature=88]="TimeSignature",t[t.KeySignature=89]="KeySignature",t[t.SequencerSpecific=127]="SequencerSpecific"}(Bu||(Bu={}));class Tu extends Su{get metaStatus(){return Bu.EndOfTrack}}!function(t){t[t.SystemExclusive=240]="SystemExclusive",t[t.MtcQuarterFrame=241]="MtcQuarterFrame",t[t.SongPosition=242]="SongPosition",t[t.SongSelect=243]="SongSelect",t[t.TuneRequest=246]="TuneRequest",t[t.SystemExclusive2=247]="SystemExclusive2"}(_u||(_u={}));class Mu extends Su{}!function(t){t[t.MetronomeTick=0]="MetronomeTick",t[t.Rest=1]="Rest"}(xu||(xu={}));const vu=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:ua,AlphaTabMetronomeEvent:Pi,AlphaTabRestEvent:Ei,AlphaTabSysExEvent:Ni,get AlphaTabSystemExclusiveEvents(){return xu},BeatTickLookup:ba,BeatTickLookupItem:pa,ControlChangeEvent:Di,get ControllerType(){return cs},DeprecatedMidiEvent:Su,EndOfTrackEvent:Ii,MasterBarTickLookup:ga,MasterBarTickLookupTempoChange:ma,MetaDataEvent:class extends Tu{data=new Uint8Array},MetaEvent:Tu,get MetaEventType(){return Bu},MetaNumberEvent:class extends Tu{value=0},Midi20PerNotePitchBendEvent:class extends Su{noteKey=0;pitch=0},MidiEvent:Mi,get MidiEventType(){return es},MidiFile:Ti,get MidiFileFormat(){return ts},MidiFileGenerator:xa,MidiTickLookup:ya,MidiTickLookupFindBeatResult:wa,get MidiTickLookupFindBeatResultCursorMode(){return ys},MidiTrack:xi,NoteBendEvent:Ri,NoteEvent:Fi,NoteOffEvent:Ai,NoteOnEvent:Ci,PitchBendEvent:Oi,ProgramChangeEvent:Li,SystemCommonEvent:Mu,get SystemCommonType(){return _u},SystemExclusiveEvent:class extends Mu{static AlphaTabManufacturerId=125;data=new Uint8Array;get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}},TempoChangeEvent:Wi,TimeSignatureEvent:vi},Symbol.toStringTag,{value:"Module"})),Nu=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return u},get AccidentalType(){return at},Automation:G,get AutomationType(){return n},BackingTrack:qs,Bar:K,get BarLineStyle(){return D},BarStyle:Y,get BarSubElement(){return A},get BarreShape(){return bt},Beat:Yt,get BeatBeamingMode(){return gt},BeatStyle:qt,get BeatSubElement(){return wt},BendPoint:$,get BendStyle(){return r},get BendType(){return a},get BracketExtendMode(){return x},get BrushType(){return h},Chord:de,get Clef(){return N},Color:pe,get CrescendoType(){return o},get Direction(){return Ke},get Duration(){return c},get DynamicValue(){return i},ElementStyle:J,get FadeType(){return ft},Fermata:be,get FermataType(){return Nt},get Fingers(){return d},Font:or,get FontStyle(){return ls},get FontWeight(){return us},get GolpeType(){return dt},GraceGroup:Q,get GraceType(){return l},get HarmonicType(){return f},HeaderFooterStyle:Lt,InstrumentArticulation:Ht,JsonConverter:ra,get KeySignature(){return E},get KeySignatureType(){return F},Lyrics:me,MasterBar:Rt,get MusicFontSymbol(){return rt},Note:Xt,get NoteAccidentalMode(){return p},get NoteOrnament(){return ct},NoteStyle:jt,get NoteSubElement(){return lt},get Ottavia(){return b},get PickStroke(){return ht},PlaybackInformation:ke,get Rasgueado(){return mt},RenderStylesheet:j,RepeatGroup:X,Score:Ot,ScoreStyle:Wt,get ScoreSubElement(){return it},Section:ge,get SimileMark(){return P},get SlideInType(){return m},get SlideOutType(){return g},Staff:ye,SustainPedalMarker:q,get SustainPedalMarkerType(){return C},SyncPointData:I,get TechniqueSymbolPlacement(){return ot},Track:Be,get TrackNameMode(){return M},get TrackNameOrientation(){return v},get TrackNamePolicy(){return T},TrackStyle:Se,get TrackSubElement(){return Et},get TripletFeel(){return nt},Tuning:we,TupletGroup:Jt,get VibratoType(){return w},Voice:tt,VoiceStyle:Z,get VoiceSubElement(){return L},get WahPedal(){return pt},get WhammyType(){return ut}},Symbol.toStringTag,{value:"Module"})),Pu=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:bh,Cursors:Ka,FontSizeDefinition:ha,FontSizes:oa,MeasuredText:At,SvgCanvas:ph,get TextAlign(){return et},get TextBaseline(){return st}},Symbol.toStringTag,{value:"Module"})),Eu=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:Da,AlphaSynth:ir,AlphaSynthAudioWorkletOutput:_i,AlphaSynthBase:sr,AlphaSynthScriptProcessorOutput:Ja,AlphaSynthWebAudioOutputBase:Si,AlphaSynthWebWorkerApi:qa,AudioExportChunk:er,AudioExportOptions:tr,BackingTrackSyncPoint:$i,CircularSampleBuffer:gi,MidiEventsPlayedEventArgs:Qn,PlaybackRange:Ga,PlaybackRangeChangedEventArgs:Zn,get PlayerState(){return ss},PlayerStateChangedEventArgs:zi,PositionChangedEventArgs:ji},Symbol.toStringTag,{value:"Module"})),Fu=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{ih as AlphaTabApi,Va as AlphaTabApiBase,W as AlphaTabError,s as AlphaTabErrorType,U as ConsoleLogger,eu as CoreSettings,fr as DisplaySettings,ur as EngravingSettings,lr as EngravingStemInfo,tu as Environment,Er as ExporterSettings,Ha as FileLoadError,k as FingeringMode,uh as FontFileFormat,fe as FormatError,pr as ImporterSettings,Ft as LayoutMode,_ as LogLevel,z as Logger,B as NotationElement,S as NotationMode,V as NotationSettings,ms as PlayerMode,bs as PlayerOutputMode,gr as PlayerSettings,sh as ProgressEventArgs,Zl as RenderEngineFactory,dr as RenderingResources,Ta as ResizeEventArgs,ps as ScrollMode,Fr as Settings,mr as SlidePlaybackSettings,ds as StaveProfile,fs as SystemsLayoutMode,y as TabRhythmMode,br as VibratoPlaybackSettings,gs as WebPlatform,ku as exporter,iu as importer,nu as io,Fu as json,O as meta,vu as midi,Nu as model,Pu as platform,De as rendering,Eu as synth};